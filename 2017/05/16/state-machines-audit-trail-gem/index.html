<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>State machines audit trails gem</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>State machines audit trails gem</h1>
    <p class="meta">May 16, 2017</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#old-gem-state_machine"><span class="tocnumber">1</span> <span class="toctext">Old gem state_machine</span></a></li><li class="toc_level-1 toc_section-2"><a href="#old-gem-state_machine-audit_trail"><span class="tocnumber">2</span> <span class="toctext">Old gem state_machine-audit_trail</span></a></li><li class="toc_level-1 toc_section-3"><a href="#upgrade-gem-state_machines"><span class="tocnumber">3</span> <span class="toctext">Upgrade gem state_machines</span></a></li><li class="toc_level-1 toc_section-4"><a href="#other-audit-gems"><span class="tocnumber">4</span> <span class="toctext">Other audit gems</span></a></li></ul></td></tr></tbody></table></div><h1 id="old-gem-state_machine">Old gem state_machine</h1>

<p>Definition with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Objects
  state_machine :state, initial: :my_state do
  ...
  end
</code></pre></div></div>

<p>Inside definition you can use:</p>

<ul>
  <li><code class="highlighter-rouge">before_transition on: :my_state</code>, <code class="highlighter-rouge">after_transition on: :my_state</code></li>
  <li><code class="highlighter-rouge">after_failure on: :my_state</code></li>
  <li>
    <p><code class="highlighter-rouge">around_transition</code></p>
  </li>
  <li><code class="highlighter-rouge">event :my_event { transition :my_state, :my_other_state, if: Proc.new {
|my_object| my_object.valid? } }</code></li>
  <li><code class="highlighter-rouge">state :my_state do end</code></li>
</ul>

<p>In transitions you can use keyword <code class="highlighter-rouge">all</code> or <code class="highlighter-rouge">any</code> to match all/any states, and
<code class="highlighter-rouge">same</code> to match same state (usefull when you have list of matched states).
You can use <code class="highlighter-rouge">object.my_state?</code> to check if it is currently in that <code class="highlighter-rouge">my_state</code>.
Also you can use <code class="highlighter-rouge">object.can_my_event?</code> to check if it can change state using
this event. Also <code class="highlighter-rouge">object.fire_state_event(:my_event)</code> and
<code class="highlighter-rouge">object.state?(:my_state)</code>. You can use bang method to raise error if event
fails <code class="highlighter-rouge">object.my_event!</code>. List of all possible events is <code class="highlighter-rouge">object.state_events</code>
(or <code class="highlighter-rouge">object.status_events</code> to list all events for status column).</p>

<p>To list of all states you can use <code class="highlighter-rouge">Post.state_machines[:status].states.map
&amp;:name</code></p>

<p>You can use namespace <code class="highlighter-rouge">state_machine :alarm_state, initial: :active, namespace:
:alarm do</code> when all events and states have prefix <code class="highlighter-rouge">alarm_my_state</code> and suffix
<code class="highlighter-rouge">my_event_alarm</code>.</p>

<p>Instead of calling the event explicitly you can use <code class="highlighter-rouge">object.state_event =
"my_event"; object.save</code> to trigger event. You can manually change state but
then you will break state machine, so better is to update <code class="highlighter-rouge">state_event</code>. On
creation, initial state event is triggered, so you will have two events (from
nil to initial, and from initial to the value of state_event).</p>

<p>You can define transitions inside the context of an event. First transition that
matches the state and passes its conditions will be used.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>event :repair do
  transition stalled: :parked, unless: :auto_shop_busy
  transition stalled: same
end
</code></pre></div></div>

<p>but also you can define transition inside the <a href="https://github.com/pluginaweek/state_machine#transition-context">context of
state</a>. Than
you do not need to use <code class="highlighter-rouge">:from</code> (since we know the state) but you need <code class="highlighter-rouge">:on</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>state :parked do
  transition to: :idling, on: [:ignite, :shift_up], if: :seatbelt_on?
  def speed
    0
  end
end
</code></pre></div></div>

<p>When defining transitions instead of using hash rocket syntax you can use
<code class="highlighter-rouge">:from</code>, <code class="highlighter-rouge">:except_from</code>, <code class="highlighter-rouge">:to</code> and <code class="highlighter-rouge">:except_to</code> options</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>before_transition :parked =&gt; any - :parked, :do =&gt; :put_on_seatbelt
# is the same as
before_transition :from =&gt; :parked, :except_to =&gt; :parked, :do =&gt; :put_on_seatbelt
</code></pre></div></div>

<p>You can generate
<a href="https://github.com/pluginaweek/state_machine/blob/master/examples/Vehicle_state.png">graph</a> with</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install graphviz
echo "gem 'ruby-graphviz', require: 'graphviz'" &gt;&gt; Gemfile
rake state_machine:draw CLASS=Customer,Location HUMAN_NAMES=true
gnome-open Location_status.png
</code></pre></div></div>

<h1 id="old-gem-state_machine-audit_trail">Old gem state_machine-audit_trail</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat "gem 'state_machine-audit_trail'" &gt;&gt; Gemfile
rails generate state_machine:audit_trail Post status
</code></pre></div></div>

<p>This will generate model and migration which you can update</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/models/post_status_transition.rb
class PostStatusTransition &lt; ActiveRecord::Base
  belongs_to :post
end
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># db/migrate/123123123123_create_post_status_transitions.rb
class CreatePostStatusTransitions &lt; ActiveRecord::Migration[5.1]
  def change
    create_table :post_status_transitions do |t|
      t.references :post, foreign_key: true
      # t.string :namespace # this is for new version of state_machines
      t.string :event
      t.string :from
      t.string :to
      # add your custom fields
      t.string :change_description
      t.text :comment
      t.timestamp :created_at
    end
  end
end
</code></pre></div></div>

<p>If you need more data you need to add more columns, for example
<code class="highlighter-rouge">change_description</code> (by server) and <code class="highlighter-rouge">comment</code> (by user) which are defined as
<code class="highlighter-rouge">attr_accessor :change_description, :comment</code> in model and populated in form or
before_transition. For other fields that you want to track, those columns need
to exists in table.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Post &lt; ApplicationRecord
  state_machine :status, initial: :walk do
    store_audit_trail context_to_log: :comment
    event :start do
      transition all =&gt; :run
    end
    event :stop do
      transition all =&gt; :walk
    end
  end
end
</code></pre></div></div>

<h1 id="upgrade-gem-state_machines">Upgrade gem state_machines</h1>

<p>New gem have some breaking changes. You need is to include additional
gem that will use hooks to initialize data</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC
gem "state_machines"
gem 'state_machines-activerecord'
HERE_DOC
</code></pre></div></div>

<p>Before audit trail was adding description on <code class="highlighter-rouge">.save</code>, but in new gem, it is
adding on <code class="highlighter-rouge">.new</code> action and values are memoized</p>

<p><a href="https://github.com/state-machines/state_machines-audit_trail/issues/22">https://github.com/state-machines/state_machines-audit_trail/issues/22</a></p>

<p>Also, before we could use <code class="highlighter-rouge">Post.where(name: 'my name', status:
:enabled).first_or_create</code> event we had <code class="highlighter-rouge">state_machine :status, initial:
:created_new</code>. Now post will create with <code class="highlighter-rouge">Post.last.status # =&gt; 'initial'</code></p>

<p>For audit trail you need to do some renaming
<a href="https://github.com/state-machines/state_machines-audit_trail/wiki/Converting-from-former-state_machine-audit_trail-to-state_machines-audit_trail">https://github.com/state-machines/state_machines-audit_trail/wiki/Converting-from-former-state_machine-audit_trail-to-state_machines-audit_trail</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC
gem 'state_machines-audit_trail'
HERE_DOC
</code></pre></div></div>

<p>New version <code class="highlighter-rouge">rails g state_machines:audit_trail Post status</code> will generate same
migration with additional column: <code class="highlighter-rouge">t.string :namespace</code>. Note that you should
use singular <code class="highlighter-rouge">Post</code> and not plural <code class="highlighter-rouge">Posts</code></p>

<p>For additional fiels that you want to store, you can use real columns, but its
easier to use some <code class="highlighter-rouge">description</code> which you can generate from other fields.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  before_transition :on =&gt; any do |object, transition|
    case transition.event
    when :start
      self.description = "My object started"
    end
</code></pre></div></div>

<p>In model you need</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Post &lt; ApplicationRecord
  attr_accessor :change_description, :comment
  state_machine :status, initial: :walk do
    audit_trail context: [:change_description, :comment, :name]
    event :start do
      transition all =&gt; :run
    end
    event :stop do
      transition all =&gt; :walk
    end
  end

  def description=(text)
    @description = "My associated #{page.name} : #{text}"
  end

  def description
    # note that this is called on Post.new, so you should have page parameter
    # Post.new; Post.new; will call this twice, but without associated page
    # Post.new post_params.merge(page_id: current_page)
    @description ||= "My associated #{page.name}"
  end
end
</code></pre></div></div>

<p>In your view</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;% post.status_events.each do |event| %&gt;
    &lt;%= link_to event, action_post_path(post, event: event), method: :post %&gt;
  &lt;% end %&gt;

  # or on update form
  &lt;%= form.select :status_event, post.status_events %&gt;

  # of in hidden field on form object
  &lt;%= form.hidden_field :status_event, value: :edit %&gt;

  # or plain input (no need for :value key)
  &lt;%= hidden_field_tag :status_event, :edit %&gt;
</code></pre></div></div>

<p>And controller</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  def action
    @post.fire_status_event params[:event]
    redirect_to posts_path
  end

  # or on update form
  params.require(:post).permit(
    :name, :description, :status_event
  ).merge(
    updated_from_ip: request.remote_ip,
    updated_by: current_user,
  )
</code></pre></div></div>

<p>You can use <code class="highlighter-rouge">Constant.POST_STATUSES # { CREATED_NEW: "Created new" }</code> to list
all statuses and events in one file. Than in transition you can use <code class="highlighter-rouge">transition
all - Constant.POST_STATUSES.slice(:CREATED_NEW) =&gt; same</code></p>

<p>Conditional validation callbacks hooks works fine if it is rails <code class="highlighter-rouge">validates</code> but
if it is customer validation <code class="highlighter-rouge">validate :my_method</code> than it wonâ€™t work in
multiple states
<a href="https://github.com/state-machines/state_machines-activerecord#state-driven-validations">https://github.com/state-machines/state_machines-activerecord#state-driven-validations</a>
so instead of</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>state :first_gear, :second_gear do
  validate :speed_is_legal
end
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>state :first_gear, :second_gear do
  validate {|vehicle| vehicle.speed_is_legal}
end
</code></pre></div></div>

<p>Note that whole event change is wrapped in transaction, so if state validation
fails everything will be rolledback.</p>

<p>If you want to validate specific event <code class="highlighter-rouge">advance_renewal</code> (event without
corresponding state) so you can not use <code class="highlighter-rouge">event :advance_renewal; transition all
=&gt; same, if: Proc.new { |m| m.has_advance_package? }</code> since at the show time if
does not have advance package so <code class="highlighter-rouge">m.can_advance_renewal #=&gt; false</code>. So you need
to use rails validate <code class="highlighter-rouge">validate  :advance_renewal_settings, on: [:update], if:
:advance_renewal?</code> and <code class="highlighter-rouge">def advance_renewal_settings;
errors.add(:advance_renewal_package, "Please select Advance Renewal
Package.")unless advance_renewal_package.present?; end</code>.</p>

<p><code class="highlighter-rouge">before_transition</code>  and <code class="highlighter-rouge">after_transition</code> callbacks</p>

<h1 id="other-audit-gems">Other audit gems</h1>

<ul>
  <li>paper_trail
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle exec rails g paper_trail:install --with-changes
bundle exec rake db:migrate
</code></pre></div>    </div>
  </li>
</ul>
</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
