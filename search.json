[
  
    {
      "title"    : "D3 Visualization",
      "category" : "",
      "tags"     : "",
      "url"      : "/2019/04/23/d3-visualization/",
      "date"     : "2019-04-23 00:00:00 +0200",
      "content"  : "<h1 id=\"d3\">D3</h1>\n\n<p>https://d3js.org/</p>\n\n<p>Use declarative approach like jQuery <code class=\"highlighter-rouge\">d3.selectAll('p').style('color', 'blue')</code>.\nInstead of static values, properties can be specified as functions of data (for\nexample path data). You can pass data <code class=\"highlighter-rouge\">.data([1,2])</code> to bound to a selection. If\nthere are fewer nodes than data, extra data elements form the <code class=\"highlighter-rouge\">enter</code> selection\n<code class=\"highlighter-rouge\">.enter().append('p')</code>\nYou can add <code class=\"highlighter-rouge\">.transition().duration(500).delay(function(d,i) { return i*10})</code></p>\n\n<p>Nice tutorial for bar chart using svg\nhttps://alignedleft.com/tutorials/d3/making-a-bar-chart</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var data = [100,400,200, 220, 433, 123, 1, 333]\nvar w = 500\nvar h = Math.max(...data)\nvar barPadding = 1\nvar font_size = 16\n\nvar svg = d3.select('.chart')\n  .append('svg')\n  .attr('width', w)\n  .attr('height', h)\n\nsvg.selectAll('rect')\n  .data(data)\n  .enter()\n  .append('rect')\n  .attr('x', (d, i) =&gt; i * (w/data.length) )\n  .attr('y', (d) =&gt; h - d )\n  .attr('width', w / data.length - barPadding)\n  .attr('height', (d) =&gt; d )\n  .attr('fill', (d) =&gt; 'rgb(0,0,' + (d*255/h) + ')' )\n\nsvg.selectAll('text')\n  .data(data)\n  .enter()\n  .append('text')\n  .text((d) =&gt; d)\n  .attr('text-anchor', 'middle')\n  .attr('x', (d, i) =&gt; i * (w/data.length) + (w/data.length - barPadding)/2 )\n  .attr('font-size', font_size)\n  .attr('font-family', 'sans-serif')\n  .attr('y', (d) =&gt; d &gt; font_size ? h + font_size - d : h - 2 )\n  .attr('fill', (d) =&gt; d &gt; font_size ? 'white' : 'black' )\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Service Workers",
      "category" : "",
      "tags"     : "",
      "url"      : "/2019/03/26/service-workers/",
      "date"     : "2019-03-26 00:00:00 +0100",
      "content"  : "<p>https://davidwalsh.name/write-your-first-service-worker-in-5-minutes</p>\n"
    } ,
  
    {
      "title"    : "Es6 Esnext",
      "category" : "",
      "tags"     : "",
      "url"      : "/2019/03/25/es6-esnext/",
      "date"     : "2019-03-25 00:00:00 +0100",
      "content"  : "<h1 id=\"esnext\">Esnext</h1>\n\n<p>https://medium.freecodecamp.org/es5-to-esnext-heres-every-feature-added-to-javascript-since-2015-d0c255e13c6e\nhttps://blog.bitsrc.io/6-tricks-with-resting-and-spreading-javascript-objects-68d585bdc83</p>\n\n<p>ES6 is ES2015, ES7 is published on 2016 and so on (latest is\nES#{curent_year%2010+(month &gt; june) ? 1 : 0 }).\nES6 features:</p>\n\n<ul>\n  <li>\n    <p>defining variable was using <code class=\"highlighter-rouge\">var a</code> (in strict mode, which is default in ES6,\n error is raised for using undefined variables). If it was defined inside\n function, it was visible only inside it, otherwise global scope. It should be\n declarad at the beggining of a function, because it can be still referecenced\n before declaration and used like a function parameter (hoisting). ES6\n introduced <code class=\"highlighter-rouge\">let</code> and <code class=\"highlighter-rouge\">const</code> with <em>block scope</em>. For example inside <code class=\"highlighter-rouge\">if ()\n { let myVar=1; }</code> (<code class=\"highlighter-rouge\">myVar</code> is not accesible outside of <code class=\"highlighter-rouge\">if</code> block). Also you\n can NOT use variable before we <code class=\"highlighter-rouge\">let variable</code>. Also you can NOT redeclare same\n variable name (or if name is same as param declaration <code class=\"highlighter-rouge\">function f(myName) {\n let myName; }</code>. Notice difference in</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>for (var i = 1; i&lt; 5; i++) {\n  console.log(i)\n  setTimeout(function() {\n    console.log(i) # here we have i = 5,5,5,5 since same variable is used\n    # if we used let i=1;i&lt;5;i++ than it will be different variable: 1,2,3,4\n  }, 1000)\n}\n</code></pre></div>    </div>\n    <p><code class=\"highlighter-rouge\">const MY_CONST = document.querySelect(\".my-class\");</code> have block scope,\nand it should be used for all non volatile variables. If you use object than\nnested values can change <code class=\"highlighter-rouge\">const k = { a: 3 }; k.a = 4</code></p>\n  </li>\n  <li>interpolation of template literals with backticks and curly braces\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var name = \"Duke\";\nconsole.log(`Hello ${name}`);\n\nconst multiLine = `this\nis\nmulti\nline`\n\n// use trim() so you can go to new line at beggining\nlet n = `\nhi\nbye`.trim()\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>array functions are abbreviated syntax for anonymouse functions. If there is\n only one parameter than you can omit parenthesis, if there are no params than\n you can replace parenthesis with <code class=\"highlighter-rouge\">_</code>. One liner syntax (without block) use\n implicit return, for other you need explicit return if you need. If returning\n object, remember to wrap inside parethenses</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var sayHello = (name) =&gt; ({name: `Hello ${name}!`})\nvar sayCiao = name =&gt; {\n  return `Ciao ${name}!`\n}\n</code></pre></div>    </div>\n\n    <p>Note that <code class=\"highlighter-rouge\">self</code> inside arrow functions does not bind to current object for\nobject methods. It binds to outer <code class=\"highlighter-rouge\">this</code> (it is inherited from the execution\ncontext). So <code class=\"highlighter-rouge\">this</code> is usefull only if you have function inside method that is\ndefined in clasical way, ie do not use arrow functions for methods, use\nold functions (when dynamic context is not needed)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>let o = {\n  name: 'name',\n  myMethod: function() {\n    setTimeout( () =&gt; {\n      console.log(this.name) // o.name\n    }, 3000)\n  }\n}\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>destructuring with default values and renaming\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment\">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># destructuring arrays\nlet [, month, date = 1] = '2010-10-11'.split('-')\n# month = '10' and date = '11'\nlet [f, s, ...rest] = [1, 2, 3, 4]\n# f=1, s=2, rest = [3,4]\n\n# destructuring objects\nlet { name, age, gender:sex = 'male' } = { name: 'Duke', age: '33', gender: 'male' }\n# is the same as\nlet name = o.name\nlet age = o.age\nlet sex = o.gender # here we also renaming and have default value\n</code></pre></div>    </div>\n\n    <p>You can also use destructuring when defining methods</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function call({\n  name: 'My Name',\n  phone: '123123',\n} = {}) {\n  console.log(name + ' ' + phone)\n}\n</code></pre></div>    </div>\n\n    <p>You can also destructure nested objects in function params</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var car = {\n  model: 'bmw 2018',\n  engine: {\n    turbo: true,\n    vin: 12345\n  }\n}\n\n// es6 shorthand instead of\n// { vin: vin }\n// you can use just\n// { vin }\nconst modelAndVIN = ({model, engine: {vin}}) =&gt; {\n  console.log(`model: ${model} vin: ${vin}`);\n}\n\nmodelAndVIN(car); // =&gt; model: bmw 2018  vin: 12345\n</code></pre></div>    </div>\n\n    <p>There exists rest <code class=\"highlighter-rouge\">...</code> parameter which convers to array</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const sum = (...a) =&gt; a.reduce((sum, current) =&gt; sum + current, 0)\n</code></pre></div>    </div>\n\n    <p>and same operator <code class=\"highlighter-rouge\">...</code> inside method call is called <em>spread</em> and it expands\narray to params (coffee calls this splats <code class=\"highlighter-rouge\">f(items...)</code>)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>let a = [1, 2, 3]\nf(...a)\n# is the same as\nf(1, 2, 3)\n</code></pre></div>    </div>\n\n    <p>you can also spread objects <code class=\"highlighter-rouge\">let d = { a: 3}; let db = { ...d, b: 3}</code>. But if\nobject has methods, it wont be expanded. If you spread two objects, later will\noverride: <code class=\"highlighter-rouge\">let object1 = { a:1, b:2 }; let object2 = { b:30, c:40}; let merged\n= {…object1, …object2} // {a:1, b:30, c:40}</code>. You can de-duplicate array with\n<code class=\"highlighter-rouge\">let arr = [1, 1, 2, 2, 3, 3]; let deduped = [...new Set(arr)] // [1, 2, 3]</code></p>\n  </li>\n  <li>default parameter values <code class=\"highlighter-rouge\">function g(a=2){}</code>. It\ncan be combined with default destructing params <code class=\"highlighter-rouge\">function g({a=1, b}={b:2}){}</code>\nand <code class=\"highlighter-rouge\">g({a: 2})</code> (ok b=2), <code class=\"highlighter-rouge\">g()</code> (ok a=1, b=2), but <code class=\"highlighter-rouge\">g({})</code> error, b is required.</li>\n  <li>\n    <p>if you need some param to be required you can use this trick</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const required = () =&gt; {throw new Error('Missing parameter')};\n\n//The below function will trow an error if either \"a\" or \"b\" is missing.\nconst add = (a = required(), b = required()) =&gt; a + b;\n\nadd(1, 2) //3\nadd(1) // Error: Missing parameter.\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">for(i=0;i&lt;cars.length;i++) {}</code> is not concise <code class=\"highlighter-rouge\">cars.forEach(myFunction)</code> is\nconcise but can not break out of the loop. ES6 gives <code class=\"highlighter-rouge\">for(let ... of ..) {}</code>\n(for values in array) and <code class=\"highlighter-rouge\">for..in</code> (for object property names)) is concise\nand can break. Use <code class=\"highlighter-rouge\">.entries()</code> to get index\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>for(let [i, car] of cars.entries()) { car }`\n</code></pre></div>    </div>\n\n    <p>To convert HtmlCollection to array you can use <code class=\"highlighter-rouge\">Array.from(htmlCollection)</code></p>\n  </li>\n  <li><code class=\"highlighter-rouge\">array.reduce(function, init_value)</code> can be used as filtering if <code class=\"highlighter-rouge\">init_value</code>\nis array, than function takes two arguments (init_value, array_item)\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const numbers = [10, 20, 30, 40];\n\nconst doubledOver50 = numbers.reduce((finalList, num) =&gt; {\n  num = num * 2; //double each number (i.e. map)\n  //filter number &gt; 50\n  if (num &gt; 50) {\n    finalList.push(num);\n  }\n  return finalList;\n}, []);\ndoubledOver50; // [60, 80]\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p><code class=\"highlighter-rouge\">class Person</code> can be used to instantiate objects <code class=\"highlighter-rouge\">new Person()</code>. For\ninitialization you can use <code class=\"highlighter-rouge\">constructor(name) { this.name = name }</code>\nInstead of hash method <code class=\"highlighter-rouge\">full_name: function() {}</code> we can write <code class=\"highlighter-rouge\">full_name(){}</code>\nExtend classes <code class=\"highlighter-rouge\">class Employee extends Person {}</code> so we don’t need to write\n<code class=\"highlighter-rouge\">Employee.prototype = new Person</code> (or <code class=\"highlighter-rouge\">var e = { __proto__: person }</code>.\nInside <code class=\"highlighter-rouge\">class</code> we can define instance and <code class=\"highlighter-rouge\">static</code> methods. Static methods are\ncalled without instantiating their class (used for utility functions).\nMultiple inheritance can be achieved with mix-ins https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes#Mix-ins\nYou can use getter (or setter) which binds an object property to a function\nthat will be called when that property is looked up (or attempt to set that\nproperty <code class=\"highlighter-rouge\">e.full_name =</code>)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Empoyee extends Person {\n  constructor(name) {\n    super(name);\n\n    this.proffessional_name = name;\n  }\n  get full_name() {\n    return this.name;\n  }\n  set full_name(name) {\n    this.name = name;\n  }\n\n  static myUtilityFunction(uppercase) {\n    return uppercase;\n  }\n\n  hello() {\n    return `Hi, I'm ${name}`\n  }\n}\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>new data structure called <code class=\"highlighter-rouge\">Map</code> and <code class=\"highlighter-rouge\">WeakMap</code> (keys are objects, not plain\nvalues like number, string or symbol)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var map = new Map();\nmap.set('year', '123');\nmap.get('year'); // '123'\n\n# or use initialization\nm = new Map([['color', 'red'],['owner', 'me']])\nm.size\nm.keys()\nm.values()\nm.delete('color')\nm.clear()\n</code></pre></div>    </div>\n  </li>\n  <li>new data structure called <code class=\"highlighter-rouge\">Set</code> and <code class=\"highlighter-rouge\">WeakSet</code></li>\n  <li>new string functions\n<code class=\"highlighter-rouge\">'asd'.startsWith('a');'asd'.endsWith('a');'asd'.includes('as');'a'.repeat(3);</code></li>\n  <li>new Array functions\n    <ul>\n      <li><code class=\"highlighter-rouge\">Array.from([1,2,3], x =&gt; x + x)</code></li>\n      <li><code class=\"highlighter-rouge\">Array.find( user =&gt; user.age &gt; 15)</code> same as <code class=\"highlighter-rouge\">Array.findIndex</code> but returns\n object instead of index</li>\n      <li><code class=\"highlighter-rouge\">[1,2,3].filter( (n) =&gt; n &gt; 2 )</code></li>\n      <li><code class=\"highlighter-rouge\">[1,2].includes(3)</code> returns false</li>\n    </ul>\n  </li>\n  <li>\n    <p>property value shorthands, when you define object and you already have\nvariable with same name as key, you can use</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const name = 'dule'\nconst anPerson = {\n  name\n}\n// is the same as\nconst aPerson = {\n  name: name\n}\n</code></pre></div>    </div>\n\n    <p>it also exists for methods</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const aPerson = {\n  speak (word) {},\n  // same as\n  speak: function (word) {},\n  // do not use array because you can not acsess this\n  // speak: () =&gt; {},\n}\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>computed object property names</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const name = 'dule'\n\nconst aPerson = {\n  'mile': 'value',\n  [name]: 'dule is key and value',\n  [name+'car']: 'value',\n}\n</code></pre></div>    </div>\n  </li>\n  <li>generators\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function *calculator(input) {\n  var doubleThat = 2 * (yield (input / 2))\n  var another = yield (doubleThat)\n  return (input * doubleThat * another)\n}\n</code></pre></div>    </div>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const calc = calculator(10)\n// start\n&gt; c.next()\n{ value: 5, done: false }\n&gt; c.next(7)\n{ value: 14, done: false }\n&gt; c.next(100)\n{ value: 14000, done: true }\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>ES2017</p>\n\n<ul>\n  <li>in function declarations and function calls you can use trailing commas\n<code class=\"highlighter-rouge\">doSomething(p1, p2,)</code></li>\n</ul>\n\n<p>ES2019 ESNext</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">[1,[2]].flat(Infinity)</code> and\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>['My dog', 'is awesome'].flatMap(words =&gt; words.split(' '))\n//[ 'My', 'dog', 'is', 'awesome' ]\n</code></pre></div>    </div>\n  </li>\n  <li>create object from entries <code class=\"highlighter-rouge\">newPerson =\nObject.fromEntries(Object.entries(person))</code></li>\n</ul>\n\n<h1 id=\"promise\">Promise</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>let done = true\n\nconst isItDoneYet = new Promise((resolve, reject) =&gt; {\n  if (done) {\n    const workDone = 'Here is the thing I built'\n    resolve(workDone)\n  } else {\n    const why = 'Still working on something else'\n    reject(why)\n  }\n})\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">Promise.all([p1, p2]).then</code> will be executed when all are resolved\n<code class=\"highlighter-rouge\">Promise.race([p1, p2]).then</code> will be executed when first (any) is resolved</p>\n\n<p>Async/Await</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const doSomethingAsync = () =&gt; {\n  return new Promise(resolve =&gt; {\n    setTimeout( () =&gt; resolve('Here is thing I built after some delay'), 2000);\n  })\n}\n\nconst doSomething = async () =&gt; {\n  console.log(await doSomethingAsync())\n}\n</code></pre></div></div>\n\n<p>Using <code class=\"highlighter-rouge\">async</code> to a function means that it will return promise, so those two\nfunctions are the same:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>const aFunction = async () =&gt; {\n  return 'test'\n}\n\nconst aFunction = () =&gt; {\n  return Promise.resolve('test')\n}\n\naFunction().then(console.log)\n</code></pre></div></div>\n\n<p>ES2018 there is <code class=\"highlighter-rouge\">for await (const line of readLines(filePath)) { log(line) }</code></p>\n\n<p><code class=\"highlighter-rouge\">.finnaly()</code> is executed regardless of the successful or not promise.</p>\n\n<h1 id=\"modules\">Modules</h1>\n\n<p>Import bindings which are exported by another module (js file). Module is just\njs script (no need for special keyword) but everything defined inside module is\nlocal to the module, except when you use <code class=\"highlighter-rouge\">export</code>.\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import\">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function myModule() {\n  this.hello = function() {\n    return 'hello\n  }\n}\n\nmodule.exports = myModule\n</code></pre></div></div>\n\n<p>Note that for Webpack you can use CommonJS module and use with <code class=\"highlighter-rouge\">require</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var myModule = require('myModule');\n\nvar myModuleInstance = new myModule();\nmyModuleInstance.hello(); // 'hello!'\n</code></pre></div></div>\n\n<p>Using Asynchronous Module Definition AMD can load modules async using <code class=\"highlighter-rouge\">define</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>define(['myModule', 'myOtherModule'], function(myModule, myOtherModule) {\n  console.log(myModule.hello());\n});\n</code></pre></div></div>\n\n<p>Universal Module Definition UMD combines AMD and CommonJS. But ECMASCRIPT 6\nintroduce <code class=\"highlighter-rouge\">import</code> and <code class=\"highlighter-rouge\">export</code> methods which replace all those functions…\nSo if you write libs for web you should create all variations so it can be\nused in webpack or directly\nhttps://medium.com/@kelin2025/so-you-wanna-use-es6-modules-714f48b3a953\nhttp://krasimirtsonev.com/blog/article/javascript-library-starter-using-webpack-es6</p>\n\n<p>You can export any top level function, class, var, let or const.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// lim/math.js\nexport function sum(x, y) {\n  return x + y;\n}\nexport let pi = 3.141593;\n\n// or you could use export list\nexport { sum, pi };\n</code></pre></div></div>\n\n<p>You can name the export as <code class=\"highlighter-rouge\">default</code> and in this case you can use anonymous\nfunctions (otherwise you have to name each export so it can be distinquished\nfrom other exports)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>let myObject = {\n  field1: value1,\n  field2: value2\n};\nexport {myObject as default};\n// or better use shorthand\nexport default {\n  field1: value1,\n  field2: value2\n};\n</code></pre></div></div>\n\n<p>Note that with <code class=\"highlighter-rouge\">import</code> you should use brackets if there is no default export,\nand check the form of the <code class=\"highlighter-rouge\">export</code> command.\nhttps://developer.mozilla.org/en-US/docs/web/javascript/reference/statements/export\nDefault import</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// import what is default exported and bind bind to defaultExport\nimport defaultExport from \"module-name\";\n// this is shorthand of\nimport { default as defaultExport } from 'module-name';\n</code></pre></div></div>\n\n<p>Namespace import</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import * as name from \"module-name\";\n</code></pre></div></div>\n<p>Named import</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import { export } from \"module-name\";\nimport { export as alias } from \"module-name\";\nimport { export1 , export2 } from \"module-name\";\nimport { export1 , export2 as alias2 , [...] } from \"module-name\";\n</code></pre></div></div>\n<p>combination of default import and named or namespaces import</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import defaultExport, { export [ , [...] ] } from \"module-name\";\nimport defaultExport, * as name from \"module-name\";\n// just run the code, not importing anything\nimport \"module-name\";\n</code></pre></div></div>\n\n<p>module-name is relative (<code class=\"highlighter-rouge\">./lib/math</code> or <code class=\"highlighter-rouge\">lib/math</code>) or absolute path name to\nthe <code class=\"highlighter-rouge\">.js</code> file</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import * as math from \"lib/math\";\nconsole.log(\"2pi = \" + math.sum(math.pi, math.pi));\n\n// or we could\nimport { pi, sum } from \"lib/math\";\nconsole.log(\"2pi = \" + sum(pi, pi));\n</code></pre></div></div>\n\n<p>In html you can include using script tag with <code class=\"highlighter-rouge\">type='module'</code></p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;meta</span> <span class=\"na\">charset=</span><span class=\"s\">\"utf-8\"</span><span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;script </span><span class=\"na\">type=</span><span class=\"s\">'module'</span> <span class=\"na\">src=</span><span class=\"s\">'./app.js'</span><span class=\"nt\">&gt;&lt;/script&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    asd up is\n    <span class=\"nt\">&lt;span</span> <span class=\"na\">id=</span><span class=\"s\">'up'</span><span class=\"nt\">&gt;&lt;/span&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n\n# app.js\nimport toUp from './t.js'\ndocument.getElementById('up').innerHTML = toUp('asd')\n\n# t.js\nexport default (str) =&gt; str.toUpperCase()\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Rails Translations I18n",
      "category" : "",
      "tags"     : "",
      "url"      : "/2019/01/04/rails-translations-i18n/",
      "date"     : "2019-01-04 00:00:00 +0100",
      "content"  : "<h1 id=\"localisation-i18n-translations\">Localisation i18n translations</h1>\n\n<p>Tips <a href=\"https://devhints.io/rails-i18n\">https://devhints.io/rails-i18n</a>\nTranslate models using <code class=\"highlighter-rouge\">activerecord</code>\nhttps://guides.rubyonrails.org/i18n.html#translations-for-active-record-models\nso you can use</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>User.model_name.human\n# pluralize\nUser.model_name.human(count: 2)\n# attribute\nUser.human_attribute_name(:email)\n</code></pre></div></div>\n\n<p>To translate active record messages for specific attributes, you can overwrite\nmessages for specific model and attributes (default ActiveRecord messages taken)\n<a href=\"https://github.com/rails/rails/blob/master/activerecord/lib/active_record/locale/en.yml#L23\">https://github.com/rails/rails/blob/master/activerecord/lib/active_record/locale/en.yml#L23</a>\n<a href=\"https://apidock.com/rails/v4.2.7/ActiveModel/Errors/generate_message\">https://apidock.com/rails/v4.2.7/ActiveModel/Errors/generate_message</a></p>\n\n<p>Also you can change format <code class=\"highlighter-rouge\">errors.format: Polje \"%{attribute}\" %{message}</code>\nhttps://github.com/rails/rails/blob/master/activemodel/lib/active_model/locale/en.yml#L4\nYou can use custom notice:\nYou can also see some default en translations for errors.\nTo see Rails default datetime formats go to\nhttps://github.com/svenfuchs/rails-i18n/blob/master/rails/locale/en.yml\nto see current translation you can use</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>I18n.translate 'date.formats.default`\n=&gt; \"%Y-%m-%d\"\n</code></pre></div></div>\n\n<p>And you can change attribute name <code class=\"highlighter-rouge\">activerecord.attributes.user.email: имејл</code>\nTo translate also plurals you can use <code class=\"highlighter-rouge\">User.model_name.human(count: 2)</code>. For\nattributes you can use <code class=\"highlighter-rouge\">User.human_attribute_name(\"email\")</code>\n<a href=\"http://guides.rubyonrails.org/i18n.html#translations-for-active-record-models\">link</a>\nFor <code class=\"highlighter-rouge\">ApplicationRecord</code> translate <code class=\"highlighter-rouge\">activerecord</code>.\nFor form objects <code class=\"highlighter-rouge\">include ActiveModel::Model</code> you should translate\n<code class=\"highlighter-rouge\">activemodel</code>. There you can use <code class=\"highlighter-rouge\">t('successfully')</code> instead\n<code class=\"highlighter-rouge\">I18n.t('successfully')</code> if you <code class=\"highlighter-rouge\">include AbstractController::Translation</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/locales/activerecord_activemodels.en.yml\nen:\n  activerecord:\n    models:\n      user:\n        zero: No dudes\n        one: Dude\n        other: Dudes\n  activemodel:\n    attributes:\n      landing_signup:\n        current_city: Који је твој град ?\n    errors:\n      messages:\n        group_not_exists_for_age: Не постоји група (%{age}год) на овој локацији\n      models:\n        landing_signup:\n          attributes:\n            current_city:\n              blank: Не може бити празно ?\n    models:\n      user:\n        one: корисник\n        other: корисници\n        accusative: корисника\n        some_customer_message: Моја порука\n</code></pre></div></div>\n\n<p>Separate translations into different files (for example\n<code class=\"highlighter-rouge\">activerecord_activemodels.sr.yml</code>) include them with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/application.rb\nconfig.i18n.load_path += Dir[Rails.root.join('config', 'locales', '**', '*.{rb,yml}')]\n\n# Whitelist locales available for the application\nI18n.available_locales = [:en, :pt]\n\n# Set default locale to something other than :en\nI18n.default_locale = :pt\n</code></pre></div></div>\n\n<p>To raise error when translation is missing <code class=\"highlighter-rouge\">.translation_missing</code> class</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/application.rb\nconfig.action_view.raise_on_missing_translations = true\n</code></pre></div></div>\n\n<p>This way you can change default_locale and run system tests and you will get\nexception if some locale is missing.</p>\n\n<p>No need to write quotes in yml unless you have:</p>\n<ul>\n  <li>colon <code class=\"highlighter-rouge\">:</code> , than simply escape it’s meaning and use quotes <code class=\"highlighter-rouge\">name: \"name: Ime\"</code></li>\n  <li>start with <code class=\"highlighter-rouge\">%{}</code> or <code class=\"highlighter-rouge\">,</code> or <code class=\"highlighter-rouge\">.</code></li>\n  <li>have <code class=\"highlighter-rouge\">answer: Yes</code> or <code class=\"highlighter-rouge\">answer: No</code>, is somehow casts to <code class=\"highlighter-rouge\">true</code> or <code class=\"highlighter-rouge\">false</code></li>\n  <li>have double quotes inside <code class=\"highlighter-rouge\">processing: &lt;i class=\"fa fa-spinner fa-spin\n datatable-spinner\"&gt;&lt;/i&gt;Обрада...</code>. Than you need to switch to single quotes.\n Note that it does not help to wrap double quotes with single quote, this won’t\n work: <code class=\"highlighter-rouge\">processing: '&lt;i class=\"c\"&gt;&lt;/i&gt;'</code> since you have double quote inside.</li>\n</ul>\n\n<p>When debugging <code class=\"highlighter-rouge\">SyntaxError: [stdin]:60:33: unexpected identifier</code> you should\nrun <code class=\"highlighter-rouge\">rake tmp:clear</code> so all yml end .erb files are compiled again.</p>\n\n<p>If you want to reuse same translation you can use alias, but only inside same\nfile, so in case of form object, you can add to activerecord_models.yml</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sr:\n  activerecord:\n    attributes:\n      subscriber: &amp;subscriber_attributes\n        name: Назив\n      project: &amp;project_attributes\n        name: Назив\n  activemodel:\n    attributes:\n      project_task_notification:\n        &lt;&lt;: *project_attributes\n        &lt;&lt;: *subscriber_attributes\n        project_name: Назив\n</code></pre></div></div>\n\n<p>For custom errors can be different for each attribute or same. Can also accept\nparam, for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    errors.add :from_group_age, :group_not_exists_for_age, age: age\n</code></pre></div></div>\n\n<p>https://stackoverflow.com/questions/6166064/i18n-pluralization\nFor serbian you can provide pluralization</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/locales/plurals.rb\n# https://github.com/svenfuchs/i18n/blob/master/test/test_data/locales/plurals.rb\nserbian = {\n  i18n: {\n    plural: {\n      keys: %i[one few many other],\n      rule: lambda { |n|\n        if n % 10 == 1 &amp;&amp; n % 100 != 11\n          :one\n        elsif [2, 3, 4].include?(n % 10) &amp;&amp; ![12, 13, 14].include?(n % 100)\n          :few\n        # elsif (n % 10).zero? || [5, 6, 7, 8, 9].include?(n % 10) || [11, 12, 13, 14].include?(n % 100)\n        #   :many\n        # there are no other integers, use :many if you need to differentiate\n        # with floats\n        else\n          :other\n        end\n      }\n    }\n  }\n}\n{\n  sr: serbian,\n  'sr-latin': serbian,\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/pluralization.rb\nrequire 'i18n/backend/pluralization'\nI18n::Backend::Simple.send(:include, I18n::Backend::Pluralization)\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/locales/sr.yml\nsr:\n  sent_messages:\n    # 1, 21, 31 ...\n    one: %{count} порука је послата\n    # 2, 3, 4, 22, 23, 24, 32, 33, 34 ...\n    few: %{count} поруке су послате\n    # all other integers: 5, 6, ... 9, 10, 11, 12, 13, 14 ... 20, 25, ...\n    many: %{count} порука је послато\n</code></pre></div></div>\n\n<p>Note that you have to provide <code class=\"highlighter-rouge\">few</code> translation for all words, since it could\nhappend that count is 2 and translation is missing.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>I18n.t 'sent_messages', count: 15\n# or if you want to translate model\n\"#{chat.moves.size} #{Move.model_name.human count: chat.moves.size}\"\n</code></pre></div></div>\n\n<p>You can translate to any language with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>I18n.t 'sent_messages', locale: :sr\n</code></pre></div></div>\n\n<p>Example for Serbian localizations translations:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/locales/sr.yml\nsr:\n  # https://github.com/rails/rails/blob/master/activemodel/lib/active_model/locale/en.yml#L8\n  errors:\n    format: Поље \"%{attribute}\" %{message}\n    messages:\n      blank: не сме бити празно\n      invalid: није исправно\n  neo4j:\n    errors:\n      messages:\n        required: мора постојати\n        taken: је већ заузет\n    models:\n      user: корисник\n      location:\n        one: локација\n        other: локације\n    attributes:\n      user:\n        email: Имејл\n        password: Лозинка\n        password_confirmation: Потврда лозинке\n        remember_me: Запамти ме\n</code></pre></div></div>\n\n<p>When you use <code class=\"highlighter-rouge\">.capitalize</code>, <code class=\"highlighter-rouge\">.titleize</code> or <code class=\"highlighter-rouge\">.upcase</code> than you need first to call\n<code class=\"highlighter-rouge\">.mb_chars</code>. For example</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>'ž'.upcase\n=&gt; \"ž\"\n\n'ž'.mb_chars.upcase.to_s\n =&gt; \"Ž\"\n</code></pre></div></div>\n<p>Some common words translations can be found\n<a href=\"https://github.com/svenfuchs/rails-i18n/blob/master/rails/locale/en.yml\">https://github.com/svenfuchs/rails-i18n/blob/master/rails/locale/en.yml</a></p>\n\n<p>To translate with accusative you need to joins strings or use param in\ntranslation</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>module TranslateHelper\n  # there are two ways of calling this helper:\n  # t_crud 'are_you_sure_to_remove_item', item: @move\n  # t_crud 'edit', User\n  def t_crud(action, model_class)\n    if model_class.class == Hash\n      t(action, item: t(\"neo4j.models.#{model_class[:item].name.downcase}.accusative\"))\n    else\n      \"#{t(action)} #{t(\"neo4j.models.#{model_class.name.downcase}.accusative\")}\"\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>Translate latin to cyrilic with <a href=\"https://github.com/dalibor/cyrillizer\">https://github.com/dalibor/cyrillizer</a> You need\nto set language in config</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n# translate cyrillic\ngem 'cyrillizer'\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/cyrillizer.rb\nCyrillizer.language = :serbian\n</code></pre></div></div>\n\n<p>In console</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>'my string'.to_cyr\n =&gt; \"мy стринг\"\n</code></pre></div></div>\n\n<p>Note that some chars looks the same but are not when rendered on html page</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> # for example first line is not correct link a href\n &lt;a href='%{confirmation_url}'&gt;Поново пошаљи упутство за потврду&lt;/а&gt;\"\n &lt;a href='%{confirmation_url}'&gt;Поново пошаљи упутство за потврду&lt;/a&gt;\"\n</code></pre></div></div>\n\n<h1 id=\"locale\">Locale</h1>\n\n<p>When changing locale <code class=\"highlighter-rouge\">I18n.locale = :sr</code> in some methods, note that this is\nglobal variable in thread, so when you have 5 puma threads than on GET requests\n(simply refresh couple of times) you will get different locales.\nHere is my Rails controbution to guide about it https://github.com/rails/rails/pull/34911\nOne way is to use <code class=\"highlighter-rouge\">I18n.with_locale</code> for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class UserMailer &lt; ActionMailer::Base\n  default from: 'noreply@translation.io'\n\n  def invitation(user)\n    I18n.with_locale(user.locale) do\n      mail subject: t('invitation'), to: user.email\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>For controller, you need to use around filters</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  around_action :set_locale_from_session\n\n  def set_locale_from_session\n    if session[:locale].present?\n      I18n.with_locale session[:locale].to_sym do\n        yield\n      end\n    else\n      yield\n    end\n  end\n</code></pre></div></div>\n\n<h1 id=\"translating-user-content\">Translating user content</h1>\n\n<p>https://github.com/shioyama/mobility#quickstart</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n# translation\ngem 'mobility', '~&gt; 0.8.6'\n\n# this will generate config/initializers/mobility.rb\nrails g mobility:install\n\n# app/models/activity.rb\nclass Activity &lt; ApplicationRecord\n  extend Mobility\n  translates :name\nend\n\n# in migration add default value\n  create_table :activities, id: :uuid do |t|\n    t.json :name, default: {}\n</code></pre></div></div>\n\n<p>For google translate look for two scripts, one for vim and one for whole yml.\nhttps://github.com/duleorlovic/config/tree/master/ruby</p>\n"
    } ,
  
    {
      "title"    : "Java In Android Studio",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/12/10/java-in-android-studio/",
      "date"     : "2018-12-10 00:00:00 +0100",
      "content"  : "<h1 id=\"install-firebase\">Install Firebase</h1>\n\n<p>There is a collection of apps for quick start\nhttps://github.com/firebase/quickstart-android</p>\n\n<p><code class=\"highlighter-rouge\">google-services.json</code> file should be copied to <code class=\"highlighter-rouge\">app/</code> folder, but you can use\ndifferent google services json for different build type\nhttps://developers.google.com/android/guides/google-services-plugin#adding_the_json_file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>app/google-services.json\napp/src/release/google-services.json\n</code></pre></div></div>\n\n<p>To connect your app with Firebase you can use Gradle or Assistant.\nFor using Gradle, you need to copy SHA and paste to firebase console. To get\n<code class=\"highlighter-rouge\">Debug signing certificate SHA-1 (optional)</code> from the Android Studio, you can go\nto right toolbox <code class=\"highlighter-rouge\">Gradle</code> and double click on <code class=\"highlighter-rouge\">root -&gt; Tasks -&gt; android -&gt;\nsigninReport</code>. Another way to get sha is running command</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>keytool --exportcert -list -v -alias androiddebugkey -keystore $ANDROID_SDK_ROOT/.android/debug.keystore\nEnter keystore password:\n# type: android\n</code></pre></div></div>\n\n<p>Using assistant, you will grand permission to update your firebase settings, so\nyou do not need to paste.</p>\n\n<p>You can register different firebase project with the same package name, but you\nneed to use different signing key (it is not possible to have same SHA on two\ndifferent projects for the same package name). So you need to use another key\n(you can keep same package name <code class=\"highlighter-rouge\">com.myapp.app</code>).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>keytool --exportcert -list -v -alias key0 -keystore app/myapp_debug.jks\n# type the password: myapp123456\n# in output find SHA1: 87:16:52:08:C7:B1:BE:BC:73:BE:9E:37:64:67:CB:9D:76:0C:2B:01\n</code></pre></div></div>\n\n<p>Add dependencies</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># build.gradle\nbuildscript {\n  dependencies {\n    // Add this line\n    classpath 'com.google.gms:google-services:4.0.1'\n  }\n}\n\n# app/build.gradle\ndependencies {\n  // Add this line\n  implementation 'com.google.firebase:firebase-core:16.0.1'\n}\n\n// Add to the bottom of the file\napply plugin: 'com.google.gms.google-services'\n</code></pre></div></div>\n\n<h1 id=\"signing-config-keys\">Signing config keys</h1>\n\n<p>https://coderwall.com/p/zrdsmq/signing-configs-with-gradle-android\nInstead of default certificate located at <code class=\"highlighter-rouge\">$HOME/.android/debug.keystore</code> (which\nis different for each user ie sdk installation) you can create your own keys.\nThat way new developer do not need to add SHA to firebase project, since he can\nimediatelly build and run the app in emulator or device.</p>\n\n<p>https://developer.android.com/studio/publish/app-signing\nThere are <code class=\"highlighter-rouge\">signing</code> and <code class=\"highlighter-rouge\">upload</code> key.</p>\n\n<p>You can sign in manually from command line or using gradle https://developer.android.com/studio/publish/app-signing#gradle-sign\nGenerate <code class=\"highlighter-rouge\">.jks</code> file from Android studio</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/build.gradle\nandroid {\n+    signingConfigs {\n+      debug {\n+          // You need to specify either an absolute path or include the\n+          // keystore file in the same directory as the build.gradle file.\n+          storeFile file(\"mykey.jks\")\n+          storePassword \"asdf\"\n+          keyAlias \"key0\"\n+          keyPassword \"asdf\"\n+      }\n+    }\n+\n     buildTypes {\n         release {\n             minifyEnabled false\n             proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n         }\n+        debug {\n+            signingConfig signingConfigs.debug\n+\n+        }\n     }\n</code></pre></div></div>\n\n<p>Release to App Store https://www.youtube.com/watch?v=AWawL5HFn64</p>\n\n<h1 id=\"keyboard-shortcuts\">Keyboard shortcuts</h1>\n\n<ul>\n  <li>Comment with <code class=\"highlighter-rouge\">Ctrl + /</code> uncomment with <code class=\"highlighter-rouge\">Ctrl + shift + /</code></li>\n  <li><code class=\"highlighter-rouge\">Alt + Enter</code> when you want to import something that can not be resolved (when\nyou paste some code snipets))</li>\n  <li>fix code indent with <code class=\"highlighter-rouge\">Ctrl + Alt + Super + L</code></li>\n</ul>\n\n<h1 id=\"webview\">Webview</h1>\n\n<p>https://developer.android.com/guide/webapps/webview#java\nStart new app with blank intent.\nIn <code class=\"highlighter-rouge\">app/serv/main/AndroidManifest.xml</code> add permission for internet and also for\nhttp traffic https://stackoverflow.com/questions/45940861/android-8-cleartext-http-traffic-not-permitted/50834600#50834600</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;manifest...\n    &lt;uses-permission android:name=\"android.permission.INTERNET\"&gt;&lt;/uses-permission&gt;\n    &lt;application\n        ...\n        android:usesCleartextTraffic=\"true\"\n</code></pre></div></div>\n\n<p>In java you need to enable javascript in webview, set user agent so you can\ncustomize the response.</p>\n\n<p>https://github.com/duleorlovic/android-webview-example/commit/3097878534c019264f58050612a2d5564267b63d</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>public class MainActivity extends AppCompatActivity {\n\n    private WebView myWebView;\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n        myWebView = (WebView) findViewById(R.id.webview);\n//        setContentView(myWebView);\n        WebSettings webSettings = myWebView.getSettings();\n        webSettings.setJavaScriptEnabled(true);\n        webSettings.setUserAgentString(\"myapp\");\n        myWebView.setWebViewClient(new MyWebViewClient());\n        myWebView.addJavascriptInterface(new WebAppInterface(this), \"Android\");\n\n        myWebView.loadUrl(\"http://192.168.5.4:3001/\");\n    }\n\n    @Override\n    public boolean onKeyDown(int keyCode, KeyEvent event) {\n        // Check if the key event was the Back button and if there's history\n        if ((keyCode == KeyEvent.KEYCODE_BACK) &amp;&amp; myWebView.canGoBack()) {\n            myWebView.goBack();\n            return true;\n        }\n        // If it wasn't the Back key or there's no web page history, bubble up to the default\n        // system behavior (probably exit the activity)\n        return super.onKeyDown(keyCode, event);\n    }\n}\n\npublic class WebAppInterface {\n    Context mContext;\n\n    /** Instantiate the interface and set the context */\n    WebAppInterface(Context c) {\n        mContext = c;\n    }\n\n    /** Show a toast from the web page */\n    @JavascriptInterface\n    public void showToast(String toast) {\n        Toast.makeText(mContext, toast, Toast.LENGTH_SHORT).show();\n    }\n}\n</code></pre></div></div>\n\n<ul>\n  <li>to change launcher icon and other icons you can go to File -&gt; New -&gt; Image\nAsset and than select “Lanucher icons” and add svg image file. Repeat proccess\nbut select “Notification icons”. You can see <code class=\"highlighter-rouge\">git status</code> that existing files\nwill be updated, for example <code class=\"highlighter-rouge\">app/src/main/res/mipmap-hdpi/ic_launcher.png</code>\ninsteaad of mipmap-hdpi, there is mipmap-mdpi/xhdmpi/xxhdpi/xxxhdpi density\nand ic_launcher_foreground.png/ic_launcher_round.png\nThere is <code class=\"highlighter-rouge\">app/src/main/res/values/ic_launcher_background.xml</code> which is some\n<code class=\"highlighter-rouge\">vector</code> but do not know how to use it.\nFor notification icon path is <code class=\"highlighter-rouge\">app/src/main/res/drawable/ic_notificaiton.png</code></li>\n</ul>\n\n<h1 id=\"const-for-server-url\">Const for server Url</h1>\n\n<p>When you build <code class=\"highlighter-rouge\">release</code> (Build -&gt; Select build variant -&gt; release), by default\n<code class=\"highlighter-rouge\">serverUrl</code> is targeting production server <code class=\"highlighter-rouge\">https://myapp.herokuapp.com</code>.\nWhen you want to target local Rails server than choose <code class=\"highlighter-rouge\">debug</code> and update\n<code class=\"highlighter-rouge\">app/src/main/java/com/myapp/app/Const.java</code>, by default is\n<code class=\"highlighter-rouge\">http://192.168.5.4:3001</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">package</span> <span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">myapp</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">;</span>\n\n<span class=\"n\">import</span> <span class=\"n\">android</span><span class=\"p\">.</span><span class=\"n\">content</span><span class=\"p\">.</span><span class=\"n\">Context</span><span class=\"p\">;</span>\n<span class=\"n\">import</span> <span class=\"n\">android</span><span class=\"p\">.</span><span class=\"n\">content</span><span class=\"p\">.</span><span class=\"n\">pm</span><span class=\"p\">.</span><span class=\"n\">ApplicationInfo</span><span class=\"p\">;</span>\n\n<span class=\"k\">public</span> <span class=\"n\">class</span> <span class=\"n\">Const</span> <span class=\"p\">{</span>\n   <span class=\"p\">//</span> <span class=\"n\">Use</span> <span class=\"n\">for</span> <span class=\"n\">example</span>\n   <span class=\"p\">//</span> <span class=\"k\">String</span> <span class=\"n\">mUrl</span> <span class=\"p\">=</span> <span class=\"n\">Const</span><span class=\"p\">.</span><span class=\"n\">getServerUrl</span><span class=\"p\">(</span><span class=\"n\">getApplicationContext</span><span class=\"p\">());</span>\n   <span class=\"p\">//</span>\n    <span class=\"k\">public</span> <span class=\"n\">static</span> <span class=\"k\">String</span> <span class=\"n\">getServerUrl</span><span class=\"p\">(</span><span class=\"n\">Context</span> <span class=\"n\">context</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"k\">boolean</span> <span class=\"n\">isDebuggable</span> <span class=\"p\">=</span> <span class=\"p\">(</span><span class=\"m\">0</span> <span class=\"c1\">!= (context.getApplicationInfo().flags\n</span>                <span class=\"p\">&amp;</span> <span class=\"n\">ApplicationInfo</span><span class=\"p\">.</span><span class=\"n\">FLAG_DEBUGGABLE</span><span class=\"p\">));</span>\n        <span class=\"k\">String</span> <span class=\"n\">mUrl</span><span class=\"p\">;</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">isDebuggable</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n            <span class=\"n\">mUrl</span> <span class=\"p\">=</span> <span class=\"s2\">\"http://192.168.5.4:3001\"</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n            <span class=\"n\">mUrl</span> <span class=\"p\">=</span> <span class=\"s2\">\"https://myaapp.herokuapp.com\"</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span>\n    <span class=\"n\">return</span><span class=\"p\">(</span><span class=\"n\">mUrl</span><span class=\"p\">);</span>\n\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<h1 id=\"release-new-version-on-play-store\">Release new version on Play store</h1>\n\n<p>Increment <code class=\"highlighter-rouge\">android { defaultConfig { versionCode X }}}</code> in <code class=\"highlighter-rouge\">app/build.gradle</code>.\n(Module: app). Than go to Build -&gt; Generate Signed Bundle or APK -&gt; Apk -&gt;\nChoose\n<code class=\"highlighter-rouge\">app/myaapp.jks</code> and add passwords from gradle config. Upload\n<code class=\"highlighter-rouge\">app/release/app-release.apk</code> to Google Play console , Release Management -&gt; App\npreleases -&gt; Production Track -&gt; Manage -&gt; Create Release or Edit Release\nhttps://play.google.com/apps/publish/</p>\n\n<p>Note that Playstore is somehow cached on Emulator, so install from real device\nwhen you want to checound latest release.</p>\n\n<h1 id=\"errors\">Errors</h1>\n\n<p>When I Import existing project the subfolders, I got error</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Gradle sync failed: Could not find com.google.gms:google-services:4.2.0.\n</code></pre></div></div>\n\n<p>so I need to add this line to gradle https://stackoverflow.com/questions/53706565/error-could-not-find-com-google-gmsgoogle-services4-2-0</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>maven { url 'https://dl.bintray.com/android/android-tools' }\n</code></pre></div></div>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>add loader before page is shown https://android.jlelse.eu/loading-splash-screen-for-webview-in-android-studio-ef68ec05720a</li>\n  <li>if you have multiple andoird icons</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Alexa Aws Lambda",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/12/10/alexa-aws-lambda/",
      "date"     : "2018-12-10 00:00:00 +0100",
      "content"  : "<p>Aws Lambda supports ruby\nhttps://aws.amazon.com/blogs/compute/announcing-ruby-support-for-aws-lambda/</p>\n"
    } ,
  
    {
      "title"    : "Tableless Search Union Of Multiple Models Using Polymorphic Association In Rails",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/12/02/tableless-search-union-of-multiple-models-using-polymorphic-association-in-rails/",
      "date"     : "2018-12-02 00:00:00 +0100",
      "content"  : "<p>Common problem is to enable search on the site, but with differt kind of results\n(posts, comments, books). So we need to combine different models in one action\nand still enable pagination and sorting (so merge arrays is not considered\nhere).</p>\n\n<p>Also, you might need to show all instances for\nsearched used user (<code class=\"highlighter-rouge\">belongs_to :created_by</code>, or habtm <code class=\"highlighter-rouge\">book_users</code>).</p>\n\n<p>Solution is to create new model without table (tabless active record). For rails\n4 https://gist.github.com/dalibor/228654 but for Rails 5 we need to override <code class=\"highlighter-rouge\">load_schema!</code>\nhttps://stackoverflow.com/questions/41494951/how-to-create-activerecord-tableless-model-in-rails-5</p>\n\n<p>Another solution is to use gem https://github.com/pboling/activerecord-tablefree\nbut we will not use it here.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/abstract_tableless_model.rb\n# https://stackoverflow.com/a/45743718/287166\n# to define you tableless model you can\nclass AbstractTablelessModel &lt; ApplicationRecord\n  self.abstract_class = true\n\n  def self.attribute_names\n    @attribute_names ||= attribute_types.keys\n  end\n\n  def self.load_schema!\n    @columns_hash ||= Hash.new\n\n    # From active_record/attributes.rb\n    attributes_to_define_after_schema_loads.each do |name, (type, options)|\n      if type.is_a?(Symbol)\n        type = ActiveRecord::Type.lookup(type, **options.except(:default))\n      end\n\n      define_attribute(name, type, **options.slice(:default))\n\n      # Improve Model#inspect output\n      @columns_hash[name.to_s] = ActiveRecord::ConnectionAdapters::Column.new(name.to_s, options[:default])\n    end\n\n    # Apply serialize decorators\n    attribute_types.each do |name, type|\n      decorated_type = attribute_type_decorations.apply(name, type)\n      define_attribute(name, decorated_type)\n    end\n  end\n\n  def persisted?\n    false\n  end\nend\n</code></pre></div></div>\n\n<p>We use <code class=\"highlighter-rouge\">left_outer_joins</code> on searchable for which there is only one instance.\nBut if you need to search for some nested has_many relation (for example\n<code class=\"highlighter-rouge\">book_users</code>) so there could be multiple instances than we need to use\n<code class=\"highlighter-rouge\">distinct</code>\nIf you want to split on table to two models based on one fields</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Book &lt; ApplicationRecord\nend\n\nclass ShortBook &lt; Book\nend\n\nclass LongBook &lt; Book\nend\n</code></pre></div></div>\n<p>than you shoud know that <code class=\"highlighter-rouge\">where(long_book: { user: 'me' })</code> produces the same\nresult as <code class=\"highlighter-rouge\">where(short_book: { user: 'me' })</code>.</p>\n\n<p>One solution could be to use database views</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>CREATE VIEW search AS\n  SELECT ...\n  UNION ALL\n  SELECT ...\n</code></pre></div></div>\n<p>But for updating database view we need migration, so I prefer to have that SQL\nin the code.</p>\n\n<p>Similar to but without database query\nhttps://blog.bigbinary.com/2016/05/30/rails-5-adds-or-support-in-active-record.html</p>\n\n<p>For Postgresql there could be improvements using <code class=\"highlighter-rouge\">pg_search</code>\nhttps://github.com/Casecommons/pg_search</p>\n"
    } ,
  
    {
      "title"    : "Nested Habtm Forms For Associations In Rails",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/12/01/nested-habtm-forms-for-associations-in-rails/",
      "date"     : "2018-12-01 00:00:00 +0100",
      "content"  : "<h1 id=\"html-form-input\">HTML Form Input</h1>\n\n<p>Start from basic docs for html\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input\">input</a>\nand <a href=\"https://www.w3.org/TR/html401/interact/forms.html\">forms</a>\nhttps://html.spec.whatwg.org/multipage/forms.html\nThe most important attribute is</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">name</code> identify the input in data submitted with the form. If not provided,\nthis input will not we included.</li>\n  <li><code class=\"highlighter-rouge\">type</code> to identify a input type that input element represents</li>\n  <li><code class=\"highlighter-rouge\">value</code> when specified, it is initial value. For unselected <code class=\"highlighter-rouge\">checkbox</code> or\n<code class=\"highlighter-rouge\">radio</code> it is not submitted. They have default value <code class=\"highlighter-rouge\">on</code></li>\n</ul>\n\n<p>There is a lot of input types (like <code class=\"highlighter-rouge\">color</code> which will popup\ncolor picker) but here we will focus on:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">text</code> single line text field (line breaks are automatically removed)</li>\n  <li><code class=\"highlighter-rouge\">checkbox</code> allowing single value to be selected/deselected</li>\n  <li><code class=\"highlighter-rouge\">hidden</code> it is not displayed, but value is submitted</li>\n  <li><code class=\"highlighter-rouge\">radio</code> allowing a single value to be selected out of multiple choices</li>\n  <li><code class=\"highlighter-rouge\">submit</code> ie <code class=\"highlighter-rouge\">&lt;input type='submit'</code> acts like a button that submits the form.\nYou can use <code class=\"highlighter-rouge\">&lt;button&gt;OK&lt;/button&gt;</code> (default is <code class=\"highlighter-rouge\">type='submit'</code>) instead (button\nthat does not submit the form is <code class=\"highlighter-rouge\">&lt;button type='button'&gt;</code>.</li>\n</ul>\n\n<p>Now start with what Rails provides https://api.rubyonrails.org/v5.2.1/classes/ActionView/Helpers/FormHelper.html#method-i-fields_for</p>\n\n<p>Similar to nested forms, you can have select tag with multiple options (habtm\nrelation) so we can update without ajax (it is created in one request).\nSince in html forms we can only send value or array</p>\n<ul>\n  <li>single value (html <code class=\"highlighter-rouge\">name='name'</code>) In rails <code class=\"highlighter-rouge\">text_field_tag :name</code> and\nwe got <code class=\"highlighter-rouge\">params[:name] # =&gt; 'Duke'</code></li>\n  <li>array (html <code class=\"highlighter-rouge\">name='ids[]'</code>) In rails <code class=\"highlighter-rouge\">text_field_tag 'ids[]'</code> or\n<code class=\"highlighter-rouge\">f.text_field :ids, name: 'ids[]'</code> and we got <code class=\"highlighter-rouge\">params[:ids] #=&gt; [1,2]</code> Note\nthat you need to permit array <code class=\"highlighter-rouge\">params.permit(ids: [])</code>. When you remove all\nelements from DOM than nothing is send to server, so you need to add empty and\nreject empty values\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>before_save :clear_unchecked_values\ndef clear_unchecked_values\n  self.custom_sign_up_labels = custom_sign_up_labels.reject(&amp;:blank?)\n  true\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>hash is when you nest inside brackets and define specific key, for example\n<code class=\"highlighter-rouge\">name='user[name]</code>, in rails <code class=\"highlighter-rouge\">f.text_field :name</code> (when f.object.class ==\nUser).  Note that you need to permit each key.</p>\n\n    <p>Hash values can also be string, array or another hash. For array (html\n<code class=\"highlighter-rouge\">name='user[ids][]</code>) in rails you can use <code class=\"highlighter-rouge\">f.text_field :ids, name:\n'user[ids][]</code> (<code class=\"highlighter-rouge\">f.text_field :ids</code> does not make sense since there are\nmultiple input fields, so better is to use <code class=\"highlighter-rouge\">text_field_tag :name</code>, but if you\nare using strong params, than you need to put inside model name, for example\n<code class=\"highlighter-rouge\">\"#{f.object.class.name.underscore}[ids][]\"</code>) we got\n<code class=\"highlighter-rouge\">params[:user][:ids] #=&gt; [1,2]</code>.  Hash with hash values rails use it for\n<code class=\"highlighter-rouge\">fields_for &amp; accepts_nested_attributes_for</code> html\n<code class=\"highlighter-rouge\">name='user[posts_attributes][0][id]</code> and we got\n<code class=\"highlighter-rouge\">params[:user][:posts_attributes][\"0\"][:id]</code>. Note that you need to permit\neach key <code class=\"highlighter-rouge\">params.require(:user).permit(posts_attributes: [:id,:name])</code></p>\n  </li>\n</ul>\n\n<p>So for habtm or has_many through, we need to mark for destruction and than add\nparams</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># modal\nclass Book &lt; ApplicationRecord\n  has_many :book_topics\n  has_many :topics, through: :book_topics\n  accepts_nested_attributes_for :book_topics\nend\nclass BookTopic &lt; ApplicationRecord\n  belongs_to :book\n  belongs_to :topic\nend\n\n# html\n      &lt;%= f.select :topic_ids, options_from_collection_for_select(Topic.all, :id, :topic_name, -&gt; (topic) { @book.book_topics.map(&amp;:topic).include? topic }), {}, multiple: true %&gt;\n\n# controller\n    @book.book_topics.each &amp;:mark_for_destruction\n    book_topics_params = {\n      book_topics_attributes: params[:book][:topic_ids].map {|id| { topic_id: id } }\n    }\n    if @book.update _book_params.merge book_topics_params\n\n</code></pre></div></div>\n\n<h1 id=\"nested-forms\">Nested forms</h1>\n\n<p><a href=\"http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html\">http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html</a>\nIf you want to use nested forms like question and answers, good approach is to\n<code class=\"highlighter-rouge\">create!</code> on new action and redirect to edit. That way you have <code class=\"highlighter-rouge\">question_id</code>.\nFor new questions or delete questions, you can simply use ajax. So start with\n<code class=\"highlighter-rouge\">rails g scaffold questions title;rails g model answers question:references</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># models/question.rb\nclass Question &lt; ActiveRecord::Base\n  has_many :answers, dependent: :destroy\n  accepts_nested_attributes_for :answers, allow_destroy: true\nend\n\n# questions/_form.html.erb\n  &lt;div id=\"answers\"&gt;\n    &lt;h2&gt;Answers&lt;/h2&gt;\n    &lt;% @question.answers.each do |answer| %&gt;\n      &lt;%= render partial: 'answer', locals: { question_form: f, answer: answer } %&gt;\n    &lt;% end %&gt;\n  &lt;/div&gt;\n  &lt;%= link_to \"Create new answers\", create_answer_question_path, remote: true,\n  method: :post %&gt;\n\n# questions/_answer.html.erb\n&lt;%#\n  question_form - we need this because we don't want to generate &lt;form&gt; tags\n                - we need just fields\n  answer - target answer\n\n  we hard code \"answers_attributes[]\" because\n  when we use fields_for :answer, than when we use ajax `new` twice we got same\n  name for different records\n  question[answers_attributes][0][id] (value 111)\n  question[answers_attributes][0][id] (value 222)\n  and only latest will be considered\n  it is because uniq number is reset for each fields_for\n  this sequential \"0\", \"1\" is used so you can show `fields_for :answers` for\n  existing and new answers (which does not have id) so they are all separated\n  with hard coded `answers_attributes[]` it is\n  question[answers_attributes][111][id] (value 111)\n  question[answers_attributes][222][id] (value 222)\n  but for unsaved objects it will be\n  question[answers_attributes][][id] (value nil)\n  so there are two solutions:\n    * always create objects and than render form\n    * add fake id (used for key), but not provide a hidden input field 'id'\n%&gt;\n&lt;%= question_form.fields_for \"answers_attributes[]\", answer do |ff| %&gt;\n  &lt;div class=\"field\"&gt;\n    &lt;%= ff.hidden_field :id %&gt;\n    &lt;%= ff.text_field :content, placeholder: \"Answer\" %&gt;\n    &lt;%= ff.number_field :score, placeholder: 'Score' %&gt;\n    &lt;%= ff.number_field :position, placeholder: 'Position' %&gt;\n    &lt;%= link_to \"Destroy\", destroy_answer_question_path(answer.question, answer_id: answer.id), remote: true, method: :delete %&gt;\n  &lt;/div&gt;\n&lt;% end %&gt;\n\n# questions/create_answer.js.erb\n&lt;% output = nil %&gt;\n&lt;% form_for(@question) do |f| %&gt;\n  &lt;% output = j render partial: 'answer', locals: { question_form: f, answer:\n  @answer } %&gt;\n  &lt;% end %&gt;\n$('#answers').append('&lt;%= output %&gt;');\n\n# config/routes.rb\n  resources :questions do\n    member do\n      post :create_answer\n      delete :destroy_answer\n    end\n  end\n\n# controllers/questions_controller.js\n  def create_answer\n    @answer = @question.answers.create!\n  end\n\n  def destroy_answer\n    @answer = @question.answers.find(params[:answer_id])\n    @answer.destroy!\n  end\n\n    def question_params\n      params.require(:question).permit(\n        :title, :time_limit,\n        answers_attributes: [:id, :score, :content, :_destroy]\n      )\n    end\n</code></pre></div></div>\n\n<p>You can try\n<a href=\"https://github.com/nathanvda/cocoon\">cocoon</a> gem and use\n<code class=\"highlighter-rouge\">link_to_add_association</code> <a href=\"https://www.sitepoint.com/better-nested-attributes-in-rails-with-the-cocoon-gem\">tutorial\npost</a></p>\n\n<p><code class=\"highlighter-rouge\">has_many :ip_addresses, inverse_of: :subscriber</code> is needed when you have\nvalidation errors for <code class=\"highlighter-rouge\">accepts_nested_attributes_for</code>\nhttps://robots.thoughtbot.com/accepts-nested-attributes-for-with-has-many-through\nValidation of uniqueness does not work for bulk update with <code class=\"highlighter-rouge\">_attributes</code> since\nit check only what is in db (not in params), so one solution is to add\n<code class=\"highlighter-rouge\">inverse_of</code> and to add validation</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  # this works when we create one record (not for batch update with\n  # ip_address_attributes)\n  validates :fix_ip_address, presence: true, uniqueness: { scope: :parent_location_id }\n  # so we need to validate that also\n  validate :uniqueness_for_batch_update\n  def uniqueness_for_batch_update\n    ips = subscriber.ip_addresses.map(&amp;:fix_ip_address)\n    errors.add(:fix_ip_address, 'already exists') if ips.size != ips.uniq.size\n  end\n</code></pre></div></div>\n\n<h1 id=\"multiple-form-submit-buttons-for-different-actions\">Multiple form submit buttons for different actions</h1>\n\n<p>you can use rails builder</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.submit \"Some label\" %&gt;\n  &lt;%= f.submit \"Some other label\" %&gt;\n</code></pre></div></div>\n\n<p>will generate</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;input type=\"submit\" name=\"commit\" value=\"Some label\"&gt;\n  &lt;input type=\"submit\" name=\"commit\" value=\"Some other label\"&gt;\n</code></pre></div></div>\n\n<p>so you can check on server</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  if params[:commit] == \"Some label\"\n</code></pre></div></div>\n\n<p>When you are not using <code class=\"highlighter-rouge\">f.submit</code> but plain <code class=\"highlighter-rouge\">&lt;button&gt;Some label&lt;/button&gt;</code> than\n  you need to add <code class=\"highlighter-rouge\">hidden_field_tag :commit, \"Some label\"</code></p>\n\n<p>Sometimes there is a problem when automatic translator on the page change\n  button labels and inputs so commit param is different…\n  There are two solutions for that:\n  Instead of <code class=\"highlighter-rouge\">commit</code> you can use\n  <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Input#attr-formaction\">formaction</a>\n  So you do not need to parse commits but you need different action methods to\n  handle.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= form_for('url') do |f| %&gt;\n      &lt;%= f.submit 'Create' %&gt;\n      &lt;%= f.submit 'Special Action', formaction: special_action_path %&gt;\n  &lt;% end %&gt;\n</code></pre></div></div>\n\n<p>Another solution to translations I18 of input submit is to use buttons with\n  value as the same as the text inside button tag.</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= form_for('url') do |f| %&gt;\n    &lt;%# instead of &lt;input&gt; we use &lt;button&gt; with value (which could be the same as inner text) so automatic page translators do not change that value %&gt;\n    &lt;%= f.button 'Create', value: 'Create' %&gt;\n    &lt;%= f.button 'Special Action', value: 'Special Action' %&gt;\n  &lt;% end %&gt;\n</code></pre></div></div>\n<p>this will generate</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;form action=\"url\"&gt;\n    &lt;button name=\"button\" type=\"submit\" value=\"Create\"&gt;Create&lt;/button&gt;\n    &lt;button name=\"button\" type=\"submit\" value=\"Special Action\"&gt;Special Action&lt;/button&gt;\n  &lt;/form&gt;\n</code></pre></div></div>\n<p>so you can grab <code class=\"highlighter-rouge\">params[:button] == 'Create'</code></p>\n\n<p>If you want to disable utf-8 and authenticity hidden fields, remove hidden\n  input <code class=\"highlighter-rouge\">name='commit'</code> for submit buttons <code class=\"highlighter-rouge\">button_tag 'OK', name: nil</code> and use\n  plain param name instead of in brackets <code class=\"highlighter-rouge\">f.hidden_field :name</code> generate\n  <code class=\"highlighter-rouge\">name='[name]'</code> (but <code class=\"highlighter-rouge\">f.text_field :name</code> generate <code class=\"highlighter-rouge\">name='name'</code>), than use\n  <code class=\"highlighter-rouge\">hidden_field_tag :name</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    &lt;%= bootstrap_form_tag url: @atom_payment.atom_server_link, layout: :horizontal, enforce_utf8: false, authenticity_token: false do |f| %&gt;\n      &lt;% @atom_payment.atom_params.each do |atom_param| %&gt;\n        &lt;%= hidden_field_tag atom_param[:name], atom_param[:value] %&gt;\n      &lt;% end %&gt;\n      &lt;%= button_tag \"Pay Now\", name: nil, class: 'btn btn-primary btn-block', 'data-disable-with': 'Processing...' %&gt;\n    &lt;% end %&gt;\n</code></pre></div></div>\n<ul>\n  <li>if you want to access hash keys by symbol or string you can instantiate with\n<code class=\"highlighter-rouge\">params = HashWithIndifferentAccess.new name: 'Duke'</code> so you can use\n<code class=\"highlighter-rouge\">params[:name]</code> or <code class=\"highlighter-rouge\">params[\"name\"]</code>.</li>\n</ul>\n\n<p>Here is a rails app, and here is a gist</p>\n\n<h1 id=\"rails-and-forms\">Rails and Forms</h1>\n\n<p>https://api.rubyonrails.org/v5.2.1/classes/ActionView/Helpers/FormHelper.html</p>\n\n<h2 id=\"input-outside-of-a-form\">Input outside of a form</h2>\n\n<p><code class=\"highlighter-rouge\">&lt;input&gt;</code> can be outside of a <code class=\"highlighter-rouge\">&lt;form&gt;</code>, all it needs is <code class=\"highlighter-rouge\">form='id_of_a_form'</code></p>\n\n<h2 id=\"dialog-element\">Dialog element</h2>\n\n<p>There is native html tag for modals <code class=\"highlighter-rouge\">&lt;dialog&gt;</code>. When you call\n<code class=\"highlighter-rouge\">dialogEl.showModal()</code> there will be backgrop and autofocus is triggered (if\nthere is <code class=\"highlighter-rouge\">autofocus</code> attribute).\nhttps://alligator.io/html/dialog-element/</p>\n\n<h2 id=\"fieldset--legend\">Fieldset &amp; Legend</h2>\n\n<p>Use <code class=\"highlighter-rouge\">&lt;fieldset&gt;</code> to group several input fields and set caption on it with\n<code class=\"highlighter-rouge\">&lt;legend&gt;</code>.\nWhen it is disabled, all input fields won’t be submitted.\nYou can set caption also on firgure</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;figure&gt;\n&lt;img src=\"/wp-content/uploads/flamingo.jpg\" alt=\"flamingo\"&gt;\n&lt;figcaption&gt;&lt;i&gt;fig. 1&lt;/i&gt; A pink flamingo.&lt;/figcaption&gt;\n&lt;/figure&gt;\n</code></pre></div></div>\n\n<h1 id=\"input-attributes\">Input Attributes</h1>\n\n<h2 id=\"autosuggestion\">Autosuggestion</h2>\n\n<p>Pure html autoselect suggestions (but not required from list) can be done using\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/datalist\">datalist</a>\nand <code class=\"highlighter-rouge\">&lt;input list='id_of_datalist'&gt;</code> attribute.</p>\n\n<h2 id=\"autocomplete\">Autocomplete</h2>\n\n<p>Autocomplete can be enabled with specific value https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/autocomplete\nor disabled because off\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Securing_your_site/Turning_off_form_autocompletion\">security</a>\n(even disabled, browser can ask for auto save password, it will populate them)</p>\n\n<p>Firefox has soft refresh which persist input values and disabled attribute on\nrefresh the page https://stackoverflow.com/questions/5985839/bug-with-firefox-disabled-attribute-of-input-not-resetting-when-refreshing\nThis can be disabled by hard refresh or autocomplete <code class=\"highlighter-rouge\">off</code></p>\n\n<h2 id=\"autofocus\">Autofocus</h2>\n\n<p>Auto focus input fields on page load (or dialog show). If you need to show focus\non input with existing value than you can use callback <code class=\"highlighter-rouge\">onfocus</code>\nhttps://stackoverflow.com/questions/511088/use-javascript-to-place-cursor-at-end-of-text-in-text-input-element/2345915#2345915</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.search_field :s, autofocus: true, onfocus: 'this.selectionStart = this.selectionEnd = this.value.length;' %&gt;\n</code></pre></div></div>\n\n<h2 id=\"disabled\">Disabled</h2>\n\n<p>Disabled inputs do not receive <code class=\"highlighter-rouge\">click</code> event, and they are not submitted with\nthe form.\nThis can be used to preventDefault on click event for other <code class=\"highlighter-rouge\">data-</code> event\nlisteners.</p>\n\n<h2 id=\"required\">Required</h2>\n\n<p><code class=\"highlighter-rouge\">required</code> is boolean attribute, when is present, user myst specify a value. On\nall except (color, hidden, range, submit, image, reset, button). When it is on\n<code class=\"highlighter-rouge\">checkbox</code> than user have to select it before procceeding.\nRequired inputs has pseudoclass <code class=\"highlighter-rouge\">:required</code>.</p>\n\n<h2 id=\"tabindex\">Tabindex</h2>\n\n<p><code class=\"highlighter-rouge\">tabindex</code> should be <code class=\"highlighter-rouge\">0</code> so it is reachable by sequential keyboard navigation.</p>\n\n<h2 id=\"placeholder\">Placeholder</h2>\n\n<p>There are three ways of providing more info about form field, but the best way\nis using <code class=\"highlighter-rouge\">label</code> and to avoid placeholders.</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">label</code> element is outside of a input</li>\n  <li><code class=\"highlighter-rouge\">placeholder</code> text that is shown when field is empty. So when is not empty, no\nshow. Also browsers translators does not work on placeholders since it is\nattribute (not a value or a text object).</li>\n  <li>adjacent elements (google sign in use this)</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Object Oriented Design Principles",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/11/30/object-oriented-design-principles/",
      "date"     : "2018-11-30 00:00:00 +0100",
      "content"  : "<p>https://thoughtbot.com/upcase/intermediate-ruby-on-rails</p>\n\n<p><a href=\"https://www.youtube.com/watch?v=D7zUOtlpUPw\">dhh tips for rails</a></p>\n<ul>\n  <li>epipsode 1: do not use comments but method names or constants… follow\ntable of content: method definition should be in same order as they are used\nin the class (in before callbacks)\nadministered concern define methods on associations. Also use <code class=\"highlighter-rouge\">or</code> <code class=\"highlighter-rouge\">|</code> to join\ntwo arrays</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>module Account::Administered\n  extend ActiveSupport::Concern\n\n  included do\n    has_many :administratorships, dependent: :delete_all do\n      def grant(person)\n        create_or_find person: person\n      end\n\n      def revoke(person)\n        where(person_id: person.id).destroy_all\n      end\n    end\n\n    has_many :administrators, through: :administratorships, source: :person\n  end\n\n  def all_administrators\n    administrators | all_owners\n  end\n\n  def administrator_candidates\n    people.users.\n      where.not(id: administratorships.pluck(:person_id)).\n      where.now(id: ownerships.pluck(:person_id)).\n      where.not(id: owner_person.id)\n  end\nend\n</code></pre></div></div>\n<ul>\n  <li>episode 2: use callbacks to initiate background jobs</li>\n  <li>episode 3: use globals in request/response cycle. For background jobs you need\nto pass them as params.</li>\n  <li>episode 4</li>\n</ul>\n\n"
    } ,
  
    {
      "title"    : "Android Turbolinks Native Mobile App For Rails",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/11/20/android-turbolinks-native-mobile-app-for-rails/",
      "date"     : "2018-11-20 00:00:00 +0100",
      "content"  : "<h1 id=\"native-login\">Native login</h1>\n\n<p>Since mobile can use sdk to login user, it should be done native (android\nactivity).\nAfter Firebase auth you should pass the token to the webview (do not pass\n<code class=\"highlighter-rouge\">user.getUid()</code> since that wont change)\nhttps://firebase.google.com/docs/auth/android/manage-users#get_a_users_profile</p>\n\n<p>That accessToken can be validated in ruby\nhttps://medium.com/@igorkhomenko/how-to-validate-firebase-id-token-in-ruby-23f4f54c89ab</p>\n\n<p>There is a firebase-ruby gem but only wrapper for Real time database REST API\nhttps://github.com/oscardelben/firebase-ruby\nhttps://firebase.google.com/docs/database/rest/start</p>\n\n<h1 id=\"turbolinks\">Turbolinks</h1>\n\n<p>https://github.com/turbolinks/turbolinks-android\nYou just need to use <code class=\"highlighter-rouge\">&lt;com.basecamp.turbolinks.TurbolinksView</code> and override\n<code class=\"highlighter-rouge\">visitProposedToLocationWithAction</code>. Look at demo app.</p>\n\n<h1 id=\"notifications\">Notifications</h1>\n\n<p>Option to use email of mobile app notifications.</p>\n\n<h1 id=\"android-emulator\">Android Emulator</h1>\n\n<p>I found that genymotion works fine. Just install <a href=\"https://github.com/codepath/android_guides/wiki/Genymotion-2.0-Emulators-with-Google-Play-support\">google play\nservices</a> after drag and drop those two files, you need to\nlogs in and open Google+ which will trigger update of Google play services.\nYou can use same login on all emulators.\nIf genymotion emulator dissapears, run <code class=\"highlighter-rouge\">adb kill-server</code> to clean connections.</p>\n\n<p>For first message you need to wait minute or two. But than it works instantly.</p>\n"
    } ,
  
    {
      "title"    : "Cordova",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/11/07/cordova/",
      "date"     : "2018-11-07 00:00:00 +0100",
      "content"  : "<h1 id=\"install\">Install</h1>\n\n<p>https://gradle.org/install/\nDownload from binary-only from https://gradle.org/releases/</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mkdir ~/Programs/gradle\nunzip -d ~/Programs/gradle ~/Downloads/gradle-4.10.2-bin.zip\n# add to PATH\nexport PATH=\"$PATH:$HOME/Programs/gradle/bin\"\n</code></pre></div></div>\n\n<p>Cordova</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cordova help create\ncordova create myapp com.mycompany.myteam.myapp MyApp\n\ncd myapp\ncat &gt;&gt; .gitignore &lt;&lt;HERE_DOC\n/node_modules\n/plugins\n/platforms\nHERE_DOC\n\ncordova plarform add android\n</code></pre></div></div>\n\n<h2 id=\"compile\">Compile</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cordova run android\n</code></pre></div></div>\n\n<h2 id=\"plugins\">Plugins</h2>\n\n<p>https://www.npmjs.com/search?q=ecosystem%3Acordova\nhttps://cordova.apache.org/plugins/</p>\n\n<p>TODO\nhttps://cordova.apache.org/docs/en/latest/guide/cli/index.html#create-the-app</p>\n"
    } ,
  
    {
      "title"    : "Oauth Specification Doorkeeper",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/08/13/oauth-specification-doorkeeper/",
      "date"     : "2018-08-13 00:00:00 +0200",
      "content"  : "<h1 id=\"oauth-specification\">Oauth specification</h1>\n\n<p><a href=\"https://tools.ietf.org/html/rfc6749\">https://tools.ietf.org/html/rfc6749</a> around 66 pages</p>\n\n<blockquote>\n  <p>Instead of using the resource owner’s credentials to access protected\nresources, the client obtains an access token – a string denoting a specific\nscope, lifetime, and other access attributes. Access tokens are issued to\nthird-party clients by an authorization server with the approval of the\nresource owner.</p>\n</blockquote>\n\n<p>Roles:</p>\n<ul>\n  <li>resource owner (end-user) capable of granting access to protected resource</li>\n  <li>client (web or server app) application that make protected resource requests</li>\n  <li>resource server: capable of responding to requests using access token\non behalf of the resource owner and with its authorization</li>\n  <li>authorization server: server issuing access tokens after successfully\nauthenticating the resource owner, and obtaining authorization</li>\n</ul>\n\n<p>Flow:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> +--------+                               +---------------+\n |        |--(A)- Authorization Request -&gt;|   Resource    |\n |        |                               |     Owner     |\n |        |&lt;-(B)-- Authorization Grant ---|               |\n |        |                               +---------------+\n |        |\n |        |                               +---------------+\n |        |--(C)-- Authorization Grant --&gt;| Authorization |\n | Client |                               |     Server    |\n |        |&lt;-(D)----- Access Token -------|               |\n |        |                               +---------------+\n |        |\n |        |                               +---------------+\n |        |--(E)----- Access Token ------&gt;|    Resource   |\n |        |                               |     Server    |\n |        |&lt;-(F)--- Protected Resource ---|               |\n +--------+                               +---------------+\n</code></pre></div></div>\n\n<ul>\n  <li>client gets authorization grant from resource owner</li>\n  <li>than using that grant get access token</li>\n  <li>and using that token get protected resource</li>\n</ul>\n\n<p>4 Authorization Grant types (and extensibility mechanism for additional types):</p>\n<ul>\n  <li>authorization code - grant is authorization code</li>\n  <li>implicit - no grant, direct token</li>\n  <li>resource owner password credentials - grant is password</li>\n  <li>client credentials</li>\n</ul>\n\n<ol>\n  <li>Authorization code is obtained by using authorization server as an\nintermediary between the client and resource owner. Client directs resource\nowner to authorization server using user agent (because this is direct,\nresource owner credentials are never shared with a client) and than resource\nowner is directed back to the client with <strong>authorization code</strong> (without\npassing code to user agent).</li>\n  <li>Implicit is simplified authorization code for clients in browser using\njavascript. Instead of issuing authorization code, the client is issued an\n<strong>access token</strong> directly. When issuing access token, authorization server\ndoes not authenticate the client, only place where we can verify client is\nRedirect URI used to deliver access token to client. Access token may be\nexposed to resource owner or other application with access to the resource\nowner user agent.</li>\n  <li>Resource owner password credentials can be used as authorization grant to\nobtain access token. The credentials should be used only when there is high\ndegree of trust between resource owner and client (for example client is part\nof device operating system). Usually client do not store credentials but use\nthem in single request to exchange with long-lived access token or refresh\ntoken. Password flow is also used when your app owns oauth provider, since\nuser is sending username and password to get token.</li>\n  <li>Client credentials is used when scope is limited to client protected\nresources (not end user).</li>\n</ol>\n\n<p>Refresh tokens are used to obtain access tokens. It is optional and included\nwhen issuing access token. It is used only with authorization server and never\nsent to resource server. When access token expires client use refresh token to\nget new access token (and eventual new refresh token). If client know expiration\ndate, it can request new access token before that moment.</p>\n\n<h2 id=\"2-client-registration\">2. Client Registration</h2>\n\n<p>When registering the client, client developer SHALL specify client type,\nredirection URI and other info like application name, logo, terms.\nClient type is <em>confidential</em> when client is capable of maintaining the\nconfidentiality of their credentials (it runs on secure server like rails and\ncan secure client authentication).\nClient type is <em>public</em> when client is incapable of maintaining the\nconfidentiality (it runs as native application on resource owner device, web\nbrowser application or can not secure client authentication). For native\napplication is it assumed that client authentication credentials included in\napplication can be extracted, but dynamicaly issued access tokens can receive\nacceptable level of protection.</p>\n\n<p>Authorization server issues the registered client a client identifier, unique\nidentifier representing information provided by the developer. It is not a\nsecret and it exposed to resource owner and MUST NOT be used alone for client\nauthentication.</p>\n\n<p>If client is confidential, than authorization server MAY accept any form of\nclient authentication (password, public/private key pair). If client is public\nthan authorization server MUST NOT rely on public client authentication for the\npurpose of identifying the client.</p>\n\n<p>Client password can be used with HTTP Basic authentication scheme (Digest of\nidentifier and password). Alternatively, authorization server MAY support client\ncredentials in request body (MUST NOT in request URI) like:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>POST /token HTTP/1.1\nHost: server.example.com\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=refresh_token&amp;refresh_token=tGzv3JOkF0XG5Qx2TlKWIA\n&amp;client_id=s6BhdRkqt3&amp;client_secret=7Fjfp0ZBr1KtDRbnfVdmIw\n</code></pre></div></div>\n\n<h2 id=\"3-protocol-endpoints\">3. Protocol Endpoints</h2>\n\n<p>Two authorization server endpoints:</p>\n\n<ul>\n  <li>\n    <p>authorization endpoint GET - used by client to obtain authorization grant from\nresource owner via user agent redirection. Client get the location from service\ndocumentation, Authorization server MUST verify identity of resource owner\n(username/password, cookies…). It is used for Authorization code and implicit\nwhich is defined in parameter: <code class=\"highlighter-rouge\">response_type</code> REQUIRED <code class=\"highlighter-rouge\">code</code> or <code class=\"highlighter-rouge\">token</code>.\nRedirection endpoint is MUST for public clients and confidentail clients\nunilizing implicit grant type. Authorization server MAY allow client to register\nmultiple redirection endpoints. In that case, endpoint MUST be included in\n<code class=\"highlighter-rouge\">redirect_url</code> request parameter.</p>\n  </li>\n  <li>\n    <p>token endpoint POST - used by client to exchange authorization grant to access\ntoken. Used in every grant except implicit grant type (since access token is\nissued directly).</p>\n  </li>\n</ul>\n\n<p>One client endpoint:</p>\n\n<ul>\n  <li>redirection endpoint - used by authorization server to return responses\ncontaining authorization credentials to the client via resource owner user\nagent. For native apps it can be <code class=\"highlighter-rouge\">my_app://redirect</code> for others, it MUST be\nusing TLS security ie begins with https</li>\n</ul>\n\n<p>Access token scope can be added as request parameter, as list of space delimited\ncase sensitive strings.</p>\n\n<p>Client Authentication is MUST for token endpoint for confidential clients or\nother clients issued client credentials. It is used to enforce bindings of\nrefresh token to client, recovering from compromised client by changing its\ncredentials.</p>\n\n<h2 id=\"4-obtaining-authorization\">4. Obtaining authorization</h2>\n\n<h3 id=\"41-authorization-code\">4.1 Authorization code</h3>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  +----------+\n   | Resource |\n   |   Owner  |\n   |          |\n   +----------+\n        ^\n        |\n       (B)\n   +----|-----+          Client Identifier      +---------------+\n   |         -+----(A)-- &amp; Redirection URI ----&gt;|               |\n   |  User-   |                                 | Authorization |\n   |  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |\n   |          |                                 |               |\n   |         -+----(C)-- Authorization Code ---&lt;|               |\n   +-|----|---+                                 +---------------+\n     |    |                                         ^      v\n    (A)  (C)                                        |      |\n     |    |                                         |      |\n     ^    v                                         |      |\n   +---------+                                      |      |\n   |         |&gt;---(D)-- Authorization Code ---------'      |\n   |  Client |          &amp; Redirection URI                  |\n   |         |                                             |\n   |         |&lt;---(E)----- Access Token -------------------'\n   +---------+       (w/ Optional Refresh Token)\n</code></pre></div></div>\n\n<p>Authorication code grant is used to obtain both access token and refresh tokens\nand is optimized for confidential clients. Since this is redirection based flow,\nclient must be capable of interacting with resource owner user agent and capable\nof receiving incoming requests from authorization server.\nURI example:</p>\n\n<ul>\n  <li>response_type: required, must be <code class=\"highlighter-rouge\">code</code></li>\n  <li>client_id: required, client id when you created application on oauth server</li>\n  <li>redirect_uri: required, where to redirect after authorization is complete</li>\n  <li>scope=photos - one or more scope values indicating which part of account you\nwish to access</li>\n  <li>state: recommended to prevent cross-site request forgery csrf, random string\nwhich you will verify later.</li>\n</ul>\n\n<p>Create “Log In” link with href <code class=\"highlighter-rouge\">https://server.example.com/authorize?res...</code>:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz\n        &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1\nHost: server.example.com\n</code></pre></div></div>\n\n<p>Authorization response in case of resource owner grants access request</p>\n\n<ul>\n  <li>code: required, lifetime of 10minutes</li>\n  <li>state: required if state was in requests</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>HTTP/1.1 302 Found\nLocation: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA\n         &amp;state=xyz\n</code></pre></div></div>\n\n<p>Response in case of missing, invalid redirection url or client_id, authorization\nserver MUST NOT automatically redirect to invalid redirection URI, but SHOULD\ninform resource owner of the error.\nResponse in case of denies, authorization server by adding following parameter\nto the redirection URI</p>\n\n<ul>\n  <li>error: required <code class=\"highlighter-rouge\">invalid_request</code>, <code class=\"highlighter-rouge\">unauthorized_client</code>, <code class=\"highlighter-rouge\">access_denied</code> …</li>\n  <li>error_description: optional</li>\n  <li>state: required if state was in requests</li>\n</ul>\n\n<p>Access token request POST</p>\n\n<ul>\n  <li>grant_type: required <code class=\"highlighter-rouge\">authorization_code</code></li>\n  <li>code: required, authorization code from previous step</li>\n  <li>redirect_uri: required if it was inclded in previous request</li>\n  <li>client_id: required</li>\n</ul>\n\n<p>Client MUST authenticate with authorization server if client type is confidental\nor client was issued client credentials</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>POST /token HTTP/1.1\nHost: server.example.com\nAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA\n&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb\n</code></pre></div></div>\n\n<p>Access token response</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>HTTP/1.1 200 OK\nContent-Type: application/json;charset=UTF-8\nCache-Control: no-store\nPragma: no-cache\n\n{\n \"access_token\":\"2YotnFZFEjr1zCsicMWpAA\",\n \"token_type\":\"example\",\n \"expires_in\":3600,\n \"refresh_token\":\"tGzv3JOkF0XG5Qx2TlKWIA\",\n \"example_parameter\":\"example_value\"\n}\n</code></pre></div></div>\n\n<h3 id=\"42-implicit-grant\">4.2 Implicit Grant</h3>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>   +----------+\n   | Resource |\n   |  Owner   |\n   |          |\n   +----------+\n        ^\n        |\n       (B)\n   +----|-----+          Client Identifier     +---------------+\n   |         -+----(A)-- &amp; Redirection URI ---&gt;|               |\n   |  User-   |                                | Authorization |\n   |  Agent  -|----(B)-- User authenticates --&gt;|     Server    |\n   |          |                                |               |\n   |          |&lt;---(C)--- Redirection URI ----&lt;|               |\n   |          |          with Access Token     +---------------+\n   |          |            in Fragment\n   |          |                                +---------------+\n   |          |----(D)--- Redirection URI ----&gt;|   Web-Hosted  |\n   |          |          without Fragment      |     Client    |\n   |          |                                |    Resource   |\n   |     (F)  |&lt;---(E)------- Script ---------&lt;|               |\n   |          |                                +---------------+\n   +-|--------+\n     |    |\n    (A)  (G) Access Token\n     |    |\n     ^    v\n   +---------+\n   |         |\n   |  Client |\n   |         |\n   +---------+\n</code></pre></div></div>\n\n<p>Optimized for public clients known to operate a particular redirection URI (it\ndoes not support refresh tokens).\nIt is the same as authorization code but not sending secret, so we might use\n<code class=\"highlighter-rouge\">code</code>.</p>\n\n<p>Request:</p>\n\n<ul>\n  <li>response_type: required <code class=\"highlighter-rouge\">token</code></li>\n  <li>client_id: required</li>\n  <li>redirect_uri: optional</li>\n  <li>scope: optional</li>\n  <li>state: recommended</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>GET /authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz\n    &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1\nHost: server.example.com\n</code></pre></div></div>\n\n<p>Authorization server MUST verify redirection URI matches registered uris.</p>\n\n<p>Response:</p>\n\n<ul>\n  <li>access_token: required</li>\n  <li>token_type: required <code class=\"highlighter-rouge\">bearer</code>, <code class=\"highlighter-rouge\">mac</code> <a href=\"https://tools.ietf.org/html/rfc6749#section-7.1\">Access token types</a></li>\n  <li>expires_in: recommended</li>\n  <li>scope: optional if identical to requested scope, otherwise required</li>\n  <li>state: required if state was in requests</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>HTTP/1.1 302 Found\nLocation: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA\n         &amp;state=xyz&amp;token_type=example&amp;expires_in=3600\n</code></pre></div></div>\n\n<h3 id=\"43-resource-owner-password-credentials-grant\">4.3 Resource Owner Password Credentials Grant</h3>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>   +----------+\n   | Resource |\n   |  Owner   |\n   |          |\n   +----------+\n        v\n        |    Resource Owner\n       (A) Password Credentials\n        |\n        v\n   +---------+                                  +---------------+\n   |         |&gt;--(B)---- Resource Owner -------&gt;|               |\n   |         |         Password Credentials     | Authorization |\n   | Client  |                                  |     Server    |\n   |         |&lt;--(C)---- Access Token ---------&lt;|               |\n   |         |    (w/ Optional Refresh Token)   |               |\n   +---------+                                  +---------------+\n</code></pre></div></div>\n\n<p>Request:</p>\n<ul>\n  <li>grant_type: required <code class=\"highlighter-rouge\">password</code></li>\n  <li>username: required</li>\n  <li>password: required</li>\n  <li>scope: optional</li>\n</ul>\n\n<p>We might send also client_id.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>POST /token HTTP/1.1\nHost: server.example.com\nAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=password&amp;username=johndoe&amp;password=A3ddj3w\n</code></pre></div></div>\n\n<p>Response</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>HTTP/1.1 200 OK\nContent-Type: application/json;charset=UTF-8\nCache-Control: no-store\nPragma: no-cache\n\n{\n \"access_token\":\"2YotnFZFEjr1zCsicMWpAA\",\n \"token_type\":\"example\",\n \"expires_in\":3600,\n \"refresh_token\":\"tGzv3JOkF0XG5Qx2TlKWIA\",\n \"example_parameter\":\"example_value\"\n}\n</code></pre></div></div>\n\n<h3 id=\"44-client-credentials-grant\">4.4 Client Credentials Grant</h3>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>   +---------+                                  +---------------+\n   |         |                                  |               |\n   |         |&gt;--(A)- Client Authentication ---&gt;| Authorization |\n   | Client  |                                  |     Server    |\n   |         |&lt;--(B)---- Access Token ---------&lt;|               |\n   |         |                                  |               |\n   +---------+                                  +---------------+\n</code></pre></div></div>\n\n<p>Client credentials grant type MUST only be used by confidential clients.\nAuthorization server MUST authenticate the client.\nclient_credentials is usually for apps (not for users) to update their info\n(like icon, statistics…) outside of the context of any user.\nBut it can be used for apps than do not require user interaction, for example\npayment gateway and when customer wants to pay, client do not need to ask user\nif that is OK.</p>\n\n<p>Request:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>POST /token HTTP/1.1\nHost: server.example.com\nAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=client_credentials\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>HTTP/1.1 200 OK\nContent-Type: application/json;charset=UTF-8\nCache-Control: no-store\nPragma: no-cache\n\n{\n \"access_token\":\"2YotnFZFEjr1zCsicMWpAA\",\n \"token_type\":\"example\",\n \"expires_in\":3600,\n \"example_parameter\":\"example_value\"\n}\n</code></pre></div></div>\n\n<h2 id=\"10-client-authentication\">10. Client Authentication</h2>\n\n<p>Web application clients MUST ensure confidentiality of client password.\nThe authorization server MUST NOT issue client passwords or other client\ncredentials to native application or user-agent-based application clients for\nthe purpose of client authentication.</p>\n\n<p>The authorization server MAY issue a client password or other credentials for a\nspecific installation of a native application client on a specific device.</p>\n\n<p><a href=\"https://tools.ietf.org/html/rfc6750\">Access Token Specification</a>\nAccess token can have different formats. But it is abstraction layer so resource\nserver does not need to understand wide range of authentication methods.</p>\n\n<h2 id=\"rails-oauth-provider-doorkeeper\">Rails oauth provider doorkeeper</h2>\n\n<p><a href=\"https://github.com/doorkeeper-gem/doorkeeper\">doorkeeper</a> is rails engine that\nprovides oauth 2 auth <a href=\"http://railscasts.com/episodes/353-oauth-with-doorkeeper\">railscasts #353</a>\nSome intro how google does oauth2\nhttps://developers.google.com/identity/protocols/OAuth2?csw=1</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt;HERE_DOC\n# oauth provider\ngem 'doorkeeper', '~&gt; 4.2.6'\nHERE_DOC\nrails g doorkeeper:install\nrails g doorkeeper:migration\n# add_foreign_key :oauth_access_grants, :users, column: :resource_owner_id\n# add_foreign_key :oauth_access_tokens, :users, column: :resource_owner_id\ngit add . &amp;&amp; git commit -am \"rails g doorkeeper:install\"\n</code></pre></div></div>\n\n<p>Migration will generate three tables:</p>\n\n<ul>\n  <li>oauth_applications - store secret and redirect_uri</li>\n  <li>oauth_access_grants - tokens for each user and application</li>\n  <li>oauth_access_tokens - token, refresh_token</li>\n</ul>\n\n<p>When you list all generated routes you will notice three:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails routes -g oauth\n# /oauth/authorize\n# /oauth/applications - CRUD for applications\n# /oauth/authorized_applications\n# /oauth/token\n# /oauth/token/info\n# /oauth/revoke\n</code></pre></div></div>\n\n<p>First you need to set up one oauth application on\n<a href=\"http://localhost:3004/oauth/applications\">http://localhost:3004/oauth/applications</a> to generate <code class=\"highlighter-rouge\">client_id</code> and\n<code class=\"highlighter-rouge\">client_secret</code>.</p>\n\n<p>There are 4 ways to use <a href=\"https://aaronparecki.com/oauth-2-simplified\">oauth grant types</a>:</p>\n<ul>\n  <li>authorization_code: web server, browser based and mobile apps</li>\n  <li>imlicit: superceded by authorization code with no secret</li>\n  <li>password</li>\n  <li>client_credentials</li>\n</ul>\n\n<p>When you get access token, than you can authenticated request using header:\nIn doorkeeper by default access_token expires after 2 hours.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>curl -H \"Authorization: Bearer RsT5OjbzRn430zqMLgV3Ia\" https://api.oauth2server.com/1/me\n</code></pre></div></div>\n\n<p><a href=\"https://github.com/doorkeeper-gem/doorkeeper/wiki/Using-Scopes\">Using scopes</a></p>\n\n<p>Some provider opensource examples:\n<a href=\"https://github.com/doorkeeper-gem/doorkeeper/wiki/Example-Applications\">https://github.com/doorkeeper-gem/doorkeeper/wiki/Example-Applications</a></p>\n\n<p>To test provider you can use <a href=\"https://github.com/intridea/oauth2\">oauth2 client</a>\nto generate <code class=\"highlighter-rouge\">access_token</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem install oauth2\nirb -r oauth2\nclient_id = ''\nclient_secret = ''\nredirect_uri = ''\nclient = OAuth2::Client.new(client_id, client_secret, site: 'https://localhost:3000')\n\nclient.auth_code.authorize_url redirect_uri: redirect_url\n</code></pre></div></div>\n\n"
    } ,
  
    {
      "title"    : "Innovations And Business",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/06/05/innovations-and-business/",
      "date"     : "2018-06-05 00:00:00 +0200",
      "content"  : "<p>Patent could be imagination, not practically feasibile.\nInvention is idea that has practical realisation.\nInnovation is realistion on market, ie sold.</p>\n\n<p>What is you innovation ?</p>\n\n<p>Production unit could be service or product (device).</p>\n\n<p>Novelty:\nAdvantages:\nValue description for customer:</p>\n\n<p>4 types of innovations:</p>\n<ul>\n  <li>incremental innovation: improved existing product on existing market in a way\nthat buyers expect. Easy (in one year)</li>\n  <li>modular innovation:</li>\n  <li>system innovation: architecture change.</li>\n  <li>revolutional innovation:</li>\n</ul>\n\n<p>Online course</p>\n\n<p>https://www.udacity.com/course/how-to-build-a-startup–ep245\nhttps://strategyzer.com/training/courses/mastering-business-models</p>\n"
    } ,
  
    {
      "title"    : "Sinatra",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/05/31/sinatra/",
      "date"     : "2018-05-31 00:00:00 +0200",
      "content"  : "<h1 id=\"sinatra\">Sinatra</h1>\n\n<p>Default folder for partials is <code class=\"highlighter-rouge\">views/</code> and name is with <code class=\"highlighter-rouge\">.erb</code> extension.\nDefault layout file is <code class=\"highlighter-rouge\">views/layout.erb</code>. Always use symbols when referencing\ntemplates, event with subfolder <code class=\"highlighter-rouge\">erb :'subdir/home'</code>. Instance variables are\naccessible in templates.\nStatic files are server from <code class=\"highlighter-rouge\">public/</code> folder.\nFor stylesheet use <code class=\"highlighter-rouge\">scss :stylesheet, style: :expanded</code>\nFor coffescript <code class=\"highlighter-rouge\">coffee :index</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># to change default views folder\nset :views, settings.root + '/templates'\n</code></pre></div></div>\n\n<p>Filter can be used to modify request and response, set instance variable.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>before '/protected/*' do\n  authenticate!\nend\n</code></pre></div></div>\n\n<p>Session and other configuration options</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'securerandom'\n\nenable :sessions\nset :session_secret, ENV.fetch('SESSION_SECRET') { SecureRandom.hex(64) }\n\n# to be able to access from other computers, or run with `ruby app.rb -o 0.0.0.0\nset :bind, '0.0.0.0'\n\nget '/:value' do\n  session['val'] = params['value']\nend\n</code></pre></div></div>\n\n<p>Redirect with <code class=\"highlighter-rouge\">redirect to('/foo?bar=42')</code>.\nCache-control header is set with <code class=\"highlighter-rouge\">cache_control :public</code>. Rack cache can be used\nfor caching.</p>\n\n<p>Top level application assumes a micro app style configuration (a single app\nfile, public and views folders).\nIf you want modular style (run is disabled by default) you can inherit from\n<code class=\"highlighter-rouge\">Sinatra::Base</code> (logging and inline templates disabled by default).\nIf you want similar to classic style, you can write with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'sinatra/base'\n\nclass MyApp &lt; Sinatra::Application\n  get '/' do\n    'Hello world!'\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config.ru\nrequire './app'\nrun MyApp\n</code></pre></div></div>\n\n<p>Run with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bundle exec rackup -p- 4567\n</code></pre></div></div>\n\n<h2 id=\"sinatra-contrib\">Sinatra Contrib</h2>\n\n<p>http://sinatrarb.com/contrib/</p>\n\n<p>Reloading in Sinatra can be done with <code class=\"highlighter-rouge\">rerun</code> http://sinatrarb.com/faq.html or\nwith</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'sinatra/reloader' if development?\n</code></pre></div></div>\n\n<h2 id=\"sinatra-book\">Sinatra book</h2>\n\n<p>http://sinatra-org-book.herokuapp.com/</p>\n\n<h2 id=\"logger\">Logger</h2>\n\n<p>Inside <code class=\"highlighter-rouge\">get</code> actions you can define helper and use request logger</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>get '/' do\n  logger.info 'get_root'\nend\n</code></pre></div></div>\n\n<p>For use in templates you can define helpers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>helpers do\n  def logger\n    request.logger\n  end\nend\n</code></pre></div></div>\n\n<p>To enable logging to a file use as well to stdout. Problem is that I do not see\ncustom logs with <code class=\"highlighter-rouge\">logger.info params</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># http://recipes.sinatrarb.com/p/middleware/rack_commonlogger\nconfigure do\n  # logging is enabled by default in classic style applications,\n  # so `enable :logging` is not needed\n  # create folder `mkdir log` and gitignore with `touch log/.keep`\n  file = File.new(\"#{settings.root}/log/#{settings.environment}.log\", 'a+')\n  file.sync = true\n  use Rack::CommonLogger, file\nend\n</code></pre></div></div>\n\n<p>For use in other places you can create global variable (I do not know how to\naccess logger outside of actions). But the problem here is that I do not see\nmessages in file (but see in STDOUT on developemnt) when I use <code class=\"highlighter-rouge\">$logger.info</code>\nbut <code class=\"highlighter-rouge\">logger.info</code> inside actions works fine.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># https://stackoverflow.com/questions/5995854/logging-in-sinatra\nconfigure :production do\n  $logger = Logger.new('log/common.log', 'hourly')\n  $logger.level = Logger::WARN\n\n  # Spit stdout and stderr to a file during production\n  # in case something goes wrong\n  $stdout.reopen(\"log/#{settings.environment}.log\", 'w')\n  $stdout.sync = true\n  $stderr.reopen($stdout)\nend\n\nconfigure :development do\n  $logger = Logger.new(STDOUT)\nend\n</code></pre></div></div>\n\n<p>https://github.com/minodes/sinatra-logger</p>\n\n<h2 id=\"enviroments\">Enviroments</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>APP_ENV=production ruby my_app.rb\n# or\nruby my_app.rb -e production\n</code></pre></div></div>\n\n<h2 id=\"sinatra-sass\">Sinatra Sass</h2>\n\n<p>To add support to scss you can add <code class=\"highlighter-rouge\">gem 'sass'</code> and if using modular style</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config.ru\nrequire 'sass/plugin/rack'\n\nSass::Plugin.options[:style] = :compressed\nuse Sass::Plugin::Rack\n</code></pre></div></div>\n\n<p>or is using classis style, run</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sass --watch public/assets/stylesheets/sass:public/assets/stylesheets\n</code></pre></div></div>\n\n<p>and include in layout</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;link rel=\"stylesheet\" href=\"/assets/stylesheets/switch.css\"&gt;\n</code></pre></div></div>\n\n<h1 id=\"activerecord\">Activerecord</h1>\n\n<p>https://github.com/janko-m/sinatra-activerecord</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'sinatra-activerecord'\ngem 'sqlite3'\ngem 'rake'\n\n# app.rb\nrequire 'sinatra/activerecord'\nset :database, adapter: 'sqlite3', database: \"#{__dir__}/db/home_automation.sqlite3\"\n\n# Rakefile\nrequire 'sinatra/activerecord/rake'\n\nnamespace :db do\n  task :load_config do\n    require './app'\n  end\nend\n</code></pre></div></div>\n\n<p>Note that we use <code class=\"highlighter-rouge\">__dir__</code> to get app_file folder so it works fine when we run\nthe app from non root path <code class=\"highlighter-rouge\">ruby some/path/to/app.rb</code></p>\n\n<p>And you can create tables</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rake db:create_migration NAME=create_temperatures\n</code></pre></div></div>\n\n<p>and models</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Temperature &lt; ActiveRecord::Base\nend\n</code></pre></div></div>\n\n<p>On raspberri pi you should install sqlite3</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get autoremove; sudo apt-get autoclean;sudo apt-get clean\nsudo apt-get update; sudo apt-get -y dist-upgrade; sudo apt-get install sqlite3\nsudo apt-get install libsqlite3-dev\n</code></pre></div></div>\n\n<h1 id=\"sinatra-tests\">Sinatra tests</h1>\n\n<p>https://www.sitepoint.com/build-sinatra-api-using-tdd-heroku-continuous-integration-travis/</p>\n\n<h1 id=\"console\">Console</h1>\n\n<p>You can access console like <code class=\"highlighter-rouge\">rails c</code> with https://github.com/sickill/racksh</p>\n\n<h1 id=\"webpack\">Webpack</h1>\n\n<p>You can use javascript with hot reloading using https://github.com/kopylovvlad/sinatra-webpack-vuejs-template</p>\n\n<h1 id=\"sending-emails\">Sending emails</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'mail'\n\n# my_mail.rb\nrequire 'mail'\n\n# test with\n# rvmsudo ruby -e \"load 'my_mail.rb';MyMail.send()\"\n# using sudo requires -E to pass enviroment variables\n# sudo -E ruby -e \"load 'my_mail.rb';MyMail.send()\"\n\nGMAIL_EMAIL = ENV['GMAIL_EMAIL'] # ENV['rvm_EMAIL_USER_NAME'],\nGMAIL_PASSWORD = ENV['GMAIL_PASSWORD'] # ENV['rvm_EMAIL_PASSWORD'],\nEXCEPTION_RECIPIENTS = ENV['EXCEPTION_RECIPIENTS'] # ENV['rvm_EMAIL_RECIPIENT_EMAIL']\n\noptions = {\n  address: 'smtp.gmail.com',\n  port: 587,\n  user_name: GMAIL_EMAIL,\n  password: GMAIL_PASSWORD,\n}\n# puts options\n\nMail.defaults do\n  delivery_method :smtp, options\nend\n\nmodule MyMail\n  def self.send(subject: 'alert', text: 'hi', attachment: nil)\n    puts \"Send email #{text} #{attachment}\"\n    Mail.deliver do\n      to EXCEPTION_RECIPIENTS\n      from GMAIL_EMAIL\n      subject subject\n      body text\n      add_file attachment unless attachment.nil?\n    end\n  rescue StandardError =&gt; e\n    puts \"MyMail.send failed #{e}\"\n  end\nend\n</code></pre></div></div>\n\n<p>Usage in <code class=\"highlighter-rouge\">app.rb</code> is like</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>MyMail.send attachment: image_file, text: S3.getUrl(video_file)\n</code></pre></div></div>\n\n<h1 id=\"timezone\">Timezone</h1>\n\n<p>In pure ruby, you can show UTC time in your time zone by specifying offset</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> Time.now.localtime(\"+02:00\")\n</code></pre></div></div>\n\n<h1 id=\"examples-of-opensource-apps\">Examples of opensource apps</h1>\n\n<ul>\n  <li>https://github.com/swanson/stringer Nice Sinatra ActiveRecord Backbone app. It</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Rss Feed Reader",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/05/30/rss-feed-reader/",
      "date"     : "2018-05-30 00:00:00 +0200",
      "content"  : "<h1 id=\"feedjira\">Feedjira</h1>\n\n<p>http://feedjira.com/</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>feed = Feedjira::Feed.fetch_and_parse url\n</code></pre></div></div>\n\n<p>Opensource sites that uses feedjira:</p>\n\n<ul>\n  <li>https://github.com/swanson/stringer Nice Sinatra ActiveRecord Backbone app. It\nuses hourly rake task (to create delayed job for each feed to fetch new items)</li>\n  <li>https://github.com/amatriain/feedbunch</li>\n  <li>https://github.com/feedbin/feedbin</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Websockets Actioncable",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/05/24/websockets-actioncable/",
      "date"     : "2018-05-24 00:00:00 +0200",
      "content"  : "<p>https://gorails.com/episodes/realtime-ssh-logs-with-actioncable</p>\n"
    } ,
  
    {
      "title"    : "Ruby Http Client",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/05/18/ruby-http-client/",
      "date"     : "2018-05-18 00:00:00 +0200",
      "content"  : "<h1 id=\"nethttp\">Net::HTTP</h1>\n\n<p>Http client https://docs.ruby-lang.org/en/2.0.0/Net/HTTP.html\nSet uri</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>uri = URI('http://www.example.com/search.cgi')\n\n# add some params to uri\nparams = { :limit =&gt; 10, :page =&gt; 3 }\nuri.query = URI.encode_www_form(params)\n</code></pre></div></div>\n\n<p>Simple one liner <code class=\"highlighter-rouge\">Net::HTTP.get</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># you can get body (without status)\nresponse_body = Net::HTTP.get uri\n# but I prefer to fetch also the status\nresponse = Net::HTTP.get_response uri\n</code></pre></div></div>\n\n<p>Simple one liner <code class=\"highlighter-rouge\">Net::HTTP.post_form</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>response = Net::HTTP.post_form(uri, 'q' =&gt; ['ruby', 'perl'], 'max' =&gt; '50')\n</code></pre></div></div>\n\n<p>Longer format is with <code class=\"highlighter-rouge\">HTTP.new</code> or <code class=\"highlighter-rouge\">HTTP.start</code> block syntax (better since you\ndo not need to call <code class=\"highlighter-rouge\">http.start</code> and it automatically close connection). Longer\nmeans than you create separate <code class=\"highlighter-rouge\">request</code> object and use with http connection to\nmake request</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>http = Net::HTTP.new(uri.host, uri.port)\nrequest = Net::HTTP::Get.new '/'\nresponse = http.request request\n</code></pre></div></div>\n\n<p>For https you need to enable ssl. If url is https but you do not use ssl than\nyou will get following error <code class=\"highlighter-rouge\">EOFError: end of file reached</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># if you are using https\nhttp.use_ssl = true\n# or the best is to use\nhttp.use_ssl = (uri.scheme == \"https\")\n# you can also disable verify ssl with\nhttp.verify_mode = OpenSSL::SSL::VERIFY_NONE\n</code></pre></div></div>\n\n<p>You can define timeouts</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>http.open_timeout = 1\n# when response takes to much time\nhttp.read_timeout = 3\n# when you POST a lot of data\nhttp.write_timeout = 10\n</code></pre></div></div>\n\n<p>On request object you can set headers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>header = {'Content-Type': 'application/json'}\nrequest = Net::HTTP::Post.new(uri, header)\n# or\nrequest['Content-Type'] = 'text/json'\n</code></pre></div></div>\n\n<p>On response you can read headers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>response.each_key {|k| res[k]}\n{\"server\"=&gt;[\"nginx/1.6.2\"], \"date\"=&gt;[\"Wed, 17 Oct 2018 22:22:51 GMT\"], \"content-type\"=&gt;[\"text/html\"], \"content-length\"=&gt;[\"184\"], \"connection\"=&gt;[\"close\"], \"location\"=&gt;[\"https://paytm.com/business/payments\"]}\n</code></pre></div></div>\n\n<p>Set Form data</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>request.set_form_data(user: { name: 'Duke' })\n# or\nrequest.body = { user: { name: 'Duke' } }.to_json\n# or plain text when request['Content-Type'] = 'application/x-www-form-urlencoded'\n# ie in Postman there is no json curly braces\nrequest.body = 'grant_type=client_credentials'\n</code></pre></div></div>\n\n<p>Basic authentication header</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>request.basic_auth username, password\n</code></pre></div></div>\n\n<h1 id=\"snippets\">Snippets</h1>\n\n<p>Handle redirection</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'net/http'\nrequire 'uri'\n\ndef fetch(uri_str, limit = 10)\n  # You should choose better exception.\n  raise ArgumentError, 'HTTP redirect too deep' if limit == 0\n\n  url = URI.parse(uri_str)\n  request = Net::HTTP::Get.new(url.path, { 'User-Agent' =&gt; 'Mozilla/5.0 (etc...)' })\n  response = Net::HTTP.start(url.host, url.port) { |http| http.request(request) }\n  case response\n  when Net::HTTPSuccess     then response\n  when Net::HTTPRedirection then fetch(response['location'], limit - 1)\n  else\n    response.error!\n  end\nend\n\nprint fetch('http://www.ruby-lang.org/')\n</code></pre></div></div>\n\n<h1 id=\"httparty\">HTTParty</h1>\n\n<p>This gem is a little bit simpler than plain Net::HTTP.\nIt does not support multipart requests (needed for uploading a file)</p>\n\n<h1 id=\"restclient\">RestClient</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'rest-client'\nRestClient.post '/profile', file: File.new('photo.jpg', 'rb')\n</code></pre></div></div>\n\n<h1 id=\"faraday\">Faraday</h1>\n\n<p>Faraday allows you to choose any implemetnation (net/http, typhoeus)</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'faraday'\nconn =\nFaraday.new do |f|\n  f.request :multipart\n  f.request :url_encoded\n  f.adapter :net_http\nend\nfile_io = Faraday::UploadIO.new('photo.jpg', 'image/jpeg')\nconn.post('http://example.com/profile', file: file_io)\n</code></pre></div></div>\n\n<h1 id=\"debug-requests\">Debug requests</h1>\n\n<p>Ruby one liner http server</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ruby -rsocket -e \"trap('SIGINT') { exit }; Socket.tcp_server_loop(8080) { |s,_| puts s.readpartial(1024); puts; s.puts 'HTTP/1.1 200'; s.close }\"\n</code></pre></div></div>\n\n<p>And open <a href=\"http://localhost:8080/\">http://localhost:8080/</a> to see all headers and body</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>GET / HTTP/1.1\nHost: localhost:8080\nConnection: keep-alive\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.32 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Encoding: gzip, deflate, br\nAccept-Language: en-US,en;q=0.9,sr;q=0.8,hr;q=0.7,bs;q=0.6,da;q=0.5,pt;q=0.4,bg;q=0.3\nCookie: _session_id=...\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Gdpr Privacy Policy And Terms Of Use",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/05/17/gdpr-privacy-policy-and-terms-of-use/",
      "date"     : "2018-05-17 00:00:00 +0200",
      "content"  : "<h1 id=\"gdpr\">GDPR</h1>\n\n<p>How other implement that https://www.youtube.com/watch?v=8nq43nqi9X0&amp;t=\nWhen you source, process and use personal data than you need to implement\nGeneral Data Protection Regulation</p>\n\n<ul>\n  <li>expiry period (retention) should be accessible. When that expires, personal\ndata should be destroyed if there is no confirmation of that person</li>\n  <li>put a link in a email notification than can be used by person to correct or\ndelete its data</li>\n  <li>make persons aware of how their data is being processed by adding privacy\npolicy page to the site and link in the footer</li>\n  <li>show cookie consent box and show box for consent of processing their personal\ndata</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Let Me See",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/04/16/let-me-see/",
      "date"     : "2018-04-16 00:00:00 +0200",
      "content"  : "<p>Let me see is a web app that you can run locally (or self hosted somewhere) and\nuse to test how some webpage looks like.\nNote that you need permission to access that page.\nIt is simillar to other testing, scrapping, crawler tools, but I wanted to build\none myself.</p>\n\n<p>It is API based service.</p>\n\n<p>Results can be returned using websockets:\nhttps://blog.stanko.io/do-you-really-need-websockets-343aed40aa9b</p>\n\n<p>Node tool of controlling headless chrome https://pptr.dev/ puppeteer\nIn python https://scrapy.org/</p>\n\n<p>https://awesome-ruby.com/#-web-crawling</p>\n\n<p>https://github.com/MontFerret/ferret</p>\n\n<p>https://github.com/openaustralia/morph\nhttps://morph.io/planningalerts-scrapers/kiama</p>\n"
    } ,
  
    {
      "title"    : "Continuous Delivery Integration Ci Cd Pronto",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/04/10/continuous-delivery-integration-ci-cd-pronto/",
      "date"     : "2018-04-10 00:00:00 +0200",
      "content"  : "<h1 id=\"other-examples\">Other examples</h1>\n\n<ul>\n  <li><a href=\"https://jenkins.io/\">https://jenkins.io/</a> https://github.com/jenkinsci/jenkins ci in java</li>\n  <li>others <a href=\"https://news.ycombinator.com/item?id=12703121\">https://news.ycombinator.com/item?id=12703121</a></li>\n</ul>\n\n<h1 id=\"flynn\">Flynn</h1>\n\n<p><a href=\"https://flynn.io/\">https://flynn.io/</a></p>\n\n<p>Install</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>L=/usr/local/bin/flynn &amp;&amp; curl -sSL -A \"`uname -sp`\" https://dl.flynn.io/cli | zcat &gt;$L &amp;&amp; chmod +x $L\n</code></pre></div></div>\n\n<h1 id=\"fastline-ci\">Fastline Ci</h1>\n\n<p><a href=\"https://github.com/fastlane/ci\">https://github.com/fastlane/ci</a> Open source, self hosted, mobile optimized CI\npowered by fastlane (opensource tools for building mobile apps). I like it\nbecause it is ruby.\nIt requires Fastfile</p>\n\n<h1 id=\"gocd\">Gocd</h1>\n\n<p>https://www.gocd.org/</p>\n\n<p>After downloading client and server dev file, double click and install, you can\nstart with https://docs.gocd.org/current/installation/install/server/linux.html#debian-based-distributions-ie-ubuntu</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo /etc/init.d/go-server start\n# Started Go Server on http://main:8153/go\n\nsudo /etc/init.d/go-agent start\n# http://localhost:8153/go\n</code></pre></div></div>\n\n<p>Quite complicated…</p>\n\n<h1 id=\"pronto\">Pronto</h1>\n\n<p>You can create another github user bot (and invite him to collaborate on\nyour project) and use <a href=\"https://github.com/mmozuras/pronto\">pronto</a> to post\ncomments on commit, pull request or status</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development do/a  \\\n  gem \"pronto\", require: false\\\n  gem \"pronto-rubocop\", require: false\\\n  gem \"pronto-brakeman\", require: false\\\n  gem \"pronto-eslint\", require: false\\\n  gem \"pronto-jshint\", require: false\\\n  gem \"pronto-poper\", require: false\\\n  gem \"pronto-rails_best_practices\", require: false\\\n  gem \"pronto-reek\", require: false\\\n  gem \"pronto-scss\", require: false\\\n  gem \"pronto-flay\", require: false\\\n'\n</code></pre></div></div>\n\n<p>Generate <a href=\"https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/\">Personal Access\nToken</a>\nfor the bot user and export in your env file so pronto command can post comments</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pronto run -f github\npronto run -f github_status\npronto run -f github_pr\n</code></pre></div></div>\n\n<p>You need to set up target commit (default is master) to which it needs to\ncompare current HEAD. It compare only changes that occurs between those two\n(changes on master are ignored).</p>\n\n<p><a href=\"https://christoph.luppri.ch/articles/2017/03/05/how-to-automatically-review-your-prs-for-style-violations-with-pronto-and-rubocop\">https://christoph.luppri.ch/articles/2017/03/05/how-to-automatically-review-your-prs-for-style-violations-with-pronto-and-rubocop</a>\nto find last pull request id</p>\n"
    } ,
  
    {
      "title"    : "Stimulus Js",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/03/22/stimulus-js/",
      "date"     : "2018-03-22 00:00:00 +0100",
      "content"  : "<h1 id=\"install\">Install</h1>\n\n<p>To checkount demo you can</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git clone https://github.com/stimulusjs/stimulus-starter.git\ncd stimulus-starter\nyarn install\nyarn start\ngnome-open http://localhost:9000/\n</code></pre></div></div>\n\n<p>To add to existing Rails app</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails webpacker:install:stimulus\n</code></pre></div></div>\n\n<h1 id=\"magic-keywords\">Magic keywords</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">data-controller='hello'</code> controller that is defined in <code class=\"highlighter-rouge\">hello_controller.js</code>.\nEach dash corresponts to underscore (or dash) in file name, two dashes\ncorresponds to subfolder <code class=\"highlighter-rouge\">users--list-item</code> -&gt; <code class=\"highlighter-rouge\">users/list_item_controller.js</code></li>\n  <li><code class=\"highlighter-rouge\">data-action='click-&gt;hello#greet'</code> event name is <code class=\"highlighter-rouge\">click</code>, controller <code class=\"highlighter-rouge\">hello</code>\nmethod <code class=\"highlighter-rouge\">greet</code>. If element is <code class=\"highlighter-rouge\">&lt;a&gt;</code>, <code class=\"highlighter-rouge\">&lt;button&gt;</code>, <code class=\"highlighter-rouge\">&lt;input type=\"submit\"&gt;</code> than\nyou do not need to write <code class=\"highlighter-rouge\">click</code>. <code class=\"highlighter-rouge\">&lt;input&gt;</code>, <code class=\"highlighter-rouge\">&lt;select&gt;</code> and <code class=\"highlighter-rouge\">&lt;textarea&gt;</code> has\n<code class=\"highlighter-rouge\">change</code> as default event. <code class=\"highlighter-rouge\">&lt;form&gt;</code> has <code class=\"highlighter-rouge\">submit</code> default event. If you want to\n<code class=\"highlighter-rouge\">event.preventDefault()</code> (for example click on link) than pass parameter\n<code class=\"highlighter-rouge\">greet(event) {}</code></li>\n  <li><code class=\"highlighter-rouge\">data-target='hello.name'</code> creates <code class=\"highlighter-rouge\">nameTarget</code> property in a controller so we\ncan use it to set value. We need to declare it also inside controller <code class=\"highlighter-rouge\">static\ntargets = [ 'name' ]</code>. Beside <code class=\"highlighter-rouge\">this.nameTarget</code> you can check if there are\nmore targets like this <code class=\"highlighter-rouge\">this.nameTargets</code> or if exists at all\n<code class=\"highlighter-rouge\">this.hasNameTarget</code> (return true or false)</li>\n  <li><code class=\"highlighter-rouge\">data-hello-index='1'</code> used to pass data to controller which you can get on\ninitialize instead of <code class=\"highlighter-rouge\">this.element.getAttribute('data-hello-index'))</code> you can\nuse stimulus shorthand <code class=\"highlighter-rouge\">this.data.get('index')</code>. Also <code class=\"highlighter-rouge\">this.data.has('index')</code>\nto check if data existis and <code class=\"highlighter-rouge\">this.data.set('index', 2)</code> to set data so\ncontroller do not need to store any data, just use setter and getter to store\ndata in DOM.</li>\n</ul>\n\n<p>Controllers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// src/controllers/hello_controller.js\nimport { Controller } from \"stimulus\"\n\nexport default class extends Controller {\n  // triggered when controller is connected to the document\n  // you can add classes to element\n  connect() {\n    this.element.classList.add('controller-initialized')\n  }\n  // anytime when controller is disconnected from the dom\n  disconnect() {}\n  // initialize is once when controller is first instantiated\n  initialize() {\n    this.showCurrentSlide()\n  }\n\n  showCurrentSlide() {\n    this.slideTargets.forEach((el, i) =&gt; {\n      el.classList.toggle(\"slide--current\", this.index == i)\n    })\n  }\n\n  # getter\n  get index() {\n    return parseInt(this.data.get('index'))\n  }\n\n  # setter\n  set index(value) {\n    this.data.set('index', value)\n  }\n}\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Blockchain Bitcoin Etherium",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/02/21/blockchain-bitcoin-etherium/",
      "date"     : "2018-02-21 00:00:00 +0100",
      "content"  : "<p>Hash function is function that accepts input of arbitrary size and produce fixed\nsized output. Two different inputs is very likely to produce different outputs.\nFunction is irreversible.</p>\n\n<p>Homework: Find document for which CRC32 32 bits signature is 0xbbd1264f.</p>\n\n<p>Symmetric cryptography, AES, one key is used for encryption or decryption.\nBlock algorithims.</p>\n\n<p>Asymmetric cryptography (public and private key).\nAsymetric signatures.</p>\n\n<h1 id=\"master-etherum-book\">Master Etherum book</h1>\n\n<p><a href=\"https://github.com/ethereumbook/ethereumbook\">https://github.com/ethereumbook/ethereumbook</a>\nstop at introduction</p>\n\n<p>https://player.fm/series/blockchain-software-engineering-daily/ethereum-platform-with-preethi-kasireddy</p>\n\n<p>http://www.toptal.com/ethereum</p>\n"
    } ,
  
    {
      "title"    : "Mikrotik Routers Winbox",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/02/12/mikrotik-routers-winbox/",
      "date"     : "2018-02-12 00:00:00 +0100",
      "content"  : "<p>I got Router Board <a href=\"https://mikrotik.com/product/RB750Gr3\">rb 750 gr3</a> with 16MB\nRAM in flash.</p>\n\n<h1 id=\"winbox-on-wine\">Winbox on Wine</h1>\n\n<p><a href=\"https://wiki.winehq.org/Ubuntu\">https://wiki.winehq.org/Ubuntu</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo dpkg --add-architecture i386\nwget -nc https://dl.winehq.org/wine-builds/Release.key\nsudo apt-key add Release.key\nsudo apt-add-repository https://dl.winehq.org/wine-builds/ubuntu/\nsudo apt-get update\nsudo apt-get install --install-recommends winehq-stable\n</code></pre></div></div>\n\n<p>Run <code class=\"highlighter-rouge\">winbox.exe</code> in wine and download plugins. Click on tab <code class=\"highlighter-rouge\">Neighbors</code> and when\nit finds it, use Login: admin and empty password.\nI’m using WinBox v3.12.</p>\n\n<p>On router there is RouterOS.  To upgrade, download routeros\nhttps://mikrotik.com/download for your specific archicteture and drag and drop\n(works in wine) to “Files” (it will appear on root) and simply reboot.\nI’m using RouterOS v6.41.2</p>\n\n<p>You can connect to terminal using Winbox or using ssh (look below for how to\nconnect to mikrotik)</p>\n\n<h1 id=\"terminal-and-scripts\">Terminal and Scripts</h1>\n\n<p>Item names can be used instead of item number and are more stable since some\nother user can configure router in the same time or change scripts.</p>\n\n<p>General menu commands:\nhttps://wiki.mikrotik.com/wiki/Manual:Console#General_Commands</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">print</code> is to list all items, <code class=\"highlighter-rouge\">print file=my_file</code> print to file, <code class=\"highlighter-rouge\">print\ndetail</code> print in format <code class=\"highlighter-rouge\">prop=value</code> (oposite to <code class=\"highlighter-rouge\">print brief</code>), <code class=\"highlighter-rouge\">print\nfollow</code> like tail -f, <code class=\"highlighter-rouge\">print from=my_property_name</code> print single item find by\nname (similar to <code class=\"highlighter-rouge\">print where name=my_property_name</code>), <code class=\"highlighter-rouge\">/ip route print where\ninterface=\"ether1\"</code> filtering used for print, <code class=\"highlighter-rouge\">print dynamic</code> print dynamic\nitems. <code class=\"highlighter-rouge\">print static interval=1</code> print static items and refresh every 2\nseconds</li>\n  <li><code class=\"highlighter-rouge\">add</code> to create new record. You can use <code class=\"highlighter-rouge\">copy-from</code>. example is <code class=\"highlighter-rouge\">add address =\n192.168.0.1 / 24 network = 192.168.0.0 broadcast = 192.168.0.255 interface =\nLocal</code></li>\n  <li><code class=\"highlighter-rouge\">remove &lt;id&gt;</code> remove record</li>\n  <li><code class=\"highlighter-rouge\">disable &lt;id&gt;</code> and <code class=\"highlighter-rouge\">enable &lt;id&gt;</code></li>\n  <li><code class=\"highlighter-rouge\">move</code></li>\n  <li><code class=\"highlighter-rouge\">edit &lt;id&gt; prop</code> any property/param in editor <code class=\"highlighter-rouge\">edit pptp-out1 password</code></li>\n  <li><code class=\"highlighter-rouge\">set &lt;id&gt; prop=value</code> similar to edit, but for more properties. Use <code class=\"highlighter-rouge\">!</code> to\nunset <code class=\"highlighter-rouge\">:set 3 !password</code>. To disable you can use <code class=\"highlighter-rouge\">set 3 disable=yes</code>.</li>\n  <li><code class=\"highlighter-rouge\">get &lt;id&gt; prop</code> used for inline expressions <code class=\"highlighter-rouge\">:put [get 1 address]</code></li>\n  <li><code class=\"highlighter-rouge\">find</code> filtering <code class=\"highlighter-rouge\">:put [/interface find name~\"ether\"]</code> this will return array\nof <code class=\"highlighter-rouge\">&lt;id&gt;</code>. It can be used for example\nto remove all globals you can <code class=\"highlighter-rouge\">/system script environment remove [find]</code>,\nupdate specific item: <code class=\"highlighter-rouge\">/system logging set [find topics=\"warning\"]\naction=disk</code></li>\n  <li><code class=\"highlighter-rouge\">/export file=myfilename</code> will export all configurations. You can export only\nnot default with <code class=\"highlighter-rouge\">/export compact</code>, or <code class=\"highlighter-rouge\">/export compact file=my_export</code> to\nsave to a file <code class=\"highlighter-rouge\">/dule.rsc</code> which you can download using ftp. If you are not in\nroot, for example you are in <code class=\"highlighter-rouge\">/ip</code> it will export only changes to <code class=\"highlighter-rouge\">ip</code>. You\ncan <code class=\"highlighter-rouge\">/import myfilename.rsc</code> to load configurations. Add <code class=\"highlighter-rouge\">verbose=yes</code> to see\nmore info. If file name ends with auto <code class=\"highlighter-rouge\">myfilename.auto.rsc</code> than it will be\nexecuted when uploaded using FTP.\nIn rsc file you can indent all commands with <code class=\"highlighter-rouge\">:%s/^\\([as]\\)/    \\1/</code></li>\n</ul>\n\n<p>Keyboard shortcuts similar to linux: <code class=\"highlighter-rouge\">&lt;c-k&gt;</code> clear to end of line, <code class=\"highlighter-rouge\">&lt;c-b&gt;</code>\n<code class=\"highlighter-rouge\">&lt;c-f&gt;</code> back and forward one char, <code class=\"highlighter-rouge\">&lt;c-a&gt;</code> <code class=\"highlighter-rouge\">&lt;c-e</code> jump to begging or end of\nline.</p>\n\n<p>Safe mode starts with <code class=\"highlighter-rouge\">&lt;c-x&gt;</code>, and ends and keep all changes also with <code class=\"highlighter-rouge\">&lt;c-x&gt;</code>.\ntwice <code class=\"highlighter-rouge\">&lt;c-x&gt;</code> will empty safe mode action list so you can store more.\n<code class=\"highlighter-rouge\">&lt;c-d&gt;</code> undo all safe mode changes, while <code class=\"highlighter-rouge\">/quit</code> does not.\nYou can rewiev all safe mode changes (while you are in safe mode) with <code class=\"highlighter-rouge\">/system\nhistory print</code>\nIf you want to paste some commands, but autocompletion triggers some errors, you\ncan go to Safe mode so autocompletion is triggered only on tab.</p>\n\n<p><a href=\"https://wiki.mikrotik.com/wiki/Manual:Scripting#Global_commands\">https://wiki.mikrotik.com/wiki/Manual:Scripting#Global_commands</a>\nNote that all commands that work with data, starts with <code class=\"highlighter-rouge\">:</code></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\"># comment should start on beggining of the line</code></li>\n  <li><code class=\"highlighter-rouge\">/</code> move top level, <code class=\"highlighter-rouge\">..</code> move up</li>\n  <li><code class=\"highlighter-rouge\">?</code> show available commands</li>\n  <li><code class=\"highlighter-rouge\">:delay 3</code> do nothing for 3 seconds. Could be miliseconds <code class=\"highlighter-rouge\">:delay 10ms</code></li>\n</ul>\n\n<p>In terminal you can set variables. Local variables only works inside <code class=\"highlighter-rouge\">{ }</code>, They\nare ignored if used at root of console. Always use snakeCase, so you do not\noverlap with keywords. If you need to use underscore than wrap variable with\nquotes. You can pring value with <code class=\"highlighter-rouge\">:put</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:global globalVar;\n{\n  :local localVar localValue;\n  :set localVar 1;\n  :put $localVar;\n}\n:global \"var_with_underscore\";\n:global \"var-with-dash\";\n</code></pre></div></div>\n\n<p>In scripts when hotspot user logs in you can access <code class=\"highlighter-rouge\">$user</code> variable (it is\nusername)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:global username [/ip hotspot active find user=$user];\n:global userip [/ip hotspot active get $username address];\n:log info $userip\n\n# or in one line\n/ip hotspot user profile set [ find default=yes ] on-login=\"if ([/ip hotspot active get [find user=\\$user] address] in 10.255.0.0/16) do={:log warning \\\"THIS SUBSCRIBER HAS EXPIRED! ASSIGNED IP IN 10.255.0.0/16\\\"}\"\n</code></pre></div></div>\n\n<p>Conditionals</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:if () do={\n}\n\n# check if some record exists\n:if ([:len [/system package find name=\"dhcp\" !disabled]] != 0) do={\n}\n# check if ping did not timeout\n:if ([:ping 123.123.123.123 count=5] = 0) do={\n  :error \"Ping timeout 5 times\"\n}\n</code></pre></div></div>\n\n<p>Various</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:put message=\"some message\"\n# join long lines with \\\n# white space is not allowed around \"=\"\n</code></pre></div></div>\n\n<p>Data types</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">num</code></li>\n  <li><code class=\"highlighter-rouge\">bool</code></li>\n  <li><code class=\"highlighter-rouge\">str</code> string can be concatenated with <code class=\"highlighter-rouge\">\"asd\".\"qwe\"</code>. Lenght of string with\n<code class=\"highlighter-rouge\">:put [:len \"asdf\"]</code>. Interpolate with <code class=\"highlighter-rouge\">:put \"a=$($a))\"</code> or <code class=\"highlighter-rouge\">:put \"we have\nfind $[ :len [/ip route find] ] routes\"</code></li>\n  <li><code class=\"highlighter-rouge\">ip</code></li>\n  <li><code class=\"highlighter-rouge\">ip-prefix</code></li>\n  <li><code class=\"highlighter-rouge\">id</code> prefixed with <code class=\"highlighter-rouge\">*</code></li>\n  <li><code class=\"highlighter-rouge\">time</code></li>\n  <li><code class=\"highlighter-rouge\">array</code> can be concatenated with comma <code class=\"highlighter-rouge\">:put ({1;2;3}, 5)</code>. Can also use named\nelements <code class=\"highlighter-rouge\">{1; a=2; \"b3\"=3; 4}</code> and than can be accessed with hash arrow but it\nneeds to be grouped with brackets <code class=\"highlighter-rouge\">:set ($a-&gt;\"a\") 22</code>. Positional elements can\nbe accessed with <code class=\"highlighter-rouge\">:put [:pick $a 0]</code>\nArrays can be generated from string with <code class=\"highlighter-rouge\">:local myArray [:toarray $myStr]</code></li>\n  <li><code class=\"highlighter-rouge\">nil</code></li>\n</ul>\n\n<p>You can convert data</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>#convert string to array\n:local myStr \"1,2,3,4,5\";\n:put [:typeof $myStr];\n:local myArr [:toarray $myStr];\n:put [:typeof $myArr]\n</code></pre></div></div>\n\n<p>Operators</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">in</code> logical <em>belongs</em> <code class=\"highlighter-rouge\">:put (1.1.1.1/32 in 1.0.0.0/8);</code></li>\n  <li><code class=\"highlighter-rouge\">[]</code> square brackets is command substitution <code class=\"highlighter-rouge\">:put [ :len \"my string\" ];</code>.\nOnly one line is allowed (commands can be separated with <code class=\"highlighter-rouge\">;</code>). To use in menu\ncommands wrap with a string <code class=\"highlighter-rouge\">add address=\"$[ $ip . \"1\" ]\"</code>. It is not allowed\nto have nested substitution.</li>\n  <li><code class=\"highlighter-rouge\">()</code> round brackets sub expression or grouping operator <code class=\"highlighter-rouge\">:put ( \"value is \" . (4+5));</code></li>\n</ul>\n\n<p>Find</p>\n\n<p><code class=\"highlighter-rouge\">:find</code> there is also <code class=\"highlighter-rouge\">find</code> command but it is only for filtering.\n<code class=\"highlighter-rouge\">:put [:find \"asd\" \"s\"];</code> return position of substring or array (in this\nexample <code class=\"highlighter-rouge\">1</code> so if you pick to that position <code class=\"highlighter-rouge\">s</code> will not be included), can\naccept integer that means where to start (-1 is before start, 0 is to ignore\nfirst).  If you want to know if it founds try this:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:if ([:len [:find \"abcd\" \"x\"]] &gt; 0) do={:put \"Found\";} else={:put \"Not Found\";};\n</code></pre></div></div>\n\n<p>Pick</p>\n\n<p><code class=\"highlighter-rouge\">:pick $myVar &lt;start&gt; &lt;end&gt;</code> return substring <code class=\"highlighter-rouge\">:put [:pick \"abcde\" 1 3]</code> will\nreturn <code class=\"highlighter-rouge\">bc</code>. Start can be <code class=\"highlighter-rouge\">-1</code> or <code class=\"highlighter-rouge\">0</code> to pick from beggining.</p>\n\n<p>Loops</p>\n\n<p><code class=\"highlighter-rouge\">:for i from=1 to=10 step=2 do= {}</code> iterate for loop\n<code class=\"highlighter-rouge\">:do { } while=()</code> or <code class=\"highlighter-rouge\">:while () do={ }</code> while loop\n<code class=\"highlighter-rouge\">:foreach i in=$myArray do= { }</code> iterate array elements</p>\n\n<p>Functions</p>\n\n<p>Functions can accept named <code class=\"highlighter-rouge\">$argName</code> or unnamed arguments <code class=\"highlighter-rouge\">$1, $2 ...</code>. Avoid\nusing parameters with same name as global variables.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:global myFunc do={\n  :local sum ($a + $b)\n  :return $sum\n}\n\n# call function with square brackets\n:put [$myFunc a=1 b=2]\n</code></pre></div></div>\n\n<p>To call another function from inside function, you need to declare it</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:global funcA do={ :return 5 }\n:global funcB do={\n  :global funcA;\n  :return ([$funcA] + 4)\n}\n</code></pre></div></div>\n\n<p>Parse can be used to define functions: <code class=\"highlighter-rouge\">:global myFunc [:parse \":put hello!\"];</code></p>\n\n<p>Logs and debug</p>\n\n<p>You can print to terminal with <code class=\"highlighter-rouge\">:put message=hi</code> or to log <code class=\"highlighter-rouge\">:log info hi</code> (log\ncan be used both as /menu and :command).\n<a href=\"https://wiki.mikrotik.com/wiki/Manual:System/Log\">https://wiki.mikrotik.com/wiki/Manual:System/Log</a>\n<code class=\"highlighter-rouge\">:log warning \"My message\"</code> write to topic: <code class=\"highlighter-rouge\">error</code>, <code class=\"highlighter-rouge\">info</code> and <code class=\"highlighter-rouge\">warning</code>. You\ncan define topis on <code class=\"highlighter-rouge\">/system logging</code> and which action to perform. Actions could\nbe <code class=\"highlighter-rouge\">memory</code> (shows in <code class=\"highlighter-rouge\">/log print</code>), <code class=\"highlighter-rouge\">echo</code> (show in console), <code class=\"highlighter-rouge\">disk</code> (write to\nfile), <code class=\"highlighter-rouge\">email</code> and <code class=\"highlighter-rouge\">remote</code> (from webproxy to Kiwi server). Topics could be for\nexample <code class=\"highlighter-rouge\">hotspot</code>, <code class=\"highlighter-rouge\">pppoe</code>. To set <code class=\"highlighter-rouge\">warnings</code> to write to file (anyway it will\nshow in <code class=\"highlighter-rouge\">/log</code> just if we need to save for later use)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># set warning to disk\n/system logging set [find topics=\"warning\"] action=disk\n:log warning \"WAN started \"\n</code></pre></div></div>\n\n<p>to see all logs on host you can run</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ssh admin@$MIKROTIK_IP log print follow\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">:put [:time { :delay 100ms }]</code> show time needed to execute command\n<code class=\"highlighter-rouge\">:environment print</code> show all variables and functions. They are defined as\nrecords on <code class=\"highlighter-rouge\">/system script environment print</code>\n<code class=\"highlighter-rouge\">:do {} on-error={ :put \"my script failed\" }</code> catch run time errors\n<code class=\"highlighter-rouge\">:error \"Message\"</code> stop executing the script</p>\n\n<p>Run command in background and remove it</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  :local pid [:execute {/interface print follow}]`\n  :delay 5s\n  :do { /system script job remove $pid } on-error={}\n}\n</code></pre></div></div>\n\n<p>Scripts can be stored and triggered on event or by another\nscript. For example I use my helper functions and load them from other scripts.\nTo create use winbox (copy and paste) since <code class=\"highlighter-rouge\">$</code>, <code class=\"highlighter-rouge\">\"</code> and <code class=\"highlighter-rouge\">\\ </code> must be escaped\nwith preceding backslash <code class=\"highlighter-rouge\">\\ </code> if you want to create using terminal <code class=\"highlighter-rouge\">/system\nscript add name=helpers source=...</code>. Before use you need to run them</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/system script run helpers\n</code></pre></div></div>\n\n<p>To replace mask with 1 you can</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># helpers.script\n# Add to /system scripts using Windbox\n# if using terminal you need to escape $ \" \\\n# before use you need to call\n# /system script run helpers\n\n# Strip Mark from IP\n# :put [$stripMask 192.168.1.5/24]\n# 192.168.1.5\n# :put [$stripMask 192.168.1.5]\n# 192.168.1.5\n:global stripMask do={\n  :local slashPosition [:find $1 \"/\"]\n  if ([:len $slashPosition] &gt; 0) do={\n    :return [:pick $1 -1 $slashPosition ]\n  } else= {\n    :return $1\n  }\n}\n\n# Replace Last Number in IP address\n# :put [$replaceLastNumber 192.168.1.5/24 1]\n# 192.168.1.1\n# :put [$replaceLastNumber 192.168.1.5 \"2\"]\n# 192.168.1.2\n:global replaceLastNumber do={\n  :local firstDot [:find $1 \".\" -1]\n  :local secondDot [:find $1 \".\" $firstDot]\n  :local thirdDot [:find $1 \".\" $secondDot]\n  :return ([:pick $1 -1 $thirdDot] . \".\" . $2)\n}\n</code></pre></div></div>\n\n<h2 id=\"script-to-send-system-log-to-email\">Script to send system log to email</h2>\n\n<p>https://forum.mikrotik.com/viewtopic.php?t=29130</p>\n\n<h1 id=\"theory\">Theory</h1>\n\n<p>To connect using IP you need to create IP -&gt; Addresses -&gt; New Address.\nAlso you need to setup routes with gateway that are provided by isp (or it is\nyour adsl router ip address).\nhttps://wiki.mikrotik.com/wiki/Manual:IP/Route\nRoute with <code class=\"highlighter-rouge\">dst-address=0.0.0.0/0</code> applies to every destination address.</p>\n\n<p>Walled garden <code class=\"highlighter-rouge\">/ip hotspot walled-garden</code> can be used to allow deny specific\nhost in http and https requests.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/ip hotspot walled-garden\nadd dst-host=:^www.example.com path=\":/test\\$\"\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">/ip hotspot walled-garden ip</code> can be used to allow deny specific host and IP\nrequests</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/ip hotspot walled-garden ip\nadd action=accept disabled=no dst-host=www.paypalobject.com\n\n# allow google dns and specific site\nadd action=accept disabled=no dst-address=8.8.8.8\nadd action=accept disabled=no dst-address=IpOfMySERVER\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">dst-address</code> can be a <a href=\"https://wiki.mikrotik.com/wiki/Manual:IP/Firewall/Address_list\">Destination IP address\nlist</a> so you can\ngroup them…</p>\n\n<p><a href=\"https://wiki.mikrotik.com/wiki/Manual:Hotspot_HTTPS_example\">https://wiki.mikrotik.com/wiki/Manual:Hotspot_HTTPS_example</a>\nHTTPS can not be redirected since it starts in the browser and it creates a\nsocket destionation_ip:443/TCP and mikrotik intercepts that and can not provide\nvalid certificate for this url, so hotspot can’t redirect https to login page.\nMikrotik can use certificate and redirect all https requests that are not on\nHSTS list.</p>\n\n<p>https://mikrotik.com/documentation/manual_2.6/IP/Hotspot.html\nYou can have two address pools (one for authenticated and one for non auth\nusers) and ARP feature could be set to <code class=\"highlighter-rouge\">reply-only</code> to prevent network access\nusing static IP addresses.</p>\n\n<h1 id=\"connect-to-mikrotik\">Connect to Mikrotik</h1>\n\n<p>You can FTP to Mikrotik <code class=\"highlighter-rouge\">ftp 192.168.5.1</code> (username <code class=\"highlighter-rouge\">admin</code> and blank password).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ssh-keygen -t dsa\nftp 192.168.5.1\n# username: admin\n# password: blank\n&gt; ls\n&gt; mkdir backups\n&gt; cd backups\n&gt; cd ..\n&gt; put local_file_name\n&gt; get remote_file_name\n&gt; exit\n</code></pre></div></div>\n\n<p>Or in one line you can use <code class=\"highlighter-rouge\">lftp</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>lftp -u admin, -e \"cd hotspot;put doc/mikrotik/login.html;exit\" 192.168.5.1\n</code></pre></div></div>\n\n<p>Also you can SSH\nhttps://wiki.mikrotik.com/wiki/Use_SSH_to_execute_commands_(DSA_key_login)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># using winbox create new user under System -&gt; Users: admin-ssh (password can be blank)\n# https://askubuntu.com/a/885396/40031\n/ip ssh set always-allow-password-login=yes\n</code></pre></div></div>\n\n<p>From your machine you can:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ssh -o HostKeyAlgorithms=+ssh-dss -o KexAlgorithms=diffie-hellman-group14-sha1 -l admin-ssh -i id 192.168.5.1\n\n# or put in ~/.ssh/config\nHost 192.168.5.1\n  HostKeyAlgorithms ssh-dss\n  KexAlgorithms diffie-hellman-group1-sha1\n\n# so you can simply\nssh admin-ssh@192.168.5.1\n</code></pre></div></div>\n\n<p>Reset router with ssh</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/system reset-configuration no-defaults=yes keep-users=yes run-after-reset=flash/wan.rsc\n</code></pre></div></div>\n\n<p>One short beep is that reseting started, normal beep is that actual reset\noccured, and two beeps are ready.</p>\n\n<p>Since there could be some initialization problems, you should add delay in rsc\nfiles. To iterate command until it success you can try this script</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># this succeed since we do not use network\n/ip pool\nadd name=dhcp-pool-my-comp ranges=192.168.5.10-192.168.5.254\n\n:local repeat true\n:local counter 0\n:while ($repeat) do={\n  :do {\n    # this raise error on boot, so repeat untill succeed\n    /ip dhcp-server\n    add address-pool=dhcp-pool-my-comp disabled=no interface=ether2 name=\\\n    dhcp-my-comp\n    :set repeat false\n  } on-error= {\n    :delay 1\n    :set counter ($counter + 1);\n    :log warning \"delay $counter\"\n    :if ($counter=50) do={ :set repeat false }\n  }\n}\n</code></pre></div></div>\n\n<h1 id=\"my-hotspot-testing\">My hotspot testing</h1>\n\n<p>I have two ethernet cards: eth0 (Atheros, bottom port) and eth1 (Intel, upper\nport). I connected my <code class=\"highlighter-rouge\">eth0</code> to <code class=\"highlighter-rouge\">ether2</code> and later <code class=\"highlighter-rouge\">eth1</code> to <code class=\"highlighter-rouge\">ether3</code>.\nFirst port <code class=\"highlighter-rouge\">ether1</code> on Mikrotik is used like WAN and connected to my ADSL router\n<a href=\"https://forum.mikrotik.com/viewtopic.php?t=60313#p308124\">https://forum.mikrotik.com/viewtopic.php?t=60313#p308124</a>\nSecond mikrotik port <code class=\"highlighter-rouge\">ether2</code> is my computer connection.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/ip address\n# my wan is 192.168.2.1\nadd address=192.168.2.9/24 interface=ether1\n# my comp is on 192.168.5.*\nadd address=192.168.5.1/24 interface=ether2\n\n/ip pool\nadd name=dhcp-pool5 ranges=192.168.5.10-192.168.5.254\n/ip dhcp-server\nadd address-pool=dhcp-pool5 disabled=no interface=ether2 name=dhcp5\n/ip dhcp-server network\nadd address=192.168.5.0/24 dns-server=192.168.5.1 gateway=192.168.5.1\n\n/ip dns\nset allow-remote-requests=yes servers=8.8.8.8\n/ip route\nadd distance=1 gateway=192.168.2.1\n\n# IMPORTANT to masquerade if you are behind other routers\n/ip firewall nat\nadd action=masquerade chain=srcnat out-interface=ether1\n</code></pre></div></div>\n\n<p>Third mikrotik port <code class=\"highlighter-rouge\">ether3</code> is connected to my <code class=\"highlighter-rouge\">eth1</code> ethernet and bridged to\nVirtual Box.\nMikrotik is using Radius server PUBLIC_RADIUS_IP but inside VPN with\nVPN_USERNAME and VPN_PASSWORD (so use PRIVATE_RADIUS_IP) on the mikrotik hosted\nin the cloud MIKROTIK_IN_THE_CLOUD_IP. There could be also\nPUBLIC_RADIUS_BACKUP_IP, and PRIVATE_RADIUS_BACKUP_IP. RADIUS_SECRET is needed\nfor communication.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:global PUBLIC_RADIUS_IP ....\n:global PRIVATE_RADIUS_IP ....\n:global PUBLIC_RADIUS_BACKUP_IP ....\n:global PRIVATE_RADIUS_BACKUP_IP ....\n:global VPN_USERNAME ....\n:global VPN_PASSWORD ....\n:global MIKROTIK_IN_THE_CLOUD_IP ....\n\n# Interfaces -&gt; + -&gt; PPTP client -&gt; Dial Out\n# Connect To: MIKROTIK_IN_THE_CLOUD_IP, User: VPN_USERNAME, Password:\n# VPN_PASSWORD, uncheck pap and chap, check mschap1 mschap2\n/interface pptp-client\nadd allow=mschap1,mschap2 connect-to=$MIKROTIK_IN_THE_CLOUD_IP disabled=no \\\n  name=pptp-out1  password=$VPN_PASSWORD user=$VPN_USERNAME\n\n# since there could be only one pptp client connection for specific username,\n# check if connection established correctly\n\n# IP -&gt; Routes -&gt; +\n# Dst. Address: PRIVATE_RADIUS_IP_0/24 Gateway: pptp-out1\n# Dst. Address: PRIVATE_RADIUS_BACKUP_IP_0/24 Gateway: pptp-out1\n/ip route\nadd distance=1 dst-address=PRIVATE_RADIUS_IP_0/24 gateway=pptp-out1\nadd distance=1 dst-address=PRIVATE_RADIUS_BACKUP_IP_0/24 gateway=pptp-out1\n# maybe also vpn private network\n\n# IP -&gt; Firewall -&gt; NAT -&gt; +\n# Chain: srcnat, tab Action select masquerade\n/ip firewall nat\nadd action=masquerade chain=srcnat out-interface=pptp-out1\n</code></pre></div></div>\n\n<p>If you want to ping from comp to hotspot user, user need to be logged in.\nIf it is logged in user can ping router <code class=\"highlighter-rouge\">ping 10.5.50.1</code>, and other hotspot\nusers <code class=\"highlighter-rouge\">ping 10.5.50.6</code> and host comp <code class=\"highlighter-rouge\">ping 192.168.5.252</code>. Also from host you\ncan ping user.\nIf it not logged in, user can not ping router and host can not ping user.</p>\n\n<p>If <code class=\"highlighter-rouge\">/login</code> shows “Error 404: Not Found” that means you are connected with\nether2 and not ehter3 (hotspot)</p>\n\n<p>If not logged in it can be byepassed with <code class=\"highlighter-rouge\">/ip hotspot ip-binding add\naddress=10.5.50.5 type=bypassed</code>, but than it can not access login or status\npages <code class=\"highlighter-rouge\">http://10.5.50.1/login</code>.\nOr you can add Walled garden <code class=\"highlighter-rouge\">/ip hotspot walled-garden ip add\ndst-address=192.168.5.252 action=accept</code> and than it will be accessible in both\ndirections, from and to 192.168.5.252.\nhttps://forum.mikrotik.com/viewtopic.php?t=88317</p>\n\n<p>For Hotspot we allow ALLOW_SITE_IP and Google DNS\nIf www.google.com inside hotspot client does not work, it is because of DNS is\navailable but redirects to https, which is than redirected to login page, but\nsince we do not have proper certification, there is an error.\nTry to use some of google IP address to see if it will redirect to hotspot login\npage, or use <code class=\"highlighter-rouge\">http://yahoo.com</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:global ALLOW_SITE_IP = ....\n\n# IP -&gt; Hotspot -&gt; Hotspot setup\n# HotSpot interface = ether3, Local Address of Network = 10.5.50.1/24\n# check Masquerade Network, Address Pool of Network = 10.5.50.2-10.5.50.254,\n# Select Certificate = none, IP Address of SMTP server = 0.0.0.0\n# DNS Server = 8.8.8.8, DNS Name of local hotspot server = (empty)\n# Hotspot user Name: admin, password: (empty)\n/ip hotspot profile\nadd hotspot-address=10.5.50.1 login-by=cookie,http-pap name=hsprof1 \\\n    nas-port-type=ethernet use-radius=yes\n/ip pool\nadd name=hs-pool-3 ranges=10.5.50.2-10.5.50.254\n/ip dhcp-server\nadd address-pool=hs-pool-3 disabled=no interface=ether3 lease-time=1h name=dhcp1\n/ip hotspot\nadd address-pool=hs-pool-3 disabled=no interface=ether3 name=hotspot1 profile=hsprof1\n/ip address\nadd address=10.5.50.1/24 comment=\"hotspot network\" interface=ether3\n/ip dhcp-server network\nadd address=10.5.50.0/24 comment=\"hotspot network\" gateway=10.5.50.1\n/ip firewall filter\nadd action=passthrough chain=unused-hs-chain comment=\"place hotspot rules here\" disabled=yes\n/ip firewall nat\nadd action=passthrough chain=unused-hs-chain comment=\"place hotspot rules here\" disabled=yes\nadd action=masquerade chain=srcnat comment=\"masquerade hotspot network\" src-address=10.5.50.0/24\n/ip hotspot user\nadd name=admin\n\n# IP -&gt; Hotspot -&gt; Server Profiles -&gt; hsprof\n# -&gt; Login : check HTTP PAP, uncheck HTTP CHAP\n# -&gt; RADIUS : check Use RADIUS, NAS Port Type: ethernet\n# this properties: login-by, nas-port-type and use-radius already include above\n\n# IP -&gt; Hotspot -&gt; Walled Garden IP List -&gt; +\n# Dst. Address = 8.8.8.8\n# IP -&gt; Hotspot -&gt; Walled Garden IP List -&gt; +\n# Dst. Address = xceednet.com (or ip address for older RouterOS)\n/ip hotspot walled-garden\nadd comment=\"place hotspot rules here\" disabled=yes\n/ip hotspot walled-garden ip\nadd action=accept disabled=no dst-address=8.8.8.8\nadd action=accept disabled=no dst-address=$ALLOW_SITE_IP\n\n# Radius -&gt; +\n# check ppp, check hotspot, Address = PRIVATE_RADIUS_IP, Secret = RADIUS_SECRET,\n# Timeout = 5000ms\n# same for PRIVATE_RADIUS_BACKUP_IP\n/radius\nadd address=$PRIVATE_RADIUS_IP secret=secret service=ppp,hotspot timeout=5s\nadd address=$PRIVATE_RADIUS_BACKUP_IP secret=secret service=ppp,hotspot timeout=5s\n</code></pre></div></div>\n\n<h1 id=\"hotspot-templates-html-pages\">Hotspot templates Html pages</h1>\n\n<p>https://wiki.mikrotik.com/wiki/Manual:Customizing_Hotspot</p>\n\n<p>There are several pages that are rendered on mikrotik:</p>\n\n<ul>\n  <li>\n    <p><code class=\"highlighter-rouge\">redirect.html</code> immediatelly redirect with http status (also with meta but\nI think that is not used). When I remove first two lines that perform\nhttp-status and http-header</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$(if http-status == 302)Hotspot redirect$(endif)\n$(if http-header == \"Location\")$(link-redirect)$(endif)\n</code></pre></div>    </div>\n\n    <p>than it will use some other default template which redirects. If I\nchange <code class=\"highlighter-rouge\">$(link-redirect)</code> to google, it will redirect to google. So you can\nnot override this file to not perform redirect.</p>\n  </li>\n</ul>\n\n<p>GET <code class=\"highlighter-rouge\">/login</code></p>\n<ul>\n  <li>if user is not authenticated than renders <code class=\"highlighter-rouge\">login.html</code> to ask user for\nusername and password. Parameters on this url can be:\n    <ul>\n      <li><code class=\"highlighter-rouge\">username</code>, <code class=\"highlighter-rouge\">password</code> (plain for PAP or md5 hash of chap-id, password and\nchallenge  for CHAP)</li>\n      <li><code class=\"highlighter-rouge\">dst</code> original requested url before redirect</li>\n      <li><code class=\"highlighter-rouge\">popup</code> show status window on success login</li>\n      <li><code class=\"highlighter-rouge\">radius</code> some radius params\nPOST &amp; GET <code class=\"highlighter-rouge\">/login</code></li>\n    </ul>\n  </li>\n  <li>if user is successfully authenticated or already authenticated than it\nrenders <code class=\"highlighter-rouge\">alogin.html</code> page. It redirects in javascript or meta to\nlink-redirect (it is external page or http://10.5.50.1/status)</li>\n  <li>if not successfull auth (wrong password or username) it renders <code class=\"highlighter-rouge\">flogin.html</code>\nif exists or redirect with http status 302 to login</li>\n</ul>\n\n<p>GET <code class=\"highlighter-rouge\">/status</code></p>\n<ul>\n  <li>if auth user than render <code class=\"highlighter-rouge\">status.html</code> show status with logout form that\nsubmit to <code class=\"highlighter-rouge\">/logout</code> Form can have <code class=\"highlighter-rouge\">erase-cookie</code> to erase cookie so user need\nto insert username/password again even cookie login is enabled</li>\n  <li>if not auth user and if <code class=\"highlighter-rouge\">fstatus.html</code> exists than use that template,\notherwise use <code class=\"highlighter-rouge\">redirect.html</code> to redirect to <code class=\"highlighter-rouge\">/login</code></li>\n</ul>\n\n<p>GET <code class=\"highlighter-rouge\">/logout</code></p>\n<ul>\n  <li>if auth user it will log out and render <code class=\"highlighter-rouge\">logout.html</code> and provide a link to\n <code class=\"highlighter-rouge\">/login</code> (refresh will not work since user is deauthenticated)</li>\n  <li>\n    <p>if not auth user than redirect 302 to <code class=\"highlighter-rouge\">/login</code> or use <code class=\"highlighter-rouge\">flogout.html</code> if exists</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">error.html</code> show fatal errors</li>\n</ul>\n\n<p>GET external page</p>\n<ul>\n  <li>if user is not auth it renders <code class=\"highlighter-rouge\">rlogin.html</code> if exists or redirect 302 to\n<code class=\"highlighter-rouge\">/login?dst=target_page</code>. It can be used for external login</li>\n</ul>\n\n<p>GET “/”on hotspot</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">rstatus.html</code> root on hotspot host for auth user,</li>\n  <li><code class=\"highlighter-rouge\">radvert.html</code> when advertisement is due to be displayed,</li>\n</ul>\n\n<p>You can have different pages for different <code class=\"highlighter-rouge\">/ip hotspot profile print where\nhtml-directory=hotspot</code>. You can create subfolder for translation (<code class=\"highlighter-rouge\">lv</code>) and use\nparametar <code class=\"highlighter-rouge\">target=lv</code>. Other links will stay in that subfolder.</p>\n\n<p>Links variables which can be used like <code class=\"highlighter-rouge\">$(varName)</code>:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">link-login</code> link to login page including original URL requested\nhttp://10.5.50.1/login?dst=http://www.example.com/</li>\n  <li><code class=\"highlighter-rouge\">link-login-only</code> link to login page, not including original URL requested\nhttp://10.5.50.1/login</li>\n  <li><code class=\"highlighter-rouge\">link-orig</code> original url requested http://yahoo.com</li>\n  <li><code class=\"highlighter-rouge\">link-logout</code> link to logout http://10.5.50.1/logout</li>\n  <li><code class=\"highlighter-rouge\">link-status</code> link to status</li>\n</ul>\n\n<p>General variables:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">logged-in</code> “yes” is user is logged in, otherwise “no”</li>\n  <li><code class=\"highlighter-rouge\">mac</code> MAC of the user</li>\n  <li><code class=\"highlighter-rouge\">username</code> name of the user</li>\n  <li><code class=\"highlighter-rouge\">error</code> error message</li>\n  <li><code class=\"highlighter-rouge\">hostname</code> DNS or IP address of hostspot servlet</li>\n  <li><code class=\"highlighter-rouge\">server-address</code> hostspot server address with port</li>\n  <li><code class=\"highlighter-rouge\">ssl-login</code> “yes” if https methods was used to access this page</li>\n  <li><code class=\"highlighter-rouge\">interface-name</code> bridge or interface name</li>\n  <li><code class=\"highlighter-rouge\">ip</code> ip address of the client</li>\n  <li><code class=\"highlighter-rouge\">host-ip</code> client ip address from <code class=\"highlighter-rouge\">/ip hotspot host</code></li>\n</ul>\n\n<p>Inside templates <code class=\"highlighter-rouge\">$(if varName) ... $(elif varName) ... $(else) ... $(endif)</code>\nor <code class=\"highlighter-rouge\">$(if logged-in = 'yes')</code> can be used for conditionals.</p>\n\n<p>You can POST to <code class=\"highlighter-rouge\">/login.html</code> with username and password, and user will be\nauthenticated and redirected. You can also GET and user will be authenticated\nbut <code class=\"highlighter-rouge\">/status.html</code> will be shown.\nIt’s better to use POST with https.</p>\n\n<p>If hotspot user after logout, goes to status page, if will be logged in again,\nbecause of cookie. You need to erase cookie if you want user to type password\nagain.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;input type=\"hidden\" name=\"erase-cookie\" value=\"on\"&gt;\n</code></pre></div></div>\n\n<p>or you can disable cookie login for hotspot profile <code class=\"highlighter-rouge\">/ip hotspot profile set\ndefault login-by=http-chap</code></p>\n\n<p>External login <a href=\"https://wiki.mikrotik.com/wiki/HotSpot_external_login_page\">https://wiki.mikrotik.com/wiki/HotSpot_external_login_page</a></p>\n\n<p>Note that form url should point to <code class=\"highlighter-rouge\">/login</code> path</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>no\n</code></pre></div></div>\n\n<h2 id=\"firewall\">Firewall</h2>\n\n<p>https://wiki.mikrotik.com/wiki/Manual:IP/Firewall\nobsolete https://mikrotik.com/testdocs/ros/3.0/</p>\n\n<p><code class=\"highlighter-rouge\">chain</code> is name of rule group. Rulles are taken from the chain in the order they\nare listed and if packet matches the criteria than action is perfomed and no\nmore rules are processed in that chain (except for <code class=\"highlighter-rouge\">passthrough</code> action), if a\npacket has not matched any rule whith the chain then it is accepted.</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">input</code> for connections to the router (destination is one of the router’s\n  addresses)</li>\n  <li><code class=\"highlighter-rouge\">forward</code> for connection going through router</li>\n  <li><code class=\"highlighter-rouge\">output</code> for connections from the router (originated the the router)</li>\n  <li><code class=\"highlighter-rouge\">my_name</code> for example <code class=\"highlighter-rouge\">hotspot</code> for hotspot connections</li>\n</ul>\n\n<p><code class=\"highlighter-rouge\">action</code> could be:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">accept</code> to allow packet to pass through and no more rules are applied</li>\n  <li><code class=\"highlighter-rouge\">redirect</code> replaces destionation port to <code class=\"highlighter-rouge\">to-ports=64872</code> and destination\n  address <code class=\"highlighter-rouge\">to-addresses</code> to one of the routers local address.</li>\n  <li><code class=\"highlighter-rouge\">jump</code> with <code class=\"highlighter-rouge\">jump-target=chain-name</code> jumps to the chain which can <code class=\"highlighter-rouge\">return</code>\n  usually with defined <code class=\"highlighter-rouge\">hotspot</code> for example: <code class=\"highlighter-rouge\">hotspot=from-client,!auth</code>, <code class=\"highlighter-rouge\">to-client,auth</code>, <code class=\"highlighter-rouge\">local-dst</code></li>\n  <li><code class=\"highlighter-rouge\">return</code> jump back to the chain where the jump took place.</li>\n  <li><code class=\"highlighter-rouge\">drop</code> drop this packet without sending ICMP reject message</li>\n  <li><code class=\"highlighter-rouge\">reject</code> with <code class=\"highlighter-rouge\">reject-with=tcp-reset</code> or <code class=\"highlighter-rouge\">reject-with=icmp-net-prohibited</code></li>\n  <li><code class=\"highlighter-rouge\">passthrough</code> continue rules on this chain (ignore current rule)</li>\n  <li><code class=\"highlighter-rouge\">log</code> add message to system log, same as when you check “Log” for other\n  actions</li>\n  <li><code class=\"highlighter-rouge\">add-dst-to-address-list</code>, <code class=\"highlighter-rouge\">add-src-to-address-list</code> add address to my-list\n  <code class=\"highlighter-rouge\">address-list=my-list</code></li>\n  <li><code class=\"highlighter-rouge\">src-nat</code> replaces <code class=\"highlighter-rouge\">src-address</code> with <code class=\"highlighter-rouge\">to-addresses</code> and <code class=\"highlighter-rouge\">to-ports</code></li>\n  <li><code class=\"highlighter-rouge\">dst-nat</code> replaces <code class=\"highlighter-rouge\">dst-address</code> with <code class=\"highlighter-rouge\">to-addresses</code> and <code class=\"highlighter-rouge\">to-ports</code></li>\n</ul>\n\n<p><code class=\"highlighter-rouge\">dst-address</code> ip address range ip/mask or ip-ip.\n<code class=\"highlighter-rouge\">dst-port</code> destination port\n<code class=\"highlighter-rouge\">dst-address-list</code> list\n<code class=\"highlighter-rouge\">protocol</code>: <code class=\"highlighter-rouge\">tcp</code></p>\n\n<p><code class=\"highlighter-rouge\">hotspot</code> multiple choice: <code class=\"highlighter-rouge\">auth,from client,to client,http,local dst</code>. There\nare dynamic rules that <code class=\"highlighter-rouge\">jump</code> to another chain:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">hs-unauth</code> for chain: <code class=\"highlighter-rouge\">forward</code> and hotspot: <code class=\"highlighter-rouge\">from client,!auth</code></li>\n  <li><code class=\"highlighter-rouge\">hs-unauth-to</code> for chain: <code class=\"highlighter-rouge\">forward</code> and hotspot: <code class=\"highlighter-rouge\">!auth,to client</code></li>\n  <li><code class=\"highlighter-rouge\">hs-input</code> for chain: <code class=\"highlighter-rouge\">input</code> and hotspot: <code class=\"highlighter-rouge\">from client</code>. which jumps to\n  <code class=\"highlighter-rouge\">pre-hs-input</code>\nand at the end there is <code class=\"highlighter-rouge\">reject</code> for <code class=\"highlighter-rouge\">hs-unauth</code>, <code class=\"highlighter-rouge\">hs-unauth-to</code>. If you want to\nallow some trafic to (and from) add action <code class=\"highlighter-rouge\">return</code> so it does not reach those\n<code class=\"highlighter-rouge\">reject</code> rules. You need to add twice for both incoming and outgoing packets.</li>\n</ul>\n\n<p>You need to check both tables: Firewall Rules and NAT.\nFor Hotspot in NAT firewall table there are <code class=\"highlighter-rouge\">redirect</code> to port 64872-64875.\nhttps://wiki.mikrotik.com/wiki/Manual:Customizing_Hotspot#Firewall_customizations</p>\n<ul>\n  <li>64872 port provides DNS service for Hotspot users\n  <code class=\"highlighter-rouge\">5 chain=hotspot action=redirect to-ports=64872 dst-port=53 protocol=tcp</code></li>\n  <li>64873 port is hotspot http servlet port (when user access router IP)\n  <code class=\"highlighter-rouge\">6 chain=hotspot action=redirect to-ports=64873 hotspot=local-dst dst-port=80\n  protocol=tcp</code></li>\n  <li>64874 port is Walled Garden proxy server\n  <code class=\"highlighter-rouge\">12 D chain=hs-unauth action=redirect to-ports=64874 dst-port=80 protocol=tcp</code></li>\n  <li>64875 port is hotspot https servlet port\n  <code class=\"highlighter-rouge\">8 D chain=hotspot action=redirect to-ports=64875 hotspot=local-dst\n  dst-port=443 protocol=tcp</code></li>\n</ul>\n\n<p>Redirection in NAT should be done in <code class=\"highlighter-rouge\">dstnat</code> chain with <code class=\"highlighter-rouge\">dst-nat</code> action, which\ncan accept <code class=\"highlighter-rouge\">address-to=</code></p>\n\n<h2 id=\"ip-proxy\">IP Proxy</h2>\n\n<p>Proxy can be used for increasing web speed or for firewall, when we redirect\nusers to the proxy and show them local page.\nhttps://wiki.mikrotik.com/wiki/Manual:IP/Proxy#Proxy_based_firewall_.E2.80.93_Access_List\nFor example when Radius assign user some ip UNAUTHORIZED_IP we can redirect all\ntrafic from that UNAUTHORIZED_IP to our hotspot page <code class=\"highlighter-rouge\">unauthorized.html</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># assign address to interface\n/ip address\nadd address=UNAUTHORIZED_IP_with_0_1/16 interface=ether3\n\n# redirect all requests to 8080\n/ip firewall nat\nadd action=redirect chain=dstnat protocol=tcp \\\nsrc-address=UNAUTHORIZED_IP_with_0_1/16 to-ports=8080\n\n# enable ip proxy\n/ip proxy\nset enabled=yes\n\n# redirect path\n/ip proxy access\nprint detail\n# you can redirect specific sites like facebook\nadd action=deny dst-host=www.facebook.com redirect-to=10.5.50.1/unauthorized.html\n# you can allow specific sites\nadd action=allow dst-host=*.trk.in.rs\n</code></pre></div></div>\n\n<h2 id=\"https-and-redirect\">HTTPS and redirect</h2>\n\n<p>https://wiki.mikrotik.com/wiki/Manual:Hotspot_HTTPS_example\nHttps use secure connection (SSL/TLS handshake) with a server so request to\nhttps://www.google.com which is redirected at firewall level will not work with\nyour server/proxy/router.\nOnly think that user can do is to add Exception to install your certificate and\nuse transparent web proxy.</p>\n\n<p>Even it is not possible to redirect https without warning, modern browsers\n(firefox 58) will show login button (link to 10.5.50.1/login) for hsts and non\nhsts site, so users can continue with login.</p>\n\n<blockquote>\n  <p>Log in to network</p>\n</blockquote>\n\n<blockquote>\n  <p>You must log in to this network before you can access the Internet.</p>\n</blockquote>\n\n<blockquote>\n  <p>This site uses HTTP Strict Transport Security (HSTS) to specify that Firefox\nmay only connect to it securely. As a result, it is not possible to add an\nexception for this certificate.</p>\n</blockquote>\n\n<p><img src=\"/assets/posts/https%20redirect%20for%20non%20hsts%20site.png\" alt=\"https redirect non hsts site\" />\n<img src=\"/assets/posts/https%20redirect%20for%20hsts%20site.png\" alt=\"https redirect hsts site\" /></p>\n\n<p>Lets encrypt can be used to generate certs.\nhttps://www.ollegustafsson.com/en/letsencrypt-routeros/</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># get acme\ncurl https://get.acme.sh | sh\n# issue a cert\nacme.sh --issue --dns -d router.mydomain.com\n# check if record exists\nhost -t txt _acme-challenge.router.trk.in.rs\n# renew when txt record is available\nacme.sh --renew -d router.mydomain.com\n\n</code></pre></div></div>\n\n<p>https://github.com/gitpel/letsencrypt-routeros\nhttps://github.com/Neilpang/acme.sh/pull/706/files</p>\n\n<p>NAT\nhttps://mikrotik.com/testdocs/ros/3.0/qos/filter.php\nNat is used to rewrite source (destination) ip address for source (and\ndestination) NATted network. <code class=\"highlighter-rouge\">masquerade</code> is a form of source NAT where\n<code class=\"highlighter-rouge\">to-addresses</code> is not needed to be specified, outgoing interface is used.\n<code class=\"highlighter-rouge\">redirect</code> is a form of destination NAT where <code class=\"highlighter-rouge\">to-addresses</code> is not used,\nincoming interface is used.</p>\n\n<p>For easier manipulation you can create lists</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/ip firewall address-list\nadd list=my_site.com address=my_site.com\n# at this moment, mikrotik will fetch ip from dns and save to address list\n</code></pre></div></div>\n\n<p>Mangle mark routing\nhttps://www.youtube.com/watch?v=q13z9_dmmyA</p>\n\n<p>Microtik youtube tutorials\nhttps://www.youtube.com/user/rodrick4u/playlists</p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>\n    <p>resolve hostname and update record\n https://wiki.mikrotik.com/wiki/Manual:Scripting-examples#Resolve_host-name</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:resolve www.google.com\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>user scripts https://wiki.mikrotik.com/wiki/Scripts</p>\n  </li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Hanami",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/01/26/hanami/",
      "date"     : "2018-01-26 00:00:00 +0100",
      "content"  : "<h1 id=\"hanami\">Hanami</h1>\n\n<h1 id=\"monads\">Monads</h1>\n\n<p><a href=\"http://dry-rb.org/gems/dry-monads/\">http://dry-rb.org/gems/dry-monads/</a></p>\n"
    } ,
  
    {
      "title"    : "Minitests Rails",
      "category" : "",
      "tags"     : "",
      "url"      : "/2018/01/22/minitests-rails/",
      "date"     : "2018-01-22 00:00:00 +0100",
      "content"  : "<h1 id=\"minitest\">Minitest</h1>\n\n<p>Minitest real test examples: openstreetmap, redmine</p>\n\n<p>Mini test for rails <code class=\"highlighter-rouge\">TestCase</code>s (like <code class=\"highlighter-rouge\">ActiveSupport::TestCase</code>) inherits from\n<code class=\"highlighter-rouge\">Minitest::Test</code> so you can use it <code class=\"highlighter-rouge\">def test_method</code>, but Rails adds <code class=\"highlighter-rouge\">test</code>\nmethod so it can be used like <code class=\"highlighter-rouge\">test \"my method\" do</code>.  In minitests you can not\nhave same test descriptions since it will be converted to same\n<code class=\"highlighter-rouge\">test_my_method</code>.</p>\n\n<p>You can run specific test use <code class=\"highlighter-rouge\">:line</code> or <code class=\"highlighter-rouge\">-n test_name</code>.\nThis also works for system test (so you do not need <code class=\"highlighter-rouge\">system</code> in <code class=\"highlighter-rouge\">rails\ntest:system somefile</code>)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails test\nrails test:system\n# invoke test by line\nrails test test/models/article_test.rb:6\n# or name\nrails test -n test_example\n</code></pre></div></div>\n\n<p>You could also use ENV variables <code class=\"highlighter-rouge\">rails test\nTEST=test/machine_with_callbacks_test.rb\nTESTOPTS=\"--name=test_should_run_validations_for_specific_state -v\"</code></p>\n\n<p>Each test run will load all fixture data, run setup blocks, run test method, run\nteardown block, rollback fixtures.</p>\n\n<h1 id=\"fixtures\">Fixtures</h1>\n\n<p>http://api.rubyonrails.org/v5.2.0/classes/ActiveRecord/FixtureSet.html</p>\n\n<p>Rails performs loading fixtures in tree steps: removing old fixture data, load\nfixture data and dump data into a method inside test case <code class=\"highlighter-rouge\">users(:david)</code></p>\n\n<p>Defining fixtures:</p>\n<ul>\n  <li>use labels for associated belongs_to and has_many items (separated by comma)\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/fixtures/users.yml\nmy_user:\n  name: My User\n  company: my_company\n\n# test/fixtures/companies.yml\nmy_company:\n  name: My Company\n</code></pre></div>    </div>\n  </li>\n  <li>if you have polymorphic than put class name in brackets\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/fixtures/notifications.yml\nnotification_for_task:\n  notifiable: my_task (Task)\nnotification_for_comment:\n  notifiable: my_comment (Comment)\n</code></pre></div>    </div>\n\n    <p>No need to use brackets if you have <code class=\"highlighter-rouge\">belongs_to :associated, class_name:\n'Activity'</code></p>\n  </li>\n  <li><code class=\"highlighter-rouge\">created_at</code>, <code class=\"highlighter-rouge\">updated_at</code>, <code class=\"highlighter-rouge\">created_on</code> and <code class=\"highlighter-rouge\">updated_on</code> is automatically\nTime.now</li>\n  <li>use ERB for dynamic creation. Note that you should use fixed dates instead of\n<code class=\"highlighter-rouge\">published_at: &lt;%= Date.today.strftime('%Y-%m-%d')</code> so they are stable.\nNote that erb is evaluated before yml (for example <code class=\"highlighter-rouge\">$LABEL</code>)\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;% 15.times do |i| %&gt;\nmedium_&lt;%= i %&gt;:\n  media_name: My &lt;%= i %&gt; Medium\n  published_at: 2018-10-11\n&lt;% end %&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>fixture label interpolation (<code class=\"highlighter-rouge\">$LABEL</code> is <code class=\"highlighter-rouge\">me</code>)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>me:\n  name: 'duke'\n  subdomain: me\n  # or use label\n  subdomain: $LABEL\n  email: $LABEL@email.com\n</code></pre></div>    </div>\n\n    <p>$Label is not interpolated within object like <code class=\"highlighter-rouge\">name: { en: $LABEL }</code> (so I18n\nmobility does not work)</p>\n  </li>\n  <li>defaults\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>DEFAULTS: &amp;DEFAULTS\n  name: $LABEL Name\n  created_on: &lt;%= 3.weeks.ago.to_s(:db) %&gt;\n\nfirst:\n  name: Smurf\n  &lt;&lt;: *DEFAULTS\n\nsecond:\n  name: Fraggle\n  &lt;&lt;: *DEFAULTS\n</code></pre></div>    </div>\n  </li>\n  <li>if you really want hardcoded ids you can use\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>my_language:\n  id: 5\n  name: English\n\ncourse:\n  language_id: 5\n  # note that this is just yml so you can not use\n  language_id: my_language.id\n  # but you can use erb\n  language_id: &lt;%= ActiveRecord::FixtureSet.identify :my_language %&gt;\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">pre_loaded_fixtures</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">use_transactional_tests</code>. In Rails 4 it was\n<code class=\"highlighter-rouge\">use_transactional_fixtures</code> but since it could be factories not fixtures,\nthat is renamed to <code class=\"highlighter-rouge\">use_transactional_tests</code>. So to disable it you can use</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class FooTest &lt; ActiveSupport::TestCase\n  self.use_transactional_tests = false\nend\n</code></pre></div>    </div>\n  </li>\n  <li>when defining new fixtures, add them to the end, so you do not break current\ntest for first page (when you use pagination)</li>\n  <li>load fixtures in development <code class=\"highlighter-rouge\">rake db:fixtures:load</code> (put in your seed</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># db/seed.rb\nRake::Task['db:fixtures:load'].invoke\n# https://github.com/rails/rails/blob/master/activerecord/lib/active_record/fixtures.rb\nalready_proccessed = []\nDir.entries(\"#{Rails.root}/test/fixtures\").each do |file_name|\n  next unless file_name[-4..-1] == '.yml'\n\n  # foreach will read line by line\n  File.foreach(\"#{Rails.root}/test/fixtures/#{file_name}\").grep /LABEL/ do |line|\n    column = line.match(/(\\w*):.*\\$LABEL/)[1]\n    klass = file_name[0..-5].singularize.camelize\n    next if already_proccessed.include? \"#{klass}-#{column}\"\n\n    puts \"klass=#{klass} column=#{column}\"\n    klass.constantize.find_each do |item|\n      item.send \"#{column}=\", item.send(column).tr('_', ' ')\n      item.save # email can not be saved with spaces\n    end\n    already_proccessed.append \"#{klass}-#{column}\"\n  end\nend\nputs 'db:seed and db:fixtures:load completed'\n</code></pre></div></div>\n<ul>\n  <li>to set devise password, you can add encrypted password on specific items\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>admin_user:\n  encrypted_password: &lt;%= User.new.send(:password_digest, 'password') %&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>if there are no colomns you can use <code class=\"highlighter-rouge\">user: {}</code> curly brackets</li>\n  <li>\n    <p>Usage of fixtures</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># note that we are calling method users()\nusers(:my_user)\n# we can get two\nusers(:duke, mike)\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"minitest-classes\">Minitest classes</h1>\n\n<p>To see all 6 base test clases go\n<a href=\"http://guides.rubyonrails.org/testing.html#a-brief-note-about-test-cases\">http://guides.rubyonrails.org/testing.html#a-brief-note-about-test-cases</a>\nActiveSupport::TestCase\nActionMailer::TestCase\nActionView::TestCase\nActionDispatch::IntegrationTest\nActiveJob::TestCase\nActionDispatch::SystemTestCase</p>\n\n<h1 id=\"minitest-model\">Minitest model</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'test_helper'\n\nclass TaskTest &lt; ActiveSupport::TestCase\n  test 'a completed' do\n    task = Task.new\n    refute(task.complete?)\n    task.mark_completed\n    assert(task.complete?)\n  end\n\n  def test_that_is_skipped\n    skip \"later\"\n  end\n\n  test 'valid fixture' do\n    assert_valid_fixture activities\n  end\n\n  # test/test_helper.rb\n  def assert_valid_fixture(items)\n    assert items.map(&amp;:valid?).all?, (items.reject(&amp;:valid?).map { |c| (c.respond_to?(:name) ? \"#{c.name} \" : '') + c.errors.full_messages.to_sentence })\n  end\nend\n</code></pre></div></div>\n\n<p>Assertions\n<a href=\"http://docs.seattlerb.org/minitest/Minitest/Assertions.html\">all</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">assert true</code> or <code class=\"highlighter-rouge\">assert_block do end</code></li>\n  <li><code class=\"highlighter-rouge\">assert_nil</code></li>\n  <li><code class=\"highlighter-rouge\">assert_empty</code></li>\n  <li><code class=\"highlighter-rouge\">assert_raises(NameError) do end</code></li>\n  <li><code class=\"highlighter-rouge\">assert_match regex, actual_string</code></li>\n  <li><code class=\"highlighter-rouge\">assert_includes(collection, object)</code></li>\n  <li><code class=\"highlighter-rouge\">assert_equal(expected, actual)</code></li>\n</ul>\n\n<p>They all have oposite <code class=\"highlighter-rouge\">refute_</code> methods, or <code class=\"highlighter-rouge\">assert_not</code>\nThey all accept additional string param that will be error message.</p>\n\n<p><a href=\"http://guides.rubyonrails.org/testing.html#rails-specific-assertions\">http://guides.rubyonrails.org/testing.html#rails-specific-assertions</a>\nRails also defines <code class=\"highlighter-rouge\">assert_difference</code>, <code class=\"highlighter-rouge\">assert_blank</code>, <code class=\"highlighter-rouge\">assert_presence</code>,\n<code class=\"highlighter-rouge\">assert_response</code>, <code class=\"highlighter-rouge\">assert_redirected_to</code>, <code class=\"highlighter-rouge\">assert_select</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    assert_difference \"User.count\", 1 do\n    end\n</code></pre></div></div>\n\n<p>You can create your own assertiongs (assert sorted)\nReopen <code class=\"highlighter-rouge\">module MiniTest::Assertions</code> when helper is used in all tests. If you\nneed only for system tests (assert_selector) or integration test (assert select)\nthan you need to reopen that particular class\nhttps://github.com/duleorlovic/premesti.se/blob/master/test/support/assert_equal_when_sorted_by_id.rb</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/application_system_test_case.rb\nrequire 'test_helper'\n\nclass ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase\n  def assert_alert_message(text)\n    assert_selector 'div#alert-debug', text: text, visible: false\n  end\n\n  def assert_notice_message(text)\n    assert_selector 'div#notice-debug', text: text, visible: false\n  end\nend\n</code></pre></div></div>\n\n<p>for integration tests</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/support/assert_flash_message.rb\nclass ActionDispatch::IntegrationTest\n  # assert_flash_message\n  def assert_alert_message(text)\n    assert_select 'div#alert-debug', text\n  end\n\n  def assert_notice_message(text)\n    assert_select 'div#notice-debug', text\n  end\n\n  def assert_select_field_error(text)\n    assert_select 'div.invalid-feedback', text\n  end\nend\n</code></pre></div></div>\n\n<p>For any method? you can assert for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>assert_kind_of Array, exp\n</code></pre></div></div>\n\n<h1 id=\"minitest-services\">Minitest services</h1>\n\n<p>Similar to model test you can create tests for services since there are PORO</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/services/credit_card_service_test.rb\n\nrequire 'test_helper'\n\nclass CreditCardServiceTest &lt; ActiveSupport::TestCase\n  test 'it creates charges' do\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"minitest-controllers\">Minitest controllers</h1>\n\n<p>Deprecated, use minitest integration tests</p>\n\n<h1 id=\"minitest-integration\">Minitest integration</h1>\n\n<p>For integration we use <code class=\"highlighter-rouge\">ActionDispatch::IntegrationTest</code> which gives methods:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">get '/'</code>, <code class=\"highlighter-rouge\">post path, params: {}</code> (params is required in rails_post_5),</li>\n  <li>also <code class=\"highlighter-rouge\">put</code>, <code class=\"highlighter-rouge\">patch</code>, <code class=\"highlighter-rouge\">head</code>, <code class=\"highlighter-rouge\">delete</code></li>\n  <li>for ajax use <code class=\"highlighter-rouge\">post path, xhr: true</code></li>\n  <li>add <code class=\"highlighter-rouge\">as: :json</code> as third param for json requests so you can use something like</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">assert_equal({ id: Article.last.id,\ntitle: \"Ahoy!\" }, response.parsed_body)</code>.</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">follow_redirect!</code></li>\n  <li><code class=\"highlighter-rouge\">assert_redirected_to post_url(Post.last)</code></li>\n  <li><code class=\"highlighter-rouge\">assert_response :success</code> (for http codes 200-299), <code class=\"highlighter-rouge\">:redirect</code> (300-399), <code class=\"highlighter-rouge\">:missing</code> (404), <code class=\"highlighter-rouge\">:error</code> (500-599).</li>\n  <li><code class=\"highlighter-rouge\">assert_select 'h1', user.email</code> . Note that white spaces and new lines are\nignored</li>\n  <li><code class=\"highlighter-rouge\">assert_difference \"User.count\", 1 do</code></li>\n  <li>You have access to <code class=\"highlighter-rouge\">@request</code>, <code class=\"highlighter-rouge\">@controller</code> and <code class=\"highlighter-rouge\">@response</code> object, but only\nafter you call <code class=\"highlighter-rouge\">get</code>, <code class=\"highlighter-rouge\">post</code>. You can set <code class=\"highlighter-rouge\">request.remote_ip</code> by passing\nheaders (note that http referrer is written as http referer (single r)\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>get sign_up_path, params: { user: { email: 'new@email.com' } }, headers: { 'REMOTE_ADDR': '123.123.123.123', HTTP_REFERER: 'http://domain.com' }\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">assert_select 'h1', 'Welcome'</code> is used to test view. View can be tested with\n<code class=\"highlighter-rouge\">assert_match /Welcome/', response.body</code>.\nThere are two forms of <em>assert_select selector, [equality], [message]</em> or\nusing Nokogiri::XML::Node as element <em>assert_select element, selector,\n[equality]</em>.\nselector can be CSS selector as one string, or array with substitutions\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>assert_select 'div#123' # exists &lt;div id='123'&gt;\nassert_select \"a[href='http://www.example.com/diary/new']\"\nassert_select 'a[href=?]', tasks_path\nassert_select 'input[value=?]', username   # substitute username\nassert_select 'input[value*=?]', username   # match when containing username\n\n# use custom pseudo class `:match(attribute_name, attribute_value)`\nassert_select \"ol&gt;li:match('id', ?)\", /item-\\d+/       # exists li id='item-1'\nassert_select \"div:match('id',?)\", /\\d+/        # exists div with non empty id\n\nassert_select 'div', 'Hello' # exists &lt;div&gt;Hello&lt;/div&gt;\nassert_select 'div', /hello/ # if div text matches\nassert_select 'div', false # no divs exists\nassert_select 'div', 4 # exactly 4 divs\nassert_select 'div', 4..5 # number of dives is in range\n</code></pre></div>    </div>\n\n    <p>To perform more than one quality tests in one assert you can use hash\n(assert_selector also use this hash param)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># instead of refute_select, for no div with my_name you can use\nassert_select 'a[href=?]', link, text: /my_name/, count: 0\nassert_select 'div', html: 'p', minimum: 2\n</code></pre></div>    </div>\n\n    <p>To check html in emails use assert_select_email</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>assert_select_email do\n  items = assert_select \"ol&gt;li\"\n  items.each do\n    Work with items here...\n  end\nend\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>Those integration tests are similar to Rspec request spec, and works full stack\nwith no use of capybara. More info\n  https://github.com/rails/rails-dom-testing/blob/master/lib/rails/dom/testing/assertions/selector_assertions.rb\nsimilar to capybara <code class=\"highlighter-rouge\">have_selector</code> but separate implementation <code class=\"highlighter-rouge\">html selector</code>.\n<a href=\"http://www.rubydoc.info/github/rails/rails-dom-testing/Rails%2FDom%2FTesting%2FAssertions%2FSelectorAssertions%3Aassert_select\">http://www.rubydoc.info/github/rails/rails-dom-testing/Rails%2FDom%2FTesting%2FAssertions%2FSelectorAssertions%3Aassert_select</a>\n  After request is made you can also access <code class=\"highlighter-rouge\">@controller</code>, <code class=\"highlighter-rouge\">@request</code> and\n  <code class=\"highlighter-rouge\">@response</code> (same as <code class=\"highlighter-rouge\">response</code>).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/controllers/projects_controller_test.rb\nrequire 'test_helper'\n\nclass ProjectsControllerTest &lt; ActionDispatch::IntegrationTest\n  setup do\n    @project = create :project\n  end\n\n  # called after every single test\n  teardown do\n    # when controller is using cache it may be a good idea to reset it afterwards\n    Rails.cache.clear\n  end\n\n  test 'show' do\n    get project_path(@project)\n    assert_select \"#tutorial-#{tutorials(:priced_course_first_free_tutorial).id}\", /Watch this lesson now/\n    assert_select \"#tutorial-#{tutorials(:priced_course_third_tutorial).id}\", text: /Watch this lesson now/, count: 0\n\n    # or you can parse `response.body` do it manually\n\n    doc = Nokogiri::HTML response.body\n    # you can get all text with doc.text.split.join(' ')\n    el = doc.search \"#tutorial-#{tutorials(:priced_course_first_free_tutorial).id}\"\n    assert_match 'Watch this lesson now', el.text\n    el = doc.search \"#tutorial-#{tutorials(:priced_course_third_tutorial).id}\"\n    assert_no_match 'Watch this lesson now', el.text\n  end\n\n  test \"the create method creates project\" do\n    post projects_url, params: { project: { name: 'Duke' } }\n    assert_redirected_to projects_path\n    # also available: assert_response :redirect\n    follow_redirect!\n    assert_select '#my-id', /dule/\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"minitest-routing\">Minitest routing</h2>\n\n<p>It uses <code class=\"highlighter-rouge\">assert_routing</code>.</p>\n\n<h2 id=\"minitest-helper\">Minitest helper</h2>\n\n<p>Uses <code class=\"highlighter-rouge\">assert_dom_equal</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/helpers/projects_helper_test.rb\nrequire 'test_helper'\nclass ProjectsHelperTest &lt; ActionView::TestCase\n  test \"project on schedule\" do\n    project = Project.new name: 'Duke'\n    project.stubs(:on_schedule?).returns(true)\n    actual= name_with_status(project)\n    expected = \"&lt;span class='on-schedule'&gt;Duke&lt;/span&gt;\"\n    assert_dom_equal expected, actual\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"minitest-system\">Minitest system</h2>\n\n<p>Feature tests are run in different process than rails so we need database\ncleaner gem. With system tests, we can use internal mechanism to roll back db\nchanges.\nBefore we used feature specs for full application integration testing, but now\nwe should use system specs (which also uses capybara and webdriver with chrome).</p>\n\n<p>System tests are not included in default test suite if you run <code class=\"highlighter-rouge\">rails test</code> (you\nshould run <code class=\"highlighter-rouge\">rake test:system</code>), but if you run specific test than it will be run\n<code class=\"highlighter-rouge\">rails test test/system/my_test.rb</code>.</p>\n\n<p>Note that if you use puma with multiple workers than\n<code class=\"highlighter-rouge\">ActionMailer::Base.deliveries.size</code> could be different in rails process and in\ntest process, so use <code class=\"highlighter-rouge\">workers 0</code> in <code class=\"highlighter-rouge\">config/puma/test.rb</code>.</p>\n\n<p>In system test you can’t mock OmniAuth.mock_auth so use integration test for\nthat.</p>\n\n<p>Capybara assertions\n<a href=\"http://www.rubydoc.info/gems/capybara/Capybara/Minitest/Assertions\">http://www.rubydoc.info/gems/capybara/Capybara/Minitest/Assertions</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">assert_text /dule/</code></li>\n  <li><code class=\"highlighter-rouge\">assert_selector 'a', text: 'duke'</code></li>\n  <li><code class=\"highlighter-rouge\">assert_equal admin_path, page.current_url</code></li>\n  <li><code class=\"highlighter-rouge\">page.accept_confirm</code> to confirm alert dialog box</li>\n</ul>\n\n<h2 id=\"webmock\">Webmock</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'webmock'\n\n# config/initializers/webmock.rb\nif Rails.env.test?\n  require 'webmock'\n  WebMock.disable_net_connect!(allow_localhost: true)\nend\n\n# test/test_helper.rb\nrequire 'webmock/minitest'\n</code></pre></div></div>\n\n<h2 id=\"minitest-helpers\">Minitest helpers</h2>\n\n<p>Add a line in <code class=\"highlighter-rouge\">test/test_helper.rb</code> to include files from <code class=\"highlighter-rouge\">test/a</code></p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/test_helper.rb\nENV['RAILS_ENV'] ||= 'test'\nrequire File.expand_path('../../config/environment', __FILE__)\nDir[Rails.root.join('test/a/**/*.rb')].each { |f| require f }\nrequire 'rails/test_help'\nrequire 'minitest/autorun'\nrequire 'webmock/minitest'\n\nclass ActiveSupport::TestCase\n  # create(:user) instead FactoryBot.create :user\n  include FactoryBot::Syntax::Methods\n  # stub_something\n  include WebmockHelper\n  # t('successfully') instead I18n.t('successfully')\n  include AbstractController::Translation\n  # devise method: sign_in user\n  include Devise::Test::IntegrationHelpers\n  # Setup all fixtures in test/fixtures/*.yml for all tests in alphabetical order.\n  fixtures :all\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/a/webmock_helper.rb\nmodule WebmockHelper\n  def stub_s3\n    stub_request(:get, /s3.amazonaws.com/).to_return(status: 200, body: 'text')\n    yield if block_given?\n  end\nend\n</code></pre></div></div>\n\n<p>I prefer to use factories on specific integration test so when I need to remove\nspecific fixtures I use rails <code class=\"highlighter-rouge\">Courses.delete_all</code>. I do not use database\ncleaner because it complicates thinks because I need to load some specific\nfixtures (like users) and remove other. Not sure if that will remove fixtures\nfor other tests\nhttps://stackoverflow.com/a/28539464/287166</p>\n\n<p>For pause</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/a/pause_helper.rb\nmodule PauseHelper\n  # you can use byebug, but it will stop rails so you can not navigate to other\n  # pages or make another requests in chrome while testing\n  def pause\n    $stderr.write('Press CTRL+j or ENTER to continue') &amp;&amp; $stdin.gets\n  end\nend\n\nclass ActionDispatch::SystemTestCase\n  include PauseHelper\nend\n</code></pre></div></div>\n\n<h2 id=\"minitest-mock\">Minitest Mock</h2>\n\n<p>You need to require autorun</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/test_helper.rb\nrequire 'minitest/autorun'\n</code></pre></div></div>\n\n<p>http://ruby-doc.org/stdlib-2.0.0/libdoc/minitest/rdoc/MiniTest/Mock.html</p>\n\n<p>You can mock return values:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@mock = Minitest::Mock.new\n@mock.expect(:meaning_of_life, 42)\n@mock.meaning_of_life # =&gt; 42\n</code></pre></div></div>\n\n<p>and also for arguments and verify their type or value</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@mock.expect(:do_something_with, true, [some_obj, true])\n@mock.do_something_with(some_obj, true) # =&gt; true\n\n@mock.expect(:uses_any_string, true, [String])\n@mock.uses_any_string(\"foo\") # =&gt; true\n@mock.verify  # =&gt; true\n\n@mock.expect(:uses_one_string, true, [\"foo\"]\n@mock.uses_one_string(\"bar\") # =&gt; true\n@mock.verify  # =&gt; raises MockExpectationError\n</code></pre></div></div>\n\n<p>You can use <code class=\"highlighter-rouge\">Object.stub</code> https://github.com/seattlerb/minitest#stubs\nhttps://github.com/seattlerb/minitest#mocks\nhttps://stackoverflow.com/questions/10990622/how-do-i-stub-a-method-to-raise-an-error-using-ruby-minitest</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">require</span> <span class=\"s2\">\"minitest/autorun\"</span>\n\n<span class=\"n\">class</span> <span class=\"n\">MyModel</span>\n  <span class=\"n\">def</span> <span class=\"n\">my_method</span><span class=\"p\">;</span> <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">class</span> <span class=\"n\">TestRaiseException</span> <span class=\"p\">&lt;</span> <span class=\"n\">MiniTest</span><span class=\"p\">::</span><span class=\"n\">Unit</span><span class=\"p\">::</span><span class=\"n\">TestCase</span>\n  <span class=\"n\">def</span> <span class=\"n\">test_raise_exception</span>\n    <span class=\"k\">model</span> <span class=\"p\">=</span> <span class=\"n\">MyModel</span><span class=\"p\">.</span><span class=\"n\">new</span>\n    <span class=\"n\">raises_exception</span> <span class=\"p\">=</span> <span class=\"n\">Proc</span><span class=\"p\">.</span><span class=\"n\">new</span> <span class=\"p\">{</span> <span class=\"n\">raise</span> <span class=\"n\">ArgumentError</span><span class=\"p\">.</span><span class=\"n\">new</span> <span class=\"p\">}</span>\n    <span class=\"k\">model</span><span class=\"p\">.</span><span class=\"n\">stub</span> <span class=\"p\">:</span><span class=\"n\">my_method</span><span class=\"p\">,</span> <span class=\"n\">raises_exception</span> <span class=\"k\">do</span>\n      <span class=\"n\">assert_raises</span><span class=\"p\">(</span><span class=\"n\">ArgumentError</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"k\">model</span><span class=\"p\">.</span><span class=\"n\">my_method</span> <span class=\"p\">}</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div></div>\n\n<p>Stub works also with some custom doubles mock. You can define singleton method\non mock <code class=\"highlighter-rouge\">def mock.apply; end</code> but can not use other methods or variables… in\nthis case use <code class=\"highlighter-rouge\">mock.expect :method, return_value</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/models/user_test.rb\nrequire 'test_helper'\nclass UserTest &lt; ActiveSupport::TestCase\n  test '#apply_subscription' do\n    mock = Minitest::Mock.new\n    def mock.apply; true; end\n    # or\n    mock.expect :apply, true\n\n    SubscriptionService.stub :new, mock do\n      user = users(:one)\n      assert user.apply_subscription\n    end\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"minitest-mocha-feature-tests\">Minitest mocha feature tests</h2>\n\n<p>Rails calls “integration tests” as “request tests” and it covers both controller\nand view code. If logic is more complex, it should be written in model anyway,\nand use lower level tests.</p>\n\n<p>With capybara:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n  gem \"minitest-rails-capybara\"\n  gem \"mocha\", require: false\n\n# test/test_helper.rb\nrequire \"minitest/rails/capybara\"\nrequire \"mocha/mini_test\"\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  test \"full double\" do\n    stubby = stub(name: \"Dule\", wight: 100)\n    assert_equal(\"Dule\", stubby.name)\n  end\n\n  test \"verifying double\" do\n    stubby = stub(name: \"Dule\", weight: 100)\n    stubby.responds_like(Project.new)\n    # or\n    stubby.responds_like_instance_of(Project)\n    # this is find since project.name exists\n    stubby.name\n    # this will raise error\n    skip\n    stubby.weight\n  end\n\n  test \"partial double\" do\n    project = Project.new name: 'Dule'\n    # we can stub method on any ruby object\n    project.stubs(:name)\n    # returns nothing unless we use returns\n    assert_nil(project.name)\n    # we can stub non existing methods\n    project.stubs(:asd)\n    assert_nil(project.asd)\n    # we can define return\n    project.stubs(:due_date).returns(Date.today)\n    assert_equal(project.due_date, Date.today)\n    # we can stub classes\n    Project.stubs(:find).returns(Project.new(name: 'dule'))\n    project = Projet.find(1)\n    assert_equal('dule', project.name)\n    # we can stub any instance\n    Project.any_instance.stubs(:save).returns(false)\n  end\n\n  test \"mock expectation\" do\n    mock_project = Project.new name: 'Not important since expect returns'\n    mock_project.expects(:name).returns('Duke')\n    # previous expectation will fail if we have not called it\n    assert_equal('Duke', mock_project.name)\n    # we can set number of times it is called\n    mock_project.expects(:name).twice\n    mock_project.name\n    mock_project.name\n    # we can set arguments\n    mock_task = Task.new\n    mock_task.expects(:mark_as_completed).with(instance_of(Date)).returns(instance_of(Date))\n    mock_task.mark_as_completed Date.today\n    mock_task.expects(:mark_as_completed).with(instance_of(String)).returns(nil)\n    mock_task.mark_as_completed \"bla\"\n  end\n</code></pre></div></div>\n\n<h1 id=\"guard\">Guard</h1>\n\n<p>For guard minitest use <code class=\"highlighter-rouge\">guard-minitest</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development do/a  \\\n  gem 'guard'\n  gem 'guard-minitest'\nbundle\nguard init minitest\nvi Guardfile\n# uncomment rails section\n# change some lines in Guardfile\nguard :minitest, spring: 'bin/rails test', failed_mode: :focus do\n</code></pre></div></div>\n\n<ul>\n  <li>to show full backtrace use <code class=\"highlighter-rouge\">BACKTRACE=blegga rails test</code></li>\n  <li>\n    <p>to take screenshot you can call <code class=\"highlighter-rouge\">take_screenshot</code> in tests.\nAutomatically taking screenshot when tast fails is included in teardown by\ndefault, and you can override it\nhttps://api.rubyonrails.org/v5.2/classes/ActionDispatch/SystemTesting/TestHelpers/ScreenshotHelper.html#method-i-take_screenshot\nBy default <code class=\"highlighter-rouge\">image_name</code> is\n<a href=\"https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/actionpack/lib/action_dispatch/system_testing/test_helpers/screenshot_helper.rb#L42\">method_name</a>\nBy default <code class=\"highlighter-rouge\">display_image</code> will print <code class=\"highlighter-rouge\">puts image_path</code> but we can open image</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/application_system_test_case.rb\nrequire 'test_helper'\n\nclass ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase\n  driven_by :selenium, using: :chrome, screen_size: [1400, 1400]\n\n  def display_image\n    system \"gnome-open #{image_path} &amp;\"\n    \"Opening screenshot: gnome-open #{image_path}\"\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>test og meta tags for jekyll</li>\n  <li>https://gist.github.com/thbar/10be2ea924b81f78d24ab800461bfee3</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Sharetribe",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/11/17/sharetribe/",
      "date"     : "2017-11-17 00:00:00 +0100",
      "content"  : "<h1 id=\"install\">Install</h1>\n\n<p><a href=\"https://github.com/sharetribe/sharetribe\">https://github.com/sharetribe/sharetribe</a></p>\n\n<p>If you have newer versions of <code class=\"highlighter-rouge\">node 7.8</code> or <code class=\"highlighter-rouge\">npm 4.2</code> than you should install\nolder <code class=\"highlighter-rouge\">nvm install 7.8</code> and <code class=\"highlighter-rouge\">npm install -g npm@4.2.0</code>.\nIf you dont see forms or other react components, than <code class=\"highlighter-rouge\">rm -rf\nclient/node_modules/</code> and <code class=\"highlighter-rouge\">npm install</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>PORT=3001 foreman start -f Procfile.static\nbundle exec rake jobs:work\n</code></pre></div></div>\n\n<p>Open <a href=\"http://lvh.me:5000/\">http://lvh.me:5000/</a> or updated port <a href=\"http://lvh.me:3001/\">http://lvh.me:3001/</a></p>\n\n<p>Localy inspect mails that are send:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem install mailcatcher\nmailcatcher\n\n# config/config.yml\ndevelopment:\n  mail_delivery_method: smtp\n  smtp_email_address: \"localhost\"\n  smtp_email_port: 1025\n</code></pre></div></div>\n\n<p>Open <a href=\"http://localhost:1080\">http://localhost:1080</a></p>\n\n<h1 id=\"development\">Development</h1>\n\n<p><a href=\"https://github.com/sharetribe/sharetribe/tree/master/docs\">https://github.com/sharetribe/sharetribe/tree/master/docs</a></p>\n\n<h1 id=\"deploy-in-production\">Deploy in production</h1>\n\n<p><a href=\"https://github.com/sharetribe/sharetribe#setting-up-sharetribe-for-production\">https://github.com/sharetribe/sharetribe#setting-up-sharetribe-for-production</a></p>\n\n<p>First checkout latest\n<a href=\"https://github.com/sharetribe/sharetribe/releases\">release</a>.</p>\n\n<p>Keys for AWS S3 and stmp emails are stored in <code class=\"highlighter-rouge\">config/config.defaults.yml</code>.\nIt does not accepts <code class=\"highlighter-rouge\">&lt;%= ENV[\"\"] %&gt;</code> but you can override with env with the same\n<strong>lowercase</strong> names.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/keys/sharetribe.sh\n# domain\nexport domain=my-domain.com\n\n# aws is used from my_keys, but need lowercase\nexport s3_bucket_name=$AWS_BUCKET_NAME\nexport s3_region=$AWS_REGION\nexport s3_upload_bucket_name=$AWS_BUCKET_NAME\nexport aws_access_key_id=$AWS_ACCESS_KEY_ID\nexport aws_secret_access_key=$AWS_SECRET_ACCESS_KEY\n\n# mail using my gmail\nexport mail_delivery_method=smtp\nexport smtp_email_address=smtp.gmail.com\nexport smtp_email_port=587\nexport smtp_email_user_name=$GMAIL_EMAIL\nexport smtp_email_password=$GMAIL_PASSWORD\nexport smtp_email_domain=gmail.com\n\n# google api key for maps\nexport google_maps_key=$GOOGLE_API_KEY\n\n# facebook\nexport fb_connect_id=$FACEBOOK_KEY\nexport fb_connect_secret=$FACEBOOK_SECRET\n\n# all in heroku command\nheroku config:set domain=my-domain.com s3_bucket_name=$AWS_BUCKET_NAME s3_region=$AWS_REGION s3_upload_bucket_name=$AWS_BUCKET_NAME aws_access_key_id=$AWS_ACCESS_KEY_ID aws_secret_access_key=$AWS_SECRET_ACCESS_KEY mail_delivery_method=smtp smtp_email_address=smtp.gmail.com smtp_email_port=587 smtp_email_user_name=$GMAIL_EMAIL smtp_email_password=$GMAIL_PASSWORD smtp_email_domain=gmail.com google_maps_key=$GOOGLE_API_KEY fb_connect_id=$FACEBOOK_KEY fb_connect_secret=$FACEBOOK_SECRET\n</code></pre></div></div>\n\n<p>Domain is root domain, and each community is under subdomain.</p>\n\n<p>Sphinx needs access to mysql so download credentials from clearDB dashboard and\nsave to <code class=\"highlighter-rouge\">lib/certificates</code> folder. Edit <code class=\"highlighter-rouge\">config/thinking_sphinx.yml</code> to point to\nthose files. Key needs to be without password.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>openssl rsa -in cleardb_id-key.pem -out cleardb_id-key-no-password.pem\nvi config/thinking_sphinx.yml\nproduction:\n  mysql_ssl_ca: lib/certificates/cleardb-ca.pem\n  mysql_ssl_cert: lib/certificates/cleardb_id-cert.pem\n  mysql_ssl_key: lib/certificates/cleardb_id-key-no-password.pem\n\nheroku run bundle exec flying-sphinx configure\nheroku run bundle exec flying-sphinx rebuild\nheroku run bundle exec flying-sphinx index\nheroku run bundle exec flying-sphinx start\n</code></pre></div></div>\n\n<p>Scheduler tasks\n<a href=\"https://github.com/sharetribe/sharetribe/blob/master/docs/scheduled_tasks.md\">https://github.com/sharetribe/sharetribe/blob/master/docs/scheduled_tasks.md</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku addons:create scheduler:standard\nheroku addons:open scheduler\n\n# create three tasks, first is hourly other are daily\nbundle exec rails runner ActiveSessionsHelper.cleanup\nbundle exec rails runner CommunityMailer.deliver_community_updates\nbundle exec rake sharetribe:delete_expired_auth_tokens\n</code></pre></div></div>\n\n<p>For Heroku use the same steps.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku config:set PASSENGER_MAX_POOL_SIZE=3\nheroku run bundle exec rake db:structure:load\n</code></pre></div></div>\n\n<p>Problem with <code class=\"highlighter-rouge\">Please check the output above for any errors and make sure that\n</code>mysql<code class=\"highlighter-rouge\"> is installed in your PATH and has proper permissions.</code> is reported\nhttps://github.com/sharetribe/sharetribe/issues/2981 and you need to install\nbuildpack <a href=\"https://stackoverflow.com/a/47392242/287166\">https://stackoverflow.com/a/47392242/287166</a></p>\n\n<h1 id=\"adding-linkedin\">Adding linkedin</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># linkedin\nexport linkedin_client_id=$LINKEDIN_CLIENT_ID\nexport linkedin_client_secret=$LINKEDIN_CLIENT_SECRET\n\nheroku config:set linkedin_client_id=$LINKEDIN_CLIENT_ID linkedin_client_secret=$LINKEDIN_CLIENT_SECRET\n\n# config/initializers/devise.rb\n  config.omniauth :linkedin, APP_CONFIG.linkedin_client_id, APP_CONFIG.linkedin_client_secret\n</code></pre></div></div>\n\n<h1 id=\"contribute\">Contribute</h1>\n\n<p><a href=\"https://github.com/sharetribe/sharetribe/blob/master/app/models/person.rb#L518\">https://github.com/sharetribe/sharetribe/blob/master/app/models/person.rb#L518</a>\nlogger is using Rails logger instead of SharetribeLogger.</p>\n\n<h1 id=\"examples\">Examples</h1>\n\n<ul>\n  <li>interesting example <a href=\"https://www.sharegrid.com/\">https://www.sharegrid.com/</a></li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Google Apis Gmail Calendar Youtube Captcha",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/10/05/google-apis-gmail-calendar-youtube-captcha/",
      "date"     : "2017-10-05 00:00:00 +0200",
      "content"  : "<h1 id=\"youtube\">Youtube</h1>\n\n<h2 id=\"youtube-video-in-popup-modal\">Youtube video in popup modal</h2>\n\n<p>It is simple iframe similar to <a href=\"http://jsfiddle.net/jeremykenedy/h8daS/1/\">this\nsolution</a> just with stop video after\nmodal is closed with Esc</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;div class=\"modal fade\" id=\"videoModal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"videoModal\" aria-hidden=\"true\"&gt;\n  &lt;div class=\"modal-dialog\"&gt;\n    &lt;div class=\"modal-content\"&gt;\n      &lt;div class=\"modal-body\"&gt;\n        &lt;button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\"&gt;&amp;times;&lt;/button&gt;\n        &lt;div&gt;\n          &lt;iframe width=\"100%\" height=\"350\" src=\"\"&gt;&lt;/iframe&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n&lt;/div&gt;\n\n &lt;a href=\"#\" class=\"btn btn-default\" data-toggle=\"modal\" data-target=\"#videoModal\" data-theVideo=\"http://www.youtube.com/embed/loFtozxZG0s\" &gt;VIDEO&lt;/a&gt;\n\n&lt;script&gt;\n$('[data-theVideo]').click(function () {\n  var theModal = $(this).data( \"target\" ),\n  videoSRC = $(this).attr( \"data-theVideo\" ), \n  videoSRCauto = videoSRC+\"?autoplay=1\" ;\n  $(theModal+' iframe').attr('src', videoSRCauto);\n  $(theModal+' button.close').click(function () {\n      $(theModal+' iframe').attr('src', videoSRC);\n  });\n});\n\n$('#videoModal').on('hidden.bs.modal', function() {\n  $(this).find('iframe').attr('src', null);\n});\n&lt;/script&gt;\n</code></pre></div></div>\n\n<h1 id=\"google-pdf-preview\">Google pdf preview</h1>\n\n<p>If you want to preview pdf or image file, you can use Google</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$('#viewerBox').attr('src','https://docs.google.com/viewer?embedded=true&amp;url=&lt;%= application.resume.media.url %&gt;' );\n</code></pre></div></div>\n\n<p>or you can use directly <a href=\"http://mozilla.github.io/pdf.js/getting_started/\">pdf.js</a></p>\n\n<p><a href=\"https://github.com/Fullscreen/yt\">yt</a> gem access <a href=\"https://developers.google.com/youtube/\">youtube\napi</a>. Creators\n<a href=\"http://fullscreen.github.io/yt/\">http://fullscreen.github.io/yt/</a>. Private or non existing video url raise\nexceptions so you need to <code class=\"highlighter-rouge\">rescue Yt::Errors::NoItems,\nYt::Errors::RequestError</code>. Video could be public but not accessible (because of\ndeactived account).</p>\n\n<h1 id=\"gmail-api\">Gmail API</h1>\n\n<p>https://pramodbshinde.wordpress.com/2014/12/07/gmail-api-in-ruby-on-rails-a-piece-of-cake/\nhttp://stackoverflow.com/questions/26005675/sending-html-email-using-gmail-api-in-ruby\nhttps://developers.google.com/gmail/api/guides/sending\nhttps://developers.google.com/api-client-library/ruby/apis/gmail/v1</p>\n\n<p>Someone can break to your account simple by adding his email as recovery email.\nThan he can easily change password.</p>\n\n<h1 id=\"gmail-shortcuts\">Gmail shortcuts</h1>\n\n<ul>\n  <li>? to open keyboard shortcut help</li>\n  <li>Ctrl+Enter to send email</li>\n  <li>j and k to older and newer conversation</li>\n  <li>o to open conversation, u to back to threadlist</li>\n  <li>g+a go to all mail, g+t to sent emails, g+i to inbox</li>\n  <li>c to compose</li>\n  <li>/ to search</li>\n</ul>\n\n<h1 id=\"recaptcha\">ReCaptcha</h1>\n\n<p>Register on <a href=\"https://www.google.com/recaptcha\">https://www.google.com/recaptcha</a> and you can use in in javascript\n<code class=\"highlighter-rouge\">&lt;div class=\"g-recaptcha\" data-sitekey=\"6LdrgFQUAAAAALvyQvT3fpoagmnb-ik9f73Y0Zaz\"&gt;&lt;/div&gt;</code>\nbut on rails and devise follow\n<a href=\"https://github.com/plataformatec/devise/wiki/How-To:-Use-Recaptcha-with-Devise\">https://github.com/plataformatec/devise/wiki/How-To:-Use-Recaptcha-with-Devise</a>\nand gem <a href=\"https://github.com/ambethia/recaptcha\">https://github.com/ambethia/recaptcha</a></p>\n\n<p>Example is https://github.com/duleorlovic/premesti.se</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n# captcha on contact form\ngem 'recaptcha'\n\n# config/locales/en.yml\n  recaptcha:\n    errors:\n      verification_failed: reCAPTCHA verification failed, please try again.\n\n# app/form_objects/contact_form.rb\nrequire 'recaptcha/verify'\n\nclass ContactForm\n  include ActiveModel::Model\n  include Recaptcha::Verify\n\n  attr_accessor :email, :text, :g_recaptcha_response, :current_user, :remote_ip\n  validates_format_of :email, with: Devise.email_regexp\n  validates :text, :email, presence: true\n\n  def save\n    verify_recaptcha model: self, response: g_recaptcha_response\n    return false if errors.present?\n    return false unless valid?\n\n    _send_notification\n    true\n  end\n\n  def request\n    OpenStruct.new remote_ip: remote_ip\n  end\n\n  def env\n    nil\n  end\n\n  def _send_notification\n    Notify.message(\"contact_form #{email} @ #{Time.zone.now}\", email, text, remote_ip, current_user)\n  end\nend\n\n# app/controllers/pages_controller.rb\n  def contact\n    @contact_form = ContactForm.new(\n      email: current_user&amp;.email\n    )\n  end\n\n  def submit_contact\n    @contact_form = ContactForm.new(\n      email: current_user&amp;.email || params[:contact_form][:email],\n      text: params[:contact_form][:text],\n      g_recaptcha_response: params['g-recaptcha-response'],\n      current_user: current_user,\n      remote_ip: request.remote_ip,\n    )\n    if @contact_form.save\n      flash.now[:notice] = t('contact_thanks')\n      contact\n    else\n      flash.now[:alert] = @contact_form.errors.full_messages.join(', ')\n    end\n    render :contact\n  end\n\n# app/assets/javascripts/window_functions.coffee\nwindow.enableRecaptchaButtons = (e) -&gt;\n  console.log 'enableRecaptchaButtons'\n  $('[data-recaptcha-button]').prop('disabled', false)\n\n# config/initializers/recaptcha.rb\nRecaptcha.configure do |config|\n  config.site_key = Rails.application.secrets.google_recaptcha_site_key\n  config.secret_key = Rails.application.secrets.google_recaptcha_secret_key\nend\n\n# config/secrets.yml\n  # Google recaptcha\n  google_recaptcha_site_key: &lt;%= ENV['GOOGLE_RECAPTCHA_SITE_KEY'] %&gt;\n  google_recaptcha_secret_key: &lt;%= ENV['GOOGLE_RECAPTCHA_SECRET_KEY'] %&gt;\n</code></pre></div></div>\n\n<p>Use <code class=\"highlighter-rouge\">Checkbox</code> v2 (<code class=\"highlighter-rouge\">Invisible</code> is similar, just you need to trigger using js and\nuse callback to receive results). V3 is for scoring.</p>\n\n<p>It is not possible to edit configuration using api\nhttps://stackoverflow.com/questions/38197959/how-to-add-redirect-uris-programmatically\nso use selenium script to update redirect URIs. You can use 50 domain with one\nkey.</p>\n\n"
    } ,
  
    {
      "title"    : "Design Patterns And Domain Driven Design",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/10/03/design-patterns-and-domain-driven-design/",
      "date"     : "2017-10-03 00:00:00 +0200",
      "content"  : "<p>https://code.tutsplus.com/articles/a-beginners-guide-to-design-patterns–net-12752</p>\n\n<p>Three basic kind of design pattern:</p>\n<ul>\n  <li>structural</li>\n  <li>creational</li>\n  <li>behavioral</li>\n</ul>\n\n<p>https://www.youtube.com/watch?v=3SGRjUWScRw&amp;feature=youtu.be</p>\n\n<p>Instead of</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Member &lt; ActiveRecord::Base\n  has_many :email_addresses\n  has_one :primary_email_address, conditions: { primary: true }\nend\n</code></pre></div></div>\n\n<p>Use belongs_to on members</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Member &lt; ActiveRecord::Base\n  has_many :email_addresses\n  belongs_to :primary_email_address, class_name: \"EmailAddress\", foreign_key: :email_address_id\nend\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Vue Js",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/10/02/vue-js/",
      "date"     : "2017-10-02 00:00:00 +0200",
      "content"  : "<h1 id=\"basic-directive-helpers\">Basic directive helpers</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;div id='app'&gt;\n  \n  &lt;input v-model='message'&gt;\n  &lt;ul&gt;\n    &lt;li v-for='item in items' :key='item'&gt;\n      \n    &lt;/li&gt;\n  &lt;/ul&gt;\n&lt;/div&gt;\n</code></pre></div></div>\n\n<ul>\n  <li>mustaches <code class=\"highlighter-rouge\">{ { message }}</code> can be used only as inner block (not html\nattributes). Use ternary expression instead <code class=\"highlighter-rouge\">if</code> flow. Can not use statement\nlike <code class=\"highlighter-rouge\">a=1</code>.</li>\n  <li>For html attributes you have to use <code class=\"highlighter-rouge\">&lt;div v-bind:id='dynamicId'&gt;&lt;/div&gt;</code>. For\nboolean atributes true will show and false, null, undefined will hide that\nattribute for example <code class=\"highlighter-rouge\">&lt;button v-bind:disabled='isButtonDisabled'&gt;B&lt;/button&gt;</code>.\nShorthand for <code class=\"highlighter-rouge\">v-bind:</code> is <code class=\"highlighter-rouge\">:</code></li>\n  <li>model <code class=\"highlighter-rouge\">v-model='message'</code></li>\n  <li>conditional <code class=\"highlighter-rouge\">v-if='seen'</code> directive.</li>\n  <li>in loops <code class=\"highlighter-rouge\">v-for='item in items'</code> you need a key (which is uniq) so it keeps\ntrack of changes between dom and virtual dom. <code class=\"highlighter-rouge\">v-bind:key='item.id'</code> or\nshorthand <code class=\"highlighter-rouge\">:key='item.id'</code>.</li>\n  <li><code class=\"highlighter-rouge\">&lt;span v-once&gt;{ { message }}&lt;/span&gt;</code> will render only once even you change data\nfor inside model interpolation <code class=\"highlighter-rouge\">{ { message }}</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;span v-html='rawHtml'&gt;&lt;/span&gt;</code> will output without html encoding</li>\n  <li>events <code class=\"highlighter-rouge\">v-on:click='shuffle'</code> or shorthand <code class=\"highlighter-rouge\">@click='shuffle'</code>. You can use</li>\n  <li>modifiers like <code class=\"highlighter-rouge\">&lt;form v-on:submit.prevent='onSubmit'&gt;</code> which call\n<code class=\"highlighter-rouge\">preventDefault()</code> on triggered event</li>\n  <li>bind specific dom attributes <code class=\"highlighter-rouge\">v-bind:title='message'</code></li>\n  <li>instead <code class=\"highlighter-rouge\">&lt;img source='{ {}}'&gt;</code> use <code class=\"highlighter-rouge\">&lt;img :src='comment.image'&gt;</code></li>\n</ul>\n\n<h1 id=\"vue-instance\">Vue instance</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var vm = new Vue({\n  el: '#example',\n  data: {\n    asd: 1 // you can access data with `vm.asd`\n  },\n  // lifecycle hooks created, mounted, updated, destroyed\n  created: function() {},\n  computed: {\n    // getters for computed values like helpers, but result is chaches as long\n    // as dependencies are not changed (message is not updated). `Date.now()` is\n    // not reactive dependency\n    reverseMessage: function() {\n      return this.message.split('').reverse().join('')\n    }\n  },\n  methods: {\n    reverseMessage: function() {}\n  }\n\n})\n\nvm.asd // =&gt; 1\nvm.asd = 2 // reactiveness in action will update data.asd == 2\nvm.non_bind = 1 // this was not defined at time of instantiating so no update\nvm.$data === data // =&gt; true\nvm.$el === document.getElementById('example') // =&gt; true\n\n// $watch is an instance method\nvm.$watch('a', function (newValue, oldValue) {\n  // This callback will be called when `vm.a` changes\n})\n\n</code></pre></div></div>\n\n<p>Do not use arrow functions since <code class=\"highlighter-rouge\">this</code> will not be bound to view instance.</p>\n\n<h1 id=\"animations\">Animations</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;transition-group tag='ul name='items'&gt;\n&lt;/transition-group&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.items-move {\n  transition: transform 0.5s ease;\n}\n</code></pre></div></div>\n\n<h1 id=\"components\">Components</h1>\n\n<p>Template for component can be referenced with id or written inline. Pass data to\ncomponents with <code class=\"highlighter-rouge\">props</code>, that are ‘attributes’ for components. They are passed\nwith <code class=\"highlighter-rouge\">v-bind:name_of_attribute='value_of_attribute'</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Vue.component('AppComponent', {\n  template: '#componentTemplate',\n  props: ['comment']\n})\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;ul&gt;\n  &lt;li is='app-component' v-for='comment in comments' :key='comment'\n:comment='comment'&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;script type='text/x-template' id='componentTemplate'&gt;\n  &lt;li&gt;\n    \n  &lt;/li&gt;\n&lt;/script&gt;\n</code></pre></div></div>\n\n<h1 id=\"vue-cli\">Vue cli</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># yarn will install old ~2 version\n# yarn global add @vue/cli\nnpm install -g @vue/cli\n\nvue create my-project\n</code></pre></div></div>\n\n<p>TODO\nhttps://blog.codeship.com/vuejs-as-a-frontend-for-rails/\nhttps://gorails.com/series/using-vuejs-with-rails\nhttps://mkdev.me/en/posts/rails-5-vue-js-how-to-stop-worrying-and-love-the-frontend</p>\n\n<p>https://vuejs.org/v2/guide/computed.html#Computed-vs-Watched-Property</p>\n\n<p>https://vuejs.org/v2/style-guide/\nhttps://github.com/aarondfrancis/vue-model\nhttp://quasar-framework.org/\nhttps://www.reddit.com/r/javascript/comments/6v1ki7/weex_vs_framework7_vs_quasar/\nhttps://blog.logrocket.com/an-imperative-guide-to-forms-in-vue-js-7536bfa374e0\n<a href=\"https://vuejsdevelopers.com/2017/10/23/vue-js-tree-menu-recursive-components/\">https://vuejsdevelopers.com/2017/10/23/vue-js-tree-menu-recursive-components/</a>\nhttps://www.thepolyglotdeveloper.com/2017/11/router-navigate-pages-vuejs-application/\nhttps://www.classandobjects.com/tutorial/using_vue_js_with_rails\nhttps://docs.gitlab.com/ee/development/fe_guide/vue.html#testing-vuex\nhttps://www.thepolyglotdeveloper.com/2017/11/pass-data-between-routes-vuejs-web-application/\nhttps://github.com/calirojas506/vue-inspector\nhttps://engineering.doximity.com/articles/five-traps-to-avoid-while-unit-testing-vue-js\nhttps://wyeworks.com/blog/2018/1/16/Testing-Vuejs-in-Rails-with-Webpacker-and-Jest\nhttps://alligator.io/vuejs/vue-parceljs/\nhttp://epic-spinners.epicmax.co/#/\nhttps://blog.codeship.com/vuejs-components-with-coffeescript-for-rails/\nhttps://github.com/epicmaxco/vuestic-admin</p>\n\n"
    } ,
  
    {
      "title"    : "Stripe",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/08/29/stripe/",
      "date"     : "2017-08-29 00:00:00 +0200",
      "content"  : "<h1 id=\"installation\">Installation</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem 'stripe'\n\nrails credentials:edit\n# add two keys\nstripe_publishable_key: pk_test_I...\nstripe_secret_key: sk_test_g...\n\n# config/initializers/stripe.rb\nStripe.api_key = Rails.application.credentials.stripe_secret_key\n</code></pre></div></div>\n\n<p>You can use checkout.js https://stripe.com/docs/checkout#integration that will\ngenerate token which you can use to make a customer</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%= form_tag charge_path do %&gt;\n  &lt;script src=\"https://checkout.stripe.com/checkout.js\" class=\"stripe-button\"\n          data-key=\"&lt;%= Rails.application.credentials.stripe_publishable_key %&gt;\"\n          data-description=\"A month's subscription\"\n          data-amount=\"500\"\n          data-locale=\"auto\"&gt;&lt;/script&gt;\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<p>Or you can use more flexibile <code class=\"highlighter-rouge\">stripe.js</code> but note that if you use elements\ncreate than they will be inside iframe\nhttps://stripe.com/docs/stripe-js/elements/quickstart\nhttps://github.com/stripe/react-stripe-elements/issues/167\nhttps://stripe.com/docs/stripe-js/elements/migrating#elements-demo</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var stripe = Stripe('pk_test_Ib1l2OSfSQv8DieeTjCHsNoU');\nstripe.createToken(card).then(function(result) {\n  result.token\n  result.error\n});\n</code></pre></div></div>\n\n<h1 id=\"stripe-ruby-mock\">Stripe ruby mock</h1>\n\n<p>https://github.com/rebelidealist/stripe-ruby-mock is a nice way to mock all API\ncalls. To mock js calls you need to override js or mock params\nhttps://github.com/rebelidealist/stripe-ruby-mock/issues/360</p>\n\n<p>You can find on github https://github.com/duleorlovic/stripe_demo</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  def stub_stripe(status, plan_id: nil)\n    StripeMock.start\n    stripe_helper = StripeMock.create_test_helper\n    token = stripe_helper.generate_card_token(last4: '1234')\n    script = \"document.token_id = '#{token}'\"\n    page.evaluate_script(script)\n    stripe_helper.create_plan(id: plan_id) if plan_id.present?\n    yield if block_given?\n    # note that you should make assertion before the block finish\n    StripeMock.stop\n  end\n</code></pre></div></div>\n\n<h1 id=\"testing-stripe\">Testing Stripe</h1>\n\n<p>Test numbers <code class=\"highlighter-rouge\">4242424242424242</code> or some of declined cards:\nhttps://stripe.com/docs/testing#cards</p>\n<ul>\n  <li>incorrect_number <code class=\"highlighter-rouge\">424242424242424241</code></li>\n  <li>incorrect cvc is just use two digits or <code class=\"highlighter-rouge\">4000000000000127</code> or\n  <code class=\"highlighter-rouge\">4000000000000101</code></li>\n  <li>can attach card but attempts to charge fails <code class=\"highlighter-rouge\">4000000000000341</code></li>\n</ul>\n\n<p>Demo app but Rails 4 can be found <a href=\"https://github.com/andrewculver/koudoku\">https://github.com/andrewculver/koudoku</a>\nhttp://koudoku.org/</p>\n\n<p>You can test using server https://github.com/stripe/stripe-mock or using mocking\nlibrary https://github.com/rebelidealist/stripe-ruby-mock</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Shopify Api",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/08/18/shopify-api/",
      "date"     : "2017-08-18 00:00:00 +0200",
      "content"  : "<h1 id=\"creating-new-app\">Creating new app</h1>\n\n<p><a href=\"https://help.shopify.com/api/getting-started\">https://help.shopify.com/api/getting-started</a> On <a href=\"https://partners.shopify.com\">https://partners.shopify.com</a>\ncreate account and development store, for example\n<a href=\"https://duleorlovic-test.myshopify.com/\">https://duleorlovic-test.myshopify.com/</a>.\nAlso create an App (url could be your local ngrok tunnel). Since shopify from\nseptember uses only https, you need to use https ngrok url.\nYou need to start ngrok and than update in Apps -&gt; App Info -&gt; App\ninformation App URL as <a href=\"https://159abd37.ngrok.io/\">https://159abd37.ngrok.io/</a> and Whitelisted redirection\nURL <a href=\"https://159abd37.ngrok.io/auth/shopify/callback\">https://159abd37.ngrok.io/auth/shopify/callback</a>\nUse ngrok url when installing the app, since if you install from <code class=\"highlighter-rouge\">&lt;localhost&gt;</code>\nthen <code class=\"highlighter-rouge\">Oauth error invalid_request: The redirect_uri is not whitelisted</code> is\nraised. This is also raised when you use <code class=\"highlighter-rouge\">http</code> instead <code class=\"highlighter-rouge\">https</code>.\nCopy credentials from Apps -&gt; App info -&gt; App credentials and store them in\n<code class=\"highlighter-rouge\">SHOPIFY_API_KEY</code> and <code class=\"highlighter-rouge\">SHOPIFY_SECRET_KEY</code>.</p>\n\n<p>Note that protocoll should be https (admin store is always redirected to https),\nbecause if we use <code class=\"highlighter-rouge\">http://159abd37.ngrok.io</code> there will be a warning:\n<code class=\"highlighter-rouge\">Shopify.AppMessenger received message null from unexpected origin\nhttps://159abd37.ngrok.io ; expecting http://159abd37.ngrok.io or subdomain\nthereof</code></p>\n\n<p>Install <a href=\"https://developer-tools.shopifyapps.com/install\">https://developer-tools.shopifyapps.com/install</a> to load sample\ngenerated data.</p>\n\n<p>Create new rails and add gem <a href=\"https://github.com/Shopify/shopify_app\">https://github.com/Shopify/shopify_app</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails new shopify_test -d postgresql\ncd shopify_test\nrake db:create\ngit init . &amp;&amp; git add . &amp;&amp; git commit -am \"rails new\"\ncat &gt; config/secrets.yml &lt;&lt; HERE_DOC\nshared:\n  secret_key_base: &lt;%= ENV[\"SECRET_KEY_BASE\"] || 'some_secret' %&gt;\n\n  shopify_api_key: &lt;%= ENV[\"SHOPIFY_API_KEY\"] %&gt;\n  shopify_secret_key: &lt;%= ENV[\"SHOPIFY_SECRET_KEY\"] %&gt;\nHERE_DOC\necho \"gem 'shopify_app'\" &gt;&gt; Gemfile\nbundle\n\nrails generate shopify_app\n#    generate  shopify_app:install\n#      create  config/initializers/shopify_app.rb\n#      create  config/initializers/omniauth.rb\n#      insert  config/initializers/omniauth.rb\n#      create  app/views/layouts/embedded_app.html.erb\n#      create  app/views/layouts/_flash_messages.html.erb\n#       route  mount ShopifyApp::Engine, at: '/'\n#    generate  shopify_app:shop_model\n#      create  app/models/shop.rb\n#      create  db/migrate/20171103082230_create_shops.rb\n#        gsub  config/initializers/shopify_app.rb\n#      create  test/fixtures/shops.yml\n#    generate  shopify_app:home_controller\nrake db:migrate\nsed -i config/initializers/shopify_app.rb -e '/&lt;api_key&gt;/c \\\n  config.api_key = Rails.application.secrets.shopify_api_key'\nsed -i config/initializers/shopify_app.rb -e '/&lt;secret&gt;/c \\\n  config.secret = Rails.application.secrets.shopify_secret_key'\ngit add . &amp;&amp; git commit -m \"rails g shopify_app\"\n</code></pre></div></div>\n\n<p>When you navigate to <a href=\"https://159abd37.ngrok.io\">https://159abd37.ngrok.io</a> for the first time you will be\nasked for shop url, so enter <a href=\"https://duleorlovic-test.myshopify.com/\">https://duleorlovic-test.myshopify.com/</a> or just a\nname <code class=\"highlighter-rouge\">duleorlovic-test</code> to install our app. Than enable Apps -&gt; App info -&gt;\nExtensions -&gt; “Embed in Shopify admin”.</p>\n\n<p>You can use <code class=\"highlighter-rouge\">ngrok http 3003</code> while you are developing.\nAlso <a href=\"https://requestb.in/\">https://requestb.in/</a> and <a href=\"https://forwardhq.com/\">https://forwardhq.com/</a></p>\n\n<p>Only legacy app uses <code class=\"highlighter-rouge\">embeded: false</code>. If you do not want to redirect to shopify\nadmin and be under iframe, you can disable redirect\n<a href=\"https://github.com/Shopify/shopify_app#testing-an-embedded-app-outside-the-shopify-admin\">https://github.com/Shopify/shopify_app#testing-an-embedded-app-outside-the-shopify-admin</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/views/layouts/embedded_app.html.erb\n        forceRedirect: &lt;%= Rails.env.development? || Rails.env.test? ? 'false' : 'true' %&gt;\n</code></pre></div></div>\n\n<p>Note that <code class=\"highlighter-rouge\">app/views/layouts/embedded_app.html.erb</code> layouts always used (and\nnot application layout).</p>\n\n<h1 id=\"heroku\">Heroku</h1>\n\n<p>When you deploy to heroku you need to update Redirection URL or create another\napp</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku config:set SHOPIFY_API_KEY=$SHOPIFY_API_KEY SHOPIFY_SECRET_KEY=$SHOPIFY_SECRET_KEY SERVER_URL=https://`heroku domains | sed -n 2p`\n</code></pre></div></div>\n\n<p>Remember to reinstall application after the assets compilation is finished.\nAlso you can force oauth simply going on <code class=\"highlighter-rouge\">/login</code> page, but this helps only with\nwebhooks. Script tags need reinstall. NOTE THAT USUALLY NEED TO RESTART RAILS\nSERVER BEFORE THAT SO IT PICKS UP NEW DIGEST.</p>\n\n<p>Use force ssl, so it is always using https (redirect url will be the same\nprotocol from which we started auth).</p>\n\n<p>If there is a message for <code class=\"highlighter-rouge\">/auth/failure</code> with <code class=\"highlighter-rouge\">\"message\":\"invalid_signature\"</code>\nthan probably you already have existing shop with different API keys. So remove\nany shops from database when you change API keys. Also might be that your API\nSECRET is invalid.</p>\n\n<p>If there is a message for your page\n<code class=\"highlighter-rouge\">duleorlovic-test.myshopify.com/admin/apps/12342134</code> with message <code class=\"highlighter-rouge\">Not Found:\nThe page you were looking for does not exist.</code>… I do not know.</p>\n\n<h1 id=\"oauth\">OAuth</h1>\n\n<p>Client is application that would like access to shops data.\nFirst step is to redirect resource owner to authorization server and ask for\nscopes (write_orders,read_customers), define redirect_uri and use option for\noffline (default) or online access mode (current session).\nWhen resource owner click Install they will be redirected to redirect_url with\nauthorization code.</p>\n\n<p>If offline access mode, than authorization code is exchanged with permament\naccess token using <code class=\"highlighter-rouge\">POST https://{shop}.myshopify.com/admin/oauth/access_token</code>\nwith <code class=\"highlighter-rouge\">authorization_code</code>, <code class=\"highlighter-rouge\">client_id</code> and <code class=\"highlighter-rouge\">client_secret</code>.</p>\n\n<h1 id=\"private-app\">Private app</h1>\n\n<p>You can generate keys for specific shop, got to you\n<code class=\"highlighter-rouge\">{shop_url}/admin/apps/private</code>. Enable what you need since by default not all\nare enabled.</p>\n\n<p>You can use <a href=\"https://github.com/Shopify/shopify_api#console\">shopify-cli\nconsole</a> to access resources\nusing pry</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>shopify-cli add duleorlovic-test\nshopify-cli console\nShopifyAPI::Product.find(:all)\n</code></pre></div></div>\n\n<p>Also, you can use postman to access requests.</p>\n\n<h1 id=\"api\">API</h1>\n\n<p><a href=\"https://help.shopify.com/api/reference\">https://help.shopify.com/api/reference</a>\nWhen using api you can call <code class=\"highlighter-rouge\">find</code> on two ways: <code class=\"highlighter-rouge\">:all</code> or specific id.\nWhen find is used with specific id it will raise exception if it is not found.</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ShopifyAPI::Order.find 123456\nShopifyAPI::Order.find :all\n</code></pre></div></div>\n\n<p>If find is used with <code class=\"highlighter-rouge\">:all</code> you can use additional <code class=\"highlighter-rouge\">params</code> hash with:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">fields</code> which fields to return, can be array</li>\n  <li><code class=\"highlighter-rouge\">page</code> which page 1, 2, …</li>\n  <li><code class=\"highlighter-rouge\">limit</code> default is 50 usuall max is 250</li>\n  <li><code class=\"highlighter-rouge\">ids</code> comma separated ids</li>\n  <li><code class=\"highlighter-rouge\">vendor</code> or any other field</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@orders = ShopifyAPI::Order.find(:all, params: {fields: \"id,name,created_at,email,financial_status,total_price\", financial_status: \"pending\", limit: 250})\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">where</code> could also work (no need to nest inside <code class=\"highlighter-rouge\">params</code> hash):</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ShopifyAPI::Product.where(ids: \"8931567365\")\n# NOTE that single 'id' does not work, it returns all\nShopifyAPI::Product.where(id: \"8931567365\") # THIS DOES NOT WORK\n# other fields are ok in singular - original field name\nShopifyAPI::Product.where(vendor: \"duleorlovic-test\")\n\n# fields array, page and limit also works\nShopifyAPI::Product.where(vendor: \"duleorlovic-test\", fields: [:id, :title],\nlimit: 1, page: 2)\n</code></pre></div></div>\n\n<h1 id=\"webhooks\">Webhooks</h1>\n\n<p>You can generate config and job for webhook\n<a href=\"https://github.com/Shopify/shopify_app#webhooksmanager\">https://github.com/Shopify/shopify_app#webhooksmanager</a></p>\n\n<p>Note that address needs to be different for each webhook and name is joined\nitem_action.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g shopify_app:add_webhook -t carts/update -a https://example.com/webhooks/carts_update\n</code></pre></div></div>\n\n<p>This will generate something but you can add server url config:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  config.webhooks = [\n    {\n      topic: 'carts/update',\n      address: Rails.application.secrets.server_url.to_S +\n        '/webhooks/carts_update',\n      format: 'json'\n    },\n  ]\n</code></pre></div></div>\n\n<p>Webhook is hash, so you need to access like <code class=\"highlighter-rouge\">webhook[:line_items]</code>\nWebhooks are regenerated by uninstalling and installing again the app. Also\nretriggering the oauth flow also update webhooks (so no need to uninstall).\nJob is created</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/jobs/carts_update_job.rb\nclass CartsUpdateJob &lt; ActiveJob::Base\n  def perform(shop_domain:, webhook:)\n    shop = Shop.find_by(shopify_domain: shop_domain)\n\n    shop.with_shopify_session do\n      # do something with webhook hash\n    end\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"application-proxy\">Application proxy</h1>\n\n<p>You can load productions from external source. Enable it on partners.shopify.com\n-&gt; Apps -&gt; Extension -&gt; App proxy\nsub path can be anything and proxy url should match exact path on server.\nNOTE that this is settings for the app defaults. When user install the app, it\nwill use current settings, but they can customize subpath. You can change\nsubpath on the app and that will have no effects. But If you change proxy url\nthat will broke current applications unless you enable that url on server. So\nthat proxy url always should be working url.</p>\n\n<p>On controller if you inherit from <code class=\"highlighter-rouge\">ShopifyApp::AuthenticatedController</code> than you\nshould skip\n~~\n  skip_around_action :shopify_session, only: [:index]\n  skip_before_action :login_again_if_different_shop, only: [:index]</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\nAnyway for liquid you should set header and render without layout\n</code></pre></div></div>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>render layout: false, content_type: 'application/liquid' ~~~\n</code></pre></div></div>\n\n<h1 id=\"polaris-and-react-components\">Polaris and react components</h1>\n\n<p><a href=\"https://polaris.shopify.com/components/get-started\">https://polaris.shopify.com/components/get-started</a></p>\n\n<h1 id=\"application-admin-links\">Application admin links</h1>\n\n<p>You can register admin links so user can use it from other admin pages\n<a href=\"https://help.shopify.com/api/partner-dashboard/app-admin-access\">https://help.shopify.com/api/partner-dashboard/app-admin-access</a>\nGo to Partners -&gt; Apps -&gt; Extensions -&gt; Add an admin link</p>\n\n<h1 id=\"modify-online-store-using-scripttag\">Modify online store using ScriptTag</h1>\n\n<p>Remote javascript can be loaded on pages of shop’s storefront so show owner do\nnot need to change theme files directly (and to revert changes when uninstalling\nyour app).</p>\n\n<p>You can use template from\n<a href=\"https://help.shopify.com/api/sdks/shopify-apps/modifying-online-store/use-javascript-responsibly\">use javascript\nresponsibly</a>\nand save it on <code class=\"highlighter-rouge\">assets/storefront_javascript/loadSliders.js</code>.\nEnable precompiling and rendering without digest</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# compile assets without digest\ngem 'non-stupid-digest-assets'\nHERE_DOC\nbundle\n\ncat &gt;&gt; config/initializers/assets.rb &lt;&lt; HERE_DOC\nRails.application.config.assets.precompile += %w[\n  loadSliders.js\n]\nNonStupidDigestAssets.whitelist += %w[\n  loadSliders.js\n]\nHERE_DOC\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">rake assets:precompile</code> should create <code class=\"highlighter-rouge\">public/assets/loadSliders.js</code></p>\n\n<p>Register script tag in <code class=\"highlighter-rouge\">config/initializers/shopify_app.rb</code> as in example\n<a href=\"https://github.com/Shopify/shopify_app#scripttagsmanager\">https://github.com/Shopify/shopify_app#scripttagsmanager</a></p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  config.scripttags = [\n    { event: 'onload',\n      src: \"#{Rails.application.secrets.server_url}/assets/loadSliders.js\" }\n  ]\n</code></pre></div></div>\n\n<p>You need to restart rails and reinstall shopify app if you want to change src\nurl.\nYou can use non-stupid-digest-assets or you can use lambda for src.</p>\n\n<h1 id=\"authorize\">Authorize</h1>\n\n<p>To authorize request:\nhttps://help.shopify.com/api/tutorials/application-proxies#proxy-response</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  shop = request.params['shop']\n  code = request.params['code']\n  hmac = request.params['hmac']\n  # perform hmac validation to determine if the request is coming from Shopify\n  h = request.params.reject{|k,_| k == 'hmac'}\n  query = URI.escape(h.sort.collect{|k,v| \"#{k}=#{v}\"}.join('&amp;'))\n  digest = OpenSSL::HMAC.hexdigest(OpenSSL::Digest.new('sha256'), API_SECRET, query)\n  if not (hmac == digest)\n    return [403, \"Authentication failed. Digest provided was: #{digest}\"]\n  end\n</code></pre></div></div>\n\n<h1 id=\"apps\">Apps</h1>\n\n<p>MULTI VENDOR LOKAL SELLER</p>\n<ul>\n  <li>multistore forum discussion: https://ecommerce.shopify.com/c/shopify-discussion/t/multiple-domain-under-one-account-140477</li>\n  <li>one store multi users/vendors discussion https://ecommerce.shopify.com/c/shopify-discussion/t/user-level-accounts-366021</li>\n  <li>supplier offering storefronts to distributors/end_stores. not possible with\none store since price should be different to each distributor.</li>\n</ul>\n\n<h1 id=\"theme-customizations-with-themekit\">Theme customizations with ThemeKit</h1>\n\n<p>Install with commands from <a href=\"https://shopify.github.io/themekit/\">https://shopify.github.io/themekit/</a>. Create private\napp for your store and add read/write access to Theme templates and theme\nassets. Save password to <code class=\"highlighter-rouge\">SHOPIFY_PRIVATE_APP_PASSWORD</code>. Find theme id and save\nto <code class=\"highlighter-rouge\">SHOPIFY_THEME_ID</code>. We will use it to create config.yml.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>theme configure --password=$SHOPIFY_PRIVATE_APP_PASSWORD --store=$SHOPIFY_STORE_URL --themeid=$SHOPIFY_THEME_ID\ntheme download\ntheme upload\ntheme open\ntheme watch\n</code></pre></div></div>\n\n<p>Sections for other pages than home (static sections)  should be uncluded in a\ncode, for example on cart page in <code class=\"highlighter-rouge\">templates/cart.liquid</code> we can insert <code class=\"highlighter-rouge\">{ %\nsection 'my-section' %}</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># sections/my-section.liquid\n&lt;div id=\"my-section\"&gt;\n  &lt;h1&gt;&lt;/h1&gt;\n  &lt;h3&gt;&lt;/h3&gt;\n&lt;/div&gt;\n{ % schema %}\n  {\n    \"name\" : \"My Section\",\n    \"settings\": [\n      {\n        \"id\": \"header-id\",\n        \"label\": \"Header text\",\n        \"type\": \"text\",\n        \"default\": \"Header text here\"\n      },\n      {\n        \"id\": \"content-id\",\n        \"label\": \"Content text\",\n        \"type\": \"richtext\",\n        \"default\": \"&lt;p&gt;Add here&lt;/p&gt;\"\n      }\n    ]\n  }\n{ % endschema %}\n\n{ % stylesheet %}\n{ % endstylesheet %}\n\n{ % javascript %}\n{ % endjavascript %}\n</code></pre></div></div>\n\n<p>For home page (dynamic section) we need to define additional property <code class=\"highlighter-rouge\">presets</code>.\nThere is also a <code class=\"highlighter-rouge\">block</code> type of sections.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{ % schema %}\n  {\n    \"name\" : \"My Section\",\n    \"settings\": [\n    ],\n    \"presets\": [\n      {\n        \"name\": \"Call to action\",\n        \"category\": \"Call to action\"\n      }\n    ]\n  }\n{ % endschema %}\n</code></pre></div></div>\n\n<p>We can have several types:\n<a href=\"https://help.shopify.com/themes/development/theme-editor/settings-schema#input-setting-types\">https://help.shopify.com/themes/development/theme-editor/settings-schema#input-setting-types</a>\nsimple: text, richtext, image_picker, radio, select, checkbox, range\nspecial: product, url, page, collection (it contains ‘Edit collection’ link) …</p>\n\n<h1 id=\"adding-custom-properties\">Adding custom properties</h1>\n\n<p>You need to pass <code class=\"highlighter-rouge\">properties[name-of-property]</code> to the <code class=\"highlighter-rouge\">/card/add</code>. If the\n<code class=\"highlighter-rouge\">name-of-property</code> starts with underscore <code class=\"highlighter-rouge\">_</code> than it wont be shown on checkout.\nYou can use\n<a href=\"https://ui-elements-generator.myshopify.com/pages/line-item-property\">https://ui-elements-generator.myshopify.com/pages/line-item-property</a>\nto generate something like</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;p class=\"line-item-property__field\"&gt;\n  &lt;label&gt;Layout&lt;/label&gt;&lt;br&gt;\n  &lt;input required class=\"required\" type=\"radio\" name=\"properties[Layout]\" value=\"left\"&gt; &lt;span&gt;left&lt;/span&gt;&lt;br&gt;\n  &lt;input required class=\"required\" type=\"radio\" name=\"properties[Layout]\" value=\"right\"&gt; &lt;span&gt;right&lt;/span&gt;&lt;br&gt;\n&lt;/p&gt;\n</code></pre></div></div>\n\n<h1 id=\"publishing-your-app\">Publishing your app</h1>\n\n<p>You should attract your merchants to make a review and put stars on you app.\nFor example: We see you’re seeing success with our app we’d love it if you left\nus a review [link].\nWhen someone is talking to customer support and have good experience, customer\nsupport says: Hey we’d love itif you leave a review.</p>\n\n<h1 id=\"opensource-examples\">Opensource examples</h1>\n\n<p><a href=\"https://github.com/julionc/awesome-shopify\">https://github.com/julionc/awesome-shopify</a></p>\n"
    } ,
  
    {
      "title"    : "Typescript begginer examples",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/08/15/typescript-begginer-examples/",
      "date"     : "2017-08-15 00:00:00 +0200",
      "content"  : "<p><a href=\"https://www.typescriptlang.org/docs/handbook/basic-types.html\">https://www.typescriptlang.org/docs/handbook/basic-types.html</a></p>\n\n<p>You can install and start watching typescript compilation using</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install -g typescript\ntsc -w\n</code></pre></div></div>\n\n<p>Types are checked when you assign or use method on it.</p>\n\n<h1 id=\"basic-types\">Basic types</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">boolean</code>, <code class=\"highlighter-rouge\">number</code>, <code class=\"highlighter-rouge\">string</code> for example <code class=\"highlighter-rouge\">let name: string = 'Duke';</code></li>\n  <li><code class=\"highlighter-rouge\">_[]</code> or <code class=\"highlighter-rouge\">Array&lt;_&gt;</code>: <code class=\"highlighter-rouge\">let list: number[] = [1, 2, 3];</code>, generic array type:\n<code class=\"highlighter-rouge\">let list: Array&lt;number&gt; = [1, 2, 3];</code>\n    <ul>\n      <li>type is used when array has different types <code class=\"highlighter-rouge\">let x: [string, number]</code> so\nfirst element is string and second is number, and all others are union of\nthose (string | number).</li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">enum Color {Red, Green. Blue}</code> usage is <code class=\"highlighter-rouge\">let c: Color = Color.Red</code>. By\ndefault value is 0, 1, … You can also use lookup to get from number to color\nie color name <code class=\"highlighter-rouge\">let colorName: string = Color[2]; // \"Blue\"</code></li>\n  <li><code class=\"highlighter-rouge\">any</code> is type that can be used for existing code, it can contain any value\nand can call any method on it</li>\n  <li><code class=\"highlighter-rouge\">void</code> is only usefull to mark return type of a function (that returns\nnothing)</li>\n  <li><code class=\"highlighter-rouge\">null</code> and <code class=\"highlighter-rouge\">undefined</code> are types for which you can assignly only <code class=\"highlighter-rouge\">null</code> and\n<code class=\"highlighter-rouge\">undefined</code>. <code class=\"highlighter-rouge\">null</code> and <code class=\"highlighter-rouge\">undefined</code> are subtypes of all other types so you can\nassign <code class=\"highlighter-rouge\">null</code> to some <code class=\"highlighter-rouge\">:number</code>. But if <code class=\"highlighter-rouge\">--strictNullChecks</code> is enabled\n(default) <code class=\"highlighter-rouge\">null</code> can be assignable only to <code class=\"highlighter-rouge\">:void</code> or <code class=\"highlighter-rouge\">:null</code>. Use union if\nyou don’t know if it will exists <code class=\"highlighter-rouge\">number | null</code>.</li>\n  <li><code class=\"highlighter-rouge\">never</code> type represents value that never occur. For example if function\nalways throw exception, it has return type <code class=\"highlighter-rouge\">never</code>. it is subtype of all\ntypes. And no type is subtype of <code class=\"highlighter-rouge\">never</code> (except <code class=\"highlighter-rouge\">never</code>)</li>\n</ul>\n\n<p>Type assertions <code class=\"highlighter-rouge\">(&lt;_&gt;)</code> are similar to type cast, but has no runtime impact,\nit’s only used for compiler <code class=\"highlighter-rouge\">let length: number = (&lt;string&gt;name).length;</code> or\n<code class=\"highlighter-rouge\">as</code> syntax <code class=\"highlighter-rouge\">let length: number = (name as string).length;</code></p>\n\n<h1 id=\"interfaces\">Interfaces</h1>\n\n<p>Interface describe objects</p>\n\n<p>stao ovde https://www.typescriptlang.org/docs/handbook/interfaces.html</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>interface Person {\n  firstName: string;\n  lastName: string;\n}\n</code></pre></div></div>\n\n<p>Classes</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Student {\n  fullName: string;\n   constructor(public firstName, public middleInitial, public lastName) {\n      this.fullName = firstName + \" \" + middleInitial + \" \" + lastName;\n  }\n}\n</code></pre></div></div>\n\n<p>We can declare and initialize properties, or use variable assigment</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class A {\n  title: string;\n  constructor(public title: string) {\n    this.title = title;\n  }\n  // or simply variable assigment with type anotation\n  title: string = title;\n}\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">implements</code></p>\n\n<p>Type\nHero[] is array of Hero\n? optional</p>\n\n<p>https://www.youtube.com/watch?v=-PR_XqW9JJU</p>\n"
    } ,
  
    {
      "title"    : "Angular 4 And Beyond",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/08/10/angular-4-and-beyond/",
      "date"     : "2017-08-10 00:00:00 +0200",
      "content"  : "<h1 id=\"install\">Install</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install -g @angular/cli\nng help | more\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ng new myapp --style=scss\ncd myapp\nng serve\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn add sass @types/lodash ngrx\nyarn add bootstrap@4 --dev\n</code></pre></div></div>\n\n<p><em>Presentation components</em> are used only for how things look. and <em>container\ncomponents</em> how thinks works they provide data and behavior to other components\n(never have any styles)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ng generate component card --inline-template --inline-style --dry-run\n</code></pre></div></div>\n\n<h1 id=\"html-templates\">HTML templates</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">{ { title }}</code> interpolation of title (which is component property),</li>\n  <li><code class=\"highlighter-rouge\">&lt;script&gt;</code> is ignored and statements can’t refer to <code class=\"highlighter-rouge\">window</code> or <code class=\"highlighter-rouge\">console.log</code></li>\n  <li>in interpolation (both expression and statements) you can not use <code class=\"highlighter-rouge\">new</code>,<code class=\"highlighter-rouge\">++</code>\nor <code class=\"highlighter-rouge\">+=</code>. This is not allowed since it has side effects.</li>\n  <li>\n    <p>difference between HTML attributes and DOM property is that attribute only\ninitialize DOM properties, so attributes can’t be changed (initial value of\ninput), but properties (current value) can. So in Angular we do only with\nproperties.\nBinding targets can be: element, component, directive. There are 5 type of\nbinding:</p>\n  </li>\n  <li><strong>[property]=expression</strong> (<code class=\"highlighter-rouge\">bind-property</code>) set img src <code class=\"highlighter-rouge\">&lt;img\n[src]=\"heroImageUrl\"&gt;</code>, disable <code class=\"highlighter-rouge\">&lt;button\n[disabled]=\"isUnchanged\"&gt;Cancel&lt;/button&gt;</code>, passing value <code class=\"highlighter-rouge\">&lt;hero-detail\n[hero]=\"currentHero\"&gt;&lt;/hero-detail&gt;</code>.\n    <ul>\n      <li>you should not use property binding to call a method that has side effect</li>\n      <li>angular first check if the name is property of known directive <code class=\"highlighter-rouge\">&lt;div\n[ndClass]=\"classes\"&gt;&lt;/div&gt;</code> or reports “unnknown directive” error</li>\n      <li>Context of the expression is instance of component, or some property of\ntemplate’s context like <em>template input variable</em> <code class=\"highlighter-rouge\">&lt;div *ngFor=\"let hero of\nheroes\"&gt;&lt;/div&gt;</code> and <em>template reference variable</em> <code class=\"highlighter-rouge\">&lt;input\n#heroInput&gt;</code>. So there are three namespaces: template\nvariable, directive’s <em>context</em> object and compoments’s member name.</li>\n      <li>tips: Always use simple property name or method call (with eventual <code class=\"highlighter-rouge\">!</code>),\nuse component definition to define business logic.</li>\n    </ul>\n  </li>\n  <li><strong>(event)=statement</strong> (<code class=\"highlighter-rouge\">on-event</code>) <code class=\"highlighter-rouge\">&lt;button (click)=\"onSave()\")&lt;/button&gt;\"</code>\n    <ul>\n      <li>template statement usually have side effect (while template expression not)</li>\n      <li>In this event binding like <code class=\"highlighter-rouge\">(click)=\"onSelect(hero)\"</code> statement context is\ntypicaly <em>component instance</em>, but also can be templates own context\n(<code class=\"highlighter-rouge\">$event</code>, template input variable, template reference variable)</li>\n      <li><code class=\"highlighter-rouge\">$event</code> store info about event (if it is navite DOM than you can use\n<code class=\"highlighter-rouge\">$event.target.value</code>, if it belongs to directive than it could be anything)</li>\n      <li>statements allow assignment <code class=\"highlighter-rouge\">=</code> and chaining <code class=\"highlighter-rouge\">;</code> <code class=\"highlighter-rouge\">,</code>, but dont allow\ntemplate epression operators (<code class=\"highlighter-rouge\">|</code> <code class=\"highlighter-rouge\">?.</code> <code class=\"highlighter-rouge\">!</code>)</li>\n    </ul>\n  </li>\n  <li><strong>event and property</strong>  two way bindings <code class=\"highlighter-rouge\">&lt;input [(ngModel)]=\"name\"&gt;</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">&lt;input #heroName /&gt; &lt;button (click)=\"add(heroName.value); heroName.value=''\"&gt;Add&lt;/button&gt;</code> creates local variable <code class=\"highlighter-rouge\">heroName</code> that provides access to <code class=\"highlighter-rouge\">input</code> element instance in all data and event binding expressions in current template.</p>\n  </li>\n  <li><strong>attribute</strong> (exception) <code class=\"highlighter-rouge\">&lt;button [attr.aria-label]=\"help\"&gt;help&lt;/button&gt;</code></li>\n  <li><strong>class.name</strong> property <code class=\"highlighter-rouge\">&lt;div [class.special]=\"isSpecial\"&gt;&lt;/div&gt;</code> class\nbinding is used to add and remove <em>single</em> class.</li>\n  <li>\n    <p><strong>style.name</strong> property <code class=\"highlighter-rouge\">&lt;button [style.color]=\"isSpecial ? 'red' : 'green'\"&gt;</code></p>\n  </li>\n  <li><code class=\"highlighter-rouge\">*ngFor='let hero of heroes'</code> iterate over items\n<a href=\"https://angular.io/api/common/NgForOf\">NgForOf</a> in angular 4</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">*ngif='heroes.lenght &gt; 3'</code> add or remove from the DOM</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">[(ngModel)]=\"currentHero.name\"</code> (banana in a box) is part of <code class=\"highlighter-rouge\">FormsModule</code>\nfrom <code class=\"highlighter-rouge\">@angular/forms</code> it is the same as\n<code class=\"highlighter-rouge\">(input)=\"currentHero.name=$event.target.value\"</code> and\n<code class=\"highlighter-rouge\">[value]=\"currentHero.name\"</code>.</li>\n</ul>\n\n<p>Redisplay occurs when some async event related to view occurs: keystroke, timer\nor response to HTTP request.</p>\n\n<h1 id=\"component\">Component</h1>\n\n<p>For new components, you need to declare in <code class=\"highlighter-rouge\">@NgModule({declarations:\nHeroDetailComponent]})</code>, accept input <code class=\"highlighter-rouge\">@Input() hero: Hero</code>.</p>\n\n<p><a href=\"https://angular.io/guide/lifecycle-hooks\">lifecycle hooks</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import { OnInit } from '@angular/core';\n\nexport class AppComponent implements OnInit {\n  ngOnInit(): void {\n  }\n}\n</code></pre></div></div>\n\n<h1 id=\"service\">Service</h1>\n\n<p>Add to constructor <code class=\"highlighter-rouge\">constructor(private heroService: HeroService) { }</code> and to\n<code class=\"highlighter-rouge\">@Component({providers: [HeroService]})</code>. You can call service inside component\nwith <code class=\"highlighter-rouge\">this.heroService.getHeroes()</code>.\nIf you move service to <code class=\"highlighter-rouge\">@ngModule({providers: [HeroService]})</code> than every\ncomponent has access to it. Singleton <code class=\"highlighter-rouge\">HeroService</code> instance is created.</p>\n\n<h1 id=\"routing\">Routing</h1>\n\n<p><a href=\"https://angular.io/guide/router\">https://angular.io/guide/router</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">&lt;router-outlet&gt;&lt;/router-outlet&gt;</code> is where to show a component</li>\n  <li><code class=\"highlighter-rouge\">&lt;a routerLink=\"/heroes\"&gt;Heroes&lt;/a&gt;</code> is used</li>\n</ul>\n\n<p>To get params use</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import { ActivatedRoute, ParamMap } from '@angular/router';\nimport { Location }                 from '@angular/common';\nimport 'rxjs/add/operator/switchMap';\nexport class HeroDetailComponent implements OnInit {\n  constructor(\n    private heroService: HeroService,\n    private route: ActivatedRoute,\n    private location: Location\n  ) {\n  }\n  ngOnInit(): void {\n    this.route.paramMap\n      .switchMap((params: ParamMap) =&gt; this.heroService.getHero(+params.get('id')))\n      .subscribe(hero =&gt; this.hero = hero);\n  }\n  goBack(): void {\n    this.location.back();\n  }\n}\n</code></pre></div></div>\n\n<p>To navigate using js</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  constructor(\n    private router: Router\n  ) { }\n  viewDetails(hero: Hero): void {\n    this.router.navigate(['/detail', hero.id]);\n  }\n</code></pre></div></div>\n\n<h1 id=\"httpmodule\">HttpModule</h1>\n\n<p>To use mock web api install:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install angular-in-memory-web-api --save\n</code></pre></div></div>\n\n<h1 id=\"dependency-injection\">Dependency injection</h1>\n\n<p><a href=\"https://angular.io/guide/dependency-injection\">https://angular.io/guide/dependency-injection</a>\nClass is available when you register a class with <code class=\"highlighter-rouge\">@Injectable()</code>.\nYou can register a provider within <code class=\"highlighter-rouge\">@NgModule</code> or in component’s <code class=\"highlighter-rouge\">providers: []</code>\nproperty. If it is registered on component, than it is available to that\ncomponent and children component (all components that are included in template\nmarkup, or navigating with router).\nThe component must ask for service in its constructor (type anotation will\ndetermine what to inject).</p>\n\n<p>Always use <code class=\"highlighter-rouge\">@Injectable()</code> for services (event they do not have any\ndependency). <code class=\"highlighter-rouge\">@Component</code> is subtype of <code class=\"highlighter-rouge\">@Injectable()</code> so you do need that for\ncomponents.</p>\n\n<p><code class=\"highlighter-rouge\">providers: [Logger]</code> is the same as <code class=\"highlighter-rouge\">providers: [{provide: Logger, useClass:\nLogger}]</code>. First value is a key, a second is a class (could be some other\n<code class=\"highlighter-rouge\">BetterLogger</code>).</p>\n\n<h1 id=\"rxjs\">RxJS</h1>\n\n<p>A <strong>Subject</strong> is a producer of an observable event stream.</p>\n\n"
    } ,
  
    {
      "title"    : "GraphQL",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/07/11/graphql/",
      "date"     : "2017-07-11 00:00:00 +0200",
      "content"  : "<p>http://graphql.org/learn</p>\n\n<h1 id=\"queries\">Queries</h1>\n\n<p>Fields can be string or array, or object (than you can make subselection).\nYou can pass arguments to fields (like <code class=\"highlighter-rouge\">id: 1</code>). Argument can be Enumeration\ntype.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  # queries can have comments\n  human(id: 1) {\n    name\n    height(unit: METER)\n  }\n}\n</code></pre></div></div>\n\n<p>response is</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"data: {\n    \"hero\": {\n      \"name\": \"My name\",\n      \"height\": 4\n    }\n  }\n</code></pre></div></div>\n\n<p>If you need several items than you can use aliases</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  importantHuman: human(id:1) {\n    name\n  }\n}\n</code></pre></div></div>\n\n<p>For each alias you can include same set of <code class=\"highlighter-rouge\">credentialsFields</code> with named\nfragments</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  niceHuman: human(id: 2) {\n  ...credentialsFields\n  }\n  importantHuman: human(id:1) {\n    ... on Character {\n      name\n    }\n  }\n  fragment credentialsFields on Character {\n    name\n  }\n</code></pre></div></div>\n\n<p>Named fragment <code class=\"highlighter-rouge\">credentialsFields</code> is included only on type <code class=\"highlighter-rouge\">Character</code> since it\nis defined on it. For importantHuman we used inline fragment.</p>\n\n<h1 id=\"variables\">Variables</h1>\n\n<p>Query can have dynamic params which are interpolated on server. Variables has\nprefix $ and is followed by type.\nType can be (<code class=\"highlighter-rouge\">Episode</code> is type): scalar, enum or input object type.\nIf type ends with <code class=\"highlighter-rouge\">!</code> than variable is required (otherwise optional).\nVariables can have default type.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>query HeroNameAndFriends($episode: Episode = 'Default Value')\n  hero(episode: $episode) {\n    name\n    friends {\n      name\n    }\n  }\n</code></pre></div></div>\n\n<p>Additional JSON</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"episode\": \"My Episode\"\n}\n</code></pre></div></div>\n\n<h1 id=\"directives\">Directives</h1>\n\n<p>Dinamically include fields with <code class=\"highlighter-rouge\">@include(if: $my_var)</code> or <code class=\"highlighter-rouge\">@skip(if: ...)</code>.\nThis was we can conditionally add some fields.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>query Hero($episode: Episode, $withFriends: Boolean!) {\n  hero(episode: $episode) {\n    name\n    friends @include(if: $withFriends) {\n      name\n    }\n  }\n}\n</code></pre></div></div>\n\n<h1 id=\"introspection\">Introspection</h1>\n\n<p><a href=\"http://graphql.org/learn/introspection/\">learn</a>\nWhen searching results could be union of types, so to determine which type you\ncan request also <code class=\"highlighter-rouge\">__typename</code> meta field which will show name of object type.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  search(text: 'an') {\n    __typename\n    name\n    ... on Human {\n      name\n    }\n    ... on Droid {\n      name\n    }\n  }\n}\n</code></pre></div></div>\n\n<p>returns</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"data\": {\n    \"search\": [\n      {\n        \"__typename\": \"Human\",\n        \"name\": \"My name\"\n      },\n      {\n        \"__typename\": \"Droid\"\n        \"name\": \"My droid name\"\n      }\n    ]\n  }\n}\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">__schema</code> is used to see what types are available:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  __schema {\n    types {\n      name\n    }\n  }\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"data\": {\n    \"__schema\": {\n      \"types\": [\n        {\n          \"name\": \"Query\"\n        },\n        {\n          \"name\": \"Episode\"\n        },\n        {\n          \"name\": \"__Schema\"\n        }\n      }\n    }\n  }\n}\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">queryType.name</code> will return root, probably <code class=\"highlighter-rouge\">Query</code>.\nFor <code class=\"highlighter-rouge\">__type</code> we can ask:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">kind</code> returns <code class=\"highlighter-rouge\">__TypeKind</code> enum: OBJECT, INTERFACE, SCALAR, NOT_NULL, LIST</li>\n  <li><code class=\"highlighter-rouge\">fields</code> returns list or fields, if you have <code class=\"highlighter-rouge\">NOT_NULL</code> and <code class=\"highlighter-rouge\">LIST</code> you can use\n<code class=\"highlighter-rouge\">ofType</code> to get into exact type</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code></code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">__type, __fields</code></p>\n\n<h1 id=\"schemas-and-types\">Schemas and types</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  hero {\n    name\n    appearsIn\n  }\n}\n</code></pre></div></div>\n\n<p>Select <code class=\"highlighter-rouge\">hero</code> field on <code class=\"highlighter-rouge\">root</code> object and select <code class=\"highlighter-rouge\">name</code> and <code class=\"highlighter-rouge\">appearsIn</code> on\n<code class=\"highlighter-rouge\">hero</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>type Character {\n  name: String!\n  appearsIn: [Episode]!\n  length(unit: LengthUnit = METER): Float\n}\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">Character</code> is grapqh object type. <code class=\"highlighter-rouge\">name</code> is fiels on <code class=\"highlighter-rouge\">Character</code> type. With <code class=\"highlighter-rouge\">!</code>\nmeans that it is not nullable, its always string. <code class=\"highlighter-rouge\">appearsIn</code> is always array\n(could be empty). <code class=\"highlighter-rouge\">length</code> field has argument <code class=\"highlighter-rouge\">unit</code> and its optional (<code class=\"highlighter-rouge\">METER</code>\nis default value).</p>\n\n<p>Scalar types are: <code class=\"highlighter-rouge\">Int</code> (signed 32 bit integer), <code class=\"highlighter-rouge\">Float</code>,<code class=\"highlighter-rouge\">String</code>, <code class=\"highlighter-rouge\">Boolean</code> and\n<code class=\"highlighter-rouge\">ID</code>.\nEnumeration types (Enums) are restricted to a set of allowed values. Use string\nname, similar to constants.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>enum Episode {\n  NEWHOPE\n  EMPIRE\n  JEDI\n}\n</code></pre></div></div>\n\n<p>Object type, scalars and enums are only kind of types that you can define. There\nare two type modifiers that affect validation:</p>\n\n<ul>\n  <li>exclamation mark <code class=\"highlighter-rouge\">!</code> (non null value) can be used also in query</li>\n  <li>list <code class=\"highlighter-rouge\">[]</code></li>\n</ul>\n\n<p>When writing query we need to go down to scalar types (can’t ask for field\n<code class=\"highlighter-rouge\">hero</code>).</p>\n\n<p>Interface is abstract type that includes set of fields that a type must include\nto implement interface. Beside fields, also return types must match.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>interface Character {\n  id: ID!\n  name: String!\n  friends: [Character]\n  appearsIn: [Episode]!\n}\n</code></pre></div></div>\n\n<p>Example implementation</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>type Droid implements Character {\n  id: ID!\n  name: String!\n  friends: [Character]\n  appearsIn: [Episode]!\n  someOtherDroidField: String\n}\n</code></pre></div></div>\n\n<p>To ask specific object you need to use Inline fragments\nInline fragments check if returned type of hero (hero is type <code class=\"highlighter-rouge\">Character</code>) is\nDroid or Human. For <code class=\"highlighter-rouge\">hero</code> you can only ask for fields that exists on\n<code class=\"highlighter-rouge\">Character</code> interface. But for specific <code class=\"highlighter-rouge\">Droid</code> fiels you can use inline\nframents</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>query HeroForEpisode($ep: Episode!) {\n  hero(episode: $ep) {\n    name\n    ... on Droid {\n      primaryFunction\n    }\n    ... on Human {\n      height\n    }\n  }\n}\n</code></pre></div></div>\n\n<p>Union type defines possible types. Note that you can’t create union type out of\nother union type or interface.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>union SearchResult = Human | Droid\n</code></pre></div></div>\n\n<h1 id=\"mutations\">Mutations</h1>\n\n<p>Input types looks exactly the same as regular object types with keyword <code class=\"highlighter-rouge\">input</code>.\nThey are used as arguments in mutations</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>input ReviewInput {\n  stars: Int!\n  commentary: String\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mutation CreateReviewForEpisode($ep: Episode!, $review: ReviewInput!) {\n  createReview(episode: $ep, review: $review) {\n    stars\n    commentary\n  }\n}\n</code></pre></div></div>\n\n<p>data</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"ep\": \"Episode Jedi\",\n  \"review\": {\n    \"stars\": 5,\n    \"commentary\": \"My comment\"\n  }\n}\n</code></pre></div></div>\n\n<p>Mutation run in sequence, one by one (query run in parallel). Data fields are\nwithout <code class=\"highlighter-rouge\">$</code>.</p>\n\n<h1 id=\"root-fields-and-resolvers\">Root fields and resolvers</h1>\n\n<p>Root type or Query type represents all possible entry points. Resolver receive\nthree params:</p>\n\n<ul>\n  <li>obj: previous object (not used on root Query type)</li>\n  <li>args: arguments provided in query</li>\n  <li>context: used for db and authentication</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Query: {\n  human(obj, arg, context) {\n    return context.db.loadHumanById(agrs.id).then(\n      userData =&gt; new Human(userData)\n    }\n  }\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Human: {\n  name(obj, args, context) {\n    return obj.name\n  }\n}\n</code></pre></div></div>\n\n<h1 id=\"testing\">Testing</h1>\n\n<p>https://youtu.be/QHoddukdqf0?t=1918</p>\n\n<p>Permissions:</p>\n\n<p>live queries\nsubscriptions</p>\n\n<p>We get data with GET request and send sada with POST request with <code class=\"highlighter-rouge\">query</code> param.\nOnly problem could be caching since we need different strategy for caching.</p>\n\n<p>https://github.com/chentsulin/awesome-graphql\nhttps://www.netguru.co/blog/grapghql-vs-rest\nhttps://www.howtographql.com/\nhttps://www.compose.com/articles/use-all-the-databases-part-1/\nhttps://www.youtube.com/watch?v=UBGzsb2UkeY&amp;feature=youtu.be\nhttps://blog.codeship.com/how-to-implement-a-graphql-api-in-rails/\nhttp://graphqlme.com/2017/09/16/upload-images-to-s3-in-graphql-using-rails-and-paperclip/</p>\n"
    } ,
  
    {
      "title"    : "Move Index opensource",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/06/16/move-index/",
      "date"     : "2017-06-16 00:00:00 +0200",
      "content"  : "<h1 id=\"opensource\">Opensource</h1>\n\n<p><a href=\"https://gist.github.com/PurpleBooth/109311bb0361f32d87a2\">README template</a>\nFrom it link to CONTRIBUTING and LICENSE files.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>## Contributing\n\nPlease read [CONTRIBUTING.md](CONTRIBUTING.md) for details on our code of\nconduct, and the process for submitting pull requests to us.\n\n## License\n\nThis project is licensed under the MIT License - see the [LICENSE.md](LICENSE.md) file for details.\n</code></pre></div></div>\n\n<p>Look for example\nhttps://github.com/duleorlovic/premesti.se/blob/master/CONTRIBUTING.md</p>\n\n<p>You can create ISSUE_TEMPLATE and PULL_REQUEST_TEMPLATE files so they have\nsimilar title, body labels… Also you can use ISSUE_TEMPLATE folder with custom\ntemplate file which is referenced in URL query.\n<a href=\"https://help.github.com/articles/about-automation-for-issues-and-pull-requests-with-query-parameters/\">https://help.github.com/articles/about-automation-for-issues-and-pull-requests-with-query-parameters/</a></p>\n\n<h1 id=\"todo\">TODO</h1>\n\n<p><a href=\"https://opensource.guide/starting-a-project/#launching-your-own-open-source-project\">https://opensource.guide/starting-a-project/#launching-your-own-open-source-project</a></p>\n\n<p>android ethernet so battery lasts longer without wifi\n<a href=\"https://play.google.com/store/apps/details?id=xda.usbhost.test&amp;hl=en\">https://play.google.com/store/apps/details?id=xda.usbhost.test&amp;hl=en</a></p>\n\n<p>codeclimate is free for opensource.</p>\n\n<p>https://medium.com/libraries-io/what-does-a-sustainable-open-source-project-look-like-bf9b8cf824f8</p>\n\n<p>Show our API using PostMan\nhttp://pages.getpostman.com/API-Network-Inclusion_Join.html</p>\n\n<p>Three ways to improve the sustainability of open source projects\nhttps://tidelift.com/blog/2018/1/8/three-ways-to-improve-the-sustainability-of-open-source-projects</p>\n\n<p>https://blog.phusion.nl/2018/03/21/how-to-win-friends-and-open-source-your-software/</p>\n"
    } ,
  
    {
      "title"    : "Vim theory",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/06/05/vim-theory/",
      "date"     : "2017-06-05 00:00:00 +0200",
      "content"  : "<h1 id=\"lean-vim-script-the-hard-way\">Lean Vim Script The Hard Way</h1>\n\n<p><a href=\"http://learnvimscriptthehardway.stevelosh.com/\">http://learnvimscriptthehardway.stevelosh.com/</a></p>\n\n<h2 id=\"mappings\">Mappings</h2>\n\n<p>maping keys <code class=\"highlighter-rouge\">:noremap &lt;newkeys&gt; &lt;keynames&gt;</code></p>\n\n<ul>\n  <li>since mappings easilly could be broken, ALWAYS use <code class=\"highlighter-rouge\">nore</code> non recursive\nvariant <code class=\"highlighter-rouge\">noremap</code>, <code class=\"highlighter-rouge\">nnoremap</code> … so it use default meanings of keynames</li>\n  <li>you can map control CTRL key, for example <code class=\"highlighter-rouge\">:map &lt;c-d&gt; dd</code></li>\n  <li>do not use comments <code class=\"highlighter-rouge\">\"</code> in mapping</li>\n  <li><code class=\"highlighter-rouge\">nmap</code> normal, <code class=\"highlighter-rouge\">vmap</code> visual, <code class=\"highlighter-rouge\">imap</code> insert, <code class=\"highlighter-rouge\">omap</code> operator, <code class=\"highlighter-rouge\">cmap</code> command,\n<code class=\"highlighter-rouge\">xmap</code> (do not know) mode.\nDor example in insert mode <code class=\"highlighter-rouge\">:imap &lt;esc&gt;ddi</code></li>\n  <li>remove mappings <code class=\"highlighter-rouge\">:unmap &lt;key&gt;</code> or <code class=\"highlighter-rouge\">nunmap</code></li>\n  <li>you can map two keys, for example <code class=\"highlighter-rouge\">:map -d dd</code></li>\n  <li>change leader key <code class=\"highlighter-rouge\">:let mapleader = \"-\"</code> so you can write <code class=\"highlighter-rouge\">:map &lt;leader&gt;d dd</code>\n(note that it does not have effect for already defined mappings)</li>\n  <li><code class=\"highlighter-rouge\">:let maplocalleader = \"\\\"</code> can be used for mapings only for local buffer.\nMapping can be for specific buffer (file) <code class=\"highlighter-rouge\">:nnoremap &lt;buffer&gt; &lt;leader&gt;d dd</code>. You\ncan use both <code class=\"highlighter-rouge\">:nnoremap &lt;buffer&gt; &lt;localleader&gt;d dd</code></li>\n</ul>\n\n<h2 id=\"abbreviations\">Abbreviations</h2>\n\n<p>Abbreviations are similar to mappings but for insert, replace and command mode</p>\n\n<p><code class=\"highlighter-rouge\">:iabbrev adn and</code> this will replace <code class=\"highlighter-rouge\">adn&lt;non-keyword-character&gt;</code> with <code class=\"highlighter-rouge\">and</code>\nDifference between <code class=\"highlighter-rouge\">map</code> is that map does not count for non-keyword-character</p>\n\n<p><code class=\"highlighter-rouge\">:iabbrev &lt;buffer&gt; --- &amp;mdash;</code> will replace <code class=\"highlighter-rouge\">---</code> with <code class=\"highlighter-rouge\">&amp;mdash</code> but only for\ncurrent buffer. It is <code class=\"highlighter-rouge\">&lt;buffer&gt;</code> local abbreviation and is usefull when you want\nsomething only for specific type, for example <code class=\"highlighter-rouge\">:autocmd FileType javascript\n:iabbrev &lt;buffer&gt; iff if ()&lt;left&gt;</code> will enable little snippet only for js.</p>\n\n<h2 id=\"autocommands\">Autocommands</h2>\n\n<p>Autocommands are used to run commands on specific events</p>\n\n<p><code class=\"highlighter-rouge\">:autocmd BufNewFile * :write</code>.</p>\n\n<p>First param is event and can be something of: entering insert mode, not pressing\na key for some time. It can can combine, usually <code class=\"highlighter-rouge\">BufNewFile,BufRead</code> for all\nopen files, existing or not. Some events <code class=\"highlighter-rouge\">:help autocmd-events</code></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">BufNewFile</code> when you open new files not saved to disk</li>\n  <li><code class=\"highlighter-rouge\">BufRead</code> after you open existing file</li>\n  <li><code class=\"highlighter-rouge\">BufWritePre</code> just before write</li>\n  <li><code class=\"highlighter-rouge\">FileType</code> when vim sets filetype\n    <ul>\n      <li><code class=\"highlighter-rouge\">:autocmd FileType javascript nnoremap &lt;buffer&gt; &lt;localleader&gt;c I//&lt;esc&gt;</code></li>\n    </ul>\n  </li>\n</ul>\n\n<p>Second param is “pattern” that filter more specific: for example: <code class=\"highlighter-rouge\">*.txt</code> is\nonly triggered for txt files</p>\n\n<p>Last part is command that is executed.</p>\n\n<p>You can group autocommands (<code class=\"highlighter-rouge\">autocmd!</code> is to clear)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>augroup filetype_html\n    autocmd!\n    autocmd FileType html nnoremap &lt;buffer&gt; &lt;localleader&gt;f Vatzf\naugroup END\n</code></pre></div></div>\n\n<h2 id=\"operator-pending-mappings\">Operator pending mappings</h2>\n\n<p>Operator is command waiting for movement command and than executes. For example\n<code class=\"highlighter-rouge\">d</code>, <code class=\"highlighter-rouge\">y</code> and <code class=\"highlighter-rouge\">c</code> are waiting for movements: <code class=\"highlighter-rouge\">dt,</code> (delete till ,), <code class=\"highlighter-rouge\">ci(</code> (change\ninner (), <code class=\"highlighter-rouge\">yw</code> (yank word).\nWe can remap movement keys for operator mode <code class=\"highlighter-rouge\">:onoremap p i(</code> (inner braces,\nselect parametars), or <code class=\"highlighter-rouge\">:onoremap b /end&lt;cr&gt;</code> (block, until end).\nIf you want to select before or some block after current position you can\nvisualy select and it will be executed on that selection.\nFor example, change params while current is on current line before params:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>onoremap in( :&lt;c-u&gt;normal! f(vi(&lt;cr&gt;\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">:normal!</code> means that it simulate pressing in normal mode. <code class=\"highlighter-rouge\">&lt;cr&gt;</code> at the end\nexecutes <code class=\"highlighter-rouge\">:normal!</code> command. You can indent from command mode: <code class=\"highlighter-rouge\">:normal &gt;&gt;</code>\n<code class=\"highlighter-rouge\">&lt;c-u&gt;</code> needs to remove the range that vim may insert.</p>\n\n<p><code class=\"highlighter-rouge\">:execute</code> takes vimscript string and performs as command, <code class=\"highlighter-rouge\">:execute \"write\"</code>.\nIt is used since <code class=\"highlighter-rouge\">:normal</code> can not recognize special characters like <code class=\"highlighter-rouge\">&lt;cr&gt;</code>.\n<code class=\"highlighter-rouge\">execute</code> will substitute any special charactes before running string, special\nchars are <code class=\"highlighter-rouge\">:help expr-quote</code></p>\n<ul>\n  <li><code class=\"highlighter-rouge\">\\r</code> return <code class=\"highlighter-rouge\">&lt;CR&gt;</code></li>\n  <li><code class=\"highlighter-rouge\">\\n</code> new line <code class=\"highlighter-rouge\">&lt;NL&gt;</code>\nFor example change current title header in markdown text with <code class=\"highlighter-rouge\">cih</code>:</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:onoremap ih :&lt;c-u&gt;execute \"normal! ?^==\\\\+$\\r:nohlsearch\\rkvg_\"&lt;cr&gt;`\n</code></pre></div></div>\n\n<h2 id=\"status-line\">Status Line</h2>\n\n<p><code class=\"highlighter-rouge\">:set statusline=%f\\ -\\ FileType:\\ %y</code> will change status line to show</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">%f</code> path to the file</li>\n  <li><code class=\"highlighter-rouge\">%F</code> full path to the file</li>\n  <li><code class=\"highlighter-rouge\">%y</code> filetype of the file</li>\n  <li><code class=\"highlighter-rouge\">%L</code> total lines</li>\n</ul>\n\n<h2 id=\"variables\">Variables</h2>\n\n<ul>\n  <li>print env variables on command line: <code class=\"highlighter-rouge\">:echo $MYVIMRC</code> or <code class=\"highlighter-rouge\">:echo filetype?</code>.\n <code class=\"highlighter-rouge\">:echom $PATH</code> will save output into <code class=\"highlighter-rouge\">:messages</code> so you can view later</li>\n  <li>to set variable use <code class=\"highlighter-rouge\">:let foo = \"bar\"</code> and pring <code class=\"highlighter-rouge\">:echo foo</code></li>\n  <li>to set option you can use <code class=\"highlighter-rouge\">:set xxx</code> or <code class=\"highlighter-rouge\">:set xxx=value</code> or <code class=\"highlighter-rouge\">:let &amp;xxx=value</code>\nTo unset <code class=\"highlighter-rouge\">:set noxxx</code> or <code class=\"highlighter-rouge\">:set xxx!</code>. To check if it is set <code class=\"highlighter-rouge\">:set xxx?</code> or\n<code class=\"highlighter-rouge\">:echo &amp;xxx</code>. For boolean options <code class=\"highlighter-rouge\">1</code> is true and <code class=\"highlighter-rouge\">0</code> is false. <code class=\"highlighter-rouge\">:let</code> is more\npowerfull than <code class=\"highlighter-rouge\">:set</code> since it can use math and other operations.\nIf you have space inside value than you need to escape <code class=\"highlighter-rouge\">set xxx+=my\\ value</code></li>\n  <li>to set registers run <code class=\"highlighter-rouge\">let @a = \"hello\"</code> so you can paste <code class=\"highlighter-rouge\">\"ap</code>. To read\nregister run <code class=\"highlighter-rouge\">:echo @a</code> (<code class=\"highlighter-rouge\">:echo @\"</code> is unnamed yank register, <code class=\"highlighter-rouge\">:echo @\\ </code> is\nsearch register … <code class=\"highlighter-rouge\">:help registers</code>).</li>\n  <li>to get current value you can use <code class=\"highlighter-rouge\">=</code> and <code class=\"highlighter-rouge\">&lt;TAB&gt;</code> for example <code class=\"highlighter-rouge\">:set xxx=</code> and\npress tab so vim autocomplete the value so you can edit it. Or you can press\nenter after the name (skip equal sign), for example <code class=\"highlighter-rouge\">:se ft&lt;cr&gt;</code></li>\n</ul>\n\n<p>Local scope variables are with prefix like <code class=\"highlighter-rouge\">:let b:a=2</code> (<code class=\"highlighter-rouge\">b:</code> buffer, <code class=\"highlighter-rouge\">w:</code>\nwindow, <code class=\"highlighter-rouge\">t:</code> tab, <code class=\"highlighter-rouge\">g:</code> global, <code class=\"highlighter-rouge\">l:</code> local to function, <code class=\"highlighter-rouge\">a:</code> argument)</p>\n\n<p><code class=\"highlighter-rouge\">:setlocal nowrap</code> is only for current buffer (file), when you open another\nfile (inside same window) it will not have nowrap. If you have same mappings\nthan local will be chosen since it is more specific.</p>\n\n<p>Multiline commands can be written as:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:echom \"foo\" | echom \"bar\"\n\n\" or\n\n:augroup testgroup\n:   autocmd BufWrite * :echom \"Baz\"\n:autgroup END\n</code></pre></div></div>\n\n<p>Conditional</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>: if 0\n:   echom \"not possible\"\n: elsif \"also_zero0\"\n:  echom \"also 0\"\n: elsif \"1one\" - 1\n:   echom \"also zero value\"\n: elsif \"zero1\" + \"1one\"\n:   echom \"finally\"\n: else\n: end\n</code></pre></div></div>\n\n<p>Vim is by default ignorecase but it can be changed. There are casa insensitive\nand case sensitive equal operator regardless of <code class=\"highlighter-rouge\">ignorecase</code> setting (so you use\nthat in your scripts <code class=\"highlighter-rouge\">:help expr4</code>):</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:if \"Asd\" == \"asd\" | echo \"case insensitive equal\" | end\n:set noignorecase\n:if \"Asd\" != \"asd\" | echo \"case sensitive different\" | end\n\n:if \"Asd\" ==? \"asd\" | echo \"case insensitive different\" | end\n:if \"Asd\" !=# \"asd\" | echo \"case sensitive equal\" | end\n</code></pre></div></div>\n\n<p>Functions must start with capital if they are unscoped.\nParameters are always pefixed with <code class=\"highlighter-rouge\">a:</code> (argument scope).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:function MyFuction(name)\n: let result = \"hi \" . a:name\n: return result\n:endfunction\n\n:call MyFunction(\"Duke\") \" when there is no return. default return is 0\n:echom MyFunction(\"Duke\")\n</code></pre></div></div>\n\n<p>Variable types can be:</p>\n\n<ul>\n  <li>numbers <code class=\"highlighter-rouge\">100</code>, <code class=\"highlighter-rouge\">0xff</code> (hex representation), <code class=\"highlighter-rouge\">010</code> (octal representation)</li>\n  <li>float <code class=\"highlighter-rouge\">100.1</code>, <code class=\"highlighter-rouge\">1.001e+2</code> (e notation, decimal is required). For division to\nwork in float you need to use float as one of params (type cast, coercion of\nsecond param is automatic) <code class=\"highlighter-rouge\">echo 3/2.0</code></li>\n  <li>\n    <p>string <code class=\"highlighter-rouge\">\"asd\"</code>, Concatenation is with dot <code class=\"highlighter-rouge\">.</code> (<code class=\"highlighter-rouge\">+</code> is only for numbers).\nSpecial characters: <code class=\"highlighter-rouge\">\\\\</code>, <code class=\"highlighter-rouge\">\\\"</code>, <code class=\"highlighter-rouge\">\\n</code></p>\n\n    <p>26</p>\n  </li>\n</ul>\n\n<p>TODO \nhttps://github.com/mhinz/vim-galore</p>\n\n<h1 id=\"shell-script\">Shell script</h1>\n\n<p>Calling external shell script is with bang <code class=\"highlighter-rouge\">:!pwd</code>. When you visually select it\noperates on lines and use it as argument, for example select multuple lines and\nrun <code class=\"highlighter-rouge\">:'&lt;,'&gt;!sort</code> to sort them.\nIf nothing is selected, last selected visual line (whole line) is used.\nYou can use <code class=\"highlighter-rouge\">cat</code> to pass argument. For example run <code class=\"highlighter-rouge\">:'&lt;,'&gt;!echo 1</code>cat<code class=\"highlighter-rouge\">2</code>, and\nit will replace whole line by inserting 1…line…2.\nAnother way to pass is using <code class=\"highlighter-rouge\">system(\"echo \", @\")</code> unnamed register.</p>\n\n<p>To work on part of a line, you can use visual match replacement\n<code class=\"highlighter-rouge\">:'&lt;,'&gt;s/\\%V.*\\%V/\\=system('echo -n \"the result\"')</code>.\nTo use visual selected text as inputs, you can do it manually by pasting with\n<code class=\"highlighter-rouge\">&lt;C-R&gt;</code> + <code class=\"highlighter-rouge\">\"</code> (“ is a standard register for yanking).\nOr you can use helper function that will yank to register and get register\nhttps://stackoverflow.com/questions/12805922/vim-vmap-send-selected-text-as-parameter-to-function</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>func! GetSelectedText()\n  normal gv\"xy\n  let result = getreg(\"x\")\n  normal gv\n  return result\nendfunc\n\nvnoremap &lt;F6&gt; :call MyFunc(GetSelectedText())&lt;cr&gt;\n</code></pre></div></div>\n\n<p>https://stackoverflow.com/questions/9637921/vim-filter-only-visual-selection-not-the-entire-line</p>\n\n<h1 id=\"translate\">Translate</h1>\n\n<p>Run scripts on visual selection and change with output. I use <code class=\"highlighter-rouge\">translate.rb</code> and\n<code class=\"highlighter-rouge\">sudo ln -s /home/orlovic/config/ruby/translate.rb /usr/local/bin/</code> and\n<code class=\"highlighter-rouge\">chmod +x ~/config/ruby/translate.rb</code> https://github.com/duleorlovic/config/blob/master/ruby/translate.rb\nIn vim there is a <a href=\"https://github.com/duleorlovic/config/blob/master/.vimrc#L482\">ProgramFilter function</a></p>\n\n<p>There is an issue with ending space (at the end of a line) when pasting. Same\nproblem is when selecting word and super + p</p>\n\n"
    } ,
  
    {
      "title"    : "MacBook MacOS OSX",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/05/23/macbook-macos-osx/",
      "date"     : "2017-05-23 00:00:00 +0200",
      "content"  : "<h1 id=\"shortcuts\">Shortcuts</h1>\n\n<p>Option (ALT) key is ⌥\nCommand cmd key is ⌘\nShift key is ⇧ \nReturn key is ↵ \nControl (CTRL) key is ^</p>\n\n<p>Since on mac keyboard <code class=\"highlighter-rouge\">fn</code> key is at left edge, I use it as <code class=\"highlighter-rouge\">ctrl</code> . Remap with\nSystem preferences -&gt; Keyboard -&gt; Modifier Keys -&gt; Function key as Ctrl\nAlso tilda and backtick are not on top left corner, so I used different Keyboard\n-&gt; Input sources -&gt; English British so at least <code class=\"highlighter-rouge\">backtick</code> is on top left key.</p>\n\n<p>Another solution to remap keys is to use <code class=\"highlighter-rouge\">hidutil</code>\nhttps://developer.apple.com/library/content/technotes/tn2450/_index.html\nYou can find key codes in a table.\nInstall <strong>Key Codes</strong> app\nhttps://itunes.apple.com/us/app/key-codes/id414568915?mt=12 to find key codes.\nThan use OR with 0x700000000.</p>\n\n<p>To switch switch keys <code class=\"highlighter-rouge\">0xa</code> (§) and <code class=\"highlighter-rouge\">0x32</code> (backtick tilde) use <code class=\"highlighter-rouge\">0x700000004</code>\nand <code class=\"highlighter-rouge\">0x700000032</code>.  For <code class=\"highlighter-rouge\">a</code> and <code class=\"highlighter-rouge\">b</code> use <code class=\"highlighter-rouge\">0x700000004</code> and <code class=\"highlighter-rouge\">0x700000005</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>hidutil property --set '{\"UserKeyMapping\":\n  [\n    {\"HIDKeyboardModifierMappingSrc\":0x7000000a,\n    \"HIDKeyboardModifierMappingDst\":0x700000032},\n    {\"HIDKeyboardModifierMappingSrc\":0x700000032,\n    \"HIDKeyboardModifierMappingDst\":0x70000000a}\n  ]\n}'\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># to see what is already mapped\nhidutil property --get 'UserKeyMapping'\n# clear mappings\nhidutil property --set '{\"UserKeyMapping\":[]}'\n</code></pre></div></div>\n\n<p>From terminal toolbar:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">⌘ N</code> new window</li>\n  <li><code class=\"highlighter-rouge\">⌘ T</code> new tab</li>\n</ul>\n\n<p>From System Preferences -&gt; Keyboard -&gt; Shortcuts</p>\n<ul>\n  <li>-&gt; Spotlight\n    <ul>\n      <li><code class=\"highlighter-rouge\">⌘ space</code> spotlight search</li>\n      <li><code class=\"highlighter-rouge\">⌥  ⌘ space</code> finder : inside finder you can open files with <code class=\"highlighter-rouge\">⌘ o</code> (enter\njust renames the file)</li>\n    </ul>\n  </li>\n  <li>-&gt; Mission control\n    <ul>\n      <li><code class=\"highlighter-rouge\">^ up</code> mission control</li>\n      <li><code class=\"highlighter-rouge\">^ down</code> application windows in all workspaces, use arrow to focus, use tab\nto select another application and view it’s windows</li>\n    </ul>\n  </li>\n</ul>\n\n<p>You can disable any special key for any app. From System Preferences -&gt;\nKeyboard -&gt; Shortcuts -&gt; App Chortcuts -&gt; +  than select the app and write exact\nname and add shortcut uncluding ⌥  key:</p>\n<ul>\n  <li>I disable Minimize since I do not need it, so add Minimize and random keyboard\ncombination like <code class=\"highlighter-rouge\">⌥ ⌘ M</code>.</li>\n  <li>for iTerm I do not need Clear Buffer so now it is <code class=\"highlighter-rouge\">⌘ ⌥ M</code></li>\n  <li>Mission control -&gt; Move left space I remaped to <code class=\"highlighter-rouge\">^ ⌘ h</code> (also right space\n<code class=\"highlighter-rouge\">^ ⌘ l</code>)</li>\n</ul>\n\n<p>From <a href=\"https://support.apple.com/en-us/HT201236\">Mac keyboard shortcuts from\nsupport</a></p>\n<ul>\n  <li><code class=\"highlighter-rouge\">⌘ H</code> hide front app</li>\n  <li><code class=\"highlighter-rouge\">⌘ ⌥ H</code> to show only front app</li>\n  <li><code class=\"highlighter-rouge\">Fn-delete</code> is forward del since that key does not exists on macbook air</li>\n</ul>\n\n<p>Click on link by holding ⌘ or ⌥ or ctrl will open new tab (with shift it will\nfocus that new tab), download and open context menu (ctrl click also works for\nselected text).</p>\n\n<p><code class=\"highlighter-rouge\">⌘ shift 3</code> and <code class=\"highlighter-rouge\">⌘ shift 4</code> to create screenshots for entire and selected area.\nPress space after that to select window. Screen shots will be on desktop.</p>\n\n<p>To use apple keyboard on ubuntu I tried to remap Fn key, but that is not\npossible https://askubuntu.com/questions/370944/remap-fn-key-to-insert-key-on-apple-aluminium-keyboard</p>\n\n<p>To show home folder in Finder, go to Finder Preferences -&gt; Sidebar and enable\nhome folder in sidebar.\nInside Finder Go menu you can hold ⌥  key to show <code class=\"highlighter-rouge\">Library</code> folder. Some app\ndata can be\n<code class=\"highlighter-rouge\">~/Library/Containers/com.mydomain.myaoo/Data/Library/Application%20Support/myapp/</code>\nWhen you open the app using ⌘ + space than it is usually from Applications\nfolder, but it could be from Downloads. You can check where app is location by\nright clicking on app icon in Dock than Options -&gt; Show in finder</p>\n\n<p>I added to <code class=\"highlighter-rouge\">.bash_profile</code>:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">alias ls='ls -Gp'</code> so I can see difference between files and folders</li>\n</ul>\n\n<p>To enable ssh server you need to go “System Preferences -&gt; Sharing -&gt; enable\nRemote login”</p>\n\n<p>Position windows using <a href=\"https://github.com/eczarny/spectacle\">spectacle</a>\n<a href=\"https://www.youtube.com/watch?v=k1lmd2T5Z2A\">video</a>.\nComparison of all\n<a href=\"https://css-tricks.com/os-x-window-manager-apps/\">os-x-windoiw-manager</a>.\nI found interesting\n<a href=\"http://www.hammerspoon.org/go/\">hammerspoon</a>\n<a href=\"http://thume.ca/2016/07/16/advanced-hackery-with-the-hammerspoon-window-manager/\">blog</a></p>\n\n<h1 id=\"karabiner-elements-to-change-keys\">Karabiner Elements to change keys</h1>\n\n<p>Since I like Alt + ` to switch to next window inside same app. You can try to\nchoose English PC in System Preferences-&gt;Keyboard-&gt;Input Sources. This way keys\n(§ and `)  were replaced,  but also single quote key, so better solution is to\nuse karabiner. For Sierra 10.12.5 there is new version\n<a href=\"https://github.com/tekezo/Karabiner-Elements\">https://github.com/tekezo/Karabiner-Elements</a></p>\n\n<p>My <code class=\"highlighter-rouge\">.config/karabiner/karabiner.json</code> file looks:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"profiles\": [\n    {\n      \"simple_modifications\": {\n        \"caps_lock\": \"left_control\",\n        \"non_us_backslash\": \"grave_accent_and_tilde\"\n      }\n    }\n  ]\n}\n</code></pre></div></div>\n\n<h1 id=\"update-packages\">Update packages</h1>\n\n<p>Install homebrew\nUpdate bash: <code class=\"highlighter-rouge\">brew install bash</code>\n<a href=\"https://gist.github.com/xuhdev/8b1b16fb802f6870729038ce3789568f\">link</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>brew install coreutils findutils gnu-tar gnu-sed gawk gnutls gnu-indent gnu-getopt\nbrew info coreutils\n\nbrew install bash-completion\n</code></pre></div></div>\n\n<p>Install <a href=\"https://yousseb.github.io/meld/\">meld for mac</a></p>\n\n<p>On high sierra you need to run <a href=\"https://github.com/yousseb/meld/issues/50\">https://github.com/yousseb/meld/issues/50</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>unlink /Applications/Meld.app/Contents/Frameworks/libz.1.dylib\n</code></pre></div></div>\n\n<p>Install java JRE from jre-9.0.4_osx-x64_bin.dmg (not tar.gz)\nhttp://www.oracle.com/technetwork/java/javase/downloads/index.html\nDouble click will install.\nYou can check if installed using https://java.com/en/download/installed.jsp on\nsafari.</p>\n\n<p>Install vim</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>brew install vim --override-system-vi\n# if you receive error\n# xcrun: error: invalid active developer path (/Library/Developer/CommandLineTools), missing xcrun at: /Library/Developer/CommandLineTools/usr/bin/xcrun\nxcode-select --install\n</code></pre></div></div>\n\n<p>Instal pip</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo easy_install-3.6 pip\npip3 install awscli  --user --upgrade\n</code></pre></div></div>\n\n<h1 id=\"iterm2\">iTerm2</h1>\n\n<p>You can maps pageup in iterm.  Do <code class=\"highlighter-rouge\">⌘ ,</code> to open Preferences -&gt; Keys -&gt; Key\nmappings and add <code class=\"highlighter-rouge\">⌘ [</code> and <code class=\"highlighter-rouge\">⌘ ]</code> to map scroll page down and up. But that does\nnot work well for vim since it show previous page in terminal buffer (not in\nvim) so for vim use <code class=\"highlighter-rouge\">^b</code> and <code class=\"highlighter-rouge\">^f</code> (<code class=\"highlighter-rouge\">^d</code> and <code class=\"highlighter-rouge\">^u</code> for half down up)</p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>new disks like sd card will be mounted under <code class=\"highlighter-rouge\">/Volumes</code> instead of <code class=\"highlighter-rouge\">/media</code> or\n<code class=\"highlighter-rouge\">/mnt</code></li>\n</ul>\n\n<h1 id=\"work-spaces\">Work spaces</h1>\n\n<p>With <code class=\"highlighter-rouge\">fn F3</code> (or swipe up with three fingers) you can create new spaces (any\nnumber of workspaces). You can switch between them with left/right swipe with\nthree fingers (you can see more animations on System Preferences -&gt; Trackpad.</p>\n\n<p>Full screen apps open their own space.</p>\n\n<h1 id=\"applescript\">AppleScript</h1>\n\n<p>You can run and edit scripts in <code class=\"highlighter-rouge\">Script Editor</code>. Open <code class=\"highlighter-rouge\">Dictionary</code> in File-&gt;Open\nDictionary or drag application icon to Script Editor application icon.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># comments\n-- this is comment\n\n# continuation character Option l\ndialog \"This is long line\" ¬\nbuttons { \"Great\", \"OK\" }\n\n# Boolean\ntrue, false\n# Text\n\"Hi\"\n# List\n{ 1, \"Duke\" }\n# Record\n{name: \"Duke\", age: 35}\n\n# Operators\n\"a\" &amp; \"b\"\n\n# variables\nset myName to \"John\"\ncopy 33 to myAge\n</code></pre></div></div>\n\n<p>Statements can include all above. Simple statement is single line, multiline is\ncompound statements</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>tell application \"Finder\"\n  -- by position index, first/last or front/back, name\n  get the name of window 2\n  -- same as get the name of second window\n  -- same as get the name of 2nd window\n  -- same as get the name of the window after the front window\n  -- same as get the name of window \"Trash\"\n\n  -- name can not be updated, but other (like index) can be updated\n  set the index of the last window to 1\n  set toolbar visible of the front Finder window to true\n  set the sidebar width of  the second Finder window to 240\n  set the position of the front Finder window to {94, 134}\n  set the bounds of the front Finder window to {24, 96, 524, 396}\n  set the target of the front Finder window to home\n\n  open window \"Trash\"\n  -- same as select window \"Trash\"\n  tell the front window\n    set the current view to flow view\n    set the bounds to {528, 116, 1016, 674}\n  end tell\n\n  close window \"Trash\"\n  set savedName to name of front window\n  set windowRef to a reference to window 1\n  set windowId to theWindow's id\n  -- same as set windowId to id of the first window\n\nend tell\n</code></pre></div></div>\n\n<p>If conditional with type casting</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>if (myVar as string) is equal to \"asd\" then\nend if\n</code></pre></div></div>\n\n<p>If you want to check the type of variable</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>if class of myVar is string then\nend if\n</code></pre></div></div>\n\n<p>If you got exception than wrap with try to do exceptions handling</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>try\n    set a to a as number\n    display dialog \"Yes! It's a number!\"\nend try\n\n-- or\n\ntry\n  set windowId to do shell script \"defaults read com.duleorlovic.windowShortCuts \" &amp; key\non error\n  display dialog \"Please create window shortcut for key \"\nend try\n</code></pre></div></div>\n\n<p>Get user input</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>set theResponse to display dialog \"Key (h, j, k, l, semicolon, m, comma, dot, slash, u, i) ?\" default answer \"\" with icon note buttons {\"Cancel\", \"Continue\"} default button \"Continue\"\nif button returned of theResponse is equal to \"Cancel\" then\n error number -128\nend if\nset key to text returned of theResponse\n\n</code></pre></div></div>\n\n<p>Command is series of words that request an action. Command is directed to a\ntarget.\nChoose file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    set xfile to choose file\n    set xpath to POSIX path of xfile\n</code></pre></div></div>\n\n<p>Debugging with <code class=\"highlighter-rouge\">display dialog \"message\"</code>. Use double quotes, not single quote.</p>\n\n<p>Array list iterate loop</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>set theList {1, 2, 3}\nset first as item 1 of theList\nset first to item 1 of theList\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>on getPositionOfItemInList(theItem, theList)\n    repeat with a from 1 to count of theList\n        if item a of theList is theItem then return a\n    end repeat\n    return 0\nend getPositionOfItemInList\n\nset theList to {\"Sal\", \"Ben\", \"David\", \"Chris\", \"Jen\", \"Lizzie\", \"Maddie\", \"Lillie\"}\ngetPositionOfItemInList(\"Maddie\", theList)\n</code></pre></div></div>\n\n<p>String manipulation https://developer.apple.com/library/content/documentation/LanguagesUtilities/Conceptual/MacAutomationScriptingGuide/ManipulateText.html</p>\n\n<p>You can run scripts inside bash with <code class=\"highlighter-rouge\">osascript -e 'display dialog \"Hi\"'</code> or for\nshell scripts (you need to <code class=\"highlighter-rouge\">chmod +x filename.txt</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>#!/usr/bin/osascript\ndisplay dialog \"Hi\"\n</code></pre></div></div>\n\n<p>You can also call another scpt file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>osascript ~/myscript.scpt\n</code></pre></div></div>\n\n<p>TODO: https://developer.apple.com/library/content/documentation/AppleScript/Conceptual/AppleScriptLangGuide/conceptual/ASLR_fundamentals.html#//apple_ref/doc/uid/TP40000983-CH218-SW1</p>\n\n<h1 id=\"activate-window\">Activate window</h1>\n\n<p>iTerm supports hotkeys https://www.iterm2.com/documentation-hotkey.html\nbut it is not generic. I rather write window id and hotkey combination in user</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>do shell script \"defaults write com.myname.myapp foo bar\"\nset myValue to do shell script \"defaults read com.myname.myapp foo\"\n</code></pre></div></div>\n\n<p>To assign keyboard shortcuts you need to create a service in Automator and\ncreate shortcut in System Preferences -&gt; Keyboard -&gt; Shortcuts -&gt; Services</p>\n\n<p>Create service for each key, for example activateWindowL\n(<code class=\"highlighter-rouge\">/home/orlovic/Library/Services/activateWindowL.workflow</code>).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>on run {input, parameters}\n    -- note that mac path is using colons instead of slash\n    run script file \"Macintosh HD:Users:dule:config:bashrc:mac_scripts:mac_activate_window.scpt\" with parameters {\"l\"}\n    return input\nend run\n</code></pre></div></div>\n\n<p>To overwrite existing shortcuts in specific application you need to remap that\nsame menu item to something else, for example in chrome cmd + j is jump to\nselection so in  System Preferences -&gt; Keyboard -&gt; Shortcuts -&gt; App Shortcuts</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>all Jump to Selection cmd+ald+j\n\niTerm Clear Buffer cmd+alt+k\niTem Use Transparency cmd+alt+u\n\nscriptEditr Underline cmd+alt+u\n</code></pre></div></div>\n\n<p>To get foremost window</p>\n\n<p>https://apple.stackexchange.com/questions/117421/how-do-i-focus-a-specific-window-with-applescript-without-doing-an-activate-and\nhttps://stackoverflow.com/questions/10366003/applescript-google-chrome-activate-a-certain-window/34375804#34375804\nhttp://tom.scogland.com/blog/2013/06/08/mac-raise-window-by-title/\nhttps://macosxautomation.com/applescript/firsttutorial/index.html chap 3 name\noroperty</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># open last window\ndo shell script \"open -a Google\\\\ Chrome\"\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>tell application \"iTerm\"\n       activate\n       set theWindow to the first item of ¬\n               (get the windows whose name is \"2. bash\")\n       if index of theWindow is not 1 then\n               set index to 1\n               set visible to false\n               set visible to true\n       end if\nend tell\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>tell application \"System Events\" to tell process \"iTerm\"\n       perform action \"AXRaise\" of (first window whose name contains \"2.\")\nend tell\n</code></pre></div></div>\n\n<h1 id=\"rails\">Rails</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>brew unlink imagemagick\nbrew install imagemagick@6 &amp;&amp; brew link imagemagick@6 --force\n\ngem install puma -v 2.11.3 -- --with-cppflags=-I/usr/local/opt/openssl/include --with-ldflags=-L/usr/local/opt/openssl/lib\n\nbrew install qt\n</code></pre></div></div>\n\n<h1 id=\"mysql\">Mysql</h1>\n\n<p><code class=\"highlighter-rouge\">brew install mysql</code> will will use <code class=\"highlighter-rouge\">/tmp/mysql.sock</code> so you can create link to\nubuntu folder of mysql socket file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo mkdir -p /var/run/mysqld\nsudo ln -s /tmp/mysql.sock /var/run/mysqld/mysqld.sock\n</code></pre></div></div>\n\n<p>To permanently change socket file location you can update</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo vi /usr/local/etc/my.cnf\n[client]\nsocket=/var/run/mysqld/mysqld.sock\n</code></pre></div></div>\n\n<h1 id=\"android-usb-thethering\">Android USB Thethering</h1>\n\n<p>Download <a href=\"http://www.joshuawise.com/horndis\">http://www.joshuawise.com/horndis</a> driver (right click open with) to\nenable usb tethering from android phone (wireless thethering will consume\nbatery). I needed to restart mac to find my phone in network preferences.</p>\n\n<h1 id=\"defaults\">Defaults</h1>\n\n<p>Mac user defaults are preferences for user system configurations</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>defaults read com.mydomain.myapp\ndefaults read com.mydomain.myapp \"MyKey\"\ndefaults write com.mydomain.myapp \"MyKey\" myvalue\ndefaults delete com.mydomain.myapp\n</code></pre></div></div>\n\n<h1 id=\"logs\">Logs</h1>\n\n<p>You can see logs using <code class=\"highlighter-rouge\">console</code> application. You can attach iPhone and see logs\nfor it. Filter in <code class=\"highlighter-rouge\">Search</code>, follow last logs with <code class=\"highlighter-rouge\">Now</code> button.</p>\n\n<h1 id=\"closed-lid\">Closed lid</h1>\n\n<p>To keep working after lid is closed you can use app https://github.com/semaja2/InsomniaX and disable Idle Sleep and Disable Lid Sleep</p>\n\n<p>Open new VLC in separate window using</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/Applications/VLC.app/Contents/MacOS/VLC &amp;\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "State machines audit trails gem",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/05/16/state-machines-audit-trail-gem/",
      "date"     : "2017-05-16 00:00:00 +0200",
      "content"  : "<h1 id=\"old-gem-state_machine\">Old gem state_machine</h1>\n\n<p>Definition with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Objects\n  state_machine :state, initial: :my_state do\n  ...\n  end\n</code></pre></div></div>\n\n<p>Inside definition you can use:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">before_transition on: :my_state</code>, <code class=\"highlighter-rouge\">after_transition on: :my_state</code></li>\n  <li><code class=\"highlighter-rouge\">after_failure on: :my_state</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">around_transition</code></p>\n  </li>\n  <li><code class=\"highlighter-rouge\">event :my_event { transition :my_state, :my_other_state, if: Proc.new {\n|my_object| my_object.valid? } }</code></li>\n  <li><code class=\"highlighter-rouge\">state :my_state do end</code></li>\n</ul>\n\n<p>In transitions you can use keyword <code class=\"highlighter-rouge\">all</code> or <code class=\"highlighter-rouge\">any</code> to match all/any states, and\n<code class=\"highlighter-rouge\">same</code> to match same state (usefull when you have list of matched states).\nYou can use <code class=\"highlighter-rouge\">object.my_state?</code> to check if it is currently in that <code class=\"highlighter-rouge\">my_state</code>.\nAlso you can use <code class=\"highlighter-rouge\">object.can_my_event?</code> to check if it can change state using\nthis event. Also <code class=\"highlighter-rouge\">object.fire_state_event(:my_event)</code> and\n<code class=\"highlighter-rouge\">object.state?(:my_state)</code>. You can use bang method to raise error if event\nfails <code class=\"highlighter-rouge\">object.my_event!</code>. List of all possible events is <code class=\"highlighter-rouge\">object.state_events</code>\n(or <code class=\"highlighter-rouge\">object.status_events</code> to list all events for status column).</p>\n\n<p>To list of all states you can use <code class=\"highlighter-rouge\">Post.state_machines[:status].states.map\n&amp;:name</code></p>\n\n<p>You can use namespace <code class=\"highlighter-rouge\">state_machine :alarm_state, initial: :active, namespace:\n:alarm do</code> when all events and states have prefix <code class=\"highlighter-rouge\">alarm_my_state</code> and suffix\n<code class=\"highlighter-rouge\">my_event_alarm</code>.</p>\n\n<p>Instead of calling the event explicitly you can use <code class=\"highlighter-rouge\">object.state_event =\n\"my_event\"; object.save</code> to trigger event. You can manually change state but\nthen you will break state machine, so better is to update <code class=\"highlighter-rouge\">state_event</code>. On\ncreation, initial state event is triggered, so you will have two events (from\nnil to initial, and from initial to the value of state_event).</p>\n\n<p>You can define transitions inside the context of an event. First transition that\nmatches the state and passes its conditions will be used.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>event :repair do\n  transition stalled: :parked, unless: :auto_shop_busy\n  transition stalled: same\nend\n</code></pre></div></div>\n\n<p>but also you can define transition inside the <a href=\"https://github.com/pluginaweek/state_machine#transition-context\">context of\nstate</a>. Than\nyou do not need to use <code class=\"highlighter-rouge\">:from</code> (since we know the state) but you need <code class=\"highlighter-rouge\">:on</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>state :parked do\n  transition to: :idling, on: [:ignite, :shift_up], if: :seatbelt_on?\n  def speed\n    0\n  end\nend\n</code></pre></div></div>\n\n<p>When defining transitions instead of using hash rocket syntax you can use\n<code class=\"highlighter-rouge\">:from</code>, <code class=\"highlighter-rouge\">:except_from</code>, <code class=\"highlighter-rouge\">:to</code> and <code class=\"highlighter-rouge\">:except_to</code> options</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>before_transition :parked =&gt; any - :parked, :do =&gt; :put_on_seatbelt\n# is the same as\nbefore_transition :from =&gt; :parked, :except_to =&gt; :parked, :do =&gt; :put_on_seatbelt\n</code></pre></div></div>\n\n<p>You can generate\n<a href=\"https://github.com/pluginaweek/state_machine/blob/master/examples/Vehicle_state.png\">graph</a> with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install graphviz\necho \"gem 'ruby-graphviz', require: 'graphviz'\" &gt;&gt; Gemfile\nrake state_machine:draw CLASS=Customer,Location HUMAN_NAMES=true\ngnome-open Location_status.png\n</code></pre></div></div>\n\n<h1 id=\"old-gem-state_machine-audit_trail\">Old gem state_machine-audit_trail</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat \"gem 'state_machine-audit_trail'\" &gt;&gt; Gemfile\nrails generate state_machine:audit_trail Post status\n</code></pre></div></div>\n\n<p>This will generate model and migration which you can update</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/post_status_transition.rb\nclass PostStatusTransition &lt; ActiveRecord::Base\n  belongs_to :post\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># db/migrate/123123123123_create_post_status_transitions.rb\nclass CreatePostStatusTransitions &lt; ActiveRecord::Migration[5.1]\n  def change\n    create_table :post_status_transitions do |t|\n      t.references :post, foreign_key: true\n      # t.string :namespace # this is for new version of state_machines\n      t.string :event\n      t.string :from\n      t.string :to\n      # add your custom fields\n      t.string :change_description\n      t.text :comment\n      t.timestamp :created_at\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>If you need more data you need to add more columns, for example\n<code class=\"highlighter-rouge\">change_description</code> (by server) and <code class=\"highlighter-rouge\">comment</code> (by user) which are defined as\n<code class=\"highlighter-rouge\">attr_accessor :change_description, :comment</code> in model and populated in form or\nbefore_transition. For other fields that you want to track, those columns need\nto exists in table.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Post &lt; ApplicationRecord\n  state_machine :status, initial: :walk do\n    store_audit_trail context_to_log: :comment\n    event :start do\n      transition all =&gt; :run\n    end\n    event :stop do\n      transition all =&gt; :walk\n    end\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"upgrade-gem-state_machines\">Upgrade gem state_machines</h1>\n\n<p>New gem have some breaking changes. You need is to include additional\ngem that will use hooks to initialize data</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\ngem \"state_machines\"\ngem 'state_machines-activerecord'\nHERE_DOC\n</code></pre></div></div>\n\n<p>Before audit trail was adding description on <code class=\"highlighter-rouge\">.save</code>, but in new gem, it is\nadding on <code class=\"highlighter-rouge\">.new</code> action and values are memoized</p>\n\n<p><a href=\"https://github.com/state-machines/state_machines-audit_trail/issues/22\">https://github.com/state-machines/state_machines-audit_trail/issues/22</a></p>\n\n<p>Also, before we could use <code class=\"highlighter-rouge\">Post.where(name: 'my name', status:\n:enabled).first_or_create</code> event we had <code class=\"highlighter-rouge\">state_machine :status, initial:\n:created_new</code>. Now post will create with <code class=\"highlighter-rouge\">Post.last.status # =&gt; 'initial'</code></p>\n\n<p>For audit trail you need to do some renaming\n<a href=\"https://github.com/state-machines/state_machines-audit_trail/wiki/Converting-from-former-state_machine-audit_trail-to-state_machines-audit_trail\">https://github.com/state-machines/state_machines-audit_trail/wiki/Converting-from-former-state_machine-audit_trail-to-state_machines-audit_trail</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\ngem 'state_machines-audit_trail'\nHERE_DOC\n</code></pre></div></div>\n\n<p>New version <code class=\"highlighter-rouge\">rails g state_machines:audit_trail Post status</code> will generate same\nmigration with additional column: <code class=\"highlighter-rouge\">t.string :namespace</code>. Note that you should\nuse singular <code class=\"highlighter-rouge\">Post</code> and not plural <code class=\"highlighter-rouge\">Posts</code></p>\n\n<p>For additional fiels that you want to store, you can use real columns, but its\neasier to use some <code class=\"highlighter-rouge\">description</code> which you can generate from other fields.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  before_transition :on =&gt; any do |object, transition|\n    case transition.event\n    when :start\n      self.description = \"My object started\"\n    end\n</code></pre></div></div>\n\n<p>In model you need</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Post &lt; ApplicationRecord\n  attr_accessor :change_description, :comment\n  state_machine :status, initial: :walk do\n    audit_trail context: [:change_description, :comment, :name]\n    event :start do\n      transition all =&gt; :run\n    end\n    event :stop do\n      transition all =&gt; :walk\n    end\n  end\n\n  def description=(text)\n    @description = \"My associated #{page.name} : #{text}\"\n  end\n\n  def description\n    # note that this is called on Post.new, so you should have page parameter\n    # Post.new; Post.new; will call this twice, but without associated page\n    # Post.new post_params.merge(page_id: current_page)\n    @description ||= \"My associated #{page.name}\"\n  end\nend\n</code></pre></div></div>\n\n<p>In your view</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;% post.status_events.each do |event| %&gt;\n    &lt;%= link_to event, action_post_path(post, event: event), method: :post %&gt;\n  &lt;% end %&gt;\n\n  # or on update form\n  &lt;%= form.select :status_event, post.status_events %&gt;\n\n  # of in hidden field on form object\n  &lt;%= form.hidden_field :status_event, value: :edit %&gt;\n\n  # or plain input (no need for :value key)\n  &lt;%= hidden_field_tag :status_event, :edit %&gt;\n</code></pre></div></div>\n\n<p>And controller</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n  def action\n    @post.fire_status_event params[:event]\n    redirect_to posts_path\n  end\n\n  # or on update form\n  params.require(:post).permit(\n    :name, :description, :status_event\n  ).merge(\n    updated_from_ip: request.remote_ip,\n    updated_by: current_user,\n  )\n</code></pre></div></div>\n\n<p>You can use <code class=\"highlighter-rouge\">Constant.POST_STATUSES # { CREATED_NEW: \"Created new\" }</code> to list\nall statuses and events in one file. Than in transition you can use <code class=\"highlighter-rouge\">transition\nall - Constant.POST_STATUSES.slice(:CREATED_NEW) =&gt; same</code></p>\n\n<p>Conditional validation callbacks hooks works fine if it is rails <code class=\"highlighter-rouge\">validates</code> but\nif it is customer validation <code class=\"highlighter-rouge\">validate :my_method</code> than it won’t work in\nmultiple states\n<a href=\"https://github.com/state-machines/state_machines-activerecord#state-driven-validations\">https://github.com/state-machines/state_machines-activerecord#state-driven-validations</a>\nso instead of</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>state :first_gear, :second_gear do\n  validate :speed_is_legal\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>state :first_gear, :second_gear do\n  validate {|vehicle| vehicle.speed_is_legal}\nend\n</code></pre></div></div>\n\n<p>Note that whole event change is wrapped in transaction, so if state validation\nfails everything will be rolledback.</p>\n\n<p>If you want to validate specific event <code class=\"highlighter-rouge\">advance_renewal</code> (event without\ncorresponding state) so you can not use <code class=\"highlighter-rouge\">event :advance_renewal; transition all\n=&gt; same, if: Proc.new { |m| m.has_advance_package? }</code> since at the show time if\ndoes not have advance package so <code class=\"highlighter-rouge\">m.can_advance_renewal #=&gt; false</code>. So you need\nto use rails validate <code class=\"highlighter-rouge\">validate  :advance_renewal_settings, on: [:update], if:\n:advance_renewal?</code> and <code class=\"highlighter-rouge\">def advance_renewal_settings;\nerrors.add(:advance_renewal_package, \"Please select Advance Renewal\nPackage.\")unless advance_renewal_package.present?; end</code>.</p>\n\n<p><code class=\"highlighter-rouge\">before_transition</code>  and <code class=\"highlighter-rouge\">after_transition</code> callbacks</p>\n\n<h1 id=\"other-audit-gems\">Other audit gems</h1>\n\n<ul>\n  <li>paper_trail\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bundle exec rails g paper_trail:install --with-changes\nbundle exec rake db:migrate\n</code></pre></div>    </div>\n  </li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Bootstrap front-end framerwork",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/05/03/bootstrap-front-end-framework/",
      "date"     : "2017-05-03 00:00:00 +0200",
      "content"  : "<h1 id=\"bootstrap-4\">Bootstrap 4</h1>\n\n<h1 id=\"bootstrap\">Bootstrap</h1>\n\n<p><code class=\"highlighter-rouge\">div</code> is block element and by default it will be stacked. Bootstrap grid is\nmobile first, so three <code class=\"highlighter-rouge\">.col-md-4</code> will be stacked until desktop, so on desktop,\nlarge and extra large desktop it will be like three equal width columns.  You do\nnot need to define all 12, <code class=\"highlighter-rouge\">.col</code> will occupy rest of place. <code class=\"highlighter-rouge\">.col-auto</code> will\noccupy only that is needed (based on it’s contents, it uses <code class=\"highlighter-rouge\">max-width: 100%</code>).\nWhen you specify for sm, you do not need to specify for md or lg. <code class=\"highlighter-rouge\">col-xs-12</code> is\n<code class=\"highlighter-rouge\">width: 100%</code> which is default so no need to write that. Write only when you\nneed columns. Gutter between columns (padding) is 30px, ie 15px on each side,\nso when nesting column inside column, first column will get blank space on its\nleft (unneeded indent from 15px padding from first column and 15px padding from\nnested column) so that the reason why row has -15px margin (to fix eventual\nparent column padding) and you have to wrap row with <code class=\"highlighter-rouge\">.container</code> class to\ncompensate that (padding 15px) otherwise you will get horizontal scrollbar since\nbody will be larger than 100% by 30px.</p>\n\n<p>Bootstrap Media queries:</p>\n\n<ul>\n  <li>xs - phones (no need for media queary since this is default)</li>\n  <li>sm - tablets <code class=\"highlighter-rouge\">@media (min-width: map-get($grid-breakpoints, 'sm') { // 576px (Bv3 768px) and up</code></li>\n  <li>md - desktops <code class=\"highlighter-rouge\">@media (min-width: @screen-md-min) { // 768px (Bv3 992px)</code></li>\n  <li>lg - larger desktops <code class=\"highlighter-rouge\">@media (min-width: @screen-lg-min) { // 992px (Bv3 1200px)</code></li>\n  <li>xl - extra lage <code class=\"highlighter-rouge\">@media (min-width: @screen-xl-min) { // 1200pxa</code></li>\n</ul>\n\n<p>With bootstrap 4 you can use mixins for media queries:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// given (sm) and larger\n@include media-breakpoint-up(sm) {\n  .some-class {\n    display: block;\n\n// or other direction (given and smaller)\n@include media-breakpoint-down(sm) {}\n\n// only given size\n@include media-breakpoint-only(sm) {}\n\n// multiple sizes\n@include media-breakpoint-between(md, xl) {}\n@media (min-width: 768px) and (max-width: 1199.98px) { ... }\n</code></pre></div></div>\n\n<p>With Bootstrap3 you can use their predefined media queries with <code class=\"highlighter-rouge\">min-width</code>\n(mobile first), for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@media(min-width:$screen-sm){\n  .alert {\n    position: absolute;\n    bottom: 0px;\n    right: 20px;\n  }\n}\n\n// or in other direction (given and smaller)\n@media(max-width: $screen-sm) { }\n// or better do not use boundary\n@media(max-width: 575.98px) { }\n</code></pre></div></div>\n\n<p>Bootstrap <code class=\"highlighter-rouge\">container</code> has fixed width for big devices.</p>\n\n<p>Difference with bootstrap 3 is that there is new grid tier <code class=\"highlighter-rouge\">xl</code> that was <code class=\"highlighter-rouge\">lg</code> in\nB3 (<code class=\"highlighter-rouge\">sm</code> is 576px instead of 768px in B3) and all are bumped up one level (so\n<code class=\"highlighter-rouge\">.col-md-6</code> in v3 is now <code class=\"highlighter-rouge\">.col-lg-6</code> in v4)\nBoostrap 3 you can use <a href=\"http://getbootstrap.com/css/#responsive-utilities-classes\">responsive available\nclasses</a> to toggle\nbetween <code class=\"highlighter-rouge\">display: block, inline, inline-block</code> or to hide, for specific viewport\nsize <code class=\"highlighter-rouge\">.visibe-sm-block .hidden-md .hidden-sm-up</code></p>\n\n<p>In Bootstrap 4 you can use <code class=\"highlighter-rouge\">d-*-none</code> class\nhttps://getbootstrap.com/docs/4.1/utilities/display/\nTo hide on smaller than md (ie show on md and larger) use <code class=\"highlighter-rouge\">d-none d-md-block</code>\nTo show only on md use <code class=\"highlighter-rouge\">.d-none .d-md-block .d-lg-none</code></p>\n\n<p>You can write your own to match all greater (or smaller) sizes:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># when it is max-width than it is Non-Mobile First Method\n# so we use le (less or equal then)\n# (min-width is Mobile First and we use hide-ge-)\n/* Large Devices, Wide Screens */\n@media only screen and (max-width : 1200px) {\n  .hide-le-lg {\n    display: none;\n  }\n}\n/* Medium Devices, Desktops */\n@media only screen and (max-width : 992px) {\n  .hide-le-md {\n    display: none;\n  }\n}\n/* Small Devices, Tablets */\n@media only screen and (max-width : 768px) {\n  .hide-le-sm {\n    display: none;\n  }\n}\n/* Extra Small Devices, Phones */\n@media only screen and (max-width : 480px) {\n  .hide-le-xs {\n    display: none;\n  }\n}\n</code></pre></div></div>\n\n<ul>\n  <li>you can center bootstrap column with offset</li>\n  <li>you can set icons on inputs, easy with generators, just add <code class=\"highlighter-rouge\">prepend:\n'password'</code></li>\n</ul>\n\n<h2 id=\"bootstrap-modal\">Bootstrap modal</h2>\n\n<p>On B3 you can use ajax and <code class=\"highlighter-rouge\">render layout: false</code> and provide only inner html of\n<code class=\"highlighter-rouge\">&lt;div class=\"modal\"&gt;&lt;div class=\"modal-dialog\"&gt;...</code> ie only <code class=\"highlighter-rouge\">.modal-content</code> will\nbe replaced. So you should use same header and footer in initial and ajax\nversion.</p>\n\n<p>On B4 we need to replace the modal content with custom js, so I use jBox modal\nin this case.</p>\n\n<p>To close modal with escape key you need to add tabindex on modal elemenent:\n<code class=\"highlighter-rouge\">&lt;div class=\"modal\" tabindex=\"-1\"&gt;</code>. Note that on Firefox ESC closing modal\nworks without this tabindex attribute. Note also that select2 dows</p>\n\n<p>On activation button you do not need <code class=\"highlighter-rouge\">data-keyboard=\"true\"</code> since that is\ndefault. But remove <code class=\"highlighter-rouge\">data-keyboard=\"false\"</code> if exists and you want to close\nmodal with escape key.</p>\n\n<p>You can use <code class=\"highlighter-rouge\">autofocus=\"true\"</code> option to focus input field when modal shows up.</p>\n\n<p>For <a href=\"http://getbootstrap.com/javascript/#tooltips\">tooltips</a> you can use html\nversion <code class=\"highlighter-rouge\">data-html=\"true\" data-toggle=\"tooltip\" title=\"&lt;h2&gt;Hi&lt;/h2&gt;\"</code>.</p>\n\n<p>If you use ajax than modal content is cached, you can clear that cache on shown\nor hidden event (or in ajax response).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;script&gt;\n$('#assign-location-modal').on('shown.bs.modal', function () {\n  $(this).removeData('bs.modal');\n});\n&lt;/script&gt;\n# or for all, for example in document_on.coffee\n$(document).on 'hidden.bs.modal', '.modal', -&gt;\n  $(this).removeData('bs.modal')\n  console.log \"remove boostrap modal\"\n</code></pre></div></div>\n\n<p>You can hide close modal with <code class=\"highlighter-rouge\">$('#my-modal').modal('toggle');</code></p>\n\n<p>Usually <code class=\"highlighter-rouge\">fade</code> makes some problem with positioning so you should not use fadding\nfor custom modals.</p>\n\n<h2 id=\"bootstrap-tooltip\">Bootstrap tooltip</h2>\n\n<p>To inspect <code class=\"highlighter-rouge\">data-toggle=\"tooltip\"</code> you need to find it’s selector and\nmanually call <code class=\"highlighter-rouge\">$('.myel').tooltip(\"show\");</code> or in developer tools when you\nselect <code class=\"highlighter-rouge\">&lt;a title=</code> element you can reference it with <code class=\"highlighter-rouge\">$0</code> so command is\n<code class=\"highlighter-rouge\">$($0).tooltip(\"show\")</code> or you can increase delay for hide</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  $('[data-toggle=\"tooltip\"]').tooltip(\n    delay:\n      hide: 100000\n  )\n</code></pre></div></div>\n\n<p>If it is inside element with <code class=\"highlighter-rouge\">overflow-y: scroll;</code> than it won’t be seen if it\ngoes over borders. You need to change container of the tooltip. You can do it\nsimply for all tooptips by overwriting DEFAULTS (if you need more customization,\nyou can overwrite any prototype of the class)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$.fn.tooltip.Constructor.DEFAULTS.container = 'body'\n$.fn.tooltip.Constructor.DEFAULTS.placement = 'right'\n</code></pre></div></div>\n\n<h2 id=\"bootstrap-input-group-and-button-group\">Bootstrap input group and button group</h2>\n\n<p>Buttons and inputs can be grouped, but <a href=\"http://getbootstrap.com/components/#btn-groups\">input\ngroup</a> is not advised to group\nwith select. <a href=\"http://jsfiddle.net/MansukhKhandhar/4309n31p/1/\">Here</a> is example\nof input with select and button.</p>\n\n<h1 id=\"helpers\">Helpers</h1>\n\n<p>Color helpers\nPrimary colors are <a href=\"https://getbootstrap.com/docs/4.0/utilities/colors/\">link</a>\n<code class=\"highlighter-rouge\">primary</code>, <code class=\"highlighter-rouge\">secondary</code>, <code class=\"highlighter-rouge\">success</code>, <code class=\"highlighter-rouge\">danger</code>, <code class=\"highlighter-rouge\">warning</code>, <code class=\"highlighter-rouge\">info</code>, <code class=\"highlighter-rouge\">dark</code>, <code class=\"highlighter-rouge\">light</code>,\n<code class=\"highlighter-rouge\">white</code>.  For text there is <code class=\"highlighter-rouge\">muted</code> and also need background <code class=\"highlighter-rouge\">text-light\nbg-dark</code> and <code class=\"highlighter-rouge\">text-white bg-dark</code>. You can set default body background by\ndefining variable <code class=\"highlighter-rouge\">$body-bg: #bcdee3</code> before importing boostrap.\nYou can use css <code class=\"highlighter-rouge\">darken</code> for example for variable\n<code class=\"highlighter-rouge\">$link-hover-color: darken($link-color, 15%) !default;</code>\nhttps://github.com/twbs/bootstrap/blob/e7e43edf65306efaf46a16ffc9fe35ef623bffef/scss/_variables.scss#L171</p>\n\n<ul>\n  <li>text and links <code class=\"highlighter-rouge\">.text-success</code></li>\n  <li>background <code class=\"highlighter-rouge\">.bg-warning</code></li>\n  <li>buttons <code class=\"highlighter-rouge\">.btn-primary</code></li>\n</ul>\n\n<p>Other helpers are:</p>\n\n<ul>\n  <li>position helpers <code class=\"highlighter-rouge\">position-relative</code>, <code class=\"highlighter-rouge\">position-absolute</code> https://github.com/twbs/bootstrap/blob/e57a2f244ba8446fffe71847e6a58b18f7b2d541/scss/utilities/_position.scss</li>\n  <li><code class=\"highlighter-rouge\">.clearfix</code></li>\n  <li>text size <code class=\"highlighter-rouge\">.h1</code>(2.5rem), <code class=\"highlighter-rouge\">.h2</code>(2rem), <code class=\"highlighter-rouge\">.h3</code>(1.75rem), <code class=\"highlighter-rouge\">.h4</code>(1.5rem), <code class=\"highlighter-rouge\">.h5</code>(1.25rem), <code class=\"highlighter-rouge\">.h6</code>(1rem) so you can use <code class=\"highlighter-rouge\">h2</code> instead defining <code class=\"highlighter-rouge\">font-size-2</code></li>\n  <li><code class=\"highlighter-rouge\">font-weight-bold</code> to use bold font</li>\n  <li>text position<code class=\"highlighter-rouge\">.text-center</code>, <code class=\"highlighter-rouge\">.text-left</code>, <code class=\"highlighter-rouge\">.text-nowrap</code>\n https://www.w3schools.com/bootstrap/bootstrap_ref_css_text.asp</li>\n  <li><code class=\"highlighter-rouge\">text-truncate</code> with <code class=\"highlighter-rouge\">max-width: 100px</code>\nhttps://getbootstrap.com/docs/4.1/utilities/text/#text-wrapping-and-overflow</li>\n  <li><code class=\"highlighter-rouge\">.show</code> and <code class=\"highlighter-rouge\">.hidden</code></li>\n  <li><code class=\"highlighter-rouge\">.d-none</code> to hide something. But when I want to show/hide in js I usually\ncreate my own <code class=\"highlighter-rouge\">.d-none-not-important</code> since bootstrap’s is with <code class=\"highlighter-rouge\">important</code>.\nI used <code class=\"highlighter-rouge\">hide-not-important</code> with jQuery <code class=\"highlighter-rouge\">$el.show()</code> (hide) or\n<code class=\"highlighter-rouge\">$el.slideDown()</code> (slideUp) but they use <code class=\"highlighter-rouge\">display: block</code> which does not work\nwell with <code class=\"highlighter-rouge\">display: flex</code> elements, better is to use\n<code class=\"highlighter-rouge\">$(el).addClass('d-none-not-important')</code>. There is also\n<a href=\"https://getbootstrap.com/docs/4.0/content/reboot/#html5-hidden-attribute\">hidden</a></li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/stylesheets/common/show_hide.sass\n.d-none-not-important,.hide-not-important\n  visibility: hidden\n  opacity: 0\n  transition: visibility 0.5s ease, opacity 0.5s ease\n  // display: none\n  &amp;.active\n    visibility: visible\n    opacity: 1\n    // display: initial\n</code></pre></div></div>\n<ul>\n  <li>\n    <p>margin and padding helpers in format <code class=\"highlighter-rouge\">&lt;property&gt;&lt;sides&gt;-&lt;breakpoint&gt;-&lt;size&gt;</code>\n<a href=\"https://getbootstrap.com/docs/4.0/utilities/spacing/#notation\">https://getbootstrap.com/docs/4.0/utilities/spacing/#notation</a> \nproperty is <code class=\"highlighter-rouge\">m</code> margin or <code class=\"highlighter-rouge\">p</code> padding\nsides <code class=\"highlighter-rouge\">t</code> top, <code class=\"highlighter-rouge\">b</code> bottom, <code class=\"highlighter-rouge\">l</code> left, <code class=\"highlighter-rouge\">r</code> right, <code class=\"highlighter-rouge\">x</code> both l and r, <code class=\"highlighter-rouge\">y</code> t and b\nsize <code class=\"highlighter-rouge\">0</code>, <code class=\"highlighter-rouge\">1</code> (<code class=\"highlighter-rouge\">$spacer * 0.25</code>), <code class=\"highlighter-rouge\">2</code> (<code class=\"highlighter-rouge\">$spacer * .5</code>), <code class=\"highlighter-rouge\">3</code> (<code class=\"highlighter-rouge\">$spacer</code>), <code class=\"highlighter-rouge\">4</code>\n(<code class=\"highlighter-rouge\">$spacer * 1.5</code>), <code class=\"highlighter-rouge\">5</code> (<code class=\"highlighter-rouge\">$spacer * 3</code>), By default <code class=\"highlighter-rouge\">$spacer: 1rem</code> 1rem is\ndefault font size ie 16px on B4 (1.5 line height) and 14px in B3 (1.428 line\nheight)</p>\n\n    <p><code class=\"highlighter-rouge\">mx-auto</code> for <code class=\"highlighter-rouge\">margin: 0px auto</code>.\nsides or breakpoint not required: <code class=\"highlighter-rouge\">p-0</code> padding none, <code class=\"highlighter-rouge\">mt-5</code> margin top,</p>\n\n    <p>For inline elements you can use <code class=\"highlighter-rouge\">float-left</code> (instead of <code class=\"highlighter-rouge\">pull-left</code>).\nFor block elements <code class=\"highlighter-rouge\">ml-auto</code> to align to the right (same as\npull-right in B3), <code class=\"highlighter-rouge\">mx-auto</code> for horizontal centering (need fixed width).\nFor block elements you can wrap inside <code class=\"highlighter-rouge\">d-flex w-100 justify-content-between</code>\nwidth 100% is important because you want right element to go right.\nhttps://getbootstrap.com/docs/4.0/components/list-group/#custom-content\n(also <code class=\"highlighter-rouge\">justify-content-around justify-content-center justify-content-start</code>).\nFor cross axis it will be scretched so use <code class=\"highlighter-rouge\">d-flex align-items-center</code> to\ncenter verticaly (or horizontaly if it is column based).\nYou can also align for particular item <code class=\"highlighter-rouge\">align-self-center</code>.\nGrow item with <code class=\"highlighter-rouge\">flex-grow-1</code> or <code class=\"highlighter-rouge\">flex-shrink-1</code>.</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">d-flex</code> class to convert to flexbox container. You can change display with\n<code class=\"highlighter-rouge\">d-inline</code>, <code class=\"highlighter-rouge\">d-inline-block</code>.  Other flex helpers\nhttps://getbootstrap.com/docs/4.0/utilities/flex/\nfor example to enable wrap use <code class=\"highlighter-rouge\">d-flex flex-wrap</code>. You can use those classes\ninstead of row col. For example\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;div class='d-flex flex-column flex-md-row'&gt;\n  &lt;div&gt;&lt;/div&gt;\n  &lt;div&gt;&lt;/div&gt;\n&lt;/div&gt;\nis the same as\n&lt;div class='row'&gt;\n  &lt;div class='col-md-6'&gt;&lt;/div&gt;\n  &lt;div class='col-md-6'&gt;&lt;/div&gt;\n&lt;/div&gt;\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">dl-horizontal</code> can be replaces with\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;dl class='row justify-content-start'&gt;\n  &lt;dt class='col-sm-2'&gt;Sign In Count&lt;/dt&gt;\n  &lt;dd class='col'&gt;&lt;%= @user.sign_in_count %&gt;&lt;/dd&gt;\n  &lt;dt class='w-100'&gt;&lt;/dt&gt;\n  &lt;dt class='col-sm-2'&gt;Last Sign In at&lt;/dt&gt;\n  &lt;dd class='col'&gt;&lt;%= @user.last_sign_in_at.to_s :short %&gt;&lt;/dd&gt;\n  &lt;dt class='w-100'&gt;&lt;/dt&gt;\n&lt;/dl&gt;\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"rails\">Rails</h1>\n\n<h2 id=\"overrides\">Overrides</h2>\n\n<p>There are two files that configure and override bootstrap</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/stylesheets/application.sass\n// default\n@import 'common/variable_default_values'\n\n// node_modules\n@import 'bootstrap/scss/bootstrap'\n\n// common\n@import 'common/variables'\n@import 'common/bootstrap_overrides'\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/stylesheets/common/bootstrap_overrides\n// it is not actually overrides, but additional classes that modify existing\n\n// this is used if you want btn inside h1\n.btn.btn__font-size-inherit\n  font-size: inherit\n</code></pre></div></div>\n\n<h2 id=\"nabar\">Nabar</h2>\n\n<p>https://getbootstrap.com/docs/4.0/examples/navbars/ shows different styles</p>\n\n<p>Here is an example adding style for specific media for alert</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/stylesheets/common.scss\n@import \"bootstrap-variables\";\n\n.hidden-left {\n  position: absolute;\n  left: -1000px;\n}\n\n@media(min-width:$screen-sm){\n  .alert {\n    position: absolute;\n    top: 8px;\n    padding: 8px;\n    padding-right: 30px; // close sign\n    z-index: 9999;\n    left: 480px; // enought to see nav buttons\n  }\n}\n</code></pre></div></div>\n\n<p>Still, default rails form build will render <code class=\"highlighter-rouge\">field_with_errors</code> on label and\ninput wrap, so if you need to change for bootstrap error classes.\nNote that with Bootstrap 3, you have to change <code class=\"highlighter-rouge\">control-group</code> to <code class=\"highlighter-rouge\">form-group</code>,\nadd <code class=\"highlighter-rouge\">form-control</code> to <code class=\"highlighter-rouge\">&lt;input&gt;</code> elements, <code class=\"highlighter-rouge\">help-inline</code> to <code class=\"highlighter-rouge\">help-block</code>, and\n<code class=\"highlighter-rouge\">warning</code> to <code class=\"highlighter-rouge\">has-warning</code> or <code class=\"highlighter-rouge\">error</code> to <code class=\"highlighter-rouge\">has-error</code>.\nThe easiest approach is with <strong>bootstrap form</strong>.</p>\n\n<h2 id=\"bootstrap-form\">Bootstrap form</h2>\n\n<p><a href=\"https://github.com/bootstrap-ruby/rails-bootstrap-forms\">bootstrap_form gem rails-bootstrap-forms\ngit</a> (not old pluralize\n<a href=\"https://github.com/sethvargo/bootstrap_forms\">bootstrap_forms</a>). Just add two\nlines</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# adding bootstrap_form_for\ngem 'bootstrap_form'\nHERE_DOC\n\nsed -i app/assets/stylesheets/application.css -e '1i\\\n/*\\\n *= require rails_bootstrap_forms\\\n */'\n# or sass\ncat &gt;&gt; app/assets/stylesheets/application.sass &lt;&lt; HERE_DOC\n// gems\n@import 'rails_bootstrap_forms'\nHERE_DOC\n</code></pre></div></div>\n\n<p>and use your <code class=\"highlighter-rouge\">bootstrap_form_for</code></p>\n\n<p>You can use <a href=\"https://github.com/bootstrap-ruby/rails-bootstrap-forms#horizontal-forms\">horizontal\nforms</a>\nwith <code class=\"highlighter-rouge\">layout: :horizontal</code> (note that it won’t work for string <code class=\"highlighter-rouge\">layout:\n'horizontal'</code>). You can add options <code class=\"highlighter-rouge\">label_col: 'col-sm-4', control_col:\n'col-sm-8'</code>. Also you can override <code class=\"highlighter-rouge\">control_class</code>, <code class=\"highlighter-rouge\">wrapper_class</code> (if it is a\nhash you can override any option).</p>\n\n<p>If you want all controlls and submit button to be in one line, you can use\n<code class=\"highlighter-rouge\">layout: :inline</code>.</p>\n\n<p>you can make checkbox inline with button</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.check_box :remember_me, inline: true %&gt;\n  &lt;%= f.submit t \"sign_in\" %&gt;\n</code></pre></div></div>\n\n<p>You can use form to have horizontal layout, and some input group can be inline,\nso you can group input and select (note that is you have horizontal layout you\ncan not use this since col-sm-2 and col-sm-10 will be added, look below for\ncustom form builder).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/todos/_form.html.erb %&gt;\n&lt;%= bootstrap_form_for @task, url: todos_path do |f| %&gt;\n  &lt;div class=\"form-inline\"&gt;\n    &lt;%= f.label :name %&gt;\n    &lt;div class=\"input-group input-group__with-select\"&gt;\n      &lt;%= f.text_field :name, input_group_class: 'input-group-under-group-with-select', skip_label: true %&gt;\n      &lt;%= f.select :id, 1..5, skip_label: true %&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/stylesheets/application.scss\n.input-group__with-select {\n  .input-group-under-group-with-select,.form-group {\n    position: initial;\n    display: initial;\n    border-collapse: initial;\n  }\n  .form-control {\n    width: 50%!important;\n  }\n}\n</code></pre></div></div>\n\n<p>You can prepend or append strings or buttons</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.text_field :price, append: '$' %&gt;\n  &lt;%= f.text_field :body, append: f.primary(t('send')) %&gt;\n</code></pre></div></div>\n\n<p>Checkboxes or radio buttons should be inside a <code class=\"highlighter-rouge\">form-group</code> if you want to show\nthem indented (inside wrapper class) and to show label (control class) and help\ntext</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.form_group label: { text: 'Admin', for: 'admin' }, help: 'This option enables admin' do %&gt;\n    &lt;%= f.check_box :admin, hide_label: true, id: 'admin' %&gt;\n  &lt;% end %&gt;\n</code></pre></div></div>\n\n<p>To hide label instead of <code class=\"highlighter-rouge\">label: ''</code> you need to use <code class=\"highlighter-rouge\">hide_label: true</code></p>\n\n<p>Static text can be displayed with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%= f.static_control :email %&gt;\n&lt;%= f.static_control label: 'Custom Static Control' do %&gt;\n  Content here\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<p>You can use original rails form builder appending <code class=\"highlighter-rouge\">_without_bootstrap</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.text_field_without_bootstrap :name %&gt;\n</code></pre></div></div>\n\n<h2 id=\"form-builder\">Form builder</h2>\n\n<p>You can write your own form builder that extends for example\n<a href=\"https://github.com/bootstrap-ruby/rails-bootstrap-forms\">rails-bootstrap-forms</a>\nBut since <code class=\"highlighter-rouge\">bootstrap_form_for</code> (which is defined inside helper) calculate layout\nclass (<code class=\"highlighter-rouge\">:inline</code> or <code class=\"highlighter-rouge\">:horizontal</code>) we need to use same helper\n(<code class=\"highlighter-rouge\">bootstrap_form_for ... builder: MyFormBuilder</code> instead of <code class=\"highlighter-rouge\">form_for ...\nbuilder: MyFormBuilder</code>). I noticed huge chrome memory problems (memory chrome\nis increasing when there is no <code class=\"highlighter-rouge\">form-horizontal</code> class).</p>\n\n<p>Oneliner form is using button_to with: input label, target url, form class…</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%= button_to t('notify'), notify_device_path(device), class: 'btn btn-sm btn-secondary', title: t('send_notification_to_this_device'), form_class: 'd-inline' %&gt;\n</code></pre></div></div>\n\n<p>You can change default <code class=\"highlighter-rouge\">col-sm-2</code> control col class</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/bootstrap_form.rb\nmodule BootstrapForm\n  class FormBuilder\n    def default_label_col\n      'col-sm-3'\n    end\n    def default_control_col\n      'col-sm-9'\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>Here is example of input with select base od\n<a href=\"http://jsfiddle.net/MansukhKhandhar/4309n31p/1/\">example</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/form_builders/my_form_builder.rb\nclass MyFormBuilder &lt; BootstrapForm::FormBuilder\n  def my_text_field(method, options = {})\n    content_tag :div, class: \"my-wrapper\" do\n      super method, options\n    end\n  end\n  def text_field_with_select(method_for_text_input, options_for_text_input, method_for_select, choices, options_for_select = {}, html_options = {})\n    content_tag :div, class: \"from-group form-group__with_select\" do\n      form_group_builder method_for_text_input, options_for_text_input do\n        select_without_group = form_group_builder_without_group(method_for_select, options_for_select, html_options) do\n          select_without_bootstrap(method_for_select, choices, options_for_select, html_options)\n        end\n        text_field_without_bootstrap(method_for_text_input, options_for_text_input) +\n          select_without_group\n      end\n    end\n  end\n\n  # this will overwrite all f.submit form helpers. data-disable-with does not\n  # work well when responding with csv so there you should explicitly disable:\n  # &lt;%= f.submit \"Generate CSV\", 'data-disable-with': nil %&gt;\n  def submit(name, options = {})\n    options.reverse_merge! 'data-disable-with': \"&lt;i class='fa fa-spinner fa-spin'&gt;&lt;/i&gt; #{name}\"\n    hidden_field_tag(:commit, name) +\n      button(name, options)\n  end\n\n  def single_image_upload(method, options = {})\n    \n  end\n\n  private\n\n  def form_group_builder_without_group(method, options, html_options = nil)\n    # copy from original form_group_builder\n    # bootstrap_form-2.5.2/lib/bootstrap_form/form_builder.rb\n    options.symbolize_keys!\n    html_options.symbolize_keys! if html_options\n\n    # Add control_class; allow it to be overridden by :control_class option\n    css_options = html_options || options\n    control_classes = css_options.delete(:control_class) { control_class }\n    css_options[:class] = [control_classes, css_options[:class]].compact.join(\" \")\n\n    options = convert_form_tag_options(method, options) if acts_like_form_tag\n\n    wrapper_class = css_options.delete(:wrapper_class)\n    wrapper_options = css_options.delete(:wrapper)\n    help = options.delete(:help)\n    icon = options.delete(:icon)\n    label_col = options.delete(:label_col)\n    control_col = options.delete(:control_col)\n    layout = get_group_layout(options.delete(:layout))\n    form_group_options = {\n      id: options[:id],\n      help: help,\n      icon: icon,\n      label_col: label_col,\n      control_col: control_col,\n      layout: layout,\n      class: wrapper_class\n    }\n\n    if wrapper_options.is_a?(Hash)\n      form_group_options.merge!(wrapper_options)\n    end\n\n    unless options.delete(:skip_label)\n      if options[:label].is_a?(Hash)\n        label_text  = options[:label].delete(:text)\n        label_class = options[:label].delete(:class)\n        options.delete(:label)\n      end\n      label_class ||= options.delete(:label_class)\n      label_class = hide_class if options.delete(:hide_label)\n\n      if options[:label].is_a?(String)\n        label_text ||= options.delete(:label)\n      end\n\n      form_group_options.merge!(label: {\n        text: label_text,\n        class: label_class,\n        skip_required: options.delete(:skip_required)\n      })\n    end\n    form_group_without_group(method, form_group_options) do\n      yield\n    end\n  end\n\n  def form_group_without_group(*args, &amp;block)\n    options = args.extract_options!\n    name = args.first\n\n    options[:class] = [\"form-group\", options[:class]].compact.join(' ')\n    options[:class] &lt;&lt; \" #{error_class}\" if has_error?(name)\n    options[:class] &lt;&lt; \" #{feedback_class}\" if options[:icon]\n\n    control = capture(&amp;block).to_s\n    control.concat(generate_help(name, options[:help]).to_s)\n    control.concat(generate_icon(options[:icon])) if options[:icon]\n\n    control\n  end\nend\nend\n</code></pre></div></div>\n\n<h2 id=\"data-confirm-modal\">Data confirm modal</h2>\n\n<p>When rails use <code class=\"highlighter-rouge\">data-confirm='Are you sure?'</code> it opens default browser’s builtin\n<code class=\"highlighter-rouge\">confirm()</code>. Instead of that, you can open bootstrap 3 or 4 modal with\n<a href=\"https://github.com/ifad/data-confirm-modal\">https://github.com/ifad/data-confirm-modal</a></p>\n\n<h2 id=\"navbar\">Navbar</h2>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">navbar</code> is starting class which <code class=\"highlighter-rouge\">display: flex; flex-wrap: wrap; align-items:\ncenter; justify-content: space-between</code> (so if you have two childs like\n<code class=\"highlighter-rouge\">navbar-brand</code> and <code class=\"highlighter-rouge\">navbar-toggler</code> they will be on left and right side, but\n<code class=\"highlighter-rouge\">navbar-collapse</code> has <code class=\"highlighter-rouge\">flex-grow: 1; flex-basis: 100%</code> so that’s why it looks\nlike it’s on left, also <code class=\"highlighter-rouge\">navbar-expand-lg</code> has <code class=\"highlighter-rouge\">justify-content: flex-start</code>).</li>\n  <li><code class=\"highlighter-rouge\">navbar-light bg-light</code> to add colors (it will change color of nav-links)</li>\n  <li><code class=\"highlighter-rouge\">navbar-collapse</code> contains all navbar. add <code class=\"highlighter-rouge\">navbar-expand-lg</code> on navbar so on\nlg <code class=\"highlighter-rouge\">navbar-toggler</code> dissapears, <code class=\"highlighter-rouge\">navbar-collapse</code> expands and <code class=\"highlighter-rouge\">navbar-nav</code>\nchange from <code class=\"highlighter-rouge\">column</code> to <code class=\"highlighter-rouge\">flex-direction: row</code>. Inside <code class=\"highlighter-rouge\">navbar-collapse</code> beside\n<code class=\"highlighter-rouge\">navbar-nav</code> you can also nest one more <code class=\"highlighter-rouge\">navbar-nav ml-auto</code> if you want to\npull some links to right.</li>\n</ul>\n\n<h2 id=\"cards\">Cards</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;div class=\"card\" style=\"width: 18rem;\"&gt;\n  &lt;img class=\"card-img-top\" src=\".../100px180/\" alt=\"Card image cap\"&gt;\n  &lt;div class=\"card-body\"&gt;\n    &lt;h5 class=\"card-title\"&gt;Card title&lt;/h5&gt;\n    &lt;p class=\"card-text\"&gt;Some quick example text to build on the card title and make up the bulk of the card's content.&lt;/p&gt;\n    &lt;a href=\"#\" class=\"btn btn-primary\"&gt;Go somewhere&lt;/a&gt;\n  &lt;/div&gt;\n&lt;/div&gt;\n</code></pre></div></div>\n\n<p>Cards occupy full width, so you need to set width manually.\nYou can use <code class=\"highlighter-rouge\">card-group</code> or <code class=\"highlighter-rouge\">card-deck</code> (it has padding), or you can simply add\n<code class=\"highlighter-rouge\">d-flex flex-wrap</code> to wrapped element.\n<code class=\"highlighter-rouge\">card-body</code> is used for padding.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/stylesheets/components/sizes.sass\n.card--max-width\n  @include media-breakpoint-up(md)\n    // single card on sm and start with two on a md(minus two margins m-2)\n    max-width: map-get($grid-breakpoints, 'md') / 2 - to-px(2 * map-get($spacers, 2))\n\n# app/views/cards/index.html\n&lt;div class='d-flex flex-wrap justify-content-center'&gt;\n  &lt;% @tasks.all.each do |task| %&gt;\n    &lt;div class='card m-2 card--max-width'&gt;\n      &lt;div class='card-body'&gt;\n</code></pre></div></div>\n\n<p>To add buttons to card using list group, use flush to remove some borders and\nrender edge to edge, use <code class=\"highlighter-rouge\">btn</code> to add hover icon</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;div class='card'&gt;\n  &lt;div class='list-group list-group-flush text-center'&gt;\n    &lt;%= button_tag class: 'list-group-item list-group-item-action btn' do %&gt;\n      &lt;i class=\"fa fa-pencil-alt\" aria-hidden=\"true\"&gt;&lt;/i&gt;\n      &lt;%= t('edit') %&gt;\n    &lt;% end %&gt;\n  &lt;/div&gt;\n</code></pre></div></div>\n\n<h2 id=\"login-box\">Login box</h2>\n\n<p>On responsive, instead of margin (margin is used with auto so it is\ncentered on bigger screens) you can use <code class=\"highlighter-rouge\">max-width: 90vw</code> or better is to wrap\ninside container with <code class=\"highlighter-rouge\">padding: 0.5rem</code>.\nSince I like to put a logo and text which is larger than box, I use two times\nmax with and mx-auto, one for wrapper (60rem) and one for white box (sm size).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/stylesheets/common/sizes.sass\n.login--wrapper-max-width\n  max-width: 60rem\n\n.login--max-width\n  max-width: 30rem\n\n# app/views/layouts/application.html.erb\n  &lt;% if login_layout? %&gt;\n    &lt;body&gt;\n      &lt;div class='text-center'&gt;\n        &lt;%= link_to root_path do %&gt;\n          &lt;%= image_tag 'cable_crm_logo.png', class: 'login-logo' %&gt;\n        &lt;% end %&gt;\n        &lt;h2&gt;&lt;%= login_title %&gt;&lt;/h2&gt;\n      &lt;/div&gt;\n      &lt;div class='container'&gt;\n        &lt;div class='login--wrapper-max-width mx-auto'&gt;\n          &lt;div class=\"&lt;%= 'login--max-width mx-auto bg-white shadow p-4' unless controller_name == 'companies' %&gt;\"&gt;\n            &lt;%= yield %&gt;\n          &lt;/div&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/body&gt;\n  &lt;% else %&gt;\n</code></pre></div></div>\n\n<h2 id=\"sidebar\">Sidebar</h2>\n\n<p>https://bootstrapious.com/p/bootstrap-sidebar#3-fixed-scrollable-sidebar-menu-with-a-content-overlay</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/stylesheets/components/sidebar.sass\n$sidebar-width: 20rem\n#sidebar\n  &amp;.active\n    right: 0\n  min-width: $sidebar-width\n  max-width: $sidebar-width\n  height: 100vh\n  position: fixed\n  top: 0\n  right: -$sidebar-width\n  background: #7386D5\n  color: #fff\n  transition: right 0.3s\n  z-index: 9999\n\n.sidebar__overlay\n  display: none\n  position: fixed\n  width: 100vw\n  height: 100vh\n  background: rgba(0, 0, 0, 0.7)\n  z-index: 998\n  opacity: 0\n  transition: all 0.5s ease-in-out\n  &amp;.active\n    display: block\n    opacity: 1\n\n.sidebar__dismiss\n  width: 35px\n  height: 35px\n  position: absolute\n  top: 10px\n  right: 10px\n\n# app/views/layouts/_sidebar.html.erb\n&lt;nav id='sidebar'&gt;\n  &lt;div class='sidebar__dismiss' data-toggle-active='#sidebar,.sidebar__overlay'&gt;\n    &lt;i class=\"fa fa-times\"&gt;&lt;/i&gt;\n  &lt;/div&gt;\n\n  &lt;ul class='list-unstyled'&gt;\n    &lt;p&gt;My App&lt;/p&gt;\n    &lt;li class='&lt;%= 'active' if controller_name == 'tasks' %&gt;'&gt;\n      &lt;%= link_to 'Past tasks', '#' %&gt;\n    &lt;/li&gt;\n  &lt;/ul&gt;\n&lt;/nav&gt;\n&lt;div class='sidebar__overlay' data-toggle-active='#sidebar,.sidebar__overlay'&gt;&lt;/div&gt;\n</code></pre></div></div>\n\n<h1 id=\"improvements\">Improvements</h1>\n\n<ul>\n  <li>create classes for text primary for list groups. There is only a color\nvariants <code class=\"highlighter-rouge\">list-group-item-primary</code> but I do not see variant with white\nbackground and blue text\nhttps://github.com/twbs/bootstrap/blob/v4-dev/scss/_list-group.scss#L148\nMy fix is:\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// by defauls list-group-item-action.active background is white, but when we add\n// text-primary if overrides that, so we need to define again\n.list-group-item-action.active.text-primary\n  color: #ffffff !important\n  &amp;:hover\n    color: #ffffff !important\n</code></pre></div>    </div>\n  </li>\n</ul>\n"
    } ,
  
    {
      "title"    : "HTTP theory",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/02/23/http-theory/",
      "date"     : "2017-02-23 00:00:00 +0100",
      "content"  : "<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP\">HTTP</a> is appliation layer\nprotocol often based on TCP/IP layer (reliable) and follows classical client\nserver model.</p>\n\n<p>Requests are sent by ony entity, the user-agent. Usually it is Web browser but\nan be a robot that crawls the web to populate and maintain a search engine\nindex. Server is usually not a single machine, but a collection of servers\nsharing the load (load balancing), cache, database server… Between server and\nweb browser there could be other proxies (logging, authentication, filtering).</p>\n\n<p>Http is stateless, there is no link between two requests, but using Http Headers\nwe can create Http Cookies allowing session creation to share some context.</p>\n\n<p>Http/1.0 open a TCP connection for each request/response exchange, so it is not\nso efficient. Http/2 use multiplexing messages over a single connection, keep\nthe connection warm and more efficient.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>GET / HTTP/1.1\nHost: developer.mozzila.org\n\nbody line\n</code></pre></div></div>\n\n<p>Request consists of start line, headers, empty line and a body. Start line\ndefines:</p>\n\n<ul>\n  <li>Method: GET,\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP\">POST</a> HEAD OPTIONS</li>\n  <li>Path usually without protocol, domain, port, only absolute path. But it can\nvary depending on method (for example <code class=\"highlighter-rouge\">CONNECT asd.asd:80 HTTP/1.1</code> <code class=\"highlighter-rouge\">OPTIONS *\nHTTP/1.1</code>)</li>\n  <li>Protocol Version (HTTP/1.1)</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>HTTP/1.1 200 OK\nDate: 1 Jan 2017\nServer: Apache\n</code></pre></div></div>\n\n<p>Response consists of status line, headers, empty line and a body. Status line\ndefines:</p>\n\n<ul>\n  <li>Protocol Version (HTTP/1.1)</li>\n  <li>Status code (200)</li>\n  <li>Status message (non authoritative short description of status code, purely\ninformational)</li>\n</ul>\n\n<blockquote>\n  <p>Using Http headers (not available in Http/0.9) we can set varius properties of\nrequest and response.</p>\n</blockquote>\n\n<p>Header syntax is: case insensitive string followed by colon and value on single\nline. They can be:</p>\n\n<ul>\n  <li>general headers: like <code class=\"highlighter-rouge\">via</code>, <code class=\"highlighter-rouge\">connection</code>, <code class=\"highlighter-rouge\">upgrade-insecure-requests</code></li>\n  <li>request headers: like <code class=\"highlighter-rouge\">host</code>, <code class=\"highlighter-rouge\">user-agent</code>, <code class=\"highlighter-rouge\">accept</code>, <code class=\"highlighter-rouge\">accept-type</code>, <code class=\"highlighter-rouge\">accept-language</code></li>\n  <li>response headers: like <code class=\"highlighter-rouge\">accept-ranges</code>, <code class=\"highlighter-rouge\">vary</code>, <code class=\"highlighter-rouge\">access-control-allow-origin</code>,\n<code class=\"highlighter-rouge\">etag</code>, <code class=\"highlighter-rouge\">server</code>, <code class=\"highlighter-rouge\">set-cookie</code></li>\n  <li>entity headers: like <code class=\"highlighter-rouge\">content-type</code> <code class=\"highlighter-rouge\">content-length</code>, <code class=\"highlighter-rouge\">content-encoding</code>,\n<code class=\"highlighter-rouge\">last-modified</code>\n    <ul>\n      <li><code class=\"highlighter-rouge\">content-type</code> is it used to define body (usually POST requests) which can\nbe single resource or multiple resource body (mime is multipart/form-data).\nSingle resource usually has <code class=\"highlighter-rouge\">content-lenght</code> but can have unknown length in\ncase of <code class=\"highlighter-rouge\">transfer-encoding</code></li>\n    </ul>\n  </li>\n</ul>\n\n<h1 id=\"identifying-resources-on-the-web\">Identifying resources on the web</h1>\n\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Identifying_resources_on_the_Web\">link</a>\ntarget of the Http request is “resourse” which is identified with Uniform\nResource Identifier URI.\nURL Uniform Resource Locator (is kind of URI) is most\ncommon form of URI and is known as web address (location)\n<code class=\"highlighter-rouge\">http://www.example.com:80/path/to/file.html?key1=value1?key2=value2#SomewhereInDocument</code>\nIt consists scheme or protocol (http, data, file, ftp, mailto, ssh, tel, urn,\nview-source, ws/wss). Than follows domain name or ip address, port, path\n(handled by web server), query (key value pairs separated with &amp;) and fragment\n(hash, anchor is never sent to the server).\nURN is URI that identifies resource by name in namespace: <code class=\"highlighter-rouge\">urn:ietf:rfc:7230</code>\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Identifying_resources_on_the_Web\">Data\nURI</a>\ncan be used to embed small files inline in documents: <code class=\"highlighter-rouge\">data:'image/jpeg',&lt;data&gt;</code>\nor <code class=\"highlighter-rouge\">data:text/plain,&lt;script&gt;alert('hi');&lt;/script&gt;</code>. To encode data into base64\nformat you can use <code class=\"highlighter-rouge\">uuencode</code> command line tool. Do not forget to add <code class=\"highlighter-rouge\">,</code> before\ndata segment.</p>\n\n<h1 id=\"mime-types\">Mime types</h1>\n\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_Types\">mime\ntype</a>\nhas format <code class=\"highlighter-rouge\">type/subtype</code> (lowercase without space). File extension is not used\nin browser, only mime type. <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Complete_list_of_MIME_types\">list of all mime\ntypes</a>.\nMost common type(subtype) is one of the discrete:</p>\n\n<ul>\n  <li>text (plain, html, css, javascript)\n    <ul>\n      <li>for css files we have to use mime type <code class=\"highlighter-rouge\">text/css</code> not (<code class=\"highlighter-rouge\">text/plain</code>)</li>\n      <li><code class=\"highlighter-rouge\">text/csv</code> is used for csv (chrome does not open, but chromium opens libre\noffice). Usually do not need to specify since browser can detect that based on\nrequest (you can simple <code class=\"highlighter-rouge\">render text: 'col1,col2'</code>)</li>\n    </ul>\n  </li>\n  <li>image (gif, png, jpeg, bmp, webp)</li>\n  <li>audio (midi, mpeg, webm, ogg, wav)</li>\n  <li>video (webm, ogg)</li>\n  <li>application (xml, pdf, octet-stream)\n    <ul>\n      <li><code class=\"highlighter-rouge\">application/octet-stream</code> is unknown binary file, same as if\n<code class=\"highlighter-rouge\">Content-Disposition: attachment</code> header is set, so browser will “Save as”</li>\n      <li><code class=\"highlighter-rouge\">content-type: application/x-www-form-urlencoded</code> and body\n<code class=\"highlighter-rouge\">name=Joe%20User&amp;request=Send%20me%20one%20of%20your%20catalogue</code> is another\nexample of request.</li>\n    </ul>\n  </li>\n</ul>\n\n<p>or multipart:</p>\n\n<ul>\n  <li>\n    <p><code class=\"highlighter-rouge\">multipart/form-data</code> is used for html forms and consists multiple parts\nseparated with boundary string that starts with <code class=\"highlighter-rouge\">--</code> and each part has its own\nmime type (inside Content-Type header) and Content-Disposition, for example</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Content-Type: multipart/form-data; boundary=aBoundaryString\n(other headers associated with the multipart document as a whole)\n\n--aBoundaryString\nContent-Disposition: form-data; name=\"myFile\"; filename=\"img.jpg\"\nContent-Type: image/jpeg\n\n(data)\n--aBoundaryString\nContent-Disposition: form-data; name=\"myField\"\n\n(data)\n--aBoundaryString--\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p><code class=\"highlighter-rouge\">multipart/byteranges</code> is used to send partial content of the files</p>\n  </li>\n</ul>\n\n<p>Mime sniffing is used when client believes that mime type is incorrect, so they\ntry to guess the correct value by looking at the resource. Server can block\nsniffing by sending <code class=\"highlighter-rouge\">X-Content-Type-Options</code>.</p>\n\n<p>You can use mime url data inside inline html and css, for example:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;a href=\"data:text/plain;base64,SGVsbG8sIFdvcmxkIQ%3D%3D\" download&gt;Click here to\ndownload file&lt;/a&gt;\n\n&lt;img alt=\"Embedded Image\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIA...\" /&gt;\n\ndiv.image {\n  width:100px;\n  height:100px;\n  background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIA...);\n}\n</code></pre></div></div>\n\n<p>If you chose that apex domain is your canonical location, than you need to add\nhttp 301 redirection for <code class=\"highlighter-rouge\">www.example.com</code> to <code class=\"highlighter-rouge\">example.com</code>. Or you can use\nspecial link element in head part of the page: <code class=\"highlighter-rouge\">&lt;link\nhref=\"http://example.cin/whaddup\" rel=\"canonical\"&gt;</code></p>\n\n<p>Http/1.1 enable warm connections so it does not close after first request is\ncompleted <code class=\"highlighter-rouge\">Connection: keep-alive</code> header. Drawback is server need to consume\nresources to keep open connections (DOS attack).\nPipeling ie second request is send before answer for the first is received. Only\nidempotent methods (GET, HEAD, PUT, DELETE) can be pipelined. It is difficult to\nimplement and browser do not use it (anyway Http/2 multiplexing solve this\nproblem). Browser simply opens 6 different connections with a server and use\nthem in parallel.\nCache control mechanism is introduced, <code class=\"highlighter-rouge\">HOST</code> header enable multiple domains at\nthe same ip address.</p>\n\n<p>SSL (and later <a href=\"https://en.wikipedia.org/wiki/Transport_Layer_Security\">TLS</a>)\nprotocol is used to secure communication between server and web browser (https):</p>\n\n<ul>\n  <li>connection is private (secure) by using symmetic cryptography</li>\n  <li>identity (typically server) can be authenticated using publi-key crypthography</li>\n  <li>connection ensures integrity</li>\n</ul>\n\n<p>REST representational state transfer) pattern was introduced in 2000 for complex\napplications (API defined using specific URI with basic Http/1.1 methods).</p>\n\n<p>In 2005 extension like <code class=\"highlighter-rouge\">server-sent events</code> and <code class=\"highlighter-rouge\">websockets</code>.\nIn 2010 Google implements protocol SPDY which increase in responsiveness and\nsolving a problem of data transmitted duplication (inspiration for Http/2)\nIn 2015 Http/2 standardized with a several differences from Http/1.1\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Evolution_of_HTTP\">link</a></p>\n\n<ul>\n  <li>it is binary protocol rather than text, so it can no longer be read and\ncreated manually</li>\n  <li>it is multiplexed so parallel requests can be send on one connection</li>\n  <li>compress headers</li>\n  <li>allows server to populate data in client cache</li>\n</ul>\n\n<p>http/2 is transparent to web developers, it is just additional step between\nhttp/1.1 and transport protocol. When it is available on server and browser it\nis automatically switched on and used.</p>\n\n<p>In 2016 some important extensions are:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">Alt-Svc</code> header for location of the resource</li>\n  <li><code class=\"highlighter-rouge\">Client-Hints</code> information about client or web browser</li>\n</ul>\n\n<h1 id=\"cache\">Cache</h1>\n\n<h1 id=\"session\">Session</h1>\n\n<p>Using Http cookies you can link requests to some state of the server (event http\nis state-less protocol).</p>\n\n<h1 id=\"cors\">CORS</h1>\n\n<p>Web browsers enforce strict separation between web sites. Only resources from\n<em>Same origin</em> can be accessed. But there are exceptions. Cross origin resource\nsharing <a href=\"https://developer.mozilla.org/en-US/docs/Glossary/CORS\">CORS</a></p>\n\n<p>Allow cors on server so options request are resolved</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo \"gem 'rack-cors', require: 'rack/cors'\" &gt;&gt; Gemfile\nbundle\n\nsed -i config/application.rb -e '/^  end/i \\\n\\\n    config.middleware.insert_before 0, \"Rack::Cors\" do\\\n      allow do\\\n        origins \"*\"\\\n        resource(\\\n          \"*\",\\\n          headers: :any,\\\n          methods: :any,\\\n          expose: [\\\n            \"access-token\",\\\n            \"expiry\",\\\n            \"token-type\",\\\n            \"uid\",\\\n            \"client\",\\\n            \"Content-Range\", # clean_pagination\\\n            \"Accept-Ranges\", # clean_pagination\\\n          ],\\\n        )\\\n      end\\\n    end'\n</code></pre></div></div>\n\n<p>You can enable CORS only for specific actions. For example if you are loading\nform on other sites to create and update, you can enable cors for that actions.\nWhen you are loading javascript from other domains like</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;script type=\"text/javascript\" src=\"//localhost:3002/widget/1\"&gt;&lt;/script&gt;\n</code></pre></div></div>\n\n<p>than on your server you will get error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActionController::InvalidCrossOriginRequest (Security warning: an embedded &lt;script&gt; tag on another site requested protected JavaScript. If you know what you're doing, go ahead and disable forgery protection on this action to permit cross-origin JavaScript embedding.):\n</code></pre></div></div>\n\n<p>To solve that add</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  skip_before_action :verify_authenticity_token, only: [:widget]\n</code></pre></div></div>\n\n<p>When you want to submit form from another domain you get this error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\n</code></pre></div></div>\n\n<p>To solve that add</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  skip_before_action :verify_authenticity_token, only: [:widget, :create, :update]\n</code></pre></div></div>\n\n<p>To see response from submitted form request, you see in javascript console this\nwarning and $.ajax success callback is never triggered</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Failed to load http://localhost:3002/days/1: No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'http://localhost' is therefore not allowed access.\n</code></pre></div></div>\n\n<p>To solve that add</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  after_action :set_access_control_headers, :only =&gt; [:create, :update]\n\n  def set_access_control_headers\n    headers['Access-Control-Allow-Origin'] = '*'\n  end\n</code></pre></div></div>\n\n<h1 id=\"csp\">CSP</h1>\n\n<p>Content security policy\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP\">CSP</a></p>\n\n<h1 id=\"csrf\">CSRF</h1>\n\n<p>If your controller is protected from CSRF attack (it contains\nprotect_from_forgery) than use null session instead of exception:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i app/controllers/application_controller.rb -e '/protect_from_forgery/c \\\n  # protect_from_forgery with: :exception\\\n  protect_from_forgery with: :null_session'\n</code></pre></div></div>\n\n<p>You can disable CSRF Token authenticity for specific actions</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>skip_before_action :verify_authenticity_token, only: [:my_insecure_post_action]\n</code></pre></div></div>\n\n<h1 id=\"authentication\">Authentication</h1>\n\n<p>You can use <code class=\"highlighter-rouge\">WWW-Authenticate</code> header or setting sessiong key using Http cookie.</p>\n\n"
    } ,
  
    {
      "title"    : "Datatables",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/02/13/datatables/",
      "date"     : "2017-02-13 00:00:00 +0100",
      "content"  : "<h1 id=\"install\">Install</h1>\n\n<p><a href=\"https://datatables.net/\">datatables.net</a> install by simply <a href=\"https://datatables.net/download/#bs-3.3.7/jq-2.2.4/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.13/b-1.2.3/b-html5-1.2.3/b-print-1.2.3\">select packages and\ndownload</a>\nbut it will be 3M in one file. I think it is better to use yarn\nand install all dependencies that you have selected <a href=\"https://datatables.net/download/bower\">bower\npackages</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn add datatables.net-bs4\n</code></pre></div></div>\n<p>include them in application.js</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>//= require datatables.net/js/jquery.dataTables.js\n//= require datatables.net-bs4/js/dataTables.bootstrap4.js\n</code></pre></div></div>\n<p>and application.sass</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@import 'datatables.net-bs4/css/dataTables.bootstrap4.css'\n</code></pre></div></div>\n\n<p>Here is old bower example</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bower install --save datatables.net datatables.net-bs \\\n  Stuk/jszip pdfmake \\\n  datatables.net-buttons datatables.net-buttons-dt datatables.net-buttons-bs \\\n  select2 bootstrap-datepicker\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/javascript/application.js\n//= require jszip/dist/jszip.js\n//= require pdfmake/build/pdfmake.js\n//= require pdfmake/build/vfs_fonts.js\n//= require datatables.net/js/jquery.dataTables.js\n//= require datatables.net-bs/js/dataTables.bootstrap.js\n//= require datatables.net-buttons/js/dataTables.buttons.js\n//= require datatables.net-buttons/js/buttons.html5.js\n//= require datatables.net-buttons/js/buttons.print.js\n//= require select2/dist/js/select2\n//= require bootstrap-datepicker/dist/js/bootstrap-datepicker\n\n// app/assets/stylesheets/application.scss\n@import \"datatables.net-bs/css/dataTables.bootstrap\";\n@import \"datatables.net-buttons-dt/css/buttons.dataTables\";\n@import \"datatables.net-buttons-bs/css/buttons.bootstrap\";\n@import \"select2/dist/css/select2\";\n@import \"bootstrap-datepicker/dist/css/bootstrap-datepicker3\";\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$('#clicks-table').DataTable({\n  dom: 'Bfrtip',\n    buttons: [\n      'copy', 'csv', 'excel', 'pdf', 'print'\n    ]\n});\n</code></pre></div></div>\n\n<p>You can use\n<a href=\"https://github.com/rweng/jquery-datatables-rails\">jquery-datatables-rails</a>\ngem. Add gem to Gemfile and run <code class=\"highlighter-rouge\">rails g jquery:datatables:install</code>.\nIf you have <code class=\"highlighter-rouge\">Uncaught TypeError: Cannot read property 'mData' of undefined</code> than\nyou need to replace <code class=\"highlighter-rouge\">&lt;th colspan=\"3\"&gt;&lt;/th&gt;</code> with three `&lt;th&gt;&lt;/th&gt; &lt;th&gt;&lt;/th&gt;</p>\n<th></th>\n<p>`</p>\n\n<h1 id=\"data\">Data</h1>\n\n<p>Initial data could be inside (<a href=\"https://datatables.net/manual/data/#DOM\">DOM</a>) or\nyou can use ajax call to load all items. That is client side processing and it\nworks for less than <a href=\"https://datatables.net/manual/data/#Processing-modes\">10 000\nrows</a>. For greater than\n100 000 you should use server side processing. But problem is delay that occurs\n(at leat on rails) when it need to render 1000 rows, so we have to use server\nside processing. In that case we need to implement searching and ordering on\nserver.</p>\n\n<p>When using ajax you need to point where <a href=\"https://datatables.net/manual/ajax#Data-array-location\">data\narray</a> is in JSON object\n(<code class=\"highlighter-rouge\">dataSrc: ''</code> if we return array, or <code class=\"highlighter-rouge\">dataSrc: 'data'</code> if we return object with\ndata array).\nWe need to point where each column is on array item. If item is object\nwe can use their keys <code class=\"highlighter-rouge\">columns: [ { data: 'name' }, { data: 'price' } ]</code>.\nIf item is also array we can use their index <code class=\"highlighter-rouge\">columns: [ { data: 0 }, { data: 1\n} ]</code>. We can also omit <code class=\"highlighter-rouge\">columns</code> definition than it will use first column, first\ndata from array, second column second data …</p>\n\n<h1 id=\"server-side-processing\">Server side processing</h1>\n\n<p><a href=\"https://datatables.net/manual/server-side\">Server side processing</a> is enabled\nwith <code class=\"highlighter-rouge\">serverSide: true</code> and use <code class=\"highlighter-rouge\">data</code> or <code class=\"highlighter-rouge\">ajax</code> options. Note\nthat in this case any existing data will be discarded (you can not mix).</p>\n\n<p>There was a forum question to add data manually\n<a href=\"https://datatables.net/forums/discussion/16440/best-way-to-do-deferred-loading-client-side\">deferred loading client\nside</a>\nBest option is <a href=\"https://datatables.net/examples/server_side/defer_loading.html\">defer\nloading</a>\nJust add option <code class=\"highlighter-rouge\">deferLoading: &lt;%= @users.count %&gt;</code> than initially data from the\npage will be shown, than on any search, reorder or page, server side request\nwill be made. Note that you can not use <code class=\"highlighter-rouge\">data-order</code> and <code class=\"highlighter-rouge\">data-search</code> on\ninitial page (error is like <code class=\"highlighter-rouge\">datatables warning requested unknown parameter\n'[ojbect Object]' for row 0 column 7</code>).\nNote that when deferred loading is enabled, you can not use <code class=\"highlighter-rouge\">stateSave: true</code>\noption (which will remember sort and search inside localstorage).</p>\n\n<p>If you have long column names and a lot of columns (for example 10), than it\ncould be that url is too long, you can see in console <code class=\"highlighter-rouge\">414 (Request-URI Too\nLarge)</code>. Than you should switch to method POST and since post is used to create\nitems, you need to use another route <code class=\"highlighter-rouge\">search_products_path format: :json</code></p>\n\n<p>Request send a lot of params:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">\"draw\"=&gt;\"1\"</code> sequence counter so we know which one is last</li>\n  <li><code class=\"highlighter-rouge\">\"start\"=&gt;\"0\", \"length\"=&gt;\"10\"</code> for pagination</li>\n  <li><code class=\"highlighter-rouge\">\"search\"=&gt;{\"value\"=&gt;\"323\", \"regex\"=&gt;\"false\"}</code> global search for all coulmns\nwith searchable true</li>\n  <li><code class=\"highlighter-rouge\">\"order\"=&gt;{\"0\"=&gt;{\"column\"=&gt;\"0\", \"dir\"=&gt;\"asc\"}}</code> for ordering</li>\n  <li><code class=\"highlighter-rouge\">\"columns\"=&gt;{\"0\"=&gt;{\"data\"=&gt;\"name\", \"name\"=&gt;\"\", \"searchable\"=&gt;\"true\",\n\"orderable\"=&gt;\"true\", \"search\"=&gt;{\"value\"=&gt;\"\", \"regex\"=&gt;\"false\"}}</code> name and\nother properties of columns</li>\n</ul>\n\n<p>Server need to returns:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">draw</code> should be echo</li>\n  <li><code class=\"highlighter-rouge\">recordsTotal</code> total number before filtering</li>\n  <li><code class=\"highlighter-rouge\">recordsFiltered</code> total number after filtering</li>\n  <li><code class=\"highlighter-rouge\">data</code> array with data used in ajax option</li>\n</ul>\n\n<p>Example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n# for pagination\ngem 'will_paginate'\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/products.coffee\njQuery -&gt;\n  $('#products').dataTable(\n    ajax:\n      url: $('#products').data('source')\n      dataSrc: 'data'\n      error: (xhr, message, error) -&gt;\n        flash_alert(\"Please refresh the page. #{error}\")\n    columns: [\n      { data: 'name' }\n      { data: 'price' }\n      { data: 'description' }\n    ]\n    deferLoading: $('#products').data('total')\n    serverSide: true\n  )\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/datatables/products_datatable.rb\n# http://railscasts.com/episodes/340-datatables?autoplay=true\nclass ProductsDatatable\n  delegate :params, :page, :per_page, to: :@view\n  def initialize(view)\n    @view = view\n  end\n\n  def as_json(options = {})\n    {\n      draw: params[:draw].to_i,\n      recordsTotal: Product.count,\n      recordsFiltered: products.total_entries,\n      data: data,\n    }\n  end\n\n  private\n\n  def data\n    products.map do |product|\n      product.slice :name, :price, :description\n    end\n  end\n\n  def products\n    @products ||= fetch_products\n  end\n\n  def fetch_products\n    products = Product.order(\"#{sort_column } #{sort_direction}\")\n    products = products.page(page).per_page(per_page)\n    if params[:search][:value].present?\n      # ILIKE is case insensitive LIKE\n      sql = \"name ILIKE :search OR description ILIKE :search\"\n      # you can reference association but than references is needed\n      # sql += \" OR customers.name ILIKE :search\"\n      # sql += \" OR DATE_FORMAT(updated_at, '%d-%b-%Y') ILIKE :search\"\n      products = products\n        .where(sql, search: \"%#{params[:search][:value]}%\")\n        # .include(:customer)\n        # .references(:customer)\n    end\n    products\n  end\n\n  def page\n    params[:start].to_i / per_page + 1\n  end\n\n  def per_page\n    params[:length].to_i &gt; 0 ? params[:lenght].to_i : 10\n  end\n\n  def sort_column\n    columns = %w[name price description]\n    columns[params[:order][\"0\"][:column].to_i]\n  end\n\n  def sort_direction\n    params[:order][\"0\"][:dir] == \"desc\" ? \"desc\" : \"asc\"\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/products_controller.rb\nclass ProductsController &lt; ApplicationController\n  def index\n    @products = Product.all.limit 10\n  end\n\n  def search\n    render json: ProductsDatatable.new(view_context)\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/products/index.html.erb %&gt;\n&lt;table id=\"products\" data-source=\"&lt;%= products_path format: :json %&gt;\" data-total=\"&lt;%= Product.count %&gt;\"&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt;Name&lt;/th&gt;\n      &lt;th&gt;Price&lt;/th&gt;\n      &lt;th&gt;Description&lt;/th&gt;\n    &lt;/tr&gt;\n  &lt;/thead&gt;\n\n  &lt;tbody&gt;\n    &lt;% @products.each do |product| %&gt;\n      &lt;tr&gt;\n        &lt;td&gt;&lt;%= product.name %&gt;&lt;/td&gt;\n        &lt;td&gt;&lt;%= product.price %&gt;&lt;/td&gt;\n        &lt;td&gt;&lt;%= product.description %&gt;&lt;/td&gt;\n      &lt;/tr&gt;\n    &lt;% end %&gt;\n  &lt;/tbody&gt;\n&lt;/table&gt;\n</code></pre></div></div>\n\n<p>If you have nested models, you can order by <code class=\"highlighter-rouge\">customers.name asc</code> and search\n<code class=\"highlighter-rouge\">customers.name like '%a%'</code>, but you should use references since includes works\nonly with hash params: <code class=\"highlighter-rouge\">includes(:customer).where(\"customers.name like\n'%d%').references(:customer)</code>.</p>\n\n<h1 id=\"using-data-from-datatables\">Using data from datatables</h1>\n\n<p>Columns are defined using</p>\n\n<ul>\n  <li><a href=\"https://datatables.net/reference/option/columns\">columns</a> option which define\nall columns by its index (zero based). Note that all columns need to be defined</li>\n  <li><a href=\"https://datatables.net/reference/option/columnDefs\">columnDefs</a> <code class=\"highlighter-rouge\">targets</code> key\nwhich can use: number (index or negative index), string (class name without dot\non th element) <code class=\"highlighter-rouge\">targets: 'username'</code> for <code class=\"highlighter-rouge\">&lt;th class=\"username\"&gt;</code>. Note that we\ndo not need to define all columns, just those that we need to set up some\nproperty <code class=\"highlighter-rouge\">columnDefs: [ { targets: '_all', visible: false } ]</code></li>\n</ul>\n\n<p>Columns can be selected\n<a href=\"https://datatables.net/reference/type/column-selector\">column-selector</a> by:</p>\n\n<ul>\n  <li>its index</li>\n  <li>jQuery selector</li>\n  <li>columns.name (names should be\n<a href=\"https://datatables.net/reference/option/columns.name\">defined</a>).</li>\n</ul>\n\n<h1 id=\"export\">Export</h1>\n\n<p><a href=\"https://datatables.net/extensions/buttons/examples/initialisation/export.html\">export to csv,\npdf</a></p>\n\n<ul>\n  <li>you can configure that only visible columns will\n<a href=\"https://datatables.net/extensions/buttons/examples/print/columns.html\">print</a></li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$('#clicks-table').DataTable({\n  dom: 'B',\n  buttons: [\n    {\n      extend: 'pdf',\n      exportOptions: {\n        columns: ':not(.non-for-export),:visible',\n      }\n    },\n  ]\n});\n</code></pre></div></div>\n\n<p>If you have special simbols, you can try to enable <code class=\"highlighter-rouge\">bom: true</code> option.</p>\n\n<p>Export server side datatable\nhttps://diogenesggblog.wordpress.com/2017/02/02/how-to-export-all-rows-from-datatables-using-server-side-ajax/</p>\n\n<h1 id=\"dom\">DOM</h1>\n\n<p><a href=\"https://datatables.net/reference/option/dom\">dom</a> control buttons: <code class=\"highlighter-rouge\">l</code> for\nlenght change menu, <code class=\"highlighter-rouge\">B</code> buttons, <code class=\"highlighter-rouge\">t</code> table, <code class=\"highlighter-rouge\">p</code> pagination, <code class=\"highlighter-rouge\">r</code> processing\ndisplay, <code class=\"highlighter-rouge\">f</code> filtering.\nYou can add class <code class=\"highlighter-rouge\">move-up</code> for info and length <code class=\"highlighter-rouge\">il</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/clicks/index.html.erb\n$('#clicks-table').DataTable({\n  dom: 'Bfrtp&lt;\"move-up\"il&gt;',\n  processing: true,\n  oLanguage: {\n    // loader\n    sProcessing: '&lt;i class=\"fa fa-spinner fa-spin\" style=\"font-size:24px\"&gt;&lt;/i&gt; Processing...'\n  },\n});\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/stylesheets/datatable.scss\n@media(min-width:$screen-sm) {\n  .move-up {\n    margin-top: -50px;\n    position: relative;\n    z-index: -1;\n  }\n}\n</code></pre></div></div>\n\n<h1 id=\"seach-or-filter-is-used-for-filtering-out\">Seach (or filter is used for filtering out)</h1>\n\n<p>For search you can use html data attribute <code class=\"highlighter-rouge\">&lt;td\ndata-search=\"Novembar\"&gt;2.2.2012&lt;/td&gt;</code></p>\n\n<ul>\n  <li>when using <code class=\"highlighter-rouge\">data-search</code> then original text is not used, so it is better to\nmerge original text to <code class=\"highlighter-rouge\">data-search</code></li>\n  <li>when you are using <code class=\"highlighter-rouge\">&lt;a href=\"some-text\"&gt;</code> that <code class=\"highlighter-rouge\">some-text</code> will be matched\nalso</li>\n  <li>default <a href=\"https://datatables.net/reference/api/search()\">search(input, regex,\nsmart)</a> is <code class=\"highlighter-rouge\">regex=false,\nsmart=true</code>, that means any order of strings and matching substring. For example\n<code class=\"highlighter-rouge\">my name</code> is matched with <code class=\"highlighter-rouge\">my n a m m e e e e</code>. You can also use double quotes\n<code class=\"highlighter-rouge\">\"my name\"</code>.</li>\n  <li>it is usefull to add param search term and using regex, for example\n<code class=\"highlighter-rouge\">dule|mile</code>. Note that you HAVE TO disable smart search and use second param\n(false).</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  table.search(\"&lt;%= params[:search_term] %&gt;\", true, false).draw();\n</code></pre></div></div>\n\n<p>or you can search specific columns.</p>\n\n<h2 id=\"select-column\">Select column</h2>\n\n<p><a href=\"https://datatables.net/reference/api/column().search()\">link</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  table.columns( '.select-filter' ).every( function () {\n    var that = this;\n\n    // Create the select list and search operation\n    var select = $('&lt;select /&gt;')\n      .appendTo(\n        this.footer()\n      )\n      .on( 'change', function () {\n        that\n          .search( $(this).val() )\n          .draw();\n      } );\n\n    // Get the search data for the first column and add to the select list\n    this\n      .cache( 'search' )\n      .sort()\n      .unique()\n      .each( function ( d ) {\n          select.append( $('&lt;option value=\"'+d+'\"&gt;'+d+'&lt;/option&gt;') );\n      });\n  });\n</code></pre></div></div>\n\n<h1 id=\"order-sort\">Order (sort)</h1>\n\n<ul>\n  <li>disable ordering with\n<a href=\"https://datatables.net/reference/option/columns.orderable\">orderable</a> property \nor as data attribute on th element: <code class=\"highlighter-rouge\">&lt;th data-orderable=\"false\"&gt;</code></li>\n  <li>read about <a href=\"http://legacy.datatables.net/usage/columns\">usage columns</a> to\ndefine sort based on another column. Also hide some <code class=\"highlighter-rouge\">&lt;td class=\"hidden\"&gt;&lt;%=\nindex %&gt;&lt;/td&gt;</code> column both in css and in datatable\n<a href=\"https://datatables.net/examples/basic_init/hidden_columns.html\">hidden_columns</a></li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  \"aoColumnDefs\": [\n    { \"aDataSort\": [1], \"aTargets\": [0] },\n    { \"bVisible\": false, \"bSearchable\": false, \"aTargets\": [1] },\n  ],\n</code></pre></div></div>\n\n<ul>\n  <li>orthogonal data can be defined using <a href=\"https://datatables.net/manual/data/orthogonal-data#HTML-5\">html 5\nattributes</a> for\nordering data-sort is <code class=\"highlighter-rouge\">&lt;td data-order=\"&lt;%= post.created_at.to_datetime.to_i\n%&gt;\"&gt;2 Novemeber&lt;/td&gt;</code>.</li>\n  <li>\n    <p>you can also achieve sorting if you have ajax data</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/users/index.json.erb\njson.my_date do\n  json.display user.my_date.to_s\n  json.timestamp user.my_date.to_datetime.to_i\nend\njson.amount do\n  json.display humanized_money_with_symbol user.amount\n  json.cents user.amount.to_s\nend\njson.user do\n  json.display user.name\n  json.username user.username\nend\n\n# app/views/users/index.html.erb\ncolumns: [\n  { data: { _: 'my_date.display', sort: 'my_date.timestamp' } },\n  { data: { _: 'amount.display', sort: 'amount.cents' } },\n  { data: { _: 'user.display', filter: 'user.username' } },\n  ]\n</code></pre></div>    </div>\n  </li>\n  <li><a href=\"https://datatables.net/plug-ins/sorting/datetime-moment\">ultimate date time\nsorting</a> <a href=\"https://editor.datatables.net/examples/dates/datetime.html\">datetime\ninput</a></li>\n  <li><a href=\"https://datatables.net/examples/advanced_init/length_menu.html\">select page\nlength</a> with\n<a href=\"https://datatables.net/reference/option/lengthMenu\">lengthMenu</a> option</li>\n</ul>\n\n<h1 id=\"responsive\">Responsive</h1>\n\n<p>There are a lot of tools for\n<a href=\"https://datatables.net/extensions/responsive/examples/\">responsive</a>:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>responsive: true # enable responsive styles\nscrollX: true # enable horizontal scroll, problem on big screens because it does\n              # not occupy 100% width. if false, than only data will scroll but\n              # header will still be fixed\nscrollY: \"55vh\" # 55% of the vertical height of the browser window. Usefull\n                # since user can see footer navigation links\nscrollCollapse: true # if there are not data (when filtering) than table body\n                     # will collapse\nautoWidth: false # disable auto calculation for column width so on big screens\n                 # it occupy 100% width\n</code></pre></div></div>\n\n<p>Note that bootstrap tooltip won’t work since it is inside <code class=\"highlighter-rouge\">overflow-y: scroll;</code>\nelement (or <code class=\"highlighter-rouge\">overflow: hidden</code>) so you need to change where it is attached\n<code class=\"highlighter-rouge\">$.fn.tooltip.Constructor.DEFAULTS.container = 'body'</code>. Only <code class=\"highlighter-rouge\">&lt;select&gt;</code> element\nis natively shown over borders. You can use trick <code class=\"highlighter-rouge\">position:fixed</code></p>\n\n<p>Without horizontal scrolling you can hide some columns by <a href=\"https://datatables.net/extensions/responsive/examples/column-control/columnPriority.html\">column priority and\nexpand</a>\nor you can show <a href=\"https://datatables.net/extensions/responsive/examples/display-types/bootstrap-modal.html\">details in\nmodal</a></p>\n<ul>\n  <li>you can use <a href=\"https://datatables.net/extensions/fixedcolumns/examples/initialisation/left_right_columns.html\">fixed\ncolumns</a>\nso they always stays fixed, but all other columns can be scrolled</li>\n  <li>user can select which columns to see\n<a href=\"https://datatables.net/extensions/fixedcolumns/examples/initialisation/colvis.html\">colvis</a>\nnote: retired</li>\n</ul>\n\n<h1 id=\"custom-types\">Custom types</h1>\n\n<p><a href=\"https://datatables.net/development/type-detection\">type detection</a> is automati\nfor numeric, date and string, so default sorting works fine. If you want to do\ncustom searching than you need to use\n<a href=\"https://datatables.net/forums/discussion/36925\">$.fn.dataTableExt.afnFiltering.push</a>\nor newer\n<a href=\"https://datatables.net/manual/plug-ins/search\">$.fn.dataTable.ext.search</a>\nNote that is used on global search. If we add manually, than we need to remove\nalso.This\n<a href=\"https://codepen.io/markmichon/pen/tmeGD\">codepen</a> show how to add and remove\nfilter</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code></code></pre></div></div>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li><a href=\"https://datatables.net/extensions/select/examples/styling/bootstrap.html\">multiselect with ctrl or\nshift</a></li>\n  <li><a href=\"https://datatables.net/extensions/rowreorder/examples/\">drag and drop\nreorder</a></li>\n  <li>\n    <p>when you have a lot of columns (x-axis scrollbar is shown) than you can use\n<a href=\"https://datatables.net/extensions/fixedcolumns/examples/\">fixedColumns</a> which\nare always shown</p>\n  </li>\n  <li>another nice\n<a href=\"http://issues.wenzhixin.net.cn/bootstrap-table/index.html\">bootstrap-table</a></li>\n</ul>\n\n<h1 id=\"ajax-datatable-rails\">Ajax datatable rails</h1>\n\n<p>For this <a href=\"https://github.com/jbox-web/ajax-datatables-rails\">gem</a> you need to\ndefine view_columns, by default <code class=\"highlighter-rouge\">orderable</code> and <code class=\"highlighter-rouge\">searchable</code> are true, and\n<code class=\"highlighter-rouge\">cond</code> is <code class=\"highlighter-rouge\">:like</code> (<code class=\"highlighter-rouge\">:start_with</code>, <code class=\"highlighter-rouge\">:end_with</code>, <code class=\"highlighter-rouge\">:string_in</code>,… )</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  def view_columns\n    @view_columns ||= {\n      name: { source: \"User.name\", cond: :like }\n    }\n  end\n</code></pre></div></div>\n\n<p>https://www.youtube.com/watch?v=bn9arlhfaXc&amp;t=302s</p>\n\n<p>https://datatables.net/forums/discussion/32542/datatables-and-webpack\nhttps://www.datatables.net/download/npm\nhttps://datatables.net/manual/server-side</p>\n"
    } ,
  
    {
      "title"    : "Rails cache",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/02/03/rails-cache/",
      "date"     : "2017-02-03 00:00:00 +0100",
      "content"  : "<p><a href=\"http://guides.rubyonrails.org/caching_with_rails.html\">Guide</a> tells that page\nand action caching has been extracted to gems. Now we can use fragment caching</p>\n\n<p>By default caching in rails development environment is disabled. To enable you\nneed to <code class=\"highlighter-rouge\">touch tmp/caching-dev.txt</code> AND to comment out <code class=\"highlighter-rouge\">config.cache_store =\n:memory_store</code> from <code class=\"highlighter-rouge\">config/environments/development.rb</code> so it use\n<code class=\"highlighter-rouge\">ActiveSupport::Cache::FileStore</code>. Instead of file you should use\n<code class=\"highlighter-rouge\">dalli+memcached</code> or <code class=\"highlighter-rouge\">redis</code>  (you already have redis you use background jobs\nlike Sidekiq).\nAnother way to start caching is</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails dev:cache\n</code></pre></div></div>\n\n<p>Filestore will create files on <code class=\"highlighter-rouge\">tmp/cache/:rand/:rand/cache_key</code> so you can find\nthem <code class=\"highlighter-rouge\">ls -R tmp/cache/</code>. If cache_key is array, it is joined with <code class=\"highlighter-rouge\">/</code>.\nOn heroku <code class=\"highlighter-rouge\">heroku run bash</code> I do not see cache files <code class=\"highlighter-rouge\">ls tmp/cache</code> probably\nbecause heroku is read only system (only buildpack can add stuff) so it is\nbetter to use memcached.</p>\n\n<h1 id=\"redis-cache-store\">Redis cache store</h1>\n\n<p>In Rails 5.2 you can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'hiredis'\ngem 'redis', require: ['redis', 'redis/connection/hiredis']\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/application/environments/production.rb\n# config/application/environments/development.rb\nconfig.cache_store = :redis_cache_store\n</code></pre></div></div>\n\n<p>In coonsole you can check keys and values</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pp Rails.cache.redis.keys\n</code></pre></div></div>\n\n<h1 id=\"install-memcached\">Install memcached</h1>\n\n<p>For ubuntu you need to install memcached service.\nNote that memcached will <strong>automatically</strong> remove old cache files.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install memcached\nsudo service memcached status\n</code></pre></div></div>\n\n<p>For heroku you need addon\n<a href=\"https://devcenter.heroku.com/articles/memcachier\">memcachier</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku addons:create memcachier:dev\n</code></pre></div></div>\n\n<p>This will create env variables which you can use in secrets</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i config/secrets.yml -e '/^test:/i \\\n  # caching server\\\n  memcachier_servers: &lt;%= ENV[\"MEMCACHIER_SERVERS\"] %&gt;\\\n  memcachier_username: &lt;%= ENV[\"MEMCACHIER_USERNAME\"] %&gt;\\\n  memcachier_password: &lt;%= ENV[\"MEMCACHIER_PASSWORD\"] %&gt;\\\n'\n</code></pre></div></div>\n\n<p>Use <a href=\"https://github.com/petergoldstein/dalli\">gem dalli</a> in your Gemfile</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# for caching\ngem \"dalli\"\nHERE_DOC\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; config/initializers/dalli.rb &lt;&lt; HERE_DOC\nRails.application.configure do\n  config.cache_store = :dalli_store # this will use local memcached service\n  if secrets.memcachier_servers.present?\n    config.cache_store = :dalli_store,\n                         secrets.memcachier_servers.split(','),\n                         {\n                           username: secrets.memcachier_username,\n                           password: secrets.memcachier_password,\n                           failover: true,\n                           socket_timeout: 1.5,\n                           socket_failure_delay: 0.2,\n                           down_retry_delay: 60\n                         }\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<h2 id=\"install-memcached-using-rubber\">Install memcached using rubber</h2>\n\n<p>Read about <a href=\"/2016/09/07/cap3-capistrano-deployment-rubber-provision/\">capistrano and rubber</a> how to\nset up, so you can add memcached with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># this will copy deploy-memcached.rb and rubber-memcached.yml and role files\nbundle exec rubber vulcanize memcached\n</code></pre></div></div>\n\n<p>Add role <code class=\"highlighter-rouge\">memcached</code> to Vagrantfile or your hosts.\nSince vagrant machine do not have\n<a href=\"https://github.com/rubber/rubber/blob/master/templates/memcached/config/rubber/role/memcached/memcached.conf#L4\">image_type</a>\nwhich is used to determine max_mem, you need to define it</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/rubber/rubber-memcached.yml\nmemcached_max_mem: 2048\nmemcached_max_mem_hash:\n  ...\n</code></pre></div></div>\n\n<p>Also we need to enable listening on all required ports.</p>\n\n<p>To use in rails you need to add</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; config/initializers/dalli.rb &lt;&lt; HERE_DOC\nRails.application.configure do\n  dalli_config = Rails.root.join('config','dalli.rb')\n  if File.exists?(dalli_config)\n    require dalli_config; include ::Rubber::Dalli::Config\n  else\n    config.cache_store = :dalli_store # this will use local memcached service\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<h2 id=\"install-in-plain-irb\">Install in plain irb</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require \"rubygems\"\nrequire \"dalli\"\nCACHE = Dalli::Client.new(\"127.0.0.1\", { :namespace =&gt; “my_project”, :expires_in =&gt; 3600, :socket_timeout =&gt; 3, :compress =&gt; true }) # Options are self-explanatory\nCACHE.set(\"key\", \"value\", 180) # last option is expiry time in seconds\nCACHE.get(\"key\") 2\n</code></pre></div></div>\n\n<h1 id=\"manual-check-if-it-is-working\">Manual check if it is working</h1>\n\n<p>You can check from bash if memcached service is running</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>netstat -ap   | grep 11211\n# tcp        0      0 localhost:11211         *:*                     LISTEN      17897/memcached\n# udp        0      0 localhost:11211         *:*                                 17897/memcached\n\n# if listening on all ip addresses is enabled than you should see\ntcp        0      0 *:11211                 *:*                     LISTEN      16065/memcached\nudp        0      0 *:11211                 *:*                                 16065/memcached\n</code></pre></div></div>\n\n<p>You should be able to connect</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>telnet localhost 11211\nstats\n\n# another command is\n/usr/share/memcached/scripts/memcached-tool localhost:11211 stats\n</code></pre></div></div>\n\n<p>If you use vagrant, than <code class=\"highlighter-rouge\">config/rubber/role/memcached/dalli.rb</code> will use\n<code class=\"highlighter-rouge\">rubber_instance.full_name</code> which is <code class=\"highlighter-rouge\">default.foo.com</code> but I’m not able to\nconnect using that domain name. So you need to change\n<code class=\"highlighter-rouge\">config/rubber/role/memcached/memcached.conf</code> to add below comment <code class=\"highlighter-rouge\"># -l\n127.0.0.1</code> add this option</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># we want to listen on all IP addresses\n-l 0.0.0.0\n</code></pre></div></div>\n\n<p>You can check in console if properly enabled</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Rails.cache.class\n# if not enabled =&gt; ActiveSupport::Cache::NullStore\n</code></pre></div></div>\n\n<p>And if check its stats</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Rails.cache.stats\n# {\"127.0.0.1:11211\"=&gt;{\"pid\"=&gt;\"14592\", \"uptime\"=&gt;\"8319\", ...\n\n# if service is not working you can expect something like\n[DEBUG] Dalli::Server#connect mylocationsubdomain.my-domain.vagrant:11211\n[WARNING] mylocationsubdomain.my-domain.vagrant:11211 failed (count: 0) Errno::ECONNREFUSED: Connection refused - connect(2) for \"mylocationsubdomain.my-domain.vagrant\" port 11211\n</code></pre></div></div>\n\n<p>We can ask ActiveSupport for that also</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActiveSupport::Cache.lookup_store(:mem_cache_store).stats\n</code></pre></div></div>\n\n<p>If cache is using filestore exception will be raised</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Rails.cache.stats\nNoMethodError: undefined method `stats' for #&lt;ActiveSupport::Cache::FileStore:0x000000058a45d0&gt;\n</code></pre></div></div>\n\n<p>You can see <a href=\"http://www.pal-blog.de/entwicklung/perl/memcached-statistics-stats-command.html\">more info about\nstats</a></p>\n\n<h1 id=\"fragment-caching\">Fragment caching</h1>\n\n<p>Main usage is like this</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;% cache item do %&gt;\n  bla\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<p>Key will contain template path, item id, item updated_at and template digest so\nif you change anything, cache will be expired.</p>\n\n<p>For index pages I use key to be string, that is maximum updated at (also\ntemplate digest will invalidate cache).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;% cache ['todos', @tasks.maximum(:updated_at)] do %&gt;\n  My todos list\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<p>Note that if you use translations on different subdomain than put default locale\nin the key also.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;% cache ['moves-markers', I18n.locale, latest_move_timestamp] do %&gt;\n</code></pre></div></div>\n\n<p>Note that you should not use same keys on multiple places on the page.\nSo if you have to use on same page, use different first string.</p>\n\n<p>You can clear cache in rails console : <code class=\"highlighter-rouge\">Rails.cache.clear</code></p>\n\n<p>You can use conditional caching you can use <code class=\"highlighter-rouge\">cache_if</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;% cache_if admin?, product do %&gt;\n  &lt;%= render product %&gt;\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<p>If you show some data from nested resources, for example product comment, you\nneed to add relation so any update will also trigger parent update, and\ninvalidate parent cache.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/comment.rb\n  belongs_to :product, touch: true\n</code></pre></div></div>\n\n<p>Inside json jbuilder you need to call <code class=\"highlighter-rouge\">json.cache!</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/users/index.json.jbuilder\njson.cache! ['users', @users.maxium(:updated_at)] do\n  ...\nend\n</code></pre></div></div>\n\n<h1 id=\"low-level-caching\">Low level caching</h1>\n\n<p>In console or in code you can cache</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Rails.cache.write 'my_key', 123\nRails.cache.read 'my_key'\nRails.cache.fetch 'my_key' do\n  123\nend\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">fetch</code> will read from cache if exists or write to cache\nFor any ActiveRecord instance, you have method <code class=\"highlighter-rouge\">cache_key</code> which you can use\nfor example in <code class=\"highlighter-rouge\">fetch</code> block.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Product &lt; ApplicationRecord\n  def competing_price\n    Rails.cache.fetch(\"#{cache_key}/competing_price\", expires_in: 12.hours) do\n      Competitor::API.find_price(id)\n    end\n  end\nend\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">cache key</code> uses <code class=\"highlighter-rouge\">id</code> and <code class=\"highlighter-rouge\">updated_at</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Task.new.cache_key\n# =&gt; \"tasks/new\"\nTask.last.cache_key\n# =&gt; \"tasks/2-20170511114115000000\"\n</code></pre></div></div>\n\n<p>Note that <a href=\"http://guides.rubyonrails.org/caching_with_rails.html#sql-caching\">sql\ncaching</a> is\nonly inside one action. Usually rails do not perform sql query untill it is\nneeded. If you only read <code class=\"highlighter-rouge\">current_user</code> in before actions, that query will be\ncached. But if you update current_user, than following <code class=\"highlighter-rouge\">current_user</code> is not\nreading from cache (for example if you use current_user in view or in other\nbefore actions).</p>\n\n<p>You can use this <a href=\"http://vinsol.com/blog/2014/02/11/guide-to-caching-in-rails-using-memcache/\">snippets\n</a></p>\n\n<h1 id=\"theory\">Theory</h1>\n\n<p><a href=\"https://www.mnot.net/cache_docs/\">mnot cache_docs</a></p>\n"
    } ,
  
    {
      "title"    : "Get Syntax Right In Jade Yaml Haml",
      "category" : "",
      "tags"     : "",
      "url"      : "/2017/01/10/get-syntax-right-in-jade-yaml-haml/",
      "date"     : "2017-01-10 00:00:00 +0100",
      "content"  : "<h1 id=\"jade\">Jade</h1>\n\n<p>Very nice tool, like coffescript. You can convert all html files with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install -g html2jade\nhtml2jade *.html --bodyless --donotencode --noattrcomma --noemptypipe\n# --bodyless          do not output enveloping html and body tags\n# --donotencode       do not html encode characters (useful for templates)\n# --noattrcomma       omit attribute separating commas\n# --noemptypipe       omit lines with only pipe ('|') printable character\nrm *.html\n\n# version for all files in subdirectories\nfind . -name '*.html' -exec html2jade {} --bodyless --donotencode --noattrcomma --noemptypipe \\;\nfind . -name '*.html' -exec  rm {} \\;\n</code></pre></div></div>\n\n<p>Please check if format is good. At least this command will ignore &lt;body&gt; tag so\nyou need to build that (index.html) separately. Usually index.html needs to be\nat specific location so I leave it in html format, and all other move to\n<code class=\"highlighter-rouge\">jade_build</code> folder.</p>\n\n<ul>\n  <li>\n    <p>arguments could be in new line, but strings need <em>**</em>. comments are not\nallowed inside ()</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// comment should be outside of (arguments)\nmd-button(ng-really-click='vm.delete()'\nng-really-message='Are you sure to \\\nremove this option?')\n</code></pre></div>    </div>\n\n    <p>I prefer not to indent attributes even they suggest to <a href=\"http://jade-lang.com/reference/attributes/\">indent\nthem</a></p>\n  </li>\n</ul>\n\n<h1 id=\"yaml\">Yaml</h1>\n\n<ul>\n  <li>comments are single line and starts with <code class=\"highlighter-rouge\">#</code> number sign</li>\n  <li>list (arrays) are denoted by a leading hyphen <code class=\"highlighter-rouge\">-</code> for each member per line, or\nin single line with <code class=\"highlighter-rouge\">[a, b]</code> square brackets separated with comma space</li>\n  <li>associative arrays (hash) are written with colon space <code class=\"highlighter-rouge\">key: value</code>\n(multiline) or in single line with <code class=\"highlighter-rouge\">{a: 1, b: 2}</code>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>data: { a: 1 }\ndata:\n  a: 1\n</code></pre></div>    </div>\n  </li>\n  <li>String does not need <code class=\"highlighter-rouge\">\" \"</code> only if you use some special symbol <code class=\"highlighter-rouge\">|</code> <code class=\"highlighter-rouge\">:</code></li>\n  <li>Multiline strings starts with pipe <code class=\"highlighter-rouge\">|</code> on the line with attribute name, and\nindented.</li>\n  <li>Write dates in format <code class=\"highlighter-rouge\">yyyy-mm-dd</code> so rails <code class=\"highlighter-rouge\">Date.parse()</code> recognize it.</li>\n  <li>YML file can use anchor ie alias (<code class=\"highlighter-rouge\">&amp;</code>) and reference (<code class=\"highlighter-rouge\">*</code>) so you do not\nrepeat the code. When you use reference <code class=\"highlighter-rouge\">*</code> (as for testing) you can not add\nor update keys, but with <code class=\"highlighter-rouge\">&lt;&lt;</code> you can (as for [production secrets]\n( /2015/04/05/common-rails-bootstrap-snippets/))</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>name: Dusan Orlovic\nsport:\n  kayak: |\n    It is nice sport\n    to play around\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>shared: &amp;shared\n  key: 123\n\ndevelopment:\n  &lt;&lt;: *shared\n</code></pre></div></div>\n\n<h1 id=\"haml\">Haml</h1>\n\n<ul>\n  <li>html tags are written with <code class=\"highlighter-rouge\">%</code>, and attributes is hash <code class=\"highlighter-rouge\">{src: post.image}</code> but\nfor class you can use css notation <code class=\"highlighter-rouge\">.class</code> and <code class=\"highlighter-rouge\">#id</code> (and <code class=\"highlighter-rouge\">%div</code> is not\nneeded), and for content from ruby code use <code class=\"highlighter-rouge\">=</code> immediatelly or idented in new\nline, like: <code class=\"highlighter-rouge\">%div.col-md-6= @user.name</code></li>\n  <li>if you need more nested content, use tabs</li>\n  <li>if ruby line spans multiple lines than use</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>= link_to \"Add\",\n  url: posts_url\n</code></pre></div></div>\n\n<ul>\n  <li>plain text is without <code class=\"highlighter-rouge\">%</code> or <code class=\"highlighter-rouge\">=</code></li>\n  <li>excaping html <code class=\"highlighter-rouge\">&amp;= \"Me &amp; you\"</code> will sanitize HTML sensitive characters <code class=\"highlighter-rouge\">Me\n&amp;amp; you</code>, unescaping HTML <code class=\"highlighter-rouge\">!= &lt;br&gt;</code> will output <code class=\"highlighter-rouge\">&lt;br&gt;</code> instead of <code class=\"highlighter-rouge\">&amp;lt;br&amp;gt;</code></li>\n  <li>if conditional classes is false, than it is ignored <code class=\"highlighter-rouge\">.item{class: @item.empty?\n&amp;&amp; \"empty\"}</code> can be <code class=\"highlighter-rouge\">&lt;div class=\"item\"&gt;</code> or <code class=\"highlighter-rouge\">&lt;div class=\"item empty\"&gt;</code></li>\n  <li>\n    <p>whitespace can be removed immediatelly within the tag <code class=\"highlighter-rouge\">&lt;</code> (or surrounding the\ntag <code class=\"highlighter-rouge\">&gt;</code>), for example</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>%blockquoute&lt;\n  %div\n    Foo\n</code></pre></div>    </div>\n\n    <p>is</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;blockqoute&gt;&lt;div&gt;\n  Foo\n&lt;/blockquote&gt;&lt;/div&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>HTML comments <code class=\"highlighter-rouge\">&lt;!-- --&gt;</code> is with <code class=\"highlighter-rouge\">/</code></li>\n  <li>\n    <p>ruby code which is not inserted <code class=\"highlighter-rouge\">-</code> like <code class=\"highlighter-rouge\">- title = 'home'</code>. Iteration and\nother blocks use indent</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>- case 2\n- when 1\n  = \"1\"\n- when 2\n  = \"2?\"\n</code></pre></div>    </div>\n  </li>\n  <li>ruby comments <code class=\"highlighter-rouge\">-# this is a comment</code></li>\n  <li>\n    <p>filters like <code class=\"highlighter-rouge\">:javascript</code>, <code class=\"highlighter-rouge\">:coffeescript</code>, <code class=\"highlighter-rouge\">:scss</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:javascript\n  $(document).ready(function() {\n    alert(\"hi\");\n  });\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n"
    } ,
  
    {
      "title"    : "AdminLTE Free Template on Rails",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/10/28/adminlte-free-template-on-rails/",
      "date"     : "2016-10-28 00:00:00 +0200",
      "content"  : "<h1 id=\"installation\">Installation</h1>\n\n<p>You can start by cloning template from github\n<a href=\"https://github.com/almasaeed2010/AdminLTE\">adminLTE</a> and preview localy (it\nshould look the same as <a href=\"https://almsaeedstudio.com/preview\">preview</a>). You can\nopen documentation localy or\n<a href=\"https://almsaeedstudio.com/themes/AdminLTE/documentation/index.html\">online</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git clone https://github.com/almasaeed2010/AdminLTE.git\ncd AdminLTE\ngnome-open index.html\ngnome-open documentations/index.html\n</code></pre></div></div>\n\n<p>Latest version is 2.4.2 uses bootstrap 3 and jquery 3.\nTo install to existing rails project you can use <a href=\"/2014/07/01/ruby-on-rails-layouts-and-rendering/\n#bower\">bower inside rails</a> and than add admin-lte</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bower install --save admin-lte boostrap font-awesome ionicons\n</code></pre></div></div>\n\n<p>I use separated bootstrap (not from admin-lte package) because “Glyphicons” are\nproperly linked. Also I use latest font awesome.\nThere is <a href=\"https://github.com/aguegu/AdminLTE\">admin-lte.scss</a> version but not\nupdated.</p>\n\n<p>We can use <a href=\"https://adminlte.io/themes/AdminLTE/starter.html\">starter.html</a> for\ntesting, just copy from <code class=\"highlighter-rouge\">vendor/assets/bower_components/admin-lte/starter.html</code>\nselect <code class=\"highlighter-rouge\">&lt;div class=\"wrapper\"&gt;</code> and put on your page. CSS and js will we using\nsprockets and compiled in one big application.css/.js file. Since\nadminlte is using less we will use two wrappers.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/application.css\n/*\n * load bootstrap here since importing in less will use css import file command\n *= require bootstrap/dist/css/bootstrap.css\n *= require application_less_wrapper\n *= require application_scss_wrapper\n */\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile, below sass-rails\n# Also need less for adminlte\ngem 'less-rails', '~&gt; 3.0.0'\n# See https://github.com/sstephenson/execjs#readme for more supported runtimes\ngem 'therubyracer'\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/assets.rb\n\n# We need to add also subpaths admin-lte and admin-lte/skins since there is\n# relative reference for bootstrap in skins less files\nRails.application.config.assets.paths &lt;&lt; Rails.root.join('vendor', 'assets', 'bower_components')\nRails.application.config.assets.paths &lt;&lt; Rails.root.join('vendor', 'assets', 'bower_components', 'admin-lte')\nRails.application.config.assets.paths &lt;&lt; Rails.root.join('vendor', 'assets', 'bower_components', 'admin-lte', 'skins')\nRails.application.config.assets.precompile &lt;&lt; /\\.(?:svg|eot|woff|ttf)$/\n</code></pre></div></div>\n\n<p>Copy some header from starter.html to your layout file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/layouts/applicantion.html.erb\n<span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;meta</span> <span class=\"na\">charset=</span><span class=\"s\">\"utf-8\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;meta</span> <span class=\"na\">http-equiv=</span><span class=\"s\">\"X-UA-Compatible\"</span> <span class=\"na\">content=</span><span class=\"s\">\"IE=edge\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;title&gt;&lt;</span><span class=\"err\">%=</span> <span class=\"na\">content_for</span><span class=\"err\">?(</span><span class=\"na\">:page_title</span><span class=\"err\">)</span> <span class=\"err\">?</span> <span class=\"na\">yield</span><span class=\"err\">(</span><span class=\"na\">:page_title</span><span class=\"err\">)</span> <span class=\"na\">:</span> <span class=\"na\">default_page_title</span> <span class=\"err\">%</span><span class=\"nt\">&gt;&lt;/title&gt;</span>\n    <span class=\"c\">&lt;!-- Tell the browser to be responsive to screen width --&gt;</span>\n    <span class=\"nt\">&lt;meta</span> <span class=\"na\">content=</span><span class=\"s\">\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\"</span> <span class=\"na\">name=</span><span class=\"s\">\"viewport\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">csrf_meta_tags</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n\n    <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">stylesheet_link_tag</span>    <span class=\"err\">'</span><span class=\"na\">application</span><span class=\"err\">',</span> <span class=\"na\">media:</span> <span class=\"err\">'</span><span class=\"na\">all</span><span class=\"err\">',</span> <span class=\"err\">'</span><span class=\"na\">data-turbolinks-track</span><span class=\"err\">'</span><span class=\"na\">:</span> <span class=\"err\">'</span><span class=\"na\">reload</span><span class=\"err\">'</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">javascript_include_tag</span> <span class=\"err\">'</span><span class=\"na\">application</span><span class=\"err\">',</span> <span class=\"err\">'</span><span class=\"na\">data-turbolinks-track</span><span class=\"err\">'</span><span class=\"na\">:</span> <span class=\"err\">'</span><span class=\"na\">reload</span><span class=\"err\">'</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n    <span class=\"c\">&lt;!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries --&gt;</span>\n    <span class=\"c\">&lt;!-- WARNING: Respond.js doesn't work if you view the page via file:// --&gt;</span>\n    <span class=\"c\">&lt;!--[if lt IE 9]&gt;\n    &lt;script src=\"https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js\"&gt;&lt;/script&gt;\n    &lt;script src=\"https://oss.maxcdn.com/respond/1.4.2/respond.min.js\"&gt;&lt;/script&gt;\n    &lt;![endif]--&gt;</span>\n\n    <span class=\"c\">&lt;!-- Google Font --&gt;</span>\n    <span class=\"nt\">&lt;link</span> <span class=\"na\">rel=</span><span class=\"s\">\"stylesheet\"</span>\n          <span class=\"na\">href=</span><span class=\"s\">\"https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n\n  <span class=\"nt\">&lt;body</span> <span class=\"na\">class=</span><span class=\"s\">\"hold-transition skin-blue sidebar-mini &lt;%= sidebar_collapse %&gt;\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"wrapper\"</span><span class=\"nt\">&gt;</span>\n\n      <span class=\"c\">&lt;!-- Main Header --&gt;</span>\n      <span class=\"nt\">&lt;header</span> <span class=\"na\">class=</span><span class=\"s\">\"main-header\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"c\">&lt;!-- Logo --&gt;</span>\n        <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"/\"</span> <span class=\"na\">class=</span><span class=\"s\">\"logo\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"c\">&lt;!-- mini logo for sidebar mini 50x50 pixels --&gt;</span>\n          <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"logo-mini\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;b&gt;</span>ST<span class=\"nt\">&lt;/b&gt;</span>\n          <span class=\"nt\">&lt;/span&gt;</span>\n          <span class=\"c\">&lt;!-- logo for regular state and mobile devices --&gt;</span>\n          <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"logo-lg\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;b&gt;</span>Stuff<span class=\"nt\">&lt;/b&gt;</span>Timesheet\n          <span class=\"nt\">&lt;/span&gt;</span>\n        <span class=\"nt\">&lt;/a&gt;</span>\n\n        <span class=\"c\">&lt;!-- Header Navbar --&gt;</span>\n        <span class=\"nt\">&lt;nav</span> <span class=\"na\">class=</span><span class=\"s\">\"navbar navbar-static-top\"</span> <span class=\"na\">role=</span><span class=\"s\">\"navigation\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"c\">&lt;!-- Sidebar toggle button--&gt;</span>\n          <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">class=</span><span class=\"s\">\"sidebar-toggle\"</span> <span class=\"na\">data-toggle=</span><span class=\"s\">\"push-menu\"</span> <span class=\"na\">role=</span><span class=\"s\">\"button\"</span> <span class=\"na\">data-server-url=</span><span class=\"s\">\"&lt;%= preferences_path %&gt;\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"sr-only\"</span><span class=\"nt\">&gt;</span>Toggle navigation<span class=\"nt\">&lt;/span&gt;</span>\n          <span class=\"nt\">&lt;/a&gt;</span>\n          <span class=\"c\">&lt;!-- Navbar Right Menu --&gt;</span>\n          <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"navbar-custom-menu\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"nav navbar-nav\"</span><span class=\"nt\">&gt;</span>\n              <span class=\"c\">&lt;!-- Messages: style can be found in dropdown.less--&gt;</span>\n              <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown messages-menu\"</span><span class=\"nt\">&gt;</span>\n                <span class=\"c\">&lt;!-- Menu toggle button --&gt;</span>\n                <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-toggle\"</span> <span class=\"na\">data-toggle=</span><span class=\"s\">\"dropdown\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-envelope-o\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span>\n                  <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"label label-success\"</span><span class=\"nt\">&gt;</span>4<span class=\"nt\">&lt;/span&gt;</span>\n                <span class=\"nt\">&lt;/a&gt;</span>\n                <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-menu\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"header\"</span><span class=\"nt\">&gt;</span>You have 4 messages<span class=\"nt\">&lt;/li&gt;</span>\n                  <span class=\"nt\">&lt;li&gt;</span>\n                    <span class=\"c\">&lt;!-- inner menu: contains the messages --&gt;</span>\n                    <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"menu\"</span><span class=\"nt\">&gt;</span>\n                      <span class=\"nt\">&lt;li&gt;</span><span class=\"c\">&lt;!-- start message --&gt;</span>\n                        <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>\n                          <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"pull-left\"</span><span class=\"nt\">&gt;</span>\n                            <span class=\"c\">&lt;!-- User Image --&gt;</span>\n                            <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">\"dist/img/user2-160x160.jpg\"</span> <span class=\"na\">class=</span><span class=\"s\">\"img-circle\"</span> <span class=\"na\">alt=</span><span class=\"s\">\"User Image\"</span><span class=\"nt\">&gt;</span>\n                          <span class=\"nt\">&lt;/div&gt;</span>\n                          <span class=\"c\">&lt;!-- Message title and timestamp --&gt;</span>\n                          <span class=\"nt\">&lt;h4&gt;</span>\n                            Support Team\n                            <span class=\"nt\">&lt;small&gt;&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-clock-o\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span> 5 mins<span class=\"nt\">&lt;/small&gt;</span>\n                          <span class=\"nt\">&lt;/h4&gt;</span>\n                          <span class=\"c\">&lt;!-- The message --&gt;</span>\n                          <span class=\"nt\">&lt;p&gt;</span>Why not buy a new awesome theme?<span class=\"nt\">&lt;/p&gt;</span>\n                        <span class=\"nt\">&lt;/a&gt;</span>\n                      <span class=\"nt\">&lt;/li&gt;</span>\n                      <span class=\"c\">&lt;!-- end message --&gt;</span>\n                    <span class=\"nt\">&lt;/ul&gt;</span>\n                    <span class=\"c\">&lt;!-- /.menu --&gt;</span>\n                  <span class=\"nt\">&lt;/li&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"footer\"</span><span class=\"nt\">&gt;&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>See All Messages<span class=\"nt\">&lt;/a&gt;&lt;/li&gt;</span>\n                <span class=\"nt\">&lt;/ul&gt;</span>\n              <span class=\"nt\">&lt;/li&gt;</span>\n              <span class=\"c\">&lt;!-- /.messages-menu --&gt;</span>\n\n              <span class=\"c\">&lt;!-- Notifications Menu --&gt;</span>\n              <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown notifications-menu\"</span><span class=\"nt\">&gt;</span>\n                <span class=\"c\">&lt;!-- Menu toggle button --&gt;</span>\n                <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-toggle\"</span> <span class=\"na\">data-toggle=</span><span class=\"s\">\"dropdown\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-bell-o\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span>\n                  <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"label label-warning\"</span><span class=\"nt\">&gt;</span>10<span class=\"nt\">&lt;/span&gt;</span>\n                <span class=\"nt\">&lt;/a&gt;</span>\n                <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-menu\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"header\"</span><span class=\"nt\">&gt;</span>You have 10 notifications<span class=\"nt\">&lt;/li&gt;</span>\n                  <span class=\"nt\">&lt;li&gt;</span>\n                    <span class=\"c\">&lt;!-- Inner Menu: contains the notifications --&gt;</span>\n                    <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"menu\"</span><span class=\"nt\">&gt;</span>\n                      <span class=\"nt\">&lt;li&gt;</span><span class=\"c\">&lt;!-- start notification --&gt;</span>\n                        <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>\n                          <span class=\"nt\">&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-users text-aqua\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span> 5 new members joined today\n                        <span class=\"nt\">&lt;/a&gt;</span>\n                      <span class=\"nt\">&lt;/li&gt;</span>\n                      <span class=\"c\">&lt;!-- end notification --&gt;</span>\n                    <span class=\"nt\">&lt;/ul&gt;</span>\n                  <span class=\"nt\">&lt;/li&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"footer\"</span><span class=\"nt\">&gt;&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>View all<span class=\"nt\">&lt;/a&gt;&lt;/li&gt;</span>\n                <span class=\"nt\">&lt;/ul&gt;</span>\n              <span class=\"nt\">&lt;/li&gt;</span>\n              <span class=\"c\">&lt;!-- Tasks Menu --&gt;</span>\n              <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown tasks-menu\"</span><span class=\"nt\">&gt;</span>\n                <span class=\"c\">&lt;!-- Menu Toggle Button --&gt;</span>\n                <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-toggle\"</span> <span class=\"na\">data-toggle=</span><span class=\"s\">\"dropdown\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-flag-o\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span>\n                  <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"label label-danger\"</span><span class=\"nt\">&gt;</span>9<span class=\"nt\">&lt;/span&gt;</span>\n                <span class=\"nt\">&lt;/a&gt;</span>\n                <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-menu\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"header\"</span><span class=\"nt\">&gt;</span>You have 9 tasks<span class=\"nt\">&lt;/li&gt;</span>\n                  <span class=\"nt\">&lt;li&gt;</span>\n                    <span class=\"c\">&lt;!-- Inner menu: contains the tasks --&gt;</span>\n                    <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"menu\"</span><span class=\"nt\">&gt;</span>\n                      <span class=\"nt\">&lt;li&gt;</span><span class=\"c\">&lt;!-- Task item --&gt;</span>\n                        <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>\n                          <span class=\"c\">&lt;!-- Task title and progress text --&gt;</span>\n                          <span class=\"nt\">&lt;h3&gt;</span>\n                            Design some buttons\n                            <span class=\"nt\">&lt;small</span> <span class=\"na\">class=</span><span class=\"s\">\"pull-right\"</span><span class=\"nt\">&gt;</span>20%<span class=\"nt\">&lt;/small&gt;</span>\n                          <span class=\"nt\">&lt;/h3&gt;</span>\n                          <span class=\"c\">&lt;!-- The progress bar --&gt;</span>\n                          <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"progress xs\"</span><span class=\"nt\">&gt;</span>\n                            <span class=\"c\">&lt;!-- Change the css width attribute to simulate progress --&gt;</span>\n                            <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"progress-bar progress-bar-aqua\"</span> <span class=\"na\">style=</span><span class=\"s\">\"width: 20%\"</span> <span class=\"na\">role=</span><span class=\"s\">\"progressbar\"</span>\n                                 <span class=\"na\">aria-valuenow=</span><span class=\"s\">\"20\"</span> <span class=\"na\">aria-valuemin=</span><span class=\"s\">\"0\"</span> <span class=\"na\">aria-valuemax=</span><span class=\"s\">\"100\"</span><span class=\"nt\">&gt;</span>\n                              <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"sr-only\"</span><span class=\"nt\">&gt;</span>20% Complete<span class=\"nt\">&lt;/span&gt;</span>\n                            <span class=\"nt\">&lt;/div&gt;</span>\n                          <span class=\"nt\">&lt;/div&gt;</span>\n                        <span class=\"nt\">&lt;/a&gt;</span>\n                      <span class=\"nt\">&lt;/li&gt;</span>\n                      <span class=\"c\">&lt;!-- end task item --&gt;</span>\n                    <span class=\"nt\">&lt;/ul&gt;</span>\n                  <span class=\"nt\">&lt;/li&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"footer\"</span><span class=\"nt\">&gt;</span>\n                    <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>View all tasks<span class=\"nt\">&lt;/a&gt;</span>\n                  <span class=\"nt\">&lt;/li&gt;</span>\n                <span class=\"nt\">&lt;/ul&gt;</span>\n              <span class=\"nt\">&lt;/li&gt;</span>\n              <span class=\"c\">&lt;!-- User Account Menu --&gt;</span>\n              <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown user user-menu\"</span><span class=\"nt\">&gt;</span>\n                <span class=\"c\">&lt;!-- Menu Toggle Button --&gt;</span>\n                <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-toggle\"</span> <span class=\"na\">data-toggle=</span><span class=\"s\">\"dropdown\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"c\">&lt;!-- The user image in the navbar--&gt;</span>\n                  <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">\"dist/img/user2-160x160.jpg\"</span> <span class=\"na\">class=</span><span class=\"s\">\"user-image\"</span> <span class=\"na\">alt=</span><span class=\"s\">\"User Image\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"c\">&lt;!-- hidden-xs hides the username on small devices so only the image appears. --&gt;</span>\n                  <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"hidden-xs\"</span><span class=\"nt\">&gt;</span>Alexander Pierce<span class=\"nt\">&lt;/span&gt;</span>\n                <span class=\"nt\">&lt;/a&gt;</span>\n                <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-menu\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"c\">&lt;!-- The user image in the menu --&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"user-header\"</span><span class=\"nt\">&gt;</span>\n                    <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">\"dist/img/user2-160x160.jpg\"</span> <span class=\"na\">class=</span><span class=\"s\">\"img-circle\"</span> <span class=\"na\">alt=</span><span class=\"s\">\"User Image\"</span><span class=\"nt\">&gt;</span>\n\n                    <span class=\"nt\">&lt;p&gt;</span>\n                      Alexander Pierce - Web Developer\n                      <span class=\"nt\">&lt;small&gt;</span>Member since Nov. 2012<span class=\"nt\">&lt;/small&gt;</span>\n                    <span class=\"nt\">&lt;/p&gt;</span>\n                  <span class=\"nt\">&lt;/li&gt;</span>\n                  <span class=\"c\">&lt;!-- Menu Body --&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"user-body\"</span><span class=\"nt\">&gt;</span>\n                    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row\"</span><span class=\"nt\">&gt;</span>\n                      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-xs-4 text-center\"</span><span class=\"nt\">&gt;</span>\n                        <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>Followers<span class=\"nt\">&lt;/a&gt;</span>\n                      <span class=\"nt\">&lt;/div&gt;</span>\n                      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-xs-4 text-center\"</span><span class=\"nt\">&gt;</span>\n                        <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>Sales<span class=\"nt\">&lt;/a&gt;</span>\n                      <span class=\"nt\">&lt;/div&gt;</span>\n                      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-xs-4 text-center\"</span><span class=\"nt\">&gt;</span>\n                        <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>Friends<span class=\"nt\">&lt;/a&gt;</span>\n                      <span class=\"nt\">&lt;/div&gt;</span>\n                    <span class=\"nt\">&lt;/div&gt;</span>\n                    <span class=\"c\">&lt;!-- /.row --&gt;</span>\n                  <span class=\"nt\">&lt;/li&gt;</span>\n                  <span class=\"c\">&lt;!-- Menu Footer--&gt;</span>\n                  <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"user-footer\"</span><span class=\"nt\">&gt;</span>\n                    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"pull-left\"</span><span class=\"nt\">&gt;</span>\n                      <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">class=</span><span class=\"s\">\"btn btn-default btn-flat\"</span><span class=\"nt\">&gt;</span>Profile<span class=\"nt\">&lt;/a&gt;</span>\n                    <span class=\"nt\">&lt;/div&gt;</span>\n                    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"pull-right\"</span><span class=\"nt\">&gt;</span>\n                      <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">class=</span><span class=\"s\">\"btn btn-default btn-flat\"</span><span class=\"nt\">&gt;</span>Sign out<span class=\"nt\">&lt;/a&gt;</span>\n                    <span class=\"nt\">&lt;/div&gt;</span>\n                  <span class=\"nt\">&lt;/li&gt;</span>\n                <span class=\"nt\">&lt;/ul&gt;</span>\n              <span class=\"nt\">&lt;/li&gt;</span>\n              <span class=\"c\">&lt;!-- Control Sidebar Toggle Button --&gt;</span>\n              <span class=\"nt\">&lt;li&gt;</span>\n                <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">data-toggle=</span><span class=\"s\">\"control-sidebar\"</span><span class=\"nt\">&gt;&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-gears\"</span><span class=\"nt\">&gt;&lt;/i&gt;&lt;/a&gt;</span>\n              <span class=\"nt\">&lt;/li&gt;</span>\n            <span class=\"nt\">&lt;/ul&gt;</span>\n          <span class=\"nt\">&lt;/div&gt;</span>\n        <span class=\"nt\">&lt;/nav&gt;</span>\n      <span class=\"nt\">&lt;/header&gt;</span>\n      <span class=\"c\">&lt;!-- Left side column. contains the logo and sidebar --&gt;</span>\n      <span class=\"nt\">&lt;aside</span> <span class=\"na\">class=</span><span class=\"s\">\"main-sidebar\"</span><span class=\"nt\">&gt;</span>\n\n        <span class=\"c\">&lt;!-- sidebar: style can be found in sidebar.less --&gt;</span>\n        <span class=\"nt\">&lt;section</span> <span class=\"na\">class=</span><span class=\"s\">\"sidebar\"</span><span class=\"nt\">&gt;</span>\n\n          <span class=\"c\">&lt;!-- Sidebar user panel (optional) --&gt;</span>\n          <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"user-panel\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"pull-left image\"</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">\"dist/img/user2-160x160.jpg\"</span> <span class=\"na\">class=</span><span class=\"s\">\"img-circle\"</span> <span class=\"na\">alt=</span><span class=\"s\">\"User Image\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;/div&gt;</span>\n            <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"pull-left info\"</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;p&gt;</span>Alexander Pierce<span class=\"nt\">&lt;/p&gt;</span>\n              <span class=\"c\">&lt;!-- Status --&gt;</span>\n              <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-circle text-success\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span> Online<span class=\"nt\">&lt;/a&gt;</span>\n            <span class=\"nt\">&lt;/div&gt;</span>\n          <span class=\"nt\">&lt;/div&gt;</span>\n\n          <span class=\"c\">&lt;!-- search form (Optional) --&gt;</span>\n          <span class=\"nt\">&lt;form</span> <span class=\"na\">action=</span><span class=\"s\">\"#\"</span> <span class=\"na\">method=</span><span class=\"s\">\"get\"</span> <span class=\"na\">class=</span><span class=\"s\">\"sidebar-form\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"input-group\"</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">\"text\"</span> <span class=\"na\">name=</span><span class=\"s\">\"q\"</span> <span class=\"na\">class=</span><span class=\"s\">\"form-control\"</span> <span class=\"na\">placeholder=</span><span class=\"s\">\"Search...\"</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"input-group-btn\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;button</span> <span class=\"na\">type=</span><span class=\"s\">\"submit\"</span> <span class=\"na\">name=</span><span class=\"s\">\"search\"</span> <span class=\"na\">id=</span><span class=\"s\">\"search-btn\"</span> <span class=\"na\">class=</span><span class=\"s\">\"btn btn-flat\"</span><span class=\"nt\">&gt;&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-search\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span>\n                  <span class=\"nt\">&lt;/button&gt;</span>\n                <span class=\"nt\">&lt;/span&gt;</span>\n            <span class=\"nt\">&lt;/div&gt;</span>\n          <span class=\"nt\">&lt;/form&gt;</span>\n          <span class=\"c\">&lt;!-- /.search form --&gt;</span>\n\n          <span class=\"c\">&lt;!-- Sidebar Menu --&gt;</span>\n          <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"sidebar-menu\"</span> <span class=\"na\">data-widget=</span><span class=\"s\">\"tree\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"header\"</span><span class=\"nt\">&gt;</span>HEADER<span class=\"nt\">&lt;/li&gt;</span>\n            <span class=\"c\">&lt;!-- Optionally, you can add icons to the links --&gt;</span>\n            <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"active\"</span><span class=\"nt\">&gt;&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-link\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span> <span class=\"nt\">&lt;span&gt;</span>Link<span class=\"nt\">&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span>\n            <span class=\"nt\">&lt;li&gt;&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-link\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span> <span class=\"nt\">&lt;span&gt;</span>Another Link<span class=\"nt\">&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span>\n            <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"treeview\"</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-link\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span> <span class=\"nt\">&lt;span&gt;</span>Multilevel<span class=\"nt\">&lt;/span&gt;</span>\n                <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"pull-right-container\"</span><span class=\"nt\">&gt;</span>\n                    <span class=\"nt\">&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-angle-left pull-right\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span>\n                  <span class=\"nt\">&lt;/span&gt;</span>\n              <span class=\"nt\">&lt;/a&gt;</span>\n              <span class=\"nt\">&lt;ul</span> <span class=\"na\">class=</span><span class=\"s\">\"treeview-menu\"</span><span class=\"nt\">&gt;</span>\n                <span class=\"nt\">&lt;li&gt;&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>Link in level 2<span class=\"nt\">&lt;/a&gt;&lt;/li&gt;</span>\n                <span class=\"nt\">&lt;li&gt;&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>Link in level 2<span class=\"nt\">&lt;/a&gt;&lt;/li&gt;</span>\n              <span class=\"nt\">&lt;/ul&gt;</span>\n            <span class=\"nt\">&lt;/li&gt;</span>\n          <span class=\"nt\">&lt;/ul&gt;</span>\n        <span class=\"nt\">&lt;/section&gt;</span>\n      <span class=\"nt\">&lt;/aside&gt;</span>\n\n      <span class=\"c\">&lt;!-- Content Wrapper. Contains page content --&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"content-wrapper\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"c\">&lt;!-- Content Header (Page header) --&gt;</span>\n        <span class=\"nt\">&lt;section</span> <span class=\"na\">class=</span><span class=\"s\">\"content-header\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"nt\">&lt;h1&gt;</span>\n            <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">yield</span> <span class=\"na\">:page_header</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;small&gt;&lt;</span><span class=\"err\">%=</span> <span class=\"na\">yield</span> <span class=\"na\">:page_description</span> <span class=\"err\">%</span><span class=\"nt\">&gt;&lt;/small&gt;</span>\n          <span class=\"nt\">&lt;/h1&gt;</span>\n          <span class=\"nt\">&lt;ol</span> <span class=\"na\">class=</span><span class=\"s\">\"breadcrumb\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">get_breadcrumb_list</span><span class=\"err\">.</span><span class=\"na\">each_with_index</span> <span class=\"na\">do</span> <span class=\"err\">|(</span><span class=\"na\">text</span><span class=\"err\">,</span> <span class=\"na\">link</span><span class=\"err\">),</span> <span class=\"na\">i</span><span class=\"err\">|</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;li</span> <span class=\"na\">class=</span><span class=\"s\">\"&lt;%= 'active' if i == get_breadcrumb_list.length - 1 %&gt;\"</span><span class=\"nt\">&gt;</span>\n                <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">if</span> <span class=\"na\">link</span><span class=\"err\">.</span><span class=\"na\">present</span><span class=\"err\">?</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">link_to</span> <span class=\"na\">link</span> <span class=\"na\">do</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                    <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">if</span> <span class=\"na\">i =</span><span class=\"s\">=</span> <span class=\"na\">0</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                      <span class=\"nt\">&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-dashboard\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span>\n                    <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">end</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                    <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">text</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">end</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">else</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">if</span> <span class=\"na\">i =</span><span class=\"s\">=</span> <span class=\"na\">0</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                    <span class=\"nt\">&lt;i</span> <span class=\"na\">class=</span><span class=\"s\">\"fa fa-dashboard\"</span><span class=\"nt\">&gt;&lt;/i&gt;</span>\n                  <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">end</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">text</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n                <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">end</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;/li&gt;</span>\n            <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">end</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n\n          <span class=\"nt\">&lt;/ol&gt;</span>\n        <span class=\"nt\">&lt;/section&gt;</span>\n\n        <span class=\"c\">&lt;!-- Main content --&gt;</span>\n        <span class=\"nt\">&lt;section</span> <span class=\"na\">class=</span><span class=\"s\">\"content\"</span><span class=\"nt\">&gt;</span>\n\n          <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">if</span> <span class=\"na\">notice</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"hide-to-up\"</span><span class=\"nt\">&gt;&lt;</span><span class=\"err\">%=</span> <span class=\"na\">notice</span> <span class=\"err\">%</span><span class=\"nt\">&gt;&lt;/div&gt;</span>\n            <span class=\"nt\">&lt;script&gt;</span>\n              <span class=\"nx\">flash_notice</span><span class=\"p\">(</span><span class=\"s1\">'&lt;%= j notice %&gt;'</span><span class=\"p\">);</span>\n            <span class=\"nt\">&lt;/script&gt;</span>\n          <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">end</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n\n          <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">if</span> <span class=\"na\">alert</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"hide-to-up\"</span><span class=\"nt\">&gt;&lt;</span><span class=\"err\">%=</span> <span class=\"na\">alert</span> <span class=\"err\">%</span><span class=\"nt\">&gt;&lt;/div&gt;</span>\n            <span class=\"nt\">&lt;script&gt;</span>\n              <span class=\"nx\">flash_alert</span><span class=\"p\">(</span><span class=\"s1\">'&lt;%= j alert %&gt;'</span><span class=\"p\">);</span>\n            <span class=\"nt\">&lt;/script&gt;</span>\n          <span class=\"nt\">&lt;</span><span class=\"err\">%</span> <span class=\"na\">end</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n\n          <span class=\"c\">&lt;!-- Your Page Content Here --&gt;</span>\n          <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">yield</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n\n        <span class=\"nt\">&lt;/section&gt;</span>\n        <span class=\"c\">&lt;!-- /.content --&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n      <span class=\"c\">&lt;!-- /.content-wrapper --&gt;</span>\n\n      <span class=\"c\">&lt;!-- Main Footer --&gt;</span>\n      <span class=\"nt\">&lt;footer</span> <span class=\"na\">class=</span><span class=\"s\">\"main-footer\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"c\">&lt;!-- To the right --&gt;</span>\n        <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"pull-right hidden-xs\"</span><span class=\"nt\">&gt;</span>\n          Anything you want\n        <span class=\"nt\">&lt;/div&gt;</span>\n        <span class=\"c\">&lt;!-- Default to the left --&gt;</span>\n        <span class=\"nt\">&lt;strong&gt;</span>Copyright <span class=\"ni\">&amp;copy;</span> 2016 <span class=\"nt\">&lt;a</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>Company<span class=\"nt\">&lt;/a&gt;</span>.<span class=\"nt\">&lt;/strong&gt;</span> All rights reserved.\n      <span class=\"nt\">&lt;/footer&gt;</span>\n\n      <span class=\"c\">&lt;!-- Control Sidebar --&gt;</span>\n      <span class=\"nt\">&lt;aside</span> <span class=\"na\">class=</span><span class=\"s\">\"control-sidebar control-sidebar-dark\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;/aside&gt;</span>\n      <span class=\"c\">&lt;!-- /.control-sidebar --&gt;</span>\n      <span class=\"c\">&lt;!-- Add the sidebar's background. This div must be placed\n           immediately after the control sidebar --&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"control-sidebar-bg\"</span><span class=\"nt\">&gt;&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;script&gt;</span>\n      <span class=\"o\">&lt;%=</span> <span class=\"k\">yield</span> <span class=\"p\">:</span><span class=\"nx\">javascript</span> <span class=\"o\">%&gt;</span>\n    <span class=\"nt\">&lt;/script&gt;</span>\n\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<p>Some helpers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/helpers/page_helper.rb\nmodule PageHelper\n  def sidebar_collapse\n    if current_user&amp;.sidebar_collapse\n      'sidebar-collapse'\n    end\n  end\n\n  def preferences_path\n    '/'\n  end\n\n  # use in view: page_title \"Home\"\n  def page_title(title)\n    # this will add both page title and header below topnav\n    content_for(:page_title) { title }\n    content_for(:page_header) { title }\n  end\n\n  def default_page_title\n    add_location_to_title(\n      \"Internet Subscriber Management\"\n    )\n  end\n\n  # use in view: page_description \"Dashboard\"\n  def page_description(description)\n    content_for(:page_description) { description.html_safe }\n  end\n\n  # use in view: breadcrumb \"Home\": root_path, \"Dashboard\": nil\n  def breadcrumb(list)\n    @breadcrumb = list\n  end\n\n  def get_breadcrumb_list\n    @breadcrumb || []\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/stylesheets/application_less_wrapper.less\n@import \"Ionicons/less/ionicons\";\n// AdminLTE.less stuff need to be after bootstrap which includes normalize.scss\n@import \"AdminLTE/build/less/AdminLTE\";\n@import \"AdminLTE/build/less/skins/skin-blue\";\n\n// default sidebar width is 230px\n@sidebar-width: 170px;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/stylesheets/application_scss_wrapper.scss\n// on production all assets gets fingerprint, but here we can define only path\n// $fa-font-path: 'font-awesome/fonts';\n// so use Bootstrap CDN for font files\n$fa-font-path: \"//netdna.bootstrapcdn.com/font-awesome/4.7.0/fonts\" !default;\n@import 'font-awesome/scss/font-awesome';\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/javascript/application_adminlte.js\n//= require rails-ujs\n//= require turbolinks\n//= require_tree .\n//= require js.cookie\n//= require jstz\n//= require browser_timezone_rails/set_time_zone\n//\n// AdminLTE stuff\n//= require jquery/dist/jquery.min\n//= require bootstrap/dist/js/bootstrap.min\n//= require admin-lte/dist/js/adminlte\n</code></pre></div></div>\n\n<p>Also you need to exclude those <code class=\"highlighter-rouge\">_adminlte</code> files in original sprockets:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/stylesheets/application.scss\n *= stub application_adminlte\n\n// app/assets/javascript/application.js\n//= stub application_adminlte\n</code></pre></div></div>\n\n<p>Stubing in sprockets is recursive so if you need to include libraries (for\nexample <code class=\"highlighter-rouge\">jquery_ujs</code>) in both layouts it will <a href=\"https://github.com/sstephenson/sprockets/issues/467\">stub that\nlibraries also</a>. Also if\nuse use <code class=\"highlighter-rouge\">require_tree .</code> than you can inadvertently add some libs to some\nlayout which you have not consider in that moment.</p>\n\n<p>Better approach is to create new folder <code class=\"highlighter-rouge\">app/assets/adminlte</code> and add it to\nasset pipeline paths.</p>\n\n<p>Since asset pipeline <a href=\"/2014/07/01/ruby-on-rails-layouts-and-rendering/\">ignore first subfolders</a> you need to take\ncare to name files differently when you create new scss and coffee files. I\nsolved that by adding suffix <code class=\"highlighter-rouge\">_adminlte</code>.</p>\n\n<h2 id=\"notify-if-template-is-missing\">Notify if template is missing</h2>\n\n<p>You can notify if some of the translated templates does not exists using <a href=\"/2016/04/12/rails-tips/#get-template-name\">get\ntemplate name</a> and add notification</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/notify_if_adminlte_template_is_not_present.rb\n# getting current template is not possible in rails\n# https://github.com/rails/rails/issues/4876\n# patch taken from\n# http://stackoverflow.com/questions/4973699/rails-3-find-current-view-while-in-the-layout/8310881#8310881\nclass ActionView::TemplateRenderer\n  alias_method :_render_template_original, :render_template\n\n  def render_template(template, layout_name = nil, locals = {})\n    if I18n.locale == :in &amp;&amp;\n      template.inspect.end_with?(\".in.html.erb\") &amp;&amp;\n      template.inspect.end_with?(\".in.js.erb\") &amp;&amp;\n      template.inspect.end_with?(\".in.json.jbuilder\") &amp;&amp;\n      template.inspect.start_with?(\"app/views/devise/mailer\") &amp;&amp;\n      template.inspect.start_with?(\"app/views/mailers\") &amp;&amp;\n      template.inspect.start_with?(\"app/views/api\") &amp;&amp;\n      template.inspect.start_with?(\"rails/mailers/email\") &amp;&amp;\n      template.inspect != \"text template\".freeze &amp;&amp; # this is when send_data\n      template.inspect != \"html template\".freeze # this is when render html\n      cache_key = \"adminlte_#{template.virtual_path}\"\n      if Rails.cache.fetch cache_key\n        # already notified\n      else\n        Rails.cache.write cache_key, Time.now\n        XceednetMailer.internal_notification(\n          \"Adminlte Template does not exists for #{template.virtual_path}\",\n          template\n        ).deliver_now\n      end\n    end\n    result = _render_template_original( template, layout_name, locals)\n    result\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"turbolinks\">Turbolinks</h1>\n\n<p><a href=\"https://github.com/almasaeed2010/AdminLTE/issues/563\">https://github.com/almasaeed2010/AdminLTE/issues/563</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$(document).on 'turbolinks:load', -&gt;\n  console.log 'turbolinks:load'\n  $(window).trigger('resize')\n</code></pre></div></div>\n\n<h1 id=\"configuration\">Configuration</h1>\n\n<h2 id=\"plugins\">Plugins</h2>\n\n<p>AdminLTE is based on Bootstrap 3 and jQuery 1.11+. It contains a lot of plugins\nas you can see in their\n<a href=\"https://almsaeedstudio.com/themes/AdminLTE/documentation/index.html#plugins\">documentation</a></p>\n\n<ul>\n  <li>\n    <p><a href=\"https://github.com/fronteed/icheck\">iCheck</a> for checkboxes</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bower install icheck --save\n\n/* app/assets/adminlte/application_adminlte.scss\n*= require iCheck/skins/square/blue\n\n// app/assets/adminlte/application_adminlte.js\n//= require iCheck/icheck.min\n</code></pre></div>    </div>\n\n    <p>Note that when you run <code class=\"highlighter-rouge\">bower install</code> than some version of jquery will be\ninstalled and it will overwrite existing jquery if you have used it (in old or\nnew application.scss layout file).</p>\n\n    <p>If you receive error similar to <code class=\"highlighter-rouge\">Refused to execute script from\nbecause its MIME type ('text/html') is not executable, and strict MIME type\nchecking is enabled</code> that means that asset path is bad, and rails can not find\nthat precompiled asset. Sometime this happens only on production env.</p>\n  </li>\n  <li><a href=\"/2016/07/26/usefull-plugins-services-and-opensource-stuff/\n#datatables\">datatables</a> is used for search and ordering on client side</li>\n  <li><a href=\"https://github.com/uxsolutions/bootstrap-datepicker\">bootstrap-datepicker</a></li>\n  <li><a href=\"https://github.com/dangrossman/bootstrap-daterangepicker\">bootstrap-daterangepicker</a></li>\n</ul>\n\n<h2 id=\"premium-plugins\">Premium plugins</h2>\n\n<p>You can check premium version:\n<a href=\"http://wrapbootstrap.com/preview/WB0N89JMK\">adminlte</a> which usually use free\nplugins which you can download separatelly. It looks more professional.</p>\n\n<ul>\n  <li><a href=\"https://wrapbootstrap.com/theme/inspinia-responsive-admin-theme-WB0R5L90S\">wrapboostrap inspinia</a>\n    <ul>\n      <li>checkbox <a href=\"https://github.com/abpetkov/switchery\">abpetkov/switchery</a></li>\n    </ul>\n  </li>\n  <li><a href=\"https://themeforest.net/item/ucm-theme-adminlte-crm/8565409?sso=1&amp;_ga=2.183038054.1513538055.1496854657-1559534847.1496854657\">themeforest ucm theme crm</a></li>\n</ul>\n\n<h2 id=\"options\">Options</h2>\n\n<p>It contains nice features (as stated in their <a href=\"https://almsaeedstudio.com/blog/features-of-adminlte-2.1\">blog</a>)</p>\n\n<ul>\n  <li>toolbar can be autoexpand using js options</li>\n</ul>\n\n<p>You can use colors with background <code class=\"highlighter-rouge\">bg-red</code> <code class=\"highlighter-rouge\">bg-blue</code> … or for text\n<code class=\"highlighter-rouge\">text-red</code>, <code class=\"highlighter-rouge\">text-blue</code>…\nColors could be also for components. For example\n<a href=\"https://almsaeedstudio.com/themes/AdminLTE/documentation/index.html#component-box\">box</a>\ncould be <code class=\"highlighter-rouge\">box-default</code>, <code class=\"highlighter-rouge\">box-primary</code>, <code class=\"highlighter-rouge\">box-info</code>, <code class=\"highlighter-rouge\">box-success</code>, <code class=\"highlighter-rouge\">box-danger</code>\nand <code class=\"highlighter-rouge\">box-warning</code>.</p>\n\n<p>You can <a href=\"https://github.com/almasaeed2010/AdminLTE/blob/master/dist/js/app.js#L562\">collapse\nbox</a>\nin javascript by calling <code class=\"highlighter-rouge\">$.AdminLTE.boxWidget.collapse($('#box-id'));</code> but it\nis better to write custom code.</p>\n\n<p><a href=\"https://github.com/bootstrap-ruby/rails-bootstrap-forms\">rails bootstrap forms</a>\nworks nice with template, for example registration form:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/devise/registrations/new.html.erb %&gt;\n&lt;%= bootstrap_form_for resource, as: resource_name, url: registration_path(resource_name) do |f| %&gt;\n  &lt;%= f.email_field :email, autofocus: true, placeholder: \"Email\", skip_label: true, icon: 'user' %&gt;\n  &lt;%= f.password_field :password, class: 'form-control', placeholder: 'Password', skip_label: true, icon: 'lock' %&gt;\n  &lt;%= f.password_field :password_confirmation, class: 'form-control', placeholder: 'Password Confirmation', skip_label: true, icon: 'lock' %&gt;\n  &lt;button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\" data-disable-with=\"Processing...\"&gt;Sign up&lt;/button&gt;\n&lt;% end %&gt;\n&lt;%= render \"devise/shared/links\" %&gt;\n</code></pre></div></div>\n\n<h1 id=\"less-source\">Less source</h1>\n\n<p>Since AdminLTE is build using less, you can set variables to customize colors\nand sizes.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/adminlte/stylesheets/less_wrapper_adminlte.less\n// AdminLTE stuff need to be after bootstrap (which includes normalize.scss)\n@import \"AdminLTE/build/less/AdminLTE\";\n@import \"AdminLTE/build/less/skins/skin-blue\";\n\n@sidebar-width: 170px;\n</code></pre></div></div>\n\n<h1 id=\"crud-and-ajax\">CRUD and ajax</h1>\n\n<p>My prefered setup is to use ajax for edit/update form, use modal for create\n(with prefilled form, without ajax, since in case of success it should\nredirect).</p>\n\n<h1 id=\"using-with-existing-template\">Using with existing template</h1>\n\n<p>To add new template while keeping existing you can use different layout base on\nlocale. You can set new layout with option <code class=\"highlighter-rouge\">?layout=true</code>\nSo if you add param <code class=\"highlighter-rouge\">?layout=true</code> it will render <code class=\"highlighter-rouge\">index.in.html.erb</code> variant\nusing new layout and put that in session (so all form submittions also use new\nlayout). You can disable new_layout with <code class=\"highlighter-rouge\">?layout=false</code>. If you have locale\nfiles (probably <code class=\"highlighter-rouge\">devise.en.yml</code>) than you need to copy to <code class=\"highlighter-rouge\">:in</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\n  layout proc { |controller| controller.new_layout? ? 'adminlte' : 'application' }\n  before_filter :set_locale_for_layout\n\n  def new_layout?\n    I18n.locale == :rs\n  end\n\n  def set_locale_for_layout\n    if session[:layout] == true\n      if params[:layout] == \"false\"\n        # disable new layout\n        session[:layout] = false\n        I18n.locale = 'en'\n        logger.debug \"layout became false\"\n      else\n        logger.debug \"layout still true\"\n        I18n.locale = 'rs'\n      end\n    else\n      # session[:layout] == false\n      if params[:layout] == \"true\"\n        # enable new layout\n        session[:layout] = true\n        logger.debug \"layout became true\"\n        I18n.locale = 'rs'\n      else\n        I18n.locale = 'rs'\n        logger.debug \"layout still false\"\n      end\n    end\n  end\n</code></pre></div></div>\n\n<p>Also we need to make changes on other places</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/application.rb\n    config.i18n.available_locales = [:en, :rs]\n\n# config/locales/en.yml\n# config/locales/devise.en.yml\nen: &amp;default\nrs:\n  &lt;&lt;: *default\n\n# app/views/pages/sample_page.in.html.erb\nI'm from adminlte layout\n\n\n&lt;!-- above Main content in app/views/layouts/adminlte.html.erb --&gt;\n    &lt;div class=\"new-layout-switch\"&gt;\n      &lt;%= link_to \"Go Back To Old Layout\", params.merge(layout: false) %&gt;\n    &lt;/div&gt;\n\n// app/assets/stylesheets/application_adminlte.scss\n.m-b-10 {\n  margin-bottom: 10px;\n}\n\n// similar to pull-right just without float\n.text-align-right {\n  text-align: right;\n}\n\n.new-layout-switch {\n  position: absolute;\n  padding-left: 4px;\n  top: 50px;\n  right: 0px;\n  border-bottom-left-radius: 5px;\n  background: #3C8DBC;\n  a {\n    color: white;\n  }\n}\n</code></pre></div></div>\n\n"
    } ,
  
    {
      "title"    : "Elm functional static typed language",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/10/19/elm-functional-static-typed-language/",
      "date"     : "2016-10-19 00:00:00 +0200",
      "content"  : "<h1 id=\"installation\">Installation</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install -g elm\n</code></pre></div></div>\n\n<p>Plugin <a href=\"https://github.com/lambdatoast/elm.vim\">elm.vim</a></p>\n\n<p>Command line:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">elm-repl</code> like console</li>\n  <li><code class=\"highlighter-rouge\">elm-reactor</code> web server</li>\n  <li><code class=\"highlighter-rouge\">elm-make Main.elm --output=main.html</code> to compile</li>\n  <li><code class=\"highlighter-rouge\">elm-package</code> for downloading libs</li>\n</ul>\n\n<h1 id=\"core-language\">Core language</h1>\n\n<ul>\n  <li>values\n    <ul>\n      <li>strings <code class=\"highlighter-rouge\">\"asd\"</code> (concatenation <code class=\"highlighter-rouge\">\"asdf\" ++ \"asdf\"</code>)</li>\n      <li>numbers <code class=\"highlighter-rouge\">1</code> (integer division <code class=\"highlighter-rouge\">5//2</code>)</li>\n    </ul>\n  </li>\n  <li>\n    <p>functions</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>-- function definitions\nhalf n = n / 2\n-- using unonymous function\nhalf = \\n -&gt; n / 2\n-- when it has two arguments than we can use partial application\ndivide x y = x / y\n&lt;function&gt; : Float -&gt; Float -&gt; Float\n-- it is the same as divide = \\x -&gt; (\\y -&gt; x / y)\ndivide 3\n&lt;function&gt; : Float -&gt; Float\ndivide 3 2\n1.5 : Float\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>lists: all values must have same type</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>name = [ \"Alice\", \"Bob\" ]\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>tuples: can hold different types</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import String\ngoodName name = \\\n  if String.length name &lt;= 20 then \\\n    (True, \"ok\") \\\n  else\n    (False, \"nope\")\n</code></pre></div>    </div>\n  </li>\n  <li>records: key value pairs <code class=\"highlighter-rouge\">point = { x = 3, y = 4 }</code>\n    <ul>\n      <li>access with dot <code class=\"highlighter-rouge\">point.x</code></li>\n      <li>\n        <p>access functions is when variable starts with dot <code class=\"highlighter-rouge\">.name person1</code></p>\n\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>List.map .name [ {name='Dule'}, ]\n</code></pre></div>        </div>\n      </li>\n      <li>\n        <p>pattern matching (extrapolation) inside function arguments with <code class=\"highlighter-rouge\">{arg}</code></p>\n\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>under70 {age} = age &lt; 70\n</code></pre></div>        </div>\n      </li>\n      <li>update values with pipe (non destructive, it will create new attribute and\nshare existing attributes) <code class=\"highlighter-rouge\">{ point | x = 1 }</code></li>\n      <li>difference with js objects is that you can’t ask for nonexisting field, all\nfields are defined</li>\n    </ul>\n  </li>\n  <li>types\n    <ul>\n      <li>\n        <p>type annotations are written statement for types of arguments and output</p>\n\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>name : String\nname = \"Dusan\"\n\nadd : Int -&gt; Int\n</code></pre></div>        </div>\n      </li>\n      <li>\n        <p>type alias is used short type annotations</p>\n\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>type alias User =\n  { name: String\n  , bio: String\n  }\n</code></pre></div>        </div>\n      </li>\n      <li>\n        <p>union types is used to create new type with new values</p>\n\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>type Visibility = All | Active | Completed\n-- All is type of Visibility ie All : Visibility\nf : Visibility -&gt; String\nf visibility =\n  case visibility of\n    All -&gt;\n      \"all\"\n-- all case posibilities are checked by compiler\n\ntype Msg\n  = Change String\n-- in this declaration new constructors are created Change: String -&gt; Msg\n\ntype IntList = Empty | Node Int IntList\n-- linked list is recursive: Node 64(Node 42 Empty)\n\ntype List a = Empty | Node a (List a)\n-- generic linked list\n</code></pre></div>        </div>\n      </li>\n    </ul>\n  </li>\n  <li>use backslash <code class=\"highlighter-rouge\">\\ </code> to split in multiple lines</li>\n</ul>\n\n<h1 id=\"user-input\">User input</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import Html exposing (\n\n-- MODEL\ntype alias Model = {\n\n-- UPDATE\ntype Msg = Reset |\nupdate : Msg -&gt; Model -&gt; Model\nupdate msg model =\n  case msg of\n    Reset -&gt; ...\n\n-- VIEW\n\nview : Model -&gt; Html Msg\nview model =\n</code></pre></div></div>\n\n<h1 id=\"examples\">Examples</h1>\n\n<ul>\n  <li><a href=\"https://github.com/mxgrn/pairs.one\">pairs.one</a> game in elixir and phoenix</li>\n</ul>\n\n<p>tutorial todo <a href=\"https://guide.elm-lang.org/get_started.html\">https://guide.elm-lang.org/get_started.html</a></p>\n\n<p>http://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html\n<a href=\"https://www.toptal.com/front-end/make-web-front-end-reliable-with-elm\">https://www.toptal.com/front-end/make-web-front-end-reliable-with-elm</a>\nhttps://www.youtube.com/watch?v=28jCDXfZCgE#t=0.417205</p>\n<ul>\n  <li><a href=\"https://wuest.me/blog/e/20170528-io-monad-for-rubyists/\">monads for rubyist</a></li>\n</ul>\n\n<h1 id=\"haskell-books\">Haskell Books</h1>\n\n<ul>\n  <li>how to think in haskell <a href=\"https://gumroad.com/l/maybe-haskell\">Maybe Haskell</a></li>\n  <li>understanding syntax <a href=\"http://learnyouahaskell.com/\">Learn You a Haskell</a></li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Web Vulnerability And Dos Attacks",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/09/14/web-vulnerability-and-dos-attacks/",
      "date"     : "2016-09-14 00:00:00 +0200",
      "content"  : "<ul>\n  <li><a href=\"https://www.owasp.org/index.php/Category:Attack\">OWASP</a> nice examples of\nattack and vulnerability\n<a href=\"https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)\">XSS</a> there you can\nsee first two links:</li>\n</ul>\n<p><a href=\"https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet\">https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet</a>\n<a href=\"https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet\">https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet</a>\nSome rails securiry related staff\nhttps://github.com/pxlpnk/awesome-ruby-security</p>\n\n<ul>\n  <li>html image src could be stored:</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;IMG SRC=/ onerror=\"console.log('cao. bolje da eskejpujete sadrzaj');location.assign('http://www.iznajmljivanjeprojektoranovisad.in.rs')\"&gt;&lt;/img&gt;\n</code></pre></div></div>\n\n<p>In rails you can simulate with:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>user.name = 'Name \"&gt;&lt;img src=x onerror=alert(\"Hi\")&gt;'\nuser.save\n# so there is a problem if you have in view\n&lt;%= user.name.html_safe %&gt;\n&lt;%=raw user.name %&gt;\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>inspect post/patch request in chrome developer tools on Network tab, right\nclick on request and “Copy as cURL”, and update fields to insert your html</p>\n  </li>\n  <li>\n    <p>in rails, copy as curl, for xhr post, I need to add <code class=\"highlighter-rouge\">--request PATCH and\n--data @data.txt</code> and to join all lines with <code class=\"highlighter-rouge\">&amp;</code> in data.txt from <code class=\"highlighter-rouge\">Copy all\nData</code>.</p>\n  </li>\n</ul>\n\n<p>Prevent injection with\n<a href=\"https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet#Output_Encoding_Rules_Summary\">https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet#Output_Encoding_Rules_Summary</a></p>\n<ul>\n  <li>html entity: <code class=\"highlighter-rouge\">&amp;</code> to <code class=\"highlighter-rouge\">&amp;amp;</code>, <code class=\"highlighter-rouge\">&lt;</code> to <code class=\"highlighter-rouge\">&amp;lt;</code>, <code class=\"highlighter-rouge\">&gt;</code> to <code class=\"highlighter-rouge\">&amp;gt;</code>, quotation mark <code class=\"highlighter-rouge\">\"</code>\nto <code class=\"highlighter-rouge\">&amp;quot;</code> (<code class=\"highlighter-rouge\">&amp;#22;</code> hex <code class=\"highlighter-rouge\">&amp;34;</code> dec), apostrophe <code class=\"highlighter-rouge\">'</code> to <code class=\"highlighter-rouge\">&amp;x27;</code> (<code class=\"highlighter-rouge\">&amp;39;</code>\ndecimal), <code class=\"highlighter-rouge\">/</code> to <code class=\"highlighter-rouge\">&amp;#x2f;</code> <a href=\"https://www.w3schools.com/html/html_charset.asp\">https://www.w3schools.com/html/html_charset.asp</a></li>\n  <li>html attribute: escape all characters except aphanumeric with html entity\n<code class=\"highlighter-rouge\">&amp;#xHH;</code> and space <code class=\"highlighter-rouge\">&amp;#x;</code></li>\n  <li>url encoding: use percent encoding <code class=\"highlighter-rouge\">%XX</code> only for parametar values, not the\nurl of path fragments. Space is replaced with <code class=\"highlighter-rouge\">+</code> or <code class=\"highlighter-rouge\">%20</code>, <code class=\"highlighter-rouge\">\"</code> to <code class=\"highlighter-rouge\">%22</code>, <code class=\"highlighter-rouge\">#</code>\nto <code class=\"highlighter-rouge\">%23</code>, <code class=\"highlighter-rouge\">$</code> to <code class=\"highlighter-rouge\">%24</code>, <code class=\"highlighter-rouge\">%</code> to <code class=\"highlighter-rouge\">%25</code>, <code class=\"highlighter-rouge\">&amp;</code> to <code class=\"highlighter-rouge\">%26</code>, <code class=\"highlighter-rouge\">'</code> to <code class=\"highlighter-rouge\">%27</code>, <code class=\"highlighter-rouge\">(</code> to\n<code class=\"highlighter-rouge\">%28</code>, <code class=\"highlighter-rouge\">)</code> to <code class=\"highlighter-rouge\">%29</code>, <code class=\"highlighter-rouge\">.</code> to <code class=\"highlighter-rouge\">%2E</code>, <code class=\"highlighter-rouge\">/</code> to <code class=\"highlighter-rouge\">%2F</code>, <code class=\"highlighter-rouge\">:</code> to <code class=\"highlighter-rouge\">%3A</code></li>\n  <li>javascript: escape all chards with <code class=\"highlighter-rouge\">\\uXXXX</code> unicode escaping format</li>\n  <li>css hex encoding</li>\n</ul>\n\n<p>In ruby you can escape query params</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  require 'uri'\n\n  enc_uri = URI.escape(\"http://example.com/?a=\\11\\15\")\n  p enc_uri\n  # =&gt; \"http://example.com/?a=%09%0D\"\n\n  p URI.unescape(enc_uri)\n  # =&gt; \"http://example.com/?a=\\t\\r\"\n</code></pre></div></div>\n\n<p>Some common escaped characters are: blank, slash <code class=\"highlighter-rouge\">URI.escape \" /\" # %20%2f</code>\n  but <code class=\"highlighter-rouge\">escape</code> does not convert <code class=\"highlighter-rouge\">/</code> to <code class=\"highlighter-rouge\">%2f</code></p>\n\n<h1 id=\"dos-attack\">DOS attack</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">sudo hping3 -c 10000 -d 120 -S -w 64 -p 21 --flood --rand-source\nmyapp.herokuapp.com</code></li>\n  <li>you can generate authnentication key for http basic authentication with</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>auth=`echo -n 'username:password' | openssl base64`\n</code></pre></div></div>\n\n<h2 id=\"siege\">Siege</h2>\n\n<p>Run 25 concurent users 1 minute with basic http authorization:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>siege myapp.herokuapp.com -c25 -t1M -H \"Authorization: Basic\nbmalrb2xhb2I6bmlrb2xhamVjYXI=\"\n</code></pre></div></div>\n\n<h2 id=\"ab\">AB</h2>\n\n<p>Run 500 requests in 5 threads:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ab -n 500 -c 5 -H 'Authorization:Basic barb2xhb2I6bmlrb2xhamVjYXI=' http://yourapp.com/\nab -kc 10 -t 10 url # 10 seconds in 10 threads\n</code></pre></div></div>\n\n<h1 id=\"rack-attack\">Rack Attack</h1>\n\n<p>You can use <a href=\"https://github.com/kickstarter/rack-attack\">rack-attack gem</a> to\nprevent dos attacks. It will allow all requests from <code class=\"highlighter-rouge\">saveflist</code> and exit.\nOtherwise it will ban all requests from <code class=\"highlighter-rouge\">blocklist</code> and exit. Otherwise it will\ncheck for throttle.  <a href=\"https://github.com/kickstarter/rack-attack/wiki/Example-Configuration\">Example\nconfiguration</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo 'rack-attack' &gt;&gt; Gemfile\nbundle\nsed -i config/application.rb -e '/^  end$/i \\\n    config.middleware.use Rack::Attack'\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/rack_attack.rb\nmodule Rack\n  class Attack\n    # https://github.com/kickstarter/rack-attack/wiki/Example-Configuration\n    THROTTLED_BLOCKED_INTERVAL = 1.hour\n\n    # Key: \"rack::attack:#{Time.now.to_i/:period}:req/ip:#{req.ip}\"\n    throttle('req/ip', limit: 300, period: 5.minutes) do |req|\n      req.ip unless req.path.starts_with?('/assets')\n    end\n\n    # Key: \"rack::attack:#{Time.now.to_i/:period}:logins/email:#{req.ip}\"\n    throttle('logins/email', limit: 5, period: 20.seconds) do |req|\n      req.params['user'].try(:[], \"email\") if req.path == '/users/sign_in' &amp;&amp;\n                                              req.post?\n    end\n\n    blocklist('blocklist_ips 1.2.3.4') do |req|\n      Rails.cache.fetch(\"blocklist_ips #{req.ip}\").present?\n    end\n\n    OFFICE_IP = '1.2.3.4'\n    blocklist('bad_admin_ip') do |req|\n      req.path.start_with?('/admin') &amp;&amp; req.ip != OFFICE_IP\n    end\n\n    safelist('safelist_ips 1.2.3.4') do |req|\n      # if req.ip == \"127.0.0.1\"\n      #   true\n      # else\n      #   Rails.cache.fetch(\"safelist_ips #{req.ip}\").present?\n      # end\n      Rails.cache.fetch(\"safelist_ips #{req.ip}\").present?\n    end\n\n    self.blocklisted_response = lambda do |env|\n      ip = find_ip_from_env(env)\n      unless Rails.cache.fetch(\"notification_block #{ip}\").present?\n        Rails.cache.write(\"notification_block #{ip}\", true, expires_in: 1.hour)\n        Notify.exception_with_env(\n          \"ip_blocklist\",\n          env: env,\n          email_prefix: \"just to notify (in this hour) that #{ip} tried again\")\n      end\n      # Using 503 because it may make attacker think that they have successfully\n      # DOSed the site. Rack::Attack returns 403 for blocklists by default\n      [503, {}, [\n        \"Your IP address (#{ip}) has been blocked. If you think that this a \"\\\n        \"mistake please write to info@xceednet.com\"]]\n    end\n\n    self.throttled_response = lambda do |env|\n      ip = find_ip_from_env(env)\n      if ip.present?\n        Rails.cache.write(\"blocklist_ips #{ip}\", true,\n                          expires_in: THROTTLED_BLOCKED_INTERVAL)\n        Rails.logger.info \"throttled response: temporary adding #{ip} to \"\\\n        \"blocklist_ips\"\n        Notify.exception_with_env(\n          \"ip_throttle\",\n          env: env,\n          email_prefix: \"just info that #{ip} is on blocklist for some time\",\n          data: {\n            help_text: \"You can remove this temporary block in rails console \"\\\n            \"with this command (note that throttle still works):\n            rake rack_attack:remove_from_blocklist_ips[#{ip}]\n            ')\" }\n        )\n      else\n        Rails.logger.info \"throttled response, but do not know ip address\"\n      end\n\n      # Using 503 because it may make attacker think that they have successfully\n      # DOSed the site. Rack::Attack returns 429 for throttling by default\n      # [ 503, {}, [body]]\n      [503, {}, [\"Try later\"]]\n    end\n\n    def self.find_ip_from_env(env)\n      if env[\"REMOTE_ADDR\"].present?\n        env[\"REMOTE_ADDR\"]\n      else\n        # heroku\n        env[\"HTTP_X_FORWARDED_FOR\"]\n      end\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>You can test with command:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ab -n 350 http://localhost:3000\n</code></pre></div></div>\n\n<p>Default rails cache is file, so you need to <code class=\"highlighter-rouge\">rm -rf tmp/cache</code> if you want to\ntest clean situation.</p>\n\n<p>If you receive too much 404 in logs, you can ban ip addreses\n<a href=\"http://marianposaceanu.com/articles/keep-your-rails-logs-free-of-unwanted-noise\">http://marianposaceanu.com/articles/keep-your-rails-logs-free-of-unwanted-noise</a>\nFor example block ip address for one day if request is made to\n<code class=\"highlighter-rouge\">/{wp-admin|wp-login}</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># After 1 blocked requests in 10 minutes, block all requests from that IP for 1 day.\nRack::Attack.blocklist('fail2ban pentesters') do |req|\n  # `filter` returns truthy value if request fails, or if it's from a previously banned IP so the request is blocked\n  Rack::Attack::Fail2Ban.filter(\n    \"pentesters-#{req.ip}\",\n    maxretry: 1,\n    findtime: 10.minutes,\n    bantime: 1.day\n  ) do\n    # The count for the IP is incremented if the return value is truthy\n    req.path.include?('wp-admin') ||\n    req.path.include?('wp-login')\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"rack-timeout\">Rack Timeout</h1>\n\n<p>You can use <code class=\"highlighter-rouge\">rack-timeout</code> gem to abort requests that takes too long. For\nexample on Heroku there is a limit of 30seconds and longer requests are simply\ncanceled (there is no Expection notification in this case). Solution is to\nmanually cancel requests that takes 29 seconds and use 1 second to send\nnotification.\nhttps://github.com/heroku/rack-timeout\nTo resolve this problem you should but those requests to background jobs.</p>\n\n<h1 id=\"sql-injection\">SQL Injection</h1>\n\n<ul>\n  <li><a href=\"http://rails-sqli.org/\">rails-sqli</a> list of common injections</li>\n  <li>external params should be sanitized <code class=\"highlighter-rouge\">where(\"id = ?\", params[:id])</code> or\n<code class=\"highlighter-rouge\">where(\"id = :id\", id: params[:id])</code></li>\n  <li>\n    <p>with <code class=\"highlighter-rouge\">order</code> we can not use sanitizations <code class=\"highlighter-rouge\">?</code> or <code class=\"highlighter-rouge\">:id</code> method. So do not use\nstring interpolation since anybody can do anything (drop table, get access). You\ncan try with adding <code class=\"highlighter-rouge\">limit 1#</code> (<code class=\"highlighter-rouge\">#</code> is <code class=\"highlighter-rouge\">%23</code>\n<a href=\"http://www.w3schools.com/tags/ref_urlencode.asp\">encoded</a>) for example\n<code class=\"highlighter-rouge\">?sort=created_at&amp;direction=asc+limit+1%23</code>. Solution is to use methods that\nreturns only column names</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\ndef sort_column\n  %w[id name created_at].include?(params[:sort])) ? params[:sort] : \"id\"\nend\n\ndef sort_direction\n  %w[asc desc].include?(params[:direction]) ?  params[:direction] : \"desc\"\nend\n\ndef sort_query\n  \"#{sort_column} #{sort_direction}\"\nend\n\n# use like: User.order(sort_query)\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"ssl\">SSL</h1>\n\n<p>Add <a href=\"/2015/10/08/free-ssl-for-https-on-apache-or-nginx/\">free ssl</a></p>\n\n<ul>\n  <li>\n    <p>Test if it is working <a href=\"https://www.ssllabs.com/ssltest/\">https://www.ssllabs.com/ssltest/</a> try config with\nMozzila ssl config generator\nhttps://mozilla.github.io/server-side-tls/ssl-config-generator/</p>\n  </li>\n  <li>Add your site to hsts list <a href=\"https://hstspreload.org/\">https://hstspreload.org/</a> so major browser will\nuse https instead http (can’t use http).\n    <ul>\n      <li>if server reply with <code class=\"highlighter-rouge\">Strict-Transport-Security: max-age=16070400;\nincludeSubDomains</code> than browser will always use https\n<a href=\"https://www.chromium.org/hsts\">source</a>. For initial request browser maintains\n“hsts preload list” <a href=\"https://hstspreload.org\">https://hstspreload.org</a> where you can submit your sites\n<a href=\"https://ma.ttias.be/chrome-force-dev-domains-https-via-preloaded-hsts/\">google owns .dev and put it on hsts\nlist</a>\nso it will use https instead http for <code class=\"highlighter-rouge\">my-domain.dev</code>.</li>\n    </ul>\n  </li>\n  <li>If not using https than ISP or Browser can easilly inject javascript into the\npage and show adds.</li>\n  <li>If you have password field on a page, browsers will require https or show a\n“Not Secure Warning”.</li>\n  <li>It is mandatory for HTTP 2.0.</li>\n  <li>Some browsers features are only available over HTTPS: geolocation, service\nworkers, fullscreen…</li>\n</ul>\n\n<h1 id=\"csp\">CSP</h1>\n\n<p><a href=\"https://www.randomerrata.com/articles/2017/rails-security/\">https://www.randomerrata.com/articles/2017/rails-security/</a>\nCSP content security policy is header that tells browser where assets can be\nloaded from.\nRails initialy gives us protection from: CSRF, XSS, Injection (SQL, HTML,\nJavascript).\nDefault headers: X-Frame-Options, X-XSS-Protection, X-Content-Type-Options.</p>\n\n<p>Gem <a href=\"https://github.com/twitter/secureheaders\">https://github.com/twitter/secureheaders</a> can be added (just add to your\nGemfile <code class=\"highlighter-rouge\">gem 'secure_headers'</code> and create configuration</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/secure_headers.rb\nSecureHeaders::Configuration.default do |config|\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Content-Security-Policy:\n# allow only scripts from the same origin as the page\nscript-src 'self'\n# allow only scripts from the same origin as the page and google\nscript-src 'self' https://apis.google.com\n# allow all sources but disallow unsafe inline assets\nscript-src *\n# allow all and allow inline\nscript-src * 'unsafe-inline'\n\n# reporting to\nreport-uri https://xceednet.report-uri.io/r/default/csp/reportOnly\n</code></pre></div></div>\n\n<p>Content-Security-Policy-Report-Only</p>\n\n<p><a href=\"https://github.com/gbataille/csp_report\">https://github.com/gbataille/csp_report</a>\nYou can deploy to production using <em>Report only</em> so you can see what assets are\nused and add them one by one.</p>\n\n<p>You can test if browser is injecting js\n<a href=\"https://gist.github.com/danharper/8364399\">https://gist.github.com/danharper/8364399</a></p>\n\n<p>Tutorial <a href=\"https://chase.pursu.es/simple-intro-to-csp-for-rails.html\">https://chase.pursu.es/simple-intro-to-csp-for-rails.html</a></p>\n\n<h1 id=\"iptables\">Iptables</h1>\n\n<p>There are 3 types of chains: input, forward and output (some services like <code class=\"highlighter-rouge\">ssh</code>\nuse both input and output chains). Default policy (for example <code class=\"highlighter-rouge\">ACCEPT</code>) is used\nfor unmatched traffic. Response could be <code class=\"highlighter-rouge\">Accept</code>, <code class=\"highlighter-rouge\">Drop</code> (do not notify the\nsource) and <code class=\"highlighter-rouge\">Reject</code> (source knows that it was rejected).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># list all rules\niptables -L\n# block all connections from 10.10.10.10\niptables -A INPUT -s 10.10.10.10 -j DROP\n# block all connections from 10.10.10.10 for ssh\niptables -A INPUT -p tcp --dport ssh -s 10.10.10.10 -j DROP\n\n# SSH connections FROM 10.10.10.10 are permitted, but SSH TO 10.10.10.10 are not\niptables -A INPUT -p tcp --dport ssh -s 10.10.10.10 -m state --state NEW,ESTABLISHED -j ACCEPT\niptables -A OUTPUT -p tcp --sport 22 -d 10.10.10.10 -m state --state ESTABLISHED -j ACCEPT\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">iptables-save</code> to save changes.</p>\n\n<p>Example for WordPress useragent <code class=\"highlighter-rouge\">verifying pingback from</code> ddos attack\n<a href=\"https://www.christophe-casalegno.com/under-wordpress-pingback-ddos-attack-use-iptables/\">https://www.christophe-casalegno.com/under-wordpress-pingback-ddos-attack-use-iptables/</a></p>\n\n<h1 id=\"monit\">Monit</h1>\n\n<p>https://www.youtube.com/watch?v=wiRt3mY7Rrw</p>\n\n<h1 id=\"sample-security-app\">Sample security app</h1>\n\n<p>https://github.com/OWASP/railsgoat/wiki/Rails-5-Tutorials</p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>use scoped find, instead of <code class=\"highlighter-rouge\">Order.find params[:id]</code> use <code class=\"highlighter-rouge\">current_user.orders\nfind params[:id]</code></li>\n  <li>use rate limiting, for example facebook password recovery number is 6 digits,\nand beta.facebook did not have rate limit, so you can try 1 milin numbers very\nquickly</li>\n  <li>do not trust the mobile app, for example mobile app make a failed payment and\nthan change the payment response to be success and send that to server</li>\n  <li>if your server is doing curl requests for some user url, than user can set up\nsftp or smtp requests to any server and hide itself</li>\n  <li>use SHA 256 instead  md5 and SHA 1</li>\n</ul>\n\n<p><a href=\"https://github.com/eliotsykes/rails-security-checklist\">https://github.com/eliotsykes/rails-security-checklist</a>\n<a href=\"https://github.com/eliotsykes/real-world-rails\">https://github.com/eliotsykes/real-world-rails</a>\nhttps://github.com/pxlpnk/awesome-ruby-security</p>\n\n"
    } ,
  
    {
      "title"    : "Ubuntu working environment",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/09/13/ubuntu-working-environment/",
      "date"     : "2016-09-13 00:00:00 +0200",
      "content"  : "<h1 id=\"ubuntu-stuff\">Ubuntu stuff</h1>\n\n<ul>\n  <li>\n    <p>find ubuntu and linux version</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>lsb_release -a\ncat /proc/version\nuname -a\n</code></pre></div>    </div>\n  </li>\n  <li>taks screenshot: fullsize <code class=\"highlighter-rouge\">Print</code>, currently active window <code class=\"highlighter-rouge\">Alt+Print</code>, area\n<code class=\"highlighter-rouge\">Shift+Print</code> (select window or drag area).\nUse <code class=\"highlighter-rouge\">ctrl</code> instead of alt if you want to copy to clipboard</li>\n  <li><a href=\"https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding\">port\nforwarding</a> socks\ntunel <code class=\"highlighter-rouge\">ssh -C -D 1080 server_url_or_ip</code>, than in firefox</li>\n</ul>\n<p>&lt;about:preferences#advanced&gt; Networktab -&gt; Settings choose “Manual proxy\nconfiguration” and type SOCKS Host: localhost, and port 1080. Do not write\nanyting in HTTP proxy… For Chrome or another connections you can use system\nwide Ubuntu Settings -&gt; Network -&gt; Network Proxy -&gt; Method: Manual -&gt; Socks Host\nlocalhost 1080 (HTTP Proxy is empty), Ignore Hosts: localhost, *.loc</p>\n<ul>\n  <li>gui ssh forwarding <code class=\"highlighter-rouge\">ssh -X server</code> remote <code class=\"highlighter-rouge\">ssh -R 5900:localhost:5900\nguest@joes-pc</code> local</li>\n  <li><a href=\"https://github.com/umlaeute/v4l2loopback/wiki/Mplayer\">v4l2loopback</a>, after\n<code class=\"highlighter-rouge\">sudo make install</code> and <code class=\"highlighter-rouge\">sudo modprobe v4l2loopback</code> we can stream some video\nfile to device <code class=\"highlighter-rouge\">while true; do gst-launch-0.10 filesrc\nlocation=~/Desktop/buck.ogv ! decodebin ! v4l2sink device=/dev/video1;done</code></li>\n  <li>dim screen adjust brightness <code class=\"highlighter-rouge\">xrandr -q | grep \" connected\"</code> to find the\nname, for example <em>DFP1</em>, than <code class=\"highlighter-rouge\">xrandr --output DFP1 --brightness 0.5</code>. Here is\nwhat I use <code class=\"highlighter-rouge\">d 0.8</code> in\n<a href=\"https://github.com/duleorlovic/config/blob/master/my_bashrc.sh#L32\">my_bashrc.sh</a></li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># ~/.bashrc\nfunction d {\n  if [  -z $1 ]\n  then\n    echo Default is middle value: d 0.5\n  fi\n  xrandr --output DFP1 --brightness ${1:-0.5}\n}\nalias dim=d\n</code></pre></div></div>\n\n<p>there is <a href=\"https://justgetflux.com/\">f.lux</a> software that can automate screen\nbrighthness.</p>\n\n<ul>\n  <li>webcam does not work on chrome but works in firefox</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install libv4l-0\nsudo mv /opt/google/talkplugin/GoogleTalkPlugin /opt/google/talkplugin/GoogleTalkPlugin.real \ncat &gt; /opt/google/talkplugin/GoogleTalkPlugin &lt;&lt;HERE_DOC\n#!/bin/bash\nLD_PRELOAD=/usr/lib/x86_64-linux-gnu/libv4l/v4l1compat.so /opt/google/talkplugin/GoogleTalkPlugin.real\nHERE_DOC\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>Simple scan scanner for HP LasetJet MF1212nf MFP does not work if you add\nprinter from gui. Better is to use:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt install hplip # install hp-setup\nhp-setup -i\n# chose net\n# chose to download driver from hp site\n# no need to install fax printer\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>recently I got dns error (I’m using 8.8.8.8). Following\n<a href=\"http://askubuntu.com/questions/368435/how-do-i-fix-dns-resolving-which-doesnt-work-after-upgrading-to-ubuntu-13-10-s\">post</a>\nI comment out <code class=\"highlighter-rouge\"># dns=dnsmasq</code> from /etc/NetworkManager/NetworkManager.conf and\n<code class=\"highlighter-rouge\">sudo restart network-manager</code></p>\n  </li>\n  <li>\n    <p>if <code class=\"highlighter-rouge\">Bus 002 Device 003: ID 0d8c:013c C-Media Electronics, Inc. CM108 Audio\nController</code> microphone does not work automatically (but you can see in sound\nsettings as <em>CM108 Audio Controller</em> than you need to comment out last line\n<code class=\"highlighter-rouge\">#options snd-usb-audio index=0 </code> in <code class=\"highlighter-rouge\">/etc/modprobe.d/alsa-base.conf</code>.</p>\n  </li>\n</ul>\n\n<h1 id=\"chrome-chromium\">Chrome chromium</h1>\n\n<ul>\n  <li>take screenshot with <code class=\"highlighter-rouge\">ctrl+Shift + p</code> and search screenshot</li>\n  <li><a href=\"https://code.google.com/p/chromium/issues/detail?id=375957\">chrome scrambled</a>\ncan be solved with <code class=\"highlighter-rouge\">sudo amdconfig --initial</code></li>\n  <li>chrome flickers on resize\n<a href=\"http://askubuntu.com/questions/279088/google-chrome-flickering\">link</a>\nsolution is to disable (uncheck) <strong>Use hardware acceleration when available</strong>\nin System Settings -&gt; Show Advanced -&gt; (at bottom, search for this option) (or\n<code class=\"highlighter-rouge\">--disable-gpu</code> in <code class=\"highlighter-rouge\">/usr/share/applications/chromium-browser.desktop</code>). I try\nto disable only composition <code class=\"highlighter-rouge\">--blacklist-accelerated-compositing</code> but still is\nenabled. Check that features is software only on &lt;chrome://gpu/&gt;.</li>\n  <li>you can open extension by going to &lt;chrome://apps&gt;</li>\n  <li>enable some flags on &lt;chrome://flags&gt;\n    <ul>\n      <li>for example sound icon</li>\n    </ul>\n  </li>\n  <li>dns or other network &lt;chrome://net-internals&gt;</li>\n  <li>T-rex game &lt;chrome://network-error/-106&gt;</li>\n</ul>\n\n<h2 id=\"chrome-plugins-and-extensions\">Chrome plugins and extensions</h2>\n\n<ul>\n  <li><a href=\"https://github.com/chrispederick/user-agent-switcher/\">user agent switcher</a></li>\n  <li>to check which browsers was used by useragent string\n<a href=\"https://developers.whatismybrowser.com/useragents/parse\">parse user agent strings</a></li>\n  <li><a href=\"https://chrome.google.com/webstore/detail/railspanel/gjpfobpafnhjhbajcjgccbbdofdckggg\">railspanel</a></li>\n</ul>\n\n<h2 id=\"chrome-dns-and-hsts-problem-for-localhost-and-dev\">Chrome DNS and HSTS problem for .localhost and .dev</h2>\n\n<p>Since google owns <code class=\"highlighter-rouge\">.dev</code> domain and it exists in hsts list, in chrome (no\nfirefox) request to <code class=\"highlighter-rouge\">my-domain.dev</code> will be always https.\nYou can also use <code class=\"highlighter-rouge\">lvh.me</code> since it always resolves to 127.0.0.1.\nBut for local development I use <code class=\"highlighter-rouge\">.loc</code> with dnsmasq or <code class=\"highlighter-rouge\">.localhost</code> also with\ndnsmasq.\nOld answer: <strong>I did not choose to use <code class=\"highlighter-rouge\">localhost</code> because I can not remap subdomain of localhost in /etc/hosts and use in google\nchrome (firefox works fine) for some pathetic reason\n<a href=\"https://stackoverflow.com/questions/39666979/chrome-ignoring-hosts-file-for-subdomains-of-localhost\">https://stackoverflow.com/questions/39666979/chrome-ignoring-hosts-file-for-subdomains-of-localhost</a></strong>\nNow localhost works in Chrome but not in Firefox (about:config\nnetwork.dns.disableIPv6 set to false did not work for me).\nWhen I change <code class=\"highlighter-rouge\">loc</code> to <code class=\"highlighter-rouge\">localhost</code> in <code class=\"highlighter-rouge\">/etc/dnsmasq.d/dev-tld</code> than it works.</p>\n\n<p>For all subdomains I use dnsmasq so I do not need to edit /etc/hosts for each\nsubdomain:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/dnsmasq.d/dev-tld\nlocal=/loc/\naddress=/loc/127.0.0.1\n</code></pre></div></div>\n\n<p>restart with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo systemctl restart NetworkManager\nsudo /etc/init.d/dnsmasq restart\n</code></pre></div></div>\n\n<p>Also follow <a href=\"https://gist.github.com/marek-saji/6808114\">instructions</a></p>\n\n<p>DNS server dnsmasq for .dev domains for osx <a href=\"https://passingcuriosity.com/2013/dnsmasq-dev-osx/\">https://passingcuriosity.com/2013/dnsmasq-dev-osx/</a>\nhttps://gist.github.com/ogrrd/5831371</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>brew install dnsmasq\n# read suggested commands and apply them\ncp /usr/local/opt/dnsmasq/dnsmasq.conf.example /usr/local/etc/dnsmasq.conf\nsudo brew services start dnsmasq\n\n# in /usr/local/etc/dnsmasq.conf\naddress=/loc/127.0.0.1\n\nsudo brew services restart dnsmasq\n\nsudo mkdir -p /etc/resolver\nsudo tee /etc/resolver/loc &gt;/dev/null &lt;&lt;EOF\nnameserver 127.0.0.1\nEOF\n</code></pre></div></div>\n\n<p>Test with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Make sure you haven not broken your DNS.\nping -c 1 www.google.com\n# Check that .loc names work\nping -c 1 this.is.a.test.loc\n</code></pre></div></div>\n\n<p>You can check your domain name resolutions with mxtoolbox.com or domain settings\nwith command <code class=\"highlighter-rouge\">nslookup</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>nslookup asd.loc\n# Server:\t\t127.0.0.1\n# Address:\t127.0.0.1#53\n#\n# Name:\tasd.loc\n# Address: 127.0.0.1\n</code></pre></div></div>\n\n<p>On linux you can update <code class=\"highlighter-rouge\">/etc/hosts</code> with you custom domain name and use it\ninstead of IP address.\nOn window it is <code class=\"highlighter-rouge\">c:\\Windows\\System32\\Drivers\\etc</code>. Just edit with notepad and\nsave. No need to restart (maybe it will be cleared on restart).</p>\n\n<h2 id=\"chrome-developer-tools\">Chrome Developer tools</h2>\n\n<ul>\n  <li>open developer tools on last tab that was used is with <code class=\"highlighter-rouge\">F12</code> or\n<code class=\"highlighter-rouge\">ctrl+shift+i</code>. Switch to next and prev panel with <code class=\"highlighter-rouge\">ctrl+]</code> and <code class=\"highlighter-rouge\">ctrl+[</code>.\n<code class=\"highlighter-rouge\">ctrl+shift+d</code> dock undock. Open drawer with <code class=\"highlighter-rouge\">ESC</code></li>\n  <li>on drawer three dots, you can\n    <ul>\n      <li>to search file in google developer tools you can open console window (not\nconsole tab with console input, window can be opened on any tab with ESC key\nin dev tools). Than on three dots, open dropdown menu and find <em>Search</em>\n(keyboard shortcut is <code class=\"highlighter-rouge\">ctrl+shift+f</code>). To search current panel use <code class=\"highlighter-rouge\">ctrl+f</code></li>\n    </ul>\n  </li>\n  <li>three dots -&gt; Coverage can give how much of css or js is used on the page</li>\n  <li><a href=\"https://developers.google.com/web/tools/chrome-devtools/profile/network-performance/resource-loading#filter-requests\">network tab filter\nrequest</a>\nwill filter by filename containg the string <code class=\"highlighter-rouge\">posts</code>. But it also supports\nkeywords with autosuggestions. Examples: <code class=\"highlighter-rouge\">domain:*.com</code>, <code class=\"highlighter-rouge\">larger-than:1K</code>,</li>\n  <li>to stop on some page that redirects immediatelly, you can go <code class=\"highlighter-rouge\">Sources</code> tab and\n<em>Event Listener Breakpoints</em> and <em>Load -&gt; beforeunload</em> or <em>Script -&gt; Script\nfirst statement</em>.\nTo stop on XHR/Fetch call you can set breakpoint on Sources -&gt; XHR breakpoint</li>\n  <li>to search all files <code class=\"highlighter-rouge\">ctrl+o</code></li>\n  <li>to open <strong>command menu</strong> use <code class=\"highlighter-rouge\">ctrl+shift+p</code>\n    <ul>\n      <li><code class=\"highlighter-rouge\">screenshot</code></li>\n    </ul>\n  </li>\n  <li>to open <strong>Console panel</strong> you can use <code class=\"highlighter-rouge\">ctrl+shift+j</code> (also on a page). You can\n use <code class=\"highlighter-rouge\">monitor(function)</code>, <code class=\"highlighter-rouge\">monitorEvents($0, \"key\");</code> <code class=\"highlighter-rouge\">debug(function)</code> or\n<code class=\"highlighter-rouge\">undebug(function)</code>. Usefull when you want to stop on some event listener\n<code class=\"highlighter-rouge\">debug(getEventListeners($0).click[0].listener)</code> (you can do the same using\nElements, Event Listeners tab, click, and jump to source where you want\nbreakpoint). To show some value in log you can add Conditional breakport with\n<code class=\"highlighter-rouge\">console.log(varname);</code> to use current selected element in console use <code class=\"highlighter-rouge\">$0</code>\n(<code class=\"highlighter-rouge\">$1</code> previous selected and so on), for xpath use <code class=\"highlighter-rouge\">$x()</code>. Use <code class=\"highlighter-rouge\">$_</code> for last\nreturned value in console.\n<a href=\"https://developers.google.com/web/tools/chrome-devtools/console/command-line-reference\">link</a></li>\n  <li>\n    <p>to open <strong>Elements panel</strong> (if developer tools is not yet opened) is\n<code class=\"highlighter-rouge\">ctrl+shift+c</code>. You can use <code class=\"highlighter-rouge\">h</code> to hide element (<code class=\"highlighter-rouge\">visibility: hidden</code>). Use\n<code class=\"highlighter-rouge\">ctrl+f</code> to find element (<code class=\"highlighter-rouge\">enter</code> to find next). You can use <code class=\"highlighter-rouge\">.class</code> to\nlocate by css class.</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">ctrl+Shift + m</code> to toggle mobile responsive view</li>\n  <li><code class=\"highlighter-rouge\">ctrl+o</code> find filename</li>\n  <li><code class=\"highlighter-rouge\">ctrl+shift+</code></li>\n  <li><code class=\"highlighter-rouge\">^shift+c</code> to click and locate element</li>\n  <li><code class=\"highlighter-rouge\">^shift+f</code> to find string in all files</li>\n  <li><code class=\"highlighter-rouge\">^shift+o</code> find functions in the current js file</li>\n  <li><code class=\"highlighter-rouge\">^shift+p</code> chrome shortcuts</li>\n</ul>\n\n<p>Enable experiments with &lt;chrome://flags/#enable-devtools-experiments&gt; and go to\nExperiments menu in Settings (F1 or Ctrl+P+Settings)</p>\n\n<p>To clear autofill suggestions you can use keyboard shortcut. First select\n  suggestion with UP or Down arrows than press Shift + Delete\n  <a href=\"https://support.google.com/chrome/answer/142893?p=settings_autofill&amp;rd=1\">answer</a></p>\n\n<p>In console you can call</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>url=\"http://numbersapi.com/5/math\"\nawait fetch(url)\nawait r.text()\n</code></pre></div></div>\n\n<p>Audit tab can give you broken best practices and explanations.</p>\n\n<h1 id=\"firefox\">Firefox</h1>\n\n<p>url suggestion does not use port number, so it is advised to disable it on\n<code class=\"highlighter-rouge\">about:config</code> for <code class=\"highlighter-rouge\">browser.urlbar.autoFill</code> to false. That way only history\nlinks will be provided, so you can navigate to them using tab.</p>\n\n<h2 id=\"firefox-developer-tools-and-navigations\">Firefox developer tools and navigations</h2>\n\n<p>like vim</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">ctrl+[</code> back</li>\n  <li><code class=\"highlighter-rouge\">ctrl+]</code> forward</li>\n  <li><code class=\"highlighter-rouge\">ctrl+f</code> find (<code class=\"highlighter-rouge\">F3</code> and <code class=\"highlighter-rouge\">shift+F3</code> find next and prev)</li>\n  <li><code class=\"highlighter-rouge\">/</code> quick find, <code class=\"highlighter-rouge\">'</code> find only in links</li>\n  <li><code class=\"highlighter-rouge\">ctrl+j</code> focus search bar</li>\n  <li><code class=\"highlighter-rouge\">ctrl+shift+i</code> toggle developer tools (<code class=\"highlighter-rouge\">F12</code>), <code class=\"highlighter-rouge\">ctrl+shift+k</code> console,\n<code class=\"highlighter-rouge\">ctrl+shift+c</code> inspector, <code class=\"highlighter-rouge\">shift+F7</code> style, <code class=\"highlighter-rouge\">ctrl+shift+m</code> mobile responsive,\n<code class=\"highlighter-rouge\">ctrl+shift+j</code> browser console</li>\n  <li><code class=\"highlighter-rouge\">shift+f4</code> scratchpad and run with <code class=\"highlighter-rouge\">ctrl+r</code></li>\n  <li><code class=\"highlighter-rouge\">shift+f2</code> developer toolbar</li>\n  <li><code class=\"highlighter-rouge\">ctrl+i</code> page info (content-type, referring url, size…)</li>\n  <li><code class=\"highlighter-rouge\">f7</code> carret browsing so you can navigate cursor with shift arrow and ctrl+c</li>\n</ul>\n\n<h2 id=\"firefox-webide\">Firefox WebIDE</h2>\n\n<p>You can remotelly debug a page on your phone. Start\nhttps://developer.mozilla.org/en-US/docs/Tools/Remote_Debugging Enable Developer\nmode on Android: Settings -&gt; About Phone -&gt; Build Number -&gt; Tap 10 times and you\nwill see parent Setting menu -&gt; Developer Options -&gt; enable USB Debugging.</p>\n\n<p>On desktop Firefox open Settings -&gt; Web Developer -&gt; WebIDE (shift+F8).\nOn android Firefox open Settings -&gt; Advanced -&gt; enable Remote Debugging via USB.</p>\n\n<p>Android Firefox needs to confirm Incomming connection: Allow USB debugging\nconnection ?.  Also the app needs to be opened (in focus).</p>\n\n<h1 id=\"opera\">Opera</h1>\n\n<p>Download for ubuntu https://www.opera.com/\nDownload mobile browser Opera mobile emulator https://www.opera.com/developer/mobile-emulator</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>./opera-mobile-emulator\n# error while loading shared libraries: libQtGui.so.4: cannot open shared object file: No such file or directory\n\n# to find in which package this file belongs use\n# apt-file search libQtGui.so\n\nsudo apt install libqtwebkit4\n./opera-mobile-emulator\n# still same error\n</code></pre></div></div>\n\n<h1 id=\"gimp\">Gimp</h1>\n\n<p>Cage transform https://www.youtube.com/watch?v=jL8TepHX0qE does not work in\nlatest gimp so use old ubuntu 14 in virtual box.</p>\n\n<h1 id=\"ftp\">FTP</h1>\n\n<p>To enable ftp write you need to uncomment <code class=\"highlighter-rouge\">sudo vi /etc/vsftpd.conf</code>\n<code class=\"highlighter-rouge\">write_enable=YES</code> and restart <code class=\"highlighter-rouge\">sudo service vsftpd restart</code>. You need to create\nfolder (owner should be trkftp user).</p>\n\n<h1 id=\"ngrok\">Ngrok</h1>\n\n<p>Also https://localtunnel.github.io/www/</p>\n\n<p>You can create local tunnel with ngrok.</p>\n\n<p>When you signup you can generate authtoken in your <code class=\"highlighter-rouge\">~/.ngrok2/ngrok.yml</code>.</p>\n\n<p>You need to upgrade to use custom subdomains, but free domain is fine if you can\nuse some of your dns.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ngrok http 3002\n</code></pre></div></div>\n\n<h1 id=\"tips\">TIPS</h1>\n\n<ul>\n  <li>to change default program open with file type, you can right click,\nproperties, set default.</li>\n  <li>read only usb, can’t create file since usb is readonly https://askubuntu.com/questions/781223/physical-block-size-is-2048-bytes-but-linux-says-it-is-512-when-formatting-us</li>\n</ul>\n\n<p>or error: ‘The driver descriptor says the physical block size is 2048 bytes, but\nLinux says it is 512 bytes’</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>df -Th\numount /media/duleusb\nsudo fdisk -l\n#\nudisksctl unmount -b /dev/sdc1\nsudo sgdisk --zap-all /dev/sdc\nsudo sgdisk --new=1:0:0 --typecode=1:ef00 /dev/sdc\nsudo mkfs.vfat -F32 /dev/sdc1\n</code></pre></div></div>\n\n<p>use <code class=\"highlighter-rouge\">disks</code> application to erase and format usb flash drive.\nIf it is not mountable than try\n<a href=\"https://ubuntuforums.org/showthread.php?t=2153643\">forum</a> but change number of\nKB 1024, 2048 …</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo dd if=/dev/zero bs=4096 of=/dev/sdc\nsudo apt-get install gparted\n# Device -&gt; Create partition table.\n# format to fat32\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>to backup external usb, you can sync files. With rsync files are not deleted,\njust added, or overwritten if same filename. <code class=\"highlighter-rouge\">cd\n/media/orlovic/bf12a7e5-a5d4-4532-8612-a3984f90b56c/backup</code> and <code class=\"highlighter-rouge\">rsync -r\n/media/dusan/EKSTERNIUSB/ EXTERNIUSB</code></p>\n  </li>\n  <li>\n    <p>suspend recovery <a href=\"https://wiki.ubuntu.com/DebuggingKernelSuspend\">https://wiki.ubuntu.com/DebuggingKernelSuspend</a></p>\n  </li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># enable trace and log\nsudo sh -c \"sync &amp;&amp; echo 1 &gt; /sys/power/pm_trace &amp;&amp; pm-suspend\"\n\n# enable log in command env\nsudo PM_DEBUG=true pm-suspend\n\nless /var/log/pm-suspend.log\n</code></pre></div></div>\n\n<ul>\n  <li>instead of double click .deb file to install you can use command line <code class=\"highlighter-rouge\">sudo\ndpkg -i /home/orlovic/Downloads/skypeforlinux-64.deb</code></li>\n</ul>\n\n<h1 id=\"pdf\">PDF</h1>\n\n<p>Merge several pdf files</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pdftk * cat output ../p.pdf\n</code></pre></div></div>\n\n<h1 id=\"canon-camera-wifi\">Canon camera wifi</h1>\n\n<p><a href=\"http://www.testcams.com/airnef/\">http://www.testcams.com/airnef/</a> is used to download files from Canon camera.</p>\n\n<h1 id=\"network\">Network</h1>\n\n<p><code class=\"highlighter-rouge\">ifconfig</code> is a tool to change network configuration, but changes are not\npersisted unless you save them in <code class=\"highlighter-rouge\">/etc/network/interfaces</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ifconfig eth0\n</code></pre></div></div>\n\n<p>To configure default dateway gw you can use <code class=\"highlighter-rouge\">route</code> command</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo route add default gw 10.0.0.1 eth1\nroute -n\n</code></pre></div></div>\n\n<p>To configure DNS you can edit <code class=\"highlighter-rouge\">/etc/resolv.conf</code>.\nTo purge all configuration you can <code class=\"highlighter-rouge\">ip addr flush eth0</code></p>\n\n<p>To prevent Network manager to use connection as default route, you can edit\nconnections -&gt; IPv4 Settings -&gt; Routes -&gt; check “Use this connection only for\nresources on its network”</p>\n\n<p>To remove docker bridge you can run <code class=\"highlighter-rouge\">ip link del docker0</code></p>\n\n<ul>\n  <li>resize mp4 video with avconv</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>avconv -i input.mp4 -s 640x480 -strict -2 output.mp4\nfor i in *.MP4; do avconv -i \"$i\" -strict -2 \"resized/$i\"; done\n</code></pre></div></div>\n\n<ul>\n  <li>convert dvd vob to mp4\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>for f in *.VOB ; do ffmpeg -i \"$f\" -vcodec copy -strict experimental -c:a aac \"${f%.*.VOB}.mp4\"; done\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>default gnome screenshot folder <code class=\"highlighter-rouge\">dconf-editor</code> find\n<code class=\"highlighter-rouge\">org-&gt;gnome-&gt;gnome-screenshot-&gt; auto-save-directory -&gt;\nfile:///home/user/Download/</code></p>\n  </li>\n  <li>\n    <p>install Oracle Java instead of OpenJDK http://www.webupd8.org/2012/09/install-oracle-java-8-in-ubuntu-via-ppa.html</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo add-apt-repository ppa:webupd8team/java\nsudo apt-get update\nsudo apt-get install oracle-java8-installer\nsudo update-alternatives --config java\njava -version\njavac -version\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>bluetooth</p>\n\n    <p>https://forums.bunsenlabs.org/viewtopic.php?id=4375</p>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>systemctl status bluetooth.service\nsudo systemctl restart bluetooth.service\nlsusb\nlspci -knn\n\nbluetoothctl\nlist\nshow\nagen on\npower on\nscan on\n</code></pre></div>    </div>\n\n    <p>My is</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>04:00.0 Network controller [0280]: Qualcomm Atheros AR9462 Wireless Network Adapter [168c:0034] (rev 01)\n  Subsystem: Lite-On Communications Inc AR9462 Wireless Network Adapter [11ad:6621]\n</code></pre></div>    </div>\n\n    <p>https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1394368</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo -i\necho \"options ath9k btcoex_enable=1\"  &gt;  /etc/modprobe.d/ath9k.conf\n</code></pre></div>    </div>\n  </li>\n  <li>trim or mute vocals in mp3 files with audacity</li>\n  <li>boot old computers\n    <ul>\n      <li>unetbootin http://unetbootin.github.io/</li>\n      <li>burn cd with mini.iso\nhttps://help.ubuntu.com/community/Installation/MinimalCD (since full iso is\n850MB &gt; 700 MB CD capacity)</li>\n    </ul>\n  </li>\n  <li>find motherboard proccessor model with <code class=\"highlighter-rouge\">sudo dmidecode | less</code>. To find type\nof memory run <code class=\"highlighter-rouge\">sudo dmidecode --type 17</code> and look for <code class=\"highlighter-rouge\">Type Detail</code> (for\nmy server <a href=\"https://www.dell.com/ky/business/p/poweredge-t110-2/pd\">Dell power Edge\nT110</a>  it is <code class=\"highlighter-rouge\">Type\nDetail: Synchronous Unbuffered (Unregistered)</code> and <code class=\"highlighter-rouge\">Part Number</code>\n(M391B5273DH0-CK0) so it does not support registered/buffered memory\n<a href=\"https://www.dell.com/community/PowerEdge-Hardware-General/PowerEdge-T110-RAM-compatibility/td-p/5816309\">link</a></li>\n</ul>\n\n<h1 id=\"remote-access-to-services\">Remote access to services</h1>\n\n<p>To enable mysql service from remote you need to bind it to 0.0.0.0 in\nconfiguration. To test on which interface is some port listening you can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo netstat -plutn | grep 3306\n</code></pre></div></div>\n\n<p>You can try with nmap but it does not show for example neo4j 7474 port</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>nmap 127.0.0.1\nnmap 192.168.3.2\n</code></pre></div></div>\n\n<p>To start service on boot use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>service --status-all\n\n# to automatically boot\nsudo update-rc.d neo4j defaults\n# to remove from auto start\nupdate-rc.d -f neo4j remove\n\n# another way to set up to run at boot [+]\n\nsudo systemctl enable neo4j\n</code></pre></div></div>\n\n<h1 id=\"obs-studio\">Obs studio</h1>\n\n<p>Install https://obsproject.com/</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo add-apt-repository ppa:obsproject/obs-studio\nsudo apt-get update\nsudo apt-get install obs-studio\n</code></pre></div></div>\n\n<h2 id=\"stream-remote-screen-recordings\">Stream remote screen recordings</h2>\n\n<p>You can stream from other computers using VNC (on windows install TinyVNC) and\non main comp use VNC viewer and stream that Window Capture (Xcomposite).</p>\n\n<p>Stream from web use: https://github.com/bazukas/obs-linuxbrowser</p>\n\n<h2 id=\"auto-rotate-scenes-based-on-timer\">Auto rotate scenes based on timer</h2>\n\n<p>Advances Scene switcher\nhttps://obsproject.com/forum/resources/advanced-scene-switcher.395/ source\nhttps://github.com/WarmUpTill/SceneSwitcher</p>\n\n<p>To install download .so and copy</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo cp ~/Downloads/SceneSwitcher/SceneSwitcher/Linux/advanced-scene-switcher.so /usr/lib/obs-plugins/\n</code></pre></div></div>\n\n<p>On linux there could be an error (Help -&gt; Log files -&gt; View current log)</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>09:13:53.109: os_dlopen(/usr//lib/obs-plugins/advanced-scene-switcher.so-&gt;/usr//lib/obs-plugins/advanced-scene-switcher.so): /usr/lib/x86_64-linux-gnu/libQt5Gui.so.5: version `Qt_5' not found (required by /usr//lib/obs-plugins/advanced-scene-switcher.so)\n09:13:53.109:\n09:13:53.109: Module '/usr//lib/obs-plugins/advanced-scene-switcher.so' not loaded\n</code></pre></div></div>\n\n<p>You can check which libraries qt is using <code class=\"highlighter-rouge\">ldd $(which qtcreator)</code> (it is in\n/usr/lib/x86_64-linux-gnu/libQt5Gui.so.5: but plugin is not using it).\nI tried to compile plugin from source</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cmake -DLIBOBS_INCLUDE_DIR=~/Programs/obs-studio/libobs -DLIBOBS_FRONTEND_INCLUDE_DIR=~/Programs/obs-studio/UI/obs-frontend-api/ -DLIBOBS_FRONTEND_API_LIB=/usr/lib/ -DCMAKE_INSTALL_PREFIX=/usr ..\nmake\n</code></pre></div></div>\n<p>but I receive error</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Generating ui_advanced-scene-switcher.h\nFile '/home/orlovic/Programs/SceneSwitcher/src/headers/advanced-scene-switcher.ui' is not valid\nAUTOUIC: error: process for ui_advanced-scene-switcher.h needed by\n \"/home/orlovic/Programs/SceneSwitcher/src/headers/advanced-scene-switcher.hpp\"\n</code></pre></div></div>\n\n<p>So I build from source using Debian-based Build Directions on\nhttps://obsproject.com/wiki/install-instructions#linux</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install build-essential pkg-config cmake git-core checkinstall\nsudo apt-get install libx11-dev libgl1-mesa-dev libvlc-dev libpulse-dev libxcomposite-dev libxinerama-dev libv4l-dev libudev-dev libfreetype6-dev libfontconfig1-dev qtbase5-dev libqt5x11extras5-dev libqt5svg5-dev libx264-dev libxcb-xinerama0-dev libxcb-shm0-dev libjack-jackd2-dev libcurl4-openssl-dev libluajit-5.1-dev swig python3-dev\n</code></pre></div></div>\n\n<p>Install ffmpeg from source</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install zlib1g-dev yasm\ngit clone --depth 1 git://source.ffmpeg.org/ffmpeg.git\ncd ffmpeg\n./configure --enable-shared --prefix=/usr\nmake -j4\nsudo checkinstall --pkgname=FFmpeg --fstrans=no --backup=no \\\n        --pkgversion=\"$(date +%Y%m%d)-git\" --deldoc=yes\n#      dpkg -r ffmpeg\n\n</code></pre></div></div>\n\n<p>To find package which provide a header file</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>apt-file search X11/extensions/scrnsaver.h\n</code></pre></div></div>\n\n<p>So I installed also</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install libxss-dev\n</code></pre></div></div>\n\n<p>Build OBS</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git clone --recursive https://github.com/obsproject/obs-studio.git\ncd obs-studio\nmkdir build &amp;&amp; cd build\ncmake -DUNIX_STRUCTURE=1 -DCMAKE_INSTALL_PREFIX=/usr ..\nmake -j4\nsudo checkinstall --pkgname=obs-studio --fstrans=no --backup=no \\\n       --pkgversion=\"$(date +%Y%m%d)-git\" --deldoc=yes\n</code></pre></div></div>\n\n<h1 id=\"open-shot\">Open Shot</h1>\n\n<p>https://www.openshot.org/static/files/user-guide/introduction.html#features\nhttp://www.blender.org\nhandbrake</p>\n\n<p>For youtube, video should be 16:9, ie for 1080p: 1920x1080, and for 720p:\n1280x720.\nUse Handbrake to preview for 720px height and use ffmpeg to crop window\n(original_width x 720) starting from position 0 x (top_pixel_handbrake)\nFfmpeg generates smaller video than handbrake’s output m4v file.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ffmpeg -i dahua.ts -filter:v 'crop=2592:720:0:824' -strict -2 k.mp4\n</code></pre></div></div>\n<p>using handbrake and move the canvas using.</p>\n"
    } ,
  
    {
      "title"    : "Ruby Math Hackerrank",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/09/12/ruby-math-hackerrank/",
      "date"     : "2016-09-12 00:00:00 +0200",
      "content"  : "<h1 id=\"install\">Install</h1>\n\n<p>Install vim plugin <a href=\"/2015/12/01/vim-tips/#seeing-is-believing\">seeing-is-believing</a> and write Gemfile</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\nsource 'https://rubygems.org'\n\nruby '2.2.3'\n\n# for instant output of commands\ngem 'seeing_is_believing'\n\n# irbtools includes interactive_editor (vim inside irb)\n# just create ~/.irbrc with\n# require 'rubygems'\n# require 'irbtools'\ngem 'irbtools'\n\n# debugging\ngem 'byebug'\n\n# simple test assertions\ngem 'minitest'\n</code></pre></div></div>\n\n<h1 id=\"links\">Links</h1>\n\n<p>Math and algorith tasks</p>\n\n<ul>\n  <li>https://www.hackerrank.com\n    <ul>\n      <li>nice editor, solution have to be memory effiction (it raises Timeout or Run\nTime Error)</li>\n    </ul>\n  </li>\n  <li>https://projecteuler.net/</li>\n  <li>http://www.beatmycode.com/</li>\n  <li>http://codility.com/programmers/</li>\n</ul>\n\n<p>Codility Solutions</p>\n\n<ul>\n  <li>https://github.com/GNakayama/codility/tree/master/src/python and blog\nhttp://blog.nkbits.com/</li>\n  <li>http://codesays.com/ http://codesays.com/solutions-to-training-by-codility/</li>\n  <li>http://www.martinkysel.com/codility-solutions/</li>\n</ul>\n\n<h1 id=\"just-enough-ruby\">Just enough ruby</h1>\n\n<ul>\n  <li>\n    <p>read from STDIN or from a file if you run with <code class=\"highlighter-rouge\">ruby script.rb my_data</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>n = gets.to_i\narray = gets.strip.split(' ').map(&amp;:to_i)\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>write to a file</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>File.open \"my_file_name\", 'w' do |file|\n  file.puts \"first line (no need for new line char \\ n)\"\n  file &lt;&lt; \"second line \\n\"\n  file.write \"third line \\n\"\nend\n</code></pre></div>    </div>\n\n    <p>or in single line <code class=\"highlighter-rouge\">File.write '/path/to/file', 'My Text', mode: 'a'</code></p>\n  </li>\n  <li>division is integer division, so that <code class=\"highlighter-rouge\">1/2 == 0</code> in ruby. You need to convert\nto float <code class=\"highlighter-rouge\">x = x.to_f</code></li>\n  <li>iterate range <code class=\"highlighter-rouge\">(1..10).each</code> or <code class=\"highlighter-rouge\">1.upto(10).each</code></li>\n  <li>exponent is <code class=\"highlighter-rouge\">2**2 == 4</code></li>\n</ul>\n\n<h1 id=\"example-code\">Example code</h1>\n\n<p>We can use <a href=\"https://ruby-doc.org/stdlib-2.1.0/libdoc/pp/rdoc/PP.html\">pp</a>\nstandard library to print arrays just <code class=\"highlighter-rouge\">require 'pp'</code>. But if you need to print\nmatrix, than you can use ppp <code class=\"highlighter-rouge\">require './ppp'</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># ppp.rb\ndef ppp(x)\n  if x.class == Array\n    puts_array(x)\n  else\n    puts x\n  end\nend\n\ndef puts_array(x)\n  need_new_line = false\n  x.each do |e|\n    if e.class == Array\n      puts e.join(', ')\n    else\n      print e.to_s + ', '\n      need_new_line = true\n    end\n  end\n  puts if need_new_line\nend\n</code></pre></div></div>\n\n<p>Here is example for one solution that is submitted on site (it can not\n<code class=\"highlighter-rouge\">require byebug</code>) so it use constant PRODUCTION. Test are in the same file.\nIf the task is to read from file and to submit generated file, than use second\ntempalte.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># 0_short_palindrome.rb\n# https://www.hackerrank.com/challenges/short-palindrome\n# string s of n lowecase letters s_i 0&lt;=i&lt;n\n# (a, b, c, d)\n# s_a = s_b chars at a and d are the same\n# s_b = s_c\n# constrains:\n# 0&lt;=a&lt;b&lt;c&lt;d&lt;n\n# input: string s\n# 1&lt;= |s| &lt; 10^6\n# output: number of (a, b, c, d) tuples, use moduo 10^9 + 7\nPRODUCTION = false\nif PRODUCTION\n  def ppp(_arg = nil); end\n\n  def pp(_arg = nil); end\nelse\n  require 'pp'\n  require './ppp'\n  require 'byebug'\nend\n\n# rubocop:disable Metrics/MethodLength\n# rubocop:disable Metrics/AbcSize\ndef solution(a)\n  r = a.length\n  ppp \"r=#{r}\"\n  r\nend\n\nif PRODUCTION\n  n = gets.to_i\n  a = []\n  n.times do\n    # strip is needed since on hackerrank, new line is at the end of gets\n    r = gets.strip.split('').map { |c| c == '*' ? 0 : 1 }\n    a &lt;&lt; r\n  end\n  puts solution(a)\nend # if PRODUCTION\n\nrequire 'minitest/autorun'\nclass Test &lt; Minitest::Test\n  def test_sample\n    s = 'kkkkkkz'\n    assert_equal 12, solution(prepare(s))\n  end\n\n  def test_long\n    s = %(***.*\n**..*\n***.*\n*****\n*****)\n    assert_equal 12, solution(prepare(s))\n  end\n\n  def test_float\n    asert_in_delta 0.5, solution(1,2) # default delta=0.001\n  end\n\n  def test_that_is_skipped\n    skip \"later\"\n  end\n\n  private\n\n  def prepare(s)\n    s\n  end\nend\n</code></pre></div></div>\n\n<p>This template has separate test and actual code</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># my_script.rb\n# description of a problem\nrequire 'pp'\nrequire './ppp'\nrequire 'byebug'\n\ndef solution(aa:, l:, h:)\nend\n\n# when we run: ruby my_script.rb data/example.in\n# output is saved in data/example.out\nif ARGV.length == 1\n  file_name = ARGV.last.split('.').first\n  r, _c, l, h = gets.split(' ').map(&amp;:to_i)\n  aa = []\n  r.times do\n    # strip is needed since on hackerrank, new line is at the end of gets\n    aa &lt;&lt; gets.strip.split('').map { |c| c == 'M' ? 1 : 0 }\n  end\n  results = solution(aa: aa, l: l, h: h)\n  File.open \"#{file_name}.out\", 'w' do |file|\n    # puts results.length\n    file.puts results.length\n    results.each do |row|\n      # puts row.join(' ')\n      file.puts row.join(' ')\n    end\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test_my_script.rb\nrequire 'minitest/autorun'\nrequire './pizza'\nclass Test &lt; Minitest::Test\n  def test_solution\n    a =\n    [\n      1,\n    ]\n    res = 1\n    assert_equal res, solution(a)\n  end\nend\n</code></pre></div></div>\n\n<p>If you want to run only one test, than run <code class=\"highlighter-rouge\">ruby 0_short_palindrome.rb --name\ntest_sample</code></p>\n\n<p>If you want to print all local variables, you can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>local_variables.map { |vn| { vn =&gt; eval(vn.to_s) } }\n</code></pre></div></div>\n\n<p>Run with colors <code class=\"highlighter-rouge\">ruby my_class_test.rb -p</code>, or <code class=\"highlighter-rouge\">ruby -r\nminitest/pride my_class_test.rb</code> or put <code class=\"highlighter-rouge\">require 'pride'</code> in test file.</p>\n\n<p>For minitests you can use <code class=\"highlighter-rouge\">describe</code> and <code class=\"highlighter-rouge\">it</code> blocks.</p>\n\n<p>TIPS:</p>\n\n<ul>\n  <li>if you need to perform big number of tests, and you can not calculate solution\nbut you need to iterate something, than use table of solutions. First call\n<code class=\"highlighter-rouge\">create_table</code> of results and query that <code class=\"highlighter-rouge\">@table[n]</code> (if you can, fill just\nwhat it needs)</li>\n  <li>two dimensional 2d array <code class=\"highlighter-rouge\">@table = Array.new(n) { Array.new(n) }</code></li>\n  <li>if stack level too deep then try to use <code class=\"highlighter-rouge\">@table</code> class variables instead of\npassing them as arguments (not much help since arguments are passed by\nreference, but there are less number of arguments\n<a href=\"http://stackoverflow.com/questions/28703587/systemstackerror-when-pushing-more-than-130798-objects-into-an-array\">link</a>)</li>\n</ul>\n\n<h1 id=\"complexity\">Complexity</h1>\n\n<p>Ruby <code class=\"highlighter-rouge\">Array#find</code> method has O(n) complexity. If array is big, you should use\n<a href=\"http://ruby-doc.org/core-2.1.5/Array.html#method-i-bsearch\">bsearch</a> O(log(n)).\nArray needs to be sorted. Binary search works in two modes:</p>\n<ul>\n  <li>find minimum: block must return true or false and there must be an index <code class=\"highlighter-rouge\">i</code>\nso that: block returns false elements whose index is less than <code class=\"highlighter-rouge\">i</code>, block\nreturns true for any element whose index is greater than or equal to <code class=\"highlighter-rouge\">i</code>.\nThis method returns <code class=\"highlighter-rouge\">i</code>-th element.</li>\n  <li>find any: block returns number and there are must be two indices <code class=\"highlighter-rouge\">i</code> and <code class=\"highlighter-rouge\">j</code>\n(<code class=\"highlighter-rouge\">0&lt;=i&lt;=j&lt;=ary.size</code>) so that: block returns positive number for <code class=\"highlighter-rouge\">0&lt;=k&lt;i</code>,\nreturns zero for <code class=\"highlighter-rouge\">i&lt;=k&lt;j</code> and negative for <code class=\"highlighter-rouge\">j&lt;=k&lt;ary.size</code>.\nThis method returns any element whose index is within <code class=\"highlighter-rouge\">i..j</code>.</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = [1, 4, 7, 10]\n# find minimum that satisfy block\na.bsearch { |x| x &gt;= 6 } #=&gt; 7\n\n# find any\nary = [0, 4, 7, 10, 12]\n# try to find v such that 4 &lt;= v &lt; 8\nary.bsearch {|x| 1 - x / 4 } #=&gt; 4 or 7\n# try to find v such that 8 &lt;= v &lt; 10\nary.bsearch {|x| 4 - x / 2 } #=&gt; nil\n</code></pre></div></div>\n\n<p>Array <code class=\"highlighter-rouge\">a.include?</code> is O(n) but hash <code class=\"highlighter-rouge\">a.key?</code> (or <code class=\"highlighter-rouge\">a.include?</code>) is O(1). So\ninstead of big time, you can use big space by using Hashtables.</p>\n\n<h1 id=\"counting-of-elements\">Counting of elements</h1>\n\n<p><a href=\"https://codility.com/media/train/2-CountingElements.pdf\">tutorial</a>\nif we need to check if some elements exists, we can create counting array in\nO(N) time and query in constant time</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = [0, 3, 1, 3]\ncounting = [0]*(a.max+1)\na.each { |e| counting[e]+=1 }\ncounting # =&gt;  [1, 1, 0, 2]\ncounting[2] == 0 # true in constant time\n</code></pre></div></div>\n\n<h1 id=\"prefix-sums\">Prefix sums</h1>\n\n<p><a href=\"https://codility.com/media/train/3-PrefixSums.pdf\">tutorial</a> In O(N) time we\ncan calculate p_1, …p_n, where p_k= a_0+a_1+…+a_(k-1). Note that p_k does\nnot use a_k, and p_0 == 0 Than we can calculate sum of any slice (x,y) in\nconstant time instead of O(y-x) (that is usually needed for query several\nresults).  Slice could be defined on 1..n (index starts from 1 and include\nbounds), slice(x,y) = prefix_sum[y] - prefix_sum[x-1] for example</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>slice(a_0,a_0) = slice(1,1) = prefix_sum[1]-prefix_sum[0]\nslice(a_1,a_3) = slice(2,4) = prefix_sum[4]-prefix_sum[1]\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = [1, 4, 0, 4, 2]\nprefix_sum = [0] * (a.length+1)\na.each_with_index do |e,i|\n  prefix_sum[i+1] = prefix_sum[i] + e\nend\n# slice a_1 + a_2 + a_3\nprefix_sum[3+1]-prefix_sum[1] # =&gt; 8\n</code></pre></div></div>\n\n<h1 id=\"counting-sort-onm\">Counting sort O(n+m)</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a=[4,2,0,2,3]\nc=[0] * (a.max+1)\na.each_with_index do |e,i|\n  c[e] += 1\nend\ns=[]\ni=0\nc.each_with_index do |n,v| # =&gt; [1, 0, 2, 1, 1]\n  n.times do\n    s[i] = v\n    i+=1\n  end\nend\ns # =&gt; [0, 2, 2, 3, 4]\n</code></pre></div></div>\n\n<h1 id=\"merge-sort-onlogn\">Merge sort O(n*log(n))</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a=[4,2,0,2,3]\n\ndef sort(a)\n\n  if a.length == 1\n    return a # =&gt; [4], [2], [0], [2], [3]\n  else\n    middle = a.length/2\n    a[0..middle-1] # =&gt; [4, 2], [4], [0], [2]\n    a[middle..-1] # =&gt; [0, 2, 3], [2], [2, 3], [3]\n    left = sort(a[0..middle-1]) # =&gt; [4], [2, 4], [0], [2]\n    right = sort(a[middle..-1]) # =&gt; [2], [3], [2, 3], [0, 2, 3]\n    i = 0\n    j = 0\n    r = []\n    while ! left[i].nil? || ! right[j].nil?\n      if ! left[i].nil? &amp;&amp; (right[j].nil? || left[i] &lt;= right[j])\n        r &lt;&lt; left[i] # =&gt; [2, 4], [2], [0], [0, 2], [0, 2, 2, 3, 4]\n        i += 1\n      else\n        r &lt;&lt; right[j] # =&gt; [2], [2, 3], [0, 2], [0, 2, 3], [0], [0, 2, 2], [0, 2, 2, 3]\n        j += 1\n      end\n    end\n    return r # =&gt; [2, 4], [2, 3], [0, 2, 3], [0, 2, 2, 3, 4]\n  end\nend\nsort(a) # =&gt; [0, 2, 2, 3, 4]\n</code></pre></div></div>\n\n<ul>\n  <li>leader (value on more than half elements) is the same when we remove pair of\ndifferent items</li>\n  <li>\n    <p>maximum slice is a slice (a_p..a_q) with max sum, can be computed in O(n^2)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># max_slice O(n^2)\na=[5,-7,3,5,-2,4,-1]\nres = 0\na.each_with_index do |p,i|\n  sum = 0\n  a[i..-1].each do |q|\n    sum += q\n    res = [res,sum].max\n  end\nend\nres # =&gt; 10\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>positive ending sum slice is wrapped with negative elements (or bounds\nfirst/last) because we can always choose empty slice (sum is 0) we can deduce\nthat positive_ending_sum = max(0, positive_ending_sum_prev + a)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># max_slice O(n)\na=[5,-7,3,5,-2,4,-1]\n\nres = 0\npositive_ending_sum = 0\na.each do |p| # =&gt; [5, -7, 3, 5, -2, 4, -1]\n  positive_ending_sum = [0, positive_ending_sum+ p].max # =&gt; 5, 0, 3, 8, 6, 10, 9\n  res = [res,positive_ending_sum].max # =&gt; 5, 5, 5, 8, 8, 10, 10\nend\nres # =&gt; 10\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"prime-numbers\">Prime Numbers</h1>\n\n<ul>\n  <li>count number of divisors of N is O(sqrt(N)) since every divisor a has symetric\ndivisor b, <code class=\"highlighter-rouge\">n = a * b</code></li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>n = 30\ni = 1\nresult = 0\nwhile i * i &lt; n\n  result += 2 if n % i == 0\n  i += 1\nend\nresult += 1 if i * i == n\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>finding all primes less than N is in O(N<em>log(log(N))) Sieve of Eratosthenes.\nFind first prime (until sqrt(N) since we do not need to mark greater than N) and\nmark all multiplies of prime, starting from prime</em>prime (since i<em>prime will be\nmarked with prime divisor of i) untill N, that is n/2 + n/3+ n/5 … =\nn</em>log(log(n)\nRembember that largest prime factor of N can not be greated than Math.sqrt(N).\n0, 1 are not prime numbers.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>m = 10\ndefinitely_non_prime = Array.new m + 1, false\ndefinitely_non_prime[0] = definitely_non_prime[1] = true\n2.upto(Math.sqrt(m)) do |i|\n  next if definitely_non_prime[i]\n  prime = i\n  non_prime = prime * prime\n  while non_prime &lt;= m\n    definitely_non_prime[non_prime] = true\n    non_prime += prime\n  end\nend\ndefinitely_non_prime.each_with_index { |e,i| puts i if e == false }\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>factorization is to find prime numbers and its order. We can create fixed F\nwhere F[i] is smallest prime that divides i, ie F[12] = 2, F[6] = 2, F[2] = 0.\nIf we already have that F, than we can factorize in O(log(n)) time</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>n = 12\nf = [0]*(n+1)\ni=2\nwhile i*i &lt;= n\n  if f[i] == 0\n    prime = i\n    temp = prime * prime\n    while temp &lt;= n\n      f[temp] = prime if f[temp] == 0\n      temp += prime\n    end\n  end\n  i += 1\nend\nf # =&gt; [0, 0, 0, 0, 2, 0, 2, 0, 2, 3, 2, 0, 2]\n\ndef factorization(n, f)\n  res = []\n  while f[n] &gt; 0\n    res &lt;&lt; f[n] # =&gt; [2], [2, 2]\n    n /= f[n] # =&gt; 6, 3\n  end\n  res &lt;&lt; n # =&gt; [2, 2, 3]\nend\n\nfactorization(n,f) # =&gt; [2, 2, 3]\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>we can find all divisors, for example 12 has [1,2,3,4,6,12] divisor list, with\nsimply iterate to all numbers and add number (for example 2) to set for\nproduct (divisors[4].add(2), divisors[6].add(2) …).  Better perfomance is\nwhen we stop at <code class=\"highlighter-rouge\">number * number &lt;= n</code> and we add\n<code class=\"highlighter-rouge\">divisors[product].add(product/number)</code> (note that we still iterate to n in\ninner loop).</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>n = 12\ndivisors = [] * (n+1)\n[*1..n].each do |i| # =&gt; [1, 2, 3, 4, 5, 6]\n  divisors[i] = Set.new([1,i]) # =&gt; #&lt;Set: {1}&gt;, #&lt;Set: {1, 2}&gt;, #&lt;Set: {1, 3}&gt;, #&lt;Set: {1, 4}&gt;, #&lt;Set: {1, 5}&gt;, #&lt;Set: {1, 6}&gt;\nend\nnumber = 2\nwhile number &lt;= n  # number * number &lt;= n\n  product = number # =&gt; 2, 3, 4, 5, 6\n  while product &lt;= n\n    if ! divisors[product].include? number\n      divisors[product].add number # =&gt; #&lt;Set: {1, 4, 2}&gt;, #&lt;Set: {1, 6, 2}&gt;, #&lt;Set: {1, 6, 2, 3}&gt;\n      # divisors[product].add(product/number)\n    end\n    product += number\n  end\n  number += 1\nend\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"euclidean-algorithm\">Euclidean algorithm</h1>\n\n<p>Theory:</p>\n\n<p>Def: integer m divides n (m|n) if exists r such that m*r = n\nDef: gcm(m, n) is the largest positive integer d which divides both m and n.\nThat means d|m, d|n and for any c which c|m and c|n we have d&gt;=c</p>\n\n<p>The: for a, b nonzero integer, their gcd(a,b) is linear combination of a and b\nie: exists s and t such that s<em>a+t</em>b=gcd(a,b)\nProof: let d be least positive linear combination d = s<em>a+t</em>b . We can show that\nd|a.\nWe can write <code class=\"highlighter-rouge\">a = d*q+r (0 &lt;= r &lt; d )</code> so `r = a - d<em>q = a - (s</em>a + t<em>b)</em>q = (1</p>\n<ul>\n  <li>q<em>s)</em>a + (-qt)<em>b<code class=\"highlighter-rouge\">. Since d is least positive and </code>r&lt;d<code class=\"highlighter-rouge\"> that means </code>r = 0`.\nSimilarly d|b. We can show it is the greatest common divisor because if\nd1=gcd(a,b) &lt; d it will be that d1|a d1|b and from d=s</em>a+t*b that d1|d which is\ncontradiction so d1==d</li>\n</ul>\n\n<p>gcd(k, 1) = 1\nif a|b*c and gcd(a,b)==1 than a|c</p>\n\n<p>Lem: if a = b<em>q + r than gcd(a,b) == gcd(b,r)\nProof: gcd(a,b)=gcd(b</em>q+r,b)=gcd(r,b)\nGCD will not change if you can add multiple of b, ie gcd(a,b)=gcd(a+k*b,b)</p>\n\n<p>Def: The integers a and b are relatively prime if and only if there exist\nintegers α and β such that aα + bβ = 1</p>\n\n<table>\n  <tbody>\n    <tr>\n      <td>Def: Lcm(a,b) least common multiple is =</td>\n      <td>a*b</td>\n      <td>/gcd(a,b)</td>\n    </tr>\n  </tbody>\n</table>\n\n<table>\n  <tbody>\n    <tr>\n      <td>The: a<em>x+b</em>y=d has integer solution iff gcd(a,b)</td>\n      <td>d</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>If (x0,y0) is solution, we can add +- a<em>b/d  ie a</em>x+b<em>y + a</em>b/d - b<em>a/d =\na</em>(x+b/d) +b(y-a/d)  so (x+ b/d, y-a/d) is solution.\nGeneral solutions are { (x0+k<em>b/d, y0-k</em>a/d) for k in Z}</p>\n\n<ul>\n  <li>\n    <p>Found gcd(a,b) with Euclidean algorithm by subtraction in O(a+b) steps, or by\ndivision in O(log(a+b))</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def gcd(a,b)\n  if a % b == 0\n    return b\n  else\n    gcd(b, a % b)\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>lcm(a,b) = a*b/gcd(a,b)  and lcm(a,b,c) = lcm(a, lcm(b,c))</p>\n  </li>\n  <li>Fibonacci numbers F[n] = F[n-1] + F[n-2] and F[0] = 0 and F[1] = 1 and can be\ngenerated in O(N)</li>\n  <li>\n    <p>faster could be with matrix calculation</p>\n  </li>\n  <li>\n    <p>binary search for sorted array could be in O(log(N)) time. We found middle\nelement and test condition.  Array should be sorted (ascending) so we can test\n(mid&lt;=target) and pick next item. Result is last middle when condition was\ntrue (max element &lt;= target). If it is true go with (bigger) elements,\nothervise go with lower elements. We do not stop when we found solution since\nusual we have optimization problem (min or max). When we pass solution and set\nfirst = middle +1 (could be equal last) next iteration will be false (or last\n= new_middle -1 until last &lt; first).  If we search for min, then if condition\nis true we took lower elements (last = mid - 1). That is easy to replace in\ncheck function but result should be taken from that as well. So general check\nfunction store result if test is true with max, or test is false with min.\nAnother nice non general solution is to return last for max, or first for min.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a=[1,2,3,4,5] #[12,15,15,19,24,31,53,59,60,61]\ntarget = 3 # 13 \ndef check(a, middle, target, result)\n  if a[middle] &lt;= target\n    result.value = middle\n    true\n  else\n    false\n  end\nend\n#a = [0,1,1,0,1,1,0,1,1]\n#target = 3 # k boards 3 boards\n#def check(a, middle, target, result)\n#  last_board = -1\n#  boards = 0\n#  middle # =&gt; 4, 1, 2\n#  for i in 1..a.length\n#    if a[i] == 1 &amp;&amp; last_board &lt; i\n#      boards += 1 # =&gt; 1, 2, 1, 2, 3, 4, 5, 6, 1, 2, 3\n#      last_board = i + middle - 1 # =&gt; 4, 8, 1, 2, 4, 5, 7, 8, 2, 5, 8\n#    end\n#  end\n#  boards # =&gt; 2, 6, 3\n#  if boards &lt;= target # =&gt; true, false, true\n#    # since we search to min, we invert return value\n#    result.value = middle\n#    false\n#  else\n#    true\n#  end\n#end\nclass Result\n  attr_accessor :value\nend\ndef binary_search(a, target)\n  first = 0\n  last = a.length - 1\n  result = Result.new\n  result.value = -1\n  while first &lt;= last\n    first     # =&gt; 0, 3\n    last    # =&gt; 4, 4\n    middle = (first+last)/2 # =&gt; 2, 3\n    if check(a, middle, target, result) # =&gt; true, false\n      first = middle + 1 # =&gt; 3\n    else\n      last = middle - 1 # =&gt; 2\n    end\n  end\n  return result.value\nend\nbinary_search(a, target) # =&gt; 2\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>caterpillar method. found subseqence which total sum equals s</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = [6,2,7,4,1,3,6]\ntarget_sum = 12\n\nback = 0\nfront = 0\nsum = 0\na.each_with_index do |e, back|\n  while front &lt; a.length &amp;&amp; sum + a[front] &lt;= target_suM\n    sum += a[front]\n    front += 1\n  end\n  if sum == target_sum\n    puts \"je\"\n  end\n  sum -= e\nend\n</code></pre></div>    </div>\n  </li>\n  <li>greedy algorithm is simplest possible algorithm</li>\n  <li>\n    <p>dinamic programming</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def dynamic_coin_changing(c, k)\n  n = c.length\n  dp = [0] + [1/0.0]* k # =&gt; [0, Infinity, Infinity, Infinity, Infinity, Infinity, Infinity]\n  for i in 1..n # =&gt; 1..3\n    for j in c[i-1] .. k # =&gt; 1..6, 3..6, 4..6\n       # =&gt; 1..6, 3..6, 4..6\n      dp[j-c[i-1]]+1 # =&gt; 1, 2, 3, 4, 5, 6, 1, 2, 3, 2, 1, 2, 3\ndp[j] # =&gt; Infinity, Infinity, Infinity, Infinity, Infinity, Infinity, 3, 4, 5, 6, 2, 3, 2\n      dp[j] = [dp[j-c[i-1]]+1, dp[j]].min # =&gt; 1, 2, 3, 4, 5, 6, 1, 2, 3, 2, 1, 2, 2\n    end\n    dp # =&gt; [0, 1, 2, 3, 4, 5, 6], [0, 1, 2, 1, 2, 3, 2], [0, 1, 2, 1, 1, 2, 2]\n  end\n  dp\nend\ndynamic_coin_changing([1,3,4],6) # =&gt; [0, 1, 2, 1, 1, 2, 2]\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"geometry\">Geometry</h1>\n\n<ul>\n  <li>Find line that is perpendicular to line <code class=\"highlighter-rouge\">y = 2*x + 11</code> and contains <code class=\"highlighter-rouge\">(6, -7)</code>\n<a href=\"https://www.khanacademy.org/math/geometry/hs-geo-analytic-geometry/hs-geo-parallel-perpendicular-eq/e/line_relationships\">video</a>\nPerpendicular means slope is negative inverse ie <code class=\"highlighter-rouge\">-1/2</code>. Note that in ruby you\nneed to use <code class=\"highlighter-rouge\">x = x.to_f</code> since <code class=\"highlighter-rouge\">1/2==0</code> for integer division</li>\n  <li>maximum area for fixed length sides (edges) polygon has edges on circle\n(descripted circuit) and orders does not matter\n<a href=\"http://www.drking.org.uk/hexagons/misc/polymax.html\">link</a></li>\n  <li>triangle area <code class=\"highlighter-rouge\">s = (a+b+c)/2; P = Math.sqrt(s*(s-a)*(s-b)*(s-c));</code></li>\n</ul>\n\n<h1 id=\"math\">Math</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">radius = Math.sqrt((l1/2)**2 + (l2/2)**2)</code></li>\n</ul>\n\n<h1 id=\"tutorial\">Tutorial</h1>\n\n<ul>\n  <li><a href=\"https://www.toptal.com/algorithms/interview-questions\">https://www.toptal.com/algorithms/interview-questions</a></li>\n</ul>\n\n<h1 id=\"constrains\">Constrains</h1>\n\n<ul>\n  <li>memory: usually if you need to loop more than 10**6 (1MB) that could be a\nproblem</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Cap3 Capistrano Deployment Rubber Provision",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/09/07/cap3-capistrano-deployment-rubber-provision/",
      "date"     : "2016-09-07 00:00:00 +0200",
      "content"  : "<h1 id=\"install\">Install</h1>\n\n<p>Capistrano is not server provisioning tool. You need to manually boot up server\nand install ssh, apache, git… usually all tasks that requires sudo should be\ndone manually. Capistrano use single non priviliged user in non interactive ssh\nsession. Rubber has script for provisioning a server <code class=\"highlighter-rouge\">cap rubber:create</code> and\ninstalling packages <code class=\"highlighter-rouge\">cap rubber:bootstrap</code></p>\n\n<p>Capistrano version 3 is used here. Below is section for capistrano version 2.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# Use Capistrano for deployment\ngroup :development do\n  gem 'capistrano-puma', require: false\n  gem 'capistrano-rails', require: false # this will load capistrano-bundler\n  gem 'capistrano-rvm', require: false\nend\nHERE_DOC\nbundle update capistrano # use latest version 3.8\nbundle exec cap install\n# this will generate  Capifile, config/deploy.rb and config/deploy/staging.rb...\ncat &gt; Capfile &lt;&lt; HERE_DOC\n# Load DSL and set up stages\nrequire \"capistrano/setup\"\nrequire \"capistrano/console\"\n\n# Include default deployment tasks\nrequire \"capistrano/deploy\"\n\n# Include tasks from other gems included in your Gemfile\nrequire 'capistrano/rails'\nrequire \"capistrano/bundler\"\nrequire \"capistrano/rvm\"\nrequire \"capistrano/puma\"\n\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob(\"lib/capistrano/tasks/*.rake\").each { |r| import r }\nHERE_DOC\n</code></pre></div></div>\n\n<h1 id=\"configuration-variables\">Configuration variables</h1>\n\n<p><a href=\"http://capistranorb.com/documentation/getting-started/configuration/\">configuration</a>\nfiles can set variables <code class=\"highlighter-rouge\">set :my_var_name, \"value\"</code> and fetch values <code class=\"highlighter-rouge\">fetch\n:my_var_name</code>. There are some variables that are used by default:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">:application</code> name of application</li>\n  <li><code class=\"highlighter-rouge\">:deploy_to</code> path on the remote server where the app should be deployed,\ninitially is <code class=\"highlighter-rouge\">-&gt; { \"/var/www/#{fetch(:application)}\" }</code> but I like home folder.\nInside that folder there are:\n    <ul>\n      <li><code class=\"highlighter-rouge\">current</code> symlink to some release <code class=\"highlighter-rouge\">/var/www/my_app/releases/20170101010101</code></li>\n      <li><code class=\"highlighter-rouge\">releases/</code> contains timestamped subfolder</li>\n      <li><code class=\"highlighter-rouge\">repo/</code> hold git repository</li>\n      <li><code class=\"highlighter-rouge\">revisions.log</code> timestaped log for all deploy or rollback actions</li>\n      <li><code class=\"highlighter-rouge\">shared/</code> contains <code class=\"highlighter-rouge\">linked_files</code> and <code class=\"highlighter-rouge\">linked_dirs</code> that persists across\nreleases (db configuration, user storage)</li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">:scm</code> by default is <code class=\"highlighter-rouge\">:git</code></li>\n  <li><code class=\"highlighter-rouge\">:repo_url</code> is url for git. It should be accessible from remote server. For\nlocal <code class=\"highlighter-rouge\">set :repo_url, 'ssh://orlovic@192.168.2.4/my_project</code></li>\n  <li><code class=\"highlighter-rouge\">:linked_files</code> is symlinked files from shared folder</li>\n  <li><code class=\"highlighter-rouge\">:default_env</code> for specific env variables</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/deploy.rb\nlock \"3.8.0\"\n\nset :application, \"myapp\"\nset :repo_url, \"orlovic@192.168.2.4:rails/temp/myapp\"\nset :deploy_to, \"/home/deploy/#{fetch(:application)}\"\n\n# rails\nset :rails_env, 'production'\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/deploy/staging.rb\n# if you use NAT network\nserver \"127.0.0.1\", user: \"deploy\", roles: %w{app db web}, port: 2222\n# or if you use private network\nserver \"192.168.3.2\", user: \"deploy\", roles: %w{app db web}\n</code></pre></div></div>\n\n<h1 id=\"preparing-the-app\">Preparing the app</h1>\n\n<p><a href=\"http://capistranorb.com/documentation/getting-started/preparing-your-application/\">preparing</a>\nis with <code class=\"highlighter-rouge\">cap install</code>.</p>\n\n<p>Tasks are usually only for specific roles so you server needs to belongs to that\nrole if you want task to be executed. Three main roles</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">:web</code> role is nginx/apache server</li>\n  <li><code class=\"highlighter-rouge\">:app</code> role is for rails app</li>\n  <li><code class=\"highlighter-rouge\">:db</code> role is for mysql/postgresql database (requires <code class=\"highlighter-rouge\">primary: true</code>)</li>\n</ul>\n\n<p>You can define in two ways. Properties will be merged.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># using simple syntax\nrole :web, %w{hello@world.com example.com:1234}\n\n# using extended syntax (which is equivalent)\nserver 'world.com', roles: [:web], user: 'hello'\nserver 'example.com', roles: [:web], port: 1234\n</code></pre></div></div>\n\n<p>For local vagrant (see below) you can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/deploy.rb\nset :repo_url, \"orlovic@192.168.2.4:rails/temp/myapp\"\n\n# config/deploy/staging.rb\nserver \"127.0.0.1\", user: \"vagrant\", roles: %w{app db web}, port: 2222\n</code></pre></div></div>\n\n<p>If you are using private github repo, than permission problems for git will\noccurs, so you can use your local keys on server with those option:\n<code class=\"highlighter-rouge\">set :ssh_options, forward_agent: true</code></p>\n\n<p>You can check before deploying with <code class=\"highlighter-rouge\">cap staging git:check</code> or <code class=\"highlighter-rouge\">cap staging\ndeploy:check</code></p>\n\n<h1 id=\"tasks\">Tasks</h1>\n\n<p>Nice <a href=\"https://www.youtube.com/watch?v=UQj_01dnEiw\">railscasts video</a> but for old\ncapistrano.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># lib/capistrano/tasks/notify.rake\nnamespace :my_tasks do\n  desc \"My first task\"\n  task :my_first_task do\n    on roles(:all) do\n      puts \"Start my first task\"\n    end\n    invoke 'my_tasks:notify'\n  end\n\n  task :notify do\n    on roles(:all) do |host|\n      puts \"notify #{host}\"\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>To run in specific env, run with: <code class=\"highlighter-rouge\">cap staging my_tasks:my_first_task</code></p>\n\n<h2 id=\"task-syntax\">Task Syntax</h2>\n\n<p><code class=\"highlighter-rouge\">desc</code> and <code class=\"highlighter-rouge\">task</code> are rake methods. Others are taken from\n<a href=\"https://github.com/capistrano/sshkit/blob/master/EXAMPLES.md\">sshkit</a>:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">on roles(:all) do |host|</code> will iterate to eah server host, You can run\nlocally with <code class=\"highlighter-rouge\">run_locally do</code>. <code class=\"highlighter-rouge\">roles(:all)</code> return list of all hosts</li>\n  <li><code class=\"highlighter-rouge\">as</code></li>\n  <li><code class=\"highlighter-rouge\">capture</code></li>\n  <li><code class=\"highlighter-rouge\">test</code></li>\n  <li><code class=\"highlighter-rouge\">info</code></li>\n  <li><code class=\"highlighter-rouge\">error</code></li>\n  <li><code class=\"highlighter-rouge\">with</code> set ENV variable. only</li>\n  <li><code class=\"highlighter-rouge\">within</code> use folder. should be inside <code class=\"highlighter-rouge\">on</code></li>\n  <li><code class=\"highlighter-rouge\">invoke</code> run other rake task</li>\n  <li><code class=\"highlighter-rouge\">execute</code> used to run command: <code class=\"highlighter-rouge\">execute :rake, 'assets:precompile', env: {\nrails_env: fetch(:rails_env) }</code></li>\n</ul>\n\n<p>You can execute task in before or after hooks.\n<a href=\"http://capistranorb.com/documentation/getting-started/flow/\">flow</a> has several\npoints that you can access.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>before :finishing, :notify do\nend\n</code></pre></div></div>\n\n<p>You can use <code class=\"highlighter-rouge\">puts</code> and <code class=\"highlighter-rouge\">run</code> to run command in shell. If you use sudo, than you\nshould enable <code class=\"highlighter-rouge\">default_run_options[:pty] = true</code> so when he ask for password it\nprompts in current shell. Also helpfull is <code class=\"highlighter-rouge\">ssh_options[:forward_agent] = true</code>\nwhich uses your keys on remote server to download private repositories.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>task :hello do\n  puts \"Here are all files\"\n  run \"ls\"\n  run \"#{sudo} ls /etc\"\nend\n</code></pre></div></div>\n\n<h1 id=\"upgrading-capistrano-2-to-3\">Upgrading capistrano 2 to 3</h1>\n\n<p><a href=\"http://capistranorb.com/documentation/upgrading/\">documentation</a>\nhere are differences between cap 2 and cap 3</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">repository</code> is renamed to <code class=\"highlighter-rouge\">repo_url</code></li>\n  <li>environment is set instead <code class=\"highlighter-rouge\">RAILS_ENV=vagrant cap -T</code> to second param <code class=\"highlighter-rouge\">cap\nvagrant -T</code></li>\n  <li>instead of positional argument for role <code class=\"highlighter-rouge\">server \"123.123.123.123\", :web</code> use\nhash <code class=\"highlighter-rouge\">roles</code> argument <code class=\"highlighter-rouge\">server \"123.123.123.123\", roles: [:web]</code></li>\n</ul>\n\n<h1 id=\"sample-app-on-ec2\">Sample app on EC2</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails new myapp\ncd myapp\ngit init . &amp;&amp; git add . &amp;&amp; git commit -m \"rails new myapp\"\nsed -i Gemfile -e '/capistrano/c \\\ngem \"capistrano-rails\", group: :development'\n# capistrano-rails will also install capistrano, capistrano-bundler\n# rvm puma ?\ncap install STAGES=virtual\necho \"require 'capistrano/rails'\" &gt;&gt; Capfile\n</code></pre></div></div>\n\n<p>On AWS create new instance and download new key for example <code class=\"highlighter-rouge\">aws_test.pem</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>chmod 400 aws_test.pem\nssh -i \"aws_test.pem\" ubuntu@ec2-34-204-86-131.compute-1.amazonaws.com\n</code></pre></div></div>\n\n<h1 id=\"capistrano-with-custom-vagrant-script\">Capistrano with custom Vagrant script</h1>\n\n<p>You can install server localy using <a href=\"/2015/02/16/rails-through-vagrant-to-digitalocean/\">Vagrant scripts</a>.\nYou can use default NAT address (access virtual box at ssh port 2222) and port\nforwarding (<code class=\"highlighter-rouge\">config.vm.network :forwarded_port, guest: 80, host: 8080</code>). In\norder to access host machine from virtual box you need to know host IP address.\nSo my solution is to use Private IP (<code class=\"highlighter-rouge\">private_network</code>) and host is easilly\ndetermined from that.\nYou need to add public key on host after provision is done so virtual can access\nhost without password (maybe to try with\n<a href=\"https://github.com/emyl/vagrant-triggers\">vagrant-triggers</a>), so two commands\nare needed</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ssh-keygen -f \"/home/orlovic/.ssh/known_hosts\" -R 192.168.3.2\nssh deploy@192.168.3.2 cat .ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys\n</code></pre></div></div>\n\n<p>Here are scripts</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>vagrant init\n# edit Vagrantfile\ncat &gt;&gt; Vagrantfile &lt;&lt; HERE_DOC\nVagrant.configure(\"2\") do |config|\n  config.vm.provider \"virtualbox\" do |vb, vb_config|\n    # list of all machines can be found https://atlas.hashicorp.com/boxes/search\n    vb_config.vm.box = \"ubuntu/trusty64\"\n    vb.memory = \"2048\"\n    vb_config.vm.provision :shell, inline: $script, keep_color: true\n    vb_config.vm.network :private_network, ip: $server_ip\n  end\nend\n\n# $ruby_version = `grep \"^ruby\" Gemfile | awk \"{print $2}\"`\n$ruby_version = `ruby --version | awk \"{print $2}\"`.split(\"p\").first # 2.3.1p112\n$public_key = `cat ~/.ssh/id_rsa.pub`.strip\n$server_ip = \"192.168.3.2\"\n\n$nginx_config = &lt;&lt;-NGINX_CONFIG\n# https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma\nupstream app {\n    # Path to Unicorn SOCK file, as defined previously\n    server unix:/home/deploy/myapp/shared/tmp/sockets/puma.sock;\n}\n\nserver {\n    listen 80 default_server deferred;\n    server_name myapp.local;\n    root /home/deploy/myapp/current/public;\n    access_log /home/deploy/myapp/current/log/nginx.access.log;\n    error_log /home/deploy/myapp/current/log/nginx.error.log;\n\n\n    location ^~ /assets/ {\n      gzip_static on;\n      expires max;\n      add_header Cache-Control public;\n    }\n\n    try_files $uri/index.html $uri @app;\n    location @app {\n        proxy_pass http://app;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect off;\n        access_log /home/deploy/myapp/current/log/nginx.rails.access.log;\n    }\n\n    error_page 500 502 503 504 /500.html;\n    client_max_body_size 10M;\n    keepalive_timeout 10;\n\n    if ($request_method !~ ^(GET|HEAD|PUT|PATCH|POST|DELETE|OPTIONS)$ ){\n      return 405;\n    }\n\n    if (-f $document_root/system/maintenance.html) {\n      return 503;\n    }\n}\nNGINX_CONFIG\n\n$script = &lt;&lt;-SCRIPT\nset -e # Any commands which fail will cause the shell script to exit immediately\nset -x # show command being executed\nL=en_US.UTF-8\nupdate-locale LANG=$L LANGUAGE=$L LC_ALL=$L # needed for database default enc\n# or install missing locale with, for example sr_RS\n# locale-gen sr_RS\n\necho \"STEP: update\"\n# apt-get -y update &gt; /dev/null # update is needed to set proper apt sources\nif [ \"`id -u deploy`\" = \"\" ]; then\n  echo \"STEP: creating user deploy (without sudo access)\"\n  useradd deploy -md /home/deploy --shell /bin/bash\n  echo deploy:deploy | chpasswd # change password to 'deploy'\n  echo STEP: generate keys and adding host public key to vb authorized keys\n  sudo -i -u deploy /bin/bash -c \"yes '' | ssh-keygen -N ''\"\n  sudo -i -u deploy /bin/bash -c \"echo #{$public_key} &gt;&gt; ~/.ssh/authorized_keys\"\n  # TODO: cap staging git:check will add to known hosts\n  sudo -i -u deploy /bin/bash -c \"ssh-keyscan #{$server_ip[0..-2]+\"1\"} &gt;&gt; ~/.ssh/known_hosts\"\n\n  # gpasswd -a deploy sudo # add to sudo group\n  # echo \"deploy ALL=(ALL) NOPASSWD:ALL\" &gt; /etc/sudoers.d/deploy # don't ask for password when using sudo\n  # if [ ! \"`id -u vagrant`\" = \"\" ]; then\n  #   usermod -a -G vagrant deploy # adding to vagrant group if vagrant exists\n  # fi\nelse\n  echo \"STEP: user deploy already exists\"\nfi\n\nif [ \"`which git`\" = \"\" ]; then\n  echo \"STEP: install development tools: git nodejs ...\"\n  apt-get -y install build-essential curl git nodejs multitail\nelse\n  echo \"STEP: development tools already installed\"\nfi\n\nif [ \"`which nginx`\" = \"\" ]; then\n  echo \"STEP: install ngix server\"\n  apt-get -y install nginx\n  cat &lt;&lt; 'NGINX_CONFIG' | sudo tee /etc/nginx/sites-available/default\n  #{$nginx_config}\nNGINX_CONFIG\n  # TODO: it seems we need to restart nginx later, probable at this moment puma\n  # sockets do not exists yet\n  sudo service nginx restart\nelse\n  echo \"STEP: nginx already installer\"\nfi\n\nexport DATABASE_URL=postgresql://deploy:deploy@localhost/myapp_production\nDATABASE_NAME=${DATABASE_URL##*/}\nif [ `echo $DATABASE_URL | cut -f 1 -d ':'` = \"postgresql\" ]; then\n  if [ \"`which psql`\" = \"\" ]; then\n    echo \"STEP: installing postgres\"\n    apt-get -y install postgresql postgresql-contrib libpq-dev\n  else\n    echo STEP: postgres already installed\n  fi\n  if [ \"`sudo -u postgres psql postgres -tAc \"SELECT 1 FROM pg_roles WHERE rolname='deploy'\"`\" = \"1\" ]; then\n    echo STEP: postgres user 'deploy' already exists\n  else\n    echo STEP: create postgresql database user deploy\n    sudo -u postgres createuser --superuser --createdb deploy\n    sudo -u postgres psql -U postgres -d postgres -c \"alter user deploy with password 'deploy';\"\n  fi\n  if sudo -u postgres psql -lqt | cut -d \\\\\\| -f 1 | grep -wq $DATABASE_NAME; then\n    echo STEP: $DATABASE_NAME already exists\n  else\n    echo STEP: creating $DATABASE_NAME\n    sudo -u deploy createdb $DATABASE_NAME\n  fi\nelse\n  echo STEP: create mysql2 database user deploy\n  if [[ `echo \"SELECT user FROM mysql.user WHERE user = 'deploy'\" | mysql` = \"\" ]]; then\n    echo CREATE USER 'deploy'@'localhost' | mysql --user=root\n    echo GRANT ALL PRIVILEGES ON * . * TO 'deploy'@'localhost' | mysql --user=root\n    #FLUSH PRIVILEGES;\n  else\n    echo STEP: mysql user 'deploy' already exists\n  fi\nfi\n\nif [ \"`sudo -i -u deploy which bundle`\" = \"\" ]; then\n#if [ ! -f /usr/local/rvm/scripts/rvm ]; then\n  echo \"STEP: installing rvm for system so it can download sudo requirements\"\n  gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3\n  # multi-user install to /usr/local/rvm, we use vagrant since it is in sudoers list\n  sudo -i -u vagrant /bin/bash -c \"curl -sSL https://get.rvm.io | sudo -i bash -s stable --ruby\"\n  usermod -a -G rvm deploy # adding to rvm group so it can access /usr/local/rvm\n  usermod -a -G rvm vagrant # adding to rvm group so it can access /usr/local/rvm\n\n  if [ ! \"#{$ruby_version}\" = \"\" ]; then\n    echo \"STEP: installing ruby version #{$ruby_version}\"\n    # sometime we need to remove old cache\n    # rm -rf $rvm_path/archives/rubygems-* $rvm_path/user/{md5,sha512}\n    sudo -i -u vagrant /bin/bash -c \"rvm install #{$ruby_version}\"\n  fi\n\n  echo \"STEP: install bundle for deploy\"\n  sudo -i -u deploy /bin/bash -c \"rvm install 2.4\"\n  sudo -i -u deploy /bin/bash -c \"gem install bundler\"\nelse\n  echo \"STEP: rvm and bundler already installed\"\nfi\nSCRIPT\nHERE_DOC\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>vagrant destroy -f # destroy without confirmation\nvagrant up --provision # to provision again\nvagrant ssh\n# or directly\nssh -p 2222 vagrant@127.0.0.1\n# username/password is deploy/deploy\nssh-keygen -f \"/home/orlovic/.ssh/known_hosts\" -R [127.0.0.1]:2222\nyes | ssh-copy-id -p 2222 deploy@127.0.0.1\nssh -p 2222 deploy@127.0.0.1\n</code></pre></div></div>\n\n<h1 id=\"logs\">Logs</h1>\n\n<p>See multiple logs (like multilog or multi tail) in one terminal window</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>vagrant ssh\nsudo apt-get install multitail\nmultitail /var/log/nginx/* /home/deploy/myapp/current/log/*\n</code></pre></div></div>\n\n<h1 id=\"rubber\">Rubber</h1>\n\n<p>This gem is used just as wrapper for common stack, like passenger_postgresql,\ntargeting EC2 instances and do all provision stepts.\nIt depends on capistrano 2.\n<a href=\"http://railscasts.com/episodes/347-rubber-and-amazon-ec2\">railscast</a>\n<a href=\"https://groups.google.com/forum/?fromgroups#!forum/rubber-ec2\">google group</a>\n<a href=\"https://github.com/rubber/rubber/wiki/Quick-Start\">wiki</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n  # deploy and provision tool\n  gem \"rubber\"\nHERE_DOC\nbundle exec rubber vulcanize complete_passenger_postgresql\n# bundle exec rubber vulcanize complete_passenger_mysql\n</code></pre></div></div>\n\n<p>Vulcanize will copy\n<a href=\"https://github.com/rubber/rubber/blob/master/templates/complete_passenger/templates.yml\">templates</a>\nto <code class=\"highlighter-rouge\">config/rubber</code> which you can customize, usually only <code class=\"highlighter-rouge\">yml</code> files.\nCapistrano recepies files <code class=\"highlighter-rouge\">.rb</code>  usually do not need to change, and also\nconfiguration files <code class=\"highlighter-rouge\">role/*.conf</code> are up-to-date.\nYou can start configuring <code class=\"highlighter-rouge\">config/rubber/rubber.yml</code> and <code class=\"highlighter-rouge\">config/deploy.rb</code>.</p>\n\n<p>In <code class=\"highlighter-rouge\">rubber.yml</code> add AWS root security credentials (or another IAM user) to\naccess API and EC2 keypairs to access machine.\nUser security credentials you can export in env.\nKeypair you can download to home <code class=\"highlighter-rouge\">~/.ec2</code> folder, rename without <code class=\"highlighter-rouge\">pem</code> and\nchange permissions <code class=\"highlighter-rouge\">chmod 600 ~/.ec2/gsg-keypair</code>.\nNo need to create public version <code class=\"highlighter-rouge\">ssh-keygen -y -f ~/.ec2/aws_test &gt;\n~/.ec2/aws_test.pub</code>). In case of <code class=\"highlighter-rouge\">The key pair  does not exist\n(Fog::Compute::AWS::NotFound)</code> you should check if keypair is for same region.\nAlso <code class=\"highlighter-rouge\">image_id</code> should be some of the\nhttp://cloud-images.ubuntu.com/locator/ec2/ You can choose t2.micro since it\nFree tier applicable:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/rubber/rubber.yml\n\n# this should be one word and app will be in /mnt/myapp-production/releases/...\napp_name: myapp\n\napp_user: ubuntu\n\ncloud_providers:\n  aws:\n    access_key: \"#{ ENV['AWS_ACCESS_KEY_ID'] }\"\n    secret_access_key: \"#{ ENV['AWS_SECRET_ACCESS_KEY'] }\"\n    account: \"#{ ENV['AWS_ACCOUNT_ID'] }\"\n\n    key_name: us-east-1-gsg-keypair\n\n    image_type: t2.micro\n    # Ubuntu 16\n    image_id: ami-04169656fea786776\n\nprompt_for_security_group_sync: false\n\n# this is just default prompt\nstaging_roles: \"app,db:primary=true\"\n</code></pre></div></div>\n\n<p>We use just web app and db role, not all roles:\napache,app,collectd,common,db:primary=true,elasticsearch,examples,graphite_server,graphite_web,graylog_elasticsearch,graylog_mongodb,graylog_server,graylog_web,haproxy,mongodb,monit,passenger,postgresql,postgresql_master,web,web_tools\nRole <code class=\"highlighter-rouge\">app</code> depends on <code class=\"highlighter-rouge\">passenger</code> which depends on <code class=\"highlighter-rouge\">apache</code>.\nRole <code class=\"highlighter-rouge\">\"db:primary=true\"</code> depends on <code class=\"highlighter-rouge\">postgresql</code> and <code class=\"highlighter-rouge\">postgresql_master</code>\nI had a problem with <code class=\"highlighter-rouge\">web</code> role since it depends on <code class=\"highlighter-rouge\">haproxy</code>\n(<code class=\"highlighter-rouge\">config/rubber/rubber-complete.yml</code>) which has some errors, so I remove that\ndependency:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/rubber/rubber-complete.yml\n  web: []\n  app: [passenger]\n</code></pre></div></div>\n<p>We could remove that role, but we need to assign security groups.</p>\n\n<p>That imlies to change passenger port to 80</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/rubber/rubber-passenger.yml\npassenger_listen_port: 80\npassenger_listen_ssl_port: 443\n</code></pre></div></div>\n\n<p>For Ubuntu 16 (which is ) we need to remove package libapache2-mod-proxy-html\nfor apache\nhttps://groups.google.com/forum/#!topic/rubber-ec2/fut5WZ6TicE</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/rubber/rubber-apache.yml\nroles:\n  apache:\n    packages: [apache2, apache2-utils, libcurl4-openssl-dev, libapache2-mod-xsendfile]\n  web_tools:\n    packages: [apache2, apache2-utils, libcurl4-openssl-dev, libapache2-mod-xsendfile]\n</code></pre></div></div>\n\n<p>and remove apache2-mpm-prefork, apache2-prefork-dev for passenger and remove\npassenger version</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/rubber/rubber-passenger.yml\n    packages: [libcurl4-openssl-dev, libapache2-mod-xsendfile, libapache2-mod-passenger]\n</code></pre></div></div>\n\n<p>and make sure it has the same ruby version which if going to be build in\n<code class=\"highlighter-rouge\">config/rubber/deploy-setup.rb</code> You can use later ruby-build https://github.com/rbenv/ruby-build/releases and some of ruby versions <code class=\"highlighter-rouge\">ruby-build --definitions</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/rubber/rubber-ruby.yml\nruby_build_version: 20180822\nruby_version: 2.3.3\n</code></pre></div></div>\n\n<p>For rails you need to uncommend <code class=\"highlighter-rouge\">gem 'mini_racer', platforms: :ruby</code> in Gemfile.</p>\n\n<p>To provision you can run</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cap rubber:create_staging\n# Hit enter at prompts to accept the default value for params\n# this is the same as manually\ncap rubber:create\ncap rubber:bootstrap\ncap deploy\n# or you can set params in env var like\n# ALIAS=web01 ROLES=app cap rubber:create\n</code></pre></div></div>\n\n<p>This will create <code class=\"highlighter-rouge\">config/rubber/instance-production.yml</code>. It will also reboot\nafter creating.  <code class=\"highlighter-rouge\">ALIAS</code> is name ie subdomain and can not contain underscore. If\nyou run script again and change name it will add another InstanceItem <code class=\"highlighter-rouge\">web02</code>\n(new EC2 machine). It will also update your <code class=\"highlighter-rouge\">/etc/hosts</code> so you can access in\nbrowser with production.foo.com instead of ip address of newly created instance.\nYou can remove (terminate) all EC2 instances with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cap rubber:destroy\n# type 'web01' or your alias\n</code></pre></div></div>\n\n<p>You can create additional instances:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ALIAS=web01 ROLES=app cap rubber:create\nALIAS=web01 ROLES=app cap rubber:bootstrap # this is idempotent and it is\n# reading config/rubber/instance-production.yml for web01 InstanceItem\ncap deploy:cold\n</code></pre></div></div>\n\n<p>and you can see current in <code class=\"highlighter-rouge\">config/rubber/instance-vagrant.yml</code></p>\n\n<p>Roles should be defined in that instance file. Note that for first time we are\ndefining roles using env ROLES on rubber create task.</p>\n\n<p>Note that if <a href=\"https://github.com/rubber/rubber/blob/master/lib/rubber/recipes/rubber/utils.rb#L20\">current instance- file\ndoes not exists</a>\n<code class=\"highlighter-rouge\">rubber:create_staging</code> will create new instance using <code class=\"highlighter-rouge\">staging_roles</code>. If that\ninstance file exists, than roles from it will be used.</p>\n\n<p>Rails is running on port 7000 inside virtualbox. haproxy routes standard http\n80 port to rails 7000, so you can access site on <a href=\"http://default.foo.com/\">http://default.foo.com/</a></p>\n\n<h1 id=\"errors\">ERRORS</h1>\n\n<p>To see logs you can</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ssh -i $PEM_FILE ubuntu@web01.foo.com\ntail -f /var/log/apache2/* /mnt/myapp-production/current/log/*\n# in another terminal\ncurl localhost:7000\n</code></pre></div></div>\n\n<p>logs for other services you can find\nhttps://github.com/rubber/rubber/wiki/Troubleshooting\nor you can use existing task:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RAILS_ENV=vagrant cap rubber:tail_logs\n</code></pre></div></div>\n\n<p>If you see only dots, it is probably stuck on passenger</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> * executing `rubber:passenger:serial_add_to_pool_reload_default'\n ** Waiting for passenger to startup\n  * executing \"sudo -p 'sudo password: '  bash -l -c 'while ! curl -s -f http://localhost:$CAPISTRANO:VAR$/ &amp;&gt; /dev/null; do echo .; done'\"\n    servers: [\"default.foo.com\"]\n    [default.foo.com] executing command\n ** [out :: default.foo.com] .\n ** [out :: default.foo.com] .\n</code></pre></div></div>\n\n<p>Please check rails logs (passenger logs is in apache log) to see if there is any\nerror on index page. Probably for first time you need to create database</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cd /mnt/myapp-production/current\nbundle exec rake db:setup\n</code></pre></div></div>\n\n<h2 id=\"rubber-vagrant-rubber-provision\">Rubber Vagrant rubber provision</h2>\n\n<p>It works only for old version of vagrant 1.7.4 (just remove and install that\n<a href=\"https://releases.hashicorp.com/vagrant/1.7.4/\">version .deb file</a> using\nsoftware app)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>vagrant -v # should return 1.7.4\nvagrant plugin install rubber\n</code></pre></div></div>\n\n<p>It depends on older bundler so run</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem uninstall bunder\ngem install bundler -v 1.10.5\nrm Gemfile.lock\nbundle install\n</code></pre></div></div>\n\n<p>Add vagrant env to secrets, database and env</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo \"vagrant: *default\" &gt;&gt; config/secrets.yml\ncat &gt;&gt; config/database.yml &lt;&lt; HERE_DOC\nvagrant:\n  &lt;&lt;: *default\nHERE_DOC\ncp config/environments/production.rb config/environments/vagrant.rb\n</code></pre></div></div>\n\n<p>To be able to ssh into vagrant you need to use your keys or manually copy\nlater.</p>\n\n<p>You need to define your ruby version and roles that you need. Note that current\nruby version need to be same, so check that <code class=\"highlighter-rouge\">rvm list</code> returns current same as\nyour from Vagrantfile.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Vagrantfile &lt;&lt; HERE_DOC\nVagrant.configure(\"2\") do |config|\n  config.vm.box = \"ubuntu/trusty64\"\n  config.vm.box_check_update = false\n  config.vm.network :private_network, ip: \"192.168.70.10\"\n\n  # do not generate new key, copy my key and use it\n  config.ssh.insert_key = false\n  config.vm.provision \"file\", source: \"~/.ssh/id_rsa.pub\", destination: \"~/.ssh/authorized_keys\"\n  config.ssh.private_key_path = [\"~/.ssh/id_rsa\", \"~/.vagrant.d/insecure_private_key\"]\n  # ruby build fails on 512MB so we increase\n  config.vm.provider \"virtualbox\" do |v|\n    v.memory = 1024\n  end\n\n  config.vm.provision :rubber do |rubber|\n    rubber.rubber_env = 'vagrant'\n\n    # If you remove this line, staging_roles from config/rubber/rubber.yml is used\n    rubber.roles = 'web,app,apache,hadproxy,monit,passenger,postgresql_master,db:primary=true'\n\n    # Only necessary if you use RVM locally.\n    rubber.rvm_ruby_version = '2.3.1'\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<p>To create vagrant machine you can run vagrant commands (we use tee to save log)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>vagrant up\n# when machine already created\nvagrant provision\n# or to save a log\nvagrant destroy -f &amp;&amp; vagrant up 2&gt;&amp;1 | tee tmp/log.log\n</code></pre></div></div>\n\n<p>Note that if you make changes to <code class=\"highlighter-rouge\">config/rubber/rubber.yml</code> you need to remove\n<code class=\"highlighter-rouge\">config/rubber/instance-vagrant.yml</code>.</p>\n\n<p>I have error</p>\n\n<p>~~\n ** [out :: default.foo.com] The following packages have unmet dependencies:\n ** [out :: default.foo.com] libapache2-mod-passenger : Depends: passenger (= 1:5.0.8-1~trusty1) but it is not going to be installed\n ** [out :: default.foo.com] Unable to correct problems, you have held broken packages.\n~~</p>\n\n<p>so I need to remove version parameter from <code class=\"highlighter-rouge\">config/rubber/rubber-passenger.yml</code></p>\n\n<p>Another error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> ** ERROR:  Error installing rubber:\n ** xmlrpc requires Ruby version &gt;= 2.3.\n ** /tmp/gem_helper:32:in `block in &lt;main&gt;'\n ** Unable to install versioned gem rubber:3.2.2\n ** RuntimeError\n</code></pre></div></div>\n\n<p>I updated ruby version in <code class=\"highlighter-rouge\">config/rubber/rubber-ruby.yml</code> to match 3.2.1\nAlso if <a href=\"https://github.com/rbenv/ruby-build/issues/721\">ruby-build is failed</a>\nyou can increase memory or add option to <code class=\"highlighter-rouge\">config/rubber/deploy-setup.rb</code></p>\n\n<p>Also I need to comment out <code class=\"highlighter-rouge\">rsudo \"service vboxadd setup\"</code> from\n<code class=\"highlighter-rouge\">config/rubber/deploy-setup.rb</code>.\nAnd for rails asset pipeline you need to add <code class=\"highlighter-rouge\">nodejs</code> package to\n<code class=\"highlighter-rouge\">config/rubber/rubber-ruby.yml</code> to <code class=\"highlighter-rouge\">packages</code> list.</p>\n\n<p>If you change hostname or key, maybe there is connection error like</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>. ** timeout in initial connect, retrying\nTrying to enable root login\n  * executing `rubber:_ensure_key_file_present'\n  * executing `rubber:_allow_root_ssh'\n  * executing \"sudo -p 'sudo password: '  bash -l -c 'mkdir -p /root/.ssh &amp;&amp; cp /home/vagrant/.ssh/authorized_keys /root/.ssh/'\"\n    servers: [\"192.168.70.10\"]\n\n ** Failed to connect to 192.168.70.10, retrying\n  * executing `rubber:_ensure_key_file_present'\n  * executing `rubber:_allow_root_ssh'\n  * executing \"sudo -p 'sudo password: '  bash -l -c 'mkdir -p /root/.ssh &amp;&amp; cp /home/vagrant/.ssh/authorized_keys /root/.ssh/'\"\n    servers: [\"192.168.70.10\"]\n</code></pre></div></div>\n\n<p>when you try <code class=\"highlighter-rouge\">ssh root@192.168.70.10</code> you see</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that a host key has just been changed.\nThe fingerprint for the RSA key sent by the remote host is\nSHA256:ur+QgdymSTNZYqImXqmRgw3cZonpVjZjd7gtNyxyR\nPlease contact your system administrator.\nAdd correct host key in /home/orlovic/.ssh/known_hosts to get rid of this message.\nOffending RSA key in /home/orlovic/.ssh/known_hosts:3\n  remove with:\n  ssh-keygen -f \"/home/orlovic/.ssh/known_hosts\" -R 192.168.70.10\nRSA host key for 192.168.70.10 has changed and you have requested strict checking.\nHost key verification failed.\n</code></pre></div></div>\n\n<p>Than just remove the key from known_hosts and it will resume without errors.</p>\n\n<p>If you get errors like</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Received disconnect from 54.210.7.47 port 22:2: Too many authentication failures\nConnection to production.redirection.xceednet.com closed by remote host.\nConnection to production.redirection.xceednet.com closed.\n</code></pre></div></div>\n\n<p>it might help to add username <code class=\"highlighter-rouge\">ubuntu@</code>, like <code class=\"highlighter-rouge\">ssh -i $PEM_FILE\nubuntu@54.254.110.113</code></p>\n\n<p>To add env secrets you can write them in a <code class=\"highlighter-rouge\">keys.sh</code> file and source from\n<code class=\"highlighter-rouge\">~/.bashrc</code> before return if not interactivelly. If you are using rubber than\nuse system wide bash for example <code class=\"highlighter-rouge\">/etc/profile</code> and put keys for example\n<code class=\"highlighter-rouge\">/root/keys.sh</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># keys.sh\nexport SECRET_KEY_BASE=52b57...\n</code></pre></div></div>\n\n<p>To use different domain you need to update <code class=\"highlighter-rouge\">domain: my-domain.vagrant</code> inside\n<code class=\"highlighter-rouge\">config/rubber/rubber.yml</code>.\nTo use different subdomain you need to set up in Vagrant file using <code class=\"highlighter-rouge\">define</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Vagrant.configure(\"2\") do |config|\n  config.vm.define \"mysubdomain\" do |m|\n  end\nend\n</code></pre></div></div>\n\n<p>I tried with <code class=\"highlighter-rouge\">v.name = 'mysubdomain'</code> inside <code class=\"highlighter-rouge\">Vagrantfile</code> but that just rename\nvirtual machine name\n(<a href=\"https://github.com/rubber/rubber/blob/master/lib/rubber/vagrant/provisioner.rb#L39\">machine.name</a>]\ninside rubber plugin does not take that name). All that plugin does is a call to\nscript command</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RUN_FROM_VAGRANT=true RUBBER_ENV=vagrant ALIAS=mysubdomain ROLES='web,app' EXTERNAL_IP=192.168.70.10 INTERNAL_IP=192.168.70.10 RUBBER_SSH_KEY=/home/orlovic/.ssh/id_rsa,/home/orlovic/.vagrant.d/insecure_private_key ruby -e \"require 'capistrano/cli'; Capistrano::CLI.execute\" rubber:create -S initial_ssh_user=vagrant\n# only rubber:create uses ENV['ROLES'], other task need RUBBER_ENV (this is\ncopied from RAILS_ENV)\n# RUBBER_SSH_KEY and FILTER (not req). and create, refresh, destroy use ALIAS\n... cap rubber:refresh -S initial_ssh_user=vagrant\n... cap rubber:bootstrap\n... cap deploy:migrations\n</code></pre></div></div>\n\n<p>For existing machines you can update <code class=\"highlighter-rouge\">name: mysubdomain'</code> in\n<code class=\"highlighter-rouge\">config/rubber/instance-vagrant.yml</code>.</p>\n\n<h1 id=\"debug-capistrano-tasks\">Debug capistrano tasks</h1>\n\n<p>You can just pust <code class=\"highlighter-rouge\">require \"byebug\"</code> at the top of you .rb file and use <code class=\"highlighter-rouge\">byebug</code>\ncommand inside the tasks, or you can require using <code class=\"highlighter-rouge\">ruby -rbyebug</code> (no need to\nadd require byebug). This does not work in .conf files</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RAILS_ENV=vagrant bundle exec ruby -rbyebug $(which cap) rubber:util:backup\n</code></pre></div></div>\n\n<p>You can debug rubber rb files from you gem. If you want to debug rubber plugin\ncommands than you need to download source, create gem and copy files\n<a href=\"https://github.com/duleorlovic/rubber-vagrant-plugin/commit/409801992b9ee87c09e97b198efa85c5e4176322\">source</a></p>\n\n<p>To list all tasks your can run <code class=\"highlighter-rouge\">cap -T</code>. To find all tasks you need to set up\nenv and use option <code class=\"highlighter-rouge\">-v</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RAILS_ENV=vagrant cap -vT\n</code></pre></div></div>\n\n<p>Some tasks could be only for specific roles or providers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  after \"rubber:bootstrap\", \"rubber:base:reinstall_virtualbox_additions\"\n  task :reinstall_virtualbox_additions, only: { provider: 'vagrant' } do\n    rsudo \"service vboxadd setup\"\n  end\n\n  before \"rubber:install_packages\", \"rubber:base:prepare_passenger_install\"\n  task :prepare_passenger_install, roles: :passenger do\n    ...\n  end\n</code></pre></div></div>\n\n<p>Rubber reads all <a href=\"https://github.com/rubber/rubber/blob/master/templates/base/config/deploy.rb#L79\">deploy-*\nfiles</a>\n(you can find that line in <code class=\"highlighter-rouge\">config/deploy.rb</code>).\nIn <code class=\"highlighter-rouge\">rubber.yml</code> you can overwrite some settings for specific roles, enviroments\nand hosts.</p>\n\n<h1 id=\"videos\">Videos</h1>\n\n<p><a href=\"https://www.youtube.com/watch?v=uXla2yyzH_8\">Ruby on Rails - Railscasts PRO #337 Capistrano Recipes (pro)</a>\n<a href=\"https://www.youtube.com/watch?v=imdrYD4ooIk\">How to deploy RubyonRails project to AWS EC2 using capistrano</a></p>\n\n<p>Tips:</p>\n\n<p>I create shortcuts in home <code class=\"highlighter-rouge\">/home/ubuntu</code> and <code class=\"highlighter-rouge\">/home/deploy_user</code> for easier\naccess</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ln -s /var/www/myapp/shared/ .\nln -s /var/www/myapp/current .\n</code></pre></div></div>\n\n<p>Secrets in capistrano is long issue\nhttps://github.com/capistrano/capistrano/issues/1884\nI put secrets and source in bashrc for both users</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /var/www/myapp/env.sh\nexport RAILS_ENV=production\nexport SMTP_USERNAME=username\n\n# /home/ubuntu/.bashrc\n...\n# for ubuntu user, it can be at the end of a file\nsource /var/www/myapp/env.sh\n\n# /home/deploy_user/.bashrc\n# for deploy_user, it needs to be on first line, since it is used with ssh\nsource /var/www/myapp/env.sh\n</code></pre></div></div>\n\n<p>When you update secrets, than you need to restart the server <code class=\"highlighter-rouge\">cap production\ndeploy:restart</code>. For background jobs to pick up new secrets you need to restart\n<code class=\"highlighter-rouge\">cap production sidekiq:restart</code>.</p>\n\n<ul>\n  <li>if there is an error for\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sidekiq:monit:monitor\n    01 sudo /usr/bin/monit monitor sidekiq_cablecrm_production_0\n    01 sudo\n    01 :\n    01 no tty present and no askpass program specified\n</code></pre></div>    </div>\n    <p>than I tried to enable ssh with no password for monit with <code class=\"highlighter-rouge\">sudo visudo</code> and\nadd line</p>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>deploy_user ALL= NOPASSWD: /usr/bin/monit\n\n</code></pre></div>    </div>\n    <p>but still same problem.</p>\n  </li>\n</ul>\n\n<h1 id=\"nginx\">NGINX</h1>\n\n<p>To configure nginx with passenger, and redirect from non www to www, you can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/nginx/sites-available/trk.conf\nserver {\n    listen 80;\n    server_name www.trkapp.com;\n\n    root /var/www/trkapp/current/public;\n\n    passenger_enabled on;\n    passenger_ruby /usr/local/rvm/gems/ruby-2.5.3/wrappers/ruby;\n}\nserver {\n    listen 80;\n    server_name trkapp.com ;\n    return 301 http://www.trkapp.com$request_uri;\n}\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Background jobs and queues",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/08/26/background-jobs-and-queues/",
      "date"     : "2016-08-26 00:00:00 +0200",
      "content"  : "<h1 id=\"activejob---rails-wrapper\">ActiveJob - Rails wrapper</h1>\n\n<p><a href=\"http://guides.rubyonrails.org/active_job_basics.html\">Using ActiveJob</a> can\nsimplify writing jobs so you can change queuing backend.\n<code class=\"highlighter-rouge\">rails g job my_todo --queue critical</code> it will generate job for which we will\njust log ‘Hi’.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/jobs/my_todo_job.rb\nclass MyTodoJob &lt; ApplicationJob\n  queue_as :critical\n\n  def perform(*args)\n    puts \"puts will show in QUEUE=* rake resque:work\"\n    puts \"use VERBOSE=1 to see job name, queue and params\"\n    Rails.logger.info \"This will show in log/development,log: start #{args}\"\n    sleep 5\n    Rails.logger.info \"MyTodoJob end\"\n  end\nend\n</code></pre></div></div>\n\n<p>or if you can to put logic inside job you can use attr_reader\n(https://youtu.be/wXaC0YvDgIo?list=PL9wALaIpe0Py6E_oHCgTrD6FvFETwJLlx&amp;t=289)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/jobs/person/remove_inaccessible_records_job.rb\nclass Person::RemoveInaccessibleRecordsJob &lt; ApplicationJob\n  queue_as :background\n\n  attr_reader :person, :bucket\n\n  def perform(person, bucket)\n    @person, @bucket = person, bucket\n\n    unless presons.buckets.include? bucket\n      remove_inaccessible_records\n    end\n  end\n\n  private\n\n    def remove_inaccessible_records\n      Person::UnsubscribeFromBucketJob.perform_now(person, bucket)\n\n      if person.user\n        remove_inaccessible_readings\n        remove_inaccessible_bookmarkings\n      end\n\n      remove_inaccessible_email_dropboxes\n    end\n\n    def remove_inaccessible_readings\n      person.user.readings.for_bucket(bucket).find_each(batch_size: 100, &amp;:destroy)\n    end\nend\n</code></pre></div></div>\n\n<p>Invoke jobs with attributes <code class=\"highlighter-rouge\">wait</code> and <code class=\"highlighter-rouge\">wait_until</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>MyTodoJob.perform_later args\nMyTodoJob.set(wait: 1.week).perform_later args\nMyTodoJob.set(wait_until: Date.tomorrow.noon).perform_later args\n\n# or\nMyTodoJob.perform_now args\n</code></pre></div></div>\n\n<p>With ActiveJob you can pass entire ActiveRecord objects because GlobalID will\ndeserialize for us. But if you are using directly some jobs (not inherited from\nActiveJob::Base) than you should pass object_id.</p>\n\n<p>Error <code class=\"highlighter-rouge\">Unsupported argument type: Move</code> when using\n<code class=\"highlighter-rouge\">UserMailer.signup(move).deliver_later</code>. You need to pass id instead of object\nwhen delivering later.</p>\n\n<p>Rails provides in-process queuing (it keeps in memory and is running with rails)\nso if you put byebug it will stop rails process.\nBy default <code class=\"highlighter-rouge\">config.active_job.queue_adapter = :inline</code> better is to use\n<code class=\"highlighter-rouge\">:async</code>.  Both inline and async Active Job do not support priority, timeout and\nretry. You can find all adapter http://api.rubyonrails.org/v5.1/classes/ActiveJob/QueueAdapters.html</p>\n\n<h1 id=\"sidekiq\">Sidekiq</h1>\n\n<p>Add those lines</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n# background job proccessing\ngem 'sidekiq'\n\n# config/application.rb\n    # background jobs\n    config.active_job.queue_adapter = :sidekiq\n    config.active_job.queue_name_prefix = 'mysite'\n</code></pre></div></div>\n\n<p>Sidekiq is faster but requires thread safe code.</p>\n\n<p>You need to install redis server, which is simply adding Heroku redis addon.\nhttps://elements.heroku.com/addons/heroku-redis\nOr on AWS you can install https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04\nSince it allows only 20 connections you need to limit connections for sidekiq.\nIt requires usually concurrency + 5 connections to Redis.\nhttps://github.com/mperham/sidekiq/issues/117</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Procfile\nweb: bundle exec puma -C config/puma.rb\nworker: bundle exec sidekiq -C config/sidekiq.yml\n</code></pre></div></div>\n\n<p>You can run <code class=\"highlighter-rouge\">bundle exec sidekiq -q default -q mailers</code> but better is in config:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/sidekiq.yml\n:concurrency:  3\n:queues:\n  - default\n  - mailers\n\n  - my_site_default\n  - my_site_mailers\n</code></pre></div></div>\n\n<p>You can use console to see all queues</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'sidekiq/api'\nSidekig::Queue.all\n</code></pre></div></div>\n\n<p>Concurrency is a number which are used by sidekiq server to create redis\nconnections (=concurrency + 5 per one process).\nSidekiq client defaults to 5 connections per process but this can be limited to\n1 per process (it does not use <code class=\"highlighter-rouge\">concurrency</code>)\nSo for max 10 redis connections you can use:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/sidekiq.rb\nSidekiq.configure_client do |config|\n  config.redis = { size: 1 }\nend\n# three processes = 3 connections so one sidekiq can have 7 connections\n# only 2 connections are for workers\nSidekiq.configure_server do |config|\n  config.redis = { size: 7 }\nend\n</code></pre></div></div>\n\n<p>You can limit connection pool to 3 so all threads will use only those\nconnections. Concurrency is less than (server pool size - 5)*2. At least\n<code class=\"highlighter-rouge\">concurrency</code> connections to database is also required.\nPuma threads share client connections per process. so if size is 3, all threads\nwill use only those 3 connections.\nDyno count is important, so if you have 4 dynos of one sidekiq and 1 dyno of\nanother sidekig queue, that is 5 * (concurrency + 5) connections.</p>\n\n<p>To see how many jobs is in default queue:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Sidekiq::Queue.new.size # default name is 'default'\nSidekiq::Queue.new('mailers').size\nSidekiq::Queue.new('my_app_mailers').size\n</code></pre></div></div>\n\n<p>To see dashboard add those lines to routes (note that we require current_user to\nbe admin</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'sidekiq/web'\nRails.application.routes.draw do\n  authenticate :user, lambda { |u| u.admin? } do\n    mount Sidekiq::Web =&gt; '/sidekiq'\n  end\n</code></pre></div></div>\n\n<p>Testing sidekiq https://github.com/mperham/sidekiq/wiki/Testing</p>\n\n<p>You can use block</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'sidekiq/testing'\n\nSidekiq::Testing.inline! do\n  HardWorker.perform_async\n  assert_worked_hard\nend\n</code></pre></div></div>\n\n<p>For emails https://github.com/mperham/sidekiq/issues/724</p>\n\n<h1 id=\"resque\">Resque</h1>\n\n<p>Add resque by adding it to Gemfile, and you need to add some config files.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# background job using redis\ngem 'resque'\nHERE_DOC\nbundle\n\nsed -i config/application.rb -e '/^  end$/i \\\n    config.active_job.queue_adapter = :resque\\\n'\n\ncat &gt;&gt; lib/tasks/resque.rake &lt;&lt; HERE_DOC\nrequire 'resque/tasks'\n\n# we need to load our rails environment\n# without this, we can call: QUEUE=* rake environemt resque:work\ntask 'resque:setup' =&gt; :environment\nHERE_DOC\n</code></pre></div></div>\n\n<p>Two configurations:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>if ENV[\"REDISTOGO_URL\"].present?\n  uri = URI.parse(ENV[\"REDISTOGO_URL\"])\n  REDIS = Redis.new(host: uri.host, port: uri.port, password: uri.password)\nelse\n  REDIS = Redis.new(host: \"localhost\")\nend\n\nResque.redis = REDIS\n</code></pre></div></div>\n\n<p>or</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; config/redis.yml &lt;&lt; HERE_DOC\ndevelopment: &amp;default localhost:6379\ntest: *default\nproduction: &lt;%= REDISTOGO_URL %&gt;\nHERE_DOC\n\ncat &gt;&gt; config/initializers/resque.rb &lt;&lt; HERE_DOC\nconfig = YAML.load_file(Rails.root.join('config', 'redis.yml'))\n# configure redis connection\nResque.redis = config[Rails.env]\nHERE_DOC\n</code></pre></div></div>\n\n<p>For web use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'resque-web', require: 'resque_web'\n</code></pre></div></div>\n\n<h1 id=\"define-jobs\">Define jobs</h1>\n\n<p>You can use Rails <code class=\"highlighter-rouge\">ActiveJob</code> (so you can use <code class=\"highlighter-rouge\">perform_later</code>) or any class\nmodule that responds to <code class=\"highlighter-rouge\">perform</code> (but than you need to use\n<code class=\"highlighter-rouge\">Resque.enqueue(SimpleJob,i)</code>, or <code class=\"highlighter-rouge\">Delayed::Job.enqueue SimpleJob.new</code> or\n<code class=\"highlighter-rouge\">SimpleJob.delay.perform</code> to enqueue)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mkdir app/jobs\ncat &gt;&gt; app/jobs/process.rb &lt;&lt; HERE_DOC\nmodule SimpleJob\n  @queue = :default\n\n  def self.perform(args)\n    puts \"puts will show in QUEUE=* rake resque:work\"\n    puts \"use VERBOSE=1 to see job name, queue and params\"\n    Rails.logger.info \"logger will show in log/development,log: start #{args}\"\n    sleep 3\n    Rails.logger.info \"SimpleJob end\"\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<p>You can enqueue from rails console (watch out that you do not already have some\nbackground worker running, because it will eat those jobs).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>3.times { |i| Resque.enqueue(SimpleJob,i) }\n3.times { |i| MyTodoJob.perform_later i }\n# note that SimpleJob will wait until critical tasks are done\n</code></pre></div></div>\n\n<p>Note that if you use <code class=\"highlighter-rouge\">ActiveJob::Base</code> than you do not need to restart process\nwhen changing job, but if you use plain class than you need to kill and start\nagain. In either case you do not need to reload rails console, since it merely\nsends name of jobs.</p>\n\n<p>You can list all queues with <code class=\"highlighter-rouge\">Resque.queues</code> (<code class=\"highlighter-rouge\">low, critical, default</code>)</p>\n\n<p>To send notification in case of error use <a href=\"/2015/01/11/good-rails-exception-notification-better-than-tests/#resque\">exception notification for resque</a></p>\n\n<p>Since you need to run separate process for background jobs, you need to write\n<code class=\"highlighter-rouge\">Procfile</code>. By default heroku will run with WEBRICK server and it is advisable\nto use puma.</p>\n\n<p>Always use <code class=\"highlighter-rouge\">QUEUE</code> when calling <code class=\"highlighter-rouge\">QUEUE=* rake reque:work</code></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">QUEUES=comma,separated,list</code></li>\n  <li><code class=\"highlighter-rouge\">QUEUE=my_queue</code></li>\n  <li><code class=\"highlighter-rouge\">QUEUE=*</code> or <code class=\"highlighter-rouge\">QUEUES=*</code></li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// Procfile\nweb: bundle exec puma -C config/puma.rb\nworker: env TERM_CHILD=1 QUEUE=* bundle exec rake resque:work\n</code></pre></div></div>\n\n<p>You can start both web and worker with <code class=\"highlighter-rouge\">foreman start</code>\n<code class=\"highlighter-rouge\">heroku addons:create redistogo</code> is needed to enable redis on heroku.\n<code class=\"highlighter-rouge\">heroku addons:docs redistogo</code></p>\n\n<h1 id=\"resque-scheduler-for-recurring-tasks\">Resque scheduler for recurring tasks</h1>\n\n<p>You can create heroku scheduler (cron task) and call (for example every hour)\nyour custom rake task in which you can add new jobs.\nDisadvantage of this approach is memory. Every time it starts new Rails\nenvironment (that could be 450MB) and several could be at the same time.\nAlso I do not like to write the code outside of git, so I prefer to use plugins.</p>\n\n<p>All plugins use <a href=\"https://github.com/jmettraux/rufus-scheduler\">rufus-scheduler</a>.</p>\n\n<p>resque-scheduler works in that way to check every 5 seconds if some of the tasks\nshould be processes. If it find them, they are pushed to jobs queue.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># lib/tasks/resque.rake\nrequire 'resque/tasks'\nrequire 'resque/scheduler/tasks'\n\ntask \"resque:setup\" =&gt; :environment\n\nnamespace :resque do\n  task :setup_schedule =&gt; :setup do\n    require 'resque-scheduler'\n    Resque.schedule = {\n      UpdateViews: {\n        every: '5s',\n      }\n    }\n    # Resque.schedule = YAML.load_file('config/scheduler.yml')\n  end\n\n  # somehow scheduler task need to be separated from setup_scheduler\n  task :scheduler =&gt; :setup_schedule\nend\n</code></pre></div></div>\n\n<p>Note that scheduler can be defined as hash or yml file. If you are using yml you\nneed to put inside strings all values <code class=\"highlighter-rouge\">5s</code>, cron…</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/scheduler.yml\nMyJob:\n  # cron: '* * * * *'\n  every: '5s'\n  queue: 'critical'\n</code></pre></div></div>\n\n<p>You need to start both <code class=\"highlighter-rouge\">rake resque:work</code> and <code class=\"highlighter-rouge\">rake resque:scheduler</code>.\n(usually you need to export exception recipients only in <code class=\"highlighter-rouge\">work</code> proccess if you\nneed notification).</p>\n\n<p>If you want to run that on same dyno you can use\n<a href=\"http://stackoverflow.com/questions/18176043/does-anyone-run-more-than-one-resque-worker-in-a-heroku-dyno\">foreman</a>\nbut on on heroku free hoby type, you can run both web and worker.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// Procfile\nweb: bundle exec puma -C config/puma.rb\nresque: bundle exec foreman start -f Procfile.workers\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// Procfile.workers\nworker_1: QUEUE=* bundle exec rake resque:work\nworker_2: QUEUE=* bundle exec rake resque:scheduler\n</code></pre></div></div>\n\n<h2 id=\"delayed-job\">Delayed Job</h2>\n\n<p>Define jobs using Struct (or ApplicationJob or ActiveJob::Base, but that\nis not needed). Put params in initialization.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>FetchFeedJob = Struct.new(:feed_id) do\n  def perform\n    puts \"called with #{feed_id}\"\n  end\nend\n# invoke with\nDelayed::Job.enqueue FetchFeedJob.new(feed.id)\n# you can still use rails version\nrake jobs:work\n# no need to restart for code changes and byebug\n</code></pre></div></div>\n\n<p>or you can pass params to <code class=\"highlighter-rouge\">perform</code> and use rails <code class=\"highlighter-rouge\">perform_later</code> to invoke</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/jobs/send_sms_job.rb\nclass SendSmsJob &lt; ActiveJob::Base\n  queue_as :webapp\n\n  rescue_from Net::ReadTimeout, SocketError do |e|\n    e.ignore_please = true\n    sleep 1\n    # re-raise so job is retried\n    raise e\n  end\n  def perform(location_sms_alert)\n  end\nend\n\n# somewhere in the code\nSendSmsJob.perform_later location_sms_alert\n</code></pre></div></div>\n\n<p>Install</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'delayed_job_active_record'\nrails generate delayed_job:active_record\nrake db:migrate\n# this will create bin/delayed_job\n</code></pre></div></div>\n\n<p>Configuration is in <code class=\"highlighter-rouge\">config/application.rb</code> to set\n<code class=\"highlighter-rouge\">config.active_job.queue_adapter = :delayed_job</code>. Note that it is not fully\ncompatible with activejob (does not use default mailer queue name, starts\nimmediatelly and in background with rake jobs:work)</p>\n\n<p>Running is using gem <code class=\"highlighter-rouge\">daemons</code> (so put it in your Gemfile) and then <code class=\"highlighter-rouge\">rails g\ndelayed_job</code> will generate script file <code class=\"highlighter-rouge\">bin/delayed_job</code> which you can use</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">RAILS_ENV=production bin/delayed_job start</code> to run all queues</li>\n  <li><code class=\"highlighter-rouge\">RAILS_ENV=production bin/delayed_job start --queues=webapp,jobs</code> set specific\nqueue (QUEUE=webapp env does not work for delayed job)</li>\n  <li><code class=\"highlighter-rouge\">RAILS_ENV=production bin/delayed_job start --exit-on-complete</code> exit when\nthere are not more jobs</li>\n  <li><code class=\"highlighter-rouge\">RAILS_ENV=production bin/delayed_job run</code> is to run in foreground (sometimes\nbyebug does not work, so I use <code class=\"highlighter-rouge\">rake jobs:work</code> when debugging)</li>\n  <li><code class=\"highlighter-rouge\">RAILS_ENV=production bin/delayed_job restart</code></li>\n  <li><code class=\"highlighter-rouge\">RAILS_ENV=production bin/delayed_job status</code></li>\n  <li><code class=\"highlighter-rouge\">cat tmp/pids/delayed_job.pid</code> can give you process id</li>\n</ul>\n\n<p>The Rails way is:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">rake jobs:work</code></li>\n  <li><code class=\"highlighter-rouge\">rake jobs:workoff</code> to exit after is done with all jobs</li>\n  <li><code class=\"highlighter-rouge\">rake jobs:clear</code> to delete all jobs</li>\n  <li><code class=\"highlighter-rouge\">QUEUES=webapp,jobs rake jobs:work</code> to set specific queue (by default it runs\nall)</li>\n</ul>\n\n<p>Note that email letter opener does not work when you run with <code class=\"highlighter-rouge\">rake jobs:work</code>,\nbut works when <code class=\"highlighter-rouge\">bin/delayed_job run</code> (Launchy works in both cases, this\ndifference is only for mailer).</p>\n\n<p>Workers will check database every 5 seconds.\nNote that you do not need to refresh the runner when you update the code. Kill\nand restart is only required if you update some of the initializers files.</p>\n\n<p>Jobs are objects with a method called <code class=\"highlighter-rouge\">perform</code>. Also you can override\n<code class=\"highlighter-rouge\">Delayed::Worker.max_attempts</code> with your method <code class=\"highlighter-rouge\">max_attempts</code> (you can find\n<a href=\"https://github.com/collectiveidea/delayed_job#gory-details\">defaults</a> for other\nmethods like: <code class=\"highlighter-rouge\">max_run_time</code>, <code class=\"highlighter-rouge\">detroy_failed_jobs?</code>)</p>\n\n<p>To see that is it actually working you need to enable log:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/delayed_job_config.rb\nDelayed::Worker.logger = Logger.new(File.join(Rails.root, 'log', 'delayed_job.log'))\n</code></pre></div></div>\n\n<p>Also you can see all jobs in console:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Delayed::Job.all\njob = Delayed::Job.find 10 # 10 is job.id\n\njob.handler # to see how job will be called\njob.last_error # to see backtrace of error\njob.failed_at # time when last failed\n\n# to rerun, re run, invoke, retry job you can\njob.invoke_job # this does not remove job if successfully, so you need to do\njob.destroy # that manually\n# or\nDelayed::Worker.new.run job # this runs in current process (not in\n# bin/delayed_job run) and will remove if successfully\n# or\njob.update_attributes attempts: 0, run_at: Time.now, failed_at: nil\n# locked_by: nil, locked_at: nil\n# job.failed_at = nil; job.save!\n</code></pre></div></div>\n\n<p>To invoke jobs you can do that in three ways (all three ways support queue name)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># call for object method like user.activate\nuser.delay(queue: 'tracking').activate\n# call in rake tasks\nDelayed::Job.enqueue MyJob.new(user_id), queue: 'tracking'\n# define it on User class\nhandle_asynchronously :activate, queue: 'tracking'\n</code></pre></div></div>\n\n<p>Usage is simply with inserting <code class=\"highlighter-rouge\">delay</code> method and it will run in background. So\ninstead <code class=\"highlighter-rouge\">@user.activate(params)</code> call with <code class=\"highlighter-rouge\">@user.delay.activate(params)</code>.\nAnother way is to define <code class=\"highlighter-rouge\">handle_asynchronously :activate</code> on User class. It can\ntake these params:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">priority: 10</code> lower numbers run first</li>\n  <li><code class=\"highlighter-rouge\">run_at: 5.minutes.from_now</code> or <code class=\"highlighter-rouge\">handle_asynchronously :activate, run_at:\nProc.new { 5.minutes.from_now }</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">queue: 'important'</code> or <code class=\"highlighter-rouge\">handle_asynchronously :ativate, queue: 'important'</code>\nthan you can assign priority for each queue:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Delayed::Worker.queue_attributes = {\n  important: { priority: -10 },\n  low_priority: { priority: 10 }\n}\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>For mailer instead of <code class=\"highlighter-rouge\">.deliver</code> method we can also use <code class=\"highlighter-rouge\">.delay</code> in prefix, like\n<code class=\"highlighter-rouge\">MyMailer.delay(run_at: 5.minutes.from_now).welcome(user)</code>. Or use rails 5\n<code class=\"highlighter-rouge\">deliver_now</code> or <code class=\"highlighter-rouge\">deliver_later</code>.\nNote that if you deliver_later in some validate block which is invalid (model\nhas sam validation errors) than whole block is rolledback and even ActiveJob or\nDelayedJobs is rolledback and hence will not be executed in background.</p>\n\n<p>Mailer <code class=\"highlighter-rouge\">queue</code> is by default <code class=\"highlighter-rouge\">mailers</code>. For other jobs <code class=\"highlighter-rouge\">queue</code> is <code class=\"highlighter-rouge\">nil</code>.\nIn Rails 5 you can rename to <code class=\"highlighter-rouge\">config.action_mailer.deliver_later_queue_name =\n'default_mailer_queue'</code>.</p>\n\n<p>Another way to run background jobs is with <code class=\"highlighter-rouge\">Delayed::Job.enqueue CleanJob.new,\nqueue: 'import'</code>. Note that for ActiveJob instances it runs immediatelly\nand also in background task. So advice is not to mix those two…</p>\n\n<p><a href=\"https://www.sitepoint.com/delayed-jobs-best-practices/\">best practices</a></p>\n\n<p>Sample worker</p>\n\n<p><code class=\"highlighter-rouge\">User.find(1).with_lock do sleep(10); puts \"worker 1 done\" end</code>\n<code class=\"highlighter-rouge\">User.find(1).with_lock do sleep(1); puts \"worker 2 done\" end</code></p>\n\n<p>You can add web based monitoring https://github.com/ejschmitt/delayed_job_web</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'delayed_job_web'\n\n# config/routes.rb\n  match \"/delayed_job\" =&gt; DelayedJobWeb, :anchor =&gt; false, :via =&gt; [:get, :post]\n\n# config/initializers/delayed_job_web.rb\nif Rails.env.production?\n  DelayedJobWeb.use Rack::Auth::Basic do |username, password|\n    ActiveSupport::SecurityUtils.variable_size_secure_compare(Rails.application.secrets.delayed_job_username, username) &amp;&amp;\n      ActiveSupport::SecurityUtils.variable_size_secure_compare(Rails.application.secrets.delayed_job_password, password)\n  end\nend\n\n# config/secrets.yml\n  delayed_job_username: delayed_job\n  delayed_job_password: delayed_job\n</code></pre></div></div>\n\n<p>When you want to cancel a delayed job you can find and destroy it… but better\nis to create a job that is immune ie check at the begginning…</p>\n\n<h1 id=\"test-background-jobs-spec\">Test background jobs spec</h1>\n\n<p><code class=\"highlighter-rouge\">ActiveJob::Base.queue_adapter = :test</code> will change queue adapter for all\nfollowing test.\nYou can see differences between queue adapters\n<a href=\"http://api.rubyonrails.org/v5.1.4/classes/ActiveJob/QueueAdapters.html\">http://api.rubyonrails.org/v5.1.4/classes/ActiveJob/QueueAdapters.html</a>\nThere is test helpers like <code class=\"highlighter-rouge\">assert_performed_with</code> http://api.rubyonrails.org/classes/ActiveJob/TestHelper.html#method-i-assert_performed_with\nexample of use is\n<a href=\"https://github.com/eliotsykes/rspec-rails-examples/blob/master/spec/jobs/headline_scraper_job_spec.rb\">https://github.com/eliotsykes/rspec-rails-examples/blob/master/spec/jobs/headline_scraper_job_spec.rb</a>\nTo send email in background Rails use mailers\n<a href=\"https://blog.bigbinary.com/2018/01/15/rails-5-2-allows-mailers-to-use-custom-active-job-class.html\">ActionMailer::DeliveryJob</a>\nso to test sending in minitest</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'test_helper'\n\nclass ProductTest &lt; ActionDispatch::IntegrationTest\n  include ActiveJob::TestHelper # needed for assert_enqueued_with helper\n\n  test 'billing job scheduling' do\n    # if you want to test outcome ie how job is performed\n    perform_enqueued_jobs only: ActionMailer::DeliveryJob do\n    # or you can assert how it is called `_with`\n    assert_enqueued_with job: ActionMailer::DeliveryJob, args: 1 do\n    # or assert and perform\n    assert_performed_jobs 2, only: ActionMailer::DeliveryJob do\n      product.charge(account)\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>To rescue from exception in background sending emails you can reopen DeliveryJob\nanywhere, for example in ApplicationMailer. If you want to <code class=\"highlighter-rouge\">rescue_from</code> in some\nother non-rails class you can <code class=\"highlighter-rouge\">include ActiveSupport::Rescuable</code></p>\n\n<p>If you use Delayed::Job you can write testing in three ways:\nFirst is when <code class=\"highlighter-rouge\">Delayed::Worker.delay_jobs = true</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>expect do\n  post url, params\nend.to change { Delayed::Job.count }.by(1)\n\nexpect do\n  Delayed::Worker.new.work_off\nend.to change(Delayed::Job, :count).by(-1)\n</code></pre></div></div>\n\n<p>Or you can expect specific job\n<a href=\"https://www.rubydoc.info/gems/rspec-rails/RSpec%2FRails%2FMatchers:have_enqueued_job\">have_enqueued_job</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>expect do\nend.to have_enqueued_job SendSmsJob\n</code></pre></div></div>\n\n<p>Second is when <code class=\"highlighter-rouge\">Delayed::Worker.delay_jobs = false</code> so job is performed inline\nie invoked immediatelly.</p>\n\n<h1 id=\"tips\">TIPS</h1>\n\n<ul>\n  <li>Always check if job is eligible to run , world changes, it could be already\nrun bu some error.</li>\n  <li>Test if job is added and if it added only once.</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Ionic 3",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/08/20/ionic-3/",
      "date"     : "2016-08-20 00:00:00 +0200",
      "content"  : "<p>https://www.youtube.com/watch?v=qs2n_poLarc</p>\n"
    } ,
  
    {
      "title"    : "Api design",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/08/16/api-design/",
      "date"     : "2016-08-16 00:00:00 +0200",
      "content"  : "<h1 id=\"rest-and-json\">REST and JSON</h1>\n\n<p>Just to note that <a href=\"https://en.wikipedia.org/wiki/Representational_state_transfer\">REST\napi</a> means:\nStatelessness (no data between requests), Resource identification per request\n(update only one row, get could have more rows), Representational state transfer\n(returned representation JSON is enough to identify and manipulate row). REST\nenable cacheability so we can scale to large number of components.</p>\n\n<p>Once API is exposed, you should not modify it, except for critical bugfixes. Use\nnamespace</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>namespace :api, default: { format: :json } do\n  namespace :v1 do\n    resources :expenses, only: [:index, :create, :update, :destroy]\n  end\nend\n</code></pre></div></div>\n\n<p>If you use jbuilder, than create folder <code class=\"highlighter-rouge\">app/views/api/v1/expenses</code> for view and\ncontroller <code class=\"highlighter-rouge\">Api::V1::ExpensesController</code></p>\n\n<h1 id=\"jsonapi-resources-jr\">JSONAPI Resources JR</h1>\n\n<p><a href=\"https://github.com/cerebris/jsonapi-resources\">jsonapi-resources</a> give us\nimplementation of JSONAPI</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g jsonapi:resource Api::V1::Post\nrails g jsonapi:controller Api::V1::Post\n\nnamespace :api do\n  namespace :v1 do\n    jsonapi_resources :posts\n  end\nend\n\n# config/initializers/jsonapi_resources.rb:\nJSONAPI.configure do |config|\n  # built in paginators are :none, :offset, :paged\n  config.default_paginator = :paged\n  config.default_page_size = 50\n  config.maximum_page_size = 1000\n\n  # Do this if you use UUID's instead of Integers for id's\n  config.resource_key_type = :uuid\nend\n</code></pre></div></div>\n\n<p>Each <a href=\"http://jsonapi-resources.com/v0.9/guide/resources.html\">resource</a> can be\nconfigured with:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">attributes</code> <code class=\"highlighter-rouge\">attribute</code>\n    <ul>\n      <li>there are also <code class=\"highlighter-rouge\">id</code> and <code class=\"highlighter-rouge\">type</code>. Computed fields can use <code class=\"highlighter-rouge\">@model</code> but also\nneed to be defined with <code class=\"highlighter-rouge\">attribute</code></li>\n      <li><code class=\"highlighter-rouge\">fetchable_fields</code> all attributes are fetchable, and if you want to remove\nsome than override method</li>\n      <li><code class=\"highlighter-rouge\">self.updatable_fields</code>, <code class=\"highlighter-rouge\">self.creatable_fields</code> to override use class methods\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class ContactResource &lt; JSONAPI::Resource\nattributes :name_first, :name_last, :full_name\ndef full_name\n  \"#{@model.name_first}, #{@model.name_last}\"\nend\ndef self.updatable_fields(context)\n  super - [:full_name]\nend\n# class method can be defines inside class &lt;&lt;\nclass &lt;&lt; self\n  def creatable_fields(context)\n    super - [:full_name]\n  end\nend\nend\n</code></pre></div>        </div>\n      </li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">has_many</code></li>\n  <li><code class=\"highlighter-rouge\">filters</code>, <code class=\"highlighter-rouge\">filter</code></li>\n</ul>\n\n<h1 id=\"postman\">Postman</h1>\n\n<p>You can use plugin\n<a href=\"https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop?hl=en\">Postman packaged\napp</a>\nor <a href=\"https://chrome.google.com/webstore/detail/postman-rest-client/fdmmgilgnpjigdojojpjoooidkmcomcm?hl=en\">Postman REST\nclient</a>\nto send API requests.</p>\n\n<p>If you want to send json request from Postman than use header <code class=\"highlighter-rouge\">Accept:\napplication/json</code>. If server responds with json, it can set header\n<code class=\"highlighter-rouge\">Content-type: Application/json</code>.</p>\n\n<p>Nice extension is <a href=\"https://chrome.google.com/webstore/detail/json-formatter/bcjindcccaagfpapjjmafapmmgkkhgoa\">JSON\nFormatter</a>\nthat will render json response in readable way.</p>\n\n<p>Curl commands:</p>\n\n<p><a href=\"/2016/02/01/bash/#curl\">curl commands</a></p>\n\n<h1 id=\"current-user-or-me\">Current user or me</h1>\n\n<p>Instead of <code class=\"highlighter-rouge\">/users/123/settings</code> you can create <code class=\"highlighter-rouge\">/me/settings</code> endpoint.</p>\n\n<h1 id=\"post-vs-put\">POST vs PUT</h1>\n\n<p>When an user has one image (image is part of the user) than it is fine to do\n<code class=\"highlighter-rouge\">PUT /users/1/image</code> when you want to update or create image.\n<code class=\"highlighter-rouge\">PUT</code> should be idempotent (also <code class=\"highlighter-rouge\">DELETE</code> so you can call it several times).</p>\n\n<p>If user have multiple images, than do not use nested, but use <code class=\"highlighter-rouge\">POST\n/users/1/images</code> to create and <code class=\"highlighter-rouge\">PUT /images/1</code> to update image.</p>\n\n<h1 id=\"use-nouns\">Use nouns</h1>\n\n<p>Only verb should be HTTP method (GET, POST, PUT, DELETE). Url should contain\nonly nouns that represent resource. So instead <code class=\"highlighter-rouge\">POST /users/1/send-message</code> it’s\nbetter to use <code class=\"highlighter-rouge\">POST /users/1/messages</code> with <code class=\"highlighter-rouge\">Content-Type: application/json\n{ \"message\": \"Hello\" }</code>.</p>\n\n<p>If you need to send messages to multiple users, you can create new endpoint and\nsend data there <code class=\"highlighter-rouge\">POST /group-messages; Content-Type: application/json; { [ {\n\"user\" : { \"id\" : 1 }, \"message\" : \"Hello 1\" },...] }</code></p>\n\n<p>Use url params for search/filter <code class=\"highlighter-rouge\">GET /places?lat=123&amp;lon=123</code>.</p>\n\n<p>For authorization use headers <code class=\"highlighter-rouge\">POST /users/1/message; Authorization: Bearer\n123</code>.</p>\n\n<p>HTTP body can contain json data.</p>\n\n<h1 id=\"response-status-codes\">Response status codes:</h1>\n\n<p><a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html\">w3</a></p>\n\n<p>Success:</p>\n\n<ul>\n  <li><em>200 OK</em> (for GET)</li>\n  <li><em>201 Created</em> successful POST, login</li>\n  <li><em>202 Accepted</em> Accepted but is being processed async</li>\n  <li><em>204 No Content</em> <code class=\"highlighter-rouge\">:no_content</code> success delete, log out, sign out</li>\n</ul>\n\n<p>For errors we could respond with <code class=\"highlighter-rouge\">head :not_found</code> (and hide sensitive\ninformation) but its better to send the reason and some info (<code class=\"highlighter-rouge\">render json:\n{ error: 'Some problem', error_status: 401, error_code: 1234 }, status: 401</code>)</p>\n\n<ul>\n  <li><em>303 See Other</em> when session create (login) email does not exists</li>\n  <li><em>400 Bad Request</em>  <code class=\"highlighter-rouge\">:bad_request</code> when we have <code class=\"highlighter-rouge\">ParameterMissing</code></li>\n  <li><em>401 Unauthorized</em> <code class=\"highlighter-rouge\">:unauthorized</code> used for wrong password on login form, or\nwhen there is no current_user but it should exists.\n    <ul>\n      <li>note that it should not send <code class=\"highlighter-rouge\">:unauthorized</code> when user is changing password\nand type incorect old one (he still should be logged in, and not automatically\nlogged out since unauthorized request occurs).</li>\n    </ul>\n  </li>\n  <li><em>403 Forbidden</em> <code class=\"highlighter-rouge\">:forbidden</code> when current user exists but is forbidden from\naccessing this data</li>\n  <li><em>404 Not Found</em> <code class=\"highlighter-rouge\">:not_found</code> url is not valid router or resource does not\nexist</li>\n  <li><em>410 Gone</em> data has been deleted, deactivated …</li>\n  <li><em>422 Unprocessable Entity</em> <code class=\"highlighter-rouge\">:unprocessable_entity</code> change password form but\ncurrent password is bad, or form validation errors <code class=\"highlighter-rouge\">if ! @user.update() render\njson: @user.errors.full_messages.join(','), status: :unprocessable_entity</code>, or\nwhen creating new resource but uniqueness validation (already exists) prevents</li>\n</ul>\n\n<p>Server errors</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">500 Internal Server Error</code> unexpected happened on server side</li>\n  <li><code class=\"highlighter-rouge\">503 Service Unavailable</code> api is overloaded or in maintenance mode</li>\n</ul>\n\n<p>Common responses:\nRails does not come with <code class=\"highlighter-rouge\">:unauthorized</code> exception\nhttps://stackoverflow.com/questions/25892194/does-rails-come-with-a-not-authorized-exception\nso you can create one</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/authorization_exception.rb\nclass AuthorizationException &lt; Exception\nend\n</code></pre></div></div>\n<p>and you can use for example in <code class=\"highlighter-rouge\">login</code></p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/api/v2/sessions_controller.rb\n  def subscriber_login\n    # this will raise ActiveRecord::RecordNotFound\n    subscriber = Subscriber.find_by! username: params[:username]\n    # instead of bang we could use find_by and manually raise, result is the same\n    raise ActiveRecord::RecordNotFound.new(\"Couldn't find Subscriber\") unless subscriber\n    raise AuthorizationException.new('Password is not correct') unless subscriber.authenticate(params[:password])\n    render json: { auth_token: JwtAuth.encode_subscriber_id(subscriber.id) }\n</code></pre></div></div>\n\n<p>and rescue from those exceptions and show json message</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\n  rescue_from JWT::DecodeError do |e|\n    render json: { error: e.message }, status: :bad_request\n  end\n\n  rescue_from ActiveRecord::RecordNotFound do |e|\n    render json: { error: e.message }, status: :not_found\n  end\n\n  rescue_from ActiveRecord::RecordInvalid do |e|\n    render json: { error: e.message }, status: :unprocessable_entity\n  end\n\n  # used with params.permit(:domain).fetch(:domain)\n  rescue_from ActionController::ParameterMissing do |e|\n    render json: { error: e.message }, status: :bad_request\n  end\n\n  rescue_from AuthorizationException do |e|\n    render json: { error: e.message }, status: :unauthorized\n  end\n</code></pre></div></div>\n\n<p>Usually in case of validation error, I put only all error messages in one field\n<code class=\"highlighter-rouge\">error</code> for example :</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/users_controller.rb\n\n  def send_password\n    alert = \"Failed to send new password\"\n    format.json { render json: { error: alert }, status: :unprocessable_entity }\n  end\n\n  def create\n    @user = User.new(user_params)\n    if @user.save\n      render json: @user, status: :created\n    else\n      render json: { error: @user.errors.full_messages.to_sentence },\n             status: :unprocessable_entity\n    end\n  end\n\n  def update\n    unless @user.update(user_params)\n      render json: { error: @user.errors.full_messages.to_sentence },\n             status: :unprocessable_entity\n    end\n  end\n</code></pre></div></div>\n\n<p>In angular, I use <code class=\"highlighter-rouge\">connectionInterceptor</code> to set that <code class=\"highlighter-rouge\">data.error</code> in case of\nother errors like: server offline.</p>\n\n<p>In case of success, I use <code class=\"highlighter-rouge\">message</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  message = \"Successfully updated\"\n  format.json { render json: { message: message } }\n</code></pre></div></div>\n\n<h1 id=\"generate-json\">Generate JSON</h1>\n\n<p><a href=\"http://api.rubyonrails.org/classes/ActiveModel/Serializers/JSON.html\">default ActiveModel JSON\nSerializer</a>\ncan be customized with <code class=\"highlighter-rouge\">render json: @phones.as_json(only: [:id], expect:\n[:created_at], include: :posts)</code>\nbut for larger API you need to have centralized serializers.</p>\n\n<h1 id=\"activemodelserializer\">ActiveModelSerializer</h1>\n\n<p>To generate json you can use\n<a href=\"https://github.com/rails-api/active_model_serializers\">active_model_serializers</a>\n<a href=\"https://github.com/rails-api/active_model_serializers/tree/0-10-stable/docs\">documents</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# serializer for api\ngem 'active_model_serializers', '~&gt;0.10.0'\nHERE_DOC\nbundle\n\nrails g serializer user\n</code></pre></div></div>\n\n<p>If you rely on rails convention (empty <code class=\"highlighter-rouge\">def show;end</code>, implicit render json and\nnot specify <code class=\"highlighter-rouge\">render @user</code>) than serializer will not be used. If you specify\n<code class=\"highlighter-rouge\">render json: @user</code> or <code class=\"highlighter-rouge\">render json: @users</code> than it will use <code class=\"highlighter-rouge\">UserSerialier</code>.\nIf you have some other structure like <code class=\"highlighter-rouge\">render json: { user: @user }</code> than\nserializer will not be used. You can manully call <code class=\"highlighter-rouge\">render json: @user,\nserializer: UserSerialier</code> or <code class=\"highlighter-rouge\">render json: @users, each_serializer:\nUserSerialier</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/serializers/application_serializer.rb\nclass ApplicationSerializer&lt; ActiveModel::Serializer\n  include Rails.application.routes.url_helpers\nend\n# app/serializers/user_serializer.rb\ndef UserSerializer &lt; ApplicationSerializer\n  attributes :id, :name\nend\n</code></pre></div></div>\n\n<p>Associations are handled in\n<a href=\"http://www.rubydoc.info/gems/active_model_serializers/ActiveModel/Serializer/Reflection\">reflections</a></p>\n\n<p>You can call <code class=\"highlighter-rouge\">@users.active_model_serializer.new(@users, options).to_json</code>\nFor grape you can use\n<a href=\"https://github.com/ruby-grape/grape-active_model_serializers\">https://github.com/ruby-grape/grape-active_model_serializers</a></p>\n\n<h1 id=\"json-api\">json api</h1>\n\n<p><a href=\"http://jsonapi.org/\">http://jsonapi.org/</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; config/initializers/active_model_serializers.rb &lt;&lt; HERE_DOC\nActiveModelSerializers.config.adapter = :json_api\nHERE_DOC\n</code></pre></div></div>\n\n<h1 id=\"jbuilder\">JBuilder</h1>\n\n<p>jBuilder is already included in rails and is nice if you already have some\nviews.</p>\n\n<h1 id=\"api-documentation\">API Documentation</h1>\n\n<p>If you use rspec then go with\n<a href=\"https://github.com/zipmark/rspec_api_documentation\">rspec_api_documentation</a>,\nor swagger</p>\n\n<h2 id=\"test-and-documentation-from-rspec\">Test and Documentation from rspec</h2>\n\n<p>rspec_api_documentations/dsl and generate api docs <code class=\"highlighter-rouge\">rake docs:generate</code> and\n<code class=\"highlighter-rouge\">gnome-open docs/</code>:\nYou need to put tests in <code class=\"highlighter-rouge\">/spec/acceptance</code> in order to get <a href=\"https://github.com/zipmark/rspec_api_documentation#rake-task\">generate docs\nworking</a>\nConfiguration</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/rspec_api_documentation.rb\nRspecApiDocumentation.configure do |config|\n  config.docs_dir = Rails.root.join('public', 'api')\n  config.format = :json\n  config.curl_host = 'admin.xceednet.com'\n  used_headers = ['Content-Type', 'Authentication']\n  ignored_headers = ['Cookie', 'Host']\n  config.curl_headers_to_filter = ignored_headers\n  config.request_headers_to_include = used_headers\n  config.response_headers_to_include = used_headers\nend\n</code></pre></div></div>\n\n<p>Usage:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">resource</code> synonim for describe, but you need to use <code class=\"highlighter-rouge\">resource</code> if you want to\ngenerate docs and have</li>\n  <li><code class=\"highlighter-rouge\">get</code>, <code class=\"highlighter-rouge\">post</code>, <code class=\"highlighter-rouge\">patch</code>, <code class=\"highlighter-rouge\">delete</code>\n    <ul>\n      <li>you can validate <code class=\"highlighter-rouge\">response_status</code> and <code class=\"highlighter-rouge\">response_body</code> which is\n<code class=\"highlighter-rouge\">JSON.parse(response.body)</code></li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">parameter</code> used to define params</li>\n  <li><code class=\"highlighter-rouge\">example_request</code> is the same as calling <code class=\"highlighter-rouge\">example</code> (synonim for <code class=\"highlighter-rouge\">it</code>) and\n<code class=\"highlighter-rouge\">do_request</code></li>\n  <li><code class=\"highlighter-rouge\">send :name</code> to get value of <code class=\"highlighter-rouge\">name</code></li>\n  <li><code class=\"highlighter-rouge\">no_doc</code></li>\n  <li><code class=\"highlighter-rouge\">explanation</code> can be inside resource or it block</li>\n</ul>\n\n<p>If you got <a href=\"http://www.rubydoc.info/gems/jsonapi-resources/JSONAPI\">415 error UNSUPPORTED_MEDIA_TYPE\n</a> than set header.\nIf you got <code class=\"highlighter-rouge\">is not a valid resource</code> code 101, than you mispelled <code class=\"highlighter-rouge\">type</code> top\nlevel attribute (for example <code class=\"highlighter-rouge\">users</code>) on <a href=\"http://jsonapi.org/format/#document-resource-objects\">resource\nobject</a>.\nIf you got <code class=\"highlighter-rouge\">\"no implicit conversion of nil into Hash\"</code> than problem is that we\nneed to declare <code class=\"highlighter-rouge\">attribute</code> on the resource.\nIf you for <code class=\"highlighter-rouge\">does not contain a key</code> code 109, than you need to add <code class=\"highlighter-rouge\">:id</code> to both\n“data” and “url” and use different name, for example this is duplication for\nupdate resources:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  patch '/v1/organizations/:organization_id' do\n    let(:organization) { create :organization, name: 'My Organization' }\n    let(:organization_id) { organization.id }\n    parameter :id, 'Id of the organization.', required: true\n    let(:id) { organization.id }\n  end\n</code></pre></div></div>\n\n<p>HTTP codes are standard (200 get, 201 created, 204 deleted).</p>\n\n<p>You can debug with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>tail -f log/test.log\n</code></pre></div></div>\n\n<h2 id=\"swagger-ui-grape\">Swagger ui grape</h2>\n\n<p><a href=\"https://github.com/kendrikat/grape-swagger-ui\">https://github.com/kendrikat/grape-swagger-ui</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'grape-swagger'\ngem 'grape-swagger-ui'\n\n\n# app/api/v1/root.rb\nrequire 'grape-swagger'\nmodule API\n  module V1\n    class Root &lt; Grape::API\n      mount Events\n      add_swagger_documentation\n    end\n  end\nend\n\n# config/initializers/assets.rb\nconfig.assets.precompile += %w(swagger_ui.js swagger_ui.css swagger_ui_print.css swagger_ui_screen.css)\n</code></pre></div></div>\n\n<h2 id=\"swagger-docs\">Swagger docs</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development do/a  \\\n  # use github until it is merged https://github.com/richhollis/swagger-docs/pull/144\n  gem 'swagger-docs', git: 'https://github.com/kwerle/swagger-docs'\no\n</code></pre></div></div>\n\n<p>Basepath is important since other json files will be looked there.</p>\n\n<p><code class=\"highlighter-rouge\">param</code> first argument is: <code class=\"highlighter-rouge\">:query</code>, <code class=\"highlighter-rouge\">:path</code> or <code class=\"highlighter-rouge\">:form</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  swagger_controller :customer_sessions, \"Customer Sessions\"\n\n  swagger_api :create do\n    summary \"Customer sign in\"\n    notes \"Sign in form\"\n    param :form, :email, :string, :required, :Email\"\n  end\n</code></pre></div></div>\n\n<p>To generate json, you need to run <code class=\"highlighter-rouge\">rake swagger:docs</code> or overide precompile task</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># lib/tasks/precompile_overrides.rake\nnamespace :assets do\n  task :precompile do\n    Rake::Task['assets:precompile'].invoke\n    Rake::Task['swagger:docs'].invoke\n  end\nend\n</code></pre></div></div>\n\n<p>Usually for precompile is disabled for production, so you need to enable it in\n<code class=\"highlighter-rouge\">config/environments/production.rb</code></p>\n\n<p>Copy <code class=\"highlighter-rouge\">dist</code> content to your <code class=\"highlighter-rouge\">public/apidocs</code> and update all paths in\n<code class=\"highlighter-rouge\">public/apidocs/index.html</code> to match your <code class=\"highlighter-rouge\">/apidocs</code>, and change js <code class=\"highlighter-rouge\">url =\n\"/apidocs/api-docs.json\";</code></p>\n\n<ul>\n  <li>default sort is alphabetical for path and methods (delete, get, path…). You\ncan provide a function for <code class=\"highlighter-rouge\">apisSorter</code> <code class=\"highlighter-rouge\">operationsSorter</code> but too complicated.\nOrder in server response if not supported.</li>\n</ul>\n\n<h1 id=\"apipie-rails\">Apipie rails</h1>\n\n<p>If you are using minitest there is not automatic way to generate docs, so you\ncan use <a href=\"https://github.com/Apipie/apipie-rails\">apipie-rails</a> for\ndocumentation.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo \"gem 'apipie-rails'\" &gt;&gt; Gemfile\nbundle install\nrails g apipie:install # this will generate config/initializers/apipie.rb and update routes\n</code></pre></div></div>\n\n<p>Jus add option <code class=\"highlighter-rouge\">config.translate = false</code></p>\n\n<h1 id=\"grape\">Grape</h1>\n\n<p>If grape is used than we can rescue from all exceptions, but that needs to be\nbefore <code class=\"highlighter-rouge\">mount</code> methods and only for StandardError exceptions</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/api/v1/root.rb\nmodule API\n  module V1\n    class Root &lt; Grape::API\n      rescue_from Koala::Facebook::AuthenticationError, MyappExceptions::Base do |e|\n        ExceptionNotifier.notify_exception(\n                        Exception.new(e.message),\n                        data: {\n                          message: e.message,\n                          stack: e.backtrace,\n                          error: e\n                        }\n        )\n        Rack::Response.new([\"#{e.class} #{e.message}\"], 500, 'Content-type' =&gt; 'text/error').finish\n      end\n      # now we can mount ...\n      mount Users\n      ....\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/myapp_exceptions.rb\nmodule MyappExceptions\n  # use this base class so it is easier to rescue only that\n  # grape rescue only from standard error\n  class Base &lt; StandardError\n  end\n  class UserNotFound &lt; Base\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"guide\">Guide</h1>\n\n<p><a href=\"https://github.com/interagent/http-api-design\">https://github.com/interagent/http-api-design</a></p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>model skill level as string, but consider using array. For example if someone\nwants to cover all skill levels.</li>\n</ul>\n\n<h1 id=\"jwt-json-web-tokens\">JWT Json web tokens</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem 'jwt'\n\nt = JWT.encode( {a: 1}, 'secret')\n=&gt; \"eyJhbGciOiJIUzI1NiJ9.eyJhIjoxfQ.LrlPmSL4FxrzAHJSYbKzsA997COXdYCeFKlt3zt5DIY\"\n&gt;&gt; JWT.decode t, 'secret' #=&gt; [{\"a\"=&gt;1}, {\"alg\"=&gt;\"HS256\"}]\n</code></pre></div></div>\n\n<p><a href=\"https://scotch.io/tutorials/build-a-restful-json-api-with-rails-5-part-two\">https://scotch.io/tutorials/build-a-restful-json-api-with-rails-5-part-two</a></p>\n\n<p>https://medium.com/@stevenpetryk/providing-useful-error-responses-in-a-rails-api-24c004b31a2e#.lp6e0sjpf</p>\n\n<p>https://github.com/tuwukee/jwt_sessions</p>\n\n<p>In email search for Chris Kottom Lesson 9: Token-Based Authentication with JWTs\nAccessing Google oauth to list my videos https://martinfowler.com/articles/command-line-google.html</p>\n\n"
    } ,
  
    {
      "title"    : "Usefull plugins, services and opensource stuff",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/07/26/usefull-plugins-services-and-opensource-stuff/",
      "date"     : "2016-07-26 00:00:00 +0200",
      "content"  : "<h1 id=\"misc\">Misc</h1>\n\n<ul>\n  <li><a href=\"https://github.com/ftlabs/fastclick\">fastclick</a></li>\n  <li><a href=\"https://github.com/zeroclipboard/zeroclipboard\">zeroclipboard</a> to copy some\ntext on click</li>\n  <li>\n    <p><a href=\"https://github.com/MrRio/jsPDF\">jsPDF</a> pdf generator\n<a href=\"http://mrrio.github.io/jsPDF/#\">examples</a>\npreview pdf in browser http://mozilla.github.io/pdf.js/\nhttps://github.com/mozilla/pdf.js/wiki/Setup-pdf.js-in-a-website\nin rails there is <code class=\"highlighter-rouge\">gem 'pdfjs_viewer-rails'</code> but check for domain is enabled\nso there is an error https://github.com/mozilla/pdf.js/issues/7153 Related\nrails issues https://github.com/senny/pdfjs_viewer-rails/issues/12\nhttps://github.com/senny/pdfjs_viewer-rails/issues/42 (gem also uses old pdfjs\nversion).\nBetter approach is to copy from\n<a href=\"https://github.com/mozilla/pdf.js/wiki/Setup-pdf.js-in-a-website#from-examples\">examples</a></p>\n\n    <p>```</p>\n    <h1 id=\"appviewspagespdf_viewerhtmlerb\">app/views/pages/pdf_viewer.html.erb</h1>\n    <p>&lt;%# https://github.com/mozilla/pdf.js/wiki/Setup-pdf.js-in-a-website#from-examples %&gt;</p>\n    <head>\n  &lt;%= stylesheet_link_tag 'plugins/pdf_viewer', media: nil %&gt;\n  <!-- This snippet is used in production (included from viewer.html) -->\n  <link rel=\"resource\" type=\"application/l10n\" href=\"plugins/pdf_viewer.properties\" />\n  &lt;%= javascript_include_tag 'plugins/pdf_viewer_build' %&gt;\n  &lt;%= javascript_include_tag 'plugins/pdf_viewer' %&gt;\n</head>\n\n    <h1 id=\"cp-webviewercss-to-appassetsstylesheetspdf_viewerscss-and-replace-all\">cp web/viewer.css to app/assets/stylesheets/pdf_viewer.scss and replace all</h1>\n    <h1 id=\"url-with-asset-urlpdf_viewerimagesvg--note-that-for\">url with asset-url(‘pdf_viewer/image.svg’) # note that for</h1>\n    <h1 id=\"pdf_viewersgrabcur-there-is-double-quote\">pdf_viewers/grab.cur there is double quote</h1>\n    <h1 id=\"copy-all-webimages-to-appassetsimagespdf_viewer\">copy all web/images to app/assets/images/pdf_viewer/</h1>\n    <h1 id=\"cp-webviewerjs-and-build-to-appassetsjavascriptspdf_viewer\">cp web/viewer.js and build/* to app/assets/javascripts/pdf_viewer/</h1>\n    <h1 id=\"add-your-domain-to-hosted_viewer_origins-viewerjserb1547\">add your domain to HOSTED_VIEWER_ORIGINS viewer.js.erb:1547</h1>\n    <h1 id=\"update-to-point-to-worker-script\">update to point to worker script</h1>\n    <p>workerSrc: {</p>\n  </li>\n  <li>value: ‘../build/pdf.worker.js’,</li>\n  <li>value: ‘&lt;%= asset_path ‘pdf_viewer/pdf.worker.js’ %&gt;’,\n  ```</li>\n</ul>\n\n<p>For error <code class=\"highlighter-rouge\">Message: Failed to fetch</code> (console error <code class=\"highlighter-rouge\">Access to fetch at\n  'http://s3.amazonaws.com/...' from origin 'http://localhost:3004' has been\n  blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on\n  the requested resource. If an opaque response serves your needs, set the\n  request's mode to 'no-cors' to fetch the resource with CORS disabled.</code>) you\n  need to add cors to a bucket https://stackoverflow.com/questions/25104448/pdf-js-cors-issue-for-s3-file</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;CORSConfiguration&gt;\n    &lt;CORSRule&gt;\n        &lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;\n        &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;\n        &lt;AllowedMethod&gt;HEAD&lt;/AllowedMethod&gt;\n        &lt;MaxAgeSeconds&gt;3000&lt;/MaxAgeSeconds&gt;\n        &lt;AllowedHeader&gt;Authorization&lt;/AllowedHeader&gt;\n    &lt;/CORSRule&gt;\n&lt;/CORSConfiguration&gt;\n</code></pre></div></div>\n\n<ul>\n  <li>number input field <a href=\"https://github.com/vsn4ik/jquery.spinner\">spinner</a></li>\n  <li>\n    <p>toggle checkbox: <a href=\"http://bootstrapswitch.com/examples.html\">bootstrap\nswitch</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bower install bootstrap-switch\n//= require bootstrap-switch/dist/js/bootstrap-switch.js\n *= require bootstrap-switch/dist/css/bootstrap3/bootstrap-switch.css\n</code></pre></div>    </div>\n\n    <ul>\n      <li><a href=\"https://github.com/abpetkov/switchery\">abpetkov/switchery</a></li>\n      <li><a href=\"https://codepen.io/Rplus/pen/LdjwZz\">animated smile checkbox</a></li>\n      <li><a href=\"http://www.bootstraptoggle.com/\">bootstraptoggle</a> only for bootstrap 3, for\nB4 use https://github.com/gitbrent/bootstrap4-toggle\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># http://www.bootstraptoggle.com/\n# https://github.com/gitbrent/bootstrap4-toggle\n$('[data-bootstrap-toggle').each -&gt;\n$(this).bootstrapToggle(\n  # this class will enable vimium\n  style: 'demo-button'\n)\n</code></pre></div>        </div>\n      </li>\n    </ul>\n  </li>\n  <li>trigger a function on scroll to an element <a href=\"http://imakewebthings.com/waypoints/\">waypoints</a></li>\n  <li>drag and drop elements <a href=\"https://shopify.github.io/draggable/\">https://shopify.github.io/draggable/</a></li>\n</ul>\n\n<h1 id=\"gems\">Gems</h1>\n\n<ul>\n  <li>https://awesome-ruby.com/</li>\n</ul>\n\n<h1 id=\"alerts-and-notifications\">Alerts and notifications</h1>\n\n<h2 id=\"jbox\">Jbox</h2>\n\n<p><a href=\"http://stephanwagner.me/jBox\">jbox</a> notifications, modals, tooltips, images\nand confirm windows. You need to install plugins that you use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn add jbox\n\n// app/assets/javascripts/application.js\n//= require jbox/src/js/jBox.js\n//= require jbox/src/js/plugins/jBox.Notice.js\n\n// app/assets/javascripts/document_on_turbolinks_load.coffee\n  // add tooltip to all elements with title &lt;a title='Hi'&gt;\n  new jBox('Tooltip', {\n    attach: '[title]'\n  })\n\n// app/assets/javascripts/document_on.coffee\n# &lt;%= button_tag 'Edit', 'data-modal': new_admin_role_path, 'data-modal-title': 'Edit role', class: 'btn' %&gt;\n$(document).on 'click', '[data-modal]', (e) -&gt;\n  openModal(\n    url: e.currentTarget.dataset.modal\n    title: e.currentTarget.dataset.modalTitle\n    width: e.currentTarget.dataset.modalSize\n  )\n  console.log \"data-modal #{e.currentTarget.dataset.modal}\"\n\n// app/assets/javascripts/plugins/jbox_open_modal.coffee\n# https://stephanwagner.me/jBox/options#ajax\nwindow.openModal = ({url, title, width = 'auto'}) -&gt;\n  modal = new jBox 'Modal', {\n    title: e.currentTarget.dataset.modalTitle\n    ajax: {\n      url: e.currentTarget.dataset.modal\n      reload: 'strict'\n      setContent: true\n      complete: -&gt;\n        # we need to reposition when ajax returns\n        this.position()\n    }\n    onCloseComplete: -&gt;\n      $(\"##{this.options.id}\").html('')\n  }\n  modal.open()\n  console.log \"data-modal #{e.currentTarget.dataset.modal}\"\n\nwindow.initializeJboxTooltip = -&gt;\n  # note that this will remove title attribute\n  new jBox 'Tooltip', {\n    attach: '[title]'\n    theme: 'TooltipDark'\n  }\n\n// app/assets/stylesheets/application.sass\n@import 'jbox/src/scss/jBox.scss'\n@import 'jbox/src/scss/plugins/jBox.Notice.scss'\n\n\n# app/controllers/application_controller.rb\n  after_action :_add_flash_message, if: -&gt; { request.xhr? }\n  after_action :_add_js_plugins_initialisations, if: -&gt; { request.xhr? }\n\n  # rubocop:disable Metrics/AbcSize\n  def _add_flash_message\n    return unless request.format == 'application/javascript'\n\n    response.body += \"flash_alert('#{view_context.j flash.now[:alert]}');\" if flash.now[:alert].present?\n    response.body += \"flash_notice('#{view_context.j flash.now[:notice]}');\" if flash.now[:notice].present?\n  end\n  # rubocop:enable Metrics/AbcSize\n\n  def _add_js_plugins_initialisations\n    code = 'initializeJboxTooltip();' if response.body.match? /title=/\n    return unless code.present?\n\n    response.body += if request.format == 'application/javascript'\n                       view_context.j(code)\n                     else\n                       \"&lt;script&gt;#{code}&lt;/script&gt;\"\n                     end\n  end\n\n\n# app/views/layouts/application.html.erb\n      &lt;div class=\"d-none-not-important\" id='notice-holder'&gt;&lt;%= notice %&gt;&lt;/div&gt;\n      &lt;% if notice %&gt;\n        &lt;script&gt;\n          flash_notice('&lt;%= j notice %&gt;');\n        &lt;/script&gt;\n      &lt;% end %&gt;\n\n      &lt;div class=\"d-none-not-important\" id='alert-holder'&gt;&lt;%= alert %&gt;&lt;/div&gt;\n      &lt;% if alert %&gt;\n        &lt;script&gt;\n          flash_alert('&lt;%= j alert %&gt;');\n        &lt;/script&gt;\n      &lt;% end %&gt;\n    &lt;/body&gt;\n  &lt;% end %&gt;\n&lt;/html&gt;\n\n# app/assets/javascripts/flash_messages.coffee\n# https://stephanwagner.me/jBox/get_started\nwindow.flash_alert = (message) -&gt;\n  flash_message message, 'red'\n\nwindow.flash_notice = (message) -&gt;\n  flash_message message, 'blue'\n\nwindow.flash_message = (message, color) -&gt;\n  # https://stephanwagner.me/jBox/documentation says that we need to wait for\n  # ready for page load, so we use setTimeout\n  setTimeout(\n    -&gt;\n      new jBox 'Notice',\n        autoClose: 10000\n        attributes:\n          x: 'right'\n          y: 'bottom'\n        stack: true\n        animation:\n          open:'bounce'\n          close:'fadeOut'\n        content: message\n        color: color\n    50 # tried with 0, 1, but it was triggered before page load and not working\n  )\n</code></pre></div></div>\n\n<h1 id=\"input-mask\">Input mask</h1>\n\n<ul>\n  <li><a href=\"https://unmanner.github.io/imaskjs/\">https://unmanner.github.io/imaskjs/</a></li>\n  <li>jquery form validation https://github.com/jquery-validation/jquery-validation\nto validate only part of a form, you can use element http://jqueryvalidation.org/Validator.element/ but the problem is that you do not know if it is changed\nhttps://forum.jquery.com/topic/using-jquery-validation-on-textboxes-in-a-specific-div</li>\n</ul>\n\n<h1 id=\"select-something\">Select something</h1>\n\n<ul>\n  <li><a href=\"http://zellerda.com/projects/jquery/tokenize\">tokenize</a> for tags,\npreselecting items</li>\n  <li>nice js filter <a href=\"http://codyhouse.co/demo/bouncy-content-filter/\">bouncy content\nfilter</a></li>\n  <li>javascript input filter</li>\n</ul>\n<p><a href=\"http://digitalbush.com/projects/masked-input-plugin/\">http://digitalbush.com/projects/masked-input-plugin/</a></p>\n<ul>\n  <li><a href=\"http://brianreavis.github.io/selectize.js/\">selectize</a> and\n<a href=\"https://github.com/manuelvanrijn/selectize-rails\">selectize-rails</a></li>\n  <li><a href=\"http://loudev.com/\">multiselect</a> nice way to select multiple items from\nopened select box. If you show in popup with different data, then call\n<code class=\"highlighter-rouge\">select.multiSelect('refresh');</code> after you initialize multiSelect.\n    <ul>\n      <li>if you want to keep order <code class=\"highlighter-rouge\">keepOrder</code> option shows nice order, but\nsubmitting the form do not preserve order. You can use this\n<a href=\"http://stackoverflow.com/a/22271944/287166\">solution</a>\n<a href=\"https://github.com/lou/multi-select/issues/184\">issue</a></li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>select.multiSelect({\n  keepOrder: true,\n  afterSelect: function(value){\n    $('#templates-select option[value=\"'+value+'\"]').remove();\n    $('#templates-select').append($(\"&lt;option&gt;&lt;/option&gt;\").attr(\"value\",value).attr('selected', 'selected'));\n  },\n});\n</code></pre></div>    </div>\n\n    <ul>\n      <li><code class=\"highlighter-rouge\">keepOrder</code> does not work for preselected items, solution could be to\nmanually select (not already select: selected):</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$.each(selectedTemplateIds, function(index, template_id) {\n  select.multiSelect('select', [String(template_id)]);\n});\n</code></pre></div>    </div>\n  </li>\n  <li><a href=\"https://github.com/wenzhixin/multiple-select\">multiple select</a> it creates ul\nlists, if inside <code class=\"highlighter-rouge\">overflow: hidden</code> you can use\n<a href=\"https://github.com/wenzhixin/multiple-select/pull/34\">container</a> and\n<code class=\"highlighter-rouge\">dropWidth: '100px'</code> options</li>\n</ul>\n\n<h2 id=\"select2\">Select2</h2>\n\n<p>This nice <a href=\"https://select2.github.io/examples.html\">select2 examples</a> works.</p>\n\n<ul>\n  <li>\n    <p>problem is when you have animations (like in modal, or collapsed-box) select\ncan calculate full width. solution is to set inline <code class=\"highlighter-rouge\">style=\"width:100%\"</code> or to\ncall with</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  $('#customer-name-select').select2({ placeholder: 'Search by Customer Name or Username', width: '100%'});\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>to make it <code class=\"highlighter-rouge\">inline</code> you can wraps inside <code class=\"highlighter-rouge\">inline-block</code> element and set some\nsize with <code class=\"highlighter-rouge\">style='width:100px'</code> on select element (select2 will use that to\ncalculate size).</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/select2.sass\n.select2-inline\n  display: inline-block\n  // by default .select2-container is block, which move it slightly to the top\n  // and then it is not inline with other inline text or buttons\n  .select2-container\n    display: inline-block\n</code></pre></div>    </div>\n\n    <p>one solution to make select wider is to use <code class=\"highlighter-rouge\">select_tag :id, '',\ninclude_blank: 'Long sentence that make select width wider'</code></p>\n  </li>\n  <li>\n    <p>options like\n<a href=\"https://select2.github.io/options.html#dropdownParent\">dropdownParent</a> could\nhelp</p>\n  </li>\n</ul>\n\n<p>You can use <code class=\"highlighter-rouge\">data-(any option)</code> so for example you can use\n<code class=\"highlighter-rouge\">data-placeholder=\"Please select\"</code> to set select2 placeholder, or\n<code class=\"highlighter-rouge\">data-tags=\"true\"</code> to enable tagging (also need <code class=\"highlighter-rouge\">multiple: true</code> for select to\naccept multiple options)</p>\n\n<p>I use this initializer <code class=\"highlighter-rouge\">data-select2-initialize</code> (do not use <code class=\"highlighter-rouge\">data-select2</code>\nsince it is used already) and if you use turbolinks and have all select elements\non main page</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/turbolinks_load.coffee.rb\n$(document).on 'turbolinks:load', -&gt;\n  console.log 'turbolinks:load'\n  $('[data-select2-initialize]').each -&gt;\n    options = {}\n    if $(this).attr 'placeholder'\n      # select_tag :id, options, include_blank: true, placeholder: 'Choose one'\n      options['placeholder'] = $(this).attr 'placeholder'\n    else\n      options['placeholder'] = '&lt;%= I18n.translate 'please_select' %&gt;'\n\n    options['language'] = determine_language()\n    $(this).select2 options\n</code></pre></div></div>\n\n<p>or without turbolinks or if you have select elements on some ajax responses, you\ncan manually call <code class=\"highlighter-rouge\">&lt;script&gt;initializeSelect2()&lt;/script&gt;</code>)</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/data_select2_initialize.coffee\n@initializeSelect2 = -&gt;\n  $('[data-select2-initialize]').each -&gt;\n    if $(this).attr 'placeholder'\n      placeholder = $(this).attr 'placeholder'\n    else\n      placeholder = \"Please select\"\n    $(this).select2(\n      placeholder: placeholder\n    )\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.select :customer, options_from_collection_for_select(Customer.all, 'id', 'name_and_username'),  { include_blank: true }, 'data-select2-initialize': true, 'data-placeholder': 'Select customer' %&gt;\n  &lt;script&gt;\n    initializeSelect2();\n  &lt;/script&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># default options for all select\n# https://select2.github.io/options.html#setting-default-options\n# issue when select2 is used in modal or other elements that fades in\n$.fn.select2.defaults.set(\"width\", \"100%\")\n</code></pre></div></div>\n\n<p>Problem is when select2 is inside modal with <code class=\"highlighter-rouge\">tabindex=\"-1\"</code>\n<a href=\"https://github.com/select2/select2/issues/119\">example</a></p>\n\n<p>To select item on select2 with ajax source, you need to initialize with data and\nkeep ajax source</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    $(selectTarget).select2({\n      data: [{id: selectValue, text: selectText}],\n      ajax: {\n        url: $(selectTarget).data('select2AjaxInitialize'),\n        dataType: 'json'\n      }\n    });\n</code></pre></div></div>\n\n<p>or for all</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$(document).on 'turbolinks:load', -&gt;\n  $('[data-select2-ajax-initialize]').each -&gt;\n    url = $(this).data('select2AjaxInitialize')\n    options = {\n      ajax: {\n        url: url\n        dataType: 'json'\n      }\n    }\n    $(this).select2 options\n    # using label for select does not open select2 on focus, so on label click\n    # we should trigger open\n    # https://github.com/select2/select2/issues/2311#issuecomment-180666626\n    $(this).focus -&gt;\n      $(this).select2('open')\n</code></pre></div></div>\n\n<p>Search not only on text but on custom data attributes https://stackoverflow.com/questions/36021892/search-on-select-attribute-in-select2\nhttps://select2.org/searching\nI tried to add hidden divs to <code class=\"highlighter-rouge\">&lt;option&gt;</code> but it seems that there could be only\nthe text as inner object. So I add title and copy <code class=\"highlighter-rouge\">matcher</code> function from\nSelect2 and add</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/data_select2_initialize.coffee\nmatcher = (params, data) -&gt;\n  # ... copy from original matcher ...\n  title = stripDiacritics(data.title).toUpperCase()\n  # check if title exists and contains the term\n  if title.indexOf(term) &gt; -1\n    return data\n\n@initializeSelect2 = -&gt;\n  $('[data-select2-initialize]').each -&gt;\n    # we need to remove tabindex attribute from modal if exists\n    # https://github.com/select2/select2/issues/119\n    $(this).parents(\".modal\").removeAttr('tabindex')\n    $(this).select2(\n      matcher: matcher\n    )\n</code></pre></div></div>\n\n<h1 id=\"calendar-date-and-time-picker\">Calendar date and time picker</h1>\n\n<ul>\n  <li>Best option is <a href=\"http://www.daterangepicker.com/\">daterangepicker</a> it can be\nused for singleDatePicker, dateTime picker\n    <ul>\n      <li>download with <code class=\"highlighter-rouge\">bower install bootstrap-daterangepicker --save</code> (git should\nbe <a href=\"https://github.com/dangrossman/bootstrap-daterangepicker\">https://github.com/dangrossman/bootstrap-daterangepicker</a>)</li>\n      <li>autoApply (can’t be used when timePicker enabled)</li>\n      <li>autoUpdateInput (when you want to parse user selection, custom format)</li>\n      <li>it can contains predefined ranges (Last 7 days)</li>\n      <li>note that is uses <code class=\"highlighter-rouge\">data-daterangepicker</code> so use with your own\n<code class=\"highlighter-rouge\">data-bootstrap-datarangepicker</code></li>\n    </ul>\n  </li>\n  <li><a href=\"http://amsul.ca/pickadate.js/\">pickdate</a></li>\n  <li><a href=\"https://jqueryui.com/datepicker/\">jquery ui datepicker</a>\nError on chrome if you use <code class=\"highlighter-rouge\">type=date</code>\n<a href=\"http://stackoverflow.com/questions/16890376/chrome-type-date-and-jquery-ui-date-picker-clashing\">link</a>\nso use <code class=\"highlighter-rouge\">type=text</code></li>\n  <li><a href=\"https://bootstrap-datepicker.readthedocs.io/en/latest/index.html\">bootstrap-datepicker</a></li>\n  <li>\n    <p>time picker <a href=\"http://jonthornton.github.io/jquery-timepicker/\">http://jonthornton.github.io/jquery-timepicker/</a></p>\n  </li>\n  <li>“One minute ago” can be updated automatically in this\n<a href=\"http://timeago.yarp.com/\">timeago</a> plugin. Similarly,\n<a href=\"https://github.com/hilios/jQuery.countdown\">jquery.countdown</a> for future\ndates</li>\n</ul>\n\n<h1 id=\"image-file-upload-drag-and-drop-crop\">Image file upload drag and drop crop</h1>\n\n<ul>\n  <li>\n    <p>http://plugins.krajee.com/file-input/demo</p>\n  </li>\n  <li><a href=\"http://rubaxa.github.io/jquery.fileapi/\">jquery.fileapi</a> supports\nwebcam, crop, dragndrop</li>\n  <li><a href=\"https://blueimp.github.io/jQuery-File-Upload/\">jQuery-File-Upload</a></li>\n  <li><a href=\"https://davidwalsh.name/browser-camera\">browser-camera</a> html5 getUserMedia</li>\n</ul>\n\n<p>For file input you can show preview file using\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/FileReader\">FileReader</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/ready_page_load.coffee\n$(document).on 'ready page:load', -&gt;\n  # file image preview\n  $(\"[data-image-preview]\").each -&gt;\n    return unless typeof FileReader != \"undefined\"\n    $preview_target = $($(this).data('imagePreview'))\n    $(this).change -&gt;\n      regex = /^([a-zA-Z0-9\\s_\\\\.\\-:])+(.jpg|.jpeg|.png)$/\n      if regex.test $(this).val().toLowerCase()\n        reader = new FileReader()\n        reader.onload = (e) -&gt;\n          $preview_target.html $('&lt;img /&gt;', src: e.target.result)\n        reader.readAsDataURL this.files[0]\n\n# app/views/users/_form.html.erb\n      &lt;div class=\"admin-image-preview\"&gt;\n        &lt;div class=\"admin-image-preview__thumbnail\" id='preview-book-cover-picture'&gt;\n          &lt;% if f.object.book_cover_picture.present? %&gt;\n            &lt;%= image_tag f.object.book_cover_picture.url(:medium) %&gt;\n          &lt;% end %&gt;\n        &lt;/div&gt;\n        &lt;div&gt;\n            &lt;%= f.file_field :book_cover_picture, 'data-image-preview': '#preview-book-cover-picture' %&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n</code></pre></div></div>\n\n<h1 id=\"rich-text-editors-wyswyg\">Rich text editors wyswyg</h1>\n\n<p>list:</p>\n\n<ul>\n  <li><a href=\"http://wagn.org\">http://wagn.org</a> wiki with cards with editor</li>\n  <li><a href=\"https://beefree.io/\">https://beefree.io/</a></li>\n  <li><a href=\"https://github.com/coltaemanuela/FireEdit\">fireEdit</a></li>\n  <li>counter how many characters left https://github.com/rikschennink/short-and-sweet</li>\n  <li>quill</li>\n</ul>\n\n<h2 id=\"quil\">Quil</h2>\n\n<p><a href=\"https://quilljs.com/\">quill</a> <a href=\"https://quilljs.com/playground\">examples</a>\nYou can edit by selecting content\n<a href=\"https://quilljs.com/docs/themes/#bubble\">bubble</a></p>\n\n<p>Usually you do not need any additional styles when you want to show html (bold,\nitalic, h1, quote, code, list). Color and background colors are defined inline\nwith <code class=\"highlighter-rouge\">style</code> attribute so it works (unless you use rails <code class=\"highlighter-rouge\">sanitize</code> which remove\ninline styles). Other styles requires quill classes (center, right, direction,\nalign, indent, large, huge, fonts) so you need to inlude that css and to wrap\noutput inside <code class=\"highlighter-rouge\">ql_editor</code> class (or you can use <a href=\"https://quilljs.com/playground/#class-vs-inline-style\">inline\nstyle</a> but it seems )</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;div class=\"ql-editor\"&gt;\n    &lt;%= raw @location.about_html %&gt;\n  &lt;/div&gt;\n  &lt;script&gt;\n    loadFile(\"//cdn.quilljs.com/1.2.2/quill.snow.css\");\n  &lt;/script&gt;\n</code></pre></div></div>\n\n<p>You can load in head section</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;!-- app/views/layouts/application.html.erb --&gt;\n&lt;script src=\"//cdn.quilljs.com/1.2.2/quill.min.js\" type=\"text/javascript\"&gt;&lt;/script&gt;\n&lt;link href=\"//cdn.quilljs.com/1.2.2/quill.snow.css\" rel=\"stylesheet\"&gt;\n</code></pre></div></div>\n\n<p>or you can load dynamically using this helper</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/load_external_css_javascript.coffee\n# all files will be loaded defered so you can use callbak\nwindow.alreadyLoadedFiles = []\nwindow.loadFile = (filename, callback) -&gt;\n  if callback and filename in alreadyLoadedFiles\n    console.log \"File #{filename} already loaded\"\n    callback()\n    return\n  if filename.slice(-2) == \"js\"\n    fileref = document.createElement('script')\n    fileref.setAttribute(\"type\",\"text/javascript\")\n    fileref.setAttribute(\"src\", filename)\n    fileref.onload = callback if callback\n  else if filename.slice(-3) == \"css\"\n    fileref = document.createElement(\"link\")\n    fileref.setAttribute(\"rel\", \"stylesheet\")\n    fileref.setAttribute(\"type\", \"text/css\")\n    fileref.setAttribute(\"href\", filename)\n  if (typeof fileref!=\"undefined\")\n    document.getElementsByTagName(\"head\")[0].appendChild(fileref)\n    alreadyLoadedFiles.push filename\n    console.log \"Adding file #{filename}\"\n</code></pre></div></div>\n\n<p>and use it with <code class=\"highlighter-rouge\">loadQuill('editor-content', 'editor-container');</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/quill.coffee\nwindow.loadQuill = (editorContent, editorContainer) -&gt;\n  loadFile \"//cdn.quilljs.com/1.2.2/quill.snow.css\"\n  loadFile \"//cdn.quilljs.com/1.2.2/quill.min.js\", -&gt;\n    console.log \"Loading quill editorContent=#{editorContent} \" +\n      \"editorContainer=#{editorContainer}\"\n    # stripped example from https://quilljs.com/docs/modules/toolbar/\n    # so we do not need to load quill classes\n    options =\n      # debug: 'info'\n      modules:\n        toolbar: [\n          [{ 'header': [1, 2, 3, 4, 5, 6, false] }]\n          ['bold', 'italic', 'underline']\n          ['blockquote', 'code-block']\n          [{ 'list': 'ordered'}, { 'list': 'bullet' }]\n          ['clean']\n          ['link']\n        ]\n      theme: 'snow'\n\n    $editorContainer = $(\"##{editorContainer}\")\n    quill = new Quill($editorContainer.get(0), options)\n    toolbar = quill.getModule 'toolbar'\n    toolbar.addHandler 'link', (value) -&gt;\n      if (value)\n        href = prompt('Enter the URL')\n        href = \"http://#{href}\" if href.substring(0,4) != \"http\"\n        this.quill.format('link', href)\n      else\n        this.quill.format('link', false)\n    quill.on 'text-change', -&gt;\n      newHtml = $($editorContainer).find('.ql-editor').html()\n      $(\"##{editorContent}\").val newHtml\n</code></pre></div></div>\n\n<p>You can also get html on <a href=\"https://quilljs.com/playground/#form-submit\">form\nsubmit</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascript/quill.coffee\n$(document).on 'ready page:load', -&gt;\n  options =\n    debug: 'info'\n    modules:\n      toolbar: [\n        ['bold', 'italic', 'underline']\n        ['blockquote', 'code-block']\n        [{ 'header': 1 }, { 'header': 2 }]\n        [{ 'list': 'ordered'}, { 'list': 'bullet' }]\n        [{ 'script': 'sub'}, { 'script': 'super' }]\n        [{ 'indent': '-1'}, { 'indent': '+1' }]\n        [{ 'direction': 'rtl' }]\n        [{ 'size': ['small', false, 'large', 'huge'] }]\n        [{ 'header': [1, 2, 3, 4, 5, 6, false] }]\n        [{ 'color': [] }, { 'background': [] }]\n        [{ 'font': [] }]\n        [{ 'align': [] }]\n        ['clean']\n      ]\n    theme: 'snow'\n  syncHtml = -&gt;\n\n  $('[data-quill-editor]').each -&gt;\n    editoContainer = $(this).get(0)\n    quill = new Quill(editoContainer, options)\n    $targetInput = $(this.dataset.quillEditor)\n    quill.on 'text-change', -&gt;\n      newHtml = $(editoContainer).find('.ql-editor').html()\n      $targetInput.val newHtml\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/admin/pages/show.html.erb %&gt;\n&lt;div data-quill-editor=\"#editor-content\"&gt;\n  &lt;%# you can test with raw content but sanitized is safer %&gt;\n  &lt;%= sanitize @page.content %&gt;\n&lt;/div&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/admin/pages/_form.html.erb\n    &lt;div id=\"editor-container\"&gt;\n      &lt;%= sanitize @location.about_html %&gt;\n    &lt;/div&gt;\n    &lt;script&gt;\n      loadQuill('editor-content', 'editor-container');\n    &lt;/script&gt;\n</code></pre></div></div>\n\n<h1 id=\"fontawesome\">Fontawesome</h1>\n\n<p>Font awesome FA icons are very usefull for quick icons. Look for\n<a href=\"http://fontawesome.io/examples/\">examples</a></p>\n\n<ul>\n  <li>color can be set with <code class=\"highlighter-rouge\">bg-red</code></li>\n  <li>spinner <code class=\"highlighter-rouge\">&lt;i class=\"fa fa-spinner fa-spin\" style=\"font-size:24px\"&gt;&lt;/i&gt;</code></li>\n  <li>in FA 5, by default should be used <code class=\"highlighter-rouge\">fas</code> (solid), <code class=\"highlighter-rouge\">far</code> (regular) and <code class=\"highlighter-rouge\">fal</code>\n(light) is only for pro, but some icons like window-close is free for regular\nhttps://fontawesome.com/icons/window-close?style=regular</li>\n  <li>size can be with setting <code class=\"highlighter-rouge\">style='font-size: 2rem'</code> or using class <code class=\"highlighter-rouge\">fas fa-2x</code>\nhttps://fontawesome.com/how-to-use/on-the-web/styling/sizing-icons</li>\n  <li>padding between icon and text is with margin, and center with fixed width\n<code class=\"highlighter-rouge\">&lt;i class='fas fa-tasks fa-fw mx-1' aria-hidden='true'&gt;&lt;/i&gt;&lt;%= t('home') %&gt;</code></li>\n</ul>\n\n<p>Other free fonts can be found on http://fontello.com/ where you can select icons\nand download only that batch of icons.</p>\n<ul>\n  <li>page loader progress bar <a href=\"http://ricostacruz.com/nprogress/\">http://ricostacruz.com/nprogress/</a></li>\n  <li>page loader car <a href=\"https://codepen.io/igor0ser/pen/amJkvp\">https://codepen.io/igor0ser/pen/amJkvp</a></li>\n</ul>\n\n<h1 id=\"images\">Images</h1>\n\n<ul>\n  <li>free high resolution <a href=\"https://unsplash.com/\">https://unsplash.com/</a></li>\n  <li>free online sample images https://unsplash.it/images</li>\n  <li>free stock photos <a href=\"https://burst.shopify.com\">https://burst.shopify.com</a></li>\n  <li>sample placeholder https://placeholder.com/</li>\n  <li>free vector images kajak pictogram https://pixabay.com/en/sport-pictogram-olympia-water-swim-1580667/</li>\n  <li>flags http://flagpedia.net/india</li>\n</ul>\n\n<h1 id=\"slides\">Slides</h1>\n\n<ul>\n  <li><a href=\"https://github.com/jaredwilli/io-slides\">https://github.com/jaredwilli/io-slides</a> presentations\n https://code.google.com/archive/p/io-2012-slides/\n <a href=\"https://www.youtube.com/watch?feature=player_embedded&amp;v=WRvECXyWj80\">video</a></li>\n</ul>\n\n<h1 id=\"graphs\">Graphs</h1>\n\n<ul>\n  <li><a href=\"https://github.com/mbostock/d3/wiki/Gallery\">graphs\ngallery</a> and\n<a href=\"http://bl.ocks.org/mbostock\">bl.ocks.org/mbostock</a>\n<a href=\"http://square.github.io/crossfilter/\">slider</a>\n<a href=\"http://www.findtheconversation.com/concept-map/#population\">people</a>\n<a href=\"http://exposedata.com/parallel/\">parallel</a> and the best is\n<a href=\"http://play.grafana.org/\">grafana</a></li>\n  <li><a href=\"http://plottablejs.org/examples/\">d3 for charts</a></li>\n  <li>\n    <p><a href=\"http://www.chartjs.org/\">chartjs</a>. Labels and datasets should be inside\n<code class=\"highlighter-rouge\">data</code> attribute. Labels are for all charts.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var myChart = new Chart(ctx, {\n  type: 'line',\n  data: {\n    labels: ['2018-1-1', '2018-1-2'],\n    datasets: [\n    {\n      data: [1, 2],\n      label: 'Tavan',\n    },\n    ]\n  }\n})\n</code></pre></div>    </div>\n    <p>To add new data you can push to datasets and labels\nhttps://www.chartjs.org/docs/latest/developers/updates.html</p>\n  </li>\n  <li>\n    <p>arrows and grouping\n<a href=\"http://marvl.infotech.monash.edu/webcola/examples/smallgroups.html\">http://marvl.infotech.monash.edu/webcola/examples/smallgroups.html</a></p>\n  </li>\n  <li>To draw diagrams and graphs\n<a href=\"http://js.cytoscape.org/demos/compound-nodes/\">http://js.cytoscape.org/demos/compound-nodes/</a>\nDefine elements with array of <code class=\"highlighter-rouge\">{data: { id: 'a' }}</code>. Edges have\n<code class=\"highlighter-rouge\">data: { id: 'ab', source: 'a', target: 'b' }</code>. Alternativelly you can define\nelements as objects of <code class=\"highlighter-rouge\">nodes: [{data: {id:'a'}}], edges: [{data: {id: 'ab',\nsource: 'a', target' b'}}]</code>.\nWhen you want to group inside squares (compound) than use <code class=\"highlighter-rouge\">data: { parent: 'a'\n}</code> (in this case <code class=\"highlighter-rouge\">a</code> will become square).\nLayout http://js.cytoscape.org/#layouts\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>layout: { name: 'grid' }\n</code></pre></div>    </div>\n    <p>Style is array of selectors style keys:</p>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>style: [\n  {\n    selector: 'node',\n    style: {\n      'label': 'data(id)'\n    }\n  }\n]\n</code></pre></div>    </div>\n\n    <p>Events like <code class=\"highlighter-rouge\">dragfree</code> <code class=\"highlighter-rouge\">tapdrag</code> http://js.cytoscape.org/#collection/events\nhttp://js.cytoscape.org/#core/events\nYou can get position http://js.cytoscape.org/#notation/position</p>\n  </li>\n</ul>\n\n<h1 id=\"email-services\">Email services</h1>\n\n<ul>\n  <li><a href=\"http://formspree.io/\">formspree</a> sending emails in javascript</li>\n  <li><a href=\"http://www.freecontactform.com/free.php\">http://www.freecontactform.com/free.php</a> free contact form</li>\n</ul>\n\n<h1 id=\"user-tracking-services\">User tracking services</h1>\n\n<p><a href=\"https://mixpanel.com/\">mixpanel</a></p>\n\n<ul>\n  <li>create tracking plan that defines each event and its properties (name and\n  type: string, number, boolean), In plan we should define: Event name,\n  description, why this event and for each property: property name, property\n  description, property type, why this property</li>\n  <li>call <code class=\"highlighter-rouge\">identify</code> when user signup, or if there are existing users, when the\n  logs in, or use the app</li>\n  <li>you can also send push notifications from mixpanel</li>\n</ul>\n\n<p>https://www.fullstory.com/</p>\n\n<h1 id=\"user-support-services\">User support services</h1>\n\n<ul>\n  <li>intercom <a href=\"https://demos.intercom.com/\">https://demos.intercom.com/</a></li>\n  <li><a href=\"https://userdeck.com\">user deck</a></li>\n</ul>\n\n<h1 id=\"user-intro-tour\">User intro tour</h1>\n\n<p>User navigation to website with help tips should be only one, when user clicks\nsomething (so help is to interactivelly show tips, not on page load). Users will\nnot remeber if you show them 8 steps for the page they just arrived.</p>\n\n<ul>\n  <li><a href=\"http://introjs.com/\">introjs</a> commercial lincence after 2.1</li>\n  <li><a href=\"http://bootstraptour.com\">http://bootstraptour.com</a>\n<a href=\"https://github.com/sorich87/bootstrap-tour\">source</a>\n    <ul>\n      <li>intersting value is <code class=\"highlighter-rouge\">backdrop: true</code> so element is highlighted <code class=\"highlighter-rouge\">reflex:\ntrue</code>  so click on target element dismiss page tour</li>\n      <li>if you want to repeat tour you can use <code class=\"highlighter-rouge\">yield</code> and <code class=\"highlighter-rouge\">content_for</code>\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# somewhere in support dropdown menu %&gt;\n&lt;% if content_for? :page_tour_script %&gt;\n  &lt;li&gt;\n    &lt;%= yield :page_tour_script %&gt;\n    &lt;a href=\"#\" onclick=\"startTour()\"&gt;\n      Start Page Tour\n    &lt;/a&gt;\n  &lt;/li&gt;\n&lt;% end %&gt;\n</code></pre></div>        </div>\n      </li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# on a page where we need tour %&gt;\n&lt;% content_for :page_tour_script do %&gt;\n  &lt;script&gt;\n    function startTour() {\n      // http://bootstraptour.com/api/\n      var tour = new Tour({\n        storage: false,\n        steps: [\n        {\n          element: \"[data-target='#publish-location-package-modal']\",\n          title: \"Publish Package\",\n          content: \"You can publish package using this button\",\n          placement: 'right',\n          backdrop: true,\n          reflex: true,\n        },\n      ]});\n\n      // Initialize the tour\n      tour.init();\n\n      // Start the tour\n      tour.start();\n    }\n  &lt;/script&gt;\n&lt;% end %&gt;\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"visitor-user-analytics\">Visitor user analytics</h1>\n\n<ul>\n  <li><a href=\"https://www.hotjar.com/tour\">https://www.hotjar.com/tour</a></li>\n  <li><a href=\"https://www.fullstory.com/features\">https://www.fullstory.com/features</a></li>\n</ul>\n\n<p>To find new customers you can find sites that link to similar content. For\nexample in google <code class=\"highlighter-rouge\">link:kulakajak.org -site:kulakajak.org</code> will give all sites\nthat links to kulakajak.org. You can scrape them to find admin contact email and\nsuggest them to add your content that will be interesting to their audience</p>\n\n<blockquote>\n  <p>Do you feel it could be a good fit for your audience?  Might be worth a\nmention :)\nHere is the Link:\nI’d love to know what you think!\nSincerely,</p>\n</blockquote>\n\n<h2 id=\"opensource-heatmaps\">Opensource heatmaps</h2>\n\n<ul>\n  <li>example how to to track with firebase</li>\n</ul>\n<p><a href=\"https://github.com/seeyourvisitors/seeyourvisitors/blob/master/gg.dev.js\">https://github.com/seeyourvisitors/seeyourvisitors/blob/master/gg.dev.js</a> and\nhow to show results with <a href=\"https://github.com/pa7/heatmap.js\">https://github.com/pa7/heatmap.js</a> example js is here\n<a href=\"https://github.com/seeyourvisitors/heatmap\">https://github.com/seeyourvisitors/heatmap</a></p>\n\n<ul>\n  <li>another solution is <a href=\"https://github.com/dugwood/clickheat\">https://github.com/dugwood/clickheat</a></li>\n</ul>\n\n<h1 id=\"marketing\">Marketing</h1>\n\n<ul>\n  <li><a href=\"https://submit.co\">https://submit.co</a> where to submit news about your project</li>\n  <li><a href=\"http://www.communitybuildingguide.com/\">http://www.communitybuildingguide.com/</a> brick by brick guide for awesome\ncommunities</li>\n</ul>\n\n<h1 id=\"optimisation\">Optimisation</h1>\n\n<ul>\n  <li><a href=\"http://caniuse.com/\">caniuse.com</a> to see what is supported and what is not\nin modern browsers</li>\n  <li>optimization for speed <a href=\"https://developers.google.com/speed/pagespeed/insights/\">google\ninsights</a>\n<a href=\"https://gtmetrix.com/reports/www.scuddle.com/zP3xxAuZ\">gtmetrix</a></li>\n</ul>\n\n<h1 id=\"error-tracking\">Error tracking</h1>\n\n<ul>\n  <li>airbrake</li>\n  <li>sentry</li>\n</ul>\n\n<h1 id=\"payment\">Payment</h1>\n\n<ul>\n  <li>https://www.braintreepayments.com/</li>\n  <li>https://www.paddle.co/</li>\n  <li>https://www.payola.io/</li>\n</ul>\n\n<h1 id=\"ruby\">Ruby</h1>\n\n<ul>\n  <li><a href=\"https://github.com/zenchief/yml_gtranslate\">yml_gtranslate</a> automatic\ngenerate translated yml locale files for rails localisations using google\ntranslate <code class=\"highlighter-rouge\">for f in $(find config/locales/ -type d);do yml_gt en rs $f;done</code>.\nAlso usefull when want to grep only en.yml <code class=\"highlighter-rouge\">grep -i catar config/locales\n--include *.en.yml -R</code></li>\n</ul>\n\n<h1 id=\"rails\">Rails</h1>\n\n<p><a href=\"https://github.com/eliotsykes/real-world-rails\">https://github.com/eliotsykes/real-world-rails</a> realworldrails\nmore are using rspec than test: <code class=\"highlighter-rouge\">cd real-world-rails/apps</code> and <code class=\"highlighter-rouge\">find . -name\nspec -maxdepth 2 | wc -l # 134</code> and <code class=\"highlighter-rouge\">find . -name test -maxdepth 2 | wc -l # 52</code></p>\n\n<p>Those are nice to explore:</p>\n<ul>\n  <li>crowdsourcing <a href=\"https://github.com/catarse/catarse\">catarse</a> <a href=\"https://github.com/crowdtilt/crowdtiltopen/\">tilt</a> is not actually opensource, since their api should be used</li>\n  <li><a href=\"/2017/11/17/sharetribe/\">sharetribe</a>\nopensource market peer-to-peer marketplace</li>\n  <li>diaspora\n    <ul>\n      <li>when you run localy, you can import new contacts and their posts, for\nexample: hq@pod.diaspora.software</li>\n    </ul>\n  </li>\n  <li>openstreetmap</li>\n</ul>\n\n<h1 id=\"templates\">Templates</h1>\n\n<ul>\n  <li><a href=\"https://github.com/puikinsh/gentelella\">gentelella</a>\n<a href=\"https://colorlib.com/polygon/gentelella/index.html\">preview</a> <a href=\"https://github.com/iogbole/gentelella_on_rails\">rails\nversion</a></li>\n  <li><a href=\"/2016/10/28/adminlte-free-template-on-rails/\">adminLTE</a></li>\n  <li>free landing pages templates <a href=\"https://freehtml5.co\">https://freehtml5.co</a>\n<a href=\"https://freehtml5.co/booster-free-html5-bootstrap-template/\">booster</a> or\n<a href=\"https://freehtml5.co/demos/elate/\">elate</a></li>\n  <li>bootstrap 4\ncheckout original bootstrap themes https://themes.getbootstrap.com/preview/?theme_id=6743&amp;show_new=\nhttps://coderthemes.com/hyper_2/light/dashboard-crm.html\n<a href=\"https://github.com/BlackrockDigital/startbootstrap-stylish-portfolio\">https://github.com/BlackrockDigital/startbootstrap-stylish-portfolio</a>\n<a href=\"https://blackrockdigital.github.io/startbootstrap-freelancer/\">https://blackrockdigital.github.io/startbootstrap-freelancer/</a></li>\n  <li><a href=\"http://barbajs.org/demo/grid/index.html\">four images</a></li>\n  <li><a href=\"http://thomasvaeth.com/trophy-jekyll/\">trophy jekyll</a> nice template for jekyll</li>\n</ul>\n\n<p>Email templates</p>\n\n<ul>\n  <li>responsive <a href=\"https://github.com/InterNations/antwort\">https://github.com/InterNations/antwort</a> documentation</li>\n</ul>\n<p><a href=\"http://internations.github.io/antwort/\">http://internations.github.io/antwort/</a> guides\n<a href=\"https://github.com/InterNations/antwort/wiki/HTML-Styleguide-for-Email\">https://github.com/InterNations/antwort/wiki/HTML-Styleguide-for-Email</a></p>\n<ul>\n  <li>three templates <a href=\"https://github.com/mailgun/transactional-email-templates\">https://github.com/mailgun/transactional-email-templates</a>\n<a href=\"http://mailgun.github.io/transactional-email-templates/action.html\">example</a></li>\n</ul>\n\n<h1 id=\"animations\">Animations</h1>\n\n<ul>\n  <li><a href=\"http://animejs.com/\">http://animejs.com/</a></li>\n  <li><a href=\"http://daneden.me/animate\">http://daneden.me/animate</a> animate.css you need to add <code class=\"highlighter-rouge\">class='animated\nfadeIn</code>. Check how it looks in Mac Safari.</li>\n  <li>\n    <p><a href=\"https://alexcambose.ro/motus/#/demos/svg\">https://alexcambose.ro/motus/#/demos/svg</a> animate on scroll</p>\n  </li>\n  <li>detect element visibility and start animating when it is visible</li>\n</ul>\n<p><a href=\"https://xtianmiller.github.io/emergence.js/\">https://xtianmiller.github.io/emergence.js/</a></p>\n\n<ul>\n  <li><a href=\"https://tympanus.net/Development/PerspectivePageViewNavigation/index6.html#\">https://tympanus.net/Development/PerspectivePageViewNavigation/index6.html#</a></li>\n  <li><a href=\"https://tympanus.net/Tutorials/AnimatedBorderMenus/index5.html#\">https://tympanus.net/Tutorials/AnimatedBorderMenus/index5.html#</a></li>\n  <li><a href=\"https://tympanus.net/Tutorials/3DShadingWithBoxShadows/\">https://tympanus.net/Tutorials/3DShadingWithBoxShadows/</a></li>\n  <li>shikoba effect on button https://codepen.io/iamryanyu/embed/RNjRZz?height=410&amp;theme-id=1&amp;slug-hash=RNjRZz&amp;default-tab=result&amp;user=iamryanyu&amp;embed-version=2&amp;pen-title=Modern%20Button%20Collection#js-box</li>\n  <li>checkbox in css https://codepen.io/himalayasingh/pen/EdVzNL</li>\n  <li>rotate and shake on hover https://codepen.io/duleorlovic/pen/jdjYNE</li>\n</ul>\n\n<h1 id=\"scroll\">Scroll</h1>\n\n<ul>\n  <li><a href=\"https://russellgoldenberg.github.io/scrollama/basic/\">https://russellgoldenberg.github.io/scrollama/basic/</a> scrolling and changing\nthe content</li>\n</ul>\n\n<h1 id=\"nice-design-and-ui-tools\">Nice design and ui tools</h1>\n\n<ul>\n  <li><a href=\"https://sarcadass.github.io/granim.js/examples.html\">granim.js</a></li>\n  <li><a href=\"https://airen.github.io/DemoHouse/\">DemoHouse</a></li>\n  <li>CSS Tricks button rotate on lost hover</li>\n</ul>\n<p><a href=\"https://css-tricks.com/examples/DifferentTransitionsOnOff/\">https://css-tricks.com/examples/DifferentTransitionsOnOff/</a></p>\n<ul>\n  <li>split cards <a href=\"https://designshack.net/tutorialexamples/splitreveal/index.html\">https://designshack.net/tutorialexamples/splitreveal/index.html</a></li>\n  <li>cards which you can click (mobile) or hover (desktop) http://devjam.com/</li>\n  <li>nice project portfolio showcase <a href=\"https://madewithenvy.com/\">https://madewithenvy.com/</a></li>\n  <li>nice example site sith custom drawings <a href=\"http://www.parkrun.com/\">http://www.parkrun.com/</a></li>\n  <li>animations <a href=\"https://www.kronologic.ai/\">https://www.kronologic.ai/</a></li>\n  <li>red bull <a href=\"https://www.bullandbeard.com/\">https://www.bullandbeard.com/</a></li>\n  <li>project portfolio animated <a href=\"http://celialopez.fr/\">http://celialopez.fr/</a></li>\n  <li>menu rotate on round image <a href=\"https://codepen.io/JoseRosario/pen/PeERry\">https://codepen.io/JoseRosario/pen/PeERry</a></li>\n  <li>menu isometric https://codepen.io/ClementRoche/pen/yEPogx</li>\n  <li>menu in css, select sibling and opacity on all but the one being hovered https://medium.freecodecamp.org/how-to-make-the-impossible-possible-in-css-with-a-little-creativity-bd96bb42b29d</li>\n</ul>\n\n<h1 id=\"fonts-and-icons\">Fonts and icons</h1>\n\n<ul>\n  <li><a href=\"https://github.com/Keyamoon/IcoMoon-Free\">ico Moon Free</a>\n <a href=\"https://icomoon.io/#preview-free\">https://icomoon.io/#preview-free</a></li>\n  <li><a href=\"http://simplelineicons.com/\">simple-line-icons</a></li>\n  <li><a href=\"http://getbootstrap.com/components/\">bootstrap glyphs</a></li>\n  <li><a href=\"https://fonts.google.com/\">google webfonts</a>\n    <ul>\n      <li><a href=\"https://fonts.google.com/specimen/Cabin+Sketch\">cabin sketch</a></li>\n    </ul>\n  </li>\n  <li>set specific font styles <a href=\"http://www.cssfontstack.com/Arial-Narrow\">http://www.cssfontstack.com/Arial-Narrow</a></li>\n</ul>\n\n<h1 id=\"web-framework\">Web framework</h1>\n\n<p><a href=\"https://github.com/kemalyst/kemalyst\">https://github.com/kemalyst/kemalyst</a> based on <a href=\"https://crystal-lang.org/\">https://crystal-lang.org/</a></p>\n\n<h1 id=\"static-analysis\">Static analysis</h1>\n\n<ul>\n  <li><a href=\"https://github.com/koalaman/shellcheck\">shellckeck</a> static analysis tool for\nshell scripts</li>\n</ul>\n\n<h1 id=\"mockups-and-wireframes\">Mockups and wireframes</h1>\n\n<ul>\n  <li>https://balsamiq.com/products/ trial one month</li>\n  <li>https://moqups.com/ free up to 300 objects</li>\n  <li>https://wireframe.cc/ free for public one page</li>\n</ul>\n\n<p>To create mockups you can use: Invision, Marvel, Baslamiq, Sketch. There is one\nopensource free mokup tool: Pencil Project https://pencil.evolus.vn/</p>\n\n<h1 id=\"continuous-integration\">Continuous integration</h1>\n\n<p>see [ci cd post] /2018/04/10/continuous-delivery-integration-ci-cd-pronto/)</p>\n\n<h1 id=\"ddns\">DDNS</h1>\n\n<ul>\n  <li><a href=\"https://www.duckdns.org/vascript:; install.jsp\">duckdns install</a></li>\n  <li>https://www.nsupdate.info to run on ubuntu just <code class=\"highlighter-rouge\">sudo apt-get install\nddclient</code> and provide config params (or update <code class=\"highlighter-rouge\">/etc/ddclient.conf</code>) and it\nwill run every hour</li>\n</ul>\n\n<p>Problem with dynamic dns is that their servers (hosted on AWS) sometime fails.\nCurrently it shows correct ip</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>dig +noall +answer trkcam.duckdns.org\ntrkcam.duckdns.org.\t60\tIN\tA\t77.46.227.151\n</code></pre></div></div>\n\n<p>but sometimes it resolves to <code class=\"highlighter-rouge\">ec2-54-80-18-240j.compute-1.amazonaws.com</code> or\n<code class=\"highlighter-rouge\">ec2-52-91-66-51.compute-1.amazonaws.com</code>, and errors is raised:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Mysql2::Error::ConnectionError: Access denied for user 'cablecrm_staging_user'@'ec2-52-91-66-51.compute-1.amazonaws.com' (using password: (redacted)))\n</code></pre></div></div>\n<p>or</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>A Neo4j::Core::CypherSession::ConnectionFailedError occurred in chats#show:\n\n  Faraday::ConnectionFailed: Couldn't resolve host name\n</code></pre></div></div>\n\n<p>Best way is to use static ip address.</p>\n\n<h1 id=\"find-alternatives\">Find alternatives</h1>\n\n<p>https://alternativeto.net</p>\n\n<h1 id=\"sms\">SMS</h1>\n\n<ul>\n  <li>twilio gem</li>\n</ul>\n\n<h1 id=\"dokku\">Dokku</h1>\n\n<p>Heroku-like self hosted platform as a service</p>\n\n<p>https://pawelurbanek.com/rails-heroku-dokku-migration\n<a href=\"https://github.com/dokku/dokku\">https://github.com/dokku/dokku</a>\nhttps://github.com/githubsaturn/captainduckduck</p>\n"
    } ,
  
    {
      "title"    : "Apns Gcm Push Notifications Using Ionic",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/05/31/apns-gcm-push-notifications-using-ionic/",
      "date"     : "2016-05-31 00:00:00 +0200",
      "content"  : "<h1 id=\"apns\">APNS</h1>\n\n<p><a href=\"https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html#//apple_ref/doc/uid/TP40008194-CH8-SW1\">Overview</a>\nexplain how it works. Your server acts as <em>provider</em> which stores tokens.\nFirebase call tokens as IID Token (Instance ID Token).</p>\n\n<blockquote>\n  <p>The token itself is opaque and persistent, changing only when a device’s data\nand settings are erased\nEach app instance receives its unique token when it registers with APNs.\nDevice tokens change when the user updates the operating system and when a\ndevice’s data and settings are erased. As a result, apps should always request\nthe current device token at launch time.</p>\n</blockquote>\n\n<blockquote>\n  <p>If APNs attempts to deliver a notification and the destination device is\noffline, APNs stores the notification for a limited period of time and\ndelivers it when the device becomes available again. This component stores\nonly the most recent notification per device and per app. If a device is\noffline, sending a new notification causes the previous notification to be\ndiscarded. If a device remains offline for a long time, all stored\nnotifications are discarded.</p>\n</blockquote>\n\n<p>Maximum size is 4KB. Payload is something like: <code class=\"highlighter-rouge\">{ \"aps\" : { \"alert\" : \"My\nmessage\", \"badge\": 5, \"sound\": \"default\" }, \"my_custom_data\": \"my custom data\"\n}</code></p>\n\n<blockquote>\n  <p>Silent notifications are not meant as a way to keep your app awake in the\nbackground, nor are they meant for high priority updates. APNs treats silent\nnotifications as low priority and may throttle their delivery altogether if\nthe total number becomes excessive. The actual limits are dynamic and can\nchange based on conditions, but try not to send more than a few notifications\nper hour.</p>\n</blockquote>\n\n<p>Silent notification are configured with <code class=\"highlighter-rouge\">{\"aps\" : { \"content-available\" : 1 } }</code>\nand not alert, badge or sound keys.</p>\n\n<p>You can add customer actions using <code class=\"highlighter-rouge\">category</code> in notification, so user responds\nbefore booting whole app.</p>\n\n<p>Feedback service should be used once a day to get tokens that are not longer\nactive\n<a href=\"https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/BinaryProviderAPI.html#//apple_ref/doc/uid/TP40008194-CH13-SW12\">docs</a></p>\n\n<h2 id=\"how-to-make-invalid-apn-token\">How to make invalid apn token</h2>\n\n<p>Feedback service will show tokens that are failed after you last checked. This\nwill not show some invalid tokens that you have generated like: <code class=\"highlighter-rouge\">123123</code>. You\nneed to delete your app manually. Also the token would not be failed if you just\ndelete your app, you need to send message to actually try to use token. After\nthat you will find it in feedback service.  When you read feedback service than\nyou need to try again to send to that token to find in in feedback service.</p>\n\n<p>It could be that you use mobile app with different cert than on server. Those\ntokens will not be invalidated, just messages will not be delivered.</p>\n\n<p>Running MAC in virtualbox is ok when you buy macOS, There are some youtube video\n<a href=\"https://www.youtube.com/watch?v=wI3ng69kTD0\">video</a> with links to download\n<code class=\"highlighter-rouge\">vmdk</code> file and just use with your virtual box but that is not fair. Than you\nwill get message like:</p>\n\n<blockquote>\n  <p>You cannot sign in to iCloud because there was a problem verifying the\nidentity of this Mac. Try restarting your Mac and signing in again</p>\n</blockquote>\n\n<h1 id=\"how-to-generate-push-notification-cert\">How to generate Push Notification cert</h1>\n\n<p>How to generate Push Notification cert</p>\n\n<ul>\n  <li>developer.apple.com - account</li>\n  <li>Certificates, Identifiers, … App Ids</li>\n  <li>Push notifications -  DEV for testing, production for app store and test\nflight -&gt; generate</li>\n  <li>Keychain -&gt; Certificate assistant -&gt; generate request for certificate with\nauthority</li>\n  <li>Upload that file to push notification screen on generate Dev/Prod SSL client\nform</li>\n  <li>Follow steps to generate cert file</li>\n  <li>Import that file as a login keychain (Note that it has to have keychain linked\nto certificate to be able to export it as a .p12 file)</li>\n  <li>Export certificate as a .p12 file</li>\n  <li>\n    <p>Terminal, navigate to root folder of .p12</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>openssl pkcs12 -in yourcert.p12 -out yourcert.pem -nodes -clcerts\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"iphone-tips\">iPhone tips</h1>\n\n<ul>\n  <li>to close any app use double click on home button and swipe up</li>\n  <li>sometimes you need to restart Settings app (geard icon) to be able to set up\nvariables for specific app</li>\n</ul>\n\n<h1 id=\"fcm-firebase-cloud-messaging\">FCM Firebase cloud messaging</h1>\n\n<p>Upgrade <a href=\"https://developers.google.com/cloud-messaging/faq\">https://developers.google.com/cloud-messaging/faq</a> Note that GCM\n(developers.google.com/cloud-messaging) is deprecated so use FCM instead.\nFor server side in ruby you need to register a project on\n<a href=\"https://console.developers.google.com\">https://console.developers.google.com</a> and enable “Firebase Cloud Messaging”.\nCreate API key and save as GOOGLE_API_KEY.\nInstead of google console you can create a project in firebase console\nhttps://console.firebase.google.com/</p>\n\n<p>Best way to start is video https://www.youtube.com/watch?v=BsCBCudx58g\nMore info for server https://firebase.google.com/docs/cloud-messaging/server and\nerror codes https://firebase.google.com/docs/reference/fcm/rest/v1/FcmError</p>\n\n<p>There are two formats of payloads: notification (with eventual data) and data\nhttps://firebase.google.com/docs/cloud-messaging/concept-options#top_of_page\nThere are fields that needs to be send\nhttps://firebase.google.com/docs/reference/fcm/rest/v1/projects.messages#Notification</p>\n<ul>\n  <li>data message, does not contain notification and can trigger onMessageReceived\nwhen app is both in foreground, background, killed</li>\n  <li>notification message, set the <code class=\"highlighter-rouge\">notification</code> key. It can include optional\n<code class=\"highlighter-rouge\">data</code> payload which can be consumed by client app. For general notificaiton\nyou can use title and body, and for android, you can add other fields.\nhttps://firebase.google.com/docs/reference/fcm/rest/v1/projects.messages#androidnotification\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>token/topic/condition: \"registration_id/weather/foo in topics\",\n\nnotification: {\n  title: 'Message title',\n  body: 'message body',\n  icon: 'myicon', // this can override default lancher icon from manifest\n  color: '#FFFFFF',\n  sound: 'default', // can be my_sound which is located in /res/raw\n  tag: 'post_123', // replace existing notification with same tag in drawer\n  click_action: 'intent'. // If specified, an activity with a matching intent\n                          // filter is launched when a user clicks on the notification. \n  body_loc_key: 'my_key', // key used to localize message\n  body_loc_args: [],      // agrs used for localization keys\n  title_loc_key: ''.      // same as body\n  title_loc_args: [],     // same as body\n  channel_id: '',  // Android 8 API 26, notifications are separated by\n  channels https://developer.android.com/guide/topics/ui/notifiers/notifications#ManageChannels\n}\n\nandroid: {\n  collapse_key: 'new_post' // max 4 different keys, only last from the same\n                              key will be send on resume\n  priority: 'normal', // normal or high (consumes more battery)\n  restricted_package_name: 'com.trk.web',\n  ttl: '600' //time to live\n  data: {\n  }\n  notification: {\n  }\n}\nwebpush: {\n}\napns: {\n}\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>For Rails we use https://github.com/spacialdb/fcm gem which use <a href=\"https://firebase.google.com/docs/cloud-messaging/http-server-ref\">Legacy http\nserver\nprotocol</a>\nSend message to maximum 1000 tokens <a href=\"https://github.com/spacialdb/fcm#usage\">source</a>\nFirst argument to <code class=\"highlighter-rouge\">fcm.send</code> is what is actual <code class=\"highlighter-rouge\">registration_ids</code> (if it is a\nsingle string than it is converted to array) and it is merged to second options\nparam. It can contain</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">collapse_key</code> is used to avoid sending too many same messages when the device\ncomes back online, max is 4 different keys</li>\n  <li><code class=\"highlighter-rouge\">priority</code> normal or high</li>\n  <li><code class=\"highlighter-rouge\">content_available</code> and <code class=\"highlighter-rouge\">mutable_content</code> iOS specifics</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">time_to_live</code> seconds how long it should be on server if device is offline,\ndefault is 4 weeks</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">data</code> custom key value that can be used by the app</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">notification</code> object that sets visible parts of the message. not all keys are\nthe same for android and iOS, you can see two tables on\nhttps://firebase.google.com/docs/cloud-messaging/http-server-ref#notification-payload-support</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>notification: {\n  title: 'hello' // title is not visible on iOS phones and tables\n  body: 'Body text'\n  sound: 'default` // file name from /res/raw (android) or Library/Sounds (ios)\n  click_action: // corresponds to category (ios) or activity intent (android)\n                // when app is not in foreground, it will open the app\n  body_loc_key: // for localisation purpose\n  body_loc_args:\n  title_loc_key:\n  title_loc_args:\n\n  (ios only)\n  badge: 'new',  // if 0 than badge is removed\n\n  (android only)\n  android_channel_id: 'channel_id' //\n  icon: 'file_name' // file name is from drawable resource\n  tag: 'post_123', // it replaces notification with a same tag in drawer but\n                    // only for when app is not in foreground\n  color: '#ffffff' // icon color\n}\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>To receive data and notification in android app you can follow https://www.youtube.com/watch?v=we8eGwIED8Y</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/fcm.rb\nMY_FCM = FCM.new Rails.application.secrets.firebase_cloud_messaging_server_key\n\n# app/services/firebase_cloud_messaging.rb\n\n</code></pre></div></div>\n\n<h1 id=\"firebase-web\">Firebase web</h1>\n\n<p>Create project on firebase https://console.firebase.google.com and on Settings\n-&gt; Tab Cloud Messaging -&gt; Web Configuration -&gt; Web Push certificates -&gt; create\nkey pair. Copy public key as <code class=\"highlighter-rouge\">GOOGLE_VAPID_KEY</code></p>\n\n<p>Examples can be found on https://github.com/firebase/quickstart-js\nMessaging example you need to update\n<a href=\"https://github.com/firebase/quickstart-js/blob/master/messaging/index.html#L89\">YOUR_PUBLIC_VAPID_KEY_HERE</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install -g firebase-tools\nfirebase login\nfirebase use --add\nfirebase serve -p 8001\n</code></pre></div></div>\n\n<p>You will also need project number, top righ “Project Settings” and go to the\n<a href=\"https://console.developers.google.com/iam-admin/settings/project?project=cybernetic-tide-90121\">settings</a>\nIt is not Project ID, but it is just 12 numbers like 123123. Save it as\nGOOGLE_PROJECT_NUMBER</p>\n\n<p>You can install Chrome extension to register a client <a href=\"https://github.com/GoogleChrome/chrome-app-samples/tree/master/samples/gcm-notifications\">google chrome example gcm\nnotifications</a></p>\n\n<p><a href=\"https://chrome.google.com/webstore/detail/pushwoosh-gcm-notificatio/ndeeiaalfemhaahglpildclkgilgnfce/related?hl=en\">pushwoosh\nextension</a>\ncan register but it can not receive messages.</p>\n\n<p>There is nice explanation how to create notification on your site\nhttps://developers.google.com/web/fundamentals/push-notifications/</p>\n\n<p>Docs for <a href=\"https://developers.google.com/cloud-messaging/http#response\">response</a></p>\n\n<blockquote>\n  <p>if the value of failure and canonical_ids is 0, it’s not necessary to parse\nthe remainder of the response</p>\n</blockquote>\n\n<p>If there are failures than iterate one by one and if message is some of the:\n“Unavailable’, ‘NotRegistered’, ‘InvalidRegistration’ than you can remove it.\nIf you notice <code class=\"highlighter-rouge\">registration_id</code> than you should update it token</p>\n\n<h1 id=\"how-to-make-invalid-gcm-token\">How to make invalid gcm token</h1>\n\n<p>You need to clear all your app data.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt;HERE_DOC\n# for notifications Google Cloud Messaging\ngem 'gcm'\nHERE_DOC\nbundle\n\nsed -i config/secrets.yml -e '/^test:/i \\\n  # google cloud messaging\\\n  google_api_key: &lt;%= ENV[\"GOOGLE_API_KEY\"] %&gt;'\n\ncat &gt;&gt; config/initializers/google-api.rb &lt;&lt;HERE_DOC\nMY_GCM = GCM.new Rails.application.secrets.google_api_key\nHERE_DOC\n\nrails g model NotificationToken token kind:integer notifiable:references{polymorphic} # user:references\n# make sure kind has default 0, since we can not write that in generator\nlast_migration\n\n# app/models/concerns/notifiable.rb\nmodule Notifiable\n  extend ActiveSupport::Concern\n  included do\n    has_many :notification_tokens, as: :notifiable\n  end\n  class_methods do\n    def send_messages(message = \"Hi All from myapp\", collapse_key = nil, additional_data = nil)\n      tokens = all.map do |user|\n        user.notification_tokens.map(&amp;:token)\n      end.flatten\n      send_to_tokens(tokens, message, collapse_key, additional_data)\n    end\n\n    def send_to_tokens(tokens, message, collapse_key, additional_data)\n      data = { message: message }.merge additional_data\n      data = data.merge collapse_key: collapse_key\n      response = MY_GCM.send(tokens, data: data)\n      ApplicationMailer.internal_notification('push message', tokens: tokens, data: data, response_body: response[:body]).deliver_now if Rails.env.development?\n      logger.info response[:body]\n      response[:body]\n    end\n  end\n\n  def send_message(message = \"Hi from myapp\", collapse_key = nil, additional_data = nil)\n    tokens = notification_tokens.map(&amp;:token)\n    self.class.send_to_tokens(tokens, message, collapse_key, additional_data)\n  end\nend\n\n# config/routes.rb\n+      resources :notification_tokens\n\n# app/controllers/notification_tokens_controller.rb\n+ module Api\n+   module V1\n+     class NotificationTokensController &lt; ApplicationController\n+       prepend_before_action :authenticate_current_user\n+       def index\n+         @notification_tokens = current_user.notification_tokens\n+         render json: @notification_tokens\n+       end\n+ \n+       def create\n+         token = notification_token_params[:token]\n+         @notification_token = current_user.notification_tokens\n+                                           .where(token: token)\n+                                           .first_or_initialize\n+         if @notification_token.save\n+           render json: @notification_token\n+         else\n+           render json: @notification_token.errors, status: :bad_request\n+         end\n+       end\n+ \n+       private\n+ \n+       def notification_token_params\n+         params.require(:notification_token)\n+               .permit(:token)\n+       end\n+     end\n+   end\n+ end\n</code></pre></div></div>\n\n<h1 id=\"client\">Client</h1>\n\n<p>Old plugin <a href=\"https://github.com/phonegap-build/PushPlugin\">PushPlugin</a> has been\nreplaced with new\n<a href=\"https://github.com/phonegap/phonegap-plugin-push\">phonegap-plugin-push</a>.\nYou can use ngcordova wrappers, but I found it is easier to use directly.</p>\n\n<p>GCM notifications arrives with very small delay on real devices, but on\nemulator it could be 10 seconds.\nEmulator should be build with Google API support (this is important!).</p>\n\n<p>App has 3 states: not loaded (killed, or back button pressed), background and\nforeground. In every state notification will be shown in android status bar.\nClicking on it will load the app again (if it was killed than it will start).\nBefore, when app is foreground than no notification will appear in android\nstatus bar.\n<a href=\"https://github.com/phonegap/phonegap-plugin-push/blob/master/docs/API.md#pushnotificationinitoptions\">android.forceShow</a>\nis true than callback is called only when user click on notification (for me\nsometimes it does use callback at all, for foreground and backgroun case), if\nfalse (default) callback is called immediately.</p>\n\n<p>Anyway, when you receive message you can trigger reload for some of your data\nbased on collapse_key. If collapse key is set than any new message with the same\ncollapse_key will overwrite old one. There is limit of 4 different collapse_key\nat one time.\nEven I do not use collapse key, new message will overwrite old one\n<a href=\"http://stackoverflow.com/questions/27713624/gcm-non-collapsible-message-always-replaces-the-previous-message\">stackoverflow</a></p>\n\n<h1 id=\"phonegap-plugin-push\">Phonegap plugin push</h1>\n\n<p><a href=\"https://github.com/phonegap/phonegap-plugin-push/blob/master/docs/INSTALLATION.md\">Install</a>\nall required packages:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cordova plugin add phonegap-plugin-push --variable SENDER_ID=$GOOGLE_PROJECT_NUMBER\nionic build\nandroid update sdk --no-ui --all --filter \"extra-android-m2repository\"\n</code></pre></div></div>\n\n<h1 id=\"pushplugin\">PushPlugin</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cordova plugin add https://github.com/phonegap-build/PushPlugin.git\nionic state save\n\n# edit www/index.html to add `script-src * 'unsafe-inline' 'unsafe-eval';` to\n# the Content-Security-Policy meta\n\n# add `GCM_SENDER_ID: '123123'` to the www/js/app/constants.js\n\n# add `messageService.register();` to  $rootScope.$on('auth:login-success in\n# www/js/app.run.js to register new token on user login (validation-success\n# is too much, we need just on login)\n\ncat &gt;&gt; www/js/services/message.service.js &lt;&lt; HERE_DOC\nangular.module('starter')\n.service('messageService', function(notifyService, $http, CONFIG, $cordovaPush, $rootScope, $ionicPlatform) {\n  this.register = function() {\n    $ionicPlatform.ready(function() {\n      var androidConfig = {\n        senderID: CONFIG.GCM_SENDER_ID,\n      }\n      notifyService.log({messageService_register: androidConfig});\n      $cordovaPush.register(androidConfig).then(function(result) {\n        notifyService.log({cordovaPush_register: 'success', result: result});\n        // Success\n      }, function(err) {\n        notifyService.log({cordovaPush_register: 'error'});\n        // Error\n      });\n    });\n  };\n\n  $rootScope.$on('$cordovaPush:notificationReceived', function(event, notification) {\n    notifyService.log({cordovaPush_notificationReceived: notification.event, notification: notification});\n    switch(notification.event) {\n      case 'registered':\n        if (notification.regid.length &gt; 0 ) {\n          saveToken(notification.regid);\n          // alert('registration ID = ' + notification.regid);\n        }\n        break;\n\n      case 'message':\n        notifyService.toast('message = ' + notification.message);\n        switch(notification.collapse_key) {\n         case 'new_order':\n           $rootScope.$broadcast('new_order', notification.payload);\n           break;\n         case 'do_not_collapse':\n           break\n      }\n        break;\n\n      case 'error':\n        alert('GCM error = ' + notification.msg);\n        break;\n\n      default:\n        alert('An unknown GCM event has occurred');\n        break;\n    }\n  });\n\n  // WARNING: dangerous to unregister (results in loss of tokenID)\n //  $cordovaPush.unregister(options).then(function(result) {\n //    // Success!\n //  }, function(err) {\n //    // Error\n //  })\n\n  function saveToken(token) {\n    var data = { notification_token: {token: token}};\n    $http.post(CONFIG.API_URL + '/notification_tokens', data).then( function(response) {\n      notifyService.log({messageService_saveToken: 'sucess', response_data: response.data});\n    },\n    function (error) {\n      notifyService.log({messageService_saveToken: 'error', error: error});\n    });\n  };\n});\nHERE_DOC\n\n# add where you want to update data, something like\n# +  $scope.$on('new_order', function(event, args) {\n# +    notifyService.log({orderController_new_order: args});\n# +    getOrders();\n</code></pre></div></div>\n\n<p>This is usefull notification service since <code class=\"highlighter-rouge\">$log.debug object</code> does not work.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// www/js/services/notify.service.js\nangular.module('starter')\n.service('notifyService', function($cordovaToast, $log) {\n  this.toast = function(message) {\n    var text = message;\n    if (typeof message === 'object')\n    {\n      text = JSON.stringify(message);\n    }\n    if (window.plugins &amp;&amp; window.plugins.toast)\n    {\n      $cordovaToast.show(text, 'long', 'center');\n    }\n    else\n    {\n      alert(text);\n    }\n    $log.debug(text);\n  };\n\n  this.alert = function(message) {\n    // alert stays always as opposite to toast which hides automatically\n    var text = message;\n    if (typeof message === 'object')\n    {\n      text = JSON.stringify(message);\n    }\n    alert(text);\n    $log.debug(text);\n  };\n\n  this.log = function(message) {\n    var text = message;\n    if (typeof message === 'object')\n    {\n      text = JSON.stringify(message);\n    }\n    $log.debug(text);\n  }\n});\n</code></pre></div></div>\n\n<h1 id=\"service-workers\">Service workers</h1>\n\n<p>Another cool is service workers <a href=\"https://developers.google.com/web/fundamentals\">https://developers.google.com/web/fundamentals</a></p>\n"
    } ,
  
    {
      "title"    : "Neo4j Rails",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/05/22/neo4j-rails/",
      "date"     : "2016-05-22 00:00:00 +0200",
      "content"  : "<p>Thanks to the workshop I started using Neo4j</p>\n\n<h1 id=\"installing\">Installing</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>update-java-alternatives --list\nsudo apt install default-jre default-jre-headless\nsudo apt-get install openjdk-8-jdk\n\nwget -O - https://debian.neo4j.org/neotechnology.gpg.key | sudo apt-key add -\necho 'deb http://debian.neo4j.org/repo stable/' | sudo tee -a /etc/apt/sources.list.d/neo4j.list\nsudo apt update\nsudo apt install neo4j\nlynx localhost:7474/browser\n\nsudo neo4j start\n# sudo mkdir /var/run/neo4j # this is needed if permission denied\n# cat /etc/neo4j/neo4j.conf\n# cat /var/log/neo4j/neo4j.log\n# server will accepts connection on bolt://localhost:7687\n# user:password neo4j:neo4j but it has to be changed\n# reset password with: sudo rm /var/lib/neo4j/data/dbms/auth  or\n# sudo neo4j-admin set-initial-password ...\nsudo service neo4j status\nsudo service neo4j start\n</code></pre></div></div>\n\n<p>To enable remote access just uncomment the line</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/neo4j/neo4j.conf\ndbms.connectors.default_listen_address=0.0.0.0\n</code></pre></div></div>\n\n<p>For debugging you can also uncomment http logs so you can see if firewall is\nblocking</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/neo4j/neo4j.conf\n dbms.logs.http.enabled=true\n</code></pre></div></div>\n\n<p>Open browser on <a href=\"http://localhost:7474/\">http://localhost:7474/</a>\nSince communications is over http/bold, you need to create new neo4j instance\nfor each your project and environment. Use\n<a href=\"https://github.com/cohesivestack/ineo\">https://github.com/cohesivestack/ineo</a> and install with the script</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ineo instances\nineo status\nineo create -v 3.1.0 -p 7004 my_app_development\nineo create -p7006 my_app_test\nineo set-port my_app_development 7000 # this will change only http port\nineo destroy my_app_test\nineo delete-db my_app_test # this will clear only database\nineo versions\n</code></pre></div></div>\n\n<p>But I think <a href=\"https://stackoverflow.com/questions/43344087/neo4jmigrationerror-duplicate-constraint-for-person/47485163#47485163\">bolt is not supported</a></p>\n\n<p>Alternativelly you can use <a href=\"https://github.com/neo4jrb/neo4j-rake_tasks\">https://github.com/neo4jrb/neo4j-rake_tasks</a>. Add\n<code class=\"highlighter-rouge\">gem 'neo4j-rake_tasks'</code>. Note that there is no authentication enabled so do not\nuse on production.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># install neo4j to db/neo4j/development`\nrake neo4j:install[community-latest,development]\nrake neo4j:install[community-latest,test]\n\n# To change the server port (default is 7474) type:\nrails neo4j:config[development,$(expr $NEO4J_BOLT_PORT + 2)]\nrails neo4j:config[test,$(expr $NEO4J_TEST_BOLT_PORT + 2)]\n\n# vi db/neo4j/development/conf/neo4j.conf\n# this will add something like this\n# Bolt connector\ndbms.connector.bolt.enabled=true\n#dbms.connector.bolt.tls_level=OPTIONAL\ndbms.connector.bolt.listen_address=localhost:7040\n\n# HTTP Connector. There must be exactly one HTTP connector.\ndbms.connector.http.enabled=true\ndbms.connector.http.listen_address=localhost:7042\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rake neo4j:start[development]\necho http://localhost:$(expr $NEO4J_BOLT_PORT + 2)\nrake neo4j:start[test]\necho http://localhost:$(expr $NEO4J_TEST_BOLT_PORT + 2)\n\nrails neo4j:stop[development]\nkill -9 `cat db/neo4j/development/run/neo4j.pid`\n</code></pre></div></div>\n\n<p>Note that when you are changing the ports, then run <code class=\"highlighter-rouge\">spring stop</code> to reload new\nenv.</p>\n\n<p>Learn from examples in browser, type <code class=\"highlighter-rouge\">:play movies</code>.</p>\n\n<h1 id=\"cypher-commands\">Cypher commands</h1>\n\n<p><code class=\"highlighter-rouge\">:play_cypher</code></p>\n\n<ul>\n  <li>\n    <p>create node <code class=\"highlighter-rouge\">()</code> and relationship <code class=\"highlighter-rouge\">[]</code>. In CREATE only directed\nrelationships. Nodes can have 0 or more labels <code class=\"highlighter-rouge\">:Person</code> and can have different\nproperties (strings, numbers or booleans). Relationships always have a direction\nand have a single type (<code class=\"highlighter-rouge\">:KNOWS</code>) and also properties.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>CREATE (d:Covek { name: 'Dusan' }), (m:Covek { name: 'Milan' }),\n(s:Covek { name: 'Srdjan' }),\n(d)-[:TWIN_BRO]-&gt;(m),\n(m)-[:TWIN_BRO]-&gt;(s),\n(m)-[:BRO]-&gt;(s),\n(d)-[:BRO]-&gt;(s)\n</code></pre></div>    </div>\n  </li>\n  <li>RETURN matched nodes and relationships, WHERE filter and what to RETURN, with\neventual: LIMIT 10.\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>MATCH (n:Covek) WHERE n.name = 'Dusan' RETURN n;\n</code></pre></div>    </div>\n\n    <ul>\n      <li>match relationships by type <code class=\"highlighter-rouge\">[edge:BRO]</code>. You can write long edges\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>MATCH (n)-[:BRO]-&gt;()&lt;-[:BRO]-(m) RETURN n, m\n</code></pre></div>        </div>\n      </li>\n      <li>instead writting two edges <code class=\"highlighter-rouge\">MATCH (n)-[]-&gt;(t), (t)-[]-&gt;(m)</code> you can write\nnumber of edges <code class=\"highlighter-rouge\">[*2]</code> or even interval of number <code class=\"highlighter-rouge\">[*1..4]</code></li>\n      <li>if direction is ommited it will return twice (one in both directions)\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>MATCH (n)-[:BRO]-(m) RETURN n, m;\n</code></pre></div>        </div>\n      </li>\n      <li>WHERE can be moved inside node or edge declaration <code class=\"highlighter-rouge\">MATCH (n:Covek { name:\n'Dusan' }) RETURN n;</code> so WHERE is usualy used with <code class=\"highlighter-rouge\">WHERE NOT</code>. For example\ncocoautors which are not coauthors (not equal is <code class=\"highlighter-rouge\">&lt;&gt;</code>)</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>MATCH (tom:Person {name:\"Tom Hanks\"})-[:ACTED_IN]-&gt;(m)&lt;-[:ACTED_IN]-(coActors),\n      (coActors)-[:ACTED_IN]-&gt;(m2)&lt;-[:ACTED_IN]-(cocoActors)\nWHERE NOT (tom)-[:ACTED_IN]-&gt;()&lt;-[:ACTED_IN]-(cocoActors) AND tom &lt;&gt; cocoActors\nRETURN cocoActors.name AS Recommended, count(*) AS Strength ORDER BY Strength DESC\n</code></pre></div>    </div>\n\n    <ul>\n      <li>RETURN can be node or edge, <code class=\"highlighter-rouge\">Type()</code>, <code class=\"highlighter-rouge\">DISTINCT()</code>,</li>\n    </ul>\n  </li>\n  <li>\n    <p>delete all nodes for <code class=\"highlighter-rouge\">&gt;2.3.0</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>MATCH (n) DETACH DELETE n\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">EXPLAIN</code> and <code class=\"highlighter-rouge\">PROFILE</code> will give more info about query</li>\n</ul>\n\n<h1 id=\"neo4jrb\">Neo4jrb</h1>\n\n<p>Follow <a href=\"https://neo4j.com/developer/ruby-course/\">https://neo4j.com/developer/ruby-course/</a> to create example app\n<code class=\"highlighter-rouge\">asset_portal</code>, there is <a href=\"https://www.youtube.com/watch?v=n0P0pOP34Mw&amp;list=PL5klM3mD6alLUhNTPTbj5a3GBjU7oZN0t\">screen\ncast</a> episode 6 is advance\nand links\n<a href=\"https://gist.github.com/cheerfulstoic/3142ed2e15ad08ef6631\">https://gist.github.com/cheerfulstoic/3142ed2e15ad08ef6631</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails new asset_portal -m http://neo4jrb.io/neo4j/neo4j.rb -O\n# this will add gem neo4j and neo4j-rake_tasks\n# config/neo4j,yml\n# db/neo4j folder\n# config/application.rb uncomment server url with\nconfig.neo4j.session.type = :bolt\nconfig.neo4j.session.url = 'bolt://neo4j:dusan10@localhost:7687'\n\nrails generate scaffold User name:string email:string\nrails s\ngnome-open http://localhost:3000/users\n</code></pre></div></div>\n\n<p>Model are defined with <a href=\"http://neo4jrb.readthedocs.io/en/9.0.x/ActiveNode.html\">http://neo4jrb.readthedocs.io/en/9.0.x/ActiveNode.html</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class User\n  include Neo4j::ActiveNode\n  has_many :out, :assets, type: :OWNS\nend\n\nclass Asset\n  include Neo4j::ActiveNode\n  property :created_at, type: DateTime\n  property :updated_at, type: DateTime\n  has_one :in, :user, origin: :assets\nend\n</code></pre></div></div>\n\n<ul>\n  <li>properties are declared with <code class=\"highlighter-rouge\">property :name</code>. It can also define\n    <ul>\n      <li><code class=\"highlighter-rouge\">default: 'default_value'</code> is set when property is <code class=\"highlighter-rouge\">nil</code> so for new object\nit will be <code class=\"highlighter-rouge\">'default_value'</code>. For existing object you need to run migration</li>\n      <li><code class=\"highlighter-rouge\">type: Integer</code> define property type in ruby: integer, float, string, time,\ndate, datetime, boolean, BigDecimal. Istead of DateTime, if you need some\nexpensive query, better is to use <code class=\"highlighter-rouge\">type: Integer</code> and store as unix timestamp</li>\n      <li>I have some problems with <code class=\"highlighter-rouge\">serialize: :name</code> so I used plain old <code class=\"highlighter-rouge\">user.name\n= { a: 3}.to_json</code> so I save hash or array to database. When I load, I need\nto deserialize to that object <code class=\"highlighter-rouge\">JSON.parse user.name</code></li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">enum status: [:draft, :published]</code> maps integer in db to strings in rails\n    <ul>\n      <li>you can use <code class=\"highlighter-rouge\">user.draft!</code>, <code class=\"highlighter-rouge\">user.draft?</code> or <code class=\"highlighter-rouge\">User.draft</code></li>\n      <li><code class=\"highlighter-rouge\">_default: :draft</code> to define default value, note that default value is when\nvalue is NULL for existing objects, so better is to run migration\n(<code class=\"highlighter-rouge\">user.draft?</code> will return true even in neo4j it is NULL!!!) and you need to\nsave two times <code class=\"highlighter-rouge\">next unless user.draft? ; user.status = :published;\nuser.save! user.status = :draft; user.save!</code></li>\n      <li>usually you need to add index on enum column but you can disable <code class=\"highlighter-rouge\">_index:\nfalse</code></li>\n      <li>validation like <code class=\"highlighter-rouge\">validates :name, presence: true</code>, or\n<code class=\"highlighter-rouge\">validates_uniqueness_of :name</code></li>\n      <li>you can pass undeclared properties if you insert the line <code class=\"highlighter-rouge\">include\nNeo4j::UndeclaredProperties</code></li>\n    </ul>\n  </li>\n  <li>relationship: <code class=\"highlighter-rouge\">has_many :in, :posts</code>\n    <ul>\n      <li>first parameter can be <code class=\"highlighter-rouge\">:in</code>, <code class=\"highlighter-rouge\">:out</code>, <code class=\"highlighter-rouge\">:both</code>. Once it is created, you\nshould not change it (unless you write data migration)</li>\n      <li>second set the association name (can be overriden with <code class=\"highlighter-rouge\">:model_class</code> and\nassociation name <code class=\"highlighter-rouge\">:type</code>)</li>\n      <li><code class=\"highlighter-rouge\">has_one</code> should be used with singular and <code class=\"highlighter-rouge\">.first</code> is automatically called\nso result is non chainable (unless you call <code class=\"highlighter-rouge\">comment.post(chainable: true)</code></li>\n      <li><code class=\"highlighter-rouge\">:type</code> override association name in Neo4j (Rails uses asociation name).\n<code class=\"highlighter-rouge\">type: false</code> match all relationships</li>\n      <li><code class=\"highlighter-rouge\">:model_class</code> is NODE model on other end of association, usualy resolved\nfrom second parametar - association name, <code class=\"highlighter-rouge\">model_class: false</code> will match any\nnode on other end. Value can be a symbol with class name: <code class=\"highlighter-rouge\">model_class:\n:Asset</code>, or can be array in case of polymorphic association <code class=\"highlighter-rouge\">has_many :in,\n:written_post_or_comments, type: :WROTE, model_class: [:Post, :Comment]</code>.\nWhen using polymorphic than chains will not work unless <code class=\"highlighter-rouge\">proxy_as</code> and\n<code class=\"highlighter-rouge\">query_as</code> are used</li>\n    </ul>\n    <p><a href=\"http://neo4jrb.readthedocs.io/en/9.0.x/ActiveNode.html#polymorphic-associations\">http://neo4jrb.readthedocs.io/en/9.0.x/ActiveNode.html#polymorphic-associations</a></p>\n    <ul>\n      <li><code class=\"highlighter-rouge\">:rel_class</code> is REL model</li>\n      <li><code class=\"highlighter-rouge\">:origin</code> name of association in oposite model so you don’t need to\nwrite <code class=\"highlighter-rouge\">:type</code> in both classes, often used in <code class=\"highlighter-rouge\">:in</code> relationships. Value is the\nassociation name in reciprocal model, <code class=\"highlighter-rouge\">origin: :user</code></li>\n      <li><code class=\"highlighter-rouge\">dependent: delete</code> to delete all associated nodes in cypher\n(<code class=\"highlighter-rouge\">:destroy</code> will call <code class=\"highlighter-rouge\">.each</code> and <code class=\"highlighter-rouge\">.destroy</code> with callbacks).\n<code class=\"highlighter-rouge\">:delete_orphans</code> delete associated records that have no other relationships\nof the same type (<code class=\"highlighter-rouge\">:destroy_orphans</code> do that in Ruby and callbacks will be\ncalled).</li>\n      <li><code class=\"highlighter-rouge\">unique: true</code> will use <code class=\"highlighter-rouge\">CREATE UNIQUE</code> relationship (only one). <code class=\"highlighter-rouge\">unique:\n:all</code> will create unless all nodes, type, direction and rel properties are\nmatched. <code class=\"highlighter-rouge\">unique: { on: [keys] }</code> is looking only on keys to determine if\nalready exists.</li>\n      <li>eager loading is implicit, but if you need explicit you can use\n<code class=\"highlighter-rouge\">.with_associations(:tags, :comments)</code> to generate <code class=\"highlighter-rouge\">COLLECT()</code>. For nested you\ncan use hash and array notation: https://github.com/duleorlovic/premesti.se/blob/master/app/controllers/admin/users_controller.rb#L7\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@users = User.all.with_associations moves: { from_group: [:location], to_groups: [:location] }\n</code></pre></div>        </div>\n      </li>\n    </ul>\n\n    <p>CRUD associations</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Comment.create post: post1, text: 'text'   # create comment and relationship\npost.comments &lt;&lt; comment3             # Creates new relationship\npost.comments.create comment3, posted_by: 'me' # text property on relationship\n# can not create like post1.comments.new text: '' since comment.post will not\n# be defined\n\n# remove association\nhttps://github.com/neo4jrb/neo4j/wiki/Neo4j%3A%3ARails-Persistence#destroy-and-delete\npost.comments = [comment1, comment2]  # Removes all existing relationships\ncomment.post = post1                  # Removes all existing relationships\npost.comments.delete(comment) # destroys the relationship\npost.comments.find(comment).delete # destroys the relationship and node\n\n# update nodes\npost.comments.update_all flagged: true\n# update relationships\npost.comments.update_all_rels flagged: true\n\n# iterate over relationships\npost.comments.each_rel.map &amp;:neo_id\npost.comments.each_with_rel { |node, rel| }\n\n# you can combine several associations\npost.comments.user.company # will return all companies for comments\n\n# find does not work if argument is AssociationProxy so you should use map\n# &amp;:uuid\n# find_by or where has some problem if argument is array, so I use another\n# association and find [ids]\nto_location = move.to_groups.where(location: some_locations)\nto_location = move.to_groups.location.find(some_location.map(&amp;:uuid)).first\n\n# custom query_as match pluck\npost.query_as(:p).match('(p)-[rel1:CONTAINS]-&gt;(n2)').where('rel1.on = true').pluck(:rel1)\n\n# with_associations and order\n@users = User.as(:u)\n         .with_associations(moves: { from_group: [:location], to_groups: [:location] })\n         .order('u.last_sign_in_at DESC')\n\n# to find nodes that does not have relationship\nMove.query_as(:m).match('(m)').where('NOT (m)-[:WANTS]-()').pluck :m\n# to find nodes that does not have relation with EmailMessage with specific\n# property tag=some_tag\nUser.query_as(:user).where(\"NOT (user)-[:RECEIVED]-(:EmailMessage { tag: '#{tag}'})\").pluck(:user)\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>when comment is destroyed than you can not get it’s post, it is better to get\nit’s post before</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def destroy\n  post = @comment.post\n  @comment.destroy\n  redirect_to post_path post\nend\n</code></pre></div>    </div>\n  </li>\n  <li>callbacks like <code class=\"highlighter-rouge\">before_save</code></li>\n</ul>\n\n<p>Relationships is defined <a href=\"http://neo4jrb.readthedocs.io/en/9.0.x/ActiveRel.html\">http://neo4jrb.readthedocs.io/en/9.0.x/ActiveRel.html</a>\nType name will be the same as class name uppercased (<code class=\"highlighter-rouge\">:KNOWS</code>)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Knows\n  include Neo4j::ActiveRel\n  from_class :user\n  to_class :any\n  property :created_at, type: DateTime\n  property :updated_at, type: DateTime\n  creates_unique\nend\n\n# create\nKnows.create from_node: u, to_node: u\n# fetch retreive\nu.users.each_rel.to_a\nu.users.each_with_rel.to_a\n\n</code></pre></div></div>\n\n<ul>\n  <li>it is not able to access relationships directly, always using a node</li>\n  <li>properties are the same as for nodes</li>\n  <li>usefull for polymophic, for example User knowns companies, places, … so it\ncontains different logic for each relation.</li>\n</ul>\n\n<h1 id=\"schema\">Schema</h1>\n\n<p><a href=\"http://neo4j.com/docs/developer-manual/current/cypher/schema/constraints/\">http://neo4j.com/docs/developer-manual/current/cypher/schema/constraints/</a></p>\n\n<p>Index and constraints are defined in migrations. To generate use\n‘rake neo4j:generate_schema_migration[<code class=\"highlighter-rouge\">index|constraint</code>,<code class=\"highlighter-rouge\">Label</code>,<code class=\"highlighter-rouge\">property</code>]’\nfor example:\n<code class=\"highlighter-rouge\">rake neo4j:generate_schema_migration[constraint,Person,uuid]</code> will generate\n<a href=\"http://neo4j.com/docs/developer-manual/current/cypher/schema/constraints/\">http://neo4j.com/docs/developer-manual/current/cypher/schema/constraints/</a>\n<a href=\"https://github.com/neo4jrb/neo4j/blob/5e0127f4bb3f3b523cf3f5a515f36e0468c287c5/docs/Migrations.rst#add_constraint\">https://github.com/neo4jrb/neo4j/blob/5e0127f4bb3f3b523cf3f5a515f36e0468c287c5/docs/Migrations.rst#add_constraint</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class ForceCreatePersonUuidConstraint &lt; Neo4j::Migrations::Base\n  def up\n    add_constraint :Person, :uuid, force: true\n  end\n\n  def down\n    drop_constraint :Person, :uuid\n  end\nend\n</code></pre></div></div>\n\n<p><a href=\"https://github.com/neo4jrb/neo4j/blob/master/lib/neo4j/migrations/helpers/schema.rb#L12\">code</a>\nThis will add uniqueness constrain <code class=\"highlighter-rouge\">ASSERT person.uuid IS UNIQUE</code>, I think in\n<a href=\"https://github.com/neo4jrb/neo4j-core/blob/master/lib/neo4j/label.rb#L43\">neo4j-core</a>\nimplement that. I see in <code class=\"highlighter-rouge\">:schema</code> that we alse got a index.</p>\n\n<p>Not sure how to generate existence <code class=\"highlighter-rouge\">ASSERT exists(person.uuid)</code> constraint.</p>\n\n<p><a href=\"http://neo4j.com/docs/developer-manual/current/cypher/schema/index/\">http://neo4j.com/docs/developer-manual/current/cypher/schema/index/</a>\nAlso you can <code class=\"highlighter-rouge\">add_index :Person, :email, force: true</code>.\nRun migrations with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rake neo4j:migrate\n</code></pre></div></div>\n\n<p>Or use my shortcut <code class=\"highlighter-rouge\">rake db:migrate</code>, <code class=\"highlighter-rouge\">RAILS_ENV=test rake db:drop</code> and <code class=\"highlighter-rouge\">rake\ndb:seed</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># lib/tasks/db.rake\nnamespace :db do\n  desc 'seed'\n  task seed: :environment do\n    b = {}\n    # User\n    [\n      { var: :user1, email: 'asdf1@asdf.asdf' },\n      { var: :user2, email: 'asdf2@asdf.asdf' },\n      { var: :user3, email: 'asdf3@asdf.asdf' },\n    ].each do |doc|\n      params = doc.except(:var).merge(name: doc[:var])\n      user = User.find_by params\n      unless user.present?\n        user = User.create! params.merge(password: 'asdfasdf', confirmed_at: Time.zone.now)\n        puts \"User #{user.email}\"\n      end\n      b[doc[:var]] = user if doc[:var]\n    end\n\n    # Location\n    [\n      { var: :location1 },\n      { var: :location2 },\n      { var: :location3 },\n      { var: :location4 },\n      { var: :location5 },\n    ].each do |doc|\n      params = doc.except(:var).merge(name: doc[:var])\n      location = Location.find_by params\n      if location.blank?\n        location = Location.create! params\n        puts \"Location #{location.name}\"\n      end\n      b[doc[:var]] = location if doc[:var]\n    end\n\n    # Group\n    [\n      { var: :g2_l1, location: b[:location1], age_min: 2,\n        age_max: 2 },\n      { var: :g2_l2, location: b[:location2], age_min: 2,\n        age_max: 2 },\n      { var: :g2_l3, location: b[:location3], age_min: 2,\n        age_max: 2 },\n      { var: :g2_l4, location: b[:location4], age_min: 2,\n        age_max: 2 },\n      { var: :g2_l5, location: b[:location5], age_min: 2,\n        age_max: 2 },\n      { var: :g4_l1, location: b[:location1], age_min: 4,\n        age_max: 4 },\n    ].each do |doc|\n      params = doc.except(:var).merge(name: doc[:var])\n      group = Group.find_by params\n      unless group.present?\n        group = Group.create! params\n        puts \"Group #{group.name}\"\n      end\n      b[doc[:var]] = group if doc[:var]\n    end\n\n    # Move\n    [\n      { var: :m1_l1_l2, from_group: b[:g2_l1], prefered_groups: b[:g2_l2],\n        user: b[:user1] },\n      { var: :m1_l1_l3, from_group: b[:g2_l1], prefered_groups: b[:g2_l3],\n        user: b[:user1] },\n      { var: :m2_l3_l4, from_group: b[:g2_l3], prefered_groups: b[:g2_l4],\n        user: b[:user2], available_from_date:\n        Date.today.end_of_month },\n      { var: :m3_l4_l1, from_group: b[:g2_l4], prefered_groups: b[:g2_l1],\n        user: b[:user3], }\n    ].each do |doc|\n      params = doc.except(:var).merge(name: doc[:var])\n      move = Move.find_by params\n      unless move.present?\n        move = Move.create! params\n        puts \"Move #{move.name}\"\n      end\n    end\n  end\n\n  desc 'drop'\n  task drop: :environment do\n    Rake::Task[\"neo4j:stop\"].invoke Rails.env\n    puts sh \"rm -rf db/neo4j/#{Rails.env}/data/databases/graph.db\"\n    Rake::Task[\"neo4j:start\"].invoke Rails.env\n    puts \"Find database on http://\" +\n         Rails.application.secrets.neo4j_host.to_s + \":\" +\n         (Rails.application.secrets.neo4j_bolt_port.to_i + 2).to_s\n  end\n\n  desc 'migrate'\n  task migrate: :environment do\n    puts \"running neo4j:migrate\"\n    Rake::Task[\"neo4j:migrate\"].invoke Rails.env\n  end\n\n  desc 'setup = drop, migrate and seed'\n  task setup: :environment do\n    puts 'this is not implemented'\n    puts 'since drop need some time to bootup, and migrate raises exception'\n  end\nend\n</code></pre></div></div>\n\n<p>In migration <code class=\"highlighter-rouge\">def change</code> should be replaced with <code class=\"highlighter-rouge\">def up</code> and <code class=\"highlighter-rouge\">def down</code> since\nthere is an error:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rake aborted!\nNotImplementedError: NotImplementedError\n</code></pre></div></div>\n\n<p>If using the bold, in migrations there are exception\n<a href=\"https://github.com/neo4jrb/neo4j-core/issues/303\">https://github.com/neo4jrb/neo4j-core/issues/303</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rake aborted!\nshould be implemented!\n</code></pre></div></div>\n\n<p>Test data should be wiped manually\n<a href=\"http://neo4jrb.readthedocs.io/en/8.0.x/Miscellany.html#cleaning-your-database-for-testing\">http://neo4jrb.readthedocs.io/en/8.0.x/Miscellany.html#cleaning-your-database-for-testing</a>\nThere are attempts to use database_cleaner gem\n<a href=\"https://github.com/neo4jrb/neo4j/issues/1368\">https://github.com/neo4jrb/neo4j/issues/1368</a>\n<a href=\"https://github.com/DatabaseCleaner/database_cleaner/issues?utf8=%E2%9C%93&amp;q=Neo4j\">https://github.com/DatabaseCleaner/database_cleaner/issues?utf8=%E2%9C%93&amp;q=Neo4j</a>\n<a href=\"https://github.com/DatabaseCleaner/database_cleaner/pull/481/files\">https://github.com/DatabaseCleaner/database_cleaner/pull/481/files</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/test_helper.rb\nclass ActiveSupport::TestCase\n  # http://neo4jrb.readthedocs.io/en/8.0.x/Miscellany.html#cleaning-your-database-for-testing\n  teardown do\n    Neo4j::ActiveBase.current_session.query %(\n      MATCH (n)\n      WHERE NOT (n:`Neo4j::Migrations::SchemaMigration`)\n      DETACH\n      DELETE n\n    )\n  end\nend\n</code></pre></div></div>\n\n<p>In tests you can not use fixtures. Maybe raw cypher can help\nhttps://github.com/neo4jrb/neo4j/issues/611</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    query = %(\n      CREATE (c:City),\n      (l_a:Location),\n      (l_b:Location),\n      (l_a)-[:IN_CITY]-&gt;(c),\n      (l_b)-[:IN_CITY]-&gt;(c),\n    )\n    Neo4j::ActiveBase.current_session.query query\n</code></pre></div></div>\n\n<p>but best advice to use factory girl.</p>\n\n<h1 id=\"query\">Query</h1>\n\n<p>Debug with <code class=\"highlighter-rouge\">user.assets.categories.assets.print_cypher</code> or some query <code class=\"highlighter-rouge\">move.query_as(:m1).match('(m1)-[]-(g:Group)').to_cypher</code> (similar <code class=\"highlighter-rouge\">to_sql</code>)</p>\n\n<p>Query on property <code class=\"highlighter-rouge\">User.where(name: ?)</code> parametar <code class=\"highlighter-rouge\">?</code> can be: string, nil,\narray, regular expression <code class=\"highlighter-rouge\">User.where(name: /.*dule.*/i)</code>, range\n<code class=\"highlighter-rouge\">User.where(age: 1..2)</code>.</p>\n\n<p>If you use params inside where string you should use params to excape and\nprevent injection attack https://github.com/neo4j/neo4j/issues/1983\nhttps://neo4jrb.readthedocs.io/en/5.2.x/Querying.html#parameters</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Location.query_as(:location).where(\"location.name_en =~ {name_en}\").params(name_en: \"(?iu).*#{@term}.*\").pluck(:location)\n</code></pre></div></div>\n\n<p>There is <code class=\"highlighter-rouge\">neo_id</code> on each node and relationships but are somewhat volatile so do\nnot use it. Instead, each new node requires primary key <code class=\"highlighter-rouge\">uuid</code> property which is\nalso accessed using <code class=\"highlighter-rouge\">.id</code> method. Rels do not have ids since they are traversed\nby nodes. SecureRandom uuid is generated in migration <code class=\"highlighter-rouge\">rake\nneo4j:generate_schema_migration[constraint,Model,uuid]</code> and <code class=\"highlighter-rouge\">rake neo4j:migrate</code></p>\n\n<p>Raw query can be done using <code class=\"highlighter-rouge\">Neo4j::ActiveBase.current_session.query('MATCH (n)\nRETURN n LIMIT {limit}', limit: 10)</code> or when searching for maximum</p>\n\n<p>But it is better to use <code class=\"highlighter-rouge\">ActiveNode</code> finders:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># find by id_property\nUser.find my_uuid\n# find by any property property\nUser.find_by name: 'Dule'\n# find by associations\nUser.find_by from_group: Group.last\n# find_by supports only single value even it is has_many\nUser.find_by to_groups: Group.last\n# you can use where with associations\nUser.all.where to_groups: Group.last\n</code></pre></div></div>\n\n<p>Queries can be chained in 3 ways: <code class=\"highlighter-rouge\">Model.all</code>, <code class=\"highlighter-rouge\">Model.association</code>,\n<code class=\"highlighter-rouge\">model_object.association</code>. It returns <code class=\"highlighter-rouge\">AssociationProxy</code>.</p>\n\n<p>If <code class=\"highlighter-rouge\">where</code> is used, than <code class=\"highlighter-rouge\">QueryProxy</code> is returned.</p>\n\n<p>Query object is used to simplify on which fields is used:\n<code class=\"highlighter-rouge\">User.query_as(:user).where(user: { age: 1..2 }).pluck(:user)</code></p>\n\n<p>You can use <code class=\"highlighter-rouge\">where</code> or <code class=\"highlighter-rouge\">rel_where</code> in the middle of a chain (it is applied to\nlast) for example <code class=\"highlighter-rouge\">user.created_assets.where(public: true).categories</code>.\nAlso <code class=\"highlighter-rouge\">.order</code>, <code class=\"highlighter-rouge\">.limit</code> and <code class=\"highlighter-rouge\">.skip</code>.\nYou can pass single attribute to assign variable in cypher, so we can pluck on\nit <code class=\"highlighter-rouge\">user.created_assets.categories(:category).pluck('category.name',\n'count(*)')</code></p>\n\n<p>Using <code class=\"highlighter-rouge\">where</code> can be with string or with hash. If you want to target specific\nnode you can use string like <code class=\"highlighter-rouge\">where(\"node.uuid = '#{n.id}'\")</code> or hash\n<code class=\"highlighter-rouge\">where(node: { neo_id: n.id })</code>, or using parms <code class=\"highlighter-rouge\">where('node.uuid =\n{node_id}').params(node_id: n.id)</code> or <code class=\"highlighter-rouge\">match_nodes(node: n)</code>.\nNote that you have to use <code class=\"highlighter-rouge\">uuid</code> since <code class=\"highlighter-rouge\">id</code> in cypher does not exists. For a\nlist you do not need to wrap in square brackets <code class=\"highlighter-rouge\">where('node.uuid IN\n{node_ids}').params(node_ids: @nodes.map(&amp;:uuid))</code>.\nhttps://github.com/neo4jrb/neo4j-core/blob/8.0.x/spec/neo4j-core/unit/query_spec.rb#L373\nhttps://github.com/neo4jrb/neo4j-core/blob/8.0.x/spec/neo4j-core/unit/query_spec.rb#L474</p>\n\n<h1 id=\"regular-expression\">Regular expression</h1>\n\n<p>You can search with case insensitive regex\nhttps://neo4j.com/docs/developer-manual/current/cypher/clauses/where/#case-insensitive-regular-expressions</p>\n\n<h1 id=\"devise\">Devise</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem 'devise-neo4j'\nbundle\nrails g devise:install --orm=neo4j\nrails g neo4j:devise User\n</code></pre></div></div>\n\n<h1 id=\"heroku\">Heroku</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>export MYAPP_NAME=my-app # only dash, not underscore\nheroku apps:create $MYAPP_NAME\nheroku addons:create graphenedb\n\nheroku buildpacks:set https://github.com/heroku/heroku-buildpack-ruby\nheroku buildpacks:add --index 1 https://github.com/heroku/heroku-buildpack-nodejs\nheroku buildpacks # should return  1. nodejs  2. ruby (latest wins :)\n\nheroku config # copy all GRAPHENEDB_BOLT... variables\n# use http, not bolt port\nheroku config:set NEO4J_TYPE=https NEO4J_HOST= NEO4J_PORT= NEO4J_USERNAME= NEO4J_PASSWORD=\nheroku run rake db:migrate\nheroku run rake db:seed\n</code></pre></div></div>\n\n<p>You can export from Graphenedb <code class=\"highlighter-rouge\">graphdb.zip</code>\n<a href=\"https://docs.graphenedb.com/docs/importing-and-exporting-databases\">https://docs.graphenedb.com/docs/importing-and-exporting-databases</a>. To restore\nlocaly you need to copy files to <code class=\"highlighter-rouge\">neo4j/data/graph.db/</code></p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<p>Model your entity attribute as property on a node if</p>\n<ul>\n  <li>it is simple value and there is no need to qualify relationship.</li>\n</ul>\n\n<p>Otherwise:</p>\n<ul>\n  <li>use relationship to a new node instead of property of a node in cases where\nyou need to add another relationships to it. For example instead of property\n<code class=\"highlighter-rouge\">user_id</code> on relationship you should use <code class=\"highlighter-rouge\">User</code> node with <code class=\"highlighter-rouge\">:OWNS</code> relationship\nto it, since you will probably add another relation to that <code class=\"highlighter-rouge\">User</code></li>\n  <li>use relationship if there is a need to specify something relationship\n(for example <em>profiency in a skill</em>)</li>\n  <li>use relationship if its a complex property like multiple fields (address)\nSo rule is to use node if you need start a query from this entity like skill\nruby -&gt; users.</li>\n</ul>\n\n<p>Instead to name relationship with <code class=\"highlighter-rouge\">:BELONGS_TO</code> use something more meaningfull\nto businness so you know what it is about:</p>\n<ul>\n  <li>something belongs to Category use <code class=\"highlighter-rouge\">something-[:IN_CATEGORY]-&gt;category</code></li>\n  <li>for review <code class=\"highlighter-rouge\">[:REVIEW_FOR]</code>.</li>\n  <li>For has_many use verb <code class=\"highlighter-rouge\">()-[:POSTS]-&gt;(:Post)</code>, or <code class=\"highlighter-rouge\">[:CONTAINS]</code>, <code class=\"highlighter-rouge\">[:USING]</code>,\n<code class=\"highlighter-rouge\">[:MENTIONS]</code></li>\n  <li>For has_and_belongs_to_many use whatever <code class=\"highlighter-rouge\">(:User)-[:FRIENDS]-&gt;(:User)</code>, <code class=\"highlighter-rouge\">(Tweet)-[:RETWEETS]-&gt;(:Tweet)</code></li>\n</ul>\n\n<p>Common Graph stuctures:</p>\n<ul>\n  <li>Intermediate Nodes: when when you have three or more entity in single context:\n‘Ian bought a book in Mercator’, ‘Patrick work at Trk in role Designer’ …</li>\n  <li>Linked List: entities are linked as sequence, you need to traverse:\n‘Job history’, ‘Broadcast or Production of Movies’</li>\n  <li>Versioning Graphs: time based\n    <ul>\n      <li>structure: we have idendtity nodes as placeholders and timestamped\nrelationships.</li>\n      <li>state: every note is snapshot,</li>\n    </ul>\n  </li>\n  <li>ignore case is with <code class=\"highlighter-rouge\">(?i)</code> but for cyrilic we need <code class=\"highlighter-rouge\">(?iu)</code>, for example <code class=\"highlighter-rouge\">MATCH\n(d:Covek) WHERE d.nameL =~ '(?iu).*DUŠAN.*' RETURN d</code> https://github.com/neo4j/neo4j/issues/1983</li>\n</ul>\n\n<h1 id=\"errors\">Errors</h1>\n\n<p>Error <code class=\"highlighter-rouge\">defined for a second time. Associations can only be defined once</code> is when\nyou name the associataion with already used name. Please use different name and\nsame model_class.</p>\n\n<p>In migration <code class=\"highlighter-rouge\">rails aborted!  Neo4j::MigrationError: Duplicate constraint for\nLocation</code> means that there exists in schema so you need to manually remove.\nYou can use <code class=\"highlighter-rouge\">:schema</code> or <code class=\"highlighter-rouge\">CALL db.constraints</code> to see all constrains and you can\ndrop with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>DROP CONSTRAINT ON (l:Location) ASSERT l.uuid IS UNIQUE\n</code></pre></div></div>\n\n<p>To wipe all data, destroy clear database, remove graph.db and restart.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rake neo4j:stop[development]\nrm -rf db/neo4j/development/data/databases/graph.db\nrake neo4j:start[development]\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">ArgumentError: Invalid value for 'city' condition</code> is error in seed task when\nyou assign symbol <code class=\"highlighter-rouge\">:city1</code> instead of object <code class=\"highlighter-rouge\">b[:city1]</code></p>\n\n<p>If you open <code class=\"highlighter-rouge\">rails c</code> console1 and than <code class=\"highlighter-rouge\">rails c</code> console2, and <code class=\"highlighter-rouge\">exit</code> in\nconsole1, it will not exit. You need to <code class=\"highlighter-rouge\">exit</code> console2 to release something and\nboth consoles exists… When rails console hangs than <code class=\"highlighter-rouge\">spring stop</code> helps.</p>\n\n<p>I got some error:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Neo4j::Core::CypherSession::CypherError (  Cypher error:\n  Neo.DatabaseError.Transaction.TransactionStartFailed: Database has encountered some problem, please perform necessary action (tx recovery/restart)\n):\n</code></pre></div></div>\n\n<p>For which I restart my machine to recover from this error.</p>\n\n<p>Error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Neo4j::DeprecatedSchemaDefinitionError:           Some schema elements were defined by the model (which is no longer supported), but they do not exist in the database.  Run the following to create them if you haven't already:\n\nrake neo4j:generate_schema_migration[constraint,Chat,uuid]\n\n\nAnd then run `rake neo4j:migrate`\n\n(zshell users may need to escape the brackets)\n</code></pre></div></div>\n\n<p>can be solved with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RAILS_ENV=test rake neo4j:migrate\nheroku run rake neo4j:migrate:status\n# try adding force: true so there is no error when performing migrations\nclass CreateChat &lt; Neo4j::Migrations::Base\n  def up\n    add_constraint :Chat, :uuid, force: true\n  end\n\n  def down\n    drop_constraint :Chat, :uuid\n  end\nend\n</code></pre></div></div>\n\n<p>Error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Neo4j::Core::CypherSession::CypherError:   Cypher error:\n  Neo.DatabaseError.Transaction.TransactionStartFailed: The database has encountered a critical error, and needs to be restarted. Please see database logs for more details.\n</code></pre></div></div>\n\n<p>There is a problem when there exists a node when searching by relation but does\nnot exists when searching by <code class=\"highlighter-rouge\">n.uuid</code></p>\n\n<h1 id=\"todo\">Todo</h1>\n\n<p><code class=\"highlighter-rouge\">rails g model</code> will generate model files with rubocop offencies</p>\n\n<p><code class=\"highlighter-rouge\">rails neo4j:migrate</code> event it is successfull, generate error message:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>should be implemented!\n</code></pre></div></div>\n<p><a href=\"https://github.com/neo4jrb/neo4j-core/issues/303\">https://github.com/neo4jrb/neo4j-core/issues/303</a></p>\n\n<p>device-neo4j generate two migrations with same id… Best solution is to rename\nmigration and clear database.</p>\n\n<p>Errors format should be used:</p>\n\n<h1 id=\"dump\">Dump</h1>\n\n<p>On Heroku GrapheneDB in tab Admin -&gt; Export database, you can download\n<code class=\"highlighter-rouge\">graphdb.zip</code> and export to your graph.db folder</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>export GRAPH_DB_PATH=db/neo4j/development/data/databases/graph.db\nrm -rf $GRAPH_DB_PATH\nmkdir $GRAPH_DB_PATH\nunzip tmp/graphdb.zip -d $GRAPH_DB_PATH\nrails neo4j:restart[development]\n</code></pre></div></div>\n\n<p>To dump to production you need also to restart heroku</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>wget 'graphdb_url'\nmv graphdb.zip\nexport GRAPH_DB_PATH=/var/lib/neo4j/data/databases/graph.db\nsudo rm -rf $GRAPH_DB_PATH\nsudo -u neo4j mkdir $GRAPH_DB_PATH\nsudo -u neo4j unzip graphdb.zip -d $GRAPH_DB_PATH\nsudo service neo4j restart\nheroku restart\ntail -f /var/log/neo4j/debug.log\n</code></pre></div></div>\n\n<p>To make a backup you can</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># we have to cd to directory because otherwise zip will store path in output\ncd db/neo4j/development/data/databases/graph.db/\nzip -r ../backup.zip .\n</code></pre></div></div>\n\n<h1 id=\"links\">Links</h1>\n\n<ul>\n  <li>http://neo4jrb.io/ and differences with sql http://neo4j.com/product/</li>\n  <li>http://neo4jrb.readthedocs.io/en/7.0.x/</li>\n  <li>youtube series https://www.youtube.com/watch?v=n0P0pOP34Mw</li>\n  <li>https://devchat.tv/ruby-rogues/236-rr-neo4j-with-brian-underwood</li>\n</ul>\n\n<p>Todo\nhttps://youtu.be/78r0MgH0u0w 42min time versioned graphs\nhttps://youtu.be/AaJS-DGBQX4</p>\n"
    } ,
  
    {
      "title"    : "Echo Sed Grep command line editing",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/05/18/echo-sed-grep-command-line-editing/",
      "date"     : "2016-05-18 00:00:00 +0200",
      "content"  : "<h1 id=\"echo\">Echo</h1>\n\n<p><code class=\"highlighter-rouge\">echo -e \"\\n\" &gt;&gt; filename</code> will add new line (that’s why <code class=\"highlighter-rouge\">-e</code> to the\nfilename). You can use single quotes so you do not need to write <code class=\"highlighter-rouge\">-e</code> and <code class=\"highlighter-rouge\">\\n</code>\nin multiline text but you need to escape other <code class=\"highlighter-rouge\">'</code>. The best was to write\nmultiline text is with <code class=\"highlighter-rouge\">cat &gt; filename &lt;&lt; HERE_DOC ... some lines with ' or \"\n...  HERE_DOC</code>. First <code class=\"highlighter-rouge\">\\HERE_DOC</code> or <code class=\"highlighter-rouge\">'HERE_DOC'</code> when no parametar expanded.\nRemember to use double <code class=\"highlighter-rouge\">&lt;&lt;</code> not single <code class=\"highlighter-rouge\">&lt;</code> redirection. Inside <code class=\"highlighter-rouge\">HERE_DOC</code> there\nshould not be backtick  `` since it will be evaluated as shell command.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt; my.txt &lt;&lt; 'HERE_DOC'\nhere can be ' \" \\ / anything\nHERE_DOR\n</code></pre></div></div>\n\n<h1 id=\"sed\">Sed</h1>\n\n<p><code class=\"highlighter-rouge\">sed -i '/haus/a home' filename</code> will inplace (<code class=\"highlighter-rouge\">-i</code>) search for <em>haus</em> and\nappend <em>home</em> after that line (beside insert before <code class=\"highlighter-rouge\">i</code>, this could be <code class=\"highlighter-rouge\">a</code>\nappend, <code class=\"highlighter-rouge\">c</code> change matched line, <code class=\"highlighter-rouge\">d</code> delete matched line).\nMultiple lines need to have “\" at the end of line because only first line will\nbe used otherwise.\nWhen using double quotes you also need <code class=\"highlighter-rouge\">\\n</code> (last line should not put <code class=\"highlighter-rouge\">\\n\\ </code>\nbecause you probably do not want to insert blank new line).\nWith single quotes multiline <code class=\"highlighter-rouge\">echo ' ...'</code> does not need that new line character\n(last line should ends with <code class=\"highlighter-rouge\">'</code> because if you put on next line you will insert\nblank line).\nDouble backslash at beggining is needed so first line is properly indented.\nRemember that no char (even space) could be after last <code class=\"highlighter-rouge\">\\ </code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># double quotes need \\n, can close quote in new line, need double \\\\ at begging\nsed -i config/routes.rb -e \"/^end$/i \\\\\n  # root page\\n\\\n  root 'pages#home'\\\n\"\n\n# single quotes, no need for \\n\n# I do not like this because I need to use double quotes in ruby or ugly escape\nsed -i config/routes.rb -e '/^end$/i \\\n  # root page\\\n  root '\"'\"'pages#home'\"'\"'\\\n  root \"pages#home\"'\n</code></pre></div></div>\n\n<p>Most common usage is to add before some line, for example line begins with\n<code class=\"highlighter-rouge\">test</code>. If you need single quote <code class=\"highlighter-rouge\">'</code> for example <code class=\"highlighter-rouge\">'a'</code> than you need to use\nprefix <code class=\"highlighter-rouge\">$</code> and escape quote with single backslash ` \\ <code class=\"highlighter-rouge\">. You could also use\nstring concatenation: single with double quote string </code>’“‘a’”’<code class=\"highlighter-rouge\">.\nIf you need </code>\"<code class=\"highlighter-rouge\"> than put </code>\\”` so backslash survive bash command.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i config/secrets.yml -e $'/^test:/i \\\n  # aws s3\\\n  aws_bucket_name: &lt;%= ENV[\\'AWS_BUCKET_NAME\\'] %&gt;'\n</code></pre></div></div>\n\n<p>Instead of search, you can append on line numbers <code class=\"highlighter-rouge\">3,6aTEXT</code> or at the last line\n<code class=\"highlighter-rouge\">sed '$aTEXT_AT_END</code> (last line is <code class=\"highlighter-rouge\">$</code> or <code class=\"highlighter-rouge\">\"\\$\"</code> if <code class=\"highlighter-rouge\">\"</code> is used) or at first\nline</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i app/assets/stylesheets/application.scss -e '1i\\\n/*\\\n *= require rails_bootstrap_forms\\\n */'\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">sed 's/find/replace/g</code> will replace word <code class=\"highlighter-rouge\">find</code> with <code class=\"highlighter-rouge\">replace</code>.</p>\n\n<p>Brackets need to be escaped like <code class=\"highlighter-rouge\">\\(</code>, <code class=\"highlighter-rouge\">\\1</code> means first group, <code class=\"highlighter-rouge\">&amp;</code> means matched\ntext…\n<a href=\"http://www.thegeekstuff.com/2009/10/unix-sed-tutorial-advanced-sed-substitution-examples/\">tutorial</a>\nAdding <code class=\"highlighter-rouge\">,</code> and new <code class=\"highlighter-rouge\">text</code> after <code class=\"highlighter-rouge\">match</code> could be with <code class=\"highlighter-rouge\">sed\n's/\\(match.*\\)/\\1,\\ntext/</code></p>\n\n<p>Sed has something different regular expressions so follow this <a href=\"http://www.gnu.org/software/sed/manual/html_node/Regular-Expressions.html\">link</a></p>\n\n<p>When you want to change chars (and not whole line) than you can use <code class=\"highlighter-rouge\">s/me/you/g</code>, or several regexp in same command for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed src/app/index.module.coffee \\\n  -e 's/, /,\\n  /g' \\\n  -e 's/  \\[/\\[\\n  /g' \\\n  -e 's/\\]/,\\n\\]/'\n</code></pre></div></div>\n\n<p>If you have a lot regexp, than its better to use <a href=\"http://tldp.org/LDP/abs/html/here-docs.html\">here-doc</a>\nand read from standard input <code class=\"highlighter-rouge\">-</code> <a href=\"https://unix.stackexchange.com/questions/45591/using-a-here-doc-for-sed-and-a-file/45592#45592?newreg=39c715cb752f44a9bba9b3f3f74f2015\">link</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed src/app/index.module.coffee -f - &lt;&lt;HERE_DOC\ns/, /,\\n  /g\ns/  \\[/\\[\\n  /g\ns/\\]/,\\n\\]/\nHERE_DOC\n</code></pre></div></div>\n\n<p>Note that all commands one per line. As with <code class=\"highlighter-rouge\">sed ''</code> you need backslash for each line of multiline command.</p>\n\n<p>When you really need to add multiline template\nand don’t want to escape <code class=\"highlighter-rouge\">'</code> and to add “\" to the end of each line, than you\ncan try following command <a href=\"https://stackoverflow.com/questions/26770426/use-sed-in-bash-to-replace-string-with-heredoc/26770678#26770678\">inspiration</a>\nwhich will replace new lines with <code class=\"highlighter-rouge\">ћ</code> (<code class=\"highlighter-rouge\">N</code> means multiline match, <code class=\"highlighter-rouge\">a</code> label… multiline match <code class=\"highlighter-rouge\">:a;N;$!ba;s/\\n/ћ/g</code>, note that <code class=\"highlighter-rouge\">$</code> needs to be escaped if inside <code class=\"highlighter-rouge\">\"\"</code>) and than return back new line.</p>\n\n<p>Quote in <code class=\"highlighter-rouge\">'HERE_DOC'</code> will not <a href=\"http://tldp.org/LDP/abs/html/here-docs.html#EX71C\">substitute\nparams</a> so <code class=\"highlighter-rouge\">$</code> <code class=\"highlighter-rouge\">/</code> or \\\nwill remain in here doc. Instead of <code class=\"highlighter-rouge\">&lt;&lt;</code> you can use <code class=\"highlighter-rouge\">&lt;&lt;-</code> and closing HERE_DOC\ncan be indented with <em>tab</em> character.  For regexp we need to escape <code class=\"highlighter-rouge\">/</code> and **\nwith <code class=\"highlighter-rouge\">\\/</code> and <code class=\"highlighter-rouge\">\\\\</code> (<code class=\"highlighter-rouge\">s:\\\\:\\\\\\\\:g;s:/:\\\\/:g</code>)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed src/app/index.module.coffee -e \"s/client/$(sed ':a;N;$!ba;s/\\n/ћ/g;s:\\\\:\\\\\\\\:g;s:/:\\\\/:g;' &lt;&lt;'HERE_DOC'\n    I'm \"$just\"\n    some long /'\\ multiline &lt;\\template&gt;.\nHERE_DOC\n)/g;s/ћ/\\n/g\"\n</code></pre></div></div>\n\n<p>Sometimes we need to add/replace line with template (not replace regexp)\nthan we need to move replacing <code class=\"highlighter-rouge\">s/#/\\n/g</code> outside of sed since it will\nnot be applied to new template.\nNote than we can’t use inline replacement but we can move tmp file.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed src/app/index.module.coffee -e \"/PLACEHOLDER/a $(sed ':a;N;$!ba;s/\\n/ћ/g;s:\\\\:\\\\\\\\:g;s:/:\\\\/:g;' &lt;&lt;'HERE_DOC'\n    I'm \"$just\"\n    some long /'\\ multiline &lt;\\template&gt;.\nHERE_DOC\n)\" | sed \"s/ћ/\\n/g\" &gt; tmp &amp;&amp; mv tmp src/app/index.module.coffee\n</code></pre></div></div>\n\n<p>Here is another solution which replace the PLACEHOLDER line\n<a href=\"https://stackoverflow.com/questions/26770426/use-sed-in-bash-to-replace-string-with-heredoc/26770678#26770678\">link</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt; /tmp/template &lt;&lt;\\HEREDOC\n    I'm \"$just\"\n    some long /'\\ multiline &lt;\\template&gt;.\nHERE_DOC\nsed -i myfile.rb -e '/PLACEHOLDER/ {\n  r /tmp/template\n  d\n}'\nrm /tmp/template\n</code></pre></div></div>\n\n<p>If you need <code class=\"highlighter-rouge\">sudo</code> than you can use <code class=\"highlighter-rouge\">tee</code> for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &lt;&lt; HERE_DOC | sudo tee -a /etc/systemd/system/mongodb.service\nHERE_DOC\n</code></pre></div></div>\n\n<h1 id=\"grep\">Grep</h1>\n\n<p>Just a few command line options with grep</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">grep pattern filename</code> so if you omit filename than standard input will be\nused, which is nice to test your big regex, for example <code class=\"highlighter-rouge\">asd &lt;&lt;</code> (exit with\nCtrl+d)\n    <ul>\n      <li><code class=\"highlighter-rouge\">grep \"asd &lt;&lt;\"</code></li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">grep -o 111</code> will output only matched parts (not whole possible big lines)</li>\n  <li><code class=\"highlighter-rouge\">grep -l asd</code> output only filenames</li>\n  <li>grep only specific file type is with <code class=\"highlighter-rouge\">grep asd --include \\*.yml</code> or with a\nfind command\n    <ul>\n      <li><code class=\"highlighter-rouge\">find . -name *.yml -exec grep asd {} \\;</code></li>\n    </ul>\n  </li>\n  <li>rename could be done with simple regex:\n    <ul>\n      <li><code class=\"highlighter-rouge\">rename 's/\\.in.html.erb/\\.html.erb/' app/views/*/*</code></li>\n      <li><code class=\"highlighter-rouge\">rename 's/\\.in.html.erb/\\.html.erb/' app/views/*/*/*</code> for nested folders</li>\n    </ul>\n  </li>\n  <li>if you want to output only matching group than it is better to use <code class=\"highlighter-rouge\">sed</code>\n    <ul>\n      <li><code class=\"highlighter-rouge\">sed -n 's/^.*[^0-9]\\([0-9][0-9]*\\).*/\\1/p'</code> get only numbers</li>\n      <li><code class=\"highlighter-rouge\">echo \"asd123\" | sed -n 's/asd/***/p'</code> replace asd with <code class=\"highlighter-rouge\">***</code></li>\n    </ul>\n  </li>\n  <li>exclude mathing with <code class=\"highlighter-rouge\">grep -v</code> that is invert match. This is usefull when you\nwan to exclude current grep for example <code class=\"highlighter-rouge\">ps aux | grep -v grep | grep\nmy-process</code></li>\n</ul>\n\n<h1 id=\"regex\">Regex</h1>\n\n<p><a href=\"https://regex101.com/\">https://regex101.com/</a> enable multiline flag if you are using <code class=\"highlighter-rouge\">$</code> end of line\n<a href=\"https://github.com/tom-lord/regexp-examples#usage\">https://github.com/tom-lord/regexp-examples#usage</a> to show matching examples</p>\n\n<ul>\n  <li>OR is with <code class=\"highlighter-rouge\">(|)</code>. But you need to escape <code class=\"highlighter-rouge\">|</code> for example: <code class=\"highlighter-rouge\">\\(asd\\|qwe\\)</code> lines\nthat contains asd or qwe. We need parentheses because alternator\noperator <code class=\"highlighter-rouge\">|</code> has the lowest precedence of all, so usually you want world\nboundaries like <code class=\"highlighter-rouge\">^([0-9]|[1-9][0-9])$</code> (0..99, but not 0asd, or asd9</li>\n  <li>contains asd but not qwe is <code class=\"highlighter-rouge\">asd((?!qwe).)*$</code>. Oposite for containing (does\nnot include) is using negative lookahead <code class=\"highlighter-rouge\">(?!____)</code> which asserts that this\ngroup does not match</li>\n  <li>contains <code class=\"highlighter-rouge\">asd</code> and <code class=\"highlighter-rouge\">qwe</code> but not <code class=\"highlighter-rouge\">zxc</code> in between <code class=\"highlighter-rouge\">asd((?!qwe).)*zxc</code></li>\n  <li>include end of line for multiline search, use matcher <code class=\"highlighter-rouge\">\\_.</code> finds any\ncharacter including end-of-line. Use <code class=\"highlighter-rouge\">\\n</code> for new line character for example\n<code class=\"highlighter-rouge\">asd(.|\\n)*&lt;div&gt;</code>. <code class=\"highlighter-rouge\">\\{-}</code> stopping at first occurence early short (<code class=\"highlighter-rouge\">*</code> is too\ngreedy, eager and would stop at last occurence). If you want ruby regex ignore\nnew line you can use modifier <code class=\"highlighter-rouge\">m</code>, like match all dl <code class=\"highlighter-rouge\">s.match /dl.*dl/m</code></li>\n  <li>to stop at first match use non greedy match, just add <code class=\"highlighter-rouge\">?</code> after <code class=\"highlighter-rouge\">?</code> or <code class=\"highlighter-rouge\">*</code>\nor <code class=\"highlighter-rouge\">+</code>, like\n<code class=\"highlighter-rouge\">registration_email.html_part.decoded.match(/(http:.*?confirmation.*?)\"/)[1]</code>\nto grab inside first next <code class=\"highlighter-rouge\">\"</code>.</li>\n  <li>to match all occurences yuo can use <code class=\"highlighter-rouge\">\"string\",scan /(.*?)/</code></li>\n  <li>to include matching delimiter when spliting in ruby, instead of\n<code class=\"highlighter-rouge\">content.split(/[?.!]/)</code> we can use a positive lookbehind regular expression\n(i.e. <code class=\"highlighter-rouge\">?&lt;=</code>) inside a parenthesis capture group to keep the delimiter at the\nend of each string <code class=\"highlighter-rouge\">content.split(/(?&lt;=[?.!])/)</code> https://stackoverflow.com/questions/18089562/how-do-i-keep-the-delimiters-when-splitting-a-ruby-string</li>\n  <li>match start of line with lowercase <code class=\"highlighter-rouge\">^[a-z]</code> (but one string could have\nmultiple lines). Better is to check start of string with lowercase <code class=\"highlighter-rouge\">\\A[a-z]</code> (in\nruby example) <code class=\"highlighter-rouge\">\"123\\ntest\".match /^[a-z]/</code> will return <code class=\"highlighter-rouge\">t</code>… (you can use\nalternative <code class=\"highlighter-rouge\">string.start_with? /^[a-z]/</code></li>\n  <li>repetative match is with <code class=\"highlighter-rouge\">{number}</code> like for example for numbers 000…999 use\n<code class=\"highlighter-rouge\">^[0-9]{3}$</code>. To find two or more spaces you can use <code class=\"highlighter-rouge\">\\s{2,}</code> so 2 is minimum\ncount of matching chars.</li>\n  <li>whitespace <code class=\"highlighter-rouge\">\\s</code>, word <code class=\"highlighter-rouge\">\\w</code> character</li>\n  <li><code class=\"highlighter-rouge\">\\A</code> start and <code class=\"highlighter-rouge\">\\z</code> end of string. That is better than <code class=\"highlighter-rouge\">^</code> (start of line) and\n<code class=\"highlighter-rouge\">$</code> (end of line) since that will match until a new line\n<code class=\"highlighter-rouge\">asd@asd.asd\\n&lt;script&gt;alert('danger')&lt;/script&gt;</code></li>\n  <li>replace groups of text with another text that use matching text, for example\nadd space if there is no space before MAC, <code class=\"highlighter-rouge\">'aMAC'.gsub /([^\\s])(MAC)/, '\\1\n\\2'</code></li>\n</ul>\n\n<p>When using grep, you can enable Per regexp PCRE with <code class=\"highlighter-rouge\">-P</code> or <code class=\"highlighter-rouge\">--per-regexp</code>.\nThat is needed for negative lookahead.\nWhen using <code class=\"highlighter-rouge\">-P</code> than no need to escape.</p>\n\n<p>In bash you need to escape <code class=\"highlighter-rouge\">()|\\</code> (for both single and double quotes).\nIn vim you also need to escape again (for both single and double quotes):\n<code class=\"highlighter-rouge\">grep '\\(asd\\\\|qwe\\)'</code> is the same as in vim <code class=\"highlighter-rouge\">:grep '\\\\(asd\\\\\\|qwe\\\\)'</code>. Note\nWhen using <code class=\"highlighter-rouge\">-P</code> than no need one escape (vim escape is still required).</p>\n\n<p>In vim <a href=\"http://vimdoc.sourceforge.net/htmldoc/pattern.html\">vim pattern</a> search\ninside buffer.</p>\n\n<p>Catastrophic Backtracking</p>\n\n<p>https://www.regular-expressions.info/catastrophic.html</p>\n\n<p>example in ruby is</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\"simple_captcha_valid?\".match /^([A-Za-z\\d*]+)+([\\w]*)+([A-Za-z\\d*]+)$/\n</code></pre></div></div>\n\n<h1 id=\"awk\">AWK</h1>\n\n<ul>\n  <li>split by one char: <code class=\"highlighter-rouge\">echo \"1:3\" | awk '{split($0,a,\":\");print a[1] a[2]}' # 13</code></li>\n  <li>split by multiple char: <code class=\"highlighter-rouge\">echo \"1:3x5\" | awk -F':|x' '{print $1 $2 $3}' # 135</code></li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Send and receive emails in rails",
      "category" : "",
      "tags"     : "rails, emails",
      "url"      : "/2016/05/17/send-and-receive-emails-in-rails/",
      "date"     : "2016-05-17 00:00:00 +0200",
      "content"  : "<h1 id=\"email-providers\">Email providers</h1>\n\n<p>There is nice table of <a href=\"http://socialcompare.com/en/comparison/transactional-emailing-providers-mailjet-sendgrid-critsend\">main\nproviders</a></p>\n\n<h2 id=\"testing-smtp\">Testing SMTP</h2>\n\n<p>If you need to test smtp use <a href=\"https://debugmail.io/\">https://debugmail.io/</a> free service, just use port\n9025 instead 25 since ISP is blocking 25.\nFor command line you can use <code class=\"highlighter-rouge\">swaks</code> like <code class=\"highlighter-rouge\">swaks --to duleorlovic@gmail.com\n--server $SERVER --port $PORT --auth-user $AUTH_USER --auth-password\n$AUTH_PASSWORD --auth-plaintext --auth-hide-password</code>\nso in autout you can see all telnet communications:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># generate base64 encoding\n# special characters need to have \\ in front\nperl -MMIME::Base64 -e 'print encode_base64(\"duleorlovic\\@gmx.com\");'\nperl -MMIME::Base64 -e 'print encode_base64(\"password\");'\n\ntelnet debugmail.io 9025\nEHLO main\nAUTH LOGIN\n&lt;paste encoded username&gt;\n&lt;paste encoded password&gt;\n\nctrl + ]\nctrl + d\n</code></pre></div></div>\n\n<p>If you want to inspect how rails action_mailer sends and receive tcp messages\nthan put byebug in net smtp class on line 940 <code class=\"highlighter-rouge\">get_response</code> <code class=\"highlighter-rouge\">recv_response</code>\n<code class=\"highlighter-rouge\">/home/orlovic/.rvm/rubies/ruby-2.3.3/lib/ruby/2.3.0/net/smtp.rb</code></p>\n\n<h2 id=\"gmail\">Gmail</h2>\n\n<p>Gmail smtp is the most easiest way to start</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/application.rb\n    config.action_mailer.smtp_settings = {\n      address: 'smtp.gmail.com',\n      port: 587,\n      domain: 'gmail.com',\n      authentication: 'plain',\n      enable_starttls_auto: true,\n      user_name: Rails.application.secrets.smtp_username,\n      password: Rails.application.secrets.smtp_password\n    }\n    config.action_mailer.delivery_method = :smtp\n\n# config/secrets.yml\n  smtp_username: &lt;%= ENV[\"SMTP_USERNAME\"] %&gt;\n  smtp_password: &lt;%= ENV[\"SMTP_PASSWORD\"] %&gt;\n</code></pre></div></div>\n\n<p>If you receive error <code class=\"highlighter-rouge\">SocketError: getaddrinfo: Name or service not known</code> than\nyou probably miss the <code class=\"highlighter-rouge\">address</code> field.\nIf there is error <code class=\"highlighter-rouge\">with EOFError: end of file reached</code> than you need to change\n<code class=\"highlighter-rouge\">domain</code> field (should not be <code class=\"highlighter-rouge\">localhost</code>, but the domain part of the sender\nemail, for example <code class=\"highlighter-rouge\">gmail.com</code>).</p>\n\n<p>If you see error in logs:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>2018-06-18T09:13:29.371621+00:00 app[web.1]: An error occurred when sending a notification using 'email' notifier. Net::SMTPAuthenticationError: 534-5.7.14 &lt;https://accounts.google.com/signin/continue?sarp=1&amp;scc=1&amp;plt=AKgnsbu5\n</code></pre></div></div>\n\n<p>You need to Allow less secure apps https://support.google.com/accounts/answer/6010255</p>\n\n<p>Sometimes you can send from your IP but not from Heroku IP address.</p>\n\n<h2 id=\"sendgrid\">Sendgrid</h2>\n\n<p>Sendgrid is simple to start on heroku. Just add new add-on free plan with\ncommands <code class=\"highlighter-rouge\">heroku addons:create sendgrid</code> and that will set up env keys.\n<code class=\"highlighter-rouge\">heroku config</code> you can find the keys and copy them to <code class=\"highlighter-rouge\">heroku config:set\nSMTP_USERNAME=asdasdasd SMTP_PASSWORD=asdasdasd</code>. It allows sending with <code class=\"highlighter-rouge\">from</code>\nfield any domain, but in gmail it shows that message is from: <code class=\"highlighter-rouge\">My Company\nsupport@example.com via sendgrid.me</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt; config/initializers/smtp.rb &lt;&lt; \\HERE_DOC\nActionMailer::Base.smtp_settings = {\n  :user_name =&gt; Rails.application.secrets.smtp_username,\n  :password =&gt; Rails.application.secrets.smtp_password,\n  :domain =&gt; 'yourdomain.com',\n  :address =&gt; 'smtp.sendgrid.net',\n  :port =&gt; 587,\n  :authentication =&gt; :plain,\n  :enable_starttls_auto =&gt; true\n}\nHERE_DOC\n</code></pre></div></div>\n\n<p>Another way is to use API</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n</code></pre></div></div>\n\n<h2 id=\"mandrill\">Mandrill</h2>\n\n<p>Mandrill is better than Sendgrid, since Sendgrid can not automatically convert\nhtml to txt mails. Also mandrill has nice API so you do not need background\njob to send a lot of emails quickly. To setup sending using API just run:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'mandrill_dm'\n\n# config/application.rb\nconfig.action_mailer.delivery_method = :mandrill\n\n# config/initializers/mandrill.rb\nMandrillDm.configure do |config|\n  config.api_key = Rails.application.secrets.mandrill_api_key\nend\n\n# config/secrets.yml\ndevelopment:\n  mandrill_api_key: &lt;%= ENV[\"MANDRILL_API_KEY\"] %&gt;\n</code></pre></div></div>\n\n<p>If you are using <code class=\"highlighter-rouge\">mandril_delivery</code> for ExceptionNotification than emails will\nlook scrambled, because generated html version will join all lines. Note that it\nwill trigger any webhooks that you have set up.</p>\n\n<h2 id=\"sparkpost\">Sparkpost</h2>\n\n<p>Sparkpost offer a lot of free usage (mandrill requires subscription) so\ncurrently it is my best option. You need first to validate your domain, so you\ncan send with <code class=\"highlighter-rouge\">from</code> field with that domain. You need also to</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo \"gem 'sparkpost_rails'\" &gt;&gt; Gemfile\n\nsed -i config/environments/production.rb -e '/^end$/i \\\n  config.action_mailer.delivery_method = :sparkpost'\n\ncat &gt; config/initializers/sparkpostrails.rb &lt;&lt; HERE_DOC\n# https://github.com/the-refinery/sparkpost_rails#additional-configuration\nSparkPostRails.configure do |c|\n  c.api_key = Rails.application.secrets.sparkpost_api_key\nend\nHERE_DOC\n\nsed -i config/secrets.yml -e '/^test:/i \\\n  # email provider\\\n  sparkpost_api_key: &lt;%= ENV[\"SPARKPOST_API_KEY\"] %&gt;'\n\nvi config/secrets.yml # update mailer_sender to match your domain\n</code></pre></div></div>\n\n<p>You can also use smtp with SPARK_POST but it is two times slower</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/application.rb\n    config.action_mailer.smtp_settings = {\n      address: 'smtp.sparkpostmail.com',\n      port: 587,\n      enable_starttls_auto: true,\n      user_name: 'SMTP_Injection',\n      password: Rails.application.secrets.sparkpost_api_key,\n    }\n    config.action_mailer.delivery_method = :smtp # sparkpost\n\ntime rails runner 'UserMailer.signup.deliver_now!' # ~5sec with smtp\ntime rails runner 'UserMailer.signup.deliver_now!' # ~2.5sec with sparkpost\n</code></pre></div></div>\n\n<h1 id=\"letter-opener-for-local-preview\">Letter opener for local preview</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i '/group :development do/a  \\\n  # open emails in browser\\\n  gem \"letter_opener\"' Gemfile\nsed -i '/^end$/i \\  config.action_mailer.delivery_method = :letter_opener' config/environments/development.rb \n</code></pre></div></div>\n\n<p>Note that email letter opener does not work when you run with <code class=\"highlighter-rouge\">rake jobs:work</code>,\nbut works when <code class=\"highlighter-rouge\">bin/delayed_job run</code> (Launchy works in both cases, this\ndifference is only for mailer).</p>\n\n<h1 id=\"interceptor\">Interceptor</h1>\n\n<p>When you need to test production emails localy, than you can set up interceptor\nso you receive all emails (and not real customer emails).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/interceptor.rb\nclass DevelopmentMailInterceptor\n  def self.delivering_email(message)\n    message.subject = \"#{message.to} #{message.subject}\"\n    message.to = Rails.application.secrets.mail_interceptor_email\n  end\nend\nif Rails.env.development?\n  ActionMailer::Base.register_interceptor(DevelopmentMailInterceptor)\nend\n\n# config/secrets.yml\n  mail_interceptop_email: &lt;%= ENV[\"MAIL_INTERCEPTOR_EMAIL\"] %&gt;\n</code></pre></div></div>\n\n<p>When you need to preview a lot of emails, its faster to use letter_opener gem.\nJust put in your Gemfile under development <code class=\"highlighter-rouge\">gem \"letter_opener\"</code> and in\n<em>config/environments/development.rb</em> <code class=\"highlighter-rouge\">config.action_mailer.delivery_method =\n:letter_opener</code>. Works when email is sent (even from ajax response or console).</p>\n\n<h1 id=\"style\">Style</h1>\n\n<p><a href=\"https://developers.google.com/gmail/design/css\">Official gmail styles</a> supports\n<code class=\"highlighter-rouge\">&lt;style&gt;</code> in head and media queries but when you forward email than css styles\nwill be gone. Better is to use gem which will copy and duplicate all styles from\nhead to inline styles and that will support more clients (not just gmail).</p>\n\n<p>For easier styling, you should use <em>roadie</em> gem that will generate all inline\nstyle from your head styles.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Attach css classes to emails\ngem 'roadie'\ngem 'roadie-rails'\n</code></pre></div></div>\n\n<p>You need to include mixing to each mailer (including in ApplicationMailer does\nnot help)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/mailers/my_mailer.rb\nclass MyMailer &lt; ActionMailer::Base\n  include Roadie::Rails::Automatic\nend\n\n# or include in ApplicaitionMailer and use roadie_mail\n\nclass ApplicationMailer &lt; ActionMailer::Base\n  include Roadie::Rails::Mailer\nend\n\nclass MyMailer &lt; ActionMailer::Base\n  def welcome(user)\n    roadie_mail to: user.email\n  end\nend\n</code></pre></div></div>\n\n<p>You can change template with <code class=\"highlighter-rouge\">mail to: 'my@email.com', template_name:\n'contact_form'</code></p>\n\n<p>Another solution is <code class=\"highlighter-rouge\">gem 'premailer-rails'</code>\n<a href=\"https://github.com/fphilipe/premailer-rails\">https://github.com/fphilipe/premailer-rails</a> which can also generate text part\nso you do not need to maintain it. Just add the gem and you are good to go.</p>\n\n<p>To preview emails use generated preview files in\n<code class=\"highlighter-rouge\">test/mailers/previews/my_mailer_preview.rb</code> or create new file:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/mailer_previews/application_mailer_preview.rb\nclass ApplicationMailerPreview &lt; ActionMailer::Preview\n  def new_message_from_client\n    message = Message.first || FactoryBot.create :message\n    ApplicationMailer.new_message_from_client message\n  end\nend\n</code></pre></div></div>\n\n<p>add a line <code class=\"highlighter-rouge\">config.action_mailer.preview_path =\n\"#{Rails.root}/app/mailer_previews\"</code> to <em>config/environments/development.rb</em> and\ngo to <a href=\"http://localhost:3000/rails/mailers\">rails/mailers</a>.\nIf you are using catch all route than add those lines</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/routes.rb\n  # https://stackoverflow.com/questions/26130130/what-are-the-routes-i-need-to-set-up-to-preview-emails-using-rails-4-1-actionmai\n  get '/rails/mailers' =&gt; \"rails/mailers#index\"\n  get '/rails/mailers/*path' =&gt; \"rails/mailers#preview\"\n  # https://stackoverflow.com/a/6047561/287166\n  match '*a', to: 'home#routing_error', via: [:get, :post]\n</code></pre></div></div>\n\n<p>Another gem to preview emails <a href=\"https://github.com/markets/maily\">https://github.com/markets/maily</a></p>\n\n<p>Here is example of style:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/mailers/applicaion_mailer.rb\nclass ApplicationMailer &lt; ActionMailer::Base\n  default from: 'from@example.com'\n  layout 'mailer'\n  add_template_helper MailerHelper\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/layouts/mailer.html.erb\n<span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;meta</span> <span class=\"na\">http-equiv=</span><span class=\"s\">\"Content-Type\"</span> <span class=\"na\">content=</span><span class=\"s\">\"text/html; charset=utf-8\"</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;style&gt;</span>\n      <span class=\"nc\">.email-container</span> <span class=\"p\">{</span>\n        <span class=\"nl\">max-width</span><span class=\"p\">:</span> <span class=\"m\">500px</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n      <span class=\"nc\">.pre-header</span> <span class=\"p\">{</span>\n        <span class=\"nl\">display</span><span class=\"p\">:</span> <span class=\"nb\">none</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n      <span class=\"nc\">.bordered</span> <span class=\"p\">{</span>\n        <span class=\"nl\">border</span><span class=\"p\">:</span> <span class=\"m\">2px</span> <span class=\"nb\">solid</span> <span class=\"m\">#ccc</span><span class=\"p\">;</span>\n        <span class=\"nl\">border-radius</span><span class=\"p\">:</span> <span class=\"m\">5px</span><span class=\"p\">;</span>\n        <span class=\"nl\">padding</span><span class=\"p\">:</span> <span class=\"m\">5px</span><span class=\"p\">;</span>\n        <span class=\"nl\">background</span><span class=\"p\">:</span> <span class=\"m\">#e5f1ff</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n    <span class=\"nt\">&lt;/style&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"email-container\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"pre-header\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">yield</span> <span class=\"na\">:subject_line</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n      <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">yield</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/helpers/mailer_helper.rb\nmodule MailerHelper\n  def subject_line(message)\n    content_for :subject_line, message\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/mailers/user_mailer/contact.html.erb\n&lt;%\n  subject_line @user.name\n%&gt;\n&lt;h1&gt;&lt;%= t \"user_mailer.landing_signup.title\", name: @user.email %&gt;&lt;/h1&gt;\n</code></pre></div></div>\n\n<h1 id=\"receiving-emails\">Receiving emails</h1>\n\n<p>When you want to receive, use <a href=\"https://github.com/evendis/mandrill-rails\">mandrill-rails</a>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo '\n# receiving emails and webhooks\ngem \"mandrill-rails\" ' &gt;&gt; Gemfile\n\nsed \nresource :inbox, :controller =&gt; 'inbox', :only =&gt; [:show,:create]\nconfig/routes.rb\n\necho 'class InboxController &lt; ApplicationController\n  include Mandrill::Rails::WebHookProcessor\n\n  def handle_inbound(event_payload)\n    # do something with payload\n  end\nend ' &gt; app/controllers/inbox_controller.rb\n</code></pre></div></div>\n\n<p>Mandrill:</p>\n\n<ul>\n  <li>create api key for prod and test</li>\n  <li>validate inbound domains for prod and test</li>\n  <li>create routes for validated domains (this will create one webhook)</li>\n  <li>create webhooks</li>\n  <li>create rules that match api and hooktype and send it to webhook</li>\n</ul>\n\n<p>authentication\nhttp://www.openspf.org/SPF_Record_Syntax</p>\n\n<p>Feedback Loop is in a header and some clients enable them\nhttp://www.list-unsubscribe.com/</p>\n\n<h1 id=\"internal-notification\">Internal Notification</h1>\n\n<p>Those are usefull admin or devops notifications</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/secrets.yml\nshared:\n  mailer_sender: &lt;%= ENV[\"MAILER_SENDER\"] || \"My Company &lt;support@example.com&gt;\" %&gt;\n  internal_notification_email: &lt;%= ENV[\"INTERNAL_NOTIFICATION_EMAIL\"] || \"internal@example.com\" %&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># mailers/application_mailer.rb\nclass ApplicationMailer &lt; ActionMailer::Base\n  layout 'mailer'\n  default from: Rails.application.secrets.mailer_sender\n\n  INTERNAL_NOTIFICATION_EMAIL = Rails.application.secrets.internal_notification_email\n\n  def internal_notification(subject, item = {})\n    return unless INTERNAL_NOTIFICATION_EMAIL\n    email_subject = \"[MyApp#{' staging' if Rails.application.secrets.is_staging}] #{subject}\"\n    email_body = \"&lt;h1&gt;#{subject}&lt;/h1&gt;&lt;strong&gt;Details:&lt;/strong&gt;\" +\n                 item.inspect.\n                   gsub(', ', \",&lt;br&gt;\").\n                   gsub('{', '&lt;br&gt;{&lt;br&gt;').\n                   gsub('}', '&lt;br&gt;}&lt;br&gt;')\n    mail to: INTERNAL_NOTIFICATION_EMAIL,\n         subject: email_subject,\n         body: email_body,\n         content_type: \"text/html\"\n  end\nend\n</code></pre></div></div>\n\n<p>You can send notification in any class. Note that first param is string, and\nohers are hash.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/user.rb\n  after_save :send_notification_geocode_failed\n\n  def send_notification_geocode_failed\n    if address_changed? &amp;&amp; !city.present?\n      ApplicationMailer.internal_notification(\n        \"geocode city is not present #{name}\",\n        name: name,\n        url: Rails.application.routes.url_helpers.menu_url(link),\n        address: address,\n      ).deliver_now\n    end\n  end\n</code></pre></div></div>\n\n<p>Note that you should not send email in before blocks since when validation fails\nit will rollback and even background job is rollbacked.</p>\n\n<h1 id=\"actionmailer\">ActionMailer</h1>\n\n<p><a href=\"http://guides.rubyonrails.org/action_mailer_basics.html#complete-list-of-action-mailer-methods\">Here</a>\nis what we can do with ActionMailer:</p>\n\n<ul>\n  <li>headers</li>\n  <li>attachments</li>\n  <li>mail</li>\n</ul>\n\n<p>You can use <code class=\"highlighter-rouge\">before_action</code> and <code class=\"highlighter-rouge\">after_action</code> and access to <code class=\"highlighter-rouge\">params</code>\nhttp://guides.rubyonrails.org/action_mailer_basics.html#action-mailer-callbacks</p>\n\n<p>For example <code class=\"highlighter-rouge\">prevent_delivery_to_guests</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class UserMailer &lt; ApplicationMailer\n  before_action { @business, @user = params[:business], params[:user] }\n\n  after_action :prevent_delivery_to_guests\n\n  def feedback_message\n  end\n\n    def prevent_delivery_to_guests\n      if @user &amp;&amp; @user.guest?\n        mail.perform_deliveries = false\n      end\n    end\n  end\n</code></pre></div></div>\n\n<h1 id=\"dynamic-smtp-settings-at-runtime\">Dynamic smtp settings at runtime</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class DeviseMailer &lt; Devise::Mailer\n  after_action :set_smtp\n\n  def set_smtp\n    # determine smtp settings form @receiver or other\n    if isp.use_my_smtp_server &amp;&amp; @_mail_was_called # spam could ignore mail\n      mail.from = \"#{receiver.smtp_from_name} &lt;#{receiver.smtp_from_email}&gt;\"\n      mail.reply_to = \"#{receiver.smtp_from_name} &lt;#{receiver.smtp_from_email}&gt;\"\n      mail.delivery_method.settings.merge!(\n        address: receiver.smtp_host,\n        port: (receiver.smtp_port.present? ? receiver.smtp_port : 587),\n        user_name: receiver.smtp_username,\n        password: receiver.smtp_password,\n      )\n    end\n  end\n</code></pre></div></div>\n\n<h1 id=\"interesting\">Interesting</h1>\n\n<p>You can include small giff that looks like screencast. Image should be less than\n1MB and included inline.</p>\n\n<p>Email gems <a href=\"http://awesome-ruby.com/#-email\">http://awesome-ruby.com/#-email</a> and\n<a href=\"https://github.com/gmailgem/gmail\">gmail</a></p>\n\n<p>You can use img tags and css background image, but if it is run in background\n(it does not know on which request.host) than you need to set asset host (look\nin <a href=\"/2015/04/05/common-rails-bootstrap-snippets/\">common rails bootstrap snippets</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/layouts/mailer.html.erb\nbackground-image: url('&lt;%= asset_url 'cute-small.jpg' %&gt;');\n&lt;%= image_tag 'premesti_se.gif' %&gt;\n\n# config/application.rb\nconfig.action_mailer.asset_host = \"http://my_host\"\n</code></pre></div></div>\n\n<h1 id=\"gmail-go-to-action\">Gmail Go To Action</h1>\n\n<p>Using some header json you can set button in gmail subject line “Quick Actions”.\n<a href=\"https://stackoverflow.com/questions/22318432/how-do-i-add-go-to-action-in-gmail-subject-line-using-schema-org\">https://stackoverflow.com/questions/22318432/how-do-i-add-go-to-action-in-gmail-subject-line-using-schema-org</a></p>\n\n<h1 id=\"spam-detection\">Spam detection</h1>\n\n<p>You can disable registering specific email domains using this list\nhttps://github.com/FGRibreau/mailchecker\nUsing this gem https://github.com/rubygarage/truemail you can check if actual\nemail account exists on smtp server.</p>\n\n<h1 id=\"testing-emails\">Testing emails</h1>\n\n<p>https://www.engineyard.com/blog/testing-async-emails-rails-42</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/support/mailer_helpers.rb\nmodule MailerHelpers\n  def clear_mails\n    ActionMailer::Base.deliveries = []\n  end\n\n  # if you deliver_now you can\n  # assert_difference 'all_mails.count', 1 do\n  # and for background deliver_later you need to assert perform or enqueue\n  # inherit from ActiveJob::TestCase\n  # or include ActiveJob::TestHelper\n  # assert_performed_jobs 1, only: ActionMailer::DeliveryJob do\n  def all_mails\n    ActionMailer::Base.deliveries\n  end\n\n  # last_email is renamed to last_mail\n  def last_mail\n    raise 'you_should_use_give_me_last_mail_and_clear_mails'\n    # ActionMailer::Base.deliveries.last\n  end\n\n  # some usage is like\n  # mail = give_me_last_mail_and_clear_mails\n  # assert_equal [email], mail.to\n  # assert_match t('user_mailer.landing_signup.confirmation_text'), mail.html_part.decoded\n  # confirmation_link = mail.html_part.decoded.match(\n  #   /(http:.*)\"&gt;#{t(\"confirm_email\")}/\n  # )[1]\n  # visit confirmation_link\n  def give_me_last_mail_and_clear_mails\n    mail = ActionMailer::Base.deliveries.last\n    clear_mails\n    mail\n  end\nend\nclass ActiveSupport::TestCase\n  include MailerHelpers\n  # for assert_performed_jobs\n  include ActiveJob::TestHelper\nend\nclass ActionDispatch::IntegrationTest\n  include MailerHelpers\n  # for assert_performed_jobs\n  include ActiveJob::TestHelper\nend\n</code></pre></div></div>\n\n<h1 id=\"click-link-tracking-in-emails\">Click link tracking in emails</h1>\n\n<p>https://github.com/ankane/ahoy_email</p>\n"
    } ,
  
    {
      "title"    : "Git tips",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/05/05/git-tips/",
      "date"     : "2016-05-05 00:00:00 +0200",
      "content"  : "<h1 id=\"git-commands\">Git commands</h1>\n\n<p>Add and commit in one command alias</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git config --global alias.add-commit '!git add -A &amp;&amp; git commit'\n</code></pre></div></div>\n\n<p>checkout remote branch and track it</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git checkout -t origin/branch\n</code></pre></div></div>\n\n<p>Push branch and track</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git push bitbucket development:development\n</code></pre></div></div>\n\n<p>Getting existing git branches to track remote branches:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git branch --set-upstream gh-pages-bitbucket bitbucket/gh-pages \n</code></pre></div></div>\n\n<h1 id=\"git-log\">Git log</h1>\n\n<p>Show commits that are descendant of commit1 AND ancestors of commit2, in the\nsame time</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git log --reverse --ancestry-path commit1^..commit2\ngit log $(git merge-base HEAD branch)..branch  # show commits only on branch\n</code></pre></div></div>\n\n<p>See all the changed code</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git log -p\n</code></pre></div></div>\n\n<p>Also with adding</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git add -p # e to open editor\n</code></pre></div></div>\n\n<p>Git stash only unstaged changes</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git stash --keep-index\n</code></pre></div></div>\n\n<p>Git checkout previous branch</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git checkout -\n</code></pre></div></div>\n\n<p>When you want to undo some commands</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git reflog\n</code></pre></div></div>\n\n<p>For work in progress you can use wip</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git -m wip # one word does not need \"\"\n</code></pre></div></div>\n\n<p>Show file at specific revision</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git show HEAD~4:index.html\n</code></pre></div></div>\n\n<p>Find difference of current file with some point</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git diff 123123123 -- index.html\n</code></pre></div></div>\n\n<p>Find difference of all files and folders with meld diff tool</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git difftool master --dir-diff\n</code></pre></div></div>\n\n<p>Find bug using bisect on specific folder or file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> git bisect start -- app/controllers/registration_controller.rb\n</code></pre></div></div>\n\n<p>If you need to push to two remote repositories, you can do it in one command</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git remote add all git@github.com:duleorlovic/tips.git\ngit remote set-url  --add all git@heroku.com:duleorlovic_tips.git\ngit push all master --set-upstream\ngit push\n</code></pre></div></div>\n\n<p>To push to heroku without changes, try</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git commit --allow-empty -m \"empty commit\"\ngit push heroku master\n</code></pre></div></div>\n\n<p>Versioning <a href=\"http://semver.org/\">SEMVER</a></p>\n\n<h1 id=\"multiple-accounts\">Multiple accounts</h1>\n\n<p>If there is two accounts on bitbucket or github with different keys use\n<code class=\"highlighter-rouge\">.ssh/config</code> file and put:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Host newbitbucket.org\n  Hostname bitbucket.org\n  IdentityFile ~/.ssh/id_rsa_new\n\nHost bitbucket.org\n  Hostname bitbucket.org\n  IdentityFile ~/.ssh/id_rsa\n</code></pre></div></div>\n\n<p>Note that you need to use <code class=\"highlighter-rouge\">git</code> protocol url when seting remote (<code class=\"highlighter-rouge\">https</code>\nprotocol does not use this mappings). To change current url you can edit\n<code class=\"highlighter-rouge\">.git/config</code> or use command <code class=\"highlighter-rouge\">git remote set-url origin\ngit@newbitbucket.org:company/repo</code>.</p>\n\n<p>To see which username (-T) and wich key (-v) is using:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ssh -T git@bitbucket.org\nssh -v git@secure.bitbucket.org\n</code></pre></div></div>\n\n<p>You can see which keys currenlty is used with <code class=\"highlighter-rouge\">ssh-add -L</code>. You can create new\nsession with <code class=\"highlighter-rouge\">ssh-agent bash -c 'ssh-add ~/.ssh/id_rsa_my_company_account; git\nclone git@github.com:company/repo.git'</code></p>\n\n<p>If you want, you can generate id_rsa_secure with password, so it will asked each\ntime you use git command.  Heroku uses keys from <code class=\"highlighter-rouge\">~/.netrc</code> which is created\nwhen you type <code class=\"highlighter-rouge\">heroku login</code> (once is setup, it stays forever)</p>\n\n<h1 id=\"git-commit\">Git commit</h1>\n\n<p>If you want to ignore/reignore some files that are tracked (gitignore does not\nwork on tracked files). Note that when you change branch with changes to that\nfiles, error will be reported. Also note that <code class=\"highlighter-rouge\">git checkout .</code> or <code class=\"highlighter-rouge\">git stash</code>\nwill be also applied to those hidden changes.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git update-index --assume-unchanged config/database.yml\n# then to track changes again\ngit update-index --no-assume-unchanged config/database.yml\n</code></pre></div></div>\n\n<p>If you want to add folder to git structure but ignore all its content (like\n<code class=\"highlighter-rouge\">backup</code> or <code class=\"highlighter-rouge\">tmp</code> folder) you can do with three steps</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mkdir tmp\necho '*' &gt; tmp/.gitignore\ngit add tmp/.gitignore -f\n</code></pre></div></div>\n\n<p>If you want to skip history and download latest code and change author you can</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git clone --depth=1 your-repo-url\ngit commit --amend --author \"New Author Name &lt;email@address.com&gt;\" --no-edit\n</code></pre></div></div>\n\n<p>Set author localy (config is for local folder only)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git config user.email myemail@asd.asd\ngit config user.name my-name\ngit commit --amend --reset-author\n</code></pre></div></div>\n\n<p>Apply patch</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git diff &gt; patchfile\npatch -p1 &lt; patchfile\n</code></pre></div></div>\n\n<p>Count files in staging</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git diff --cached --numstat | wc -l\n</code></pre></div></div>\n\n<p>Rebase branches</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> git pull --rebase # pull remote changes and rebase your local commits\n git rebase master # call this while you are on some feature branch\n</code></pre></div></div>\n\n<p>Interactivelly rebase pull request</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git rebase -i HEAD~2 # rebase last two commits, or use origin/master\n# pick : use same commit\n# squash : meld with previous commit (on this list is previous)\n# reword : change commit message\n# edit : use commit but stop for amending\n\ngit fetch rails\ngit checkout guides_i18n\ngit rebase -i rails/master\ngit push origin guides_i18n --force-with-lease\n</code></pre></div></div>\n\n<p>Mark commit with a tag</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git tag -l\ngit tag v1.5\n\n# push tag is not automatically, you should do it manually\ngit push origin v1.5\n# or push all tags\ngit push origin --tags\n</code></pre></div></div>\n\n<p>To find if given commit hash is incuded on some release (release is a tag)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git tag --contains &lt;commit&gt;\n</code></pre></div></div>\n\n<p>Add global gitignore for all projects</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git config --global core.excludesfile ~/.gitignore\n</code></pre></div></div>\n\n<p>Clone for local or remote folders</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git remote add local orlovic@192.168.2.103:/home/orlovic/ruby/securiPi/.git\n</code></pre></div></div>\n\n<p>Big files</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt install git-lfs\ngit lfs install\ngit lfs track *.mov\n</code></pre></div></div>\n\n<p>Tutorials</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git help tutorial-2\ngit help everyday\ngit help workflows\n</code></pre></div></div>\n\n<p>Use pre commit hooks to check for something before commit happens, for example\ndo not commit secret keys instead of <code class=\"highlighter-rouge\">DO_NOT_COMMIT</code> tag. You can\n<code class=\"highlighter-rouge\">git commit --no-verify</code> to ignore hooks.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c\">#!/bin/sh</span>\n<span class=\"c\"># .git/hooks/pre-commit</span>\n<span class=\"c\"># Redirect output to stderr.</span>\n<span class=\"nb\">exec </span>1&gt;&amp;2\n<span class=\"c\"># enable user input</span>\n<span class=\"nb\">exec</span> &lt; /dev/tty\n\n<span class=\"nv\">grep_reg</span><span class=\"o\">=</span><span class=\"s1\">'-.*DO_NOT_COMMIT'</span>\n<span class=\"c\"># CHECK</span>\n<span class=\"k\">if </span><span class=\"nb\">test</span> <span class=\"k\">$(</span>git diff <span class=\"nt\">--cached</span> | <span class=\"nb\">grep</span> <span class=\"nt\">-e</span> <span class=\"nv\">$grep_reg</span> | <span class=\"nb\">wc</span> <span class=\"nt\">-l</span><span class=\"k\">)</span> <span class=\"o\">!=</span> 0\n<span class=\"k\">then \n  </span><span class=\"nb\">exec </span>git diff <span class=\"nt\">--cached</span> | <span class=\"nb\">grep</span> <span class=\"nt\">-ne</span> <span class=\"nv\">$grep_reg</span>\n  <span class=\"nb\">read</span> <span class=\"nt\">-p</span> <span class=\"s2\">\"There are some occurrences of DO_NOT_COMMIT at your modification. Are you sure want to continue? (y/n)\"</span> yn\n  <span class=\"nb\">echo</span> <span class=\"nv\">$yn</span> | <span class=\"nb\">grep</span> ^[Yy]<span class=\"err\">$</span>\n  <span class=\"k\">if</span> <span class=\"o\">[</span> <span class=\"nv\">$?</span> <span class=\"nt\">-eq</span> 0 <span class=\"o\">]</span>\n  <span class=\"k\">then\n    </span><span class=\"nb\">exit </span>0<span class=\"p\">;</span> <span class=\"c\">#THE USER WANTS TO CONTINUE</span>\n  <span class=\"k\">else\n    </span><span class=\"nb\">exit </span>1<span class=\"p\">;</span> <span class=\"c\"># THE USER DONT WANT TO CONTINUE SO ROLLBACK</span>\n  <span class=\"k\">fi\nfi</span>\n</code></pre></div></div>\n\n<h1 id=\"time-tracking\">Time tracking</h1>\n\n<ul>\n  <li>https://github.com/laughedelic/gtm is old unmaintained</li>\n  <li>\n    <p>https://github.com/git-time-metric/gtm</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>brew tap git-time-metric/gtm\nbrew install gtm\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h2 id=\"glass\">Glass</h2>\n\n<p>https://github.com/timeglass/glass</p>\n\n<p>Download and create links in your <code class=\"highlighter-rouge\">/usr/local/bin</code> and run <code class=\"highlighter-rouge\">sudo glass install</code>\n<a href=\"https://github.com/timeglass/glass/blob/master/docs/manual_installation.md\">https://github.com/timeglass/glass/blob/master/docs/manual_installation.md</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>glass init\nglass status\ngit commit -am \"Work\"\ngit log -n 1 --show-notes=time-spent\n</code></pre></div></div>\n\n<p>To disable adding commit message use space (not empty)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; /var/lib/timeglass/timeglass.json &lt;&lt; HERE_DOC\n{\n  \"mbu\": \"1m\",\n  \"commit_message\": \" \",\n  \"auto_push\": false\n}\nHERE_DOC\n</code></pre></div></div>\n\n<h1 id=\"github\">Github</h1>\n\n<p>For you project you can set instructions for issues, look example\n<a href=\"https://github.com/arsduo/koala/issues/new\">https://github.com/arsduo/koala/issues/new</a></p>\n\n<p>Very usefull github cheat sheet\n<a href=\"https://github.com/tiimgreen/github-cheat-sheet#github-talks\">https://github.com/tiimgreen/github-cheat-sheet#github-talks</a></p>\n\n<p>Use labels:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">devops</code> for CI tasks</li>\n  <li><code class=\"highlighter-rouge\">missing_requirements</code> and <code class=\"highlighter-rouge\">ready</code> for status of issue</li>\n  <li><code class=\"highlighter-rouge\">feature</code>, <code class=\"highlighter-rouge\">bug</code> for type of issue</li>\n</ul>\n\n<p>Use <a href=\"https://github.com/zricethezav/gitleaks\">gitleaks</a> to search history for\nsecret keys, so you can remove them.</p>\n\n<h1 id=\"hub\">Hub</h1>\n\n<p><a href=\"https://hub.github.com/\">https://hub.github.com/</a>\nDownload release for linux arm 64 <a href=\"https://github.com/github/hub/releases\">https://github.com/github/hub/releases</a> and\nrun <code class=\"highlighter-rouge\">sudo ./install</code>. To create alias, run and copy output <code class=\"highlighter-rouge\">hub alias -s</code></p>\n\n<p>Hub add new commands:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">git browse</code> open current project github page in the default browser <code class=\"highlighter-rouge\">git\nbrowse -- issues</code> to open issues. <code class=\"highlighter-rouge\">git browse user/repo</code> to open user/repo</li>\n  <li><code class=\"highlighter-rouge\">git create</code> create this repository on GitHub and add GitHub as origin. After\nyou create, you need to push</li>\n  <li>ci-status      Show the CI status of a commit</li>\n  <li>compare        Open a compare page on GitHub</li>\n  <li>fork           Make a fork of a remote repository on GitHub and add as remote</li>\n  <li>issue          List or create issues</li>\n  <li>pr             Work with pull requests</li>\n  <li>pull-request   Open a pull request on GitHub</li>\n  <li>release        List or create releases</li>\n</ul>\n\n"
    } ,
  
    {
      "title"    : "Scalable css",
      "category" : "",
      "tags"     : "css",
      "url"      : "/2016/04/27/scalable-css/",
      "date"     : "2016-04-27 00:00:00 +0200",
      "content"  : "<h1 id=\"smacss\">Smacss</h1>\n\n<p><a href=\"https://smacss.com/book/\">book</a> 5 categories:</p>\n\n<ul>\n  <li>base: usually single element  (<code class=\"highlighter-rouge\">a</code>,<code class=\"highlighter-rouge\">h1</code>) or pseudo-class (<code class=\"highlighter-rouge\">a:hover</code>)\nselectors (but not a class <code class=\"highlighter-rouge\">my-class</code> selector). Its default styling for\nelements in all occurences on the page.\n    <ul>\n      <li><code class=\"highlighter-rouge\">p + p</code> is sibling selector, so only for paragraph that is after paragraph\n(so it wont affect first p, only ones that are immediately after p)</li>\n      <li><code class=\"highlighter-rouge\">p ~ p</code> is <a href=\"https://www.w3.org/TR/selectors/#general-sibling-combinators\">general\nsibling</a> so\nall p elements who has sibling p which is before (not neccessary\nimmediatelly before).</li>\n    </ul>\n  </li>\n  <li>layout: divide page into sections. prefix with <code class=\"highlighter-rouge\">l-</code> like <code class=\"highlighter-rouge\">l-inline</code></li>\n  <li>module: reusable parts: <code class=\"highlighter-rouge\">callouts</code>, <code class=\"highlighter-rouge\">products</code> When used in different part\nof page you should use subclassing classname-module, for example: <code class=\"highlighter-rouge\">&lt;div\nclass=\"pod pod-callout\"&gt;</code> instead of specificity war <code class=\"highlighter-rouge\">.callout .pod</code></li>\n  <li>state: how module or layout looks in particular state (active/inactive, home\npage/sidebar, small/big screens), prefixed with <code class=\"highlighter-rouge\">is-</code>, like <code class=\"highlighter-rouge\">is-hidden</code>. For\nspecific states of module, you can use <code class=\"highlighter-rouge\">is-callout-minimized</code> and place it\ninside module code so its loaded only when module is loaded (for just-in-time\nloading). State changes can happen by: class name (js add/remove class),\npseudo class (:hover,:focus) and media query. Always keep module all css code\ninside same file.</li>\n  <li>theme: how module or layout might look</li>\n</ul>\n\n<h1 id=\"bem-block-__element----modifier\">BEM: Block __Element - -Modifier</h1>\n\n<p><a href=\"https://en.bem.info/\">bem.info</a> &amp; <a href=\"http://getbem.com/introduction/\">getbem</a> is\na way to write classes with <code class=\"highlighter-rouge\">--</code> and <code class=\"highlighter-rouge\">__</code> so instead of <code class=\"highlighter-rouge\">menu-item-visible</code>\nwrite <em>block-name__elem-name–mod-name</em> <code class=\"highlighter-rouge\">menu__item--visible</code></p>\n\n<p><strong>blocks</strong> are independent page component that contains other blocks or\n<strong>elements</strong>. elements can’t be used outside of a block and they start with\n<code class=\"highlighter-rouge\">__</code>. <strong>modifiers</strong> defines appearance and behavior on block or elements and\nstart with <code class=\"highlighter-rouge\">--</code> (or <code class=\"highlighter-rouge\">_</code>). They always prefixed with parent block/element name,\nso instead of <code class=\"highlighter-rouge\">button active</code> we write <code class=\"highlighter-rouge\">button button--active</code> 3 reasons for\nthat: single level specificity, <code class=\"highlighter-rouge\">item button active</code> don’t know if\n<code class=\"highlighter-rouge\">item--active</code> or <code class=\"highlighter-rouge\">button--active</code> and we clearly see that it is modifier and\nnot some other block/element.</p>\n<ul>\n  <li>instead of nested elements <code class=\"highlighter-rouge\">.o-grid .o-grid__item {}</code> since BEM suggest to use\nunique class name, you need to define only single level <code class=\"highlighter-rouge\">.o-grid__item {}</code>. If\nyou have long class name <code class=\"highlighter-rouge\">.o-grid__item-search-button-text-svg-icon</code> than it\nshould be replaced with single element <code class=\"highlighter-rouge\">.o-grid__svg_icon</code> since icon do not\nrelate to item, search or button, it current position is inside, but not have\nto be.</li>\n  <li>do not use semantic tags (<code class=\"highlighter-rouge\">a.button {}</code>), its better to write <code class=\"highlighter-rouge\">&lt;button\nclass=\"button button--mod\"&gt;</code> beause you can change tag to <code class=\"highlighter-rouge\">&lt;a&gt;</code> and you can\nmix <code class=\"highlighter-rouge\">button</code> class on other places</li>\n  <li>do not write nested rules, except when you write for block modifier element\n<code class=\"highlighter-rouge\">.block--modifier .block__element { background: blue }</code></li>\n  <li>do not use global modifier that you want to apply to any class like <code class=\"highlighter-rouge\">block\nhidden</code>. Better is to use <code class=\"highlighter-rouge\">block--hidden</code></li>\n  <li>\n    <p>when you have nested blocks than instead\n<code class=\"highlighter-rouge\">block__nested-block__double-nested-block</code> use <code class=\"highlighter-rouge\">block__nested-block</code> and\n<code class=\"highlighter-rouge\">block__double-nested-block</code> or <code class=\"highlighter-rouge\">nested-block__double-nested-block</code> depending\non how you can move <em>double-nested-block</em></p>\n  </li>\n  <li>\n    <p>do not override styles of another block</p>\n  </li>\n  <li><a href=\"http://work.stevegrossi.com/2014/09/06/how-to-write-css-that-scales/\">http://work.stevegrossi.com/2014/09/06/how-to-write-css-that-scales/</a></li>\n  <li>\n    <p><a href=\"https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Writing_efficient_CSS#Avoid_the_descendant_selector.21\">https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Writing_efficient_CSS#Avoid_the_descendant_selector.21</a></p>\n  </li>\n  <li><strong>key selector</strong> is the right most part of selector (could be <code class=\"highlighter-rouge\">#id</code>, <code class=\"highlighter-rouge\">.class</code>,\ntag <code class=\"highlighter-rouge\">h1</code> or universal <code class=\"highlighter-rouge\">[hidden=\"true\"]</code> category). Avoid plain universal and\navoid mixing other three categories.</li>\n  <li>avoid descendant selector <code class=\"highlighter-rouge\">table[hidden=\"true\"] td tr</code>, betters is to use\nchild selector <code class=\"highlighter-rouge\">table[hidden=\"true\"] &gt; td &gt; tr</code> but event that should be\navoided with duplicating attributes <code class=\"highlighter-rouge\">tr[hidden=\"true\"]</code></li>\n  <li>rely on inheritance, instead of <code class=\"highlighter-rouge\">#bookmarkMenuItem &gt; .menu-left {\nlist-style-image: url(blah) }</code> its enough to write <code class=\"highlighter-rouge\">#bookmarkMenuItem {\nlist-style-image: url(bla) }</code></li>\n</ul>\n\n<h1 id=\"abem\">ABEM</h1>\n\n<p><a href=\"https://css-tricks.com/abem-useful-adaptation-bem/\">https://css-tricks.com/abem-useful-adaptation-bem/</a></p>\n\n<h1 id=\"bio\">BIO</h1>\n\n<p>https://css-tricks.com/combining-the-powers-of-sem-and-bio-for-improving-css/\nSEM Scalable Extensible Maintainable, BIO Bem Inverted triangle css, Object\nOriented css</p>\n\n<p>Scalable means reusable ie you can use <code class=\"highlighter-rouge\">c-btn</code> on link or button and it will\nlook the same, and wont impace sibling or parent elements. Extensible means you\ncan add new features without breaking current usage. <code class=\"highlighter-rouge\">c-btn--3d</code> use <code class=\"highlighter-rouge\">c-btn</code> and\nadd 3d effect to it.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/* =Mixins\n--------------------------------*/\n@mixin button-3d($color) {\n  box-shadow: 0px 4px darken($color, 20%);\n}\n/* =Objects style\n--------------------------------*/\n.c-btn {\n  background-color: transparent;\n  border: 0;\n  border-radius: rem(3);\n  color: $black;\n  padding: rem(5) rem(10);\n  text-decoration: none;\n}\n\n.c-btn--large {\n  font-size: rem(25);\n}\n\n.c-btn--3d {\n  &amp;.c-btn--yellow {\n    @include button-3d($yellow);\n  }\n\n  &amp;.c-btn--blue {\n    @include button-3d($blue);\n  }\n}\n\n.c-btn--yellow {\n  background-color: $yellow;\n}\n\n.c-btn--blue {\n  background-color: $blue;\n  color: $white;\n}\n</code></pre></div></div>\n\n<h1 id=\"css-variables\">CSS variables</h1>\n\n<ul>\n  <li>you can set to <code class=\"highlighter-rouge\">:root { --my-var: red; }</code> and than use later with <code class=\"highlighter-rouge\">p { color:\nvar(--my-var); }</code>. Those properties are inherited from elements where are\ndefined.</li>\n</ul>\n\n<h1 id=\"live-reloading-in-less-than-a-second\">Live reloading in less than a second</h1>\n\n<p><a href=\"https://github.com/sharetribe/sharetribe/blob/master/docs/scss-coding-guidelines.md\">Sharetribe</a> uses <a href=\"https://mattbrictson.com/lightning-fast-sass-reloading-in-rails\">fast reloading</a></p>\n\n<h1 id=\"scss-sass\">SCSS Sass</h1>\n\n<ul>\n  <li>you can set default value of variable <code class=\"highlighter-rouge\">$my-var: 123 !default;</code>. This has no\neffect if variable is already defined. Note that you can not override\nvariable, so in order to change value, you need to have <code class=\"highlighter-rouge\">$my-var: 111</code> before\nthis <code class=\"highlighter-rouge\">!default</code> line.</li>\n  <li>\n    <p>you can select <code class=\"highlighter-rouge\">this</code> using <code class=\"highlighter-rouge\">&amp;</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.a:hover {\n  background: blue;\n}\n// is the same as\n.a {\n  &amp;:hover {\n    background: blue;\n  }\n}\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p><a href=\"https://responsivedesign.is/develop/getting-started-with-sass\">https://responsivedesign.is/develop/getting-started-with-sass</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">@extend .email-container</code> will copy definitions from email container</li>\n  <li>use <a href=\"http://sass-lang.com/documentation/Sass/Script/Functions.html\">functions</a>\nlike <code class=\"highlighter-rouge\">map-keys</code></li>\n</ul>\n\n<p>style guides</p>\n\n<ul>\n  <li><a href=\"https://github.com/onishiweb/code-style\">collection of others</a></li>\n  <li><a href=\"https://github.com/timhartmann/Scss-Styleguide\">timharmann scss</a></li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Bundler Bower Gulp Npm Yarn Webpack Tips",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/04/20/bundler-bower-gulp-npm-yarn-webpack-tips/",
      "date"     : "2016-04-20 00:00:00 +0200",
      "content"  : "<h1 id=\"bundler-and-gemfile\">Bundler and Gemfile</h1>\n\n<p>When you install another version of existing gem, for example <code class=\"highlighter-rouge\">gem install rails\n-v 4.2.0</code>, than you can find it with <code class=\"highlighter-rouge\">gem list rails</code> and use it with <code class=\"highlighter-rouge\">rails\n_4.2.0_ new mystore</code>.\nTo list by exact name (not regexp) use <code class=\"highlighter-rouge\">-e</code>, to show remote gems <code class=\"highlighter-rouge\">-r</code> so to find\nall available versions including pre release run <code class=\"highlighter-rouge\">gem list rails -re\n--prerelease</code></p>\n\n<p>To find help some <code class=\"highlighter-rouge\">gem</code> command you can run <code class=\"highlighter-rouge\">gem help list</code></p>\n\n<p>To rebuild Gemfile.lock you can run <code class=\"highlighter-rouge\">bundle update</code>. You can upgrade specific\ngem <code class=\"highlighter-rouge\">bundle update rails</code> and only patch version of rails and its dependencies\nwill be updated in Gemfile.lock. You should also update gemfile to point to new\npatch version. If you want to update minor version than you\nneed to change in Gemfile, like <code class=\"highlighter-rouge\">gem 'rails', '~&gt;5.2.0'</code>\nTo install specific groups in Gemfile run <code class=\"highlighter-rouge\">bundle install --with postgresql</code>.\nTo specify github source of gem use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem 'jekyll', github: 'jekyll/jekyll' # branch: 'master'\n</code></pre></div></div>\n\n<p>Issue with rmagic on ubuntu 16</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>checking for Magick-config... no\nCan't install RMagick 2.12.0. Can't find Magick-config in\n...\nAn error occurred while installing rmagick (2.12.0), and Bundler cannot continue.\nMake sure that `gem install rmagick -v '2.12.0'` succeeds before bundling.\n</code></pre></div></div>\n\n<p>I upgraded to rmagic 2.13.2 and follow this\n<a href=\"https://github.com/ttscoff/Slogger/issues/344\">issue</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install libmagickwand-dev\nsudo apt-get install graphicsmagick-imagemagick-compat\nPATH=\"/usr/lib/x86_64-linux-gnu/ImageMagick-6.8.9/bin-Q16:$PATH\" gem install rmagick -v '2.13.2'\n</code></pre></div></div>\n\n<p>To remove all gems from current gemset</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rvm gemset empty\n</code></pre></div></div>\n\n<h1 id=\"rvm\">RVM</h1>\n\n<p>Install specific version and patch level <code class=\"highlighter-rouge\">rvm install 2.3.3-p451</code>\nTo see current ruby <code class=\"highlighter-rouge\">rvm list</code></p>\n\n<h1 id=\"bower\">Bower</h1>\n\n<p>Bower is deprecated https://github.com/bower/bower/issues/2298</p>\n\n<h1 id=\"gulp\">Gulp</h1>\n\n<ul>\n  <li>if you have error <code class=\"highlighter-rouge\">'watch' errored after Error: watch\n/home/orlovic/rails/menucards-frontend/src/ ENOSPC\n</code> solution is to run <code class=\"highlighter-rouge\">echo fs.inotify.max_user_watches=524288 | sudo tee -a\n/etc/sysctl.conf &amp;&amp; sudo sysctl -p</code>\n<a href=\"http://stackoverflow.com/questions/16748737/grunt-watch-error-waiting-fatal-error-watch-enospc\">link</a></li>\n</ul>\n\n<h1 id=\"npm\">NPM</h1>\n\n<p>To create package.json in current folder run <code class=\"highlighter-rouge\">npm init -y</code></p>\n\n<p>To show all versions and install specific version you can</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm info ionic\nnpm install ionic@1.4.0\nnpm uninstall ionic\n</code></pre></div></div>\n\n<p>You can install packages localy (recommended) so you can access them\n<code class=\"highlighter-rouge\">node_modules/.bin/</code> or using <code class=\"highlighter-rouge\">npx webpack</code> or with <code class=\"highlighter-rouge\">npm run build</code> if inside\npackage.json <code class=\"highlighter-rouge\">\"scripts\":{ \"build\": \"webpack\"}</code>. If you need to pass additional\nparams to build command you can use two dashes <code class=\"highlighter-rouge\">npm run build -- --colors</code>\nIf you need to access from command line than install globaly <code class=\"highlighter-rouge\">-g</code>\nUse <code class=\"highlighter-rouge\">--save</code> if package is used on production env, and <code class=\"highlighter-rouge\">--save-dev</code> if it is\nonly on development (like linters or testing tools).</p>\n\n<p>You can use scoped packages https://docs.npmjs.com/misc/scope that will be used\nfrom subfolder, for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install @myorg/mypackage\n</code></pre></div></div>\n\n<p>Scope can be associated with a registry at login <code class=\"highlighter-rouge\">npm login\n--registry=http://reg.example.com --scope=@myco</code> or at config <code class=\"highlighter-rouge\">npm config set\n@myco:registry http://reg.example.com</code>.</p>\n\n<p>Package lock <a href=\"https://docs.npmjs.com/files/package-locks\">https://docs.npmjs.com/files/package-locks</a> is used to prevend\nusing latest dependencies if they are not desirable <code class=\"highlighter-rouge\">package-lock.json</code> or\n<code class=\"highlighter-rouge\">npm-shrinkwrap.json</code></p>\n\n<p>Note that if you remove some files from package folder (for example\n<code class=\"highlighter-rouge\">node_modules/iCheck/skins</code> than <code class=\"highlighter-rouge\">npm install</code> will not see\nthat is was removed. You need to <code class=\"highlighter-rouge\">rm -rf folder</code> so than <code class=\"highlighter-rouge\">npm install</code> will\nget fresh copy of the package.</p>\n\n<p>Example adding jquery 3, bootstrap 4, fontawesome 4 on rails you can find on  /2014/07/01/ruby-on-rails-layouts-and-rendering/)</p>\n\n<h1 id=\"npmjs-publish-package\">Npmjs publish package</h1>\n\n<p>https://docs.npmjs.com/getting-started/publishing-npm-packages</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm whoami\nnpm adduser\nnpm publish\n</code></pre></div></div>\n\n<h1 id=\"yarn\">Yarn</h1>\n\n<p>Yarn will install packages to <code class=\"highlighter-rouge\">node_modules</code> folder.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn init # to generate package.json\nyarn remove [package]\nyarn # to install dependencies\nyarn run build # to run \"scripts\" -&gt; \"build\"\n\nyarn add [package]\n</code></pre></div></div>\n\n<p>You can add <code class=\"highlighter-rouge\">package@version</code> vesion could be <code class=\"highlighter-rouge\">\"^1.0.0\"</code>\n<a href=\"https://yarnpkg.com/en/docs/dependency-versions\">https://yarnpkg.com/en/docs/dependency-versions</a> When you <code class=\"highlighter-rouge\">yarn\nupgrade</code> it will upgrade version to next, for example <code class=\"highlighter-rouge\">\"^2.0.0\"</code>.</p>\n\n<p>If you want to install to specific folder instead of <code class=\"highlighter-rouge\">node_modules</code> than use\n<code class=\"highlighter-rouge\">yarn install --modules-folder ./public/assets</code> or add to\n<a href=\"https://yarnpkg.com/lang/en/docs/yarnrc/#toc-cli-arguments\">.yarnrc</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># .yarnrc\n--install.modules-folder \"./public/assets\"\n--add.modules-folder \"./public/assets\"\n</code></pre></div></div>\n\n<p>Note that there are problems with missing <code class=\"highlighter-rouge\">.bin</code> folder\nhttps://github.com/yarnpkg/yarn/issues/3724</p>\n\n<h1 id=\"commonjs\">Commonjs</h1>\n\n<p>All bundle tools explained in video https://www.youtube.com/watch?v=U4ja6HeBm6s\nCommonJS is used by node.js. <code class=\"highlighter-rouge\">module.exports</code> is defined in environment, and\nit’s value is returned when you <code class=\"highlighter-rouge\">require('my_module')</code> (no need to include\n<code class=\"highlighter-rouge\">.js</code>). You can export object with multiple functions. Build with <code class=\"highlighter-rouge\">browserify</code>\nor <code class=\"highlighter-rouge\">webpack</code>.\nEach module is run inside closure so there is no global variables. When you\ninclude <code class=\"highlighter-rouge\">&lt;script&gt;</code> tag code is run and that is.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># index.html\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">id=</span><span class=\"s\">\"s\"</span><span class=\"nt\">&gt;&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;script </span><span class=\"na\">src=</span><span class=\"s\">\"./main-bundle.js\"</span><span class=\"nt\">&gt;&lt;/script&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># add.js\nfunction add(a, b) {\n  return a + b;\n}\nmodule.exports = add;\n\n# main.js\nvar add = require('./add');\nfunction sum(list) {\n  var m = 0;\n  list.forEach(function(item) {\n    m = add(m, item);\n  });\n  return m;\n}\ndocument.getElementById('s').innerHTML = sum([1,2,3])\n\n\nnpm install browserify -g\nbrowserify main.js -o main-bundle.js\n\nnpm install -D webpack-cli\nwebpack main.js -o main-bundle.js\n</code></pre></div></div>\n\n<h1 id=\"amd-asynchronous-module-definition\">AMD Asynchronous module definition</h1>\n\n<p>When you <code class=\"highlighter-rouge\">require('jQuery')</code> it should be there at that moment, but if we want\nto run the code without jQuery loaded yet use async <code class=\"highlighter-rouge\">define(dependencies, f)</code>\nBuild with <code class=\"highlighter-rouge\">webpack</code> since it will recognize that it is AMD and define <code class=\"highlighter-rouge\">define</code>\ncorrectly.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># add.js\ndefine([], function() {\n  return function add(a, b) {\n    return a + b;\n  }\n});\n\n# main.js\ndefine(['./add'], function(add) {\n  function sum(list) {\n    var m = 0;\n    list.forEach(function(item) {\n      m = add(m, item);\n    });\n    return m;\n  }\n  document.getElementById('s').innerHTML = sum([1,2,3])\n});\n\nwebpack main.js -o main-bundle.js\n</code></pre></div></div>\n\n<p>For development you can use <a href=\"http://requirejs.org/docs/whyamd.html\">RequireJS</a>\n(works with AMD modules) that can see if <code class=\"highlighter-rouge\">define</code> is called and fetch other\ndependencies (with another <code class=\"highlighter-rouge\">&lt;script&gt;</code> tags) and include them so <code class=\"highlighter-rouge\">main.js</code> can\nexecute it’s code.</p>\n\n<p><a href=\"http://requirejs.org/docs/optimization.html\">RequireJS Optimizer</a> or\n<code class=\"highlighter-rouge\">amd-optimize</code> and almond (minimized AMD for optimized builds which define\n<code class=\"highlighter-rouge\">define</code>),\nOr you can transform AMD modules to CommonJS js modules with <code class=\"highlighter-rouge\">deamdify</code> (so no\nneed for almond to define <code class=\"highlighter-rouge\">define</code>) and than run <code class=\"highlighter-rouge\">browserify</code>.</p>\n\n<h1 id=\"es6-import-export\">ES6 Import Export</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># add.js\nfunction add(a, b) {\n  return a + b;\n}\nexport { add }\n\n# main.js\nimport { add } from './add';\nfunction sum(list) {\n  var m = 0;\n  list.forEach(function(item) {\n    m = add(m, item);\n  });\n  return m;\n}\n\n# build with webpack\nwebpack main.js -o main-bundle.js\n\n# or build with browserify with babelify transform\nnpm install -g babelify\nbrowserify -t babelify main.js -o main-bundle.js\n\n# or older google tool Traceur with es6ify transform\n</code></pre></div></div>\n\n<p>If you want to dynamic load on development and bundle on production, you can use\nsystemjs, similar to RequireJS, but loads amd, es6 or commonjs modules and\ncompiles es6 in the browser.</p>\n\n<p><a href=\"https://github.com/rollup/rollup\">Rollup</a> bundle only functions that you use,\nnot the whole library (deprecate <code class=\"highlighter-rouge\">esperanto</code>).</p>\n\n<p><a href=\"https://jspm.io/\">jspm</a>  can consume all formats in same time.</p>\n\n<h1 id=\"umd\">UMD</h1>\n\n<p>Universal module definition so you can import in commonjs or amd or with script\ntag.\nYou can use rollbar or webpack to produce umd that will generate a global\n<code class=\"highlighter-rouge\">myGlobalModule</code> or plain js https://stackoverflow.com/questions/38638210/how-to-use-umd-in-browser-without-any-additional-dependencies</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># main.js\nimport { add } from './add';\nfunction sum(list) {\n  var m = 0;\n  list.forEach(function(item) {\n    m = add(m, item);\n  });\n  return m;\n}\n\n// to use like `myGlobalModule([1,2,3])`.\nexport default sum\nexport default function sum(list) {\n\n// to use like `myGlobalModule.sum([1,2,3])`.\nexport default {\n  sum: sum\n}\nexport function sum(list) {\n\n\n// webpack call with myGlobalModule.sum([1,2,3])\nexport function sum(list) {\n// with webpack with myGlobalModule.default([1,2,3])\nexport default function sum(list) {\nexport default sum\n// with webpack with myGlobalModule.default.sum([1,2,3])\nexport default {\n  sum: sum\n}\n</code></pre></div></div>\n\n<p>rollup</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rollup main.js --format umd --name 'myGlobalModule' --file main-bundle-rollup-umd.js\n</code></pre></div></div>\n\n<p>webpack</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># webpack.config.js\nmodule.exports = {\n  entry: './main.js',\n  output: {\n    filename: 'main-bundle-webpack-umd.js',\n    path: __dirname,\n    library: \"myGlobalModule\",\n    libraryTarget: \"umd\"\n  }\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>webpack\n</code></pre></div></div>\n\n<h1 id=\"webpack\">Webpack</h1>\n\n<p><a href=\"https://webpack.academy\">https://webpack.academy</a>\n<a href=\"https://www.what-problem-does-it-solve.com/webpack\">https://www.what-problem-does-it-solve.com/webpack</a>\n<a href=\"https://survivejs.com/webpack/\">https://survivejs.com/webpack/</a></p>\n\n<p><a href=\"https://webpack.js.org/guides/getting-started/\">https://webpack.js.org/guides/getting-started/</a>\n/home/orlovic/rails_temp/webpack_guide</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm init -y\nnpm install webpack webpack-cli --save-dev\n</code></pre></div></div>\n\n<p>Add to <code class=\"highlighter-rouge\">package.json</code> build command so you can run</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// package.json\n  \"scripts\": {\n    \"build\": \"webpack\"\n  }\n\n// run build with\nnpm run build\n\n// if webpack is installed globally than you can use directly\nwebpack # not recomended to use as global\n</code></pre></div></div>\n\n<p>Entry point is module for which webpack start building out dependency graph\n(search for imports, requires, defines) and create bundles.\nOutput is where to emit the bundles (default <code class=\"highlighter-rouge\">path</code> is <code class=\"highlighter-rouge\">./dist</code>).\nLoader is used to process webpack modules (files that use <code class=\"highlighter-rouge\">import</code>, <code class=\"highlighter-rouge\">require()</code>,\n<code class=\"highlighter-rouge\">@import</code>, <code class=\"highlighter-rouge\">url()</code>) and use coffescript, typescript, sass processors. It has\n<code class=\"highlighter-rouge\">test</code> property (which files should be transformed) and <code class=\"highlighter-rouge\">use</code> which loader.\nPlugins are use to perform wider range of tasks like uglify.\n<code class=\"highlighter-rouge\">./dist/</code> is default output path folder, and you can open <code class=\"highlighter-rouge\">gnome-open\ndist/index.html</code>.</p>\n\n<p>Asset Management with loaders (<code class=\"highlighter-rouge\">npm install --save-dev style-loader</code>)</p>\n\n<ul>\n  <li>\n    <p><code class=\"highlighter-rouge\">style-loader</code> will in javascript create and attach to head as inline <code class=\"highlighter-rouge\">&lt;style\n  type=\"text/css\"&gt;.my-style-from-file{}&lt;/style&gt;</code>. It needs to be called in js\n  <code class=\"highlighter-rouge\">import './my_style.css'</code> to define which file will be imported.</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">css-loader</code> will interprets <code class=\"highlighter-rouge\">@import</code> and <code class=\"highlighter-rouge\">url()</code> and copy file using random\nfile name\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// src/style.css\n.background {\n  background: url('./img.png');\n}\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">file-loader</code> handles files\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import myImage from './img.png'\nmyImage // random-name-of-image.png\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p><code class=\"highlighter-rouge\">html-loader</code> handles <code class=\"highlighter-rouge\">&lt;img src=\"./my-image.png\"&gt;</code>.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>module: {\n  rules: [\n    {\n      test: /\\.css$/,\n      use: [\n        'style-loader',\n        'css-loader'\n      ]\n    },\n    {\n      test: /\\.(png|svg|jpg|gif)$/,\n      use: [\n        'file-loader'\n      ]\n    },\n    {\n      test: /\\.(woff|woff2|eot|ttf|otf)$/,\n      use: [\n        'file-loader'\n      ]\n    }\n  ]\n}\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>Input and Output\nFor several input files you can generate <code class=\"highlighter-rouge\">[name].bundle.js</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// webpack.config.js\nconst path = require('path')\n\nmodule.exports = {\n  entry: {\n    app: './src/index.js',\n    print: './src/print.js'\n  },\n  output: {\n    filename: '[name].bundle.js',\n    path: path.resolve(__dirname, 'dist')\n  }\n}\n</code></pre></div></div>\n\n<p>We need to manually include those generated files in <code class=\"highlighter-rouge\">index.html</code>,  it is easier\nto automatically include https://github.com/jantimon/html-webpack-plugin\nOutput management is needed to automatically include compiled assets (which are\nfingerprinted) using <code class=\"highlighter-rouge\">HtmlWebpackPlugin</code> installed with <code class=\"highlighter-rouge\">npm install --save-dev\nhtml-webpack-plugin</code> and it will generate <code class=\"highlighter-rouge\">dist/index.html</code> which includes all\ngenerated stuff.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// webpack.config.js\n  plugins: [\n    new HtmlWebpackPlugin({\n      title: 'Output management'\n    })\n  ],\n</code></pre></div></div>\n\n<p>You can pass env params on command line and extract common config</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// build-utils/webpack.common.js\nconst commonPaths = require('./common-paths.js');\n\nmodule.exports = {\n  entry: './src/index.js',\n  output: {\n    filename: 'bundle.js',\n    path: commonPaths.output,\n  },\n};\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// build-utils/common-paths.js\nconst path = require('path');\n\nmodule.exports = {\n  outputPath: path.resolve(__dirname, '../', 'dist'),\n};\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// webpack.config.js\nconst commonConfig = require('./build-utils/webpack.common');\n\nmodule.exports = (env) =&gt; {\n  console.log(env);\n  return commonConfig;\n};\n</code></pre></div></div>\n<p>https://webpack.academy/courses/web-fundamentals/lectures/2987268</p>\n\n<p>https://www.npmjs.com/package/clean-webpack-plugin\nYou can clean dist folder before each build</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install clean-webpack-plugin --save-dev\n\n# webpack.config.js\nconst CleanWebpackPlugin = require('clean-webpack-plugin');\n\n  plugins: [\n    new CleanWebpackPlugin(['dist']),\n</code></pre></div></div>\n\n<p>Use\n<a href=\"https://github.com/danethurber/webpack-manifest-plugin\">WebpackManifestPlugin</a>\nfor manifest about what is included in build.</p>\n\n<p>Add <code class=\"highlighter-rouge\">devtool: 'inline-source-map',</code> to provide source maps.</p>\n\n<p>webpack-dev-server for live reloading when code is changed</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install --save-dev webpack-dev-server\n\n# webpack.config.js\n  devServer: {\n    contentBase: './dist'\n  },\n\n# package.json\n  \"scripts\": {\n    \"test\": \"echo \\\"Error: no test specified\\\" &amp;&amp; exit 1\",\n    \"start\": \"webpack-dev-server --open\",\n\nnpm start\n</code></pre></div></div>\n\n<p>HMR Hot module replacement</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># webpack.config.js\nconst webpack = require('webpack');\nmodule.exports = {\n  devServer: {\n    contentBase: './dist',\n    hot: true\n  },\n  plugins: [\n    new webpack.NamedModulesPlugin(),\n    new webpack.HotModuleReplacementPlugin()\n\n\n# src/index.js\nif (module.hot) {\n  module.hot.accept('./print.js', function() {\n    console.log('Accepting the updated printMe module!');\n    printMe();\n    document.body.removeChild(element);\n    element = component(); // Re-render the \"component\" to update the click handler\n    document.body.appendChild(element);\n  })\n}\n</code></pre></div></div>\n\n<p>Babel-loader\nhttps://github.com/babel/babel-loader</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install \"babel-loader@^8.0.0-beta\" @babel/core @babel/preset-env webpack\n</code></pre></div></div>\n\n<p><a href=\"https://medium.com/statuscode/introducing-webpacker-7136d66cddfb\">https://medium.com/statuscode/introducing-webpacker-7136d66cddfb</a></p>\n\n<p>Webpack uses <code class=\"highlighter-rouge\">webpack.config.js</code> and compile for your using Loaders and Plugins.\nInstall loaders with <code class=\"highlighter-rouge\">yarn add --dev webpack babel-core babel-loader\nbabel-preset-react babel-preset-es2015 node-sass css-loader sass-loader\nstyle-loader</code> and use with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// webpack.config.js\n// This library allows us to combine paths easily\nconst path = require('path');\nmodule.exports = {\n   entry: path.resolve(__dirname, 'src', 'index.jsx'),\n   output: {\n      path: path.resolve(__dirname, 'output'),\n      filename: 'bundle.js'\n   },\n   resolve: {\n      extensions: ['.js', '.jsx']\n   },\n   module: {\n      rules: [\n         {\n             test: /\\.jsx/,\n             use: {\n                loader: 'babel-loader',\n                options: { presets: ['react', 'es2015'] }\n             }\n         },\n         {\n            test: /\\.scss/,\n            use: ['style-loader', 'css-loader', 'sass-loader']\n         }\n      ]\n   }\n};\n</code></pre></div></div>\n\n<h1 id=\"webpack-plugins\">Webpack plugins</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn add webpack-bundle-analyzer --dev\n// config/webpack/development.js\nconst BundleAnalyzerPlugin =\nrequire('webpack-bundle-analyzer').BundleAnalyzerPlugin;\nmodule.exports = environment.toWebpackConfig().merge({\n  plugins: [\n    new BundleAnalyzerPlugin({analyzerMode: 'static'})\n  ]\n});\n\n# bin/webpack-dev-server\n# /home/orlovic/rails/myApp/public/packs/report.html\n</code></pre></div></div>\n\n<h1 id=\"webpacker\">Webpacker</h1>\n\n<p>From sprockets to webpacker\n<a href=\"https://medium.com/@coorasse/goodbye-sprockets-welcome-webpacker-3-0-ff877fb8fa79\">https://medium.com/@coorasse/goodbye-sprockets-welcome-webpacker-3-0-ff877fb8fa79</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n# instead of sprockets\ngem 'webpacker', '~&gt; 3.4'\n\nbundle\nbundle exec rails webpacker:install\n</code></pre></div></div>\n\n<p>Put your ‘entry’ module files in <code class=\"highlighter-rouge\">app/javascript/packs</code> and your pure js files\nin <code class=\"highlighter-rouge\">app/javascript</code> or <code class=\"highlighter-rouge\">app/javascript/src</code> which you can load (just run)\n<code class=\"highlighter-rouge\">import '../my_file'</code>.\nGlobal functions will not pollute global scope, you need to attach to window or\nglobal object.\nReload js files automatically with webpacker dev server</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bin/webpack-dev-server\n</code></pre></div></div>\n\n<p>Refence each file in packs folder with (restart dev seerver)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/layouts/application.html.erb %&gt;\n  &lt;%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %&gt;\n</code></pre></div></div>\n\n<p>Add npm packages: jquery turbolinks bootstrap</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn add jquery rails-ujs turbolinks bootstrap popper.js\n</code></pre></div></div>\n\n<p>Configure jquery as plugin</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// config/webpack/environment.js\nconst webpack = require('webpack');\nenvironment.plugins.append('Provide', new webpack.ProvidePlugin({\n  $: 'jquery',\n  jQuery: 'jquery',\n  Popper: ['popper.js', 'default']\n}));\n\n// or if you load jQuery in script tag\nenvironment.config.external = {\n  jquery: 'jQuery'\n}\n\nmodule.exports = environment\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/javascript/packs/application.js\nimport Rails from 'rails-ujs';\nimport Turbolinks from 'turbolinks';\n\nRails.start();\nTurbolinks.start();\n\n$(function () {\n  console.log('Hello World from Webpacker');\n});\n\n# if you need jquery globally attach to window or global object\nglobal.$ = require('jquery')\nwindow.$ = window.jQuery = require(\"jquery\")\n</code></pre></div></div>\n\n<p>For stylesheets create new module and move files and import in scss. Use tilda\nwhen referencing node modules.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/javascript/packs/stylesheets.scss\n@import '~bootstrap/scss/bootstrap';\n</code></pre></div></div>\n\n<p>For css from gems create package.json</p>\n\n<p>https://github.com/rails/webpacker/issues/57#issuecomment-327533578</p>\n\n<p>todo\nhttps://youtu.be/fKOq5_2qj54?t=602</p>\n\n<h1 id=\"parcel\">Parcel</h1>\n\n<p>Install with <code class=\"highlighter-rouge\">yarn global add parcel-bundler</code></p>\n\n<h1 id=\"makefile\">Makefile</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>make help\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Css And Html Tips",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/04/13/css-and-html-tips/",
      "date"     : "2016-04-13 00:00:00 +0200",
      "content"  : "<ul>\n  <li>when you want to have smaller input field type number (smaller in terms of\nwidth) you need to provide both <code class=\"highlighter-rouge\">min</code> and <code class=\"highlighter-rouge\">max</code>, like <code class=\"highlighter-rouge\">&lt;input type=\"number\"\nmin=\"0\" max=\"99\"&gt;</code></li>\n  <li>to hide long text on div/dt <code class=\"highlighter-rouge\">width: 100px</code> than you can:\n    <ul>\n      <li>long string  <code class=\"highlighter-rouge\">overflow: hidden; text-overflow: ellipsis;</code> To show on hover,\nfocus or active (when selecting text) use this helper\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// &lt;div class='long-string-three-dots'&gt;long long&lt;/div&gt;\n.long-string-three-dots {\ntext-overflow: ellipsis;\noverflow: hidden;\n// white-space: nowrap;\n&amp;:active, &amp;:hover, &amp;:focus {\n  text-overflow: initial;\n  overflow: auto;\n}\n}\n</code></pre></div>        </div>\n      </li>\n      <li>long text can be in one line <code class=\"highlighter-rouge\">white-space: nowrap;</code> no wrap means it will no\ngo to the next line even for white space (this is used in <code class=\"highlighter-rouge\">navbar-brand</code>). To\nmake it go to next line define something like <code class=\"highlighter-rouge\">.white-space-normal</code>.</li>\n      <li>long strings can be shown on multiple lines with <code class=\"highlighter-rouge\">word-wrap: break-word</code>\nthis will break long string to multiple lines (for text <code class=\"highlighter-rouge\">white-space: normal</code>)</li>\n    </ul>\n  </li>\n  <li>if you have <code class=\"highlighter-rouge\">&lt;small&gt;</code> position relative, and apply left -100px, it will still\noccupy the space where it was. It is better to use <code class=\"highlighter-rouge\">position: absolute</code></li>\n  <li>to move element to the right but keep inside parent element you need to mark\nparent as <code class=\"highlighter-rouge\">position: relative</code> and than use <code class=\"highlighter-rouge\">position: absolute; right: 10px</code></li>\n  <li>align element at bottom use position relative/absolute pair, for parrent\n<code class=\"highlighter-rouge\">position: relative</code> (does not have any effects) and for child: <code class=\"highlighter-rouge\">position:\nabsolute;bottom: 10px;</code>. This\n<a href=\"http://stackoverflow.com/questions/17656623/position-absolute-scrolling\">question</a>\nexplains why outer need to be relative.</li>\n  <li>use <code class=\"highlighter-rouge\">mouseenter</code> instead <code class=\"highlighter-rouge\">mouseover</code> (which will retrigger on inner elements).</li>\n  <li>\n    <p>use relative units instead of absolute\n<a href=\"http://www.w3schools.com/cssref/css_units.asp\">http://www.w3schools.com/cssref/css_units.asp</a>, for example header <code class=\"highlighter-rouge\">h1 {\nfont-size: 20vh;}</code>. vh is 1% of vertical heigh of view port (window size, not\npage size). For width you can use horizontal width for example <code class=\"highlighter-rouge\">width: 8vw;</code>.\nYou should use relative size <code class=\"highlighter-rouge\">rem</code> (to the html el) or <code class=\"highlighter-rouge\">em</code> (to the current\nfont) since you might want to change font size on whole page, and you do not\nneed to go to all nested components to update that. 1rem is default font size\nusually 16px, bootstrap was 14px now is also 16px.</p>\n  </li>\n  <li>you can not set the width of inline elements, so to set width of <code class=\"highlighter-rouge\">span</code> you\nneed to make it <code class=\"highlighter-rouge\">display:inline-block; width: 100px</code>. Also if you have text\nthan <code class=\"highlighter-rouge\">inline</code> or <code class=\"highlighter-rouge\">inline-block</code> element with <code class=\"highlighter-rouge\">block</code> inside, it will behave\ndifferently\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>          inline-block\nsome_text nested_block\n</code></pre></div>    </div>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>some_text inline\nnested_block\n</code></pre></div>    </div>\n  </li>\n  <li>also top and bottom padding has no efect for label since it is an inline\nelement\n<a href=\"http://stackoverflow.com/questions/7168658/why-is-the-padding-not-working-on-my-label-elements\">link</a>.\nYou need to make the label a block level element for it to work.</li>\n  <li>space inside a element is important. for example <code class=\"highlighter-rouge\">&lt;label&gt;1&lt;/label&gt;&lt;label&gt; 2\n&lt;/label&gt;&lt;label&gt; 3 &lt;/label&gt;</code> with <code class=\"highlighter-rouge\">label { background: blue;}</code> this background\nwill occupy only character and it will be disconnected from 1-2, but connected\n2-3. This margin-like separation will also be presented if <code class=\"highlighter-rouge\">label { display:\ninline-block; }</code>. It seems that space is important only with inline elements.</li>\n  <li>\n    <p>if you need to render divs horizontaly (<code class=\"highlighter-rouge\">float: left</code>) you need parent to have\n<code class=\"highlighter-rouge\">width = number_of_items * (item_width+2*item_border_width)</code> I calculate that\nin javascript</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;script&gt;\n  $(function() {\n    $('.slots-preview').width($('.slots-preview-item').first().outerWidth() * &lt;%= scheduler.number_of_free_slots.count %&gt;);\n  });\n&lt;/script&gt;\n</code></pre></div>    </div>\n\n    <p>You can add scrollbar by wrapping it <code class=\"highlighter-rouge\">.outer { overflow-x: scroll }</code>\n<a href=\"http://stackoverflow.com/questions/9672176/prevent-floated-divs-from-wrapping-to-new-line\">link</a></p>\n  </li>\n  <li>\n    <p>textarea (rails <code class=\"highlighter-rouge\">f.text_area</code>) has constant size, so if you want bigger you\ncan set <code class=\"highlighter-rouge\">rows=\"30\"</code> (and <code class=\"highlighter-rouge\">cols=\"150\"</code>) or use\n<a href=\"http://www.jacklmoore.com/autosize/\">autosize</a></p>\n  </li>\n  <li>when you use padding than child with <code class=\"highlighter-rouge\">width: 100%</code> it is calculated based on\nparent content (parent border and padding is added). Solution is to use\n<code class=\"highlighter-rouge\">box-sizing: border-box</code> in which calculated size will include border and\npadding <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/box-sizing\">https://developer.mozilla.org/en-US/docs/Web/CSS/box-sizing</a>. This is\nusually included in bootstrap. Problem with padding arise when you use\n<code class=\"highlighter-rouge\">position: relative</code> on parent and <code class=\"highlighter-rouge\">position: absolute</code> on child\n<a href=\"https://stackoverflow.com/questions/17115344/absolute-positioning-ignoring-padding-of-parent\">https://stackoverflow.com/questions/17115344/absolute-positioning-ignoring-padding-of-parent</a>\nSolution is to add relatively position div with no padding around absolutely\nposition div. So when you are using padding and absolute position child,\nalways add child relative wrapper with no padding.\nAnother solution is to use <code class=\"highlighter-rouge\">left: 0;</code> on absolutively child.</li>\n</ul>\n\n<h1 id=\"examples\">Examples</h1>\n\n<ul>\n  <li>\n    <p>nice radio and checkbox <a href=\"http://codepen.io/BrianSassaman/pen/iLrpC?editors=1100\">http://codepen.io/BrianSassaman/pen/iLrpC?editors=1100</a></p>\n  </li>\n  <li>\n    <p>to see cursor position just run this code in console (it works with bootstrap\ntitle)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>document.onmousemove = function(e){\nvar x = e.pageX;\nvar y = e.pageY;\ne.target.title = \"X is \"+x+\" and Y is \"+y;\n};\n}\n</code></pre></div>    </div>\n  </li>\n  <li>hide something but still occupy space you can use <code class=\"highlighter-rouge\">visibility: hidden</code> and\n<code class=\"highlighter-rouge\">visibility: visible</code></li>\n  <li>glitch efect <a href=\"https://tympanus.net/Development/GlitchSlideshow/index2.html\">https://tympanus.net/Development/GlitchSlideshow/index2.html</a></li>\n</ul>\n\n<h1 id=\"scss-sass\">SCSS Sass</h1>\n\n<ul>\n  <li>you can set default value of variable <code class=\"highlighter-rouge\">$my-var: 123 !default;</code>. This has no\neffect if variable is already defined.\nIn CSS you can define var with <code class=\"highlighter-rouge\">--main-color: black;</code> and use with <code class=\"highlighter-rouge\">color:\nvar(--main-color);</code>. Var are usually decraler on pseudo class <code class=\"highlighter-rouge\">:root {\n--main-color: black; }</code> so it is accessible everywhere, instead of local scope\n(since this is custom property, it is accessible only on matching selector and\nits descendants) which is used only for specific elements like BEM</li>\n  <li><a href=\"https://responsivedesign.is/develop/getting-started-with-sass\">https://responsivedesign.is/develop/getting-started-with-sass</a></li>\n  <li>\n    <p>you can select <code class=\"highlighter-rouge\">this</code> using <code class=\"highlighter-rouge\">&amp;</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.a:hover {\n  background: blue;\n}\n// is the same as\n.a {\n  &amp;:hover {\n    background: blue;\n  }\n}\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>prefer mixins to <code class=\"highlighter-rouge\">@extend</code>. You can pass parameter to mixin and set default\nvalue</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@mixin grid($my_var: true) {\n  // code here\n}\n</code></pre></div>    </div>\n\n    <p>When defining mixin you can use <code class=\"highlighter-rouge\">@content</code> for example</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@mixin hover-focus {\n  &amp;:hovoer,\n  &amp;:focus {\n    @content;\n  }\n}\n# usage:\n# .class {\n#   @include hover-focus {\n#     text-decoration: none;\n#   }\n# }\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h2 id=\"sass\">SASS</h2>\n\n<p>Sass is shorter since it uses indent, and do not require semicolon.\nAtomatic convert scss to sass</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sass-convert -F scss -T sass application_styles.css.scss application_styles.css.sass\n</code></pre></div></div>\n\n<p>Instead of scss</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># scss\n@mixin border-radius($radius) {\n  border-radius: $radius;\n}\n\n.box {\n  @include border-radius(10px);\n}\n\n# sass\n=border-radius($radius)\n  border-radius: $radius\n\n.box\n  +border-radius(10px)\n</code></pre></div></div>\n\n<h1 id=\"head-meta-tags\">Head meta tags</h1>\n\n<ul>\n  <li>here is a list of used tags <a href=\"https://github.com/joshbuchea/HEAD\">HEAD</a></li>\n  <li>chrome 39 for android use different color for toolbar, just add <code class=\"highlighter-rouge\">&lt;meta\nname=\"theme-color\" content=\"#db5945\"&gt;</code></li>\n</ul>\n\n<h1 id=\"css-helper-classes\">Css helper classes</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// add some space below\n.m-b-10 {\n  margin-bottom: 10px;\n}\n\n// similar to pull-right just without float\n.text-align-right {\n  text-align: right;\n}\n\n// hide  submit buttons, since android has problems when element is not visible\n.hide-to-up {\n  position:absolute;\n  top: -1000px;\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// Here is example to show hide buttons that are not allowed for first or last\n//\n// &lt;ol&gt;\n//   &lt;!-- iterate over li --&gt;\n//   &lt;li  class=\"hide-first-child hide-last-child\"&gt;\n//     &lt;a class=\"hide-first-target\"&gt;&lt;i class=\"fa fa-arrow-up\"&gt;&lt;/li&gt;&lt;/a&gt;\n//     &lt;a class=\"hide-last-target\"&gt;&lt;i class=\"fa fa-arrow-down\"&gt;&lt;/li&gt;&lt;/a&gt;\n//   &lt;/li&gt;\n// &lt;/ol&gt;\n\n.hide-first-child:first-child .hide-first-target {\n  display: none;\n}\n\n.hide-last-child:last-child .hide-last-target {\n  display: none;\n}\n\n// if you need to nest two show hide (you have another ul inside li)\n.hide-first-child:first-child {\n  .hide-first-target {\n    display: none;\n  }\n  .hide-first-child {\n    .hide-first-target {\n      display: initial;\n    }\n    &amp;:first-child {\n      .hide-first-target {\n        display: none;\n      }\n    }\n  }\n}\n\n.hide-last-child:last-child {\n  .hide-last-target {\n    display: none;\n  }\n  .hide-last-child {\n    .hide-last-target {\n      display: initial;\n    }\n    &amp;:last-child {\n      .hide-last-target {\n        display: none;\n      }\n    }\n  }\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// show on hover\n//\n//  &lt;li class=\"show-on-hover\"&gt;\n//    Text&lt;a href=\"\" class=\"show-on-hover-target\"&gt;X&lt;/a&gt;\n//  &lt;/li&gt;\n.show-on-hover-target {\n  visibility: hidden;\n}\n.show-on-hover:hover {\n  .show-on-hover-target {\n    visibility: visible;\n  }\n}\n\n// add class show to stay visible when not hovering, bootstrap dropdown does dat\n.show-on-hover-target.show {\n  visibility: visible;\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// expand on hover\n// used on index tables when some data is too long to be always shown\n//\n// &lt;td class=\"expand-on-hover\"&gt;&lt;%= account.uuid %&gt;&lt;/td&gt;\n\n.expand-on-hover {\n  width: 20px;\n  height: 10px;\n  overflow: hidden;\n  float: left;\n}\n.expand-on-hover:hover {\n  width: inherit;\n}\n</code></pre></div></div>\n\n<p>To expand block on click use input checkbox\nhttps://www.sitepoint.com/pure-css-off-screen-navigation-menu/</p>\n\n<p>Note that input is before label, which is before target</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/stylesheets/common/show_hide.sass\n// toggle active without javascript\n// &lt;input type=\"checkbox\" id=\"toggle-active\" class=\"toggle-active\" /&gt;\n// &lt;label for=\"toggle-active\"&gt;&lt;%= t('add') %&gt;&lt;/label&gt;\n// &lt;div class=\"toggle-active-target hide-not-important\"&gt;\n// &lt;/div&gt;\n// https://www.sitepoint.com/pure-css-off-screen-navigation-menu/\n.toggle-active {\n  position: absolute;\n  clip: rect(0, 0, 0, 0);\n\n  &amp;:checked ~ .toggle-active-target {\n    display: initial;\n  }\n}\nlabel[for=\"toggle-active\"] {\n  cursor: pointer;\n}\n</code></pre></div></div>\n\n<p>To show active on click in pure css use <code class=\"highlighter-rouge\">li:hover { color: blue }</code></p>\n\n<h1 id=\"design\">Design</h1>\n\n<ul>\n  <li>when you are asking user to select items from long lists, you should have\n<code class=\"highlighter-rouge\">Next</code> before and after the list so user does not need to scroll</li>\n  <li>be proactive with messages, when user needs to type password again (for\nexample signin with fb and confirm) than write <code class=\"highlighter-rouge\">Excellent, we need just...</code></li>\n  <li>\n    <p>when hover on footer link, other link in same block should be opacity\n<a href=\"https://www.parse.com/home/index\">demo</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ul:hover li:hover {\n  opacity: 1;\n}\nul:hover li {\n  opacity: 0.4;\n}\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"image\">Image</h1>\n\n<p>Swap images and zoom on hower https://www.filamentgroup.com/lab/sizes-swap/</p>\n\n<p>To set image as background and put some text and form on it you need to make the\nimage transparent (or white) on that part.\nFor navbar, easiest way is to use <code class=\"highlighter-rouge\">fixed-top</code> and <code class=\"highlighter-rouge\">z-index: 1031</code> on image so it\nis above navbar.\nInside page links with anchor does not work with turbolinks, so you need to\ndisable it.</p>\n\n<h1 id=\"flex\">Flex</h1>\n\n<p>https://css-tricks.com/snippets/css/a-guide-to-flexbox/#flexbox-background\nhttps://medium.com/@js_tut/flexbox-the-animated-tutorial-8075cbe4c1b2</p>\n\n<p>Parent element is flex container and children are flex items. <code class=\"highlighter-rouge\">flex-direction</code>\ndetermines main axis on which items will be laid out from <code class=\"highlighter-rouge\">main-start</code>\n(<code class=\"highlighter-rouge\">flex-start</code>) to <code class=\"highlighter-rouge\">main-end</code> (<code class=\"highlighter-rouge\">flex-end</code>), that is total <code class=\"highlighter-rouge\">main-size</code>.\nPerpendicular to the main axis is <code class=\"highlighter-rouge\">cross</code> axis with its <code class=\"highlighter-rouge\">cross-start</code>\n<code class=\"highlighter-rouge\">cross-end</code> and <code class=\"highlighter-rouge\">cross-size</code>.</p>\n\n<p>On container <code class=\"highlighter-rouge\">display: flex</code> (synonim is <code class=\"highlighter-rouge\">inline-flex</code>) we can have:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">flex-direction: row | row-reverse | column | column-reverse</code> row means that\nflexible items are aligned horizontally as row</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">flex-wrap: nowrap | wrap | wrap-reverse</code> default is no wrap so in single\nline, wrap means that it is allowed to go onto multiple lines. This two\nproperites can be shorhanded in one <code class=\"highlighter-rouge\">flex-flow: row nowrap</code> which is default\n(child with <code class=\"highlighter-rouge\">width: 100px</code> will be <code class=\"highlighter-rouge\">width: 12px</code> if there is no space, unless\n<code class=\"highlighter-rouge\">flex-shrink</code> is used).</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">justify-content: flex-start | flex-end | center | space-between |\nspace-around | space-evenly</code> alignment when items are inflexible. space around\nmeans that all items have same space around (before first there is no items so\nthat’s why it is single space) if you need exactly same space from start to\nfirst and first to second, use space-evenly.</li>\n  <li><code class=\"highlighter-rouge\">align-items: flex-start | flex-end | center | stretch | baseline</code> behavior\nalong CROSS AXIS on current line similar to <code class=\"highlighter-rouge\">justify-content</code> but for cross\naxis. <code class=\"highlighter-rouge\">stretch</code> is from <code class=\"highlighter-rouge\">cross-start</code> to <code class=\"highlighter-rouge\">cross-end</code> still respect\nmin-width/max-width. <code class=\"highlighter-rouge\">baseline</code> when text are on the same line.</li>\n  <li><code class=\"highlighter-rouge\">align-content: flex-start | flex-end | center | stretch | space-between |\nspace-around</code> behavior of LINES (wrap is enabled) when there is extra space in\ncross-axis (no effect is single line) similar to <code class=\"highlighter-rouge\">justify-content</code> for main\naxis, but for lines.</li>\n</ul>\n\n<p>on items https://www.w3.org/TR/css-flexbox-1/#flexibility</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">flex-grow: 0</code> ability to grow as proportion to other items (all items need to\ndefined <code class=\"highlighter-rouge\">flex-grow</code>). If one has 2 and all others have 1, first will be twice\nbigger (<code class=\"highlighter-rouge\">width</code> is changed, but do not use it since it will have some impact,\nfor example if <code class=\"highlighter-rouge\">width: 150px</code> for sidebar and content <code class=\"highlighter-rouge\">flex-grow: 1</code> than\nif content is smaller -&gt; sidebar 150px, but when content has a table than\nsidebar will be less than 150px, so better is to use <code class=\"highlighter-rouge\">min-width: 150px</code>).</li>\n  <li><code class=\"highlighter-rouge\">flex-shrink: 1</code> ability to shrik (compress), if <code class=\"highlighter-rouge\">flex-shrink: 0</code> than it will\nkeep it’s <code class=\"highlighter-rouge\">width: 500px</code> property</li>\n  <li><code class=\"highlighter-rouge\">flex-basis: 20% | auto</code> default size before remaining space is distributed\n(use this if you want max-size: 20%)\nThis three items have shorthand <code class=\"highlighter-rouge\">flex: flex-grow flex-shrink flex-basis\n(default 0 1 auto)</code> which you can attach to flex item. For example:\n    <ul>\n      <li><code class=\"highlighter-rouge\">flex: auto</code> auto means that if item can use space it will use space. it is\nsynonim to <code class=\"highlighter-rouge\">flex: 1 1 auto</code> bigger item will take bigger space (on container\nremove <code class=\"highlighter-rouge\">justify-content</code>)</li>\n      <li><code class=\"highlighter-rouge\">flex: 1</code> is eq to <code class=\"highlighter-rouge\">flex: 1 1 0</code> all items same width (flex-basis 0 so their\ncontent is not taken into consideration)</li>\n      <li><code class=\"highlighter-rouge\">flex: 1 100%</code> (eq to <code class=\"highlighter-rouge\">flex: 1 1 100%</code>) inside <code class=\"highlighter-rouge\">wrap</code> all items takes row</li>\n      <li><code class=\"highlighter-rouge\">flex: 3 0px</code> this item is 3 times bigger than others which are <code class=\"highlighter-rouge\">1</code> (<code class=\"highlighter-rouge\">wrap&gt;*\n { flex: 1 auto}</code>) and do not take it’s initial size into account</li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">align-self: flex-start | flex-end | center | stretch | baseline</code> override\n<code class=\"highlighter-rouge\">align-items</code> for specific item, on cross axis</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">order: 0</code> when you want to show in different order <code class=\"highlighter-rouge\">order: 1</code> <code class=\"highlighter-rouge\">order: 2</code></p>\n  </li>\n  <li><a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/justify-items\">justify-items</a>\n property defines the default justify-self for all items for a <code class=\"highlighter-rouge\">display: grid</code>.</li>\n</ul>\n\n<p>Examples:\nhttps://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Flexible_Box_Layout/Typical_Use_Cases_of_Flexbox</p>\n<ul>\n  <li>perfect centering horizontaly and vertically of one width/height card\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.card-container\n  display: flex\n  height: 20px\n  justify-content: center\n  align-items: center\n.card\n  width: 10px\n  height: 10px\n</code></pre></div>    </div>\n  </li>\n  <li>bootstrap layout for example <code class=\"highlighter-rouge\">.col-md-6 { flex: 0 0 50%; max-witdh; 50% }</code>\nYou can use <code class=\"highlighter-rouge\">margin-left: auto</code> to separate group of items since auto margin\nwill took as much space as it can. So you can align first three on left and last\ntwo on right by adding <code class=\"highlighter-rouge\">.push</code> on firt right item.</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.box {\n  display: flex;\n}\n.push {\n    margin-left: auto;\n}\n\n&lt;div class=\"box\"&gt;\n  &lt;div&gt;One&lt;/div&gt;\n  &lt;div&gt;Two&lt;/div&gt;\n  &lt;div&gt;Three&lt;/div&gt;\n  &lt;div class=\"push\"&gt;Four&lt;/div&gt;\n  &lt;div&gt;Five&lt;/div&gt;\n&lt;/div&gt;\n</code></pre></div></div>\n\n<p>Om mobile you probably want all buttons to take all space so use <code class=\"highlighter-rouge\">flex: auto</code> or\n<code class=\"highlighter-rouge\">flex: 1</code> if you want same size buttons.</p>\n\n<p>https://hacks.mozilla.org/2018/01/new-flexbox-guides-on-mdn/\nhttps://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Flexible_Box_Layout/Basic_Concepts_of_Flexbox</p>\n\n<p>Flexbox</p>\n\n<p>Used in layout in one dimension at a time (either row or column).</p>\n\n<p>CSS Grid https://mozilladevelopers.github.io/playground/css-grid</p>\n\n<h1 id=\"css-box-alignment\">CSS box alignment</h1>\n\n<p>https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Box_Alignment\nolder alignment methoods were:</p>\n<ul>\n  <li>align text using <code class=\"highlighter-rouge\">text-align</code> In bootstra for text you can use <code class=\"highlighter-rouge\">text-center</code>\n<code class=\"highlighter-rouge\">text-right</code> helper classes for to align text center and right. Note that if\nyou have some <code class=\"highlighter-rouge\">floating</code> element before than text will not be centered like in\n<code class=\"highlighter-rouge\">&lt;div class='float-right'&gt;log out&lt;/div&gt;&lt;div class='text-center'&gt;Text&lt;/div&gt;</code></li>\n  <li>center blocks using auto <code class=\"highlighter-rouge\">margin</code> for block elemenent with <code class=\"highlighter-rouge\">margin: auto</code>\n(bootstrap <a href=\"http://getbootstrap.com/css/#helper-classes-center\">center-block</a>\nhelper) does not have effect unless the element has the width (because it\ncan not calculate margins)</li>\n  <li>in inline-block elements use <code class=\"highlighter-rouge\">vertical-align: baseline</code> for image to be on\nsame bootom as other elements</li>\n  <li>to make vertical align you need parent to be <code class=\"highlighter-rouge\">position: relative</code>, and target\nto be <code class=\"highlighter-rouge\">position:absolute; top: 50%; margin-top: -1rem;</code> (if you show text\n1rem).</li>\n</ul>\n\n<p>There are two axis: inline (main) and block (cros) axis.\nWhen aligning items on inline axis we use properties that starts with <code class=\"highlighter-rouge\">justify-</code>\nand when aligning items on block axis we use <code class=\"highlighter-rouge\">align-</code> (items, self, content).\nWith <code class=\"highlighter-rouge\">flex-direction: row</code> than main axis is block, and cross is inline.\nThree types of alignment:</p>\n<ul>\n  <li><strong>positional alignment</strong> for <code class=\"highlighter-rouge\">-self</code> and <code class=\"highlighter-rouge\">-content</code> specify position of\nsubject with relation to container: <code class=\"highlighter-rouge\">center</code>, <code class=\"highlighter-rouge\">start</code>, <code class=\"highlighter-rouge\">end</code>, <code class=\"highlighter-rouge\">self-start</code>,\n<code class=\"highlighter-rouge\">self-end</code>, <code class=\"highlighter-rouge\">flex-start</code>, <code class=\"highlighter-rouge\">flex-end</code>, <code class=\"highlighter-rouge\">left</code>, <code class=\"highlighter-rouge\">right</code>.</li>\n  <li><strong>baseline alignment</strong> for <code class=\"highlighter-rouge\">-self</code> and <code class=\"highlighter-rouge\">-content</code> specify relationship amount\nbaselines of multiple subjects: <code class=\"highlighter-rouge\">baseline</code>, <code class=\"highlighter-rouge\">first baseline</code>, <code class=\"highlighter-rouge\">last baseline</code></li>\n  <li><strong>distributed alignment</strong> for <code class=\"highlighter-rouge\">-content</code> specify what happens to space after\nsubject have been displayed: <code class=\"highlighter-rouge\">strech</code>, <code class=\"highlighter-rouge\">space-between</code>, <code class=\"highlighter-rouge\">space-around</code>,\n<code class=\"highlighter-rouge\">space-evenly</code></li>\n</ul>\n\n<h1 id=\"table\">Table</h1>\n\n<p>Table has <a href=\"http://www.w3schools.com/cssref/pr_tab_table-layout.asp\">two layouts</a></p>\n<ul>\n  <li><code class=\"highlighter-rouge\">table-layout: auto</code> dependends on widest unbreakable content in the cells</li>\n  <li><code class=\"highlighter-rouge\">fixed</code> faster since browser does not need full content</li>\n</ul>\n\n<p>Rotate header <a href=\"https://css-tricks.com/rotated-table-column-headers/\">link</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;th class=\"rotate\"&gt;&lt;div&gt;&lt;span&gt;Column header 1&lt;/span&gt;&lt;/div&gt;&lt;/th&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>th.rotate {\n  /* Something you can count on */\n  height: 140px;\n  white-space: nowrap;\n}\n\nth.rotate &gt; div {\n  transform:\n    /* Magic Numbers */\n    translate(25px, 51px)\n    /* 45 is really 360 - 45 */\n    rotate(315deg);\n  width: 30px;\n}\nth.rotate &gt; div &gt; span {\n  border-bottom: 1px solid #ccc;\n  padding: 5px 10px;\n}\n</code></pre></div></div>\n\n<h1 id=\"css-selectors\">CSS Selectors</h1>\n\n<p>https://www.w3.org/TR/2011/REC-css3-selectors-20110929/</p>\n\n<ul>\n  <li>type selector</li>\n  <li>universal</li>\n  <li>attribute</li>\n  <li>class</li>\n  <li>id</li>\n  <li>pseudo-classes</li>\n  <li>pseudo-elements</li>\n  <li>combinators</li>\n</ul>\n\n<p>To find you can use https://www.w3.org/TR/selectors-api/</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">querySelector('#bar, #foo')</code> for example return first in document order\n<code class=\"highlighter-rouge\">#foo</code></li>\n  <li><code class=\"highlighter-rouge\">var lis = querySelectorAll('ul&gt;li')</code> we can iterate using array notation\n<code class=\"highlighter-rouge\">for(var i = 0; i &lt; lis.lenght; i++) { lis[i] }</code>. NodeList are static (not\nlive) so changes in DOM do not affect content of the lis</li>\n</ul>\n\n<h1 id=\"jquery\">jQuery</h1>\n\n<p><a href=\"https://code.tutsplus.com/tutorials/14-helpful-jquery-tricks-notes-and-best-practices--net-14405\">some\ntips</a></p>\n\n<ul>\n  <li>jquery selectors\n    <ul>\n      <li><code class=\"highlighter-rouge\">$('thead th[data-searchable!=\"false\"]')</code> select all th that do not have\n<code class=\"highlighter-rouge\">data-searchable</code> or have it but different than <code class=\"highlighter-rouge\">false</code></li>\n    </ul>\n  </li>\n  <li>if jQuery finder returns <code class=\"highlighter-rouge\">n,fn.init</code> that means it did not find DOM elemenent\n<a href=\"http://stackoverflow.com/questions/34494873/why-is-my-jquery-selector-returning-a-n-fn-init0-and-what-is-it\">link</a></li>\n</ul>\n\n<blockquote>\n  <p>when found an element based on the selector criteria it returns the matched\nelements; when the criteria does not match anything it returns the prototype\nobject of the function.</p>\n</blockquote>\n\n<p>With jquery you can create elements <code class=\"highlighter-rouge\">$('&lt;div&gt;')</code>. If you want additional\nproperties you can pass as additional params <code class=\"highlighter-rouge\">var $div = $('&lt;div&gt;', { id: 'foo',\nclass: 'my_class'})</code>.\nYou can join elements with: append, prepend, after and before. Here you can use\njquery objects or plain html: <code class=\"highlighter-rouge\">$('#box').append($div).append('&lt;div\nid=\"foo\"&gt;&lt;/div&gt;')</code>.</p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>\n    <p>submit button outside of a form is\n<a href=\"http://stackoverflow.com/questions/7020659/submit-form-using-a-button-outside-the-form-tag\">possible</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;form id=\"myform\" method=\"get\" action=\"something.php\"&gt;\n&lt;input type=\"text\" name=\"name\" /&gt;\n&lt;/form&gt;\n\n&lt;input type=\"submit\" form=\"myform\" /&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>note that if you have multiple submit inputs and one text input field, when\nyou press Enter, only first submit button will be used (so commit value will be\nit’s value). you can disable submit on enter with</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$('#notification-form').on('keyup keypress', function(e) {\n  var keyCode = e.keyCode || e.which;\n  if (keyCode === 13) {\n    e.preventDefault();\n    return false;\n  }\n});\n</code></pre></div>    </div>\n\n    <p>I made helper data function which will also click. put on document ready or\nturbolinks load.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/turbolinks_loads.coffee\n# f.text_field :email, 'data-prevent-submit-on-enter': '#email-continue'\n$(document).on 'turbolinks:load', -&gt;\n  $('[data-prevent-submit-on-enter]').on 'keyup keypress', (e) -&gt;\n    keyCode = e.keyCode || e.which\n    if keyCode == 13\n      e.preventDefault()\n      $($(this).data().preventSubmit).click() if $(this).data().preventSubmitOnEnter != true\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">&lt;input readonly=\"readonly\"&gt;</code> is better to use than <code class=\"highlighter-rouge\">&lt;input\ndisabled=\"disabled\"&gt;</code> since it can receive focus, included in tabbing navigation\nand values are successfully posted (disabled input is not send to server).</li>\n  <li>if you need two css files, than write two <code class=\"highlighter-rouge\">&lt;link rel=\"stylesheet\"\ntype=\"text/css\" href=\"1.css\" /&gt;</code> . Do not use <code class=\"highlighter-rouge\">@import url(\"2.css\")</code> in\n<code class=\"highlighter-rouge\">1.css</code> since it will prevent downloading files in parallel (2.css is\ndownloaded only after 1.css). Only <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/@import\">use of\n@import</a> is when you\nprovide media queries as parameter and load only for specific screen. Note\nthat sass preprocessor scss <code class=\"highlighter-rouge\">@import</code> will include inline the code.</li>\n  <li>\n    <p>if option select is required, we usually prompt user with one more option\n“Please select”, but it is bad to allow user to pick that option “Please\nselect”. You can disable option, and you should force selected on it if other\noption is not selected <a href=\"http://jsfiddle.net/u8PWX/1/\">demo</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;select onchange=\"this.form.submit()\"&gt;\n    &lt;option selected=\"selected\" disabled=\"true\"&gt;--Please Select --&lt;/option&gt;\n    &lt;option value=\"volvo\"&gt;Volvo&lt;/option&gt;\n    &lt;option value=\"saab\"&gt;Saab&lt;/option&gt;\n  &lt;/select&gt;\n</code></pre></div>    </div>\n\n    <p>In rails, you can use with <code class=\"highlighter-rouge\">select_tag</code>:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= select_tag \"job[job_type_id]\",(\"&lt;option #{ \"selected='selected'\".html_safe unless fjob.object.job_type_id } disabled='disabled'&gt;Job Type&lt;/option&gt;\".html_safe+ options_from_collection_for_select(JobType.active.all, :id, :name,{selected: fjob.object.job_type_id})), { class: \"e1\" } %&gt;\n</code></pre></div>    </div>\n\n    <p>or with <code class=\"highlighter-rouge\">f.collection_select</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.collection_select :user_id, User.all.unshift(User.new id: 0, name:\n  \"Please Select User\"), :id, :name), {}  %&gt;\n</code></pre></div>    </div>\n\n    <p>or <code class=\"highlighter-rouge\">f.select</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.select :shopify_custom_collection_id, [['Please select collection',0]] + @shopify_custom_collections.map { |shopify_custom_collection| [shopify_custom_collection.title, shopify_custom_collection.id] }, disabled: 0, selected: 0 %&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>if you want to filet group select based on first option than use something\nlike</li>\n</ul>\n<p><a href=\"https://stackoverflow.com/questions/32405077/show-second-dropdown-options-based-on-first-dropdown-selection-jquery\">https://stackoverflow.com/questions/32405077/show-second-dropdown-options-based-on-first-dropdown-selection-jquery</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code></code></pre></div></div>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">&lt;a href=\"javascript:void(0)\"&gt;</code> is required when you use <code class=\"highlighter-rouge\">onclick=</code> and do not\nwant page to reload</li>\n  <li><code class=\"highlighter-rouge\">input type=\"checkbox\" onchange=\"perform(this.checked)</code> you can get value with\ninput.checked. with jquery <code class=\"highlighter-rouge\">$(input).is(':checked')</code></li>\n  <li>in css file you can include comment for source maps, for example <code class=\"highlighter-rouge\">/*#\nsourceMappingURL=bootstrap-datepicker3.css.map */</code></li>\n  <li>plain <code class=\"highlighter-rouge\">&lt;input&gt;</code> has default with (probably 157px), but if you want to set\nsize, use <code class=\"highlighter-rouge\">style=\"width: 100%\"</code></li>\n  <li>for modals you need overlay that cover content beside modal, also if you want\nto have background image that is blured, you can use overlay with opacity\nposition absolute that cover whole area.\nhttps://css-tricks.com/snippets/css/transparent-background-images/\nThis use case is when you have my-stuff with forms or something else so you need\nto interact with it. Another use case when you want to add overlay like for\nsubscribed users only, so my-stuff can be opacited and with wrapping my-stuff.\nFirst is solved with sibling div <code class=\"highlighter-rouge\">position: fixed</code> and <code class=\"highlighter-rouge\">z-index: -1</code> and adding\nbackground image to the body (not to fixed element, which is only for overlay\nand opacity) so it scrolls down with content.</li>\n</ul>\n\n<p>Second is solved with position absolute relative pair.\nNote that you should NOT use <code class=\"highlighter-rouge\">height: 100%</code> on cover because it will not cover\nthe area which is not currently in view port (for example you have div height &gt;\nview port size). On <code class=\"highlighter-rouge\">html, body { height: 100% }</code> is OK (and it will show window\nwidth and height) but when cover has greater height than body on smaller screen\nthan it should have <code class=\"highlighter-rouge\">min-height: 100%</code> (not <code class=\"highlighter-rouge\">height: 100%</code>).\nNote that <code class=\"highlighter-rouge\">my-stuff</code> should be inside <code class=\"highlighter-rouge\">gradient</code> so gradient wraps it\ncompletelly (otherwise when they are sibling than gradient can not calculate\nif there is margin on my-stuff).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;style&gt;</span>\n      <span class=\"nt\">html</span><span class=\"o\">,</span> <span class=\"nt\">body</span> <span class=\"p\">{</span>\n        <span class=\"nl\">min-height</span><span class=\"p\">:</span> <span class=\"m\">100%</span><span class=\"p\">;</span>\n        <span class=\"nl\">height</span><span class=\"p\">:</span> <span class=\"m\">100%</span><span class=\"p\">;</span>\n        <span class=\"nl\">padding</span><span class=\"p\">:</span> <span class=\"m\">0px</span><span class=\"p\">;</span>\n        <span class=\"nl\">margin</span><span class=\"p\">:</span> <span class=\"m\">0px</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n\n      <span class=\"nc\">.position-relative</span> <span class=\"p\">{</span>\n        <span class=\"nl\">position</span><span class=\"p\">:</span> <span class=\"nb\">relative</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n      <span class=\"nc\">.position-absolute</span> <span class=\"p\">{</span>\n        <span class=\"nl\">position</span><span class=\"p\">:</span> <span class=\"nb\">absolute</span><span class=\"p\">;</span>\n        <span class=\"nl\">width</span><span class=\"p\">:</span> <span class=\"m\">100%</span><span class=\"p\">;</span>\n        <span class=\"c\">/* we need this when my-stuff is less than view port */</span>\n        <span class=\"nl\">min-height</span><span class=\"p\">:</span> <span class=\"m\">100%</span><span class=\"p\">;</span>\n        <span class=\"c\">/* do not use top bottom, or height: 100% since that is relative to view port */</span>\n        <span class=\"c\">/*\n        top: 0px;\n        bottom: 0px;\n        */</span>\n        <span class=\"c\">/* height: 100%; */</span>\n      <span class=\"p\">}</span>\n      <span class=\"nc\">.my-stuff</span> <span class=\"p\">{</span>\n        <span class=\"nl\">width</span><span class=\"p\">:</span> <span class=\"m\">200px</span><span class=\"p\">;</span>\n        <span class=\"nl\">height</span><span class=\"p\">:</span> <span class=\"m\">200px</span><span class=\"p\">;</span>\n        <span class=\"nl\">margin</span><span class=\"p\">:</span> <span class=\"m\">10px</span> <span class=\"nb\">auto</span><span class=\"p\">;</span>\n        <span class=\"nl\">background</span><span class=\"p\">:</span> <span class=\"no\">blue</span><span class=\"p\">;</span>\n        <span class=\"nl\">height</span><span class=\"p\">:</span> <span class=\"m\">600px</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n      <span class=\"nc\">.my-stuff</span><span class=\"nd\">:hover</span> <span class=\"p\">{</span>\n        <span class=\"nl\">height</span><span class=\"p\">:</span> <span class=\"m\">600px</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n      <span class=\"nc\">.blue-gradient</span> <span class=\"p\">{</span>\n        <span class=\"nl\">opacity</span><span class=\"p\">:</span> <span class=\"m\">.5</span><span class=\"p\">;</span>\n        <span class=\"nl\">-webkit-backface-visibility</span><span class=\"p\">:</span> <span class=\"nb\">hidden</span><span class=\"p\">;</span>\n        <span class=\"nl\">background-color</span><span class=\"p\">:</span> <span class=\"m\">#52d3aa</span><span class=\"p\">;</span>\n        <span class=\"nl\">background-image</span><span class=\"p\">:</span> <span class=\"n\">-webkit-gradient</span><span class=\"p\">(</span><span class=\"n\">linear</span><span class=\"p\">,</span> <span class=\"m\">0%</span> <span class=\"m\">0%</span><span class=\"p\">,</span> <span class=\"m\">100%</span> <span class=\"m\">100%</span><span class=\"p\">,</span> <span class=\"n\">color-stop</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span> <span class=\"m\">#3f95ea</span><span class=\"p\">),</span> <span class=\"n\">color-stop</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">,</span> <span class=\"m\">#52d3aa</span><span class=\"p\">));</span>\n        <span class=\"c\">/* Android 2.3 */</span>\n        <span class=\"nl\">background-image</span><span class=\"p\">:</span> <span class=\"n\">-webkit-repeating-linear-gradient</span><span class=\"p\">(</span><span class=\"nb\">top</span> <span class=\"nb\">left</span><span class=\"p\">,</span> <span class=\"m\">#3f95ea</span> <span class=\"m\">0%</span><span class=\"p\">,</span> <span class=\"m\">#52d3aa</span> <span class=\"m\">100%</span><span class=\"p\">);</span>\n        <span class=\"c\">/* IE10+ */</span>\n        <span class=\"nl\">background-image</span><span class=\"p\">:</span> <span class=\"n\">repeating-linear-gradient</span><span class=\"p\">(</span><span class=\"n\">to</span> <span class=\"nb\">bottom</span> <span class=\"nb\">right</span><span class=\"p\">,</span> <span class=\"m\">#3f95ea</span> <span class=\"m\">0%</span><span class=\"p\">,</span> <span class=\"m\">#52d3aa</span> <span class=\"m\">100%</span><span class=\"p\">);</span>\n        <span class=\"nl\">background-image</span><span class=\"p\">:</span> <span class=\"n\">-ms-repeating-linear-gradient</span><span class=\"p\">(</span><span class=\"nb\">top</span> <span class=\"nb\">left</span><span class=\"p\">,</span> <span class=\"m\">#3f95ea</span> <span class=\"m\">0%</span><span class=\"p\">,</span> <span class=\"m\">#52d3aa</span> <span class=\"m\">100%</span><span class=\"p\">);</span>\n      <span class=\"p\">}</span>\n\n      <span class=\"nc\">.position-fixed-cover</span> <span class=\"p\">{</span>\n        <span class=\"nl\">position</span><span class=\"p\">:</span> <span class=\"nb\">fixed</span><span class=\"p\">;</span>\n        <span class=\"nl\">top</span><span class=\"p\">:</span> <span class=\"m\">0px</span><span class=\"p\">;</span>\n        <span class=\"nl\">bottom</span><span class=\"p\">:</span> <span class=\"m\">0px</span><span class=\"p\">;</span>\n        <span class=\"nl\">width</span><span class=\"p\">:</span> <span class=\"m\">100%</span><span class=\"p\">;</span>\n        <span class=\"nl\">z-index</span><span class=\"p\">:</span> <span class=\"m\">-1</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n      <span class=\"nc\">.background-image</span> <span class=\"p\">{</span>\n        <span class=\"nl\">background-image</span><span class=\"p\">:</span> <span class=\"sx\">url('cat.jpg')</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n    <span class=\"nt\">&lt;/style&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n  <span class=\"nt\">&lt;body</span> <span class=\"na\">class=</span><span class=\"s\">'position-relative background-image'</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">'blue-gradient position-absolute'</span><span class=\"nt\">&gt;</span>\n      blue-gradient position-absolute\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">'my-stuff'</span><span class=\"nt\">&gt;</span>\n        my-stuff\n        <span class=\"nt\">&lt;button&gt;</span>OK<span class=\"nt\">&lt;/button&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">'blue-gradient position-fixed-cover'</span><span class=\"nt\">&gt;</span>blue-gradient position-fixed-cover<span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<ul>\n  <li>another problem is when you add <code class=\"highlighter-rouge\">margin: 10px</code> to some innver div, than\nscrollbar shows up (we use <code class=\"highlighter-rouge\">box-sizing: border-box;</code> so that is not the case).\nhttps://stackoverflow.com/questions/22539053/nested-div-with-margin-top-set-causes-scrollbar-to-appear\nThe problem is in collapsing margins and workaround is: use padding instead of\nmargin, add <code class=\"highlighter-rouge\">overflow: auto</code> to the element with margin, or introduce new\n<a href=\"https://www.w3.org/TR/CSS2/visuren.html#block-formatting\">block formating\ncontext</a> by changing\nto <code class=\"highlighter-rouge\">display: inline-block</code></li>\n  <li>for phone you need to use <code class=\"highlighter-rouge\">&lt;a href=\"tel:123123\"&gt;+123-123&lt;/a&gt;</code> (rails <code class=\"highlighter-rouge\">&lt;%=\nlink_to \"+123-123\", \"tel:123123\" %&gt;</code>)</li>\n  <li>for mail <code class=\"highlighter-rouge\">&lt;a href=\"mailto:asd@asdasd\"&gt;asd@asd.asd&lt;/a&gt;</code> (rails <code class=\"highlighter-rouge\">&lt;%= mail_to\n\"asd@asd.asd\", \"asd@asd.asd\" %&gt;</code>)</li>\n  <li>for event listeners always use <code class=\"highlighter-rouge\">e.currentTarget</code> since it is element on which\nlistener was bound. Do not use <code class=\"highlighter-rouge\">e.target</code> since it could be child element.\nExample <code class=\"highlighter-rouge\">$('[data-user-preferences]').click(function(e) {\ne.currentTarget.dataset.userPreferences\n})</code></li>\n  <li>if you need to click on the underlying elements under other, you can use\n<a href=\"https://stackoverflow.com/questions/3680429/click-through-a-div-to-underlying-elements\">https://stackoverflow.com/questions/3680429/click-through-a-div-to-underlying-elements</a>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pointer-events: none\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>accordion is native in html (you do not need bootstrap accordion collapse in\njavascript)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;details&gt;\n  &lt;summary&gt;Hi&lt;/summary&gt;\n  Bye\n&lt;/details&gt;\n\n&lt;details&gt;\n  &lt;summary&gt;How do I get to New Orleans?&lt;/summary&gt;\n  Use Google Maps.\n&lt;/details&gt;\n</code></pre></div>    </div>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>details {\n  margin: 1rem;\n}\nsummary {\n  font-weight: bold;\n}\n</code></pre></div>    </div>\n\n    <p>You can style different states of defails (<code class=\"highlighter-rouge\">details[open]</code> and\n<code class=\"highlighter-rouge\">details:not[open]</code>) https://codepen.io/jh3y/pen/mLaXRe</p>\n  </li>\n  <li>\n    <p>text input can have focus on page load with  <code class=\"highlighter-rouge\">&lt;input autofocus&gt;</code>\n(<code class=\"highlighter-rouge\">f.text_field :name, autofocus: true</code> in rails)</p>\n  </li>\n  <li>prevent auto completing text inputs can be prevented with `&lt;%= text_field_tag</li>\n  <li>\n    <p>:other_reason, nil, autocomplete: ‘off’ %&gt;` (note is should be ‘off’ not\n‘false’</p>\n  </li>\n  <li>arrows (triangles) can be done with border and before pseudo element\nhttp://krasimirtsonev.com/blog/article/CSS-before-and-after-pseudo-elements-in-practice just paste this snippet</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;style&gt;\nh2 {\n    float: left;\n    width: 170px;\n}\n.popup {\n    float: left;\n    width: 340px;\n    background: #727272;\n    padding: 10px;\n    border-radius: 6px;\n    color: #FFF;\n    position: relative;\n    font-size: 12px;\n    line-height: 20px;\n}\n.popup:before {\n    content: \"\";\n    display: block;\n    width: 0;\n    height: 0;\n    border-top: 12px solid transparent;\n    border-bottom: 12px solid transparent;\n    border-right: 12px solid #727272;\n    position: absolute;\n    top: 16px;\n    left: -12px;\n}\n&lt;/style&gt;\n\n&lt;h2&gt;What is CSS?&lt;/h2&gt;\n&lt;div class=\"popup\"&gt;\n    Cascading Style Sheets is a style sheet language used for describing\n    the presentation semantics of a document written in a markup language.\n&lt;/div&gt;\n</code></pre></div></div>\n\n<ul>\n  <li>usually space is not important in html but if you have some <code class=\"highlighter-rouge\">float</code> and\n<code class=\"highlighter-rouge\">width: 40%</code> than number of spaces is important</li>\n  <li>\n    <p>you can not have <code class=\"highlighter-rouge\">&lt;a&gt;</code> tag inside other <code class=\"highlighter-rouge\">&lt;a&gt;</code> tag, use this validator\nhttps://validator.w3.org/nu/#textarea</p>\n  </li>\n  <li>components and terminology (terms names) on a web page:\n    <ul>\n      <li>accordion is list of blocks that can collapse\nhttps://getbootstrap.com/docs/3.3/javascript/#collapse-example-accordion</li>\n      <li>carousel is big image slider\nhttps://getbootstrap.com/docs/3.3/javascript/#carousel</li>\n      <li>navbar is top header with menu links, in bootstrap_4 it is fluid (spans all\nwidth)</li>\n      <li>flush on some elements\nhttps://getbootstrap.com/docs/4.1/components/list-group/#flush means that\nrounded corners are removed</li>\n      <li>B4 cards replace our old panels, wells, and thumbnails</li>\n      <li>masonry type columns is when element are places optimally basedon vertical\nspace (width is fixed, and height is variable)</li>\n    </ul>\n  </li>\n  <li>if you have two data attributes on click, to disable one from another, you can\ndisable button, for example\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$('[data-enable-if-valid]').on 'click', (e) -&gt;\n  if need_to_disable_both_clicks\n    $button.prop('disabled', 'disabled')\n    setTimeout(\n      -&gt;\n        $button.prop('disabled', false)\n      100\n    )\n\n  # no need to add e.preventDefault() since button is disabled\n</code></pre></div>    </div>\n  </li>\n  <li>page scroll when image is loaded can be prevented with padding bottom https://www.smashingmagazine.com/2016/08/ways-to-reduce-content-shifting-on-page-load/\npadding can be defined in % of the page width so for full width page images\nyou can set padding bottom in %.\nFor not full width images you can set the height in css so it will occupy the\nspace before loading (you can set background also if it is not transparent).\nDo not set only the width since than height is 0 untill the image is loaded.</li>\n  <li>elements with captions are:\n<code class=\"highlighter-rouge\">&lt;figure&gt;&lt;img&gt;&lt;figcaption&gt;I'm caption&lt;/figcaption&gt;&lt;/figure&gt;</code> and \n<code class=\"highlighter-rouge\">&lt;fieldset&gt;&lt;legend&gt;I'm caption of this set&lt;/legent&gt;&lt;input&gt;&lt;/fieldset&gt;</code></li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Rails Tips",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/04/12/rails-tips/",
      "date"     : "2016-04-12 00:00:00 +0200",
      "content"  : "<h1 id=\"validations\">Validations</h1>\n\n<p>Some usefull validations, like validate email regexp</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>validates :email, format: { with: /\\A([^@\\s]+)@((?:[-a-z0-9]+\\.)+[a-z]{2,})\\z/i }\nvalidates :email, format: { with: User.email_regexp, allow_blank: true }\nvalidates :email, uniqueness: { scope: :user_id }\n</code></pre></div></div>\n\n<p>When validating associations, always is <code class=\"highlighter-rouge\">_id</code> since we use that in select input\ninside form (don’t validate object <code class=\"highlighter-rouge\">validates :job_type, presence: true</code> since\nerror will not be shown on <code class=\"highlighter-rouge\">:job_type_id</code>).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>validates :job_type_id, presence: true\n\n&lt;%= f.select :job_type_id, Job.all.map { |job| [job.name, job.id] }, {\nprompt: true }, class: 'my-class' %&gt;\n</code></pre></div></div>\n\n<p>NOTE that in Rails 5.2 we do not need to add presence validations but if you\nwant to disable you can do with <code class=\"highlighter-rouge\">belongs_to :job_type, optional: true</code></p>\n\n<p><a href=\"https://apidock.com/rails/ActionView/Helpers/FormOptionsHelper/select\">form\nselect</a>\ncan accept as 2th param (choices) two variant:</p>\n\n<ul>\n  <li>flat collection <code class=\"highlighter-rouge\">[['name', 123],...]</code></li>\n  <li>if you need manual tags <code class=\"highlighter-rouge\">&lt;select&gt;&lt;option&gt;&lt;/option&gt;&lt;/select&gt;</code> than you can use\n<code class=\"highlighter-rouge\">&lt;%= select tag \"statuses[]\", options_for_select([[]], selected: 1) %&gt;</code></li>\n  <li>\n    <p>nested collection <code class=\"highlighter-rouge\">grouped_options_for_select()</code></p>\n\n    <p>Preselected value can be defined as second param in <code class=\"highlighter-rouge\">options_for_select([],\nselected: f.object.user_id</code>, or as 4th param in\n<code class=\"highlighter-rouge\">options_from_collection_for_select(User, :id, :email, selected:\nf.object.user_id)</code>. Note that it can be <code class=\"highlighter-rouge\">value</code> or hash <code class=\"highlighter-rouge\">selected: value</code>.</p>\n  </li>\n</ul>\n\n<p>as 3th param (options):</p>\n\n<p>Sometimes when options do not include value that you want to set and you\nuse prompt to be shown, please preform check <code class=\"highlighter-rouge\">{ prompt: 'Select package'\n}.merge( options.present? ? { selected: @customer.some_other_package.id\n} : {} )</code>. If target selected value is not in options, that first option will be\nused, or prompt is shown when options is empty.</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">disabled: [values]</code> to disable some options</li>\n  <li><code class=\"highlighter-rouge\">label: 'My label'</code></li>\n  <li><code class=\"highlighter-rouge\">prompt: 'Please select'</code> this is shown only if not already have some value</li>\n  <li><code class=\"highlighter-rouge\">include_blank: 'Please select'</code> this is shown always (even already have\nvalue) I found usefull only with select2 where we use custom placeholder and\nblank option is not selectable <code class=\"highlighter-rouge\">&lt;%= f.select :customer_name_and_username,\noptions_from_collection_for_select(current_location.customers, 'id',\n'name_and_username'),  { include_blank: true, label: 'Customer' },\n'data-select2': true, placeholder: 'Search by Customer Name or Username' %&gt;</code></li>\n</ul>\n\n<p>as 4th params (html options)</p>\n<ul>\n  <li>\n    <p><code class=\"highlighter-rouge\">multiple: true</code> so it is multi_select (instead of dropdown). Multi select\nwill be shown with its own scrollbar (use <code class=\"highlighter-rouge\">size: 5</code> to limit the size).\nIn controller you need to allow arrays</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def event_params\n  params.require(:event).permit(\n    :title, skills: []\n  )\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>Form array can be set on any input, use square brackets <code class=\"highlighter-rouge\">name='user_ids[]'</code>.\n  In view you can set array of hidden fields</p>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> &lt;% @isp_push_packages.isp_package_ids.each do |isp_package_id| %&gt;\n   &lt;%= f.hidden_field 'isp_package_ids[]', value: isp_package_id %&gt;\n &lt;% end %&gt;\n</code></pre></div>    </div>\n    <p>or using select <code class=\"highlighter-rouge\">multiple: true</code> (it will automatically add <code class=\"highlighter-rouge\">[]</code> to the name)</p>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.select isp_package_ids, options, {}, multiple: true %&gt;\n</code></pre></div>    </div>\n    <p>You can also nest in two dimensions ie it will be a hash with array values\n  <code class=\"highlighter-rouge\">name='user_ids[#{company.id}][]</code>. In this case you need to permit hash\n  (Rails 5.2) or whitelist in before Rails 5.2</p>\n  </li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  params.require(:post).permit(reseller_location_ids: {}) # Rails 5.2\n  permit(files: params[:post][:files].key # before Rails 5.2\n\n  &lt;%= select_tag 'reseller_location_ids[#{operator.id}]', options, multiple: true %&gt;\n  # do not know how to use f.select since can not have method with a name\n  `name[name]`\n</code></pre></div></div>\n<p>Note that if it is not required and nothing is selected than nothing will be\n  sent, you should use hidden field or default value <code class=\"highlighter-rouge\">{}</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= hidden_field_tag 'reseller_location_ids[0][]' %&gt;\n  # or\n  location_ids = (params[:reseller_location_ids] || {})[params[:reseller_operator_id]] || []\n</code></pre></div></div>\n\n<ul>\n  <li>And in model you need to clean empty strings <code class=\"highlighter-rouge\">[\"\"]</code> when nothing is selected\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  before_validation :clean_empty_skills\n  def clean_empty_skills\n self.skills = skills.select &amp;:present?\n  end\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>You should avoid saving without validation <code class=\"highlighter-rouge\">save(validate: false)</code> or\n<code class=\"highlighter-rouge\">update_attribute :name, 'my name'</code>. It is risky to save without validations.\nOther methods also do not check validation\nhttp://www.davidverhasselt.com/set-attributes-in-activerecord/\n<code class=\"highlighter-rouge\">update_column</code>, <code class=\"highlighter-rouge\">@users.update_all</code>.</p>\n\n<p>Conditional validations can be used with proc new like <code class=\"highlighter-rouge\">if: -&gt; { }</code> but with\nparameters. Also <code class=\"highlighter-rouge\">if: lambda {|a| }</code> (difference in required params to block)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>validates :password, confirmation: true, if: Proc.new { |a|\na.password.present?}\n</code></pre></div></div>\n\n<p>Validate occurs <code class=\"highlighter-rouge\">:on</code> <code class=\"highlighter-rouge\">:save</code> by default (but you can not use <code class=\"highlighter-rouge\">validate :d, on:\n:save</code>).  http://guides.rubyonrails.org/active_record_validations.html#on you\ncan split and specify to run on <code class=\"highlighter-rouge\">on: :create</code> or <code class=\"highlighter-rouge\">on: :update</code>. To run\nvalidation on destroy you need hook <code class=\"highlighter-rouge\">before_destroy</code> where you can <code class=\"highlighter-rouge\">errors.add</code>\nand <code class=\"highlighter-rouge\">return false</code> so hook reverts.</p>\n\n<h1 id=\"hooks\">Hooks</h1>\n\n<p><strong>NOTE THAT YOU SHOULD NOT USE HOOKS… Better is to just call a method where\nneeded, because you will not needed it always (for example in tests you want\ndifferent value) If you really need (default value that you really want) than\nplease use ||= conditional assignment</strong>\nDefault value for column could be in migration but than you need another\nmigration if you want to change value. If we put on <code class=\"highlighter-rouge\">after_initialize\n:default_values_on_initialize</code> than it is called also when you read object (that\nis required if you want to change default values for existing objects) If you\nhave <code class=\"highlighter-rouge\">validates :logo</code> than you can not put on <code class=\"highlighter-rouge\">before_save :default_logo</code> since\nvalidation will fail before that. We need <code class=\"highlighter-rouge\">before_validation</code> which occurs only\non update and create.</p>\n\n<p>Note that business logic could be that some fields could be cleared. For example\nsome logo is default value, but someone could completely remove logo.\nSo you need to separate <code class=\"highlighter-rouge\">default_values_on_create</code> and\n<code class=\"highlighter-rouge\">default_values_on_update</code> (which could get <code class=\"highlighter-rouge\">nil</code> on update some fields)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># do not use after initialize since it will be run on every load\n&gt; after_initialize :default_values_on_initialize\nbefore_validation :default_values_on_create, on: :create\nbefore_validation :default_values_on_update, on: :update\n\nprivate\n\ndef default_values_on_create\n  self.logo ||= Rails.application.secrets.default_restaurant_logo\n  # do not use self.some_true_value ||= true since that will override if\n  # some_true_value = false\n  self.some_true_value = true if some_true_value.nil?\n  # http://guides.rubyonrails.org/active_record_callbacks.html#halting-execution\n  # return value should be true or nil\n  true\nend\n</code></pre></div></div>\n\n<p>TO calculate some files you can use <code class=\"highlighter-rouge\">after_save :update_total</code>. Do not use\n<code class=\"highlighter-rouge\">after_update :update_total</code> since you can not update in that method.</p>\n\n<p>Custom validations <code class=\"highlighter-rouge\">validate :my_method</code> or <code class=\"highlighter-rouge\">validate { |customer|\ncustomer.check_permissions }</code> should add <code class=\"highlighter-rouge\">errors</code> to the object (return value is\nnot important and could be false).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Customer\n  def my_method\n    errors.add(:name) if name != 'Duke'\n  end\n  def check_permissions\n    errors.add(:name) if name != 'Duke'\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"default-order\">Default Order</h1>\n\n<p>Do not use <code class=\"highlighter-rouge\">default_scope</code>, since you need to use <code class=\"highlighter-rouge\">.reoder</code> instead of <code class=\"highlighter-rouge\">.order</code>.\nIf you really want to use, here is example:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>default_scope { order('created_at DESC') }\n</code></pre></div></div>\n\n<p>Usually default scope is not good practice (except for order). Even to trashable\nconcern is bad usage, for example if you use trashed on user and comments model</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g migration add_trashed_to_users trashed:boolean\nrails g migration add_trashed_to_comments trashed:boolean\n\n# user.rb &amp; comment.rb\n  default_scope { where(trashed: nil) }\n  scope :trashed, -&gt; { unscoped.where(trashed: true) }\n  scope :by_status_param, -&gt; (status_argument) { where status: status_argument }\n  scope :for_user, (lambda do |user|\n    where user: user\n  end)\n</code></pre></div></div>\n\n<p>than query <code class=\"highlighter-rouge\">User.first.comments.trashed</code> will return all trashed comments from\nALL users! <code class=\"highlighter-rouge\">unscoped</code> will remove even association scopes, thanks Joseph\nNdungu on\n<a href=\"http://www.victorareba.com/tutorials/creating-a-trashing-concern-in-rails-5\">comment</a>.</p>\n\n<p>Uncope can receive params what to unscope, example <code class=\"highlighter-rouge\">User.unscope(:where)</code>. If\nyou use this in <code class=\"highlighter-rouge\">belongs_to :location, -&gt; { unscope :where }</code> than it will also\nremove association belongs to condition, so you have to unscoped only columns\nfrom default_scope <code class=\"highlighter-rouge\">belongs_to :location, -&gt; { unscope where: :operator_id }</code>\n<a href=\"https://singlebrook.com/2015/12/18/how-to-carefully-remove-a-default-scope-in-rails/\">excellent link how to remove\nscope</a>\nI usually create additional classes with <code class=\"highlighter-rouge\">self.default_scopes = []</code> so it does\nnot use default scope. Also set table name so I can use sql.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class UnscopedCustomer &lt; Customer\n  self.default_scopes = []\n  self.table_name = \"customers\"\n  belongs_to :unscoped_company, foreign_key: :company_id\nend\n\nclass UnscopedCompany &lt; Company\n  self.default_scopes = []\n  self.table_name = \"companies\"\n  has_many :customers, foreign_key: :company_id\nend\n</code></pre></div></div>\n\n<h1 id=\"format-date\">Format date</h1>\n\n<p>Write datetime in specific my_time format\nhttps://apidock.com/ruby/DateTime/strftime</p>\n\n<p>You can see default date formats but they are used only when locales are used\n(for example byebug in a view)</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>(byebug) I18n.translate('date.formats.default')\n\"%m/%d/%Y\"\n(byebug) Date.today.to_s :default\n\"2018-11-05\"\n(byebug) l Date.today, format: :default\n\"11/05/2018\"\n</code></pre></div></div>\n\n<p>So I override default to_s (output). For parsing (input) best way is to use\nmonth name in select date <code class=\"highlighter-rouge\">2/Nov/2001</code> is it can parse collectly. For inputs\nwith two numbers it can not guess the month or date <code class=\"highlighter-rouge\">2/3/2000</code> so you need to\nuse <code class=\"highlighter-rouge\">Date.strptime '2/3/2000' , '%m/%d/%y'</code> to return 3 Februar.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/date_time_formats.rb\n# all 3 classes\n# puts user.updated_at.to_s :myapp_time\n# puts Time.now.to_s :myapp_time\n# puts Date.today.to_time :myapp_time # Date need to be type casted to Time\n# puts Time.now.to_date :myapp_date # Time object to Date if we want myapp_date\n\nTime::DATE_FORMATS[:default] = \"%d-%b-%Y %I:%M %p\" # this is same as for\n# datepicker format = 'DD-MMM-YYYY h:mm A'\nTime::DATE_FORMATS[:at_time] = lambda { |time| time.strftime(\"%b %e, %Y @ %l:%M %p\") }\n\nDate::DATE_FORMATS[:myapp_date] = lambda { |date| date.strftime(\"%b %e, %Y\") }\nDate::DATE_FORMATS[:myapp_date_ordinalize] = lambda { |date| date.strftime(\"#{date.day.ordinalize} %b %Y\") }\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">Time.now</code> and <code class=\"highlighter-rouge\">Date.today</code> are using system time. If you are using\n<code class=\"highlighter-rouge\">browser-timezone-rails</code> than timezone will be set for each request. But if you\nneed something from rails console, you need to set timezone manually.\n<code class=\"highlighter-rouge\">Time.zone = 'Belgrade'</code> (list all in <code class=\"highlighter-rouge\">rake time:zones:all</code>). It is good to\nalways use <code class=\"highlighter-rouge\">Time.zone.now</code> and <code class=\"highlighter-rouge\">Time.zone.today</code>. Rails helpres use zone\n(<code class=\"highlighter-rouge\">1.day.from_now</code>)</p>\n\n<ul>\n  <li>prefer using <code class=\"highlighter-rouge\">Time.current</code> over <code class=\"highlighter-rouge\">Time.now</code>, and <code class=\"highlighter-rouge\">Date.current</code> over\n<code class=\"highlighter-rouge\">Date.today</code></li>\n  <li>to get weekday from <code class=\"highlighter-rouge\">ActiveSupport::TimeWithZone</code> use\n<a href=\"http://api.rubyonrails.org/classes/ActiveSupport/TimeWithZone.html\">link</a>\n<code class=\"highlighter-rouge\">weekday = t.to_a[6]</code></li>\n  <li>to get a weekday from a date use</li>\n</ul>\n<p><a href=\"https://ruby-doc.org/stdlib-2.4.2/libdoc/date/rdoc/Date.html#method-i-cwday\">https://ruby-doc.org/stdlib-2.4.2/libdoc/date/rdoc/Date.html#method-i-cwday</a></p>\n<ul>\n  <li><code class=\"highlighter-rouge\">d.wday</code> (0-6, Sunday is zero)</li>\n  <li><code class=\"highlighter-rouge\">d.cwday</code> (1-7. Sunday is 7, Moday is 1)</li>\n  <li>to get first calendar date <code class=\"highlighter-rouge\">Time.zone.today.beginning_of_month</code> or\n<code class=\"highlighter-rouge\">Time.zone.today.end_of_month</code>\n    <ul>\n      <li>get interval for previous month: <code class=\"highlighter-rouge\">'Last Month':\n[Time.zone.today.prev_month.at_beginning_of_month,\nTime.zone.today.prev_month.at_end_of_month],</code></li>\n    </ul>\n  </li>\n  <li>to get month date use <code class=\"highlighter-rouge\">d.day</code></li>\n</ul>\n\n<p>Change system timezone (which is used by browsers) with <code class=\"highlighter-rouge\">sudo dpkg-reconfigure\ntzdata</code>. Note that <code class=\"highlighter-rouge\">rails c</code> uses UTC <code class=\"highlighter-rouge\">Time.zone # =&gt; \"UTC\"</code>, but byebug in\nrails s returns default time zone <code class=\"highlighter-rouge\">Time.zone # CEST Europe</code>. You can use users\ntimezone with\n<a href=\"https://github.com/kbaum/browser-timezone-rails\">browser-timezone-rails</a>.\n<code class=\"highlighter-rouge\">Time.zone.now.utc_offset</code> will return offset to UTC in seconds. I do not know\nwhy <code class=\"highlighter-rouge\">Time.zone.utc_offset</code> returns different results (3600 instead of 7200).</p>\n\n<h1 id=\"multiline-render-js-response\">Multiline render js response</h1>\n\n<p>Write long string in multiple lines with <code class=\"highlighter-rouge\">%()</code>, for example:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>format.js do\n  render js: %(\n    $('##{key}').replaceWith('#{view_context.j view_context.render partial: 'product_table', locals: { products: Product.send( key).all, product_type_string: key.to_s}} ');\n    jQuery(\".best_in_place\").best_in_place();\n    )\nend\n\nformat.js { render js: \"windnw.location.assign('#{user_path}');\" }\n</code></pre></div></div>\n\n<p>If you receive a lot of errors <code class=\"highlighter-rouge\">An ActionView::MissingTemplate occurred in</code> and\n<code class=\"highlighter-rouge\">Missing template customer/sessions/new, customer_application/new,\napplication/new with {:locale=&gt;[:in, :en], :formats=&gt;[\"Application/*\"],\n:variants=&gt;[], :handlers=&gt;[:erb, :builder, :raw, :ruby, :coffee, :jbuilder]}.\nSearched in:</code> on some landing or login pages than simply add:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/home_controller.rb\nclass HomeController &lt; ApplicationController\n  respond_to :html\n\n  def index\n    respond_with do |format|\n      format.html { render :index }\n      format.any { render :index }\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>Another solution to respond to all formats is to add <code class=\"highlighter-rouge\">formats</code> argument</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/home_controller.rb\nclass HomeController &lt; ApplicationController\n  def index\n    render :index, formats: [:html]\n  end\nend\n</code></pre></div></div>\n\n<p>So this will render index for any type of requests</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>curl http://loc:3001\ncurl http://loc:3001 -H \"Accept: application/json\"\n</code></pre></div></div>\n\n<h1 id=\"autosize\">Autosize</h1>\n\n<p>Textarea should be <a href=\"http://www.jacklmoore.com/autosize/\">autosized</a> (download\n<code class=\"highlighter-rouge\">autosize.js</code> from <code class=\"highlighter-rouge\">dist/</code> folder). Put below your textarea for ajax responses\nand put in your main.js file on jQuery load.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/forms/_form.html.erb %&gt;\n&lt;%= f.text_area :title %&gt;\n&lt;%= javascript_tag \"autosize($('textarea'))\" if request.xhr? %&gt;\n\n// app/assets/javascripts/main.js.erb\n$(function() {\n  autosize($('textarea'));\n});\n</code></pre></div></div>\n\n<h1 id=\"upload-file\">Upload file</h1>\n\n<p>Since default file button does not look nice we just hide it (android has some\nprobles when it is hidden, so we just move it), and use label to trigger it and\n<code class=\"highlighter-rouge\">on change</code> we submit the form. Note that we use <code class=\"highlighter-rouge\">id</code> because we could have more\nthan one form on a page.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# _suppression_list.html.erb %&gt;\n  &lt;div class=\"pull-right\"&gt;\n    &lt;%= form_tag import_suppression_path(suppression_list), multipart:true, class: 'pull-right' do %&gt;\n      &lt;span data-chosen-filename&gt;&lt;/span&gt; &amp;nbsp;\n      &lt;%= label_tag :file, 'Upload CSV', for: \"upload-file-#{suppression_list.id}\", style: 'display:inline' %&gt;\n      &lt;%= file_field_tag :file, id: \"upload-file-#{suppression_list.id}\", 'data-upload-file': true, style: 'position:absolute; top: -1000px' %&gt;\n    &lt;% end %&gt;\n  &lt;/div&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># javascripts/leads.coffee\n$(document).on 'change', '[data-upload-file]', (e) -&gt;\n  console.log(\"upload csv\")\n  e.preventDefault()\n  file = this.files[0]\n  allowedExtensions = /^(text\\/csv)$/\n  $(this).closest('form').find(\"[data-chosen-filename]\").text this.value\n  if (this.files.length == 0 )\n    alert(\"Please chose one csv file\")\n    return\n  if(! allowedExtensions.test(file.type))\n    alert(\"File type is not allowed\")\n    return\n  $(this).closest('form').submit()\n</code></pre></div></div>\n\n<h1 id=\"database\">Database</h1>\n\n<p>Show all databases in postgresql, first change user to postgres</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo su -l postgres\npsql\n\n# or in one command\nsudo -u postgres psql\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\\list\n\\connect database_name\n\\dt\n\nCREATE USER orlovic WITH CREATEDB PASSWORD '&lt;password&gt;';\n</code></pre></div></div>\n\n<p>In rails you can access database using ‘rails db’ and see table definition</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails db\n\\d users\n</code></pre></div></div>\n\n<h2 id=\"active-record\">Active record</h2>\n\n<ul>\n  <li>one issue is when you use different table name <code class=\"highlighter-rouge\">self.table_name =\n'something_other'</code> than relations could not be picked correctly</li>\n  <li>\n    <p>union is not supported <a href=\"https://github.com/rails/rails/issues/939\">issue 929</a>\nbut you can try with raw sql and <code class=\"highlighter-rouge\">from</code> statement. Union should have same\nnumber and type of columns. Also use <code class=\"highlighter-rouge\">.from([Arel.sql('...')])</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  sql = &lt;&lt;~SQL\n  ( ( SELECT id, location_id, package_saleid, customer_id, customer_name, location_package_id, sale_date, -total_amount_cents as total_amount_cents, total_amount_currency, customer_invoice_id, (bytes_uploaded_total + bytes_downloaded_total) as total_data_used\n      FROM location_package_sales\n    ) UNION (\n      SELECT id, location_id, balance_refillid as package_saleid, NULL as customer_id, 'refill' as customer_name, NULL as location_package_id, created_at as sale_date, refill_amount_cents as total_amount_cents, refill_amount_currency as total_amount_currency, NULL as customer_invoice_id, NULL as total_data_used\n      FROM location_balance_refills\n    )\n  ) AS location_package_sales_or_location_balance_refills\n  SQL\n  @all_location_package_sales_or_location_balance_refills = LocationPackageSaleOrLocationBalanceRefill\n    .includes(:location, :customer, :customer_invoice, :location_package)\n    .from([Arel.sql(sql)])\n    .where(location_id: current_location)\n</code></pre></div>    </div>\n  </li>\n  <li>execute sql from rails console. When you run sql result is iteratable (array\n of arrays of selected fields).</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>s = 'SELECT * FROM users'\nr = ActiveRecord::Base.connection.execute s\nr.each { |l| puts l }\n</code></pre></div></div>\n\n<ul>\n  <li>for single item, always use <code class=\"highlighter-rouge\">@post.destroy</code> instead of <code class=\"highlighter-rouge\">@post.delete</code> because\nit propagates to all <code class=\"highlighter-rouge\">has_many :comments, dependent: :destroy</code> (also need to\ndefine this dependent param). If you use delete or use destroy without\n<code class=\"highlighter-rouge\">has_many dependent: destroy</code> than <code class=\"highlighter-rouge\">ActiveRecord::InvalidForeignKey:\nSQLite3::ConstraintException: FOREIGN KEY constraint failed</code> for sqlite db…\nFor mysql and postgres, error will be triggered if there are foreign keys\ndefined.</li>\n  <li>for multiple items <code class=\"highlighter-rouge\">Post.destroy_all</code> will run one by one (triggering\ncallbacks) so it is probably slow, so it is better to use <code class=\"highlighter-rouge\">Post.delete_all</code>\nwhich will remove in single sql query. To prevent foreign keys errors, you\nshould first <code class=\"highlighter-rouge\">Comment.where(post: Post.all).delete_all</code> and than call\n<code class=\"highlighter-rouge\">Post.delete_all</code>. Watch out if you call delete_all on collection proxy\n<code class=\"highlighter-rouge\">post.comments.delete_all</code></li>\n</ul>\n<p><a href=\"https://stackoverflow.com/questions/23879841/activerecord-delete-all-method-updating-instead-of-deleting\">https://stackoverflow.com/questions/23879841/activerecord-delete-all-method-updating-instead-of-deleting</a>\nDefault strategy is <code class=\"highlighter-rouge\">:nullify</code> ie keep row, but set <code class=\"highlighter-rouge\">post_id = nil</code>. So always\nuse <code class=\"highlighter-rouge\">has_many :association, dependent: :destroy</code> so it will not use <code class=\"highlighter-rouge\">nullify</code>\nbut <code class=\"highlighter-rouge\">delete_all</code> strategy\n<a href=\"http://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete_all\">link</a></p>\n\n<h2 id=\"add-json-and-hstore\">Add json and hstore</h2>\n\n<p>Note that you can use simple text column (without default value) and add\n<code class=\"highlighter-rouge\">serialize :preferences, Hash</code> in your model, so <code class=\"highlighter-rouge\">user.prefereces # =&gt; {}</code> is\ndefined for initial empty value.\nYou can not search serialized columns (you are limited to reading and writing\ndata) <code class=\"highlighter-rouge\">User.where(params: { a: 1 })</code> gives error. You can only use raw sql, for\nexample <code class=\"highlighter-rouge\">User.where('params = ?', { a: 1}.to_yaml)</code>.</p>\n\n<p>Adding array of any type and hstore is easy, just add default value <code class=\"highlighter-rouge\">[]</code> and\n<code class=\"highlighter-rouge\">''</code> (breaks for <code class=\"highlighter-rouge\">{}</code>). You can create hstore extension in migration. If you\nneed arrays of hstore than you need to go for json or jsonb (better optimization\nonly pq 9.4) or json/jsonb array.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class CreatePhones &lt; ActiveRecord::Migration\n  def change\n    execute \"create extension hstore\"\n    create_table :phones do |t|\n      t.string :my_array, array: true, default: []\n      t.hstore :my_hash, default: ''\n      t.jsonb :my_json, default: []\n      t.jsonb :my_array_of_json, array: true, default: []\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>DB user need to be superuser to be able to create extension. If you need to\nrun <code class=\"highlighter-rouge\">rake db:migrate:reset</code> to rerun all migration to check if db/schema is in\nsync, than the best way is to alter user to have superuser privil <code class=\"highlighter-rouge\">sudo su\npostgres -c \"psql -d postgres -c 'ALTER USER orlovic WITH SUPERUSER;'\"</code> where\norlovic is database username (you can see those usernames - roles using\npqadmin visual program)\n<a href=\"https://github.com/diogob/activerecord-postgres-hstore/issues/99\">link</a>.</p>\n\n<p>You can enable hstore manually\n<a href=\"https://gist.github.com/terryjray/3296171\">link</a> <code class=\"highlighter-rouge\">sudo psql -d\nScuddle_app_development -U orlovic</code> and <code class=\"highlighter-rouge\">CREATE EXTENSION hstore;</code> or in one\ncommand: <code class=\"highlighter-rouge\">sudo su postgres -c \"psql Scuddle_app_test -c 'CREATE EXTENSION\nhstore;'\"</code>. You should do this also for <em>test</em> and <em>development</em> database. If\nyou don’t know database name you can use <a href=\"http://guides.rubyonrails.org/command_line.html#rails-runner\">rails\nrunner</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo su postgres -c \"psql `rails runner 'puts ActiveRecord::Base.configurations[\"production\"][\"database\"]'` -c 'CREATE EXTENSION hstore;'\"\n</code></pre></div></div>\n\n<h2 id=\"dump-database\">Dump database</h2>\n\n<p>Dump database from production for local inspection, you can download from\nheroku manually or using commands:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku pg:backups:capture # it will create b002.dump\nheroku pg:backups:download # it will download to latest.dump\n</code></pre></div></div>\n\n<p>Save it for example <code class=\"highlighter-rouge\">tmp/b001.dump</code>.</p>\n\n<p>You can dump LOCAL database with <code class=\"highlighter-rouge\">pg_dump</code>. Note that this is plain sql, but\nheroku dump is binary format (size is much smaller).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pg_dump $DATABASE_NAME &gt; $DUMP_FILE\n#\n# or heroku style, replace: mypassword myuser and mydb\n# PGPASSWORD=mypassword pg_dump -Fc --no-acl --no-owner -h localhost -U myuser $DATABASE_NAME &gt; $DUMP_FILE\n</code></pre></div></div>\n\n<h2 id=\"restore-database\">Restore database</h2>\n\n<p>Restore from local textual and binary dump</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>export DUMP_FILE=tmp/b001.dump\nexport DATABASE_NAME=$(rails runner 'puts ActiveRecord::Base.configurations[\"development\"][\"database\"]')\nchmod a+r $DUMP_FILE\n\nrake db:drop db:create\n\n# textual dump\npsql $DATABASE_NAME &lt; $DUMP_FILE\n\n# binary dump\nsudo su postgres -c \"pg_restore -d $DATABASE_NAME --clean --no-acl --no-owner -h localhost $DUMP_FILE\"\n</code></pre></div></div>\n\n<p>Or you can use <a href=\"https://github.com/duleorlovic/config/blob/master/bashrc/rails.sh#L39\">duleorlovic’s load_dump\nhelper</a></p>\n\n<p>To restore on heroku you need to dump with same flags (dump is binary) and push\nthe file somewhere on internet, for example AWS S3 and than run in console</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku pg:backups restore --confirm playcityapi https://s3.amazonaws.com/duleorlovic-test-us-east-1/b001.dump DATABASE_URL\n</code></pre></div></div>\n\n<h2 id=\"heroku-upgrade-database-plan\">Heroku upgrade database plan</h2>\n\n<p>Upgrade heroku <em>hobby-dev</em> na <em>hobby-basic</em> ($9/month max 10M rows).\nAll plans https://elements.heroku.com/addons/heroku-postgresql</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku addons:create heroku-postgresql:hobby-basic\n# Creating heroku-postgresql:hobby-basic on ⬢ myapp... $9/month\n# Database has been created and is available\n#  ! This database is empty. If upgrading, you can transfer\n#  ! data from another database with pg:copy\n# Created postgresql-defined-42601 as HEROKU_POSTGRESQL_CHARCOAL_URL\n# Use heroku addons:docs heroku-postgresql to view documentation\n\nheroku pg:copy DATABASE_URL HEROKU_POSTGRESQL_CHARCOAL_URL\n# ▸    WARNING: Destructive action\n#  ▸    This command will remove all data from CHARCOAL\n#  ▸    Data from DATABASE will then be transferred to CHARCOAL\n#  ▸    To proceed, type myapp or re-run this command with --confirm myapp\n# \n# &gt; myapp\n# Starting copy of DATABASE to CHARCOAL... done\n# Copying... done\n</code></pre></div></div>\n\n<p>Change DATABASE_URL</p>\n\n<p>Upgrading from hobby-basic to standard-0</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku pg:info\nheroku addons:create heroku-postgresql:standard-0\n# save the variable name HEROKU_POSTGRESQL_{some color}_URL\nheroku maintenance:on\nheroku pg:copy DATABASE_URL HEROKU_POSTGRESQL_color_URL\nheroku pg:promote HEROKU_POSTGRESQL_color_URL\nheroku maintenance:off\nheroku config:set DATABASE_URL=....url from config\nheroku addons:destroy HEROKU_POSTGRESQL_color_old_URL\n</code></pre></div></div>\n\n<h2 id=\"postgres-tips\">Postgres tips</h2>\n\n<ul>\n  <li>you should explicitly add timestamps with <code class=\"highlighter-rouge\">t.timestamps</code></li>\n  <li>\n    <p>upgrade postgres from 9.3 to 9.4\n<a href=\"https://gist.github.com/dideler/60c9ce184198666e5ab4\">link</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -\nsudo sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt/ precise-pgdg main\" &gt;&gt; /etc/apt/sources.list.d/postgresql.list'\n\n# Also probably optional but I like to update sources and upgrade\nsudo apt-get update\nsudo apt-get upgrade\nsudo apt-get install postgresql-9.4\nsudo pg_dropcluster 9.4 main --stop\nsudo pg_upgradecluster 9.3 main\nsudo pg_dropcluster 9.3 main\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>To disable sql logs in rails logger put this in initializer file</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/silent_sql_log.rb\nActiveRecord::Base.logger.level = Logger::INFO\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>to disable assets logs use this</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/environments/development.rb\nconfig.assets.quiet = true\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>to allow any user to log in to database, ie any user in config/database.yml\neven without password, you need to change postgres config:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo vi /etc/postgresql/9.1/main/pg_hba.conf\n# change all this words [md5, ident, peer] to trust\nsudo /etc/init.d/postgresql restart\n</code></pre></div>    </div>\n\n    <p>create one user:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo su - postgres\npsql postgres\nCREATE ROLE \"orlovic\" WITH CREATEDB LOGIN;\n\\q\n\n# you can remove with DROP ROLE orlovic;\n# or you can change anything on role\n# https://www.postgresql.org/docs/9.3/static/sql-alterrole.html\n# if you need uppercased (it was created `orlovic` instead of `Orlovic`)\nALTER ROLE orlovic RENAME TO \"Orlovic\";\n# or\npgadmin3 # login as postgres without password and chage it to Orlovic\n\n# create database is with linux command\ncreatedb # this will create db with same name as current user\ncreatedb orlovic\n</code></pre></div>    </div>\n  </li>\n  <li>you can use production database locally with url from heroku config env\nvariable <code class=\"highlighter-rouge\">HEROKU_POSTGRESQL_CRIMSON_URL:\npostgres://flvmstxfdk:3fo9O62B-Q4BZ7EP8N4YU@ec2-107-20-191-205.compute-1.amazonaws.com:5432/d5ttgvqpjs1ftb</code>\nand put it inside <code class=\"highlighter-rouge\">config/database.yml</code> under <code class=\"highlighter-rouge\">development</code> under <code class=\"highlighter-rouge\">url:\npostgres://asd.asd@asd.com:123/asd</code> item</li>\n  <li>\n    <p>you can use <a href=\"http://guides.rubyonrails.org/association_basics.html#options-for-belongs-to-counter-cache\">rails counter\ncache</a>\nwith <code class=\"highlighter-rouge\">belongs_to :author, counter_cache: true</code> but than you need to have\n<code class=\"highlighter-rouge\">authors.books_count</code> column. It is easier to have <a href=\"https://medium.com/@eric.programmer/the-sql-alternative-to-counter-caches-59e2098b7d7#.cmuuhtayh\">sql for counter\ncache</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/author.rb\nclass Author &lt; ApplicationRecord\n  scope :with_counts, -&gt; {\n    select &lt;&lt;~SQL\n      authors.*,\n      (\n        SELECT COUNT(books.id) FROM books\n        WHERE author_id = authors.id\n      ) AS books_count\n    SQL\n  }\nend\n\n# app/controllers/authors_controller.rb\n\n@authors = Author.with_counts.all\n@author = Author.with_counts.find params[:id]\n\n# app/views/authors/index.html.erb\n\n&lt;% @authors.each do |author| %&gt;\n  &lt;% autor.books_count %&gt;\n&lt;% end %&gt;\n&lt;%= @author.books_count %&gt;\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h2 id=\"migrations\">Migrations:</h2>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">rails g model user email_address</code> will generate migration and model. It is\ngood to edit <code class=\"highlighter-rouge\">last_migration</code> and add <code class=\"highlighter-rouge\">null: false</code> to not null fields\n(particularly for foreign keys) also usefull since in sql <code class=\"highlighter-rouge\">where col != NULL</code>\nwill not return any value (also <code class=\"highlighter-rouge\">where NULL = NULL</code>), you need to use <code class=\"highlighter-rouge\">where col\nIS NOT NULL</code> (which is default for active record <code class=\"highlighter-rouge\">.where.not(col: nil)</code>). So\nbetter is to use <code class=\"highlighter-rouge\">false</code> since <code class=\"highlighter-rouge\">where col != false</code> will return some results.\nAdd index <code class=\"highlighter-rouge\">add_index :users, :email_address, unique: true</code>…\nif you want to add index in different step (not in <code class=\"highlighter-rouge\">t.references :c, index:\nfalse</code> because name is too long (error like <code class=\"highlighter-rouge\">Index name 'index_table_column' on\ntable 'table' is too long; the limit is 64 characters</code>) than you can use\ndifferent name NOTE that you need to use exact column name (with <code class=\"highlighter-rouge\">_id</code>)\n<code class=\"highlighter-rouge\">add_index :users, :company_id, name: 'index company on users'</code>\nhttps://github.com/gregnavis/active_record_doctor to help you find columns\nwithout index</li>\n  <li>In migration Product.save will probably break in the future, because <em>Product</em>\nwill be validated for something that we did not know on that time.\nWe can call <code class=\"highlighter-rouge\">Product.update_all fuzz: 'fuzzy'</code> or <code class=\"highlighter-rouge\">Product.update_all 'new_col =\nold_col'</code> to update all records in single sql query, without triggering\ncallbacks or validations.\nYou can also replace substring for example: <code class=\"highlighter-rouge\">User.update_all('email =\nREPLACE(email, \"a\", \"x\")')</code>\nBetter is to create local class and call reset column information. Also if we\nare adding not null column we need to do it in two steps to populate existing\nrecords.</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># db/migrate/20161010121212_update_fuzz.rb\nclass UpdateFuzz &lt; ActiveRecord::Migration\n  # this is local Product class used only inside this migration\n  class Product &lt; ActiveRecord::Base\n  end\n  def change\n    add_column :products, :fuzz, :string\n    # this is needed since renamed columns will be ignored on \"save\"\n    # Product.reset_column_information\n    # check with Product.columns or Product.column_names\n    Product.update_all fuzz: 'fuzzy'\n    Product.find_each { |product| product.save! }\n    change_column :products, :fuzz, :string, null: false\n  end\nend\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>to change type from string to integer (using cast)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class ChangeScoreTypeInFilledAnswers &lt; ActiveRecord::Migration \n  def up\n    change_column :filled_answers, :score, 'integer USING CAST(score AS integer)'\n  end\n  def down\n    change_column :filled_answers, :score, :string\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>use <em>db/seed.rb</em> to add some working data (users, products) that should not go\nto production. add data to migration file if something needs to be in db\n(select box, customer plans)</li>\n  <li>when you restore database you can see that list of performed migrations <code class=\"highlighter-rouge\">rake\ndb:migrate:status</code> does not show that any migration was perfomed. You can\nmanually perform run specific single or all migrations\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># status\nrake db:migrate:status\n# all including until this version\nrake db:migrate VERSION=20161114162031`\n# only this migration file\nrake db:migrate:up VERSION=20161114162031`\n# reverse if it is reversible\nrake db:migrate:down VERSION=20161114162031`\n# to remove migration so you can redo\nmysql&gt; DELETE FROM schema_migrations WHERE version = 20161114162031\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>if you want to redo migration (revert and migrate again) you can use <code class=\"highlighter-rouge\">redo</code> \nTo drop database in console you can <code class=\"highlighter-rouge\">ActiveRecord::Migration.drop_table(:users)</code></p>\n<ul>\n  <li>you can use <code class=\"highlighter-rouge\">rake db:migrate:redo STEP=2</code> to redo last two migrations, or you\ncan run all migrations to certain point with <code class=\"highlighter-rouge\">rake db:migrate\nVERSION=20161114162031</code> (note that <code class=\"highlighter-rouge\">:up</code> <code class=\"highlighter-rouge\">:down</code> only run one migration)</li>\n  <li><code class=\"highlighter-rouge\">rake db:migrate</code> will also invoke <code class=\"highlighter-rouge\">db:schema:dump</code> task\n<a href=\"http://edgeguides.rubyonrails.org/active_record_migrations.html#running-migrations\">link</a></li>\n  <li>to check current metaga data, for example schema enviroment you can run\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails runner \"ActiveRecord::Base.connection.execute('select * from ar_internal_metadata').each {|r|puts r}\"\n\n# or for test database\nrails runner \"ActiveRecord::Base.connection.execute('select * from ar_internal_metadata').each {|r|puts r}\" -e test\n\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h2 id=\"has_many-through\">Has_many through</h2>\n\n<p><code class=\"highlighter-rouge\">has_many :roles; has_many :projects, through: roles</code> can be used for many to\nmany associations. You can automatically add new role, no need to <code class=\"highlighter-rouge\">user.save</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>user.roles.create project: project\n# or\nuser.projects &lt;&lt; project\n</code></pre></div></div>\n\n<p><a href=\"http://guides.rubyonrails.org/association_basics.html#the-has-and-belongs-to-many-association\">has_and_belongs_to_many</a>\n(habtm) can be generated with <code class=\"highlighter-rouge\">rails g migration create_campaigns_templates\ncampaign:references template:references</code> and add <code class=\"highlighter-rouge\">id: false</code> as\n<a href=\"http://guides.rubyonrails.org/association_basics.html#updating-the-schema\">suggested</a>\nNote that both model names are plural.\nBut rubocop suggest to use separate model for habtm relation (in that case I use\nsingular first model).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class CreateCampaignsTemplates &lt; ActiveRecord::Migration\n  def change\n    create_table :campaigns_templates, id: false do |t|\n      t.references :campaign, foreign_key: true, null: false\n      t.references :template, foreign_key: true, null: false\n\n      t.timestamps\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>and adding <code class=\"highlighter-rouge\">has_and_belongs_to_many :templates</code> in those classes.</p>\n\n<p>You can force uniq with <code class=\"highlighter-rouge\">add_index :campaign_templates, [:campaign_id,\n:template_id], unique: true</code> and check in rails with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># add if not exists\ncampaign.templates &lt;&lt; template unless campaign.templates.include? template\n\n# remove\ncampaign.templates.delete template\n</code></pre></div></div>\n\n<p>If you have different name of the table: <code class=\"highlighter-rouge\">t.references :donor, foreign_key:\ntrue, null: false</code> but donor is actually in users table, than you need to change\nforeign key (note that <code class=\"highlighter-rouge\">add_foreign_key</code> params are in plurals!)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># to_table is in rails5\nt.references :donor, foreign_key: { to_table: :users }, null: false\n# in rails4 use references keyword also as parameter, not that foreight key\n# constrains need to be added in separate command. note suffix \"_id\"\nt.references :donor, foreign_key: false, null: false, references: :users\nadd_foreign_key :table, :users, column: :donor_id\n</code></pre></div></div>\n\n<p>or manually write relation</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>create_table :donations\n  t.belongs_to :donor, index: true, null: false\nend\nadd_foregn_key :donations, :users, column: :donor_id\n</code></pre></div></div>\n\n<p>Also in model you need to write: <code class=\"highlighter-rouge\">has_many :donations, foreign_key: :donor_id</code>\nand <code class=\"highlighter-rouge\">belongs_to :donor, class_name: \"User\"</code>. If you need to specify class name\nin has_many through association, use option <code class=\"highlighter-rouge\">source: :user</code></p>\n\n<p>Note that <code class=\"highlighter-rouge\">t.references</code> should be used with <code class=\"highlighter-rouge\">foreign_key: true, null: false</code>\nsince foreign_key is not automatically used (<code class=\"highlighter-rouge\">t.references</code> automatically add\n<code class=\"highlighter-rouge\">index</code>).\nNote that <code class=\"highlighter-rouge\">t.belongs_to</code> by default use <code class=\"highlighter-rouge\">index: false</code>, so you need to use\n<code class=\"highlighter-rouge\">index: true</code> (or <code class=\"highlighter-rouge\">add_index</code> later) (<code class=\"highlighter-rouge\">add_column :users, :token, :string,\nindex: true</code> will not create index, you need to use <code class=\"highlighter-rouge\">add_index</code> separatelly).\nBut usually you use <code class=\"highlighter-rouge\">add_foreign_key</code> that\nwill also add index (name will be like: <code class=\"highlighter-rouge\">fk_rails_123123</code>) if it is not added by\nbelongs_to, so you can safelly use <code class=\"highlighter-rouge\">t.belongs_to ... index: false</code> if you are\nusing <code class=\"highlighter-rouge\">add_foregn_key</code>.</p>\n\n<p>For MySql I have to use <code class=\"highlighter-rouge\">unsigned: true</code> in <code class=\"highlighter-rouge\">t.belongs_to :user, null: false,\nunsigned: true</code> or for <code class=\"highlighter-rouge\">t.references :user, unsigned: true</code>\nYou can add column at specific location <code class=\"highlighter-rouge\">add_column :feeds, :last_modified,\n:datetime, after: :url</code> (after column does not work in psql since you need to\nchange table) https://stackoverflow.com/questions/27214251/postgresql-add-column-after-option-usage-in-rails-migration</p>\n\n<p>If you need to update specific fields of association, add validation or cdd\nustom order then you should create the model and use <code class=\"highlighter-rouge\">has_many :templates,\nthrough: campaign_templates, order: 'campaign_templates.created_at ASC'</code>\nNote that here we user singular first part so model name looks better</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class CampaignTemplate &lt; ActiveRecord::Base\n  belongs_to :campaign\n  belongs_to :template\nend\n</code></pre></div></div>\n\n<p>If you accidentaly use <code class=\"highlighter-rouge\">belongs_to :templates</code> (pluralized) than error is\n<code class=\"highlighter-rouge\">undefined method relation_delegate_class' for Templates:Module</code></p>\n\n<h2 id=\"database-indexes\">Database indexes</h2>\n\n<p>Indexes should be on all columns that are references in <code class=\"highlighter-rouge\">WHERE, HAVING, ORDER\nBY</code> parts of sql.\nFor example if you find using specific column <code class=\"highlighter-rouge\">User.find_by! column: 'val'</code>. Use\nbang version instead of <code class=\"highlighter-rouge\">@user = User.find_by name: 'Duke'</code> since that will\nreturn <code class=\"highlighter-rouge\">nil</code> instead of <code class=\"highlighter-rouge\">raise ActiveRecord::RecordNotFound unless @user</code>\nAlso we can add index to <code class=\"highlighter-rouge\">:updated_at</code> column since we sometimes order by\nthat column.</p>\n\n<p>All foreign keys need to have index.\nYou can use <code class=\"highlighter-rouge\">add_reference</code> (adding column and index) note that second param is\nin singular.\nIf you want to add or remove reference in migration <code class=\"highlighter-rouge\">rails g migration\nadd_user_to_leads user:references</code> which will generate</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class AddUserToLeads &lt; ActiveRecord::Migration\n  def change\n    # reference will automatically include index on that column\n    add_reference :leads, :contact, foreign_key: true\n  end\nend\n</code></pre></div></div>\n\n<p>For polymorphic associations <code class=\"highlighter-rouge\">owner_id</code> and <code class=\"highlighter-rouge\">owner_type</code> you can create in\nmigration <code class=\"highlighter-rouge\">rails g model project owner:references{polymorphic}</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Organization &lt; ActiveRecord::Base\n  has_many :projects, :as =&gt; :owner\nend\n\nclass User &lt; ActiveRecord::Base\n  has_many :projects, :as =&gt; :owner\nend\n\nclass Project &lt; ActiveRecord::Base\n  belongs_to :owner, :polymorphic =&gt; true\nend\n</code></pre></div></div>\n\n<p>You can eager load polymorphic association https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#module-ActiveRecord::Associations::ClassMethods-label-Eager+loading+of+associations\nbut can not use it in where https://stackoverflow.com/questions/16123492/eager-load-polymorphic\nFor using in where you need to define specific associations (note: you need to\nadd <code class=\"highlighter-rouge\">optional: true</code>)</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Notification &lt; ApplicationRecord\n  belongs_to :notifiable, polymorphic: true\n  # notifiable: Comment, Task, Project need to implement subscribed_users since\n  # we send body text to them\n\n  belongs_to :comment, -&gt; { where notifications: { notifiable_type: 'Comment' } }, foreign_key: :notifiable_id, optional: true\n  belongs_to :task, -&gt; { where notifications: { notifiable_type: 'Task' } }, foreign_key: :notifiable_id, optional: true\n\n  scope :for_comments_on_tasks, (lambda do\n    joins(:comment)\n      .where(comments: { commentable_type: 'Task' })\n  end)\n</code></pre></div></div>\n\n<p>When you create you can use <code class=\"highlighter-rouge\">references</code> and <code class=\"highlighter-rouge\">polymorphic: true</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  t.references :featureable, polymorphic: true, null: false\n</code></pre></div></div>\n\n<p>If you add one by one column than you need to add double index:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>t.string :owner_type\nt.integer :owner_id\n\n# Bad: This will not improve the lookup speed\nadd_index :projects, :owner_id\nadd_index :projects, :owner_type\n\n# Good: This will create the proper index\nadd_index :projects, [:owner_type, :owner_id]\n</code></pre></div></div>\n\n<p>You can add unique index on some existing columns (to see\nvalidation error instead of database esception, should also be in rails\n<code class=\"highlighter-rouge\">validates :email, uniqueness: { scope: :user_id }</code>)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class AddUniqContacts &lt; ActiveRecord::Migration\n  def change\n    add_index :contacts, [:email, :user_id], unique: true\n  end\nend\n</code></pre></div></div>\n\n<p>Do not add index for tables that has a lot or removing, since perfomance will be\nbad. Also huge tables need huge indexes, so pay attention on size.</p>\n\n<p>Remove index and foreign key if you want to remove column</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  remove_foreign_key :online_payment_responses, :location_packages\n  remove_column :online_payment_responses, :location_package_id\n  if index_exists?(:online_payment_responses, name: 'fk_rails_b36eeaa704')\n    remove_index :online_payment_responses, name: 'fk_rails_b36eeaa704'\n  end\n</code></pre></div></div>\n\n<p>In mysql sometimes <code class=\"highlighter-rouge\">LIMIT 10</code> is slower than <code class=\"highlighter-rouge\">LIMIT 100</code> since it won’t use\nindex for small stuff, but if table is huge than it’s much slower without index.\nTo force index use something like <code class=\"highlighter-rouge\">User.from(\"'users' FORCE INDEX\n(my_user_index\")</code>\n<a href=\"http://fuzzyblog.io/blog/rails/2017/02/24/understanding-low-level-index-issues-in-mysql.html\">link</a>\nIf you receive error <code class=\"highlighter-rouge\">undefined method map for \"'users' FORCE INDEX\n(my_user_index)\":Arel::Nodes::SqlLiteral</code> than you can try to replace\n<code class=\"highlighter-rouge\">includes/references</code> with <code class=\"highlighter-rouge\">joins</code>.</p>\n\n<h2 id=\"deadlocks\">Deadlocks</h2>\n\n<p><a href=\"https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlock-example.html\">https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlock-example.html</a>\n<a href=\"http://api.rubyonrails.org/v5.1/classes/ActiveRecord/Locking/Pessimistic.html\">http://api.rubyonrails.org/v5.1/classes/ActiveRecord/Locking/Pessimistic.html</a>\n<a href=\"http://www.chriscalender.com/advanced-innodb-deadlock-troubleshooting-what-show-innodb-status-doesnt-tell-you-and-what-diagnostics-you-should-be-looking-at/\">http://www.chriscalender.com/advanced-innodb-deadlock-troubleshooting-what-show-innodb-status-doesnt-tell-you-and-what-diagnostics-you-should-be-looking-at/</a></p>\n\n<p><a href=\"https://vimeo.com/12941188\">https://vimeo.com/12941188</a></p>\n\n<p>For errors</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Mysql2::Error: Lock wait timeout exceeded; try restarting transaction\nMysql2::Error: Deadlock found when trying to get lock; try restarting transaction: UPDATE\n</code></pre></div></div>\n<p>you can see examples on https://github.com/duleorlovic/deadlock_mysql\nTo get latest deadlock in mysql run <code class=\"highlighter-rouge\">msql&gt; SHOW ENGINE INNODB STATUS</code></p>\n\n<p><code class=\"highlighter-rouge\">Farmer.lock.find</code> will wait untill it is free to lock this farmer.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>alert = nil\nActiveRecord::Base.transaction do\n  if something_wrong?\n    alert = 'Can not ...'\n    raise ActiveRecord::Rollback\n  end\nend\nif alert\n</code></pre></div></div>\n\n<p>Race conditions</p>\n\n<p>When you have a lot of users and long db update commands than you probably have\nexceptions for deadlocks and duplicate entries. You can retry\nhttps://speakerdeck.com/rstankov/zero-exceptions-in-production?slide=71</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/users_controller.rb\n  def update\n    retries ||= 2\n    # perform some long task and in another browser and thread try to lock it\n  rescue ActiveRecord::RecordNotUnique\n    retries -= 1\n    raise unless retries.nonzero?\n    retry\n  end\n</code></pre></div></div>\n\n<h1 id=\"mysql\">MySql</h1>\n\n<ul>\n  <li>if you have\n<code class=\"highlighter-rouge\">/home/orlovic/.rvm/gems/ruby-2.2.4/gems/mysql2-0.4.4/lib/mysql2.rb:31:in\nrequire: libmysqlclient.so.18: cannot open shared object file: No such file\nor directory -\n/home/orlovic/.rvm/gems/ruby-2.2.4/gems/mysql2-0.4.4/lib/mysql2/mysql2.so\n(LoadError)</code> than try <code class=\"highlighter-rouge\">gem uninstall mysql2;gem install mysql2</code></li>\n  <li>\n    <p>on mac os if you have <code class=\"highlighter-rouge\">Mysql2::Error: Can't connect to local MySQL server\nthrough socket '/var/run/mysqld/mysqld.sock' (2)</code> than create a link to socket\nfile whish is located using <code class=\"highlighter-rouge\">mysql_config --socket</code> or <code class=\"highlighter-rouge\">mysqladmin variables</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo mkdir /var/run/mysqld\nsudo ln -s /tmp/mysql.sock /var/run/mysqld/mysqld.sock\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>create mysql user</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mysql -u root -p\nCREATE USER 'myuser'@'localhost' IDENTIFIED BY 'asdf';\n\n# list all\nSELECT User FROM mysql.user;\n# change password\nSET PASSWORD FOR 'user-name-here'@'hostname-name-here' = PASSWORD('new-password-here');\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>restore mysql sql dump</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mysql -u myuser -pMYPASSWORD my_database_name &lt; tmp/web001db.sql\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>create database with specific character set</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>CREATE DATABASE my_app DEFAULT CHARACTER SET 'ascii';\n</code></pre></div>    </div>\n\n    <p>or in <code class=\"highlighter-rouge\">config/database.yml</code> with</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>development:\n  adapter: mysql2\n  encoding: ascii\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>On Heroku it is better to use <em>JawsDB MySQL</em> than <em>ClearDB MySQL</em> since it has\nmore MB in for free usage.</p>\n\n<ul>\n  <li>\n    <p>to chech if mysql database exists use mysqlshow</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>exists = capture(\"echo $(mysqlshow --user=#{env.db_user} --password=#{env.db_pass} #{env.db_name} | grep -V Wildcard | grep -o #{env.db_name})\")\nif exists.strip.size == 0\n  # does not exists\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"turbolinks\">Turbolinks</h1>\n\n<p><code class=\"highlighter-rouge\">$(function)</code> is shorthand for <code class=\"highlighter-rouge\">$(document).ready(function(){})</code> (and is not the\nsame as <code class=\"highlighter-rouge\">$(document).on('ready', function(){})</code>) and it is when DOM is ready. If\nyou need to know when all images and iframes are loaded than use\n<code class=\"highlighter-rouge\">$(window).on('load', function() {})</code>.\nTurbolinks is installed with adding <code class=\"highlighter-rouge\">gem 'turbolinks'</code> and include in\napplication.js <code class=\"highlighter-rouge\">//= require turbolinks</code>.</p>\n\n<blockquote>\n  <p>Turbolinks intercepts all clicks on <a href=\"\"> links to the same domain. When\nyou click an eligible link, Turbolinks prevents the browser from following it.\nInstead, Turbolinks changes the browser’s URL using the History API, requests\nthe new page using XMLHttpRequest, and then renders the HTML response.</a></p>\n</blockquote>\n\n<blockquote>\n  <p>During rendering, Turbolinks replaces the current &lt;body&gt; element outright and\nmerges the contents of the &lt;head&gt; element. The JavaScript window and document\nobjects, and the HTML &lt;html&gt; element, persist from one rendering to the next.</p>\n</blockquote>\n\n<p>With turbolinks rails acts as single page application. It will intercept <code class=\"highlighter-rouge\">&lt;a&gt;</code>\nlinks, but if you want to redirect using javascript <code class=\"highlighter-rouge\">window.location</code> than you\ncan use <code class=\"highlighter-rouge\">Turbolinks.visit link</code>, for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$(document).on 'click', '[data-click]', (e) -&gt;\n  Turbolinks.visit $(this).data('click')\n</code></pre></div></div>\n\n<p>Each visit can be <code class=\"highlighter-rouge\">advance</code> or <code class=\"highlighter-rouge\">replace</code>, than can be set with\n<code class=\"highlighter-rouge\">data-turbolinks-action=\"replace\"</code> or <code class=\"highlighter-rouge\">Turbolinks.visit link, { action:\n'replace' })</code>.\n<code class=\"highlighter-rouge\">restore</code> visit is when we click <code class=\"highlighter-rouge\">Back</code> and can not be canceled.\nYou can disable turbolink on specific link with <code class=\"highlighter-rouge\">data-turbolinks=\"false\"</code></p>\n\n<p>Since <code class=\"highlighter-rouge\">window</code> and <code class=\"highlighter-rouge\">document</code> remains, all objects remain in memory.</p>\n\n<p>So if you want to do something on every page and on first load than you need to\nbind on <code class=\"highlighter-rouge\">turbolinks:load</code>\nWithout turbolinks it would be on ready_page_load.coffee <code class=\"highlighter-rouge\">$(document).on 'ready\npage:load', -&gt;</code>\nThis file is used when you need to iterate some elements <code class=\"highlighter-rouge\">.each</code>, to activate\nsome plugins or when you need to bind click event listener and prevent it in\nanother data event click</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/javascripts/turbolinks_load.coffee\n$(document).on('turbolinks:load', -&gt;\n  # in previous rails we used to catch up on 'ready page:load'\n  console.log \"document on turbolinks:load\"\n\n  # Activating Best In Place\n  jQuery(\".best_in_place\").best_in_place()\n  autosize $('textarea')\n\n  $('[data-disable-button-if-empty]').on('change paste keyup input', -&gt;\n    disabled = this.value.length == 0\n    button = $(this).parents('form').first().find('[type=submit]')\n    button.prop('disabled', disabled)\n\n  # initial status\n  $.each $('[data-disable-button-if-empty]'), (index, el) -&gt;\n    $(el).trigger('change')\n\n  # for infinite pagination use two divs, second need to have pagination links\n  # &lt;div data-scroll='true'&gt;\n  #   &lt;div data-scroll-content='true'&gt;\n  #     &lt;% @items.each do |item| %&gt;\n  #     &lt;% end %&gt;\n  #     &lt;%= will_paginate, class: 'hide-not-important' %&gt;\n  #\n  # when you do not want auto trigger you can use\n  # &lt;div data-scroll='true' data-scroll-auto-trigger='false'&gt;\n  #   &lt;div data-scroll-content='true'&gt;\n  #     ...\n  #     &lt;%= will_paginate @items, next_label: 'Show more...', class: 'show-more-pagination', page_links: false %&gt;\n  $('[data-scroll]').each -&gt;\n    if $(this).data('scrollAutoTrigger') == undefined\n      autoTrigger = true\n    else\n      autoTrigger = $(this).data('scrollAutoTrigger')\n    $(this).jscroll(\n      nextSelector: 'a.next_page'\n      autoTrigger: autoTrigger\n      contentSelector: '[data-scroll-content]'\n      loadingHtml: \"&lt;div class='col-xs-12 text-center mtb20 widget-loader'&gt;&lt;img src='https://d1bnwaoqvo9ynq.cloudfront.net/assets/images/loader_widget_sb.gif' alt='loading'&gt;&lt;p&gt;Loading more...&lt;/p&gt;&lt;/div&gt;\"\n      callback: -&gt;\n        console.log 'jscroll callback'\n    )\n\n  # we can not use $(document).on 'click', '[data-enable-if-valid]', (e) -&gt;\n  # since we can not prevent already bubbled click event in case of invalid input\n  $('[data-enable-if-valid]').on 'click', (e) -&gt;\n    $button = $(this)\n    # http://jqueryvalidation.org/Validator.element/\n    # https://johnnycode.com/2014/03/27/using-jquery-validate-plugin-html5-data-attribute-rules/\n    validator = $button.parents('form').validate()\n    $inputs = $($button.data().enableIfValid).find('input')\n    all_valid = true\n    $inputs.each -&gt;\n      unless validator.element $(this)\n        all_valid = false\n    if all_valid\n      console.log $button.data().enableIfValid + \" is valid\"\n    else\n      # this hack will prevent other data- events, like data-active-next\n      $button.prop('disabled', 'disabled')\n      setTimeout(\n        -&gt;\n          $button.prop('disabled', false)\n        200\n      )\n      console.log $button.data().enableIfValid + \" is not valid\"\n</code></pre></div></div>\n\n<p>When you are using <code class=\"highlighter-rouge\">data-remote-true</code> for show edit form than request is JS and\nany javascript inside <code class=\"highlighter-rouge\">js.erb</code> or inside partial <code class=\"highlighter-rouge\">$('#id').replaceWith('&lt;%= j\nrender 'partial' %&gt;');</code> is executed every time. Problem is with bootstrap\nmodals where request is HTML. remote modal content is deprecated in\n<a href=\"https://getbootstrap.com/docs/3.3/javascript/#modals-options\">v4</a> so it’s\nbetter to use custom implementation</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/document_on.coffee\n$(document).on 'click', '[data-js-modal]', (e) -&gt;\n  arget = this.dataset.jsModal\n  remote_link = this.href || this.dataset.jsModalHref\n  $(target).modal('show')\n  # use $.ajax and replaceWith since $.load use .html which discard scripts\n  $.ajax(\n    url: remote_link\n  ).done (responseText) -&gt;\n    $(target + \" .modal-content\").replaceWith responseText\n  e.preventDefault()\n\n$(document).on 'click change', '[data-toggle-active]', (e) -&gt;\n  target = $(this).data().toggleActive\n  if $(this).is(':checkbox')\n    # if we click directly on checkbox, it will receive also the click event,\n    # but usually that is fine (also when you are using bootstrap toggle)\n    to_show = e.currentTarget.checked\n  else\n    to_show = !$(target).hasClass('active')\n  if to_show\n    $(target).addClass 'active'\n  else\n    $(target).removeClass 'active'\n  console.log \"data-toggle-active #{target}\"\n</code></pre></div></div>\n\n<p>and trigger turbolinks load so it can catch new items. Instead of triggering,\nyou can call <code class=\"highlighter-rouge\">initializeDatepicker()</code>. That is also needed below the\nforms since ajax request in remote-true forms also need to run the initializaion\nscripts.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/initialize_datepicker.coffee\nwindow.initializeDatepicker = -&gt;\n  $date_elements = $('.date')\n  return unless $date_elements\n  ...\n</code></pre></div></div>\n\n<p>If you want to perform something on click for existing and new elements, but\nonly on particular page, you can bind bind click on document on that page inside\nbody. But when you navigate 10 times, it will trigger 10 times. So you can\nunbind on <code class=\"highlighter-rouge\">page:before-change</code>. Note that you should write that after function\ndeclaration because when you click on page again, it will assign “on” on\nprevious version, and unassign latest version of your_function</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;script&gt;\nfunction your_function() {\n  LOG &amp;&amp; console.log(\"your_function call\");\n}\n$(document).on('click', '.class', your_function);\n$(document).one('page:before-change',function() {\n  LOG &amp;&amp; console.log(\"unassign your_function\");\n  $(document).off('click', your_function);\n});\n&lt;/script&gt;\n</code></pre></div></div>\n\n<ul>\n  <li>disable turbolinks <code class=\"highlighter-rouge\">document.body.setAttribute('data-no-turbolink','true')</code></li>\n  <li>\n    <p>turbolinks are good if some of page content is changed using ajax.\nBrowser back button when turbolink is enabled shows last content\n(not first that was fatched). When turbolinks is disabled, you can\nforce refreshing the page with set_cache_buster before filter.\nNote that any input field stays populated (also hidden input field\nwhich you eventually populated in javascript):</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def set_cache_buster\n  response.headers[\"Cache-Control\"] = \"no-cache, no-store, max-age=0, must-revalidate\"\n  response.headers[\"Pragma\"] = \"no-cache\"\n  response.headers[\"Expires\"] = \"Fri, 01 Jan 1990 00:00:00 GMT\"\nend\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"seed\">Seed</h1>\n\n<p>If you want indempotent seeds data you should have some identifier (for example\n<code class=\"highlighter-rouge\">id</code>) for wich you can run <code class=\"highlighter-rouge\">where(id: id).first_or_create! do...end</code>.\nUser should use <code class=\"highlighter-rouge\">first_or_initialize</code> since we can’t create without\npassword, but we don’t have password field. <code class=\"highlighter-rouge\">do ... end</code> block is used only if\nthat object is not found.\n<code class=\"highlighter-rouge\">slice</code> is used for uniq fields (not generated by faker), but all other fields\nshould be populated in block. Slice is nice method to get params hash from\ncurrent active record object <code class=\"highlighter-rouge\">user.slice :email, :name # { email: '', name: ''\n}</code></p>\n\n<p>Use <code class=\"highlighter-rouge\">faker</code> gem to generate example strings:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">Faker::Internet.email</code></li>\n  <li><code class=\"highlighter-rouge\">Faker::Name.name</code> <code class=\"highlighter-rouge\">Faker::PhoneNumber.cell_phone</code> <code class=\"highlighter-rouge\">Faker::Avatar.image(\"my-own-slug\", \"50x50\")</code></li>\n  <li><code class=\"highlighter-rouge\">Faker::Company.name</code> <code class=\"highlighter-rouge\">Faker::Company.logo</code> <strong>real logo</strong></li>\n  <li><code class=\"highlighter-rouge\">Faker::Address.street_address</code> <code class=\"highlighter-rouge\">Faker::Address.city</code></li>\n  <li><code class=\"highlighter-rouge\">Faker::Lorem.sentence</code> <code class=\"highlighter-rouge\">Faker::ChuckNorris.fact</code></li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># db/seeds.rb\n# we keep all variables (defined as property var: :name) in global b hash\n# so you an access them later as `b[:name]`\nb = {}\n\n# rubocop:disable Rails/Output\n# JobType\n[\n  { var: :my_job_type, name: 'Admin/Office' }\n].each do |doc|\n  r = JobType.where(doc.except(:var)).first_or_create! do |job_type|\n    # you do not need to call save! here\n    # put common stuff here\n    job_type.domain = 'my_domain'\n    puts \"JobType #{doc[:name]}\"\n  end\n  b[doc[:var]] = r if doc[:var]\nend\n\n# deterministic and random data\n1.upto(10).map do |i|\n  { email: \"user#{i}@asd.asd\", password: Faker::Internet.password }\nend.each do |doc|\n  User.where(doc.except(:password, :remote_avatar_url)).first_or_create! do |user|\n    user.password = doc[:password]\n    user.remote_avatar_url = doc[:remote_avatar_url]\n    user.confirm! # do not skip_confirmation!, we need to have confirmed so\n    # we can log in as this user from admin panel. sign_in will fail for\n    # autogenerated users who did not confirm or skip confirmation\n    # note that admin can NOT sign in as any not confirmed user\n    puts \"User #{user.email}\"\n  end\nend\n\nasd_user = User.find_by! email: 'asd@asd.asd'\n</code></pre></div></div>\n\n<h1 id=\"custom-logger\">Custom logger</h1>\n\n<p>You can add tags (methods for request object), for example:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/application.rb\nconfig.log_tags = [:remote_ip]\n</code></pre></div></div>\n\n<p>But if you want custom logger, than you can override existing</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/logger_formatter.rb\nclass ActiveSupport::Logger::SimpleFormatter\n  # from activesupport/lib/active_support/core_ext/logger.rb\n  def call(severity, time, progname, msg)\n    \"#{severity_color severity} #{String === msg ? msg : msg.inspect}\\n\"\n  end\n\nprivate\n\n  def severity_color(severity)\n    case severity\n    when \"DEBUG\"\n      \"\\033[0;34;40m[DEBUG]\\033[0m\" # blue\n    when \"INFO\"\n      \"\\033[1;37;40m[INFO]\\033[0m\" # bold white\n    when \"WARN\"\n      \"\\033[1;33;40m[WARNING]\\033[0m\" # bold yellow\n    when \"ERROR\"\n      \"\\033[1;31;40m[ERROR]\\033[0m\" # bold red\n    when \"FATAL\"\n      \"\\033[7;31;40m[FATAL]\\033[0m\" # bold black, red bg\n    else\n      \"[#{severity}]\" # none\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>I need to put backtrace in reverse order, so I wrap that code (for example whole\nseeds.rb).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>begin\n# code\n# never rescue from Exception, but use Standard error\nrescue StandardError =&gt; e\n  puts e.backtrace.reverse\n  puts e.class, e.message\nend\n</code></pre></div></div>\n\n<p>I do not know how to catch all exceptions without wrapping (maybe to use rack\napp as the exception_notification does).  I will try to create new logger, it\nis used for whole Rails application.\n<a href=\"http://stackoverflow.com/questions/6407141/how-can-i-have-ruby-logger-log-output-to-stdout-as-well-as-file\">http://stackoverflow.com/questions/6407141/how-can-i-have-ruby-logger-log-output-to-stdout-as-well-as-file</a></p>\n\n<h1 id=\"mustache\">Mustache</h1>\n\n<p><a href=\"https://github.com/mustache/mustache\">mustache</a> is nice to render user\ntemplates <code class=\"highlighter-rouge\">Hi </code>, where <code class=\"highlighter-rouge\">name</code> is placeholder which is inside handlebars</p>\n\n<p>Usage is simple as</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>data_for_body == current_user.contacts.first\n@template_body = TemplateRenderService.new(@template.body, data_for_body).render\n# in view use &lt;%= simple_format @template_body %&gt; to convert \\n to &lt;br&gt;\n</code></pre></div></div>\n\n<p>It is usefull to delegate fields in contacts model to some belongs_to\nassociation, like <code class=\"highlighter-rouge\">delegate User::FIELD_NAMES, to: :user</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/services/template_render_service.rb\nclass TemplateRenderService\n  attr_reader :template_body, :data_for_body\n\n  def initialize template_body, data_for_body\n    @template_body = template_body\n    @data_for_body = data_for_body\n  end\n\n  def render\n    m = Mustache.new\n    m.raise_on_context_miss = true\n    m.render(template_body, data_for_body)\n  rescue Mustache::ContextMiss, Mustache::Parser::SyntaxError =&gt; e\n    e.message\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"rake-tasks\">Rake tasks</h1>\n\n<p>You can write tasks with arguments <a href=\"http://guides.rubyonrails.org/command_line.html#custom-rake-tasks\">rails\nrake</a></p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># lib/tasks/db.rake\nnamespace :db do\n  desc 'This task does nothing'\n  task nothing: :environment do\n    # environment is needed to load rails\n  end\nend\n</code></pre></div></div>\n\n<p>Instead of <code class=\"highlighter-rouge\">:env</code> or <code class=\"highlighter-rouge\">:environment</code> you can use other tasks on which it depends.\nAlso you can receive parameters into <code class=\"highlighter-rouge\">args</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># lib/tasks/update_subdomain.rake\n# instead of puts, we can use Rails.logger.info\nRails.logger = Logger.new(STDOUT)\nnamespace :update_subdomain do\n  desc \"update subdomains for my-user. default value is 'my_subdomain'\"\n  task :my_user, [:subdomain] =&gt; :environment do |task, args|\n    args.with_defaults subdomain: 'my_subdomain'\n    user = User.find_by name: 'my-user'\n    fail \"Can't find user 'my-user'\" unless user\n    user.subdomain = args.subdomain\n    user.save!\n    Rails.logger.info \"Updated #{user.subdomain}\" || next if return_from_rake_task_now?\n    Rails.logger.info 'Finished'\n  end\nend\n\n# run with\nrake update_subdomain:my_user\nrake update_subdomain:my_user[]\nrake update_subdomain:my_user[new_subdomain]\n</code></pre></div></div>\n\n<p>Another use of rake is to seed</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># lib/tasks/seed.rake\nnamespace :seed do\n  task :bid_types =&gt; :environment do\n    [\"live\", \"silent\", \"teacup\"].each do |name|\n      BidType.find_or_create_by! name: name\n    end\n  end\nend\n\n# db/seed.rb\nRake::Task[\"seed:bid_types\"].invoke\n\n# call task from another task\nRake::Task['translate:copy'].invoke Rails.env\n</code></pre></div></div>\n\n<p>so you can create with <code class=\"highlighter-rouge\">rake db:seed</code> or <code class=\"highlighter-rouge\">rake seed:bid_types</code></p>\n\n<p>If you want to know inside some code whether you run from rake or from rails\n(for example you do not want to send emails for seed users), you can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>if File.basename($0) == \"rake\"\n  # I'm from rake\nelse\n  # I'm from rails\nend\n</code></pre></div></div>\n\n<h1 id=\"sessions-and-share-cookies-on-multiple-subdomains\">Sessions and share cookies on multiple subdomains</h1>\n\n<p>If you use\n<a href=\"http://makandracards.com/makandra/31381-sharing-cookies-across-subdomains-with-rails-3\">sharing-cookies-across-subdomains-with-rails-3</a>\nor\n<a href=\"http://stackoverflow.com/questions/4060333/what-does-rails-3-session-store-domain-all-really-do\">what-does-rails-3-session-store-domain-all-really-do</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/session_store.rb\nRails.application.config.session_store :cookie_store, key: '_myapp_session',\ndomain: :all, expire_after: 60.minutes\n</code></pre></div></div>\n\n<p>If you do not use <code class=\"highlighter-rouge\">expired_after</code> than it will be <code class=\"highlighter-rouge\">-1</code> ie in Dev Tools -&gt;\nApplication -&gt; Cookies it will be <code class=\"highlighter-rouge\">1969-12-31T23:59:59.000Z</code> 1970 - 1 second, ie\ncookie will be discarded when browser is closed (on mobile when phone restarts,\nsince closing browser keeps current session).</p>\n\n<p>This works fine for top level domains and subdomains for them.</p>\n\n<p>For example if you have <code class=\"highlighter-rouge\">domain: :all</code> and you sign in at <code class=\"highlighter-rouge\">asd.local</code>, than you\nwill be signed in also on <code class=\"highlighter-rouge\">asd.asd.local</code> and <code class=\"highlighter-rouge\">asd.asd.asd.local</code> and so on…\nCookie will be with domain <code class=\"highlighter-rouge\">.asd.local</code> for all those sites.</p>\n\n<p>You need to know that some domains like <code class=\"highlighter-rouge\">herokuapp.com</code> belongs to <a href=\"https://devcenter.heroku.com/articles/cookies-and-herokuapp-com\">Public\nSuffix List</a> so\nbrowser will prevent setting <code class=\"highlighter-rouge\">domain: :all</code> cookie for them (because someone can\nuse attacker.herokuapp.com to read cookies from myapp.herokuapp.com).</p>\n\n<p>Note you can not login at <code class=\"highlighter-rouge\">in.rs</code> (PSL and browser will prevent cookie).</p>\n\n<p>Rails cookie store knows for public suffix list, so for <code class=\"highlighter-rouge\">trk.in.rs</code> it will use\n<code class=\"highlighter-rouge\">.trk.in.rs</code> and all others like <code class=\"highlighter-rouge\">asd.in.local</code> it will use <code class=\"highlighter-rouge\">.in.local</code>.</p>\n\n<p>You can login at <code class=\"highlighter-rouge\">trk.in.rs</code> but it wont be shared to <code class=\"highlighter-rouge\">asd.in.rs</code>. Cookie will\nbe with domain <code class=\"highlighter-rouge\">.trk.in.rs</code>, so you will be signed in also on <code class=\"highlighter-rouge\">1.trk.in.rs</code>\n<code class=\"highlighter-rouge\">2.1.trk.in.rs</code> …</p>\n\n<p>Cookie are send on each request. Cookies usually does not expire, but you can\nset <code class=\"highlighter-rouge\">expire_after: 60.minutes</code>. They are send again when you refresh close &amp;\nopen window.</p>\n\n<p>Note that flash messages are also for each domain. So if you redirect from one\ndomain to another, you can not use flash messages. Old flash message will be\nshown when user come back to previous domain (on which request flash was set).</p>\n\n<h1 id=\"subdomains-and-long-domains\">Subdomains and long domains</h1>\n\n<p>Rails has method <a href=\"http://api.rubyonrails.org/classes/ActionDispatch/Http/URL.html#method-c-extract_domain\">extract\ndomains</a>\nbut it requires second param which determine if it is top level and second level\ndomain.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActionDispatch::Http::URL.extract_domain 'dule.asd.zxc.com', 1 # 'zxc.com'\nActionDispatch::Http::URL.extract_domain 'dule.asd.zxc.com', 2 # 'asd.zxc.com'\n</code></pre></div></div>\n\n<p>You could try to guess based on next to last string and determine if it\nis shorter or equal than 3 chars.\nRails domain is always last two strings.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># dule.asd.zxc.com\nrequest.host = 'dule.asd.zxc.com'\nrequest.domain = 'zxc.com'\nrequest.subdomain = 'dule.asd'\n\n# you can specify different tld length\nrequest.domain(2) = 'asd.zxc.com'\n</code></pre></div></div>\n\n<p>When you use url for, you can pass <code class=\"highlighter-rouge\">host</code> parameter.\nBut if you pass also <code class=\"highlighter-rouge\">subdomain</code> than host param will be trimmed to only last\ntwo strings <a href=\"https://github.com/rails/rails/issues/2025\">issue</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>url_for\nActionDispatch::Http::URL.url_for host: 'dule.asd.zxc.com'\n# http://dule.asd.zxc.com\nActionDispatch::Http::URL.url_for host: 'dule.asd.zxc.com', subdomain: 'sub'\n# http://sub.zxc.com\n# note that we are missing 'asd' in domain name\n</code></pre></div></div>\n\n<h1 id=\"text-syntax-on-buttons-and-messages\">Text syntax on buttons and messages</h1>\n\n<ul>\n  <li>labels on buttons, titles,…  should be upper case with no period: <code class=\"highlighter-rouge\">This Job\nIs Paused</code></li>\n  <li>sentences on error messages, flash messages…  should have period at the end:\n<code class=\"highlighter-rouge\">Job has been copied.</code></li>\n</ul>\n\n<p>Use “Register” or “Sign up” for registrations and “Log in” and “Log out” for\nsessions (since it is easy to differentiate from “sign up”).</p>\n\n<h1 id=\"7-patterns\">7 patterns</h1>\n\n<p>From\n<a href=\"http://blog.codeclimate.com/blog/2012/10/17/7-ways-to-decompose-fat-activerecord-models/\">7-ways-to-decompose-fat-activerecord-models</a>\nsuggestions for code organization I use mostly:</p>\n\n<p>You can check also <a href=\"http://trailblazer.to/\">http://trailblazer.to/</a>\nYou can organize domain (controller, model and view) into separate folders\n<a href=\"https://github.com/NullVoxPopuli/drawers\">drawers</a></p>\n\n<p>If there is a lot of business logic in view, I prefer to put that in controller\nso it is more visible.</p>\n\n<h2 id=\"service-objects\">Service objects</h2>\n\n<p>Always define only one public method: <code class=\"highlighter-rouge\">call</code>, <code class=\"highlighter-rouge\">perform</code> or <code class=\"highlighter-rouge\">process</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/services/match_posts.rb\ndef MatchPosts\n  def initialize(posts)\n    @posts = posts\n  end\n\n  def perform\n  end\nend\n</code></pre></div></div>\n\n<p>You should return object that can be success and hold some data</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/result.rb\nclass Result\n  attr_accessor :message, :data\n\n  # you can return in service like:\n  #   return Result.new 'Next task created', next_task: next_task\n  # and use in controller:\n  #   if result.success? &amp;&amp; result.data[:next_task] == task\n  def initialize(message, data = {})\n    @message = message\n    @data = data\n  end\n\n  def success?\n    true\n  end\nend\n\n# app/models/error.rb\nclass Error &lt; Result\n  def success?\n    false\n  end\nend\n</code></pre></div></div>\n\n<p>and you can rescue from exceptions:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/services/my_service.rb\nclass MyService\n  # Some custom exception if needed\n  class ProcessException &lt; Exception\n  end\n\n  def initialize(h)\n    @user = h[:user]\n  end\n\n  def process(posts)\n    success_message = do_something posts\n    Result.new success_message\n  rescue ProcessException =&gt; e\n    Error.new e.message\n  end\n\n  private\n\n  def do_something(posts)\n    raise ProcessException, \"Error: empty posts\" unless posts\n    \"Done with do_something\"\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># main.rb\nrequire './my_service.rb'\n\nmy_service = MyService.new user: 'me'\nputs my_service.process(1).success? # true\nputs my_service.process(1).message # Done with do_something\nputs my_service.process(false).success? # false\nputs my_service.process(false).message # empty posts\n</code></pre></div></div>\n\n<p>Service object is similar to Command pattern which is implemented in gem\n<a href=\"https://github.com/collectiveidea/interactor\">https://github.com/collectiveidea/interactor</a></p>\n\n<h2 id=\"form-objects\">Form Objects</h2>\n\n<p>form objects (query objects) for multiple in multiple out data</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/form_objects/landing_signup.rb\nclass LandingSignup\n  include ActiveModel::Model\n  FIELDS = %i[ current_city current_location current_group prefered_group email].freeze\n  attr_accessor(*FIELDS)\n\n  validates :email, presence: true\n\n  def save\n    _create_users\n    _create_roles\n  end\n\n  # no need for initialize since AR will pick from params\n  # but if you need to set default values, here is a code\n  def initialize(attributes)\n    super(attributes)\n    _after_initialize\n  end\n\n  def _after_initialize\n    self.send_email_invitation = true if send_email_invitation.nil?\n  end\nend\n</code></pre></div></div>\n\n<p>Usage</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/pages_controller.rb\nclass PagesController &lt; ApplicationController\n  def home\n    @landing_signup = LandingSignup.new\n    @landing_signup.current_city = City.first\n  end\n\n  def landing_signup\n    @landing_signup = LandingSignup.new landing_signup_params\n    @landing_signup.current_city = City.first\n    if @landing_signup.save\n      sign_in @landing_signup.user\n      redirect_to dashboard_path, notice: @landing_signup.notice\n    else\n      flash.now[:alert] = @landing_signup.errors.full_messages.to_sentence\n      render :home\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>To define url for ActiveModel you need to overwrite some instance vars\nhttps://stackoverflow.com/questions/3736759/ruby-on-rails-singular-resource-and-form-for\nso better is to define url param <code class=\"highlighter-rouge\">form_for @form, url: users_path</code></p>\n\n<h2 id=\"decorators\">Decorators</h2>\n\n<p>Decorators can be used instead of callbacks. Differs from service object because\nit just decorate existing model (it can be used instead of that model, usefull\nfor forms). Form object is like a decorator, but for multiple models.\nSo instead using <code class=\"highlighter-rouge\">method_missing</code> you can use standard ruby <code class=\"highlighter-rouge\">SimpleDelegator</code>\nwhich delegates any method to object that was passed in initialization</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/decorators/message_decorator.rb\nclass MessageDecorator &lt; SimpleDelegator\n  def message\n    __getobj__\n  end\n\n  def save_and_send_notifications\n    message.save &amp;&amp; _send_notifications\n  end\n\n  def _send_notifications\n    message.chat.moves.each do |move|\n      next if move.user == message.user\n      UserMailer.new_message(move.id, message.id).deliver_later\n    end\n    true\n  end\nend\n</code></pre></div></div>\n\n<p>Use in controller</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  def show\n    @message_decorator = MessageDecorator.new Message.new\n  end\n\n  def create_message\n    @message_decorator = MessageDecorator.new Message.new _message_params\n    if @message_decorator.save_and_send_notifications\n      redirect_to chat_path(@chat), notice: t_crud('success_create', Message)\n    else\n      render :show\n    end\n  end\n\n</code></pre></div></div>\n\n<h2 id=\"concerns\">Concerns</h2>\n\n<p><a href=\"https://signalvnoise.com/posts/3372-put-chubby-models-on-a-diet-with-concerns\">DHH</a> and interesting is\n<a href=\"https://github.com/discourse/discourse/blob/master/app/models/concerns/trashable.rb\">trashable</a>\n<a href=\"https://youtu.be/bHpVdOzrvkE?t=1640\">video</a>\n<a href=\"http://www.monkeyandcrow.com/blog/reading_rails_concern/\">blog</a>\nexample usage https://github.com/rails/rails/blob/87b0de450761d4404deb615c9b83307316ddb050/activesupport/lib/active_support/rescuable.rb#L11</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>module Someable\n  extend ActiveSupport::Concern\n\n  included do\n    # define validations, callbacks and associations here (before_ has_  macros)\n    # access module variables @@my_module_variable or class variable\n    # self.class.class_variable_get :@@someable_value\n    has_many :something_else, as: :someable\n    class_attribute :tag_limit\n  end\n\n  # instance methods are defined here\n\n  # methods defined here are going to extend the class, not the instance of it\n  # do not use \"self.\" in method definition\n  # you can set \"@@my_module_variable\" here\n  # better is to set class_variable:  self.ancestors.first.class_variable_set :@@someable_value, 'some value'\n  # also you can include other concerns here\n  class_methods do\n    def tag_limit(value)\n      klass = self.ancestors.first\n      previous_columns = klass.class_variable_get(:@@monetized_columns) if klass.class_variables.include? :@@monetized_columns\n      previous_columns ||= []\n      klass.class_variable_set :@@monetized_columns, previous_columns + columns\n      self.tag_limit_value = value\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>My implementation of friendly_id gem\n<script src=\"https://gist.github.com/duleorlovic/724b8ab1eb44d7f847ee.js\"></script></p>\n\n<h2 id=\"observable\">Observable</h2>\n\n<p>We an use observable objects to send notifications <a href=\"http://www.diatomenterprises.com/observer-pattern-in-3-languages-ruby-c-and-elixir/\">implementation in 3\nlanguages</a>\nIt could looks like <a href=\"https://en.wikipedia.org/wiki/Action_at_a_distance_(computer_programming)\">action as a\ndistance</a>\nantipattern but if we explicitly add than is it fine.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>module ObservableImplementation\n  def observers\n    @observers ||= []\n  end\n\n  def notify_observers(*args)\n    observers.each do |observer|\n      observer.update(*args)\n    end\n  end\n\n  def add_observer(object)\n    observers &lt;&lt; object\n  end\nend\n\nclass Task\n  include ObservableImplementation\n  attr_accessor :counter\n  def initialize\n    self.counter = 0\n  end\n\n  def tick\n    self.counter += 1\n    notify_observers(counter)\n  end\nend\n\nclass PutsObserver\n  def initialize(observable)\n    observable.add_observer self\n  end\n\n  def update(counter)\n    puts \"Count has increased by #{counter}\"\n  end\nend\n\nclass DotsObserver\n  def initialize(observable)\n    observable.add_observer self\n  end\n\n  def update(counter)\n    puts \".\" * counter\n  end\nend\n\ntask = Task.new\ntask.tick\nDotsObserver.new(task)\ntask.tick # ..\nPutsObserver.new(task)\ntask.tick # ...\n# Count has increased by 3\n</code></pre></div></div>\n\n<h1 id=\"unsubscribe-links\">Unsubscribe links</h1>\n\n<p>You can use\nhttps://api.rubyonrails.org/v5.2.2.1/classes/ActiveSupport/MessageVerifier.html\nto encode strings or id</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  @unsubscribe = Rails.application.message_verifier(:unsubscribe).generate(@user.id)\n</code></pre></div></div>\n\n<p>Old example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/layouts/_email_footer.html.erb\n&lt;p&gt;\n  &lt;%= link_to \"Unsubscribe\", link_for_unsubscribe(user, controller.mapping_to_unsubscribe_group(controller.action_name)) %&gt; from this type of email.\n&lt;/p&gt;\n&lt;p&gt;\n  &lt;%= link_to \"Manage\", settings_user_url(user) %&gt; which emails you receive.\n&lt;/p&gt;\n\n# app/controllers/application_mail.rb\n  def mapping_to_unsubscribe_group method_name\n    group = ApplicationHelper::UNSUBSCRIBE_MAPPING_METHOD_TO_GROUP[method_name.to_s]\n    if group.nil?\n      puts \"!!!!! No group found for method_name=#{method_name.to_s}\"\n      ExceptionNotifier.notify_exception(Exception.new(\"just to notify that there is no group for method_name #{method_name}\") )\n    end\n    group\n  end\n\n# app/helpers/application_helper.rb\n  UNSUBSCRIBE_MAPPING_METHOD_TO_GROUP = {\n    \"first_application_instructions\" =&gt; \"tips_and_help_emails_jobseeker\",\n    \"application_in_review_instructions\" =&gt; \"tips_and_help_emails_jobseeker\",\n    \"new_candidate_email\" =&gt; \"new_candidate_or_applicant\",\n    }\n  def link_for_unsubscribe user, unsubscribe_group\n    referral_token_and_unsubscribe_group = user.referral_token + unsubscribe_group.to_s\n    unsubscribe_url key: Base64.encode64(referral_token_and_unsubscribe_group)\n  end\n\n# config/routes.rb\n  get 'unsubscribe', to: 'welcome#unsubscribe'\n\n# app/controllers/welome_controller.rb\n  # GET /unsubscribe\n  def unsubscribe\n    referral_token_and_unsubscribe_group = Base64.decode64 params[:key] \n    referral_token = referral_token_and_unsubscribe_group[0..User::REFERRAL_TOKEN_LENGTH-1]\n    @unsubscribe_group = referral_token_and_unsubscribe_group[User::REFERRAL_TOKEN_LENGTH..-1]\n    if current_user\n      if current_user.referral_token == referral_token\n        @user = current_user\n        @user.unsubscribe[ @unsubscribe_group] = \"true\"\n        @user.save!\n      else\n        redirect_to root_path, alert: \"This key is for different user, please log out\"\n      end\n    else\n      if @user = User.find_by( referral_token: referral_token)\n        # we found the user\n        @user.unsubscribe[ @unsubscribe_group] = \"true\"\n        @user.save!\n      else\n        flash[:alert] = \"Can't find user by this key. You need to signin in order to unsubscribe\"\n        redirect_to new_user_session_path and return\n      end\n    end\n  end\n\n# db/migrate/_add_unsubscribe_to_user.rb\nclass AddUnsubscribeToUser &lt; ActiveRecord::Migration\n  def change\n    add_column :users, :unsubscribe, :hstore, default: {}\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"run-rails-in-production-mode\">Run rails in production mode</h1>\n\n<p>You probably need to set up database user for production env.</p>\n\n<p>Also set <code class=\"highlighter-rouge\">config.force_ssl = false</code> in <em>config/environments/production.rb</em></p>\n\n<h1 id=\"get-template-name\">Get template name</h1>\n\n<p>You can try directly in controller to <code class=\"highlighter-rouge\">byebug</code> and try something like</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>view_context.view_renderer.instance_variable_get('@lookup_context').instance_variable_get('@view_paths').instance_variable_get('@paths').first.instance_variable_get('@cache').instance_variable_get('@data').instance_variable_get('@backend').values.first.instance_variable_get('@backend').values.first.instance_variable_get('@backend').values.first.instance_variable_get('@backend').values.first.values\n</code></pre></div></div>\n\n<p>Another is with patch\n<a href=\"http://stackoverflow.com/questions/4973699/rails-3-find-current-view-while-in-the-layout/8310881#8310881\">ActionView::TemplateRenderer</a>\nand this is only accessible in view.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># getting current template is not possible in rails\n# https://github.com/rails/rails/issues/4876\n# patch taken from\n# http://stackoverflow.com/questions/4973699/rails-3-find-current-view-while-in-the-layout/8310881#8310881\n# note 3th comment (Lukas) about exception notification issue\nclass ActionController::Base\n  attr_accessor :active_template\n\n  def active_template_virtual_path\n    self.active_template.virtual_path if self.active_template\n  end\nend\n\nclass ActionView::TemplateRenderer\n  alias_method :_render_template_original_, :render_template\n\n  def render_template(template, layout_name = nil, locals = {})\n    if @view.controller &amp;&amp; @view.controller.respond_to?('active_template=')\n      @view.controller.active_template = template\n      result = _render_template_original_( template, layout_name, locals)\n      @view.controller.active_template = nil\n    else\n      result = _render_template_original_( template, layout_name, locals)\n    end\n    result\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"money\">Money</h1>\n\n<p>Dealing with money with <a href=\"https://github.com/RubyMoney/money-rails\">https://github.com/RubyMoney/money-rails</a></p>\n\n<p>Add money column is using <code class=\"highlighter-rouge\">add_money</code> instead <code class=\"highlighter-rouge\">add_column</code>. You can define where\nto put cents and currency column</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  add_money :invoices, :round_off, amount: { after: :round_off_applicable }, currency: { after: :round_off_cents }\n\n</code></pre></div></div>\n\n<h1 id=\"carrierwave-for-uploading\">Carrierwave for uploading</h1>\n\n<h2 id=\"store-on-server\">Store on server</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\ngem 'carrierwave'\nHERE_DOC\nbundle\nrails generate uploader Document\n# we need just one field type string to store file url\nrails g migration add_document_to_companies document:string\nrake db:migrate\nsed -i app/models/company.rb -e '/class Company/a \\\n  mount_uploader :document, DocumentUploader'\ngit add . &amp;&amp; git commit -m \"Adding carrierwave gem document uploader\"\n</code></pre></div></div>\n\n<p>Replace <code class=\"highlighter-rouge\">f.text_field :document</code> with <code class=\"highlighter-rouge\">f.file_field :document</code> in your form. In\nview you can use <code class=\"highlighter-rouge\">company.document.url</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/companies/_form.html.erb %&gt;\n  &lt;%  if @company.document.present?  %&gt;\n    &lt;%= image_tag @company.document, class: 'image-small'%&gt;\n    &lt;%= f.check_box :remove_document %&gt;\n  &lt;% end %&gt;\n  &lt;%= f.file_field :document %&gt;\n  &lt;%# keep the file on reload in case of other validation errors %&gt;\n  &lt;%= f.hidden_field :document_cache %&gt;\n\n# app/controllers/companies_controller.rb\n  def company_params\n    params.require(:company).permit(:document, :remove_document)\n  end\n</code></pre></div></div>\n\n<p>It is straightforward to use uploader in multiple fields. Also you can use\nsingle table field for multiple files (field type json) but than you need\npostgres database.</p>\n\n<p>When you rendering json, than\n<a href=\"http://stackoverflow.com/questions/28184975/carrierwave-causing-json-output-to-become-nested-on-photo-key\">carrierwave will add nested\nurl</a>.\nSolution is render json manually with <code class=\"highlighter-rouge\">json.document_url company.document.url</code>\nor to override uploader serilization with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/uploaders/document_uploader.rb\n  def serializable_hash\n    url\n  end\n</code></pre></div></div>\n\n<p>Resizing is by adding mini magick and configure uploader. It works on Heroku\ntoo. You can process files,\ncreate new versions based on\n<a href=\"https://github.com/carrierwaveuploader/carrierwave#conditional-versions\">condition</a> or process based on <a href=\"http://stackoverflow.com/questions/11778464/conditional-versions-process-with-carrierwave\">condition</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo \"gem 'mini_magick'\" &gt;&gt; Gemfile\nbundle\n\n# app/uploaders/document_uploader.rb\n  include CarrierWave::MiniMagick\n  process resize_to_limit: [200, 300]\n  process resize_to_limit: [300, 300], if: :logo?\n  def logo?(picture)\n    # check if we mount_uploader :logo_url or something else\n    picture.file.headers.match(/logo_url/)\n  end\n  version :thumb do\n    process resize_to_fill: [200, 300]\n  end\n</code></pre></div></div>\n\n<h2 id=\"store-on-aws-s3\">Store on AWS S3</h2>\n\n<p>For <a href=\"https://github.com/carrierwaveuploader/carrierwave#using-amazon-s3\">Amazon\nS3</a> you need\nto set up your AWS keys in <em>~/.bashrc</em> <code class=\"highlighter-rouge\">export AWS_ACCESS_KEY_ID=123123</code> and\n<code class=\"highlighter-rouge\">export AWS_SECRET_ACCESS_KEY=123123</code>. Bucket should be created as standard USA\nbucket.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\ngem 'fog'\nHERE_DOC\ncat &gt; config/initializers/carrierwave.rb &lt;&lt; 'HERE_DOC'\n# https://github.com/jnicklas/carrierwave#using-amazon-s3\nCarrierWave.configure do |config|\n  config.fog_credentials = {\n    :provider               =&gt; 'AWS',\n    :aws_access_key_id      =&gt; Rails.application.secrets.aws_access_key_id,\n    :aws_secret_access_key  =&gt; Rails.application.secrets.aws_secret_access_key,\n    :region                 =&gt; Rails.application.secrets.aws_region # us-east-1\n  }\n  config.fog_directory  = Rails.application.secrets.aws_bucket_name\nend\nHERE_DOC\n\nsed -i config/secrets.yml -e '/^test:/i \\\n  # aws s3\\\n  aws_bucket_name: &lt;%= ENV[\"AWS_BUCKET_NAME\"] %&gt;\\\n  aws_access_key_id: &lt;%= ENV[\"AWS_ACCESS_KEY_ID\"] %&gt;\\\n  aws_secret_access_key: &lt;%= ENV[\"AWS_SECRET_ACCESS_KEY\"] %&gt;\\\n  # region is important for all non us-east-1 regions\\\n  aws_region: &lt;%= ENV[\"AWS_REGION\"] || \"us-east-1\" %&gt;\\\n'\n\nsed -i app/uploaders/document_uploader.rb -e '/storage :file/r \\\n  # storage :file\\\n  storage :fog'\n\ngit add . &amp;&amp; git commit -m \"Configure AWS S3\"\n</code></pre></div></div>\n\n<h2 id=\"store-directly-on-aws-s3-and-upload-the-key-to-the-server\">Store directly on AWS S3 and upload the key to the server</h2>\n\n<p>You can put the <code class=\"highlighter-rouge\">direct_upload_form_for</code> on any page, let’s use show:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# direct upload to S3\ngem 'carrierwave_direct'\nHERE_DOC\nbundle\n\nsed -i app/uploaders/document_uploader.rb -e '/DocumentUploader/a \\\n  include CarrierWaveDirect::Uploader'\n\nsed -i app/uploaders/document_uploader.rb -e '/store_dir/c \\\n  # we do not use store_dir because of dirrect carrierwave\\\n  def store_dir_origin'\n\ncat &gt;&gt; app/views/companies/show.html.erb &lt;&lt; 'HERE_DOC'\n&lt;%= direct_upload_form_for @uploader do |f| %&gt;\n  &lt;%= f.file_field :document %&gt;\n  &lt;%= f.submit %&gt;\n&lt;% end %&gt;\nHERE_DOC\n\nsed -i app/controllers/companies_controller.rb -e '/def show/a \\\n   # @uploader = @company.document # do not use old since key will remain\\\n   @uploader = DocumentUploader.new\\\n   # default key is /uploads/&lt;unique_guid&gt;/foo.png\\\n   # you can change, but use ONLY ONE folder ie \"1/2/a.txt\" -&gt; \"2/a.txt\"\\\n   # it always adds prefix \"uploads\" so it does not need to be written\\\n   @uploader.key = \"uploads/#{@company.id}-#{request.ip}/${filename}\"\\\n   @uploader.success_action_redirect = company_url(@company)\\\n   if params[:key]\\\n     @company.document.key = params[:key]\\\n     @company.save!\\\n     # we need to reload since old key is there\\\n     @company = Company.find(@company.id)\\\n     # or to redirect\\\n     redirect_to company_path(@company)\\\n   end\\\n   # you can call @company.remove_document! to remove from aws, but please\\\n   # reload after that with @company = Company.find(@company.id)'\n\nsed -i config/initializers/carrierwave.rb -e '/^end/i \\\n  # max_file_size is not originally on carrierwave, but is added on CWDirect\\\n  # if file is greater than allowed than error is from Amazon EntityTooLarge\\\n  config.max_file_size = 20.megabytes  # defaults to 5.megabytes'\n</code></pre></div></div>\n\n<h2 id=\"carrier-wave-in-seed\">Carrier wave in seed</h2>\n\n<p>You can open file and use it in seed <code class=\"highlighter-rouge\">user.image url =\nFile.open(File.join(Rails.root, 'public/my_image.png'))</code>. But if your storage is\n<code class=\"highlighter-rouge\">fox</code> than you can use <code class=\"highlighter-rouge\">user.remote_image_url_url =\n'http://www.gstatic.com/webp/gallery/1.jpg'</code>. Note that file will be downloaded\nand uploaded to your aws bucket so better is to set <code class=\"highlighter-rouge\">storage\nRails.env.development? ? :file : :fog</code> and use first file.open method so it does\nnot need to download file.</p>\n\n<h1 id=\"pdf\">PDF</h1>\n\n<h2 id=\"wicked-pdf\">Wicked PDF</h2>\n\n<p><a href=\"https://github.com/mileszs/wicked_pdf\">https://github.com/mileszs/wicked_pdf</a></p>\n\n<p>Generate pdf from html files.\nJust put in gemfile</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# pdf generation from html\ngem 'wicked_pdf'\ngem 'wkhtmltopdf-binary'\nHERE_DOC\n</code></pre></div></div>\n\n<p>And in your controller put the name of the downloaded file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class ThingsController &lt; ApplicationController\n  def show\n    respond_to do |format|\n      format.html\n      format.pdf do\n        render pdf: \"thing-#{params[:id]}\"   # Excluding \".pdf\" extension.\n      end\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>You can also set template to another file, layout to pdf and header</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>render template: 'periods/visits', pdf: \"visits-#{@period.end_date}\", layout: 'pdf', header: { right: '[page] of [topage]' }\n</code></pre></div></div>\n\n<p>Template</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/things/show.pdf.erb\n&lt;h1&gt;Hi&lt;/h1&gt;\n&lt;div class=\"alwaysbreak\"&gt;&lt;/div&gt;\n&lt;h1&gt;Second page&lt;/h1&gt;\n</code></pre></div></div>\n\n<p>Layout</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">&lt;</span><span class=\"err\">%#</span> <span class=\"na\">app</span><span class=\"err\">/</span><span class=\"na\">views</span><span class=\"err\">/</span><span class=\"na\">layouts</span><span class=\"err\">/</span><span class=\"na\">pdf</span><span class=\"err\">.</span><span class=\"na\">pdf</span><span class=\"err\">.</span><span class=\"na\">erb</span>\n<span class=\"err\">&lt;!</span><span class=\"na\">doctype</span> <span class=\"na\">html</span><span class=\"nt\">&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;meta</span> <span class=\"na\">charset=</span><span class=\"s\">'utf-8'</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">stylesheet_link_tag</span> <span class=\"na\">wicked_pdf_asset_base64</span><span class=\"err\">(\"</span><span class=\"na\">pdf</span><span class=\"err\">\")</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">id=</span><span class=\"s\">\"content\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;</span><span class=\"err\">%=</span> <span class=\"na\">yield</span> <span class=\"err\">%</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<p>Styles</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/stylesheets/pdf.scss\ntable, th, td {\n  border: 1px solid black;\n  border-collapse: collapse;\n  padding: 5px;\n  text-align: center;\n}\n* {\n  font-size: 12px;\n}\ndiv.alwaysbreak { page-break-before: always; }\n</code></pre></div></div>\n\n<p>Since we did not include this style in asset pipeline, we need to precompile it:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/assets.rb\nRails.application.config.assets.precompile += ['pdf.css']\n</code></pre></div></div>\n\n<p>If you want to use existing html template than use param <code class=\"highlighter-rouge\">render pdf: 'name',\ntemplate: 'show.html'</code> and create <code class=\"highlighter-rouge\">app/views/layouts/pdf.html.erb</code> and use\nhelper classes to show hide content:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.pdf-hidden {\n  display: none;\n}\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.html-hidden {\n  display: none;\n}\n</code></pre></div></div>\n\n<h2 id=\"prawn\">Prawn</h2>\n\n<ul>\n  <li>\n    <p>if you need custom symbols in prawn than you need to use ttf fonts. Not all\ncontains every symbol. I downloaded from\n<a href=\"http://dejavu-fonts.org/wiki/Download\">dejavu-fonts.org</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/pdfs/common_pdf.rb\nmodule CommonPdf\n  def h(amount)\n    ActionController::Base.helpers.humanized_money_with_symbol amount\n  end\n\n  def set_up_common_font\n    # http://dejavu-fonts.org/wiki/Download\n    font_families.update(\n      \"DejaVu Sans\" =&gt; {\n        normal: \"#{Rails.root}/lib/DejaVuSans.ttf\",\n        bold: \"#{Rails.root}/lib/DejaVuSans-Bold.ttf\",\n      }\n    )\n    font \"DejaVu Sans\"\n  end\nend\n\n# app/pdfs/my.pdf.rb\nclass MyPdf &lt; Prawn::Document\n  include CommonPdf\n  set_up_common_font\n  text h 10\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>when you need a image logo in pdf than you can use <code class=\"highlighter-rouge\">fit</code> option https://www.rubydoc.info/gems/prawn/0.12.0/Prawn/Images</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  require 'open-uri'\n  uri_escaped = URI.escape \"http:#{tax_holder.logo_url}\"\n  image open(uri_escaped), fit: [column_2_width, 89], position: :right\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h2 id=\"pdf-reader\">PDF reader</h2>\n\n<p>https://github.com/yob/pdf-reader</p>\n\n<h1 id=\"style-guide\">Style guide</h1>\n\n<p><a href=\"https://github.com/thoughtbot/guides/tree/master/best-practices\">toughtbot style\nguide</a></p>\n\n<ul>\n  <li>do not reference model class directly from a view (how to render counts than\n?)</li>\n  <li>do not use SQL outside of models</li>\n  <li>use <code class=\"highlighter-rouge\">touch: true</code> on <code class=\"highlighter-rouge\">belongs_to</code> associations</li>\n  <li>use <code class=\"highlighter-rouge\">ENV.fetch</code> instead of <code class=\"highlighter-rouge\">ENV[]</code> so it raises exception when env variable\ndoes not exists</li>\n</ul>\n\n<p>My style in rails models use following order:</p>\n\n<ol>\n  <li><code class=\"highlighter-rouge\">include</code> and <code class=\"highlighter-rouge\">extend</code> other modules, <code class=\"highlighter-rouge\">devise</code> or, <code class=\"highlighter-rouge\">serialize :col, Hash</code></li>\n  <li>constants <code class=\"highlighter-rouge\">FIELDS = %i[name]</code></li>\n  <li><code class=\"highlighter-rouge\">attr_accessor</code></li>\n  <li><code class=\"highlighter-rouge\">belongs_to :workflow</code> associations with plugins <code class=\"highlighter-rouge\">acts_as_list scope:\n1  [:workflow_id]</code></li>\n  <li><code class=\"highlighter-rouge\">has_many :users</code> associations</li>\n  <li>enums <code class=\"highlighter-rouge\">enum status: %i[draft accepted]</code></li>\n  <li>validations <code class=\"highlighter-rouge\">validates :name, presence: true</code></li>\n  <li>validate declarations <code class=\"highlighter-rouge\">validate :_check_nested_resource</code></li>\n  <li>callbacks declarations <code class=\"highlighter-rouge\">before_validation :_default_values_on_create, on: :create</code></li>\n  <li>scopes <code class=\"highlighter-rouge\">scope :by_status_param, -&gt;(status_argument) { where status: status_argument }</code></li>\n  <li>class methods <code class=\"highlighter-rouge\">def self.find_first_unpublished</code></li>\n  <li>instance methods <code class=\"highlighter-rouge\">def full_name</code></li>\n  <li>validate definitions <code class=\"highlighter-rouge\">def _check_nested_resource</code></li>\n  <li>callbacks definitions <code class=\"highlighter-rouge\">def _default_values_on_create</code></li>\n</ol>\n\n<h1 id=\"geocoder\">Geocoder</h1>\n\n<p>If you need to search with association, for example <a href=\"https://stackoverflow.com/questions/14188568/using-geocoder-on-a-child-association-how-to-find-all-parents-in-a-given-locati\">User has many\nlocations</a>\nyou can with joins to geocoded model on which <code class=\"highlighter-rouge\">near</code> is defined.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>near = Location.near('Paris, France')\nusers = User.joins(:locations).merge(near)\n</code></pre></div></div>\n\n<p>also if you need to get associated objects you can (location has many views)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>near = Location.near([latitude, longitude], MAX_USER_DISTANCE_MILES)\nviews.\n  joins(:location).\n  select(\"views.*\"). # somehow we need this so we got views, instead of users\n  merge(near).\n  includes(:sport). # so we can get sport.name without N+1\n  where(sport: sport) # conditional on view\n</code></pre></div></div>\n\n<h1 id=\"authorization-policy\">Authorization policy</h1>\n\n<h2 id=\"cancan\">Cancan</h2>\n\n<p>use cancancan and define all your actions in app/models/ability. If you want to\nuse\n<a href=\"https://github.com/ryanb/cancan/wiki/authorizing-controller-actions#load_resource\">load_resource</a>,\nyou should separately define: index (with hash), show/edit/update/destroy (with\nblock or hash), new/create (with hash). For nested resources just write parent\nassociation</p>\n\n<p>Note that following next <code class=\"highlighter-rouge\">cannot</code> rule will override a previous <code class=\"highlighter-rouge\">can</code> rule, so\nit is enough to set <code class=\"highlighter-rouge\">can :manage, :all</code> and than write what <code class=\"highlighter-rouge\">cannot :destroy,\nProject</code></p>\n\n<h2 id=\"pundig\">Pundig</h2>\n\n<p>https://github.com/varvet/pundit</p>\n\n<h2 id=\"other-authorization\">Other authorization</h2>\n\n<ul>\n  <li>https://github.com/palkan/action_policy</li>\n</ul>\n\n<h1 id=\"autoloading\">Autoloading</h1>\n\n<p><a href=\"https://www.bigbinary.com/videos/learn-ruby-on-rails/how-autoloading-works-in-rails\">https://www.bigbinary.com/videos/learn-ruby-on-rails/how-autoloading-works-in-rails</a>\nIn development rails uses Constant Missing hooks to auto load new files from\n<code class=\"highlighter-rouge\">app/controllers helpers mailers and models</code>\nIf you need to load files from lib, you can <code class=\"highlighter-rouge\">config.autoload_paths +=\n%W(#{config.root}/lib)</code>. Rails look for file name that is snake case of constant\nname, for example <code class=\"highlighter-rouge\">SeniorDeveloper</code> should be defined in <code class=\"highlighter-rouge\">senior_developer.rb</code>.\nYou can <code class=\"highlighter-rouge\">require_dependency 'not_conventional_file_name'</code></p>\n\n<p>There is ruby <code class=\"highlighter-rouge\">autoload :Jeep, 'Jeep'</code> which is usefull since it will not\n<code class=\"highlighter-rouge\">require 'jeep'</code> if <code class=\"highlighter-rouge\">Jeep</code> is not used. If we use <code class=\"highlighter-rouge\">Jeep</code> in a file, than it will\nrequired.</p>\n\n<h1 id=\"action-cable\">Action Cable</h1>\n\n<p>https://www.sitepoint.com/create-a-chat-app-with-rails-5-actioncable-and-devise/\nexample\nhttps://github.com/duleorlovic/premesti.se/commit/ad7cefe192cbbb6b97c13860eb6410d1b02cb5fc</p>\n\n<p>Consumer is a client of a web socket connection that can subscribe to one or\nmultiple channels. Each ActionCable server may handle multuple connections (it\nis created per browser tab).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g channel chat\n# app/assets/javascripts/channels/chat.coffee\n# app/channels/chat_channel.rb\n</code></pre></div></div>\n\n<p>You can broadcast with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActionCable.server.broadcast(\"chat:#{chat.id}\", data: data)\nChatChannel.broadcast_to chat, data: data\n</code></pre></div></div>\n\n<p>or in javascript</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>App.chat = App.cable.subscriptions.create 'ChatChannel'\nApp.chat.send({data: data})\n</code></pre></div></div>\n\n<p>You can call server method with <code class=\"highlighter-rouge\">@perform 'away', my_id:\n$('main').data('my-id')</code></p>\n\n<p>You can not use devise <code class=\"highlighter-rouge\">current_user</code> when rendering for actioncable, there will\nbe an error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActionView::Template::Error (Devise could not find the `Warden::Proxy` instance on your request environment.\nMake sure that your application is loading Devise and Warden as expected and that the `Warden::Manager` middleware is present in your middleware stack.\nIf you are seeing this on one of your tests, ensure that your tests are either executing the Rails middleware stack or that your tests are using the `Devise::Test::ControllerHelpers` module to inject the `request.env['warden']` object for you.):\n</code></pre></div></div>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>I got an error <code class=\"highlighter-rouge\">ActionDispatch::Cookies::CookieOverflow\n(ActionDispatch::Cookies::CookieOverflow):</code> when there is <code class=\"highlighter-rouge\">flash[:notice]</code>\nthat is greater than certain value for example: <code class=\"highlighter-rouge\">flash.now[:notice] =\n'1'*1972</code>, <code class=\"highlighter-rouge\">flash.now[:alert] = '1'*1_974</code> and <code class=\"highlighter-rouge\">flash[:notice] = '1'*1980</code>,\n<code class=\"highlighter-rouge\">flash[:alert] = '1'*1981</code></li>\n  <li>There is a new line in <code class=\"highlighter-rouge\">Base64.encode64 string</code> so use <code class=\"highlighter-rouge\">Base64.strict_encode64\nstring</code> https://stackoverflow.com/questions/2620975/strange-n-in-base64-encoded-string-in-ruby</li>\n  <li>\n    <p>parse url to get where user come from <code class=\"highlighter-rouge\">URI.parse(request.referrer).host</code> or\njust <code class=\"highlighter-rouge\">URI(request.referrer).host</code>. You can parse uri query with CGI (values\nare arrays) and Rack utils parse query (values are strings)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>(byebug) CGI::parse uri.query\n{\"dst\"=&gt;[\"http://www.trk.in.rs/?a=1\"]}\n(byebug) Rack::Utils.parse_query uri.query\n{\"dst\"=&gt;\"http://www.trk.in.rs/?a=1\"}\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">spring stop</code> in many cases:\n    <ul>\n      <li>when you export some ENV and use them in <code class=\"highlighter-rouge\">config/secrets.yml</code> but can’t see\nin <code class=\"highlighter-rouge\">rails c</code></li>\n      <li>when you put <code class=\"highlighter-rouge\">byebug</code> in some of the gem source</li>\n    </ul>\n  </li>\n  <li>load databe from <code class=\"highlighter-rouge\">db/schema.rb</code> (instead of <code class=\"highlighter-rouge\">rake db:migrate</code>) is with <code class=\"highlighter-rouge\">rake\ndb:schema:load</code>.</li>\n  <li>run at port 80 <code class=\"highlighter-rouge\">sudo service apache2 stop</code> and <code class=\"highlighter-rouge\">rvmsudo rails s -p 80</code>. Note\nthat db user will to <em>root</em> instead of <em>orlovic</em> so you need to hardcode it in\n<em>config/database.yml</em>. Rember to <code class=\"highlighter-rouge\">-b 0.0.0.0</code> if you access from outside.\nYou can make default option to bind on localhost 0.0.0.0\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/boot.rb\n# Set up gems listed in the Gemfile.\nENV['BUNDLE_GEMFILE'] ||= File.expand_path('../../Gemfile', __FILE__)\n\nrequire 'bundler/setup' if File.exists?(ENV['BUNDLE_GEMFILE'])\n\n# https://fullstacknotes.com/make-rails-4-2-listen-to-all-interface/\nrequire 'rubygems'\nrequire 'rails/commands/server'\n\nmodule Rails\n  class Server\n    alias :default_options_bk :default_options\n    def default_options\n      default_options_bk.merge!(Host: '0.0.0.0')\n    end\n  end\nend\n</code></pre></div>    </div>\n    <p>When you are using <code class=\"highlighter-rouge\">local.trk.in.rs</code> you can set local ip <em>192.168.0.4</em> as\nRedirection (301 or 302) (but not as Forwarding since that does not work for\nsome api requests from android).</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">Rails.logger</code> is stdout and every controller, model and view has <code class=\"highlighter-rouge\">logger</code>\nmethod which you can use like <code class=\"highlighter-rouge\">logger.debug my_var</code></li>\n  <li>if you want to join some fields with <code class=\"highlighter-rouge\">,</code> but do not know if they all exists,\nyou can <code class=\"highlighter-rouge\">[phone1, phone2].keep_if(&amp;:present?).join(', ')</code></li>\n  <li>use include for n+1 query (bullet) and joins when you don’t need associated\nmodels. Both are using INNER JOIN\n    <ul>\n      <li><code class=\"highlighter-rouge\">Comment.all(include: :user, conditions: { users: { admin: true}})</code> will\nload also the user model</li>\n    </ul>\n  </li>\n  <li><a href=\"http://guides.rubyonrails.org/active_record_querying.html#eager-loading-associations\">N+1</a>\nproblem is solved with <code class=\"highlighter-rouge\">includes(:associated_table)</code> wich is actually LEFT\nOUTER JOINS, <code class=\"highlighter-rouge\">joins(:associated_table)</code> is INNER JOIN and do not load the\nmodels. Works also for nested joins <code class=\"highlighter-rouge\">includes(jobs: :user)</code> or for multuple\nyou can use array <code class=\"highlighter-rouge\">includes(jobs: [:user, :company])</code>.\n    <ul>\n      <li>Inner <code class=\"highlighter-rouge\">joins</code> differs if you have has_many or belongs_to association. For\n<code class=\"highlighter-rouge\">has_many :associated_table</code> <code class=\"highlighter-rouge\">joins</code> will return multiple values\nbecause of multi values of :associated_table per item, or none is\n:associated_table does not exists for current item. For <code class=\"highlighter-rouge\">belongs_to :a</code> it\nwill return single if data exists, or nothing will be returned, if belongs_to\nis empty, so better is to use left join. (expecially when you search by\ndescription OR teacher name, you should not exclude books without teacher)</li>\n      <li>custom joins if you want to use left inner join\nhttps://thoughtbot.com/upcase/videos/advanced-querying-custom-joins\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Person.joins(&lt;&lt;-SQL).\n  LEFT JOIN people managers\n    ON managers.id = people.manager_id\nSQL\nwhere(managers: { id: Person.find_by!(name: 'Eve') })\n</code></pre></div>        </div>\n        <p>custom left joins are better than includes because you are explicit about\njoining and you do not eager load (do not create AR objects) if not need.\nIn Rails 5 there is a method <code class=\"highlighter-rouge\">left_outer_joins</code>\nhttps://edgeguides.rubyonrails.org/active_record_querying.html#left-outer-joins\nwhen you want to perform custom sql you can use</p>\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>task.projects\n    .select('projects.*')\n     .select(&lt;&lt;-SQL)\n       activities.name AS last_task_activity_name,\n       tasks.updated_at AS last_task_updated_at\n     SQL\n     .joins(&lt;&lt;-SQL)\n       INNER JOIN tasks ON tasks.project_id = projects.id\n       INNER JOIN activities\n       INNER JOIN (\n         SELECT project_id, MAX(id) as max_id\n         FROM tasks\n         GROUP BY project_id\n       ) last_task\n       ON last_task.project_id = projects.id AND\n         last_task.max_id = tasks.id AND\n         tasks.activity_id = activities.id\n     SQL\n</code></pre></div>        </div>\n      </li>\n      <li><code class=\"highlighter-rouge\">includes</code> will return the same number of items, with association object\nloaded in memory. eager load <code class=\"highlighter-rouge\">includes</code> can be defined in association\ndefinition <code class=\"highlighter-rouge\">has_many :comments, -&gt; { includes :author }</code> but this is bad since\nit will <strong>always</strong> load two tables.  Better is to make a query\n<code class=\"highlighter-rouge\">Post.includes(:comments).all</code> or for instance\n<code class=\"highlighter-rouge\">@post.comments.includes(:author)</code>. You need to eager load before calling\n<code class=\"highlighter-rouge\">.all</code> or <code class=\"highlighter-rouge\">.each</code>. Do not need eager load belongs_to association.\nYou can use procs to further filter relations. Note that in case of\n<code class=\"highlighter-rouge\">Customer.joins(:radaccts)</code> customer argument is not a Customer but a relation\nso this filter only works for <code class=\"highlighter-rouge\">customer.radaccts</code>\n        <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>has_many   :radaccts, -&gt; (customer)  { where('radacct.location_id = ?', customer.location_id) if customer.class == Customer }, primary_key: :username, foreign_key: :username, inverse_of: :customer\n</code></pre></div>        </div>\n      </li>\n    </ul>\n  </li>\n</ul>\n\n<p>In rails belongs_to foreign_key https://guides.rubyonrails.org/v5.2/association_basics.html#options-for-belongs-to-foreign-key\nis used is you have different name of the column than name_of_association_id</p>\n\n<p>You can specify conditions in relation</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Company &lt; ApplicationRecord\n  has_many :company_users, dependent: :destroy\n  # has_many :users, through: :company_users # do not use this since company\n  # users can be disabled, so better is to use active_users\n  has_many :active_users, -&gt; { where(company_users: { status: :active }) },\n           through: :company_users, source: :user\n</code></pre></div></div>\n<ul>\n  <li>If you want to filter with raw SQL like: <code class=\"highlighter-rouge\">.where('jobs.title ILIKE \"%duke%\"')</code>\nyou need to <code class=\"highlighter-rouge\">reference</code> them (see below) or use join (filtering using hash works\nwithout referencing since rails knows which table to look <code class=\"highlighter-rouge\">.where(jobs: { title:\n}, user: company.users)</code>). Along with\n<a href=\"http://apidock.com/rails/ActiveRecord/QueryMethods/includes\">includes</a>\n<code class=\"highlighter-rouge\">includes(user: :user_profile).where(\"user_profiles.name = 'dule'\")</code>\nyou need to explicitly reference them <code class=\"highlighter-rouge\">includes(user:\n:user_profile).where(\"user_profiles.name = 'dule'\").references(user:\n:user_profile)</code></li>\n  <li>note that you should not use <code class=\"highlighter-rouge\">joins</code> and <code class=\"highlighter-rouge\">includes</code> in the same time, for the\nsame columns (you can use it for different columns). Joins\ncould be replaced with <code class=\"highlighter-rouge\">references</code>. But I have some problems with <code class=\"highlighter-rouge\">references</code>\nsince it remove my custom selected data, so instead <code class=\"highlighter-rouge\">references</code> I use\n<code class=\"highlighter-rouge\">joins('LEFT OUTER JOIN sports ON sports.id = users.sport_id')</code> and <code class=\"highlighter-rouge\">distinct</code>.\nDistinct is needed to remove duplicated since inner join with has_many relation\n(also habtm) returns multiple results (single is only for belongs_to relation).\nHere is example of how includes/references do not let me use counts as\ncalculated columns, but joins let works fine (even .to_sql is similar)\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>all = Model\n.select(%(\n  users.id,\n  COUNT(projects.id) as projects_count\n))\n.includes(:projects)\n.references(:projects)\nall.last.projects_count # does not work\nall = Model\n.select(%(\n  users.id,\n  COUNT(projects.id) as projects_count\n))\n.joins(%(\n  LEFT JOIN projects ON user_id = users.id\n))\n\n# do not use .joins(:projects) since it will inner join, ie you will get rows\n# for each user and each project.\n# It is fine if it is belongs_to relation (only one corresponding project)\nall.last.projects_count # here it works\n</code></pre></div>    </div>\n    <p>Rails 5 has method\n<a href=\"http://edgeguides.rubyonrails.org/active_record_querying.html#left-outer-joins\">left_outer_joins</a></p>\n  </li>\n  <li>\n    <p>when you need to eager load for a single object (show action) than you can\nsimply repeat rails default before action <code class=\"highlighter-rouge\">set_post</code> with: <code class=\"highlighter-rouge\">@post =\nPost.includes(:comments).find params[:id]</code></p>\n  </li>\n  <li><code class=\"highlighter-rouge\">some_2d_array.each_with_index do |(col1, col2),index|</code> when you need\n<a href=\"http://docs.ruby-lang.org/en/2.1.0/syntax/assignment_rdoc.html#label-Array+Decomposition\">decomposition\narray</a>\nto some variables, you can use parenthesis.</li>\n  <li>long output of a command (for example segmentation fault) can be catched with\n<code class=\"highlighter-rouge\">rails s 2&gt;&amp;1 | less -R</code></li>\n  <li>\n    <p>use different layout and template based on different params is easy using\nlocales <a href=\"/2016/10/28/adminlte-free-template-on-rails/\">look for adminlte example</a></p>\n  </li>\n  <li>title and meta tags for the template can be added using helper functions</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/helpers/page_helper.rb\nmodule PagesHelper\n  def login_layout(login_title = nil)\n    @login_title = login_title\n    @login_layout = true\n  end\n\n  def login_layout?\n    @login_layout\n  end\n\n  def login_title\n    @login_title\n  end\n\n  def title(name)\n    @title = name\n  end\n\n  def fetch_title\n    @title || fetch_breadcrumb_list.keys.last\n  end\n\n  def page_description(description)\n    content_for(:page_description) { description.html_safe }\n  end\n\n  def breadcrumb(list)\n    @breadcrumb = list\n  end\n\n  def fetch_breadcrumb_list\n    @breadcrumb || {}\n  end\nend\n\n# app/views/layouts/_breadcrumb.html.erb\n&lt;nav aria-label=\"breadcrumb\"&gt;\n  &lt;ol class=\"breadcrumb\"&gt;\n    &lt;% if fetch_breadcrumb_list.blank? %&gt;\n      &lt;li class='breadcrumb-item active' aria-current='page'&gt;\n        &lt;i class=\"fa fa-dashboard\"&gt;&lt;/i&gt;\n        &lt;%= t('dashboard') %&gt;\n      &lt;/li&gt;\n    &lt;% else %&gt;\n      &lt;li class='breadcrumb-item'&gt;\n        &lt;%= link_to dashboard_path do %&gt;\n          &lt;i class=\"fa fa-dashboard\"&gt;&lt;/i&gt;\n          &lt;%= t('dashboard') %&gt;\n        &lt;% end %&gt;\n      &lt;/li&gt;\n    &lt;% end %&gt;\n    &lt;% fetch_breadcrumb_list.each_with_index do |(text, link), i| %&gt;\n      &lt;% last_item = i == fetch_breadcrumb_list.length - 1 %&gt;\n      &lt;li class=\"breadcrumb-item &lt;%= 'active' if last_item %&gt;\" &lt;%= 'aria-current=\"page\"' if last_item %&gt;&gt;\n        &lt;% if link.present? %&gt;\n          &lt;%= link_to link do %&gt;\n            &lt;%= text %&gt;\n          &lt;% end %&gt;\n        &lt;% else %&gt;\n          &lt;%= text %&gt;\n        &lt;% end %&gt;\n      &lt;/li&gt;\n    &lt;% end %&gt;\n  &lt;/ol&gt;\n&lt;/nav&gt;\n\n# app/views/customers/index.html\n&lt;%\n  page_title \"Customers List\"\n  case params[:non_table_filter]\n  when \"registered_today\"\n    page_description \"Registered Today\"\n  when \"registered_this_month\"\n    page_description \"Registered This Month\"\n  when \"renewed_in_advance\"\n    page_description \"Renewed In Advance\"\n  end\n  breadcrumb \"Customers\": nil\n%&gt;\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>to change class <strong>fields_with_error</strong> you can override\nActionView::Base.field_error_proc in any controller</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActionView::Base.field_error_proc = Proc.new { |html_tag, instance|\n  #html = %(&lt;div class=\"field_with_errors\"&gt;#{html_tag}&lt;/div&gt;).html_safe\n  # add nokogiri gem to Gemfile\n  elements = Nokogiri::HTML::DocumentFragment.parse(html_tag).css \"label, input\"\n  elements.each do |e|\n    if e.node_name.eql? 'input'\n      e['class'] ||= ''\n      e['class'] = e['class'] &lt;&lt; \" error\"\n      html_tag = \"#{e}\".html_safe\n    end\n  end\n  html_tag\n}\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>for clone with associations you can use dup or clone but easiest way to with\nnew (build is deprecated) json except. If you use method <code class=\"highlighter-rouge\">as_json.exept \"id\"</code>\nthan pass string arguments (or splat array <code class=\"highlighter-rouge\">(*%(id))</code>), if it is param\n<code class=\"highlighter-rouge\">as_json except: [:id]</code> than you can use symbols. Please note that <code class=\"highlighter-rouge\">as_json</code>\nreturns hash with string keys so if you merge something you should use string\n<code class=\"highlighter-rouge\">chat.as_json(except: [:id]).merge(\"sport_id\" =&gt; view.sport.id)</code>. <code class=\"highlighter-rouge\">to_json</code>\nreturns string, so <code class=\"highlighter-rouge\">as_json</code> it much better.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># http://stackoverflow.com/questions/5976684/cloning-a-record-in-rails-is-it-possible-to-clone-associations-and-deep-copy\ndef clone_with_associations\n  # except bookmarks since we do not need them\n  # copy all fields and belongs_to associations\n  new_job = self.user.jobs.new self.as_json except: * %(id created_at first_published_at)\n  new_job.job_title = \"(Copy) \" + new_job.job_title\n  # if status is active put paused\n  new_job.status = :paused if new_job.active?\n  # copy location, ie create new one\n  if self.location\n    new_job.location_name = self.location.address\n  end\n  # cloning images\n  # todo with fog\n  # cloning questions with answers\n  self.questions.each do |question|\n    new_question = new_job.questions.new question.as_json except: * %(id created_at)\n    question.answers.each do |answer|\n      new_answer = new_question.answers.new answer.as_json except: * %(id created_at)\n    end\n  end\n  new_job\nend\n\n# job is not saved so you need to call\n# new_job = @job.clone_with_associations\n# new_job.save!\n</code></pre></div>    </div>\n  </li>\n  <li>if you put <code class=\"highlighter-rouge\">byebug</code> inside <code class=\"highlighter-rouge\">User.first_or_initialize</code> than you will see empty\nfor <code class=\"highlighter-rouge\">User.all</code>. Notice that if you use\n<code class=\"highlighter-rouge\">User.where(params.slice(:mobile)).first_or_initialize</code> than it is a problem\nwhen <code class=\"highlighter-rouge\">params[:mobile]</code> does not exists, and first User fill be used (not new\nuser)</li>\n  <li>\n    <p>for <code class=\"highlighter-rouge\">gon</code> gem you should <code class=\"highlighter-rouge\">include_gon</code> before other javascript files. Note\nthat <code class=\"highlighter-rouge\">if gon</code> will still raise error if <code class=\"highlighter-rouge\">gon</code> is not called in controller (so\n<code class=\"highlighter-rouge\">gon</code> is undefined)</p>\n  </li>\n  <li>access helpers outside of a view\n    <ul>\n      <li>if it is standard base helper, than just call it from ActionController,\nActionView instance or Rails application routes.</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActionController::Base.helpers.pluralize(count, 'mystring')\nActionController::Base.helpers.strip_tags request.body # html to text\nActionController::Base.helpers.link_to 'name', link\nActionController::Base.helpers.j \"can't be blank\" # can\\'t be blank\n\nActionView::Base.new.number_to_human 123123\n\nRails.application.routes.url_helpers.jobs_path\n\nERB::Util.html_escape t('errors.messages.blank') # can&amp;#39;t be blank\n</code></pre></div>    </div>\n\n    <ul>\n      <li>if it your custom helper you can call from <em>ApplicationController</em></li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ApplicationController.helpers.my_custom_helper\n</code></pre></div>    </div>\n\n    <p>If you want to use it inside controller or any other class you can include</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>include MyHelper\n</code></pre></div>    </div>\n\n    <p>But best options in controllers in Rails 5 is to use <code class=\"highlighter-rouge\">helpers</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class MyController &lt; ApplicationController\n  def index\n    alert helpers.titleize_message\n  end\nend\n</code></pre></div>    </div>\n\n    <ul>\n      <li>you can include all</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>include ActionView::Helpers::TextHelper\ninclude Rails.application.routes.url_helpers\n</code></pre></div>    </div>\n\n    <ul>\n      <li>or you can delegate it</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  delegate :url_helpers, to: 'Rails.application.routes'\n  # call with `url_helpers.jobs_url` in you class\n  delegate :form_tag, :text_field_tag, to: 'ActionController::Base.helpers'\n</code></pre></div>    </div>\n  </li>\n  <li>do not use <code class=\"highlighter-rouge\">form_tag path</code> without block, since chrome will autoclose tags,\nbut IE10 wont.</li>\n  <li>do not name your model with <code class=\"highlighter-rouge\">Template</code> since there is module <code class=\"highlighter-rouge\">Template</code>\nsomewhere.</li>\n  <li>request object contains a lot of data:\n    <ul>\n      <li><code class=\"highlighter-rouge\">request.xhr?</code> is it ajax</li>\n      <li><code class=\"highlighter-rouge\">request.ip</code> <code class=\"highlighter-rouge\">request.referrer</code> <code class=\"highlighter-rouge\">request.remote_ip</code></li>\n      <li><code class=\"highlighter-rouge\">request.env[\"HTTP_USER_AGENT\"]</code></li>\n    </ul>\n  </li>\n  <li>\n    <p>if you want to add flash_alert for all <code class=\"highlighter-rouge\">flash.now[:alert]='message'</code> you can\nuse</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\nafter_action :check_flash_message\n\n# rubocop:disable Metrics/AbcSize\ndef check_flash_message\n  return unless request.xhr? &amp;&amp; request.format.js?\n  response.body += \"flash_alert('#{view_context.j flash.now[:alert]}');\" if flash.now[:alert].present?\n  response.body += \"flash_notice('#{view_context.j flash.now[:notice]}');\" if flash.now[:notice].present?\nend\n# rubocop:enable Metrics/AbcSize\n</code></pre></div>    </div>\n  </li>\n  <li>Heroku problems:</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">undefined method url_options' for #&lt;Module:</code> maybe problem with\n<a href=\"https://gist.github.com/IAMRYO/e8bee5a8e6710ad4b970\">puma</a></p>\n  </li>\n  <li>rails router\n    <ul>\n      <li>you can mount namespace under different path</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>namespace :admin, path: 'aadmin' do\n  get '/', to: 'admin#index'\nend\n</code></pre></div>    </div>\n\n    <ul>\n      <li>\n        <p>you can get dynamic path resoulution with <code class=\"highlighter-rouge\">link_to \"Dynamic #{e}\",\ncontroller: :pages, action: e, id: @user.id</code></p>\n      </li>\n      <li>\n        <p>you can catch all error using routes https://coderwall.com/p/w3ghqq/rails-3-2-error-handling-with-exceptions_app We can rescue in application controller\nbut not for <code class=\"highlighter-rouge\">ActionController::RoutingError</code> since that is done before rails\nso you need to use <code class=\"highlighter-rouge\">config.exceptions_app</code>, for example:</p>\n      </li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\n  rescue_from ActiveRecord::RecordNotFound, ActionController::UnknownController, ::AbstractController::ActionNotFound, ActionController::RoutingError do |exception|\n    redirect_to error_path title: 'Record Not Found', description: 'Could not find resource: ' + request.url\n  end\n\n# config/application.rb\nclass Application &lt; Rails::Application\n  config.exceptions_app = self.routes\nend\n\n# config/routes.rb\nMyApp::Application.routes.draw do\n  get 'error', controller: 'home'\n  get '/404', controller: 'home', action: 'routing_error'\n  get '/500', controller: 'home', action: 'internal_server_error'\nend\n\n# app/controllers/home_controller.rb\nclass HomeController &lt; ApplicationController\n  def error\n    @title = params[:title]\n    @description = params[:description]\n    render :error, formats: [:html]\n  end\n\n  def routing_error\n    @title = 'Page Not Found'\n    @description = 'Cound not find this page'\n    render :error, formats: [:html]\n  end\n\n  def internal_server_error\n    @title = 'Internal Server Error'\n    @description = 'There was an error and administrators were notified'\n    render :error, formats: [:html]\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>export csv</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/user.rb\ndef self.to_csv\n  CSV.generate do |csv|\n    csv &lt;&lt; %w(Name Email Sports)\n    all.each do |user|\n      csv &lt;&lt; [user.name, user.email, user.sports.map(&amp;:name).join(', ')]\n    end\n  end\nend\n\n# app/controllers/users_controller.rb\n  respond_to do |format|\n    format.html\n    format.csv { send_data @users.to_csv, filename: 'users.csv', type:\n    'text/csv', disposition: 'inline' }\n  end\n\n# app/views/index.html.erb\n&lt;%= link_to \"Export csv\", users_path(sport: params[:sport], format: :csv) %&gt;\n</code></pre></div>    </div>\n  </li>\n  <li><a href=\"https://github.com/swanandp/acts_as_list\">acts_as_lists</a> is nice gem, you\njust need to <code class=\"highlighter-rouge\">rails g migration add_priority_to_comment priority:integer</code>,\nadd a line in model\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>acts_as_list scope: :post, column: :priority\ndefault_scope { order('position ASC') }\n</code></pre></div>    </div>\n    <p>use that priority in associations <code class=\"highlighter-rouge\">has_many :comments, -&gt; { order priority:\n:asc }, dependent: :destroy</code>\nPosition is starting from 1, 2…\nTo perform bulk update, use form to pass ids</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def sort\n  @job.questions.each do |question|\n    # check if this question is in params, since there could be several request of sorting when we save them all\n    if params['question'].include? question.id.to_s\n      question.position = params['question'].index(question.id.to_s) + 1\n      question.save!\n    end\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p><code class=\"highlighter-rouge\">enum status: [:paused]</code> should be type integer, or it will return nil. Use\nsynonim for new, like unproccessed, draft. You can access values with symbols\n<code class=\"highlighter-rouge\">:draft</code> and outside of class with <code class=\"highlighter-rouge\">Class.statuses</code>.</p>\n  </li>\n  <li>\n    <p>params usually need to be striped, so you can use this code to get rid of all\nunnecessary spaces (not that we create new object that is returned, params\nstays unschanged)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>params_contact_striped = params[:contact].each_with_object({}) { |(k,v),o| o[k] = v.split.join(\" \") } # strip spaces\n</code></pre></div>    </div>\n\n    <p>or you can do in before save callback</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/contact.rb\n  before_save :strip_fields\n\n  def strip_fields\n    self.email.strip! if email.present?\n    self.first_name.strip! if first_name.present?\n  end\n</code></pre></div>    </div>\n\n    <p>also if you want to replace ‘\\n’ new lines in text area (<code class=\"highlighter-rouge\">f.text_area</code>) with\n<br /> so it looks the same when displaying it (alternativelly you can use <code class=\"highlighter-rouge\">&lt;%=\nsimple_format @contact.text %&gt;</code>).  Example is with nested associated elements:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>params[:contact] = params[:contact].each_with_object({}) { |(k,v),o| o[k] = v.each_with_object({}) { |(k1,v1),o1| o1[k1] = (v1.class == String ? v1.gsub(/\\n/,'&lt;br&gt;'): v1) } }\n</code></pre></div>    </div>\n\n    <p>If you want to strip params globaly (for every non get request) you can use:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>before_action :strip_params\ndef strip_params\n  return if request.get?\n  params\n    .values\n    .select {|v| [ActionController::Parameters, ActiveSupport::HashWithIndifferentAccess].include? v.class }\n    .each do |item_parameters|\n      item_parameters.each do |k,v|\n        next unless v.class == String\n        item_parameters[k] = v.split.join(' ')\n      end\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>if you notice in logs double requests (messages are double rendered) it is\nprobably that you use <code class=\"highlighter-rouge\">gem 'rails_12factor'</code> which should be only on\nproduction <code class=\"highlighter-rouge\">group: :production</code></li>\n  <li>\n    <p>when we use CDN for assets, in root folder it should contain crossdomain.xml\nfile so flash recorder works nice.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"cp\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"c\">&lt;!-- http://www.osmf.org/crossdomain.xml --&gt;</span>\n<span class=\"cp\">&lt;!DOCTYPE cross-domain-policy SYSTEM \"http://www.adobe.com/xml/dtds/cross-domain-policy.dtd\"&gt;</span>\n<span class=\"nt\">&lt;cross-domain-policy&gt;</span>\n    <span class=\"nt\">&lt;allow-access-from</span> <span class=\"na\">domain=</span><span class=\"s\">\"*\"</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;site-control</span> <span class=\"na\">permitted-cross-domain-policies=</span><span class=\"s\">\"all\"</span><span class=\"nt\">/&gt;</span>\n<span class=\"nt\">&lt;/cross-domain-policy&gt;</span>\n</code></pre></div>    </div>\n  </li>\n  <li>very nasty issue is when your before action returns\nfalse <a href=\"http://guides.rubyonrails.org/active_record_callbacks.html#halting-execution\">halting\nexecution</a>\nso check if return value could be <code class=\"highlighter-rouge\">false</code> and make sure before filters (like\nbefore_create) always return not false value (you can return <code class=\"highlighter-rouge\">true</code> or <code class=\"highlighter-rouge\">nil</code>).\nI noticed that if you raise validation exception in <code class=\"highlighter-rouge\">before_</code> callbacks than\nexception will be ignored, but <code class=\"highlighter-rouge\">before_</code> block will return false</li>\n  <li>callbacks are defined executed in the order they are defined, or you can use\n<code class=\"highlighter-rouge\">:prepend</code> option</li>\n  <li>in callbacks should only be some value format correction or other simple task.\nIn callback should not be Mailer to send email or other external task since it\nwill be triggered even in you test when you prepare some data, or when creating\nseed data</li>\n  <li>in action pack (action controller) if you <code class=\"highlighter-rouge\">render</code> something in before_filter\nthan execution will be halted (return value is not important for\nActionController callbacks)</li>\n  <li>subclasses can use <code class=\"highlighter-rouge\">skip_callback</code> if you want to skip callback</li>\n  <li>\n    <p>do not use callbacks, expecially after_callbacks since it ties with save, for\nexample, you should be able to repeat some actions (sending email, charging)\nwithout saving. Use delegator instead</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class FacebookNotifyComment &lt; SimpleDelegator\n  def initialize(comment)\n    super(comment)\n  end\n\n  def save\n    if __getobj__save\n      post_to_wall\n    end\n  end\n\n  private\n\n  def post_to_wall\n    Facebook.post(title: title)\n  end\nend\n\nclass CommentsController &lt; ApplicationController\n  def create\n    @comment = FacebookNotifyComment.new(Comment.new(comments_params))\n    if @comment.save\n      redirect_to blog_path, notice: \"Comment was posted'\n    else\n     render 'new'\n    end\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>to start new project from specific rails, run <code class=\"highlighter-rouge\">rails _4.2.7.1_ new myapp</code> .\n<code class=\"highlighter-rouge\">gem list | grep rails</code> can show you installed versions</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">\"data-disable-with\": \"&lt;i class='fa fa-spinner fa-spin'&gt;&lt;/i&gt; #{name}\"</code> works\non any element except <code class=\"highlighter-rouge\">f.submit</code> since it is <code class=\"highlighter-rouge\">input</code> element and you will see\n<code class=\"highlighter-rouge\">&lt;i&gt;</code> tags… better is to use <code class=\"highlighter-rouge\">f.button</code> but than you lose <code class=\"highlighter-rouge\">params[:commit]</code>\nwhich is included in <code class=\"highlighter-rouge\">f.submit</code>. So solution is to include <code class=\"highlighter-rouge\">hidden_field_tag\n:commit, \"Some label\"</code></p>\n  </li>\n  <li>when you call render partial with current object than first param is string\n(not hash <code class=\"highlighter-rouge\">partial: </code>) <code class=\"highlighter-rouge\">&lt;%= render 'layouts/audit_log', current_object: @user\n%&gt;</code></li>\n  <li>\n    <p>you can use config inside your initializers so you do not need to write\n<code class=\"highlighter-rouge\">Rails.application.</code> again, but does not work for <code class=\"highlighter-rouge\">cache_store</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/dalli.rb\nRails.application.configure do\n  secrets.internal_notification_email\n  config.,,,\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>for complex forms, it is advised to be able to easily populate all required\nfields, so I populate data in controller or in model. For unique fields you need\nto iterate…</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/items/_form.html.erb\n&lt;% if Rails.env.development? %&gt;\n  &lt;%= link_to \"Example\", new_item_path(example: true) %&gt;\n&lt;% end %&gt;\n\n# app/constrollers/items_controller.rb\ndef new\n  @item = Item.new\n  @item = Item.new example_params if Rails.env.development? &amp;&amp; params[:example]\n  end\nend\n\nprivate\n\ndef example_params\n  i = 1\n  while Item.find_by name: \"Example Name #{i}\"\n    i += 1\n  end\n  self.name = \"Example Name #{i}\"\nend\n\n# or\n# app/controllers/items_controller.rb\ndef new\n  @item = Item.new\n  @item.example if Rails.env.development? &amp;&amp; params[:example] == \"true\"\nend\n\n# app/models/item.rb\ndef example\n  i = 1\n  while self.class.find_by name: \"Example Name #{i}\"\n    i += 1\n  end\n  self.name = \"Example Name #{i}\"\nend\n</code></pre></div>    </div>\n  </li>\n  <li>you can iterate in groups batches <code class=\"highlighter-rouge\">&lt;% company.jobs.group_by(&amp;:user).each do\n|user, jobs| %&gt;</code></li>\n  <li><code class=\"highlighter-rouge\">Person.find_in_batches do |people|</code> will iterate but load only 1000 per run.\nOr shorter is <code class=\"highlighter-rouge\">Person.find_each do |person|</code></li>\n  <li>to count by grouping you can group_by specific column\n<code class=\"highlighter-rouge\">User.group(:company_id).count.values.max</code>\nif you want to order in sql, than you need to name the count and order by that\nname (note that we need to use string not symbol for <code class=\"highlighter-rouge\">'count_id'</code>:\n<code class=\"highlighter-rouge\">User.group(:company_id).order('count_id desc').count(:id)</code>.\nyou can group by joined table, for example  https://thoughtbot.com/upcase/videos/advanced-querying-aggregations\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Person.joins(:employees).group('people.name').count('employees_people.id')\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">User.all(joins: :comments, select: \"users.*, count(comments.id) as\ncomments_count\", group: \"users.id\")</code> you can provide string to select and output\njust specific value like comments_count.</li>\n  <li>you can use <code class=\"highlighter-rouge\">.having</code> with rails just write before <code class=\"highlighter-rouge\">.count</code>, like\n<code class=\"highlighter-rouge\">c=Item.reorder(\"\").group([:url, :title, :feed_id]).having('COUNT(*) &gt;\n1').count(:id)</code></li>\n</ul>\n\n<p>Maybe find can help</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Mail.find(\n    :all, \n    :select =&gt; 'count(*) count, country', \n    :group =&gt; 'country', \n    :conditions =&gt; ['validated = ?', 't' ], \n    :order =&gt; 'count DESC',\n    :limit =&gt; 5)\n</code></pre></div></div>\n\n<ul>\n  <li>to run ruby script with rails you can include</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require File.expand_path('/home/orlovic/rails/myApp/config/environment', __FILE__)\nputs User.all\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>even when you are using rails data attritubes you have to use <code class=\"highlighter-rouge\">to_json</code> (as\nyou need in html).\nAnd if you use jQuery data method than you do not need to use JSON.parse.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%= f.text_field :name, \"data-predefined-range\": {a: 3} %&gt;\n&lt;input data-predefined-rage=\"&lt;%= {a: 3}.to_json %&gt;\"&gt;\n&lt;%= f.select :current_city, options_from_collection_for_select(City.all, :uuid, :name), {}, 'data-select-target': '#current-location', 'data-select-options': Location.all_by_city_uuid.to_json %&gt;\n\n&lt;script&gt;\nrange = JSON.parse(input.dataset.predefinedRange);\nrange = $(input).data(\"predefinedRage\");\n\n&lt;model&gt;\n# return hash {city_uuid: [{id: l1.id, name: l1.name}, ...], ...}\ndef self.all_by_city_uuid\n  Location.all.each_with_object({}) do |location, result|\n    if result[location.city_id].present?\n      result[location.city_id].append(id: location.id, name: location.name)\n    else\n      result[location.city_id] = [{ id: location.id, name: location.name }]\n    end\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>security tips</p>\n  </li>\n</ul>\n<p><a href=\"https://github.com/brunofacca/zen-rails-security-checklist\">https://github.com/brunofacca/zen-rails-security-checklist</a></p>\n\n<ul>\n  <li>\n    <p>if you want to use <code class=\"highlighter-rouge\">key.to_sym</code> for all keys you can use <code class=\"highlighter-rouge\">hash.symbolize_keys</code>\nbut if you want that recursively for nested hashes as well you can use\n<code class=\"highlighter-rouge\">params[:some_pararam].deep_symbolize_keys</code></p>\n  </li>\n  <li>\n    <p>memoization is nice if you have network calls or sql calls or db query</p>\n  </li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def MyClass\n  def self.issues\n    @issues ||= Brand.find(1).issues.inject({}) do |hash, issue|\n      hash[issue.title] = issue\n      hash\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>If the value is falsy <code class=\"highlighter-rouge\">nil</code> or <code class=\"highlighter-rouge\">false</code> than you should not use <code class=\"highlighter-rouge\">||=</code> since it\nwill have affect as <code class=\"highlighter-rouge\">=</code>. You should check if instance variable is defined. You\ncan also use <code class=\"highlighter-rouge\">begin</code> <code class=\"highlighter-rouge\">end</code> for multiline definition</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class User &lt; ActiveRecord::Base\ndef main_address\n   return @main_address if defined? @main_address\n    @main_address = begin\n      main_address = home_address if prefers_home_address?\n      main_address ||= work_address\n      main_address ||= addresses.first # some semi-sensible default\n    end\n  end\nend\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>read raw column value before typecast\n<code class=\"highlighter-rouge\">task.read_attribute_before_type_cast('completed_on')</code></p>\n  </li>\n  <li>\n    <p>chechbox change can activate ajax call, just define requect src and method\nUsefull inside form if you want to show validation errors before actual submit,\nor outside of foem if you want to submit change without form (no need to click\non submit button). I do not know how to send value…</p>\n  </li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;%= f.check_box :renew, data: { url: customer_path(@customer), remote: true, method: :patch } %&gt;\n  &lt;%= check_box_tag name, value, checked, data: { url: toggle_todo_path(todo), remote: true } %&gt;\n</code></pre></div></div>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">printf '.'</code> if you need to print single dot</li>\n  <li>turn of sql debug log messages in console <code class=\"highlighter-rouge\">ActiveRecord::Base.logger = nil</code></li>\n  <li>to show full backtrace and lines from gems you can call\n<code class=\"highlighter-rouge\">Rails.backtrace_cleaner.remove_silencers!</code></li>\n  <li>put <code class=\"highlighter-rouge\">gem 'irbtools', require: 'irbtools/binding'</code> in Gemfile so you can load\nscripts in rails console: <code class=\"highlighter-rouge\">vi 'tmp/my_script.rb'</code> and later you can use just\n<code class=\"highlighter-rouge\">vi</code>. Do not exit with <code class=\"highlighter-rouge\">&lt;leader&gt;q</code>. but use <code class=\"highlighter-rouge\">:wq</code>.</li>\n  <li>single file rails application in one file</li>\n</ul>\n<p><a href=\"https://christoph.luppri.ch/articles/2017/06/26/single-file-rails-applications-for-fun-and-bug-reporting/\">https://christoph.luppri.ch/articles/2017/06/26/single-file-rails-applications-for-fun-and-bug-reporting/</a>\n<a href=\"https://gist.github.com/kidlab/72fff6e239b0af1dd3e5\">https://gist.github.com/kidlab/72fff6e239b0af1dd3e5</a> for something that need\ntest or we just want to showcase in one file onepage rails</p>\n<ul>\n  <li>use <code class=\"highlighter-rouge\">.blank?</code> instead of <code class=\"highlighter-rouge\">.empty?</code> since it will work for <code class=\"highlighter-rouge\">nil</code> and <code class=\"highlighter-rouge\">\"\"</code></li>\n  <li>rails has <code class=\"highlighter-rouge\">attribute_was</code> to get original value of some field. That previous\nvalue can be read in any hook, for example <code class=\"highlighter-rouge\">after_validation</code> you can read for\n<code class=\"highlighter-rouge\">operator_id &amp;&amp; operator_id_was</code>.</li>\n  <li>reject empty associated params <code class=\"highlighter-rouge\">params.require(:visit).permit(:post_id).reject\n{ |_, v| v.blank? }</code></li>\n  <li>debug network request <a href=\"https://github.com/aderyabin/sniffer\">https://github.com/aderyabin/sniffer</a></li>\n  <li>use <a href=\"https://github.com/burke/zeus\">https://github.com/burke/zeus</a> gem to speed up preload rails like spring</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>zeus init\nzeus start\ntouch config/boot\n</code></pre></div></div>\n\n<ul>\n  <li><a href=\"https://github.com/kikyous/simple-captcha2\">simple captcha 2</a> is\n<a href=\"https://github.com/kikyous/simple-captcha2/blob/master/lib/simple_captcha/view.rb#L119\">generating</a>\na key (session id) and value (6 chars) when <code class=\"highlighter-rouge\">view.show_simple_captcha</code> is\ncalled.</li>\n  <li>instead of guard clauses <code class=\"highlighter-rouge\">errors.add :name, 'is invalid' and return false\nunless item.save</code> you can move important things in front <code class=\"highlighter-rouge\">item.save ||\n(errors.add :name, 'is invalid' and return false)</code></li>\n  <li>gem <a href=\"https://github.com/hexorx/countries\">countries</a> uses\n<a href=\"https://github.com/RubyMoney/money\">money</a> gem.\nAlso\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n# country select box and store value as ISO code\ngem 'country_select'\n</code></pre></div>    </div>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%= f.form_group :country, label: { text: 'Country' } do %&gt;\n  &lt;%= f.country_select :country, { iso_codes: true, include_blank: 'Select Country'}, class: 'form-control', 'data-select-currency-based-on-country': '#currency-select', 'data-countries-and-currency-codes': ISO3166::Country.all.inject({}) {|a,c| a[c.alpha2]=c.currency&amp;.code;a }.to_json %&gt;\n&lt;% end %&gt;\n&lt;%= f.select :currency, [['Currency based on country', 0]] + Money::Currency.table.values.map {|currency| [currency[:name] + ' (' + currency[:iso_code] + ')', currency[:iso_code]] }, { disabled: 0, selected: (f.object.currency.present? ? f.object.currency : 0) }, id: 'currency-select' %&gt;\n&lt;script&gt;\n  $('[data-select-currency-based-on-country]').on('change', function() {\n    var $target = $($(this).data('selectCurrencyBasedOnCountry'));\n    var options = $(this).data('countriesAndCurrencyCodes');\n    $target.val(options[$(this).val()]);\n  });\n&lt;/script&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>single line one liner rails app for active record can be found in\n<a href=\"https://github.com/rails/rails/blob/master/CONTRIBUTING.md\">contributibuting</a></li>\n  <li>http client https://docs.ruby-lang.org/en/2.0.0/Net/HTTP.html</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'net/http'\nrequire 'uri'\n\ndef fetch(uri_str, limit = 10)\n  # You should choose better exception.\n  raise ArgumentError, 'HTTP redirect too deep' if limit == 0\n\n  url = URI.parse(uri_str)\n  req = Net::HTTP::Get.new(url.path, { 'User-Agent' =&gt; 'Mozilla/5.0 (etc...)' })\n  response = Net::HTTP.start(url.host, url.port) { |http| http.request(req) }\n  case response\n  when Net::HTTPSuccess     then response\n  when Net::HTTPRedirection then fetch(response['location'], limit - 1)\n  else\n    response.error!\n  end\nend\n\nprint fetch('http://www.ruby-lang.org/')\n</code></pre></div></div>\n\n<ul>\n  <li>you can use <code class=\"highlighter-rouge\">URI::regexp</code> to get elements from urls, for example\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>'https://www.premesti.se/my-profile?open-moda=true'.match URI.regexp\n=&gt; #&lt;MatchData\n \"https://www.premesti.se/my-profile?open-moda=true\"\n 1:\"https\"\n 2:nil\n 3:nil\n 4:\"www.premesti.se\"\n 5:nil\n 6:nil\n 7:\"/my-profile\"\n 8:\"open-moda=true\"\n 9:nil&gt;\n # to see positions of specific parts just look at\n URI.regexp\n</code></pre></div>    </div>\n  </li>\n  <li>validate url with custom validation\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># https://coderwall.com/p/ztig5g/validate-urls-in-rails\n# use in your models like:\n# validates :video_url, url: true, allow_blank: true\nclass UrlValidator &lt; ActiveModel::EachValidator\n  def validate_each(record, attribute, value)\n    record.errors[attribute] &lt;&lt; (options[:message] || \"must be a valid URL\") unless url_valid?(value)\n  end\n\n  # a URL may be technically well-formed but may\n  # not actually be valid, so this checks for both.\n  def url_valid?(url)\n    url = URI.parse(url) rescue false\n    url.kind_of?(URI::HTTP) || url.kind_of?(URI::HTTPS)\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>use bang methods to raise exception <code class=\"highlighter-rouge\">User.create! email: 'invalid'</code>. If you\nuse it inside callbacks than no exception will be raise, but rollback will be\nperformed…</li>\n  <li>\n    <p>sometime tests uses precompiled assets from <code class=\"highlighter-rouge\">/public/assets/</code> so make sure to\nclean clear them. Also <code class=\"highlighter-rouge\">/log/test.log</code> became huge if you do not limit it. You\ncan limit test log with</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/environments/test.rb\n# limit log file to 50MB, when it reaches that it will start from empty file\nconfig.logger = ActiveSupport::Logger.new(config.paths['log'].first, 1, 50.megabytes)\n</code></pre></div>    </div>\n  </li>\n  <li>colorize matching string in console\n~~~\n    <h1 id=\"configinitializerscolorizerb\">config/initializers/colorize.rb</h1>\n    <p>class String\nCOLOR = 31 # red</p>\n\n    <p>def red\n  “\\e[#{COLOR}m#{self}\\e[0m”\nend</p>\n\n    <p>def colorize(string, return_nil: true, only_matched_lines: false)\n  last_index = 0\n  res = ‘’\n  while (new_index = self[last_index..-1].index(string))\n    if last_index + new_index - 1 &gt; -1\n      res += self[last_index..last_index + new_index - 1]\n    end\n    res += string.red\n    last_index = last_index + new_index + string.length\n  end\n  res += self[last_index..-1]\n  if only_matched_lines\n    res = res.split(“\\n”).select { |l| l.index string }.join(“\\n”)\n  end\n  # rubocop:disable Rails/Output\n  puts res\n  # rubocop:enable Rails/Output\n  return_nil ? nil : res\nend\nend</p>\n  </li>\n</ul>\n\n<h2 id=\"run-tests-with-a-command\">run tests with a command</h2>\n<h2 id=\"rails-test-configinitializerscolorizerb\">rails test config/initializers/colorize.rb</h2>\n<h1 id=\"require-minitestautorun\">require ‘minitest/autorun’</h1>\n<h1 id=\"class-test--minitesttest\">class Test &lt; Minitest::Test</h1>\n<h1 id=\"def-test_one_substring\">def test_one_substring</h1>\n<h1 id=\"s--my-name-is-john\">s = ‘My name is John.’</h1>\n<h1 id=\"assert_equal-my-name-is-e31mjohne0m-scolorizejohn-return_nil-false\">assert_equal “My name is \\e[31mJohn\\e[0m.”, s.colorize(‘John’, return_nil: false)</h1>\n<h1 id=\"end\">end</h1>\n<p>#</p>\n<h1 id=\"def-test_two_substrings\">def test_two_substrings</h1>\n<h1 id=\"s--john-is-my-name-john\">s = ‘John is my name, John.’</h1>\n<h1 id=\"r--e31mjohne0m-is-my-name-e31mjohne0m\">r = “\\e[31mJohn\\e[0m is my name, \\e[31mJohn\\e[0m.”</h1>\n<h1 id=\"assert_equal-r-scolorizejohn-return_nil-false\">assert_equal r, s.colorize(‘John’, return_nil: false)</h1>\n<h1 id=\"end-1\">end</h1>\n<p>#</p>\n<h1 id=\"def-test_no_found\">def test_no_found</h1>\n<h1 id=\"s--my-name-is-john-1\">s = ‘My name is John.’</h1>\n<h1 id=\"assert_equal-my-name-is-john-scolorizemike-return_nil-false\">assert_equal “My name is John.”, s.colorize(‘Mike’, return_nil: false)</h1>\n<h1 id=\"end-2\">end</h1>\n<p>#</p>\n<h1 id=\"def-test_whole\">def test_whole</h1>\n<h1 id=\"s--my-name-is-john-2\">s = ‘My name is John.’</h1>\n<h1 id=\"assert_equal-e31mmy-name-is-johne0m-scolorizes-return_nil-false\">assert_equal “\\e[31mMy name is John.\\e[0m”, s.colorize(s, return_nil: false)</h1>\n<h1 id=\"end-3\">end</h1>\n<p>#</p>\n<h1 id=\"def-test_return\">def test_return</h1>\n<h1 id=\"s--my-name-is-john-3\">s = ‘My name is John.’</h1>\n<h1 id=\"assert_nil-scolorizejohn\">assert_nil s.colorize(‘John’)</h1>\n<h1 id=\"end-4\">end</h1>\n<p>#</p>\n<h1 id=\"def-test_only_matched_lines\">def test_only_matched_lines</h1>\n<h1 id=\"s--first_linensecond_line-johnnthird_linenjohn-fourth_line\">s = “first_line\\nsecond_line John\\nthird_line\\nJohn fourth_line”</h1>\n<h1 id=\"assert_equal-second_line-johnrednjohnred-fourth_line-scolorizejohn-only_matched_lines-true-return_nil-false\">assert_equal “second_line #{‘John’.red}\\n#{‘John’.red} fourth_line”, s.colorize(‘John’, only_matched_lines: true, return_nil: false)</h1>\n<h1 id=\"end-5\">end</h1>\n<h1 id=\"end-6\">end</h1>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n* if you ever need to write form tag in pure html for rails than you need to add\n  authenticity token\n</code></pre></div></div>\n<form action=\"&lt;%= my_url %&gt;\" method=\"post\">\n    &lt;%= hidden_field_tag :authenticity_token, form_authenticity_token %&gt;\n    <input type=\"text\" name=\"name\" />\n  </form>\n<p>~~~</p>\n\n<ul>\n  <li>\n    <p>gem <code class=\"highlighter-rouge\">will_paginate</code> can use raw sql for selecting and for counting\n https://www.rubydoc.info/github/mislav/will_paginate/WillPaginate%2FActiveRecord%2FBaseMethods:paginate_by_sql</p>\n\n    <p>if you need rails model without table https://gist.github.com/dalibor/228654\nit’s different for Rails 4 and Rails 5\nhttps://stackoverflow.com/questions/41494951/how-to-create-activerecord-tableless-model-in-rails-5</p>\n  </li>\n  <li>constants\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/const.rb\n# rubocop:disable Naming/MethodName\nclass Const\ndef self.COMMON\n  hash_or_error_if_key_does_not_exists(\n    site_name: 'My CRM',\n    domain: 'www.trk.in.rs',\n  )\nend\n\ndef self.COLLAPSE_KEYS\n  hash_or_error_if_key_does_not_exists(\n    new_message: 'new_message',\n  )\nend\n\ndef self.hash_or_error_if_key_does_not_exists(hash)\n  # https://stackoverflow.com/questions/30528699/why-isnt-an-exception-thrown-when-the-hash-value-doesnt-exist\n  # raise if key does not exists hash[:non_exists] or hash.values_at[:non_exists]\n  hash.default_proc = -&gt;(_h, k) { raise KeyError, \"#{k} not found!\" }\n  # raise when value not exists hash.key 'non_exists'\n  def hash.key(value)\n    k = super\n    raise KeyError, \"#{value} not found!\" unless k\n\n    k\n  end\n  hash\nend\nend\n# rubocop:enable Naming/MethodName\n</code></pre></div>    </div>\n  </li>\n  <li>rails routes instead of grep you can search by <code class=\"highlighter-rouge\">rails routes -g user</code> but only\nfor rails &gt; 5.2.1</li>\n  <li>\n    <p>contribute to rails guide https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation\nClone the form of the https://github.com/rails/rails and update\n<code class=\"highlighter-rouge\">guides/source/*.md</code> files.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cd guides\nbundle install\nbundle exec rake guides:generate\n\n</code></pre></div>    </div>\n  </li>\n  <li>Rails 6 uses Utf8mb4 instead Utf8 so you can store emojis 😀 everywhere, I’m\n💯% sure.</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Angular errors",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/04/07/angular-errors/",
      "date"     : "2016-04-07 00:00:00 +0200",
      "content"  : "<ul>\n  <li><code class=\"highlighter-rouge\">TypeError: Cannot read property 'childNodes' of undefined</code> is problem when\nyou are using DOM elements in jQuery in controller\n<a href=\"https://github.com/angular/angular.js/issues/5069\">issue</a>. Solution is to\nwrap inside timeout <code class=\"highlighter-rouge\">setTimeout( function() {someJquery()}, 0)</code></li>\n  <li>if you are rendering google map on element which is shown after some \nactivation (like when ‘$diest’ finishes and add some <code class=\"highlighter-rouge\">ng-class=\"{active:\nvm.showMap}\"</code>) it is advisable to use <code class=\"highlighter-rouge\">$timeout -&gt; </code> so we have DOM ready</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Javascript &amp; coffeescript tips",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/04/05/javascript-coffeescript-tips/",
      "date"     : "2016-04-05 00:00:00 +0200",
      "content"  : "<h1 id=\"how-is-javascript-loaded\">How is javascript loaded</h1>\n\n<p>First are loaded scripts from <code class=\"highlighter-rouge\">&lt;head&gt;</code> tag, than from <code class=\"highlighter-rouge\">&lt;body&gt;</code> tag. It could\nhappend that one <code class=\"highlighter-rouge\">&lt;script src=...</code> failed to load remote scipt, so probably\nthe following script <code class=\"highlighter-rouge\">&lt;script&gt;</code> tag will not work.\nYou can add script dynamically in javascript using <code class=\"highlighter-rouge\">appendChild</code> and it will be\nexecuted after all inline scripts are done (after all defered so setting <code class=\"highlighter-rouge\">defer</code>\noption in javascript has no efects).\nYou can run your script as callback when script is loaded</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># if you are using script src tag\n&lt;script onload=\"loadedContent();\" src =\"/myapp/myCode.js\"  &gt;&lt;/script&gt;\n\n# or using script src tag and event listenter\n&lt;script id=\"myscript\" src =\"/myapp/myCode.js\"&gt;&lt;/script&gt;\n&lt;script&gt;\n  var script = document.querySelector('#myscript');\n  script.addEventListener('load', function() {\n    myScipt Initialisation code\n  });\n&lt;/script&gt;\n\n# or if loaded using appendChild\n\nvar razorpay_script = document.createElement('script');\nrazorpay_script.setAttribute('src','https://checkout.razorpay.com/v1/checkout.js');\nrazorpay_script.onload=function(){\n  #{razorpay_options_js}\n  var rzp1 = new Razorpay(options);\n  rzp1.open();\n};\ndocument.head.appendChild(razorpay_script);\n\n# third solution could be to use setTimeout(callback(){}, 200)\n</code></pre></div></div>\n\n<p>Threre are two phases: downloading and executing. All modern browsers download\nin parallel so we do not need to consider downloading. Execution could be\nimmediatelly or after parsing.</p>\n\n<p>There are two additional attributes <a href=\"https://html.spec.whatwg.org/multipage/scripting.html\">html living standard 4.12\nScripting</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">&lt;script src=\"\" async&gt;</code> execute as soon as it is downloaded (download is not\nblocking). It could be in\nany order regarding other scripts and it could be before parser finishes.</li>\n  <li>when <code class=\"highlighter-rouge\">async</code> is not present than<code class=\"highlighter-rouge\">&lt;script src=\"\" defer&gt;</code> (download is not\nblocking) execute in same order when page has finished parsing (just before\nDOMContentLoaded)\n<code class=\"highlighter-rouge\">defer</code> is ignored on scripts without <code class=\"highlighter-rouge\">src</code> (so defer works only for external\nscripts)</li>\n</ul>\n\n<h1 id=\"scroll-into-view-of-element\">Scroll into view of element</h1>\n\n<p>Sometimes you need to scroll the page to show some notification on top, or to\ndisplay element from the bottom of the page. We can use\n<a href=\"https://developer.mozilla.org/en/docs/Web/API/Element/scrollIntoView\">scrollIntoView</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function checkIfInView($element, options){\n  // Not in view so use https://developer.mozilla.org/en-US/docs/Web/API/Element.scrollIntoView\n  // use options parameter to force scrolling even element is visible on current view\n  // if options == true, the top of the element will be aligned to the top of the visible area of the scrollable ancestor.\n  if (typeof document.getElementsByTagName('body')[0].scrollIntoView == 'undefined')\n  {\n    LOG &amp;&amp; console.log(\"scrollIntoView not defined\");\n    return true;\n  }\n  else if (typeof options != 'undefined')\n  {\n    LOG &amp;&amp; console.log(\"ckeckIfInView \"+options);\n    $element[0].scrollIntoView(options);\n  }\n  else\n  {\n    // check if visible\n    var offset = $element.offset().top - $(window).scrollTop();\n    if(offset &lt; 0){\n        LOG &amp;&amp; console.log(\"alignWithTop=true\");\n        $element[0].scrollIntoView();\n        return false;\n    }\n    else if (offset &gt; window.innerHeight){\n        LOG &amp;&amp; console.log(\"alignWithTop=false\");\n        $element[0].scrollIntoView(false);\n        return false;\n    }\n    else\n    {\n      LOG &amp;&amp; console.log(\"no scroll\");\n      return true;\n    }\n  }\n}\n</code></pre></div></div>\n\n<h1 id=\"always-on-page-floating-elements\">Always on page, floating elements</h1>\n\n<p>There is nice plugin <a href=\"http://stickyjs.com/\">stickyjs</a> but for simple scroll you\ncan use this\n<a href=\"http://stackoverflow.com/questions/2177983/how-to-make-div-follow-scrolling-smoothly-with-jquery\">answer</a>\nFirst version is enought if you do not need to scroll big elements. Note that\ncalculation of <code class=\"highlighter-rouge\">originalTop</code> could be wrong if there are some images and\ntheir parent does not have fixed height.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/javascripts/follow-scroll-smoothly.js\n// call with `follow_scroll_smoothly('.navbar');\nfunction follow_scroll_smoothly(elementSelector) {\n  var element = $(elementSelector);\n  var originalTop = element.offset().top;\n  console.log(\"follow_scroll_smoothly originalTop=\" + originalTop);\n\n  // Space between element and top of screen (when scrolling)\n  var topMargin = 5;\n\n  // Should probably be set in CSS; but here just for emphasis\n  element.css('position', 'relative');\n\n  $(window).on('scroll', function(event) {\n    // get the vertical position of scrollbar\n    var scrollTop = $(window).scrollTop();\n\n    var newTop = scrollTop &lt; originalTop ? 0 : scrollTop - originalTop + topMargin;\n\n    element.stop(false, false).animate({\n        top: newTop,\n    }, 300);\n    console.log(\"follow_scroll_smoothly scrollTop=\" + scrollTop + \" newTop=\" + newTop);\n  });\n}\n</code></pre></div></div>\n\n<p>If target element is big enought to go beyond the bottom line of the page, you\nneed to stop scroll untill user see the bottom.\nNote that we use\n<a href=\"http://api.jquery.com/outerheight/\">outerHeight</a> to include element padding and\nmargin.\nThere are two approaches. First is symetric which do not scroll if current view\nis inside element. Scroll only when user see’s top or bottom or does not see\nelement.</p>\n\n<ul>\n  <li>Symetric rules are:\n    <ul>\n      <li>if I scroll down and I see bottom and top is about to hide\n        <ul>\n          <li>if I see whole element than follow with top of the element</li>\n          <li>if I don’t see whole element than follow with bottom</li>\n        </ul>\n      </li>\n      <li>if I scroll up and I see top and bottom is about to hide\n        <ul>\n          <li>if I see whole element than follow with bottom of the element</li>\n          <li>if I don’t see whole element than follow with top</li>\n        </ul>\n      </li>\n      <li>if I don’t see both top and bottom and I can not see element (it happens\nwhen user press <code class=\"highlighter-rouge\">Home</code> and <code class=\"highlighter-rouge\">End</code> keys) probably element is smaller than\nwindow height\n        <ul>\n          <li>if it scroll up than follow bottom</li>\n          <li>if it scroll down than follow top</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n</ul>\n\n<iframe width=\"100%\" height=\"300\" src=\"//jsfiddle.net/duleorlovic/ffbnr62f/embedded/\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\"></iframe>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function follow_scroll_smoothly(elementSelector, footerSelector) {\n  var element = $(elementSelector);\n  var elementHeight = element.outerHeight();\n  var windowHeight = $(window).height();\n  var documentHeight = $(document).height();\n  var headerMinimumTop = element.offset().top;\n  var footerMaximumTop = documentHeight;\n  if (footerSelector &amp;&amp; $(footerSelector).length) {\n    footerMaximumTop = documentHeight - $(footerSelector).outerHeight();\n  }\n  console.log(\"follow_scroll_smoothly headerMinimumTop=\" + headerMinimumTop);\n\n  // Space between element and top/bottom of screen (when scrolling)\n  var topMargin = 5;\n  var bottomMargin = 15;\n\n  // Should probably be set in CSS; but here just for emphasis\n  element.css('position', 'relative');\n\n  function checkRangeRelativeTop(relativeTop) {\n    var result = relativeTop;\n    if (result &lt; 0) {\n      // can not go above initial position\n      result = 0;\n    } else if (result &gt; footerMaximumTop - elementHeight - headerMinimumTop) {\n      // can not go bewond footer\n      result = footerMaximumTop - elementHeight - headerMinimumTop;\n    }\n    return result;\n  }\n\n  function stickTop(scrollTop) {\n    var newRelativeTop = checkRangeRelativeTop(scrollTop - headerMinimumTop + topMargin);\n    element.stop(false, false).animate({\n        top: newRelativeTop,\n    }, 300);\n    $('#debug').prepend('&lt;br&gt;stickTop ' + newRelativeTop);\n  }\n  function stickBottom(scrollTop) {\n    // we don't use animate bottom since it is relative to element, we use top\n    var newRelativeTop = checkRangeRelativeTop(scrollTop - headerMinimumTop + windowHeight - elementHeight - bottomMargin);\n\n    element.stop(false, false).animate({\n        top: newRelativeTop,\n    }, 300);\n    $('#debug').prepend('&lt;br&gt;stickBottom ' + newRelativeTop);\n  }\n  var lastScrollTop = 0;\n  $(window).on('scroll', function(event) {\n    // get the vertical position of scrollbar\n    var scrollTop = $(window).scrollTop();\n    var scrollDownDirection = scrollTop &gt; lastScrollTop;\n    lastScrollTop = scrollTop;\n    var elementTop = element.offset().top\n    var elementBottom = elementTop + elementHeight;\n    var weSeeBottom = windowHeight + scrollTop &gt; elementBottom &amp;&amp; scrollTop &lt; elementBottom;\n    var weSeeTop = windowHeight + scrollTop &gt; elementTop &amp;&amp; scrollTop &lt; elementTop;\n    $('#info').html(JSON.stringify(\n      {\n        windowHeight: windowHeight,\n        headerMinimumTop: headerMinimumTop,\n        elementHeight: elementHeight,\n        elementTop: elementTop,\n        footerMaximumTop: footerMaximumTop,\n        // scrollTop: scrollTop,\n        // weSeeBottom: weSeeBottom,\n        // weSeeTop: weSeeTop,\n        // scrollDownDirection: scrollDownDirection,\n      }\n    ));\n\n    if (scrollDownDirection &amp;&amp; weSeeBottom &amp;&amp; !weSeeTop)\n    {\n      if (windowHeight &gt; elementHeight) {\n        // we see whole element\n        stickTop(scrollTop);\n      } else {\n        // we don't whole element because top is out of page\n        stickBottom(scrollTop);\n      }\n    }\n    else if (!scrollDownDirection &amp;&amp; !weSeeBottom &amp;&amp; weSeeTop)\n    {\n      if (windowHeight &gt; elementHeight) {\n        stickBottom(scrollTop);\n      } else {\n        stickTop(scrollTop);\n      }\n    }\n    else if (!weSeeBottom &amp;&amp; !weSeeTop &amp;&amp; (elementBottom &lt; scrollTop || elementTop &gt; scrollTop + windowHeight))\n    {\n      if (scrollDownDirection) {\n        stickTop(scrollTop);\n      } else {\n        stickBottom(scrollTop);\n      }\n    }\n  });\n}\n</code></pre></div></div>\n\n<p>Another approach is to keep top as much as he can (until bottom reaches bottom).\nWhen element is bigger than page, user needs to scroll down to the bottom to see\nbottom of the element.</p>\n\n<iframe width=\"100%\" height=\"300\" src=\"//jsfiddle.net/duleorlovic/ffbnr62f/8/embedded/\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\"></iframe>\n\n<h1 id=\"coffeescript-tips\">Coffeescript tips</h1>\n\n<ul>\n  <li><a href=\"http://coffeescript.org/\">try coffeescript</a> and convertor\n<a href=\"http://js2.coffee/\">js2coffe</a></li>\n  <li>no need <code class=\"highlighter-rouge\">;</code> at the end of line</li>\n  <li>block {…} is replaced with <code class=\"highlighter-rouge\">-&gt;</code> and proper indend (two spaces) or could be\ninline</li>\n  <li>parantheses (arg) in one line can be ommited (when there are some arguments),\nin multiple lines they are required. Don’t mix inline and multiline, since it\nwill resolve to two arguments (with type object). Don’t know how to break long\ninline arguments to two line. At least first arg should be in new line, others\ncan be on the same line or in separate line.</li>\n  <li><code class=\"highlighter-rouge\">()</code> are required when you want to call function without arguments\n(otherwise it will just return reference to the function)</li>\n  <li>object definition {…} braces can be ommited, name/value pairs could be on\nnew lines (if object is only argument than parentheses can be ommited)</li>\n  <li>No need to write return command. Since last line is returning, put empty\n<code class=\"highlighter-rouge\">return</code> in angular constructor functions</li>\n  <li>conditional ternary (triple) operator in <code class=\"highlighter-rouge\">? : </code> can be used with <code class=\"highlighter-rouge\">if then else</code></li>\n  <li>\n    <p><a href=\"http://coffeescript.org/#loops\">loops</a> are simiral to ruby, and it’s\nbetter than ES5 <code class=\"highlighter-rouge\">forEach</code> since we can <code class=\"highlighter-rouge\">break</code> from the loop. For example\nfind by objectId in array carts:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>service.findOrCreateCartForRestaurant = (restaurant) -&gt;\n  resultCart = null\n  for cart in service.carts\n    if cart.restaurantId == restaurant.id\n      resultCart = cart\n      break\n  if !resultCart\n    resultCart =\n      restaurantId: restaurant.id\n      restaurantName: restaurant.name\n      total: 0\n      cartItems: []\n    service.carts.push resultCart\n  resultCart\n</code></pre></div>    </div>\n\n    <p>Another solution is to use <code class=\"highlighter-rouge\">resultCart = $filter('filter')(service.carts,\n(cart) -&gt; { cart.id == restaurant.id })</code> or from\n<a href=\"https://coffeescript-cookbook.github.io/chapters/arrays/filtering-arrays\">cookbook</a>\n` resultCart = service.carts.filter (cart) -&gt; cart.id == restaurant.id`</p>\n  </li>\n  <li>\n    <p>print empty lines in log</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>console.log (\"\\n\" for x in [0..10]).join('')\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p><a href=\"http://coffeescript.org/#fat-arrow\">fat arrow =&gt;</a> allow to <code class=\"highlighter-rouge\">this</code> in callback\nfunctions</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Account = (customer, cart) -&gt;\n  @customer = customer\n  @cart = cart\n\n  $('.shopping_cart').on 'click', (event) =&gt;\n    @customer.purchase @cart\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>multiline text without or with new lines</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>s = \"This is\n  very long line\"\np = \"this-long-url\\\n    -joined-without-space\"\nq =\n  \"\"\"\n  This is\n  very long line\n  \"\"\"\n</code></pre></div>    </div>\n  </li>\n  <li>excellent reference for\n<a href=\"https://coffeescript-cookbook.github.io/chapters/arrays/filtering-arrays\">coffeescript-cookbook</a></li>\n  <li>global variables can be attached to <code class=\"highlighter-rouge\">window</code> object like <code class=\"highlighter-rouge\">window.my_var = 42</code>\nor you can use <code class=\"highlighter-rouge\">@</code> syntax <code class=\"highlighter-rouge\">@my_var = 42</code></li>\n  <li><a href=\"http://coffeescript.org/#loops\">iterate loops</a> over hash object <code class=\"highlighter-rouge\">for k, v of\nmy_object</code>. If you need index of array use also two params <code class=\"highlighter-rouge\">for value, index of\narray</code>. In ES6 you can <code class=\"highlighter-rouge\">myArray.forEach(function(val) { console.log(val) }</code>. To\nconvert HtmlCollection to array you can use <code class=\"highlighter-rouge\">Array.from(htmlCollection)</code></li>\n  <li>\n    <p>you can call functions without parantesis but if you have params. But if you\ndo not have params, that would be just a reference to a function, to call it you\ncan use <code class=\"highlighter-rouge\">do</code>\n<a href=\"https://coffeescript-cookbook.github.io/chapters/functions/parentheses\">link</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>event.preventDefault()\n# or\ndo event.preventDefault\n</code></pre></div>    </div>\n\n    <p>another usage of do is for <a href=\"/2016/02/10/javascript-theory/#closures\">closures</a></p>\n  </li>\n  <li>you can use <code class=\"highlighter-rouge\">class</code>, <code class=\"highlighter-rouge\">constructor</code>, <code class=\"highlighter-rouge\">@instance_valiable =</code>, <code class=\"highlighter-rouge\">@class_variable:\n</code> for\n<a href=\"http://coffeescript-cookbook.github.io/chapters/classes_and_objects/\">classes</a>\nfor example you can define constants\nhttps://coderwall.com/p/1dckba/constants-in-coffeescript\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/const.coffee.erb\nclass window.Const\n@DATATABLE_SR_LANGUAGE_URL: '&lt;%= asset_path 'plugins/datatables/i18n.sr.json.erb' %&gt;'\n@SOME_OBJECT: {\n  a: 1\n}\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>so you can access in other js files</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>url = Const.DATATABLE_SR_LANGUAGE_URL\nmy_obj = Const.SOME_OBJECT\n</code></pre></div></div>\n\n<h1 id=\"difference-es6-ie-es2015-and-es5\">Difference ES6 (ie ES2015) and ES5</h1>\n\n<p>This <a href=\"http://kamranahmed.info/blog/2016/04/04/es6-in-depth/\">post</a> explains what\nis new in ES6 (Ecma Script 2015). Almost all those features already exists in\ncoffee script <a href=\"https://gist.github.com/benjie/d0e39fbe8a61bc30ed93\">nice reply</a>.\nIt’s good that no need to write <code class=\"highlighter-rouge\">function</code> keyword. Also nice table of\n<a href=\"http://es6-features.org/\">es6-features</a> and <a href=\"http://kangax.github.io/compat-table/es6/\">supported\nbrowsers</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">use strict</code> mode by default (by this\n<a href=\"http://arcturo.github.io/library/coffeescript/07_the_bad_parts.html\">info</a>\nyou should use in development but not on production</li>\n</ul>\n\n<h1 id=\"books\">Books</h1>\n\n<ul>\n  <li>https://performancejs.com/post/hde6d32/The-Best-Frontend-JavaScript-Interview-Questions-%28written-by-a-Frontend-Engineer%29</li>\n  <li>https://github.com/getify/You-Dont-Know-JS</li>\n  <li>best practices https://github.com/wearehive/project-guidelines</li>\n</ul>\n\n<h1 id=\"colors\">Colors</h1>\n\n<p>You can generate random colors in javascript</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  function getRandomColor() {\n    var letters = '0123456789ABCDEF'.split('');\n    var color = '#';\n    for (var i = 0; i &lt; 6; i++ ) {\n        color += letters[Math.floor(Math.random() * 16)];\n    }\n    return color;\n  }\n\n  var color = getRandomColor()\n  // add transparency for background colors\n  var backgroundColor = color + 'A0'\n</code></pre></div></div>\n\n<p>If you need same distinct colors based on integer numbers you can create a\ndeterministic function. I use ruby since it is easier than javascript</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  def add_colors(datasets)\n    # http://martin.ankerl.com/2009/12/09/how-to-create-random-colors-programmatically/\n    h = 0.5\n    golden_ratio_conjugate = 0.618033988749895\n    colors = (1..datasets.length).to_a.map do\n      h += golden_ratio_conjugate\n      h %= 1\n      hsv_to_rgb(h, 0.5, 0.95)\n    end.map do |r,g,b|\n      { \n        full: \"rgba(#{r},#{g},#{b},1)\",\n        transparent: \"rgba(#{r},#{g},#{b},0.2)\"\n      }\n    end.map { |c| OpenStruct.new c }\n\n    result = datasets.each_with_index.map do |dataset,i|\n      {\n        fillColor: colors[i].transparent,\n        strokeColor: colors[i].full,\n        pointColor: colors[i].full,\n        pointStrokeColor: \"#fff\",\n        pointHighlightFill: \"#fff\",\n        pointHighlightStroke: colors[i].full,\n      }.merge dataset\n    end\n    result\n  end\n\n  # HSV values in [0..1[\n  # returns [r, g, b] values from 0 to 255\n  def hsv_to_rgb(h, s, v)\n    h_i = (h*6).to_i\n    f = h*6 - h_i\n    p = v * (1 - s)\n    q = v * (1 - f*s)\n    t = v * (1 - (1 - f) * s)\n    r, g, b = v, t, p if h_i==0\n    r, g, b = q, v, p if h_i==1\n    r, g, b = p, v, t if h_i==2\n    r, g, b = p, q, v if h_i==3\n    r, g, b = t, p, v if h_i==4\n    r, g, b = v, p, q if h_i==5\n    [(r*256).to_i, (g*256).to_i, (b*256).to_i]\n  end  \n</code></pre></div></div>\n\n<h1 id=\"javascript-tips\">Javascript tips</h1>\n\n<ul>\n  <li><a href=\"https://github.com/mbeaudru/modern-js-cheatsheet\">modern js cheatsheet</a></li>\n  <li>to see all keys of <code class=\"highlighter-rouge\">myObj</code> you can use <code class=\"highlighter-rouge\">Object.keys(myObj)</code></li>\n  <li>alert object with <code class=\"highlighter-rouge\">alert(JSON.stringify(myObj))</code></li>\n  <li>\n    <p>if you want to break array <code class=\"highlighter-rouge\">forEach</code> method when you find el, you can use\n<a href=\"http://stackoverflow.com/questions/2641347/how-to-short-circuit-array-foreach-like-calling-break\">some</a></p>\n  </li>\n  <li>to remove item <code class=\"highlighter-rouge\">myObject</code> from array <code class=\"highlighter-rouge\">myArray.splice\nmyArray.indexOf(myObject),1 </code></li>\n  <li><code class=\"highlighter-rouge\">!!variable</code> will return false only for <code class=\"highlighter-rouge\">0, null, \"\", undefined, NaN</code> NaN=Not\na number</li>\n  <li>to check if some property is defined on a object (method or variable), you can\nuse <code class=\"highlighter-rouge\">in</code> for example <code class=\"highlighter-rouge\">a = {b:1}; 'b' in a // returns true</code></li>\n  <li>get last element of array <code class=\"highlighter-rouge\">array.slice(-1);</code></li>\n  <li>replaceAll is the same as <code class=\"highlighter-rouge\">/g</code> example <code class=\"highlighter-rouge\">\"asdasd\".replace(/s/g,\"***\")</code></li>\n  <li>merging arrays is better to append <code class=\"highlighter-rouge\">array1.push.apply(array1, array2)</code> than to\ncreate new <code class=\"highlighter-rouge\">array1.concat(array2)</code></li>\n  <li>instead of <code class=\"highlighter-rouge\">parseInt('10')</code> you can use <code class=\"highlighter-rouge\">+'10'</code> to type cast string to number</li>\n  <li><code class=\"highlighter-rouge\">jQuery.data()</code> is different than plain javascript <code class=\"highlighter-rouge\">this.dataset</code> because\njavascript always returns string <code class=\"highlighter-rouge\">this.dataset.a // \"[1]\"</code> but jQuery use\nJSON.parse and returns string in case it is not valid json <code class=\"highlighter-rouge\">$(this).data('a')\n// [1]</code>. Note that integers will be integers not strings.\nAlso IE10 does not support dataset, so better is to use <code class=\"highlighter-rouge\">$(this).data().a</code>.</li>\n  <li>\n    <p>if variable point to the same array or object, than it will be the same\n<code class=\"highlighter-rouge\">a=[1];b=a;a==b//true</code>. But if it different object (event with same data)\nvariables will not have the same value. <code class=\"highlighter-rouge\">a=[1];b=[1];a==b//false</code> or\n<code class=\"highlighter-rouge\">{a:1}=={a:1}//false</code>. Comparing arrays or objects should be done one by one\n<a href=\"http://stackoverflow.com/questions/7837456/how-to-compare-arrays-in-javascript\">link</a></p>\n  </li>\n  <li>if you are using <code class=\"highlighter-rouge\">window.location.replace('http://a.b');</code> then browser back\nbutton is not working as espected. Its better to use\n<code class=\"highlighter-rouge\">window.location.assign('new_page');</code> because the page is stored in history</li>\n  <li>\n    <p>when user click back button previous page is reshown, and chrome reruns\nthe javascript, but mozilla doesn’t. if you want in mozilla to run again,\nuse cache buster or try with:</p>\n\n    <ul>\n      <li><code class=\"highlighter-rouge\">window.onunload = function(){};</code></li>\n      <li><code class=\"highlighter-rouge\">$(window).unload(function () {});</code></li>\n      <li><code class=\"highlighter-rouge\">$(window).bind(\"pageshow\", function() {});</code></li>\n    </ul>\n\n    <p>In both mozilla and chrome, form fields stays populated, so you can use\n<code class=\"highlighter-rouge\">$('form').each(function() { this.reset(); });</code> which is not user friendly, it\nis better to target only one form</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;form id=\"reset-form\"&gt;&lt;/form&gt;\n&lt;script&gt;\n  $(window).bind(\"pageshow\", function() {\n    document.getElementById('reset-form').reset();\n  });\n&lt;/script&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>submit button should be disabled when text input or textarea are blank. You\ncan enable button on change, but it should listen <a href=\"http://www.w3schools.com/tags/ref_eventattributes.asp\">other\nevents</a> as well so it is\nenable for example, on onpaste.</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;form&gt;\n  &lt;input onchange=\"d(this)\" onkeyup=\"this.onchange()\" onpaste=\"this.onchange()\" oninput=\"this.onchange()\" \\&gt;\n  &lt;button id=\"send_button\" disabled=\"disabled\"&gt;Send&lt;/button&gt;\n&lt;/form&gt;\n&lt;script&gt;\nfunction d(e){\n  document.getElementById(\"send_button\").disabled = e.value.length == 0;\n}\n&lt;/script&gt;\n</code></pre></div></div>\n\n<p>this is unobtrusive version, works for input and select elements</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/common.coffee\n  $('[data-disable-button-if-empty]').on 'change paste keyup input', -&gt;\n    disabled = this.value.length == 0\n    $(this).parents('form').first().find('[type=submit]').prop('disabled', disabled)\n\n  # initial status\n  $.each $('[data-disable-button-if-empty]'), (index, el) -&gt;\n    $(el).trigger('change')\n\n# app/views/posts/form.html.erb\n    &lt;%= f.text_field :name, class: \"input-large\", 'data-disable-button-if-empty' =&gt; true %&gt;\n    &lt;%= f.collection_select :post_id, some_posts, :id, :name, { include_blank: 'Select Package' }, class: \"field span5\", 'data-disable-button-if-empty' =&gt; true %&gt;\n</code></pre></div></div>\n\n<h1 id=\"regex\">regex</h1>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp\">match</a></p>\n\n<ul>\n  <li>\n    <p>when you are sending object with GET than you need to make it encoded (or you\ncan use jQuery.get(url, data):</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  var xhr = new XMLHttpRequest();\n  // http://stackoverflow.com/questions/5505085/flatten-a-javascript-object-to-pass-as-querystring\n  function toQueryString(obj) {\n    var parts = [];\n    for (var i in obj) {\n        if (obj.hasOwnProperty(i)) {\n            parts.push(encodeURIComponent(i) + \"=\" + encodeURIComponent(obj[i]));\n        }\n    }\n    return parts.join(\"&amp;\");\n  }\n  xhr.open('GET', '/notify-javascript-error?' + toQueryString(data));\n  xhr.send();\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>to create jquery elements you can select parent element and append to it:\n<code class=\"highlighter-rouge\">$('p').append('&lt;span&gt;hi&lt;/span&gt;')</code> or you can create and use appendTo\n<code class=\"highlighter-rouge\">$('&lt;span&gt;hi&lt;/span&gt;').appendTo('body');</code>. Instead of elements as html blocks, if\nyou have a lot of javascript variables, you can pass additinal parameters and\nuse quick self closed tags like</p>\n  </li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$('&lt;div/&gt;', {\n  id: 'foo',\n  css: {\n    fontWeight: 600\n  },\n  click: function() {\n    alert('Hi');\n  }\n});\n</code></pre></div></div>\n\n<p>you can add <code class=\"highlighter-rouge\">$('p').after(\"some text\")</code> or <code class=\"highlighter-rouge\">$('p').before('some text')</code></p>\n\n<ul>\n  <li>\n    <p>click event buble up, so when you attach click</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;button type=\"button\" class=\"btn btn-box-tool\" data-widget=\"collapse\" data-user-preferences=\"expand_location_reports_customers\"&gt;&lt;i class=\"fa fa-minus\"&gt;&lt;/i&gt;\n</code></pre></div>    </div>\n\n    <p>target will will be inner <code class=\"highlighter-rouge\">&lt;i&gt;</code> and currentTarget will be <code class=\"highlighter-rouge\">&lt;button&gt;</code> so\ntargetElement (e.target) should be e.currentTarget</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@initializeUserPreferences = -&gt;\n  $('[data-user-preferences]').click (e) -&gt;\n    preference = e.currentTarget.dataset.dataUserPreferences\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>disable right click on a page with <code class=\"highlighter-rouge\">document.addEventListener('contextmenu',\nevent =&gt; event.preventDefault());</code>. If you want to reenable on some page,\nuse global search (Ctrl+Shift+F in chrome) for <code class=\"highlighter-rouge\">contextmenu</code> and put\nbreakpoint and comment that line, save and continue F8.</p>\n  </li>\n  <li>\n    <p><code class=\"highlighter-rouge\">fetch</code> makes js requests. If you need to pass header for cookie session than\nuse param https://github.com/github/fetch#sending-cookies</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>fetch('/users', {\n  credentials: 'same-origin'\n})\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>jquery.each should not return <code class=\"highlighter-rouge\">false</code> since it will break the loop, for in\ncoffeescript you should add <code class=\"highlighter-rouge\">true</code></p>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  $('[data-enable-buttons]:checked').each -&gt;\n    this.checked = false\n    true\n</code></pre></div>    </div>\n  </li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Gulp tasks",
      "category" : "",
      "tags"     : "gulp",
      "url"      : "/2016/03/02/gulp-tasks/",
      "date"     : "2016-03-02 00:00:00 +0100",
      "content"  : "<p>Gulp commands are simple and sometimes not intuitive, so you need to read\n<a href=\"http://julienrenaux.fr/2014/05/25/introduction-to-gulp-js-with-practical-examples/\">practical examples</a>\nbefore using it.</p>\n\n<h1 id=\"deploy-to-s3\">Deploy to S3</h1>\n\n<p>You can deploy frontend code on any static web host, like AWS S3. You just need\nto add <em>deploy</em> task that is using <a href=\"https://www.npmjs.com/package/gulp-awspublish\">gulp-awspublish</a> <code class=\"highlighter-rouge\">npm install --save-dev gulp-awspublish</code> .</p>\n\n<p>It has some problems when bucket is from eu-central-1 and contains dots, so read\n<a href=\"/2016/02/29/amazon-aws-s3/\">aws s3</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// gulp/build.js\nvar awspublish = require('gulp-awspublish');\n\ngulp.task('deploy', ['build'], function() {\n  console.log(\"AWS_BUCKET_NAME=\" + process.env.AWS_BUCKET_NAME);\n  console.log(\"AWS_REGION=\" + process.env.AWS_REGION);\n  console.log(\"AWS_ACCESS_KEY_ID=\" + process.env.AWS_ACCESS_KEY_ID);\n  console.log(\"AWS_SECRET_ACCESS_KEY=\" + process.env.AWS_SECRET_ACCESS_KEY);\n  if (!process.env.AWS_BUCKET_NAME || !process.env.AWS_ACCESS_KEY_ID || !process.env.AWS_SECRET_ACCESS_KEY) {\n    console.error('You must provide bucket name, access key id and secret access key to deploy.');\n    process.exit(1);\n  }\n  \n  // create a new publisher using S3 options\n  // http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#constructor-property\n  var publisher = awspublish.create({\n    region: process.env.AWS_REGION,\n    params: {\n      Bucket: process.env.AWS_BUCKET_NAME\n    },\n    accessKeyId: process.env.AWS_ACCESS_KEY_ID,\n    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY\n  });\n\n  // define custom headers for assets\n  var headers = {\n    'Cache-Control': 'max-age=0, s-maxage=86400'\n  };\n\n  return gulp.src(['dist/**/*'])\n    .pipe(publisher.publish(headers))\n    .pipe(publisher.sync())\n    .pipe(awspublish.reporter());\n});\n</code></pre></div></div>\n\n<h1 id=\"gulp-api-production-or-local\">Gulp api production or local</h1>\n\n<p>To change which api should be used, I use param <code class=\"highlighter-rouge\">--api</code> like</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gulp serve --api production\ngulp serve --api localhost:3000\ngulp clean &amp;&amp; gulp deploy --api production\n</code></pre></div></div>\n\n<p>Note that you need to stop eventual gulp serve for localhost, when you want to\ndeploy for production.</p>\n\n<p>First install <code class=\"highlighter-rouge\">gulp-if</code> with <code class=\"highlighter-rouge\">npm install yargs gulp-if --save-dev</code>. Than add to\n<code class=\"highlighter-rouge\">gulp/script.js</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// gulp/script.js\nvar replace = require('gulp-replace');\nvar argv = require('yargs').argv;\nvar gulpif = require('gulp-if');\nvar serverUrl = false; // default is what is defined in constants.coffee\nif (argv.api == 'production') {\n  serverUrl = 'PRODUCTION_SERVER_URL';\n} else if (argv.api) {\n  serverUrl = '\"http://' + argv.api + '\"';\n}\n// inside `function buildScripts()` insert as first pipe, below return\n    .pipe(gulpif(!!serverUrl,replace(/API_URL: \\w*SERVER_URL/g, 'API_URL: ' + serverUrl)))\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># src/app/index.constants.coffee\n# do not rename this constants since they are used in gulp scripts task\nPRODUCTION_SERVER_URL = 'https://myapp.herokuapp.com'\nSTAGING_SERVER_URL = 'https://myapp-staging.herokuapp.com'\nLOCAL_SERVER_URL = 'http://localhost:3000'\nangular.module('myappAngular')\n  .constant 'CONFIG',\n    API_URL: STAGING_SERVER_URL + '/api/v1'\n</code></pre></div></div>\n\n<p>Since Ionic command line does not pass params to gulp, there is Enviroment\napproach to select SERVER_URL on <a href=\"/2016/01/27/ionic-begginer-examples/\">ionic\npage</a></p>\n\n<p>Adding coffeescript and jade example you can find on that ionic page.</p>\n"
    } ,
  
    {
      "title"    : "Amazon AWS S3",
      "category" : "",
      "tags"     : "s3",
      "url"      : "/2016/02/29/amazon-aws-s3/",
      "date"     : "2016-02-29 00:00:00 +0100",
      "content"  : "<h1 id=\"create-iam-user-and-attach-inline-policy\">Create IAM user and attach inline policy</h1>\n\n<p>I usually one user for testing (keys that I export in my basrc), one user for\nall my apps, and one for some projects which other devs could have access.\nFor test IAM user I attach\n<a href=\"http://blogs.aws.amazon.com/security/post/Tx3VRSWZ6B3SHAV/Writing-IAM-Policies-How-to-grant-access-to-an-Amazon-S3-bucket\">policy</a>\nfor <em>Programmatic read and write permissions</em> with name for example\n<strong>full_access_to_video_uploading_demo</strong> . Keep in mind that underscore _ is not\nequal hyphen - .\nCarrierwave and paperclip need something more than put, get and delete, so I\nadded <code class=\"highlighter-rouge\">s3:*</code> below <code class=\"highlighter-rouge\">\"s3:DeleteObject\"</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"s3:ListBucket\"\n            ],\n            \"Resource\": [\n                \"arn:aws:s3:::duleorlovic-test\",\n                \"arn:aws:s3:::duleorlovic-test-eu-central-1\",\n                \"arn:aws:s3:::duleorlovic-test-us-east-1\"\n            ]\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"s3:*\"\n            ],\n            \"Resource\": [\n                \"arn:aws:s3:::duleorlovic-test/*\",\n                \"arn:aws:s3:::duleorlovic-test-eu-central-1/*\",\n                \"arn:aws:s3:::duleorlovic-test-us-east-1/*\"\n            ]\n        }\n    ]\n}\n</code></pre></div></div>\n\n<h2 id=\"add-admin-user-to-the-account\">Add admin user to the account</h2>\n\n<p>You can create IAM user with PowerUserAccess. On\nhttps://console.aws.amazon.com/iam/home?#/users click on Add user</p>\n\n<p>Put username: duleorlovic@gmx.com\nSelect: AWS Management Console access\nLeave autogenerated password\nNext (Permissions)\nTab Attach existing policies directly\nSearch for PowerUserAccess\nSelect PowerUserAccess\nCreate user\nClick on Send email\nAlso copy the password and put in email (it will be changed when I login).\nSend me the email…</p>\n\n<h1 id=\"website-hosting\">Website hosting</h1>\n\n<p>You can use your <code class=\"highlighter-rouge\">some.domain.com</code> to point to your bucket\n<a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html\">guide</a>\nThis is simple as adding one CNAME record.</p>\n\n<p>Your bucket needs to have the SAME NAME AS YOUR DOMAIN <code class=\"highlighter-rouge\">some.domain.com</code> or you\nneed to use Amazon DNS Route 53. Also if you want to serve from root domain\n<code class=\"highlighter-rouge\">domain.com</code> than you must use DNS Route 53.\nFor default region <em>US Standard (us-east-1)</em> you can add CNAME record with value\n<code class=\"highlighter-rouge\">some.domain.com.s3.amazonaws.com</code> on your domain provider page.</p>\n\n<p>But if bucket is from different region than from CNAME you need to use full\n<strong>Endpoint</strong> which you can find in Properties of you bucket -&gt; Endpoint.\nfor CNAME</p>\n\n<p><strong>bucket-name</strong>.s3-website[-.]<strong>region</strong>.amazonaws.com</p>\n\n<p>List of regions you\ncan find on <a href=\"http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteEndpoints.html\">website\nendpoints</a>.\nor <a href=\"http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region\">http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region</a>\nFor frankfurt would be <code class=\"highlighter-rouge\">some.domain.com.s3-website.eu-central-1.amazonaws.com</code>\nFor southeast region is <code class=\"highlighter-rouge\">ap-southeast-1</code>.\nYour bucket-name can not be different than your domain name!\n<a href=\"http://docs.aws.amazon.com/AmazonS3/latest/dev/VirtualHosting.html\">virtual hosting</a>,\n<a href=\"http://docs.aws.amazon.com/general/latest/gr/rande.html\">regions and endpoints</a></p>\n\n<h2 id=\"mark-bucket-public\">Mark bucket public</h2>\n\n<p>You can deploy frontend code to S3 but you need to make it public. Edit bucket\npolicy to</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"Version\":\"2012-10-17\",\n  \"Statement\":[{\n  \"Sid\":\"AddPerm\",\n        \"Effect\":\"Allow\",\n    \"Principal\": \"*\",\n      \"Action\":[\"s3:GetObject\"],\n      \"Resource\":[\"arn:aws:s3:::projektor.trk.in.rs/*\"\n      ]\n    }\n  ]\n}\n</code></pre></div></div>\n\n<h2 id=\"ssl-on-amazon-cloud-front\">SSL on Amazon Cloud front</h2>\n\n<p>You can request certificate <a href=\"https://console.aws.amazon.com/acm/\">AWS Certificate\nManager</a>. It will send email to the\n<code class=\"highlighter-rouge\">administrator@trk.in.rs</code> with the link to approve. Administrator of domain can\njust click on the link to approve it.</p>\n\n<p>Once you have approved certificate you can use it on <a href=\"https://console.aws.amazon.com/cloudfront/\">cloud\nfront</a> distribution. Some\n<a href=\"http://docs.aws.amazon.com/gettingstarted/latest/swh/getting-started-create-cfdist.html\">notes</a>.</p>\n\n<ul>\n  <li>it could 15 mins for distribution to become deployed</li>\n  <li>when selecting <em>Origin Domain Name</em> do not select option from dropdown since\nit does not contain region (it will work only for us-east-1 buckets). You need\nto use bucket Endpoint here</li>\n  <li>\n    <p>update your DNS record so CNAME is something like\nd1ub4fmsp3scvp.cloudfront.net</p>\n  </li>\n  <li>default is <a href=\"http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Expiration.html\">24\nhours</a>\nfor cache to expire… you can try to invalidate some files manually</li>\n</ul>\n\n<h1 id=\"access-files\">Access files</h1>\n\n<p>Files can we accessed in three ways.</p>\n\n<ol>\n  <li><strong>bucket_name as path</strong>.\n<em>s3<code class=\"highlighter-rouge\">[-.]region</code>.amazonaws.com/<code class=\"highlighter-rouge\">bucket-name</code>/<code class=\"highlighter-rouge\">file-name</code></em>. Go to the properties\nof the file and find <em>link</em>, for example:\n<a href=\"https://s3.eu-central-1.amazonaws.com/duleorlovic-test-eu-central-1/icon-menu.png\">https://s3.eu-central-1.amazonaws.com/duleorlovic-test-eu-central-1/icon-menu.png</a>.\nYou will notice that for us-east-1 region, link does not contain region part,\nonly <a href=\"https://s3.amazonaws.com/duleorlovic-test-us-east-1/favicon.ico\">https://s3.amazonaws.com/duleorlovic-test-us-east-1/favicon.ico</a></li>\n  <li><strong>bucket_name as subdomain</strong>.<code class=\"highlighter-rouge\">bucket-name</code>.s3.amazonaws.com/<code class=\"highlighter-rouge\">filename</code>. This\nis shorter since this url does not contain region\n<a href=\"https://duleorlovic-test-eu-central-1.s3.amazonaws.com/icon-menu.png\">https://duleorlovic-test-eu-central-1.s3.amazonaws.com/icon-menu.png</a></li>\n  <li>enable <strong>website hosting</strong> so you can use <em>Endpoint</em> and append fileName\n<a href=\"http://duleorlovic-test-eu-central-1.s3-website.eu-central-1.amazonaws.com/icon-menu.png\">http://duleorlovic-test-eu-central-1.s3-website.eu-central-1.amazonaws.com/icon-menu.png</a>\n    <ul>\n      <li>note that url contains <code class=\"highlighter-rouge\">website-</code> so website needs to be enabled</li>\n      <li>note that this way you can not access using SSL https protocol</li>\n      <li>for HTTPS you need Cloud Front and Route 53 service\n<a href=\"http://knightlab.northwestern.edu/2015/05/21/implementing-ssl-on-amazon-s3-static-websites/\">link</a>\nor <a href=\"https://www.cloudflare.com/\">https://www.cloudflare.com/</a> . You can set up naked domain, just add <code class=\"highlighter-rouge\">CNAME</code>\nwith name <code class=\"highlighter-rouge\">@</code> (or you <code class=\"highlighter-rouge\">domain.com</code>) and value <code class=\"highlighter-rouge\">Endpoint</code>.</li>\n    </ul>\n  </li>\n</ol>\n\n<h1 id=\"region-problems\">Region problems</h1>\n\n<ul>\n  <li>\n    <p><a href=\"/2016/03/02/gulp-tasks/\">gulp aws-publish</a> for non us-east-1\n(for example eu-central-1, southeast-1) problems arise for bucket name with\ndot. Single world like\n<a href=\"http://duleorlovic-test-southeast-1.s3-website-ap-southeast-1.amazonaws.com/\">http://duleorlovic-test-southeast-1.s3-website-ap-southeast-1.amazonaws.com/</a>\nworks fine. Also multiple words on us-east-1 region works fine. Solution is to\nuse param <code class=\"highlighter-rouge\">var publisher = awspublish.create({region:\nprocess.env.AWS_REGION...</code> and <code class=\"highlighter-rouge\">export AWS_REGION=ap-southeast-1</code>. It seems\nthat region can be us-east-1 in other cases (for example it works for single\nword southeast and region us-east-1)</p>\n  </li>\n  <li>\n    <p>ng-s3upload than if your bucket name contains only one word (for example\n<a href=\"https://duleorlovic-test-us-east-1.s3.amazonaws.com/\">https://duleorlovic-test-us-east-1.s3.amazonaws.com/</a>) than you can upload\nfiles with ng-s3upload but if it contains multiple\n(<a href=\"https://assets.test.trk.in.rs.s3.amazonaws.com/\">https://assets.test.trk.in.rs.s3.amazonaws.com/</a>) than there is\n<code class=\"highlighter-rouge\">ng-s3upload.js:135 OPTIONS https://assets.test.trk.in.rs.s3.amazonaws.com/\nnet::ERR_INSECURE_RESPONSE</code> error.</p>\n  </li>\n</ul>\n\n<h1 id=\"cors\">CORS</h1>\n\n<p>Sometime you need to upload files <a href=\"/2015/12/24/ionic-direct-aws-s3-upload/\">directly on S3</a> which means that our\njavascript code needs to send data but browser prevents with this error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>XMLHttpRequest cannot load\nhttps://duleorlovic-test-southeast-1.s3.amazonaws.com/. Response to preflight\nrequest doesn't pass access control check: No 'Access-Control-Allow-Origin'\nheader is present on the requested resource. Origin 'http://localhost:9000' is\ntherefore not allowed access. The response had HTTP status code 403.\n</code></pre></div></div>\n\n<p>We need to go Bucket -&gt; Properties -&gt; Permissions -&gt; Add Cors configuration and\nadd <code class=\"highlighter-rouge\">&lt;AllowedMethod&gt;POST&lt;/AllowedMethod&gt;</code> and <code class=\"highlighter-rouge\">&lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;</code>\nto the provided example:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;CORSConfiguration&gt;\n    &lt;CORSRule&gt;\n        &lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;\n        &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;\n        &lt;AllowedMethod&gt;POST&lt;/AllowedMethod&gt;\n        &lt;MaxAgeSeconds&gt;3000&lt;/MaxAgeSeconds&gt;\n        &lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;\n    &lt;/CORSRule&gt;\n&lt;/CORSConfiguration&gt;\n</code></pre></div></div>\n\n<p>This error also occurs when we mismatch bucket_name or region. To test if bucket\nis working, follow the link from the error.</p>\n\n<p>Note that only one host or all hosts <code class=\"highlighter-rouge\">*</code> can be defined. You can not allow two\nhosts.</p>\n\n<h1 id=\"tools\">Tools</h1>\n\n<p>Firefor plugin <a href=\"https://www.youtube.com/watch?v=L1cqzEYYUB0\">S3Fox</a> firefox\norganizer is great since you can access specific buckets.</p>\n\n<p>To check your DNS you can use linux command <code class=\"highlighter-rouge\">host</code>:</p>\n\n<ul>\n  <li>host frankfurt.trk.in.rs</li>\n</ul>\n\n<h1 id=\"aws-sdk\">aws-sdk</h1>\n\n<p>You can use aws-sdk for simple uploading\n<a href=\"https://github.com/duleorlovic/securiPi/blob/master/s3.rb\">https://github.com/duleorlovic/securiPi/blob/master/s3.rb</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># you can override global config\nAws.config.update(\n  credentials: Aws::Credentials.new(credentials[:aws_access_key_id], credentials[:aws_secret_access_key]),\n)\n\n# if bucket is from different region than you will get error like\n# ActionView::Template::Error (The bucket you are attempting to access must be addressed using the specified endpoint. Please send all future requests to this endpoint.):\n\n# or use s3 directly\ns3 = Aws::S3::Resource.new region: credentials[:aws_region]\nbucket = s3.bucket credentials[:aws_bucket_name]\nbucket.objects(prefix: 'assets').map {|o| o.public_url}\n</code></pre></div></div>\n\n<h1 id=\"aws-cli\">AWS CLI</h1>\n\n<p>https://aws.amazon.com/cli/</p>\n\n<p>If you export keys, cli will use that\nhttps://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html</p>\n\n<h1 id=\"elastic-beanstalk\">Elastic Beanstalk</h1>\n\n<p>https://aws.amazon.com/cli/\nUsing EB client you need to add permissions for AWSElasticBeanstalkFullAccess\nfor AWS keys in your env</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo pip install awsebcli\neb init\neb create myapp-env\neb setenv SECRET_KEY_BASE=`rake secret`\neb printenv\neb logs\neb deploy\neb status\neb open\n</code></pre></div></div>\n\n<p>Rails sqlite database can’t be shared between instances (event when we just\ndeploy the code). Adding database is one click. Just use proper env var names:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/database.yml\ndefault: &amp;default\n  adapter: postgresql\n  encoding: unicode\n  database: &lt;%= ENV['RDS_DB_NAME'] %&gt;\n  username: &lt;%= ENV['RDS_USERNAME'] %&gt;\n  password: &lt;%= ENV['RDS_PASSWORD'] %&gt;\n  host: &lt;%= ENV['RDS_HOSTNAME'] %&gt;\n  port: &lt;%= ENV['RDS_PORT'] %&gt;\n</code></pre></div></div>\n\n<h1 id=\"admin-access\">Admin access</h1>\n\n<p>You can create users and attach AdministratorAccess (Resource *) and create\npassword so they can login in on app url like: <code class=\"highlighter-rouge\">https://123123.signin.aws.amazon.com/console</code>.</p>\n\n<h1 id=\"errors\">Errors</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">NoSuchKey</code> 404 Not Found error is when you remove <code class=\"highlighter-rouge\">index.html</code> and enable\nstatic website hosting with index document <code class=\"highlighter-rouge\">index.html</code></li>\n</ul>\n\n<h1 id=\"paperclip\">Paperclip</h1>\n\n<p>You can use presigned url if you want S3 links to expire, in paperclip it was\nusing <code class=\"highlighter-rouge\">attachment.expiring_url</code>\nhttps://www.rubydoc.info/github/thoughtbot/paperclip/Paperclip%2FStorage%2FS3:expiring_url\nWhen uploading PDF in paperclip there is rails validation error because of\nimagemagic <code class=\"highlighter-rouge\">Paperclip::Errors::NotIdentifiedByImageMagickError</code> fix is to update\nlocal <code class=\"highlighter-rouge\">sudo vi /etc/ImageMagick-6/policy.xml</code> and add <code class=\"highlighter-rouge\">read|write</code>\nhttps://github.com/thoughtbot/paperclip/issues/2223#issuecomment-428862815</p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>blog https://alestic.com/</li>\n</ul>\n\n"
    } ,
  
    {
      "title"    : "Zoneminder security server and Raspberry Pi home automation",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/02/21/zoneminder-security-server-raspberry-pi-home-automation-arduino/",
      "date"     : "2016-02-21 00:00:00 +0100",
      "content"  : "<h1 id=\"rpi\">RPi</h1>\n\n<p>On my board PCB says: <code class=\"highlighter-rouge\">Raspberry Pi (c)2011.12</code> so <a href=\"http://www.raspberry-projects.com/pi/pi-hardware/raspberry-pi-pcb-versions\">it\nis</a>\nPi 1 Model B Revision 2.0 (512MB).\n<code class=\"highlighter-rouge\">cat /proc/cpuinfo</code> says it is Hardware revision 000e.</p>\n\n<p>Start with <a href=\"https://www.raspberrypi.org/downloads/noobs/\">NOOBS</a> (which is based\non Raspbian) to create SD card.\n<a href=\"https://www.raspberrypi.org/documentation/installation/noobs.md\">Instructions</a>\nsays to run <code class=\"highlighter-rouge\">gparted</code> and format as FAT32. Another way is using <a href=\"http://qdosmsq.dunbar-it.co.uk/blog/2013/06/noobs-for-raspberry-pi/\">dunbar\ninstructions</a> <code class=\"highlighter-rouge\">fdisk -l</code> to find your card mount point. then</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo fdisk /dev/mmcblk0\n# d -&gt; 1 to delete partitions\n# n to create partition (use default values)\n# t -&gt; b to set FAT32 format\n# p to print current configuration\n# w to write partition table to disc\n\n# format card\nsudo mkfs.vfat /dev/mmcblk0p1\n</code></pre></div></div>\n\n<p>Than just extract zip to the card.</p>\n\n<p>On MAC download “SD Memory Card formatter” and do formating. Than extract and\ncopy all content from NOOBS_v2_7_0 folder to the root of the card.</p>\n\n<p>NOOBS will ask which OS you want to install. If you preferr to have ready to go\nsd card, than download <a href=\"https://www.raspberrypi.org/downloads/raspbian/\">RASPBIAN STRETCH\nLITE</a>.</p>\n\n<p>On Mac use Etcher https://etcher.io/ and select zip and sd card and click Flash.\nWhen installing Raspian it took around 20mins to extract 4.138MB (speed 2MB/s).\nOn another C10 cards:\nKingston 16GB MicroSD HC C10 SDC10/16GB speed is 9.9MB/s and\nScanDisk Ultra 32GB 10 UHS I speed is 15MB/s\nso 2018-06-27-raspbian-stretch-lite.zip (367MB, uncompressed in Etcher says it\nis 1.86GB) took only few mins.</p>\n\n<p>Create empty file <code class=\"highlighter-rouge\">ssh</code> in the root of sd card (now sd card has name <code class=\"highlighter-rouge\">boot</code>) so\nthan ssh will be enabled and you do not need mouse and monitor, just find ip\naddress and ssh to it.</p>\n\n<p>Run <code class=\"highlighter-rouge\">sudo raspi-config</code> in console or find in Top Left Icon -&gt; Preferences -&gt;\nRaspberry Pi Coonfiguration -&gt; Tab System.\nIf you install Desktop version of Raspbian than change <code class=\"highlighter-rouge\">Boot</code> options to <code class=\"highlighter-rouge\">To\nCli</code> instead of <code class=\"highlighter-rouge\">To Desktop</code>, (in raspi-config set to <code class=\"highlighter-rouge\">B1 Consolle Autologin</code>).\nIf you want to enable Desktop again, run <code class=\"highlighter-rouge\">startx</code> when you are logged in and\nattached keyboard (can not run startx remotelly from ssh). Note that startx is\nnot available in lite stretch, but you can install with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install --no-install-recommends xserver-xorg xinit raspberrypi-ui-mods\n# also to start chromium in kiosk mode\nsudo apt-get install chromium-browser\nstartx /usr/bin/chromium-browser http://www.google.com/ --window-size=1920,1080 --start-fullscreen --kiosk --\n</code></pre></div></div>\n\n<p>You can see current value when you select for example <code class=\"highlighter-rouge\">5 Interfacing Options</code> -&gt;\n<code class=\"highlighter-rouge\">P7 1-Wire</code> -&gt; <code class=\"highlighter-rouge\">Would you like the one-wire interface to be enabled?</code> and\ncurrent focused value <code class=\"highlighter-rouge\">&lt;Yes&gt;</code> or <code class=\"highlighter-rouge\">&lt;No&gt;</code> is current value.</p>\n\n<p>If you did not enable ssh with <code class=\"highlighter-rouge\">touch ssh</code> on the root sd card, than enable on\ntab Interfaces (in raspi-config Interfacing Options -&gt; P2 SSH) enable SSH.</p>\n\n<p>Find ip address with <code class=\"highlighter-rouge\">nmap 192.168.0.-</code>. Connect from your desktop <code class=\"highlighter-rouge\">ssh\npi@192.168.0.11</code> (password raspberry).</p>\n\n<p>If something is not working than check\n<code class=\"highlighter-rouge\">/etc/network/interfaces</code> and <code class=\"highlighter-rouge\">/etc/dhcpcd.conf</code> (you can manually get dns with\n<code class=\"highlighter-rouge\">sudo dhclient eth0</code>).</p>\n\n<p>Set up static IP address using GUI, right click on Network Icon -&gt; Wireless and\nwired network setting -&gt; Configure Interface -&gt; Select eth0 -&gt; IPv4 address <code class=\"highlighter-rouge\">192.168.2.6</code>, disable IPv6, Router <code class=\"highlighter-rouge\">192.168.2.1</code> DNS servers <code class=\"highlighter-rouge\">8.8,8,8</code>.\nor using command line edit <code class=\"highlighter-rouge\">/etc/dhcpcd.conf</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/dhcpcd.conf\ninterface eth0\ninform 192.168.2.6\nstatic routers=192.168.2.1\nstatic domain_name_servers=8.8.8.8\nnoipv6\n</code></pre></div></div>\n\n<p>Leave <code class=\"highlighter-rouge\">/etc/network/interfaces</code> as default.\nSome posts about all network configuration that you need to know\nhttps://raspberrypi.stackexchange.com/questions/37920/how-do-i-set-up-networking-wifi-static-ip-address/74428#74428\nhttps://wiki.debian.org/NetworkConfiguration\nhttps://wiki.debian.org/NetworkManager</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># find ip address and network mask\nip -4 addr show | grep global\n#    inet 192.168.2.6/24 brd 192.168.2.255 scope global eth0\n\n# find default route\nip route | grep default | awk '{print $3}'\n# 192.168.2.1\n\n# find dns server (usually same as router)\ncat /etc/resolv.conf\n# nameserver 8.8.8.8\n# /etc/resolv.conf is overwritten by resolvconf, network-manager and other dhcp\n# clients.\n\n# list interfaces even they are not connected\nls /sys/class/net/\n\n# to set static ip address you can edit either /etc/dhcpcd.conf\ninterface eth0\n   static ip_address=192.168.2.6/24\n   static routers=192.168.2.1\n   static domain_name_servers=192.168.2.1\n\n# or edit /etc/network/interfaces\nauto eth0\niface eth0 inet static\n        address 192.168.2.6\n        netmask 255.255.255.0\n        gateway 192.168.2.1\n\n</code></pre></div></div>\n\n<p>Copy ssh keys with <code class=\"highlighter-rouge\">ssh-copy-id pi@192.168.0.11</code>.</p>\n\n<p>Check internet connection with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>host google.com\nping http://www.google.com\n</code></pre></div></div>\n\n<h1 id=\"ruby\">Ruby</h1>\n\n<p>Check if ruby is already installed in latest Raspian.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install ruby\n# this is needed for eventmachine gem\nsudo apt-get install ruby-dev\nruby -v\n</code></pre></div></div>\n\n<p>Use ligth <a href=\"/2018/05/31/sinatra/\">sinatra framework</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo gem install bundler\ncat &gt; Gemfile &lt;&lt; HERE_DOC\nsource 'https://rubygems.org'\n\ngem 'sinatra'\ngem 'sinatra-param'\ngem 'pi_piper'\nHERE_DOC\n\nbundle\n# I got error installing gems\n# mkmf.rb can't find header files for ruby at /usr/lib/ruby/include/ruby.h\nsudo apt-get install ruby-dev\n\n# I got error\n# project.h:116:25: fatal error: openssl/ssl.h: No such file or directory\ngem install eventmachine -- --with-cppflags=-I/usr/local/opt/openssl/include\n\n# update your Gemfile to include installed eventmachine\n# gem 'eventmachine', '1.2.5'\n\nbundle\n</code></pre></div></div>\n\n<p><a href=\"https://rvm.io/rvm/install\">rvm</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3\n\\curl -sSL https://get.rvm.io | bash\nrvm install 2.3.0\n</code></pre></div></div>\n\n<p>This takes too much time, so you can revert to</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install ruby ruby1.9.1-dev libssl-dev\nsudo gem install pi_piper\n</code></pre></div></div>\n\n<h1 id=\"pipiper\">PiPiper</h1>\n\n<p>In irb</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rvmsudo irb\nrequire 'pi_piper'\npin = PiPiper::Pin.new(pin: 17, direction: :in)\npin.read\n</code></pre></div></div>\n\n<p>Errors</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/var/lib/gems/2.3.0/gems/pi_piper-1.3.2/lib/pi_piper/pin.rb:24:in `initialize': Permission denied @ rb_sysopen - /sys/class/gpio/gpio11/direction (Errno::EACCES)\n# you need to run as root\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/var/lib/gems/2.3.0/gems/pi_piper-1.3.2/lib/pi_piper/pin.rb:23:in `close': Device or resource busy @ fptr_finalize - /sys/class/gpio/export (Errno::EBUSY)\n\n# you need to open pin port again, but before that you need to release\n# https://github.com/jwhitehorn/pi_piper/issues/30\nFile.open(\"/sys/class/gpio/unexport\", \"w\") { |f| f.write(\"#{pin.pin}\") }\n# or\ngpio unexportall\n# to see all used pins\ngpio exports\n</code></pre></div></div>\n\n<h1 id=\"bash\">Bash</h1>\n\n<p><a href=\"https://raspberrypi-aa.github.io/session2/bash.html\">https://raspberrypi-aa.github.io/session2/bash.html</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>#   Exports pin to userspace\necho \"18\" &gt; /sys/class/gpio/export\n\n# Sets pin 18 as an output\necho \"out\" &gt; /sys/class/gpio/gpio18/direction\n\n# Sets pin 18 to high\necho \"1\" &gt; /sys/class/gpio/gpio18/value\n\n# Sets pin 18 to low\necho \"0\" &gt; /sys/class/gpio/gpio18/value\n</code></pre></div></div>\n\n<h1 id=\"wiringpi\">WiringPi</h1>\n\n<p>http://wiringpi.com/download-and-install/</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install wiringpi\n</code></pre></div></div>\n\n<p><a href=\"https://projects.drogon.net/raspberry-pi/wiringpi/the-gpio-utility/\">https://projects.drogon.net/raspberry-pi/wiringpi/the-gpio-utility/</a></p>\n\n<p><a href=\"http://www.raspberrypi-spy.co.uk/2012/06/simple-guide-to-the-rpi-gpio-header-and-pins/#prettyPhoto\">Pinouts</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gpio readall\n# for pin number with gpio we use wPi numbers so instead PIN 26 use 11\n# for pi_piper we use BCM (GPIO NUMBERS like GPIO07 for pin 26)\n# http://www.raspberrypi-spy.co.uk/2012/06/simple-guide-to-the-rpi-gpio-header-and-pins/#prettyPhoto\n\ngpio mode 11 out\n# same as -g 7\n# gpio -g mode 7 out\ngpio write 11 1\n\n# pull up resistor\ngpio mode 12 up\n</code></pre></div></div>\n\n<p>Dallas DS18B20 temperature sensor. Connect to pin BCM 4, wPi 7, Phusical 7 and\nuse one pull up resistor. Reading is from file.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo vi /boot/config.txt\ndtoverlay=w1-gpio\nsudo reboot\nsudo modprobe w1-gpio\nsudo modprobe w1-therm\ncd /sys/bus/w1/devices\nls\ncd 28-xxxx (change this to match what serial number pops up)\ncat w1_slave\n</code></pre></div></div>\n\n<h1 id=\"startup-run\">Startup run</h1>\n\n<p>This somehow does not work</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/rc.local\nsudo ruby /home/pi/home_automation/app.rb -e production\n</code></pre></div></div>\n\n<p>so I use  <code class=\"highlighter-rouge\">~/.bash_profile</code> and with <code class=\"highlighter-rouge\">sudo raspi-config</code> enable option Boot to\nCLIE Autologin, Create <code class=\"highlighter-rouge\">~/.bash_profile</code> with this line:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># -E is needed if you want to pass env varables to sudo command\nsudo -E ruby /home/pi/home_automation/app.rb -e production\n# source $HOME/securiPi/start.sh\n</code></pre></div></div>\n<p>Note that this will be executed for each ssh login and it will be exited when\nyou disconnect from ssh session.</p>\n\n<p>We use prefix <code class=\"highlighter-rouge\">rvm</code> so <code class=\"highlighter-rouge\">rvmsudo</code> pass that env variable to\n<a href=\"https://github.com/rvm/rvm/blob/master/bin/rvmsudo#L84\">child</a> and unbuffer so\nwe can read long and not wait buffer to fill in. For this command we need to\n<code class=\"highlighter-rouge\">sudo apt-get install expect-dev</code>.</p>\n\n<h1 id=\"mozilla-things\">Mozilla Things</h1>\n\n<p>https://hacks.mozilla.org/2018/02/how-to-build-your-own-private-smart-home-with-a-raspberry-pi-and-mozillas-things-gateway/\nDownload img and flash to sd card.\nOnce booted up and connected to the lan, you can connect <gateway.local> or find\nip address and go &lt;http://192.168.2.111/wifi-setup&gt;</gateway.local></p>\n\n<p>https://hacks.mozilla.org/2018/02/making-a-clap-sensing-web-thing/</p>\n\n<h1 id=\"webpack\">Webpack</h1>\n\n<p>Follow <a href=\"/2016/04/20/bundler-bower-gulp-npm-yarn-webpack-tips/\">Webpack</a></p>\n\n<h1 id=\"home-automation\">Home automation</h1>\n\n<p>automation\nhttps://github.com/sjmog/ralyxa</p>\n\n<h1 id=\"disk-errors\">Disk errors</h1>\n\n<p>If you get <code class=\"highlighter-rouge\">Kernel panic - not syncing: VFS: Unable to mount root fs on\nunknown-block</code> that meens SD card is corrupted. Try to recover with the <code class=\"highlighter-rouge\">fsck</code>\ncommand on your ubuntu machine. Find your root partition of your sd card  using\n<code class=\"highlighter-rouge\">gnome-disks</code>. Click on root Partition 7, and than on STOP icon to unmount it.\nThan run in console (it could take 10 minutes):</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo fsck.ext4 -fy /dev/sdc7\n</code></pre></div></div>\n\n<h1 id=\"program-attiny\">Program Attiny</h1>\n\n<p><a href=\"http://highlowtech.org/?p=1695\">highlowtech</a> tutorial suggest to add board\nmanager\n<a href=\"https://raw.githubusercontent.com/damellis/attiny/ide-1.6.x-boards-manager/package_damellis_attiny_index.json\">https://raw.githubusercontent.com/damellis/attiny/ide-1.6.x-boards-manager/package_damellis_attiny_index.json</a></p>\n\n<p>Another installation is downloading to hardware folder.\nhttps://github.com/SpenceKonde/ATTinyCore</p>\n\n<h1 id=\"poe-power-over-ethernet\">POE power over ethernet</h1>\n\n<p>From left to right, when you hold lan cable and look at pins (T568A color)\npinouts. B variant is when orange and green are swapped.\n<strong>Crossover cable</strong> is when on one side is A and on other is B variant and it is\nused to connect two computers directly. When you connect computer to switch than\nuse straight through cable (on both side is same variant).</p>\n\n<ul>\n  <li>1 White green</li>\n  <li>2 Green</li>\n  <li>3 White organge</li>\n  <li>4 Blue (DC-)</li>\n  <li>5 White blue (DC-)</li>\n  <li>6 Orange</li>\n  <li>7 White brown (DC+)</li>\n  <li>8 Brown (DC+)</li>\n</ul>\n\n<p>https://en.m.wikipedia.org/wiki/Ethernet_extender\nEthernet range is 100m, but you can use some devices to extend that range\nhttp://www.veracityglobal.com/products/ethernet-and-poe-devices/outreach-lite.aspx\nIt is powered with POE and it can deliver POE to the other end.</p>\n\n<p>ixl6009 https://electronics.stackexchange.com/questions/113253/voltage-drop-and-safe-current-load-on-cat5-cable</p>\n\n<h1 id=\"zoneminder\">Zoneminder</h1>\n\n<p><a href=\"http://zoneminder.readthedocs.io/en/latest/installationguide/ubuntu.html#easy-way-ubuntu-16-04\">Installation</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>su\nadd-apt-repository ppa:iconnor/zoneminder\napt-get update\napt-get upgrade\napt-get dist-upgrade\napt-get install zoneminder\n\necho \"sql_mode = NO_ENGINE_SUBSTITUTION\" &gt;&gt; /etc/mysql/mysql.conf.d/mysqld.cnf\nsystemctl restart mysql\n\nchmod 740 /etc/zm/zm.conf\nchown root:www-data /etc/zm/zm.conf\nchown -R www-data:www-data /usr/share/zoneminder/\n\na2enconf zoneminder\na2enmod cgi\na2enmod rewrite\n\nsystemctl enable zoneminder\nsystemctl start zoneminder\n\nsed -i /etc/php/7.0/apache2/php.ini -e '/\\[Date\\]/a \\\ndate.timezone = Europe/Belgrade'\n\nsystemctl reload apache2\n</code></pre></div></div>\n\n<p><a href=\"http://localhost/zm/api/host/getVersion.json\">http://localhost/zm/api/host/getVersion.json</a> should return version.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\"version\":\"1.30.2\",\"apiversion\":\"1.0\"}\n</code></pre></div></div>\n\n<p>Motion recording works but can not see stream. Error in log</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Socket /var/run/zm/zms-153908s.sock does not exist. This file is created by zms, and since it does not exist, either zms did not run, or zms exited early. Please check your zms logs and ensure that CGI is enabled in apache and check that the PATH_ZMS is set correctly. Make sure that ZM is actually recording. If you are trying to view a live stream and the capture process (zmc) is not running then zms will exit. Please go to http://zoneminder.readthedocs.io/en/latest/faq.html#why-can-t-i-see-streamed-images-when-i-can-see-stills-in-the-zone-window-etc for more information.\n</code></pre></div></div>\n\n<p>One fix for\n<a href=\"https://forums.zoneminder.com/viewtopic.php?t=24265\">ubuntu</a></p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>(Web interface) Options, paths, and update PATH_ZMS from \"/cgi-bin/nph-zms\" to \"/zm/cgi-bin/nph-zms\"\n\nThat should match in /etc/apache2/conf-available/zoneminder.conf\n#ScriptAlias /zm/cgi-bin \"/usr/lib/zoneminder/cgi-bin\"\n\nsudo service apache2 restart\nsudo service zoneminder restart\n</code></pre></div></div>\n\n<p>To change apache port to 81 you can change:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/apache2/sites-enabled/000-default.conf\n&lt;VirtualHost *:81&gt;\n\n# /etc/apache2/ports.conf\nListen 81\n</code></pre></div></div>\n\n<p>Error ‘Failed to open video device /dev/video0: Permission denied’</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>adduser www-data video\nusermod -a -G video www-data\n\n# chmod is not needed\n# sudo chmod 777 /dev/video*\n\nsudo reboot\n</code></pre></div></div>\n\n<p>To trigger some functions you can run script with\n<a href=\"https://forums.zoneminder.com/viewtopic.php?t=24494\">patch</a></p>\n\n<p>or event server as in ZMNinja</p>\n\n<p>You can export images for event: Export -&gt; check Export Image Files and check\nExport File Format Tar. When you extract you can create video file with command:\n<code class=\"highlighter-rouge\">ffmpeg -i %05d-capture.jpg output.mp4</code></p>\n\n<p>Zoneminder service starts automatically using <code class=\"highlighter-rouge\">/etc/init.d/zoneminder</code>.\nIf you want to prevent automatical start on boot, you can disable using:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo update-rc.d zoneminder remove\n</code></pre></div></div>\n\n<h2 id=\"zoneminder-errors-and-logs\">Zoneminder Errors and Logs</h2>\n\n<p>Watch logs</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>tail -f /var/log/syslog\ntail -f /var/log/apache2/*\ntail -f /var/log/mysql/*\n</code></pre></div></div>\n\n<p>If you see error:</p>\n\n<p>An error has occurred and this operation cannot continue.\nFor full details check your web logs for the code ‘F88AB7’</p>\n\n<p>https://forums.zoneminder.com/viewtopic.php?t=12997</p>\n\n<p>It is probably some error in database, like</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[Fri Jan 25 12:25:52 2019] [error] [client 192.168.1.8] SQL-ERROR(BDC154): Table './zm/Events' is marked as crashed and last (automatic?) repair failed\n\n[Fri Jan 25 12:25:52 2019] [error] [client 192.168.1.8] PHP Warning:  Unknown: open(/var/lib/php5/sess_31rbb6unk3hhraifv94pfqgci1, O_RDWR) failed: No space left on device (28) in Unknown on line 0\n</code></pre></div></div>\n\n<p>I got this error because no space left on device, specifically inodes.\nSo I removed some files and repair mysql.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get autoremove\nrm -rf /var/cache/zoneminder/*\n</code></pre></div></div>\n\n<p>Remove all data from zm with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mysql -u root -p zm\ntruncate table Logs;\ntruncate table Frames;\ntruncate table Events;\n</code></pre></div></div>\n\n<h2 id=\"zones\">Zones</h2>\n\n<p><a href=\"https://wiki.zoneminder.com/Understanding_ZoneMinder's_Zoning_system_for_Dummies\">wiki</a>\nhas example. Use small zone for far distances so percentage is same.</p>\n\n<ul>\n  <li>set A is full zone pixels</li>\n  <li>set B is Min/Max pixel Threshold: difference in color from previous\n    <ul>\n      <li><em>Min/Max Alarmed Area</em>: check if set B is at least/most of set A in %\nI used max 50% since a car is less than that.</li>\n    </ul>\n  </li>\n  <li>set C is Filter Width/Height: check if 3x3 surround pixels (from set B) is\nalso different in colors\n    <ul>\n      <li><em>Min/Max Filtered Area</em>: check if C cover min/max of set A in %</li>\n    </ul>\n  </li>\n  <li>set D is <em>Min/Max Blobs</em>: number of blobs\n    <ul>\n      <li><em>Min/Max Blob area</em>: check if cover at least/most of set A in %</li>\n    </ul>\n  </li>\n</ul>\n\n<p>To eliminate sun shadow, you can lower the <em>Max Alarmed Area</em> (50%) and use\n<em>Overload Frame Ignore Count</em> to ignore next 3 frames in that case of overload.</p>\n\n<p>To eliminate camera glitches, you can set in tab Source -&gt; Monitor -&gt; Buffers -&gt;\nAlarm Frame Count to 2.</p>\n\n<p>To eliminate false alarm when half of the image is triggered than use <em>Max\nAlarmed Area</em> to 50% or less.</p>\n\n<p>Also you can set Preclusive zone so if sun or ir light triggers alarm on\npreclusive zone it will disable alarm in active zone.</p>\n\n<p>Also you are using old camera in snapshot mode, zoneminder is pulling for new\nimages, you should limit Analysis FPS, Maximum FPS, and Alarm Maximum FPS in\nSource -&gt; Monitor -&gt; General tab</p>\n\n<p>You can see stats by clicking Frames -&gt; last column is Score (on stills you can\nsee only score on hover). For example:</p>\n\n<table>\n  <tbody>\n    <tr>\n      <td>Zone</td>\n      <td>Pixel Diff</td>\n      <td>Alarm Px</td>\n      <td>Filter Px</td>\n      <td>Blob Px</td>\n      <td>Blobs</td>\n      <td>Blob Sizes</td>\n      <td>Alarm Limits</td>\n      <td>Score</td>\n    </tr>\n    <tr>\n      <td>All</td>\n      <td>67</td>\n      <td>437 (5%)</td>\n      <td>97629 (5%)</td>\n      <td>96123 (5%)</td>\n      <td>1</td>\n      <td>96123 (5%)</td>\n      <td>813,0-1306,269</td>\n      <td>5</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>In filter window you can see Max score frame (last column)</p>\n\n<p>To enable authentication and admin password go to options -&gt; System -&gt;\nOPT_USE_AUTH checked. Default is admin/admin.</p>\n\n<p>To change password use:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mysql -u root -p\nuse zm\nupdate Users set Password=PASSWORD(\"admin\") where Username=\"admin\";\n</code></pre></div></div>\n\n<h1 id=\"pci-cards\">PCI Cards</h1>\n\n<p>PICO200 https://wiki.zoneminder.com/Pico2000\nPICO2000 is a quad camera input PCI card. The card uses a single Conexant 878A\nchip. In addition, some models have 1 audio input jack; it has not been tested\nwith ZoneMinder.  30 FPS (degrades as the channels are utilized; expect ~2 FPS\nwith all four channels capturing)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/modprobe.conf\noptions bttv card=77 tuner=4 radio=0 triton1=0 vsfx=0 autoload=0\n</code></pre></div></div>\n\n<p>Bt878 4chip https://wiki.zoneminder.com/Bt878_4chip_8inputs</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>dmesg | grep video\ndmesg | grep bttv\n\n[   21.257789] bttv: Bt8xx card found (0)\n[   21.258002] bttv: 0: Bt878 (rev 17) at 0000:01:01.0, irq: 17, latency: 32, mmio: 0xf8601000\n[   21.258045] bttv: 0: using:  *** UNKNOWN/GENERIC ***  [card=0,autodetected]\n[   27.728037] bttv: 0: tuner type unset\n[   27.735284] bttv: 0: registered device video0\n[   27.737522] bttv: 0: registered device vbi0\n\n</code></pre></div></div>\n\n<h1 id=\"china-ip-cam\">China IP cam</h1>\n\n<p>When I look at the source I see</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var g_SoftWareVersion=\"V4.02.R12.00006531.10010.143300.00000\";\nvar g_HardWareVersion=\"Unknown\";\nvar g_mBuildTime=\"2016/9/13 16:50:12\";\nvar g_SerialNo=\"fcccccdda05ad0a9\";\nvar g_VideoInChannel=1;\nvar g_AlarmInChannel=2;\nvar g_AlarmOutChannel=1;\nvar g_AudioInChannel=1;\nvar g_DigChannel=0;\n\n\nvar g_channelNumber=1;\nvar g_user=\"admin\";\nvar g_port=\"554\";\n var g_address =document.location.hostname;\n\nif (g_address == \"\")\n{\n//\tg_address = \"10.2.4.46\";\n}\n\nvar iLanguage=101;\nvar g_passWord=\"\";\n</code></pre></div></div>\n\n<p>So to set zoneminder you can use “ONVIF” link at the top or manually select:</p>\n\n<ul>\n  <li>Source Type -&gt; Ffmpeg</li>\n  <li>Source Path -&gt; rtsp://admin:@192.168.1.11:554/user=admin_password=tlJwpbo6_channel=1_stream=0.sdp?real_stream</li>\n  <li>Remote Method -&gt; TCP</li>\n  <li>Capture Width: 1280, Capture Height: 960</li>\n</ul>\n\n<p>ON/Vif gives some options: Main stream H264 1920x1080 @ 30fps, secondStream\n720x480 @ 30fps, thirdStream 352x288 @ 15fps</p>\n\n<p>IPC-Model vendor is H264DVR, media port 34567, IP address: 192.168.1.11.\nYou can search, just type 192.168.1. (blank). Or you do not need to type\naddress, it will find cameras on other subnet mask.\nYou can change ip with “EditDevice”</p>\n\n<p><img src=\"/assets/posts/china ip camera ip settings edit.png\" alt=\"search\" />\n<img src=\"/assets/posts/china ip camera ip settings edit address.png\" alt=\"search\" /></p>\n\n<h1 id=\"dahua-ip-cam\">Dahua IP Cam</h1>\n\n<p>IPC-HDW4300C Dahua IP dome 3MP Camera HDW4300C Built-in MIC Metal body POE CMOS IR 30m IK10 1080p IP66 security cctv Camera IPC-HDW4300C\nLens (mm):3.6mm\nDefault IP address for Dahua cameras is 192.168.1.108 media port 3777 MAC\n3c:ef:8c:a3:c9:6b, vendor Dahua, username: admin, password: admin. Also have\nRTSP port 554.</p>\n\n<p>Zoneminder ONVIF rtsp://admin:admin@192.168.3.5:554/cam/realmonitor?channel=1&amp;subtype=0&amp;unicast=true&amp;proto=Onvif</p>\n\n<h1 id=\"ip-dom\">IP Dom</h1>\n\n<p>KIP-200SHT30H (on web page it shows Herospeed)\n<a href=\"http://www.elementa.rs/proizvod/57087/ip-dom-kamera\">http://www.elementa.rs/proizvod/57087/ip-dom-kamera</a>\nObjektiv: varifokalni, 2.8-12mm\nHorizontalni ugao vidljivosti: 21° do 81°\nYou need to 192.168.1.168 (maybe 192.168.1.9) and change admin/admin password to\nadmin dule…10.\nThan on configuration there is basic setup, to set up manual IP address.\nUnder System there is Time Settings to set TimeZone.</p>\n\n<p>KIP-200SH20H https://www.elementa.rs/proizvod/57086/ip-dom-kamera\nOn camera it shows Cantonk. Focus: 3.6mm, 68°\nDefault ip is 192.168.1.168 admin/admin.</p>\n\n<h1 id=\"china-ip-camera-23\">China IP camera $23</h1>\n\n<p><a href=\"https://www.aliexpress.com/item/JIENU-1280-960P-ip-camera-CCTV-Security-Home-Surveillance-Indoor-White-Dome-Mini-Ipcam-p2p-System/32828747430.html\">JIENU 1280*960P ip camera CCTV Security Home Surveillance Indoor White Dome Mini Ipcam p2p System Infrared HD Cam Support ONVIF</a></p>\n\n<p>Find camera ip address using <code class=\"highlighter-rouge\">nmap 192.168.2.-</code> or Zoneminder ON/VIF.\nConnect using Windows IE (install plugins, chose english, username: ‘admin’,\npassword: ‘’ empty)</p>\n\n<ul>\n  <li>set timezone</li>\n  <li>set fix ip address 192.168.3.6</li>\n</ul>\n\n<h1 id=\"china-mini-ip-camera-without-box\">China Mini IP camera without box</h1>\n\n<p>https://www.aliexpress.com/item/1280-720P-1-0-MP-1-3MP-Mini-IP-Camera-ONVIF-indoor-Plug-and-Play-support/32801033646.html?spm=a2g0s.9042311.0.0.27424c4dIrwbGp</p>\n\n<h1 id=\"lead-acid\">Lead acid</h1>\n\n<p>WP7.2 28W has a 7.2Ah on 12V. ie can provide 0.36A for 20h.</p>\n\n<p>Charging is limited to 2.4V per cell (6x2.4 = 14.4v for 12v battery). Current is\n10% of capacity, 0.1C (0.7A for 7Ah). Stop charging when current is below 3% of\ncapacity (0.21A for 7Ah), or after 16hours time (time to charge depends on\ncurrent, if it is 10% than it need 10 hours).\nSlow charging is 2.25V per cell (6x2.25 = 13.5V for 12v battery).\nBest option is to start with 14.4V and decrease to 13.5V when battery is full.\nBattery needs charge when it is below <strong>12.5V</strong> in open circuit. Battery is\nfully discarged when is it below 9.5V (do not go this far). Battery is around\n2.15V per cell when is fully charged <strong>12.91V</strong> for 12V battery. Wait for\n12hours after charging to measure open circuit.</p>\n\n<h1 id=\"solar-food-dehydrator\">Solar food dehydrator</h1>\n\n<p>https://www.youtube.com/results?search_query=solar+food+dehydrator</p>\n\n<h1 id=\"arduino\">Arduino</h1>\n\n<p>You can download old Arduino (ver 1.8) to Programs, or you can use from Ubuntu\n(ver 2.1).</p>\n\n<h2 id=\"arduino-makefile\">Arduino Makefile</h2>\n\n<p>I use Arduino Makefile to compile and flash to arduino https://github.com/sudar/Arduino-Makefile</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get install arduino-mk\n</code></pre></div></div>\n\n<p>It gives some files https://packages.ubuntu.com/xenial/all/arduino-mk/filelist\nI could ignore path to arduino dir since I used system arduino</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># ~/config/bashrc/arduino.sh\nexport ARDUINO_DIR=/usr/share/arduino\nexport ARDMK_DIR=/usr/share/arduino/\n</code></pre></div></div>\n\n<p>So for your project you have to define</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Makefile\nBOARD_TAG    = uno\nARDUINO_PORT = /dev/ttyACM0\ninclude $(ARDMK_DIR)/Arduino.mk\n</code></pre></div></div>\n<p>In vim you can run</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>make\nmake upload\nmake monitor\n# you can exit with Ctrl+C or Ctrl+A + K (and y)\nmake show_boards\n</code></pre></div></div>\n\n<p>To exit from serial monitor (screen or minicom, which I could not setup to work\nfrom makefile) you can <code class=\"highlighter-rouge\">Ctrl + A and than K and than Y</code></p>\n\n<h2 id=\"low-cost-tx-rx\">Low cost tx rx</h2>\n\n<p>VirtualWire works fine on ATMEGA Follow installation\nhttp://www.airspayce.com/mikem/arduino/VirtualWire/ and download zip and extract\nto <code class=\"highlighter-rouge\">sketchbook/libraries</code> in my case is <code class=\"highlighter-rouge\">/home/orlovic/Arduino/libraries</code>. Than\nyou can find examples of it: File -&gt; Examples -&gt; VirtualWire -&gt; transmitter\nPin 12 is for sending, Pin 11 for receiving.</p>\n\n<p>But since it is not updated I used Manchester http://mchr3k.github.io/arduino-libs-manchester/</p>\n\n<h1 id=\"default-passwords\">Default Passwords</h1>\n\n<p>Telekom: admin ztonpk</p>\n\n<h1 id=\"poe\">POE</h1>\n\n<h1 id=\"long-cable-on-battery-power\">Long cable on battery power</h1>\n\n<p>Mikrotik RB 750 use 90mA + 10ma for each port, so ~ 150mA when all cables are\nthere. There is no difference while there is a traffic or inactive network.</p>\n\n<p>Cheap china white ip camera spends 260mA if all diodes are on and streaming\n(253mA no streaming). During the day, witout IR diodes, it spends 100mA (87mA\nwhen there is no streaming).\nCheap china ip camera without box and ir diodes spends ~140mA.\nDahua IPC-HDW4631C-A spens 250mA without IR and 270mA with ID diodes.</p>\n\n<h1 id=\"stream\">Stream</h1>\n\n<p>You can open rtsp stream in vlc player.\nYou can stream inside html page using https://wiki.videolan.org/Documentation:WebPlugin</p>\n\n<p>but plugin is not supported any more https://forum.videolan.org/viewtopic.php?t=138044</p>\n\n<p>Alternative is https://github.com/Streamedian/html5_rtsp_player</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install git://github.com/Streamedian/html5_rtsp_player.git\n</code></pre></div></div>\n\n<p>To search for onvif devices in ruby you can use:\nhttps://github.com/Caldis/Ruby-Onvif/blob/master/examples/test_device_discovery.rb\nbased on https://github.com/jimxl/ruby-onvif-client</p>\n\n<p>To stream screen recordings you can download\nhttps://www.tightvnc.com/download.php vnc server (default configuration is\nenough). Run Server in Application Mode.</p>\n\n<h1 id=\"obs\">OBS</h1>\n<p>On computer that is connected to projector, run OBS project\nhttps://obsproject.com/ and add source “Window source”.\nYou can stream RTSP cameras by selecting “Media source” and unchecking “Local\nfile” and insert something like rtsp://admin:dusan10@192.168.3.6:554/user=admin_password=tlJwpbo6_channel=1_stream=1.sdp?real_stream\nSince changing scenes will disconnect and reconnect again, best way to switch\ncameras is to move to top (on mac it is fn + cmd + left).\nTo preview cameras you can use right click and “Windowed projector” so you can\nsee all three cameras in three windows.\nOn each source you should use “Transform” and “Strech to screen”. It is good to\nhave all cameras with same ratio width and height.</p>\n\n"
    } ,
  
    {
      "title"    : "Angular Material",
      "category" : "",
      "tags"     : "css, angular",
      "url"      : "/2016/02/19/angular-material/",
      "date"     : "2016-02-19 00:00:00 +0100",
      "content"  : "<ul>\n  <li><a href=\"https://material.angularjs.org/latest/demo/autocomplete\">md-autocomplete</a> to\nautomatically open, you need <code class=\"highlighter-rouge\">md-min-length=\"0\"</code></li>\n  <li>\n    <p>to align button to right you can insert <code class=\"highlighter-rouge\">&lt;span flex&gt;&lt;/span&gt;</code> before so it\ncovers the space before element, and wrap inside <code class=\"highlighter-rouge\">layout=\"row\"</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>div(layout=\"row\")\n  span(flex)\n  button\n</code></pre></div>    </div>\n\n    <p>Another approach is to use <code class=\"highlighter-rouge\">layout-align=\"end\"</code></p>\n  </li>\n  <li>\n    <p><a href=\"https://material.angularjs.org/1.0.4/api/directive/mdAutofocus\">md-autofocus</a>\nis nice tool to save users clicks, just add to attribude like <code class=\"highlighter-rouge\">&lt;input\nmd-autofocus=\"!vm.menuItem.name\"&gt;</code>. It works ONLY on <code class=\"highlighter-rouge\">$mdDialog</code>,\n<code class=\"highlighter-rouge\">$mdBottomSheet</code> and <code class=\"highlighter-rouge\">$mdSidenav</code></p>\n  </li>\n  <li>\n    <p><a href=\"https://material.angularjs.org/latest/api/directive/mdSelect\">md-select</a> and\n<code class=\"highlighter-rouge\">md-option</code> should have values inside quotes like\n<code class=\"highlighter-rouge\">md-option(ng-value=\"'delivery_only'\")</code></p>\n\n    <ul>\n      <li>use <code class=\"highlighter-rouge\">$scope.$watch 'vm.restaurantCart.pickUp'</code> instead of <code class=\"highlighter-rouge\">ng-click</code> since\nvalue is not yet updated in <code class=\"highlighter-rouge\">ng-click</code> hook</li>\n    </ul>\n  </li>\n  <li>\n    <p><a href=\"https://github.com/angular/material/issues/2829\">md-chips</a> does not work with\n<code class=\"highlighter-rouge\">ng-repeat</code>. You need to use md-chips api like</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;md-chips ng-model=\"ctrl.items\" readonly=\"true\"&gt;\n  &lt;md-chip-template&gt;\n      { {$chip.name}}\n  &lt;/md-chip-template&gt;\n&lt;/md-chips&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>if <code class=\"highlighter-rouge\">ng-messages</code> are shown before you interact with input, solution is to\nupdate angular-material by changing\n<code class=\"highlighter-rouge\">bower.json</code> file, replace the number with start <code class=\"highlighter-rouge\">\"angular-material\": \"*\",</code>\nand run <code class=\"highlighter-rouge\">bower update</code></p>\n  </li>\n  <li>\n    <p><a href=\"https://material.angularjs.org/latest/api/directive/mdToolbar\">md-scroll-shrink</a>\non md-toolbar does not work always, so use this\n<a href=\"http://codepen.io/mikkokam/pen/PqpZoN\">fix</a> to add outher wrapper</p>\n  </li>\n  <li>\n    <p>when you perfom server request on <code class=\"highlighter-rouge\">ng-click</code> (not on <code class=\"highlighter-rouge\">form(ng-submit)</code> than\nthere is an issue that validation message is not shown before user interacts\nwith that field.\nIdea to add <code class=\"highlighter-rouge\">button(type=\"submit\")</code> does not work for me since I don’t\nknow how to stop form from submit, since <code class=\"highlighter-rouge\">vm.save = (item, myForm) -&gt; return\nif myForm.$errors</code> don’t see errors.\nSolution is to use\n<code class=\"highlighter-rouge\">md-input-container(md-is-error=\"myForm.price.$error.server\")</code> so it will put\nthis container in error mode\n<a href=\"https://material.angularjs.org/latest/api/directive/mdInputContainer\">md-is-error</a></p>\n\n    <p>Another thing that could help is to add css:\n<a href=\"https://github.com/angular/material/issues/5837\">#5837</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>md-input-container.md-input-invalid ng-message {\n  opacity: 1 !important;\n}\n</code></pre></div>    </div>\n\n    <p>or in js by adding two attributes\n<a href=\"https://github.com/angular/material/issues/6767\">#6767</a> (animation stop working)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>md-messages md-auto-hide=\"false\" ng-if=\"myForm.myField.$touched\"\n</code></pre></div>    </div>\n\n    <p>Problematic validations are also shown if your use <code class=\"highlighter-rouge\">ng-if</code> instead of\n<code class=\"highlighter-rouge\">ng-show</code>.</p>\n  </li>\n  <li>\n    <p><a href=\"https://material.angularjs.org/latest/api/directive/mdDialog\">mdDialog</a> works\nfine (you can put <code class=\"highlighter-rouge\">form</code> element inside <code class=\"highlighter-rouge\">md-dialog</code>). You can open and wait\nfor results to resolve</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$mdDialog.show\n  controller: 'VerifyOrderController'\n  controllerAs: 'vm'\n  templateUrl: 'app/menu/verifyOrder.html'\n  locals:\n    restaurant: vm.restaurant\n.then(\n  (resp) -&gt;\n  (cancel) -&gt;\n)\n</code></pre></div>    </div>\n  </li>\n  <li>show hide attributes\n<a href=\"https://material.angularjs.org/latest/layout/options\">link</a> <code class=\"highlighter-rouge\">&lt;div\nhide-gt-sm&gt;</code> or <code class=\"highlighter-rouge\">&lt;div hide show-gt-sm&gt;</code></li>\n</ul>\n\n<h1 id=\"theme\">Theme</h1>\n\n<p>Material pick 4 colors (hues/shades) from palette: 500, 300, 800, A100 for\nprimary<code class=\"highlighter-rouge\"> and </code>warn<code class=\"highlighter-rouge\"> intentions, and A200, A100, A400, A700 for </code>accent<code class=\"highlighter-rouge\">\nintention.\n[link](https://material.angularjs.org/latest/Theming/03_configuring_a_theme)\n[video](https://design.google.com/videos/palette-perfect/).\nButton can have different intention with </code>md-primary md-accent md-warn<code class=\"highlighter-rouge\"> classes\nand you can pick slightly different variation with </code>md-hue-1 md-hue-2 md-hue-3`</p>\n"
    } ,
  
    {
      "title"    : "Javascript theory",
      "category" : "",
      "tags"     : "javascript",
      "url"      : "/2016/02/10/javascript-theory/",
      "date"     : "2016-02-10 00:00:00 +0100",
      "content"  : "<h1 id=\"closures\">Closures</h1>\n\n<p><a href=\"http://www.jibbering.com/faq/notes/closures/\">source</a></p>\n\n<blockquote>\n  <p>A closure is formed when one of those inner functions is made accessible\n outside of the function in which it was contained, so that it may be executed\n after the outer function has returned. At which point it still has access to\n the local variables, parameters and inner function declarations of its outer\n function.</p>\n</blockquote>\n\n<p>Nice example on\n<a href=\"https://en.wikipedia.org/wiki/Closure_(computer_programming)\">wiki</a>\nExample from\n<a href=\"http://stackoverflow.com/questions/643542/doesnt-javascript-support-closures-with-local-variables/643664#643664\">stackoverflow</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var closures = [];\nfunction create() {\n  for (var i = 0; i &lt; 5; i++) {\n    closures[i] = function() {\n      alert(\"i = \" + i);\n    };\n  }\n}\n\nfunction run() {\n  for (var i = 0; i &lt; 5; i++) {\n    closures[i]();\n  }\n}\n\ncreate();\nrun();\n</code></pre></div></div>\n\n<p>This will print 5,5,5,5,5 since at the time function is created it reference to\nvariable <code class=\"highlighter-rouge\">i</code>, but when function is called <code class=\"highlighter-rouge\">for</code> loop already set <code class=\"highlighter-rouge\">i</code> to 5. More\ncorrect is to call inner function when you define it</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function create() {\n  for (var i = 0; i &lt; 5; i++) {\n    closures[i] = (function(tmp) {\n        return function() {\n          alert(\"i = \" + tmp);\n        };\n    })(i);\n  }\n</code></pre></div></div>\n\n<p>Thats why <code class=\"highlighter-rouge\">do</code> exist in coffee script</p>\n\n<blockquote>\n  <p>When using a JavaScript loop to generate functions, it’s common to insert a\nclosure wrapper in order to ensure that loop variables are closed over, and\nall the generated functions don’t just share the final values. CoffeeScript\nprovides the do keyword, which immediately invokes a passed function,\nforwarding any arguments.</p>\n</blockquote>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>closures = []\ncreate -&gt;\n  for i in [0..5]\n    # instead of closuers[i] = -&gt;\n    closures[i] = do (i) -&gt;\n      -&gt; alert i\n</code></pre></div></div>\n\n<p>Here is example in ruby</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def create\n  r = []\n  # 1.upto 5 do |i| # this will print 1,2,3,4,5 since i is not shared between\n  for i in 1..5\n    r.push Proc.new { i }\n  end\n  r\nend\n\na = create\na.each {|f| puts f.call } # [5,5,5,5,5] since i is shared for all closures\n</code></pre></div></div>\n\n<h2 id=\"resolution-of-property-names-on-objects\">Resolution of property names on objects</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// assignment of values\nvar objectRef = new Object();\nobjectRef.testNumber = 5;\nobjectRef[\"testNumber\"] = 5;\n// reading of values\nalert(objectRef.testNumber);\n</code></pre></div></div>\n\n<p><a href=\"http://www.w3schools.com/js/js_object_prototypes.asp\">w3 prototypes</a></p>\n\n<blockquote>\n  <p>All JavaScript objects inherit their properties and methods from their\nprototype. The Object.prototype is on the top of the prototype chain.</p>\n</blockquote>\n\n<p><code class=\"highlighter-rouge\">prototype</code> property is on functions only. Prototype is an object.\nFunction by default have Object.prototype prototype object.\nWe can add properties to prototype object even after we create object.\nFunction is constructor function when we use it to create new objects and they\nare UpperCased. Object, Array, Date are function constructors.\nThe default prototype for the Object constructor has a null prototype.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function People(name) {\n  this.name = name;\n}\nfunction Man(car) {\n  this.car = car;\n}\nMan.prototype = new People('dule');\nvar p = new Man('renault');\nPeople.prototype.age = 30;\nMan.prototype.say = function() { return this.name + \" (\" + this.age +\n  \") drive \" + this.car;\n};\nalert(p.say()); // dule (30) drive renault\n</code></pre></div></div>\n\n<h2 id=\"identifier-resolution-execution-contexts-and-scope-chains\">Identifier resolution, execution contexts and scope chains</h2>\n\n<h3 id=\"intro\">Intro</h3>\n\n<p>Scope of variable is from a moment of declaration to the end of function where\nit is declared (global context acts like one big function encompassing the code\non the page)</p>\n\n<p>Scope of a function is <strong>entire</strong> function where it is declared (ie function\nhoising).\nBlock nesting like in <code class=\"highlighter-rouge\">if</code> statement, does not affect scope. Scope of inline\nfunction <code class=\"highlighter-rouge\">var b=function a(){}</code> is only inside function (this is function\nexpression and hoising is not applied here).</p>\n\n<p>Function context (<em>this</em> variable) is:</p>\n\n<ul>\n  <li><em>window</em> for invocation as function <code class=\"highlighter-rouge\">a()</code></li>\n  <li>current object for invocation as method <code class=\"highlighter-rouge\">objB={};objB.a=a;objB.a()</code></li>\n</ul>\n\n<p>Invocation as contructor <code class=\"highlighter-rouge\">var n=new A();</code> creates new object and pass to\nfunction as <em>this</em>.</p>\n\n<p>Invocation with <code class=\"highlighter-rouge\">a.apply(objB,[1,2])</code> and <code class=\"highlighter-rouge\">a.call(objB,1,2)</code> set manually the\ncontext <code class=\"highlighter-rouge\">objB</code> of a function (apply and call are function methods).</p>\n\n<p>You can see the source code of a method with <code class=\"highlighter-rouge\">objB['a']</code></p>\n\n<p>When function is called it enters an execution context:</p>\n\n<ol>\n  <li>first is “Activation” object is created with <code class=\"highlighter-rouge\">arguments</code> property</li>\n  <li><em>scope chain</em> (list of objects) from last to first:\n    <ul>\n      <li>global object</li>\n      <li>Activation object for inner functions</li>\n      <li><code class=\"highlighter-rouge\">y</code> if <code class=\"highlighter-rouge\">y</code> is object for execution of <code class=\"highlighter-rouge\">x()</code> in <code class=\"highlighter-rouge\">var x;with(y){\n x=function(){}; }</code></li>\n    </ul>\n  </li>\n  <li>variable instantiation to “Variable” object\n    <ul>\n      <li>function’s formal parameters with name and value if value is provided</li>\n      <li>inner function definitions are creating <strong>function objects</strong> with inner\n function name as key</li>\n      <li>named properties for all local variables, just key, value is not yet defined</li>\n    </ul>\n  </li>\n  <li>value is assigned to <em>this</em> keyword</li>\n</ol>\n\n<h2 id=\"identifier-resolution\">Identifier Resolution</h2>\n\n<ol>\n  <li>it starts from first object in the scope chain (it is Activation/Variable)</li>\n  <li>it also check it’s prototype chain</li>\n  <li>go to the next object from scope chain, until global object</li>\n</ol>\n\n<p>Functions are objects and are created:</p>\n\n<ul>\n  <li>during “Variable” instantiation from function declaration</li>\n  <li>during evaluation of function expressions</li>\n  <li>or invoking <em>Function</em> contructor</li>\n</ul>\n\n<p>Upon exiting an execution context all scope chain, Activation/Variable object\nand any object created (including function objects) are no longer accessible.</p>\n\n<h2 id=\"forming-closure\">Forming closure</h2>\n\n<p>A closure is formed by returning a function object that was created withing an\nexecution of a function call and assigning that reference to a property of\nanother object. Or assigning (not returning) reference of such function object\nto global variable, or a property of global object or object passed by reference\nas an argument to the outer function call.</p>\n\n<p>Tip: in chrome console when you stop with <code class=\"highlighter-rouge\">debugger</code> and try to reference\nvariable than has not been referenced than is could say <code class=\"highlighter-rouge\">undefined reference</code>\nalthough you can use it</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function() \n</code></pre></div></div>\n\n<p>Examples</p>\n\n<ul>\n  <li>\n    <p>closure for function without arguments can be passed to</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function callLater(arg1) {\n  return (function() {\n    return \"I'm \" + arg1;\n  });\n}\nvar fRef=callLater('arg1');\nsetTimeout(fRef,3000);\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>associating functions with a lot of object instances</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function associateObjWithEvent(obj, methodName) {\n  return (function(e) {\n    e = e || window.event;\n    return obj[methodName](e, this); // this will be element object\n  });\n}\nfunction DhtmlObject(elementId) {\n  var el = getElementWithId(elementId);\n  if (el) {\n    el.onclick = associateObjWithEvent(this, \"doOnClick\");\n    // el.onclick = this.doOnClick; //\n    el.onmouseover = associateObjWithEvent(this, \"doMouseOver\");\n  }\n}\nDhtmlObject.prototype.doOnClick = function(event, element) {\n  // doOnClick body\n}\nDhtmlObject.prototype.doMouseOver = function(event, element) {\n  // doMouseOver body\n}\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>Encapsulating related functionality. Crete execution context by executing a\nfunction expression in-line and return function (or object)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var getImgInPositionedDivHtml = (function(){\n  var innerArray = [\n    '&lt;div id=\"',\n    '', // index 1 DIV ID\n    '\"&gt;&lt;/div&gt;',\n  ];\n  return (function(id){\n    innerArray[1] = id;\n    return innerArray.join;\n  }\n})(); /* the inline execution of the outer function expression */\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>Accidental closures. Do not use inner functions as event handlers that will be\nused in a lot of places since every time new function object is created</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var quantaty = 5;\nfunction addGlobalQueryOnClick(linkRef) {\n  if (linkRef) {\n    linkRef.onlick = function() {\n      this.href += ('?quantaty='+escape(quantaty));\n      return true;\n    }\n  }\n}\n// better is to define on property\nvar quantaty = 5;\nfunction addGlobalQueryOnClick(linkRef) {\n  if (linkRef) {\n    linkRef.onlick = forAddQuaryOnClick;\n  }\n}\naddGlobalQueryOnClick.prototype.forAddQuaryOnClick = function() {\n  this.href += ('?quantaty='+escape(quantaty));\n  return true;\n};\n  \n// similar is for object constructor functions for a lot of objects\n// instead\nfunction ExampleConstuctor(p) {\n  this.publicProp = p;\n  this.method1 = function() {\n    // method body\n  }\n}\n// we shuold write\nfunction ExampleConstuctor(p) {\n  this.publicProp = p;\n}\nExampleConstuctor.prototype.method1 = function() {\n  // method body\n};\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n"
    } ,
  
    {
      "title"    : "Bash",
      "category" : "",
      "tags"     : "bash",
      "url"      : "/2016/02/01/bash/",
      "date"     : "2016-02-01 00:00:00 +0100",
      "content"  : "<h1 id=\"run-command-as-another-user\">Run command as another user</h1>\n\n<p>In two ways</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">su deployer -c 'whoami</code> can add login <code class=\"highlighter-rouge\">-l</code> option <code class=\"highlighter-rouge\">su -l deployer -c 'rvm\nlist'</code> so PATH is extended with <code class=\"highlighter-rouge\">~/.rvm/bin/</code> and rvm script works</li>\n  <li><code class=\"highlighter-rouge\">sudo -u deployer whoami</code> simpler, no need for quotes\n    <ul>\n      <li>Add option <code class=\"highlighter-rouge\">-i</code> or <code class=\"highlighter-rouge\">--login</code> to run as login shell. In login shell <code class=\"highlighter-rouge\">~</code> is\npointing to <code class=\"highlighter-rouge\">/home/deployer/</code> not <code class=\"highlighter-rouge\">/root/</code> home.</li>\n      <li>Wrap command inside <code class=\"highlighter-rouge\">bash</code> to properly load XDG_RUNTIME_DIR for rails c or\nother ruby commands: <code class=\"highlighter-rouge\">sudo -i -u deployer /bin/bash -c \"cd /vagrant &amp;&amp; rails\nc\"</code>. Also when you use pipe <code class=\"highlighter-rouge\">|</code> or <code class=\"highlighter-rouge\">&amp;&amp;</code> or redirection <code class=\"highlighter-rouge\">&gt;&gt;</code>, you should wrap\ninside bash or use <code class=\"highlighter-rouge\">eval</code></li>\n    </ul>\n  </li>\n</ul>\n\n<h1 id=\"shortcuts-for-windows\">Shortcuts for windows</h1>\n\n<p>Very usefull shortcuts to activate certain windows.</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">gnome-terminal</code> if negative is used, than it is bottom alligned</li>\n  <li><a href=\"http://helpdeskgeek.com/linux-tips/resize-a-window-to-a-specific-size-in-ubuntu/\">wmctrl</a></li>\n  <li><code class=\"highlighter-rouge\">xwininfo</code> to click on window to find it’s <code class=\"highlighter-rouge\">0x440003d</code> which we can use to\ncreate shortcut <code class=\"highlighter-rouge\">xdotool windowactivate 0x440003d</code></li>\n  <li>another robust solution is to set predefined classname for windows with\n<code class=\"highlighter-rouge\">xprop -f WM_CLASS 8s -set WM_CLASS main_editor</code> (click on window) and \n<code class=\"highlighter-rouge\">xdotool search --classname main_editor windowactivate</code> in <em>Alt+M</em> shortcut.\nI’m using ALT+HJKL; with <em>class_hjkl;</em></li>\n</ul>\n\n<p><img src=\"/assets/posts/mapping hjkl keys to activate window.png\" alt=\"mapping hjkl keys to activate window\" />\n<img src=\"/assets/posts/mapping_workspace_keys_to_hjkl.png\" alt=\"mapping workspace keys to hjkl\" title=\"mapping workspace keys to hjkl\" />\nLook at my\n<a href=\"https://github.com/duleorlovic/config/blob/master/bashrc/window_shortcuts.sh\">window_shortcuts</a></p>\n\n<p>When I update ubuntu I need to map keys again. Go one by one and press ALT+key\ncombination again.</p>\n\n<p>On blank ubuntu I need to go All Settings -&gt; Appearance -&gt; (tab) Behavior and\n<em>Auto-hide the Launcher</em> to ON and <em>Enable workspaces</em>.\n(in virtualBox I can not open launcher, only hud with left alt)</p>\n\n<h1 id=\"shortcuts-for-key-mappings\">Shortcuts for key mappings</h1>\n\n<p>To scroll in terminal window, instead <code class=\"highlighter-rouge\">shift+page_up</code> we can <a href=\"http://askubuntu.com/questions/250791/how-to-bind-altarrows-to-pageup-pagedown\">bind to\nkey</a>\n<a href=\"https://bbs.archlinux.org/viewtopic.php?id=136265\">simulate keyup</a>.\n<a href=\"https://wiki.archlinux.org/index.php/Xbindkeys\">xbindkeys</a> I usually map vim\nshortcuts <em>CTRL+</em> , so for terminal windows I use <em>ALT+</em>.  Do not override\nalready two ALT <a href=\"http://www.howtogeek.com/howto/ubuntu/keyboard-shortcuts-for-bash-command-shell-for-ubuntu-debian-suse-redhat-linux-etc/\">bash\nshortcut</a>\n<em>Alt+F</em> <em>Alt+B</em> to move cursor one word (use capitalize F to not open File menu\nor disable in <em>Edit</em> -&gt; <em>Keyboard Shortcuts</em>) (CTRL version move by one\ncharacter) . I also map <em>ctrl+k</em> to scroll up since it’s natural (I don’t mind\nthat I don’t have cut shortcut, I just use <code class=\"highlighter-rouge\">#</code>). I tried to use <code class=\"highlighter-rouge\">bind</code> command\nbut that outputs, so multiple scroll looks like one scroll.</p>\n\n<p>Here are all bash CTRL shortcuts:</p>\n\n<ul>\n  <li>ctrl+a (+e) : move cursor to begging (end) of line</li>\n  <li>ctrl+b (+f) : move cursor by one char to left (right)</li>\n  <li>ctrl+h (+d) : delete char left to the cursor-backspace (under the cursor)</li>\n  <li>ctrl+w : delete word before the cursor</li>\n  <li>ctrl+i : (or tab) completion</li>\n  <li>ctrl+j : enter</li>\n  <li>ctrl+k (+u) [+y]: cut chars until the end of the line (before the cursor\nposition) [yank cutted text]</li>\n  <li>ctrl+p (+n) : go to previous (next) command</li>\n  <li>ctrl+r : search</li>\n  <li>ctrl+c (+z) : kill current process (send to background and suspend, use <code class=\"highlighter-rouge\">fg</code>\nto restore).  You can put any shell (vim, rails s) to suspend state with\n<code class=\"highlighter-rouge\">Control + z</code>. Than you can put it in background <code class=\"highlighter-rouge\">bg</code> if needed. You can use\nthat shell for inspection other things. When you are finished, you can switch\nback to vim, or rails s, with foreground <code class=\"highlighter-rouge\">fg</code> (from both suspend and background\nstate) see all background and suspended processes in current bash session <code class=\"highlighter-rouge\">jobs\n-l</code></li>\n  <li>ctrl+l : clear window, but I remaped to copy current line to clipboard</li>\n</ul>\n\n<p>ALT shortcuts:</p>\n\n<ul>\n  <li>alt+b (+f) : move cursor by one word to left (right). On mac Alt is Meta so\nyou need to disable in all your terminals in system preferences and restart.</li>\n</ul>\n\n<p>Here are some <em>Edit</em> -&gt; <em>Keyboard Shortcuts</em>:</p>\n\n<ul>\n  <li>shoft+ctrl+t : open in new tab</li>\n  <li>alt+1 : switch between tabs</li>\n</ul>\n\n<p>To copy line, you need to select with mouse and use <em>ctrl+shift+c</em>\n(<em>ctrl+shift+v</em> to pase). Or with <code class=\"highlighter-rouge\">xsel</code> you can bind to ctrl+l:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># .bashrc\nbind '\"\\C-l\": \"\\C-e\\C-u xsel --clipboard &lt;&lt;\"EOF\"\\n\\C-y\\nEOF\\n\\C-y\"'\n</code></pre></div></div>\n\n<p>In vim you can paste primary selection (just select, middle mouse, shift insert)\nwith <code class=\"highlighter-rouge\">\"*p</code>. Clipboard selection (copy, paste) with  and <code class=\"highlighter-rouge\">\"+p</code></p>\n\n<p>To copy some text from <code class=\"highlighter-rouge\">less</code> you can click <code class=\"highlighter-rouge\">v</code> inside less to invoke the\neditor (<code class=\"highlighter-rouge\">vim</code>) and than you can copy from that. There is an error <code class=\"highlighter-rouge\">Cannot edit\nstandard input (press RETURN)</code> when editing (<code class=\"highlighter-rouge\">v</code>) for example <code class=\"highlighter-rouge\">ls | less</code>.\nWorkaround is to <code class=\"highlighter-rouge\">ls | vim -</code>, or for example <code class=\"highlighter-rouge\">git log | vim -</code>, Note that yank\nwhile vim is open works fine, but once you close the vim, clipboard is empty.</p>\n\n<p>Maximize terminal window to full screen is with <code class=\"highlighter-rouge\">F11</code> (yes it is the same\nshortcut for bash as for chrome).\nInside terminal there are Terminal-&gt;Preferences-&gt;Shortcuts</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">Shift+Ctrl+F</code> search (<code class=\"highlighter-rouge\">G</code> and <code class=\"highlighter-rouge\">H</code> next and previous)</li>\n</ul>\n\n<p>Only place where I sometimes need arrow keys is google chrome suggestions in\naddress bar, but than I use Tab.</p>\n\n<p>Starting chrome with <a href=\"http://peter.sh/experiments/chromium-command-line-switches/\">command line\nswitch</a>\n<code class=\"highlighter-rouge\">chromium-browser --auto-open-devtools-for-tabs</code> does work only on\ngoogle-chrome.</p>\n\n<p>Intresting <a href=\"http://anti-code.com/devtools-cheatsheet/\">devtools-cheatcheet</a>\n(search by filename Ctrl+O, search all sources Ctrl+Shift+F).</p>\n\n<p>Look my\n<a href=\"https://github.com/duleorlovic/config/blob/master/.xbindkeysrc\">xbindkeysrc</a>\nThere is very nice tool <a href=\"http://xmonad.org/\">Xmonad</a> which is designed to\nmaximize. move windows around, <code class=\"highlighter-rouge\">automatically tile the screen without gaps or\noverlap</code>, but I do not need auto arrangement.</p>\n\n<p>To start command programs on startup you can use <code class=\"highlighter-rouge\">ctrontab -r</code> and <code class=\"highlighter-rouge\">@reboot</code>,\nbut for gui programs use ubunt Startup Applications.\nOutput (from crontab or gui) should be redirected to system log, for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># script should start with #!/bin/bash\n# and should be executable chmod +x my_script.sh\n# in script use echo \"start my script\"\n/home/orlovic/config/bashrc/startup_my_script.sh 2&gt;&amp;1 | /usr/bin/logger\n# using tags works only if you call script direclty, but if it is called from\n# startup scripts than tag is gnome-session it overrides my tag\n# --tag my_tag\n# sometimes messages are grouped so wait few seconds\ntail -f /var/log/syslog\n# clear syslog\n&gt; /var/log/syslog\n# if syslog is not readable you can make it readable and writable\nsudo chmod g+rw /var/log/syslog\n</code></pre></div></div>\n\n<p>You can also redirect output to a file withing the script itself (but\nredirecting to syslog does not work)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c\">#!/bin/bash</span>\n<span class=\"nb\">exec</span> <span class=\"o\">&gt;&gt;</span> /home/orlovic/Downloads/output.log\n<span class=\"nb\">exec </span>2&gt;&amp;1\n\n<span class=\"nb\">echo </span>this will go to /home/orlovic/Downloads/output.log\n</code></pre></div></div>\n\n<p>For gui debugging you can use this command to log message from scripts:\n<code class=\"highlighter-rouge\">notify-send $USER --urgency critical</code> Create desktop notifications with\n<code class=\"highlighter-rouge\">notify-send</code> but need urgency critical, so I made alias <code class=\"highlighter-rouge\">alert</code>.\nYou can debug with <code class=\"highlighter-rouge\">sleep</code> and <code class=\"highlighter-rouge\">echo</code> redirection.</p>\n\n<p>Since <code class=\"highlighter-rouge\">ctrl+w</code> and <code class=\"highlighter-rouge\">ctrl+r</code> in chrome firefox browsers will close and reload the\npage, it is much easier to use alt (like on mac), so I created shortcuts</p>\n\n<p>To run script on keyboad shortcut go to Settings -&gt; Keyboard -&gt; Shortcuts -&gt;\nCustom Schortcuts -&gt; +</p>\n<ul>\n  <li>name: this is description</li>\n  <li>command: should be path to the executable script… Directly writting commands\nhere might not work</li>\n</ul>\n\n<p>If you are mapping <code class=\"highlighter-rouge\">Alt+W</code> to send another key <code class=\"highlighter-rouge\">Ctrl+W</code> you need to release\n<code class=\"highlighter-rouge\">Alt</code> first. To release all modifiers\nyou can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c\">#!/bin/bash</span>\n<span class=\"c\"># config/bashrc/ctrl_browser.sh</span>\n<span class=\"c\"># exec &gt;&gt; /home/orlovic/Downloads/output.log</span>\n<span class=\"c\"># exec 2&gt;&amp;1</span>\n<span class=\"k\">if</span> <span class=\"o\">[</span> <span class=\"s2\">\"</span><span class=\"nv\">$1</span><span class=\"s2\">\"</span> <span class=\"o\">=</span> <span class=\"s2\">\"\"</span> <span class=\"o\">]</span><span class=\"p\">;</span> <span class=\"k\">then\n  </span>notify-send <span class=\"s2\">\"Please provide a key, like Ctrl+r\"</span> <span class=\"nt\">-u</span> critical\n<span class=\"k\">fi</span>\n\n<span class=\"c\"># release all modifiers</span>\n<span class=\"c\"># https://unix.stackexchange.com/questions/60007/how-to-force-release-of-a-keyboard-modifiers</span>\nxdotool keyup Shift_L Shift_R Control_L Control_R Meta_L Meta_R Alt_L Alt_R Super_L Super_R Hyper_L Hyper_R ISO_Level2_Latch ISO_Level3_Shift ISO_Level3_Latch ISO_Level3_Lock ISO_Level5_Shift ISO_Level5_Latch ISO_Level5_Lock\nxdotool key <span class=\"nv\">$1</span>\n<span class=\"c\"># keydown again so you can run multiple reloads while keeping alt key down</span>\n<span class=\"c\"># problem is if you release alt to fast, you need to click again to release it</span>\n<span class=\"c\"># xdotool keydown Alt_L</span>\n</code></pre></div></div>\n\n<p>You can send commands to specific window\nhttps://unix.stackexchange.com/questions/87831/how-to-send-keystrokes-f5-from-terminal-to-a-gui-program</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># this does not send key\nxdotool search --classname vp_$(get_current_viewport)_class_slash  windowactivate --sync %1 key  a\n\n# also can not send key without activate that window\nxdotool key --window 67199662 a Return\n\n# with windowactivate you need to wait with sync and than send key\nxdotool windowactivate --sync 67199662 key a\n\n# to write command use `type`, to include spaces wrap with quotes\nxdotool windowactivate --sync 67199662 type \"pwd\"\n\n# to send Enter &lt;CR&gt; you need delay and also some key before that\n# &lt;CR&gt; is 'Return', space is 'space'\n# remember not to run command with &lt;C-j&gt; since ctrl modifier is still active\nxdotool windowactivate --sync 67199662 type \"pwd\"; xdotool key --delay 50 space Return\n\n# you can come back to previous terminal with\nxdotool windowactivate --sync 67199662 type \"pwd\"; xdotool key --delay 50 space Return windowactivate 67199574\n\n# complete command for janko-m/vim-test strategy is in vim tips\n</code></pre></div></div>\n\n<p>Remapping keyboard keys is with\n<a href=\"https://wiki.archlinux.org/index.php/Xmodmap\">xmodmap</a>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># show all keys, columns are\n# Key, Shift+Key, mode_switch+Key, mode_switch+Shift+Key, alt+Key, alt+shift+key\nxmodmap -pke\n\n# save configuration to a file\nxmodmap -pke &gt; ~/.Xmodmap\n# reload new configuration\nxmodmap ~/.Xmodmap\n</code></pre></div></div>\n\n<p>To find keycodes use <code class=\"highlighter-rouge\">xev</code> program (exit with mouse or alt+f4).\n<code class=\"highlighter-rouge\">showkeys</code> is using for linux system.\nYou can use also <code class=\"highlighter-rouge\">xkeycaps</code> but I do not know which keyboard to choose.\n<code class=\"highlighter-rouge\">sudo showkey -a</code> can show keycode.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>xev | sed -n 's/^.*keycode *\\([0-9]\\+\\).*$/keycode \\1 = /p'\n</code></pre></div></div>\n\n<p>Keycode for <code class=\"highlighter-rouge\">a</code> is 38. It can be used alone or with modifier keys. Alone <code class=\"highlighter-rouge\">a</code>\ngives keysym <code class=\"highlighter-rouge\">0x61</code> (ie 141 in ascii), for <code class=\"highlighter-rouge\">shift+a</code> keysym is <code class=\"highlighter-rouge\">0x41</code> ie <code class=\"highlighter-rouge\">A</code>.\nDescriptive keysyms for multimedia keys are in <code class=\"highlighter-rouge\">/usr/include/X11/XF86keysym.h</code>.\nKeycode for left ctrl is 37 (keysym <code class=\"highlighter-rouge\">Control_L</code>), left alt 64 (keysym <code class=\"highlighter-rouge\">Alt_L</code>),\nwindows 133 (keysym <code class=\"highlighter-rouge\">Super_L</code>), caps lock 66 (Caps_Lock), right alt is 108\n(<code class=\"highlighter-rouge\">Alt_R</code>).</p>\n\n<p>http://wiki.linuxquestions.org/wiki/List_of_Keysyms_Recognised_by_Xmodmap\nhttp://wiki.linuxquestions.org/wiki/List_of_KeySyms AltGr, Alt_R, AltGr_R are\nsynonyms.</p>\n\n<p>From <code class=\"highlighter-rouge\">man xmodmap</code> you can see that you can write 4 keysyms</p>\n\n<blockquote>\n  <p>Up to eight keysyms may be attached to a key, however the last four are not\nused in any major X server implementation.  The first keysym is used when no\nmodifier key is pressed in conjunction with this key, the  second with Shift,\nthe third when the Mode_switch key is used with this key and the fourth when\nboth the Mode_switch and Shift keys are used</p>\n</blockquote>\n\n<p>keycode 57 = key Shift+Key Mode_switch+Key Mode_switch+Shift+Key ISO_Level3_Shift+Key ISO_Level3_Shift+Shift+Key</p>\n\n<p>Do not know where is ISO_Level3_Shift. Mode switch is on Caps_Lock. When I bind\nto for example number 1 and 2, than <code class=\"highlighter-rouge\">13</code> gives <code class=\"highlighter-rouge\">4</code> (so Mode_switch works) but\n<code class=\"highlighter-rouge\">23</code> gives <code class=\"highlighter-rouge\">3</code> (ISO_Level3_Shift does not work)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>keycode  10 = Mode_switch exclam 1 exclam\nkeycode  11 = ISO_Level3_Shift at 2 at\nkeycode  12 = 3 numbersign 4 numbersign 5 6\n</code></pre></div></div>\n\n<p>Default output of <code class=\"highlighter-rouge\">xmodmap -pm</code> is</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>xmodmap:  up to 4 keys per modifier, (keycodes in parentheses):\n\nshift       Shift_L (0x32),  Shift_R (0x3e)\nlock        Caps_Lock (0x42)\ncontrol     Control_L (0x25=37), Control_R (0x69)\nmod1        Alt_L (0x40=64),  Alt_R (0x6c=108),  Meta_L (0xcd)\nmod2        Num_Lock (0x4d)\nmod3\nmod4        Super_L (0x85),  Super_R (0x86),  Super_L (0xce),  Hyper_L (0xcf)\nmod5        ISO_Level3_Shift (0x5c),  Mode_switch (0xcb)\n</code></pre></div></div>\n\n<p>To change modifier keys usually you should to <code class=\"highlighter-rouge\">clear</code> them; <code class=\"highlighter-rouge\">Lock</code>, <code class=\"highlighter-rouge\">Shift</code>,\n<code class=\"highlighter-rouge\">Control</code>, <code class=\"highlighter-rouge\">Mod1</code> (this is alt) …  and than <code class=\"highlighter-rouge\">add Control = Super_L ...</code>.\nModifier <code class=\"highlighter-rouge\">Mod4</code> is usually <code class=\"highlighter-rouge\">Super_L</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>! This modifies CapsLock to Control, and keep CapsLock on Shift+CapsLock\nclear lock\nclear control\nkeycode 66 = Control_L Caps_Lock NoSymbol NoSymbol\nadd control = Caps_Lock Control_L Control_R\n</code></pre></div></div>\n\n<p>You can use dummy modifier on capslock and assign various key on that modifier.\nhttps://gist.github.com/bcremer/9caa54d0432531f80c1e</p>\n\n<p>For Apple keyboard you can use https://help.ubuntu.com/community/AppleKeyboard\nand this answer\nhttps://askubuntu.com/questions/131900/how-do-i-switch-the-command-key-and-control-key-on-a-macbook-pro\nfor swapping controll and command (I use swapping option and command).\nFor swapping fn and control use https://help.ubuntu.com/community/TroubleWithAppleKbdOnUbuntu\nhttps://wiki.archlinux.org/index.php/Apple_Keyboard#Treating_Apple_keyboards_like_regular_keyboards\nhttps://github.com/free5lot/hid-apple-patched#installation-via-dkms-recommended</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo vi /etc/modprobe.d/hid_apple.conf\ncat /sys/module/hid_apple/parameters/swap_fn_leftctrl\n</code></pre></div></div>\n\n<p>I use mapping for all keys that I need right shift like underscore, brackets,\nhtml &gt;.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>! ~/.Xmodmap\n! remove caps lock modifier\nclear Lock\n! assign dummy modifier to capslock\nkeycode 66 = ISO_Group_Shift ISO_Group_Shift ISO_First_Group NoSymbol\nkeycode 43 = h H braceleft\nkeycode 44 = j J parenleft\nkeycode 45 = k K parenright\nkeycode 46 = l L braceright\nkeycode 59 = comma less less\nkeycode 60 = period greater greater\n\nclear Mod1\nadd Mod1 = Alt_L\nkeycode 108 = underscore underscore underscore underscore\n\n! Colon and semicolon are just reversed.\nkeycode 47 = colon semicolon colon semicolon\n</code></pre></div></div>\n\n<p>Also I like command+c / alt+c for copy/paste so I use this answer to copy\nselected text to clipboard https://askubuntu.com/questions/573663/command-to-copy-currently-selected-text\nand in terminal remap copy paste Terminal-&gt;Preferences-&gt;Shortcuts-&gt;Edit-&gt;Copy\n(Alt+C) Paste (Alt+V) so I can create keyboard shortcut for Alt+C and Alt+V\nwhich I can use both on terminal and non terminal</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /home/orlovic/config/bashrc/copy_from_x_selection.sh\n#!/bin/bash\nxclip -out -selection primary | xclip -in -selection clipboard\n</code></pre></div></div>\n\n<p>create two shortcuts, one for Alt+C\n<code class=\"highlighter-rouge\">/home/orlovic/config/bashrc/copy_from_x_selection.sh</code> and another for Alt+V\n<code class=\"highlighter-rouge\">/home/orlovic/config/bashrc/ctrl_browser.sh Control+v</code>.\nDo not forget to use old method of selecting text and middle mouse button or\nShift+Insert (Insert does not exists on Apple Keyboard so that is the reason why\nI add this shortcuts, but also another helpers is ctrl+i which is remaped to\nshift+insert in .xbindkeysrc). This xclip is also used when you want to copy\nfrom vim to clipboard, you need just to yank and alt+c and alt+v (alt+c do not\nneed to be inside vim).</p>\n\n<p>Run <code class=\"highlighter-rouge\">/home/orlovic/config/bashrc/startup_xmodmap.sh 2&gt;&amp;1 | /usr/bin/logger</code> in\nboth startup scripts and /lib/systemd/system-sleep/startup_after_sleep.sh</p>\n\n<p>Problem with system-sleep xmodmap: unable to open display can not be solved with\nhttps://ubuntuforums.org/showthread.php?t=2380045</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sleep 5\ndeclare -x DISPLAY=\":0.0\"\ndeclare -x XAUTHORITY=\"/home/&lt;your user&gt;/.Xauthority\"\n</code></pre></div></div>\n\n<p>Maybe pm power manager is different than system sleep, but it needs some events\nto properly work. X server is not set in systemd script so we need to declare\nand export DISPLAY and XAUTHORITY.\nI success with <code class=\"highlighter-rouge\">xhost +main</code> (enable connect from main, but since network\nmanager is not yet initialized, that is not reliable).\nI also tried https://bbs.archlinux.org/viewtopic.php?pid=684936#p684936 so nm\nknows hostname in configuration</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /etc/NetworkManager/NetworkManager.conf\n[keyfile]\nhostname=main\n</code></pre></div></div>\n\n<p>but not reliable…</p>\n\n<h1 id=\"tar\">Tar</h1>\n\n<p>comress folder: <code class=\"highlighter-rouge\">tar -zcvf folder.tar.gz folder</code>\nextract folder: <code class=\"highlighter-rouge\">tar -zxvf folder.tar.gz</code></p>\n\n<p>compress file: <code class=\"highlighter-rouge\">tar cvzf file_name.tar.gz file_name</code>\nNote that is file_name is relative to some subfolders (contains slash <code class=\"highlighter-rouge\">/</code>) for\nexample <code class=\"highlighter-rouge\">/tmp/db.dump</code> than leading slash will be ignored and when you extract\nit will be in <code class=\"highlighter-rouge\">tmp/db.dump</code></p>\n\n<h1 id=\"scrips-and-commands\">Scrips and commands</h1>\n\n<ul>\n  <li>nice tutorial <a href=\"http://www.tldp.org/LDP/Bash-Beginners-Guide/html/Bash-Beginners-Guide.html\">Bash Begginers\nGuide</a> and <a href=\"https://github.com/duleorlovic/config\">example config scrips</a></li>\n  <li>input first param <code class=\"highlighter-rouge\">$1</code>. <code class=\"highlighter-rouge\">$@</code> is all params. Use <code class=\"highlighter-rouge\">\"$@\"</code> is you pass to another\nscript and you want to preserve quoted strings https://stackoverflow.com/questions/4824590/propagate-all-arguments-in-a-bash-shell-script\nSo when variable contain spaces and you need to pass to a command than wrap\naround with quotes, for example <code class=\"highlighter-rouge\">A=\"file with space.txt\"; ls \"$A\"</code></li>\n  <li>exit from script with <code class=\"highlighter-rouge\">exit 1</code></li>\n  <li>functions can accept <a href=\"http://www.gnu.org/software/bash/manual/bashref.html#Shell-Parameter-Expansion\">default\nparameters</a>\nwith <code class=\"highlighter-rouge\">:-</code> syntax\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>myFunc() {\n  echo first param is $(1:-not defined)\n}\n</code></pre></div>    </div>\n\n    <p>To use functions in xargs you need to export them</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>myF() {\n  echo $1\n}\nexport -f myF\n</code></pre></div>    </div>\n  </li>\n  <li>always use double square brackets <code class=\"highlighter-rouge\">[[ ]]</code> instead of single <code class=\"highlighter-rouge\">[ ]</code> since it is\nextension and support using <code class=\"highlighter-rouge\">||</code> instead of <code class=\"highlighter-rouge\">-o</code>, or regex match <code class=\"highlighter-rouge\">=~</code></li>\n  <li>\n    <p>with <a href=\"http://tldp.org/LDP/abs/html/comparison-ops.html\">comparison operators</a>\nyou should use quotes since something could not be defined <code class=\"highlighter-rouge\">if [ -n \"$a\" ]</code>.\nIf you use double brackets you do not need quotes around variable name.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># check if $a is present (not null)\nif [[ -n $a ]]\n\n# if conditional to check if string is substring\nstring='my long string'\nif [[ $string = *\"long\"* ]]; then\n  echo \"its here\"\nfi\n\n# string equal\nif [[ $a != $b ]]; then\n  echo string a is not equal to string b\nfi\n\n# split string and use last item\nnumber=\"$(echo \"asd 123\" | cut -d' ' -f2)\"\n\n# integer equal\nif [[ $a -eq $b ]]; then\n  echo number a is equal to number b\nfi\n</code></pre></div>    </div>\n\n    <p>Find other test helpers in <code class=\"highlighter-rouge\">man test</code>.\nUse conditional <code class=\"highlighter-rouge\">or ||</code> and <code class=\"highlighter-rouge\">and &amp;&amp;</code> and <code class=\"highlighter-rouge\">group ()</code> and negative <code class=\"highlighter-rouge\">!</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>if [[ $a -eq $b || ($a -eq 2 &amp;&amp; $b &gt; 2) ]] || [[ ! -n $a ]] ; then\n  echo number a is equal to number b\nfi\n</code></pre></div>    </div>\n\n    <p>Use regular expression matching (not supported with <code class=\"highlighter-rouge\">[ ]</code> single quote)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>w_name=\"Mozzila Firefox and Chrome\"\nif [[ $w_name =~ 'Mozilla Firefox'|Chrome ]] ; then\nfi\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>loops and expressions example</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>attempts=\"0\"\nwhile [ $attempts -lt 10 ] || [ -z \"$window_id\" ]\ndo\n  echo $attempts\n  sleep 1\n  window_id=`wmctrl -l | grep $url | awk '{print $1}' | tail -n1`\n  attempts=$[$attempts+1]\ndone\necho move and mark window_id=$window_id\n</code></pre></div>    </div>\n  </li>\n  <li>find\n    <ul>\n      <li>find and remove files <code class=\"highlighter-rouge\">find . -type f -name \"test.log\" -exec rm -f {} \\;</code></li>\n      <li>find all html files <code class=\"highlighter-rouge\">find . -name '*.html'</code>. Note that <code class=\"highlighter-rouge\">find . -name *.html</code>\nwill not work since wildcard will be changed to html file in current folder.</li>\n      <li>filter files based on their size: <code class=\"highlighter-rouge\">find . -size -212c</code> show only small than\n212 bytes</li>\n    </ul>\n  </li>\n  <li>escape single quote <code class=\"highlighter-rouge\">'</code> in linux scripts with <code class=\"highlighter-rouge\">$'Hello I\\'m here'</code>\n<a href=\"http://stackoverflow.com/questions/8254120/how-to-escape-a-single-quote-in-single-quote-string-in-bash\">link</a></li>\n  <li>add task to crontab with linux command <code class=\"highlighter-rouge\"># (crontab -l 2&gt;/dev/null; echo\n\"@reboot /home/orlovic/my.sh\") | crontab -</code></li>\n  <li>output goes to the mail but I prefer to redirect to some file. Also define\nshell since it will use sh (on which sleep does not work).\n~~~\nSHELL=/bin/bash\n    <ul>\n      <li>\n        <ul>\n          <li>\n            <ul>\n              <li>\n                <ul>\n                  <li>\n                    <ul>\n                      <li>/path/to/my/script.sh » /home/orlovic/Downloads/cron.log 2&gt;&amp;1\n~~~</li>\n                    </ul>\n                  </li>\n                </ul>\n              </li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n    </ul>\n\n    <p>cron format <code class=\"highlighter-rouge\">Minute Hour Day_of_the_Month Month_of_the_Year Day_of_the_Week</code>\nand also <code class=\"highlighter-rouge\">Year</code> as 6th field. For more information see the manual pages of\ncrontab(5) and cron(8) <code class=\"highlighter-rouge\">m h  dom mon dow   command</code>.\nFor multiple values you can separate with comma, use dash or use slash, for\nexample <code class=\"highlighter-rouge\">0,15,30,45 0,6,12,18 1,15,31 * 1-5 *</code> is the same as <code class=\"highlighter-rouge\">*/15 */6\n1,15,31 * 1-5 *</code>.</p>\n  </li>\n  <li>repeat last command with sudo <code class=\"highlighter-rouge\">sudo !!</code></li>\n  <li>copy all files from folder (including hidden) <code class=\"highlighter-rouge\">cp folder/. /some-other/ -r</code>\nNote <code class=\"highlighter-rouge\">.</code> after folder name.</li>\n  <li>preserve env variables with sudo <code class=\"highlighter-rouge\">sudo -E ruby some_script.rb</code>, but <code class=\"highlighter-rouge\">rvmsudo\nruby some_script.rb</code> works better</li>\n  <li><code class=\"highlighter-rouge\">ps aux | grep process_name</code> will return always the grep process because it\nmatch. But you can use regex so it is not matched <code class=\"highlighter-rouge\">ps aux | grep\n[p]rocess_name</code>. to show full command for process id you can use `ps -fp\n    <pid>`. You can kill one by one using `top` and `k`. To find proccess by port\nit is using you can `lsof -wni tcp:3000`.\nYou can see top 5 proccesses and commands\n~~~\nps aux | sort -nrk 3,3 | head -n 5\nwatch \"ps aux | sort -nrk 3,3 | head -n 5\"\n\n# or with top\ntop -b -n 1 | head -n 12  | tail -n 5\n\n# or better\nhtop\n~~~\n</pid>\n  </li>\n  <li>edit long commands in bash <code class=\"highlighter-rouge\">set -o vi</code> and than press Esc, and v (visual).\nDon’t recomment to put in bashrc since it will disable bash shortcuts like:\nctrp+p, bind, ….</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">mount</code> <code class=\"highlighter-rouge\">sudo fdisk -l</code> <code class=\"highlighter-rouge\">sudo blkid</code> <code class=\"highlighter-rouge\">sudo vi /etc/fstab</code> add line</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># /ets/fstab\nUUID=428c1c5c-7ef4-480a-aa3b-1b62c3feab98 /mnt/moj_ssd    ext4    defaults  0  2\n</code></pre></div>    </div>\n\n    <p>run <code class=\"highlighter-rouge\">sudo chown -R orlovic.orlovic /mnt/moj_ssd/</code> this is needed only one\ntime.</p>\n  </li>\n  <li>if you need to answer yes and there is no <code class=\"highlighter-rouge\">-y</code> parameter, you can use <code class=\"highlighter-rouge\">echo\n-en \"\\n\\n\\n\" | command</code> . Or you can install\n<a href=\"https://en.wikipedia.org/wiki/Yes_%28Unix%29\">yes</a> command which outputs\n<code class=\"highlighter-rouge\">y\\n</code> in a infinite loop <code class=\"highlighter-rouge\">yes | command</code></li>\n  <li>last folder in path <code class=\"highlighter-rouge\">basename $(pwd)</code></li>\n  <li>\n    <p>to check if file does not exists you can use</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>if [ ! -f tmp/memory_profile.png ]; then\n  echo \"File not found\"\nfi\n</code></pre></div>    </div>\n  </li>\n  <li>run multiple long running commands (like <code class=\"highlighter-rouge\">watch</code> <code class=\"highlighter-rouge\">tail -f</code>) with <code class=\"highlighter-rouge\">;</code></li>\n  <li>\n    <p>show commands being executed</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>set -x\ncommand\nset +x\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"pipe\">Pipe</h1>\n\n<ul>\n  <li>you can pipe output of some command to file <code class=\"highlighter-rouge\">c &gt;&gt; a.log</code>, and in other shell\n<code class=\"highlighter-rouge\">tailf a.log</code> but output will be\n<a href=\"http://stackoverflow.com/questions/9752291/bash-output-stream-write-to-a-file\">buffered</a>\nSo you need to <code class=\"highlighter-rouge\">sudo apt-get install expect-dev</code> and run with <code class=\"highlighter-rouge\">unbuffer c &gt;&gt;\na.log</code></li>\n  <li>if you need pipe inside string <code class=\"highlighter-rouge\">heroku logs -t | -o app.web.1</code> than you have\nto <code class=\"highlighter-rouge\">eval $my_string</code></li>\n  <li>you can add a row to some pipe <code class=\"highlighter-rouge\">(echo first line; cat file; echo last line) |\nsome_command</code> or with <code class=\"highlighter-rouge\">ps | { echo \"header\"; grep \"something\"; }</code></li>\n  <li>\n    <p>replace a string in pipe with sed. You can create a long running pipe with\n<code class=\"highlighter-rouge\">tailf</code> and <code class=\"highlighter-rouge\">echo &gt;&gt;</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>tailf my.txt | sed 's/000/111/g'\n\necho \"asd 000 asd 000\" &gt;&gt; my.txt\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <table>\n      <tbody>\n        <tr>\n          <td>for redirection standard error to standard output ` 2&gt;&amp;1</td>\n          <td>` there is shorthand</td>\n        </tr>\n        <tr>\n          <td><code class=\"highlighter-rouge\">|&amp;</code> version.</td>\n          <td> </td>\n        </tr>\n      </tbody>\n    </table>\n  </li>\n  <li>if you need to redirect all script output to a file use <code class=\"highlighter-rouge\">exec</code>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c\">#!/bin/bash</span>\n<span class=\"nb\">exec</span> <span class=\"o\">&gt;&gt;</span> my_script.log\n<span class=\"nb\">exec </span>2&gt;&amp;1\n<span class=\"nb\">echo</span> <span class=\"s2\">\"This will be saved in a log when you run the script\"</span>\n</code></pre></div>    </div>\n  </li>\n  <li>last command exit status <code class=\"highlighter-rouge\">echo $?</code> (<code class=\"highlighter-rouge\">0</code> is success)</li>\n  <li>current script pid <code class=\"highlighter-rouge\">echo $$</code></li>\n  <li>last background process id <code class=\"highlighter-rouge\">sleep 100 &amp;</code> <code class=\"highlighter-rouge\">echo $!</code></li>\n  <li><code class=\"highlighter-rouge\">jobs -l</code> is a list of processes in current bash session (it is <code class=\"highlighter-rouge\">Running</code> if\nin background with <code class=\"highlighter-rouge\">cmd &amp;</code>, or <code class=\"highlighter-rouge\">Stopped</code> if <code class=\"highlighter-rouge\">Ctrl+z</code> or <code class=\"highlighter-rouge\">Terminated</code> when we\nkill and until it dissapear). Kill first of them with <code class=\"highlighter-rouge\">kill %1</code>. If process id\nis saved in pid file than you can kill with <code class=\"highlighter-rouge\">pkill -F tmp/pids/server.pid -9</code></li>\n</ul>\n\n<h1 id=\"parameter-expansion\">Parameter expansion</h1>\n\n<p>You can find substring</p>\n\n<ul>\n  <li>call function with <code class=\"highlighter-rouge\">$(function_name)</code>. Return value from function can be done\nwith <code class=\"highlighter-rouge\">$()</code> expansion:\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>monitor_size() {\nresult=`ls | cw`\n  echo $result\n}\nwin_width=`expr $(monitor_size) / 36` # 7200 / 36 = 200\n</code></pre></div>    </div>\n  </li>\n  <li>print variable with <code class=\"highlighter-rouge\">$variable_name</code> (without brackets). If you need to\nconcatenate with other string you can use curly braces\n<code class=\"highlighter-rouge\">${variable_name}other_string</code></li>\n  <li><a href=\"http://wiki.bash-hackers.org/syntax/pe#common_use\">substring removal</a></li>\n</ul>\n\n<h1 id=\"arrays\">Arrays</h1>\n\n<p><a href=\"http://www.linuxjournal.com/content/bash-arrays\">linuxjournal</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>arr=(Dule Orlovic)\n${arr[*]}         # Dule Orlovic All of the items in the array\n${!arr[*]}        # 0 1 All of the indexes in the array\n${#arr[*]}        # 2 Number of items in the array\n${#arr[0]}        # 4 Length of item zero\n\n# iterate array in for loog\nfor var in \"${arr[@]}\"\ndo\n  echo \"${var}\"\ndone\n\n# iterate over sequence\nfor i in {1..5}; do echo $i; done\n</code></pre></div></div>\n\n<h1 id=\"curl\">Curl</h1>\n\n<p>https://gist.github.com/subfuzion/08c5d85437d5d4f00e58</p>\n\n<ul>\n  <li>same url to some variable\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>export u=http://localhost:3000/api/v1/\ncurl $u/expenses\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>you can add <code class=\"highlighter-rouge\">-v</code> <code class=\"highlighter-rouge\">--verbose</code> option to see more info or save all\ncommunications with <code class=\"highlighter-rouge\">url $u --trace-ascii dump.txt</code></p>\n  </li>\n  <li>see headers</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>curl $u/expenses -I # or --head fetch the headers only\ncurl $u/expenses -i # or --include show also the response headers\n</code></pre></div></div>\n\n<ul>\n  <li>to keep session in curl you can <code class=\"highlighter-rouge\">-c</code> write and <code class=\"highlighter-rouge\">-b</code> read from cookie file\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>curl -c ~/Downloads/cookiefile -b ~/Downloads/cookiefile http://www.google.com\n</code></pre></div>    </div>\n  </li>\n  <li>test the speed on ssh on remote server:\n    <ul>\n      <li>download: <code class=\"highlighter-rouge\">curl -o /dev/null http://speedtest.qsc.de/1GB.qsc</code></li>\n      <li>upload: generate large file <code class=\"highlighter-rouge\">fallocate -l 1G gentoo_root.img</code> and use scp to\ntest upload link</li>\n    </ul>\n  </li>\n  <li>limit the speed to simulate slow connections <code class=\"highlighter-rouge\">curl $u limit-rate 100</code> or using</li>\n</ul>\n<p><a href=\"https://github.com/bcoe/crapify\">https://github.com/bcoe/crapify</a>. But this is only for downloading, server\nrenders quickly. Only way to simulate high response time is with <code class=\"highlighter-rouge\">sleep 5</code></p>\n<ul>\n  <li>curl url must be inside <code class=\"highlighter-rouge\">''</code>, for example <code class=\"highlighter-rouge\">curl http://trk.in.rs?a=2&amp;b=3</code></li>\n  <li>to get json request use header tag Accept <code class=\"highlighter-rouge\">curl -H \"Accept: application/json\"\nhttp://localhost:3001/</code></li>\n  <li>set authorization header <code class=\"highlighter-rouge\">curl $u/expenses -H 'Authorization: Token token=\"c576f0136149a2e2d9127b3901015545\"'</code></li>\n  <li>user agent <code class=\"highlighter-rouge\">curl --user-agent \"Mozilla/4.73 [en] (X11; U; Linux 2.2.15 i686)\" $u</code></li>\n  <li>http basic auth <code class=\"highlighter-rouge\">curl $u -u username:password</code> or <code class=\"highlighter-rouge\">curl $u -u $ADMIN_USERNAME:$ADMIN_PASSWORD'</code>. Another format is inside uri <code class=\"highlighter-rouge\">curl http://$username:$password@localhost:3000</code></li>\n  <li>follow redirection <code class=\"highlighter-rouge\">curl $u --location</code> (it works also when performing POST,\nsince it will perfome GET to redirected url).</li>\n  <li>referrer <code class=\"highlighter-rouge\">curl $u --referer http://google.com</code></li>\n  <li>domain name resolution could be using resolve <code class=\"highlighter-rouge\">curl http://a.b:3000 --resolve\na.b:3000:127.0.0.1</code> so in rails <code class=\"highlighter-rouge\">request.host == 'a.b'</code></li>\n  <li>POST request is with <code class=\"highlighter-rouge\">--data</code> <code class=\"highlighter-rouge\">curl $u --data \"name=my name\"</code> (recent curl\nwill encode post data for you). To see how actual form sends data, save the page\nlocaly and change method to <code class=\"highlighter-rouge\">GET</code> so when you submit you can see data separated\nwith <code class=\"highlighter-rouge\">?</code> and <code class=\"highlighter-rouge\">&amp;</code></li>\n  <li>patch request on rails is done with <code class=\"highlighter-rouge\">--request PATCH</code> option</li>\n  <li>\n    <p>verifyhost</p>\n\n    <p>some sites prevents curl and ruby scripts, if gives forbidden or empty\nresponse: https://www.theguardian.com</p>\n  </li>\n</ul>\n\n<h1 id=\"ssh\">SSH</h1>\n\n<p>You can enable ssh agent forwaring so remote connection can use your keys. When\nis it enabled there is <code class=\"highlighter-rouge\">env | grep SSH_AUTH_SOCK</code> environment variable. You can\nenable with <code class=\"highlighter-rouge\">ssh -A</code> option.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ssh -A vagrant@127.0.0.1 -p 2222 'env | grep SSH_AUTH_SOCK'\n</code></pre></div></div>\n\n<p>Connect using pem or rsa key is\n~~\nssh -i $PEM_FILE host</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\nYou can see more logs\n```\nssh host -vvv\n```\nWhen there is no connection to the host, you can check with\n```\n# you can see ssh version\nnc -w 10 192.168.1.3 22\nSSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.6\n\n# or you can echo true or false in case of timeout\nnc -w 10 192.168.1.3 22 &amp;&amp; echo true || echo false\n```\nI had an issue with my old router connecting `SSH-2.0-OpenSSH_7.6p1\nUbuntu-4ubuntu0.1` so I need to connect directly to my ADSL. This problem was\nrelated to IPv6 on the server.\n\n`Too many authentication failures for` error is caused by inadvertently offering\nmultiple ssh keys to the server. You can limit to only one identity\n\n</code></pre></div></div>\n<p>ssh -i some_id_rsa -o IdentitiesOnly=yes host</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n# Rsyslog\n\nInstall\n[mongo](https://www.digitalocean.com/community/tutorials/how-to-install-mongodb-on-ubuntu-16-04)\n\n</code></pre></div></div>\n<p>sudo apt-key adv –keyserver hkp://keyserver.ubuntu.com:80 –recv EA312927\necho “deb http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.2 multiverse” | sudo tee /etc/apt/sources.list.d/mongodb-org-3.2.list\nsudo apt-get update\nsudo apt-get install -y mongodb-org</p>\n\n<p>cat « HERE_DOC | sudo tee -a /etc/systemd/system/mongodb.service\n[Unit]\nDescription=High-performance, schema-free document-oriented database\nAfter=network.target</p>\n\n<p>[Service]\nUser=mongodb\nExecStart=/usr/bin/mongod –quiet –config /etc/mongod.conf</p>\n\n<p>[Install]\nWantedBy=multi-user.target\nHERE_DOC</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n</code></pre></div></div>\n<p>sudo systemctl start mongodb\nsudo systemctl status mongodb\nsudo systemctl enable mongodb</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\nhttps://datatables.net/development/server-side/php_mongodb\n\n# MACBook macOS\n\nxprop for macos can be installed using: `sudo port install xdotool`\nFind and xargs can be used also:\n\n</code></pre></div></div>\n<p>find . -name .DS_Store -print0 | xargs -0 git rm -f –ignore-unmatch</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n[xsel](https://linux.die.net/man/1/xsel) equivalent is\n[pbcopy](https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man1/pbcopy.1.html)\nso I use [is_mac_os]() to determine os.\n\nI like mac Cmd key so to use that on ubuntu, I need to remap keys. One solution\nis to switch ctrl and alt keys, but problem is that Alt+Tab, Alt+1, Ctrl+C,\nCrtl+D, should stay as it was.\n\n# Tips\n\n* history\n  * bash update history only on exit, but you can manually write with `history\n      -a` (do not do this for every command since multiple terminal will be\n      [interlieved](http://mywiki.wooledge.org/BashFAQ/088))\n  * to add command to history without executing it `history -s pwd`. Note that\n    this command if executing as param to bash will open new `history` file so\n    we can't have that command in history. Running history when you get console\n    is not the same when you pass history as param to bash command. For example\n    the following command will show pwd and empty history (if you repeat\n    `history` it will give you results) `gnome-terminal -x bash -lc \"cd\n    ~/Downloads;bash --rcfile &lt;(echo 'pwd;history;watch ls')\"`. Solution is to\n    add command before invoking bash like [here](\n* `cat /etc/issue` and `arch`\n\n</code></pre></div></div>\n<p>$ cat /etc/issue\n  # Ubuntu 16.04.1 LTS \\n \\l</p>\n\n<p>arch\n  # x86_64</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n* move file to another file appending some suffix without writting filename\ntwice\n\n</code></pre></div></div>\n<p>mv config/database.yml{,.example}</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n* get second string: `echo 'first second' | awk '{print $2}'`\n* in bash [3 kinds of variable\nsubstitution](http://www.linuxjournal.com/article/8919)\n  * pattern matching: deletes match `#` shortest from left, `##` longest from\n  left, `%` shortest from right, `%%` longest from right\n    * `NAME=${MYVAR%:*}`  retain the part before the colon `:`\n    * `NAME=${NAME##*/}`  retain the part after the last slash `/`\n  * substitution `${foo:-bar}`\n* [string manipulation](http://tldp.org/LDP/abs/html/string-manipulation.html)\n\n* `wget trk.in.rs --recursive` will download all files from the site.\n* sometimes when using multiprocess puma as rails server, I do not see what I'm\ntyping in\n[bash](https://askubuntu.com/questions/171449/shell-does-not-show-typed-in-commands-reset-works-but-what-happened)\nso I need to run `reset` command\n* to select vim as default editor for root, run `update-alternatives --config\neditor` and choose vim.basic\n* files need bit `r` to be able to read, `w` to write and `x` to list, search or\nsource included files.\nYou can see permissions for particular directory with `ls -ld`. To set for\nexample `chmod 644` is the same as `chmod u=rw,g=r,o=r`. To be able to source\nfile, parent folder needs to have `x` flag enabled.\n* to detect if it is linux or MacOS you can use\n</code></pre></div></div>\n<p>if [ “$(uname -s)” = “Darwin” ]; then\n  echo “==&gt; Bootstrapping Homebrew OSX environment”\nfi</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>* screen command\n  * `screen -r` to reattach to window (which you exited with Ctrl+A+D). Ctrl+A+]\n  to go to copy mode.\n* cheatsheet https://devhints.io/bash\n* `pbcopy` is only on mac\n* to prevent `ctrl-d` to exit terminal bash you can set `IGNOREEOF=3` so shell\n  only exists after the 3 consecutive Ctrl-d.\n* https://github.com/wting/autojump use j or autojump instead of cd change\n  directory\n* split long text files with `split -C 50m input output --numeric-suffixes`\n\n* in scripts use\n</code></pre></div></div>\n<p>set -e # Any commands which fail will cause the shell script to exit immediately\nset -x # show command being executed</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\nYou can read user input\n\n</code></pre></div></div>\n<p>read -p “enter fullname: “ fullname\nread -p “Continue? (Y/N): “ confirm &amp;&amp; [[ $confirm == [yY] || $confirm == [yY][eE][sS] ]] || exit 1</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n* xargs is used to convert stdin standard input to arguments for a commands.\n  can reference arguments with `-I '{}'`, limit number of lines `-L 2` before\n  it is executed (usefull for long running proccess to trigger commands). You\n  can not call custom functions since commands are executed in plain bash, but\n  you can use `sh` and params `{}` so there you can inline your script\n\n</code></pre></div></div>\n<p>echo 123 | xargs -0 -I ‘{}’ sh -c ‘echo {}’</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n* read from stdin works fine http://tldp.org/LDP/abs/html/internal.html#READREF\n  but not with pipe\n  &lt;https://stackoverflow.com/questions/2746553/bash-script-read-values-from-stdin-pipe/6779351#6779351&gt;\n  For pipe you need to simulate with `{ }`\n\n* add tab suggestions for your script using `complete` command\n  https://iridakos.com/tutorials/2018/03/01/bash-programmable-completion-tutorial\n* strip new line from command output `xdotool search --classname\n  vp_3_class_slash | tr -d '\\n'`\n* fan working when high temperature\n</code></pre></div></div>\n<p>sudo apt install lm-sensors\n  sudo sensors-detect\n  sensors</p>\n\n<p>sudo apt install hardinfo\n  hardinfo\n  ~~~</p>\n<ul>\n  <li>\n    <p>first line in scripts shebang for ruby using rvm instead of\n<code class=\"highlighter-rouge\">/usr/local/bin/ruby</code> can be\nhttps://stackoverflow.com/questions/17447532/what-is-the-use-of-usr-local-bin-ruby-w-at-the-start-of-a-ruby-program</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">#!/usr/bin/env ruby</span>\n</code></pre></div>    </div>\n  </li>\n  <li>list files with full path is using <code class=\"highlighter-rouge\">find $PWD</code> or using <code class=\"highlighter-rouge\">-d</code>\noption <code class=\"highlighter-rouge\">ls -d -1 $PWD/*.*</code>\nlist files by regexp https://www.linuxjournal.com/content/bash-extended-globbing\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ls @(one|two).html\n</code></pre></div>    </div>\n    <p>ls sort by file size using <code class=\"highlighter-rouge\">ls -S</code></p>\n  </li>\n  <li><code class=\"highlighter-rouge\">df -h</code> and <code class=\"highlighter-rouge\">du -sh</code> can show how much is used or free</li>\n  <li><code class=\"highlighter-rouge\">df -i</code> show how much inodes are left. Zoneminder through mysql can use all of\nthem so you need to find and remove those files.\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>df -i\ndu -s --inodes /*\nfind . -xdev -printf '%h\\n' | sort | uniq -c | sort -k 1 -n\n</code></pre></div>    </div>\n\n    <p>To remove old kernel files you can run <code class=\"highlighter-rouge\">sudo apt-get autoremove</code></p>\n  </li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Ionic Begginer Examples",
      "category" : "",
      "tags"     : "ionic",
      "url"      : "/2016/01/27/ionic-begginer-examples/",
      "date"     : "2016-01-27 00:00:00 +0100",
      "content"  : "<h1 id=\"setup\">Setup</h1>\n\n<h2 id=\"android-sdk\">Android SDK</h2>\n\n<p>Download <a href=\"http://developer.android.com/sdk/installing/index.html?pkg=tools\">Android\nSDK</a> and\nexport path in your <code class=\"highlighter-rouge\">.bashrc</code> like <code class=\"highlighter-rouge\">export\nANDROID_HOME=/home/orlovic/Android/Sdk/</code>.</p>\n\n<p>Make <code class=\"highlighter-rouge\">android</code>, <code class=\"highlighter-rouge\">adb</code> and <code class=\"highlighter-rouge\">emulator</code> accessible with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo ln -s /home/orlovic/Android/Sdk/platform-tools/adb /usr/bin/\necho 'export PATH=\"$PATH:$HOME/orlovic/Android/Sdk/tools\"' &gt;&gt; ~/.bashrc\n# or\nsudo ln -s /home/orlovic/Android/Sdk/tools/android /usr/bin/\n\nandroid avd\nemulator @n4 &amp;\n</code></pre></div></div>\n\n<p><a href=\"http://source.android.com/source/initializing.html#configuring-usb-access\">Configure USB\naccess</a> with this command:</p>\n\n<p><code class=\"highlighter-rouge\">wget -S -O - http://source.android.com/source/51-android.rules | sed\n\"s/&lt;username&gt;/$USER/\" | sudo tee &gt;/dev/null /etc/udev/rules.d/51-android.rules;\nsudo udevadm control --reload-rules</code></p>\n\n<p>On new device go to settings to enable USB Debugging. Settings is hidden by\ndefault, to enable go Settings -&gt; About Phone -&gt; Build number then tap 5 times.\nThen go to Settings -&gt; Developer options and enable USB debugging. Also usefull\nis to enable Stay awake (screen will never sleep while charging).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>lsusb # find your model\nsudo vi /etc/udev/rules.d/51-android.rules\n# add your model with idVendor and idProduct\nsudo udevadm control --reload-rules\n# plug again your device\nadb kill-server\nadb devices\n</code></pre></div></div>\n\n<h2 id=\"download-ionic\">Download Ionic</h2>\n\n<p>Download ionic and cordova</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install -g cordova ionic\nionic start myIonic blank\ncd myIonic\ncat &gt;&gt; .gitignore &lt;&lt; HERE_DOC\n# from command ionic upload\n.io-config.json\n# bower packages\n./www/lib/\n# cordova js is managed by ionic\n./hooks/\nHERE_DOC\ngit init . &amp;&amp; git add . &amp;&amp; git commit -m \"ionic start\"\n</code></pre></div></div>\n\n<h1 id=\"run-ionic\">Run ionic</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ionic platform add android # this will install cordova-plugins-(console,device, splashscreeen,statusbar,whitelist)\ncordova plugin add ionic-plugin-keyboard # this is default plugin\n# prefer ionic CLI to cordova CLI because it adds to package.json\nionic plugin add cordova-plugin-camera\nionic state save # others pull the code, sync with `ionic state restore`\nionic upload\ngit add . &amp;&amp; git commit -m \"ionic add android &amp;&amp; ionic upload\"\nionic share some@email.com\n\nionic serve # to see it in browser (rebuild also)\n# to run in emulator with live reload and logs (rebuild also)\n# --target to select emulator\nionic emulate -lcs --target=googleapi21\nionic run --target 123123 # to run on device, find device name with adb devices\n# note that `run` will not rebuild, it will just install latest configured apk\n# note that it will rebuild and use env vars if `-l` parameter is used\nionic serve --nobrowser # it will not open new browser, so you can use existing\n</code></pre></div></div>\n\n<p><a href=\"https://github.com/driftyco/ionic-cli#advanced-serve-options\">livereload</a> use\nionic.config.yml to look <code class=\"highlighter-rouge\">watchPatterns</code> (default is <code class=\"highlighter-rouge\">www/js/*</code> and\n<code class=\"highlighter-rouge\">!www/css/**/*</code>).\nTo run gulp task you an use <code class=\"highlighter-rouge\">gulpStartupTasks: ['watch']</code> in <code class=\"highlighter-rouge\">ionic.config.yml</code>.\nIonic cli 2 <a href=\"https://forum.ionicframework.com/t/ionic2-cli-doesnt-run-gulp-tasks-on-ionic-serve/49085/3\">does not run gulp task on ionic\nserve</a>\nso you need to add in gulpfile.js (gulpSartupTasks will not help).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// gulpfile.js\ngulp.task('serve:before', ['default']);\ngulp.task('emulate:before', ['default']);\ngulp.task('run:before', ['default']);\n\n// default should run all tasks and watch task\ngulp.task('default', ['sass', 'coffee', 'jade', 'watch']);\n</code></pre></div></div>\n\n<h2 id=\"sass\">Sass</h2>\n\n<p>Note that sass is already in gulpfile, but it is not started. Follow <a href=\"https://github.com/driftyco/ionic-cli/blob/master/README.md#using-sass\">using\nsass</a>\ninstructions to link to compiled sass file.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ionic setup sass\ncat &gt;&gt; .gitignore &lt;&lt; HERE_DOC\n# when using /scss css is autogenerated\n./www/css/\nHERE_DOC\ngit rm www/css -r\ngit add . &amp;&amp; git commit -m \"ionic setup sass\"\n</code></pre></div></div>\n\n<h2 id=\"coffeescript\">Coffeescript</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; .gitignore &lt;&lt; HERE_DOC\n# coffee script files are all appended to one file\nwww/js/_coffeescript_build.js\nHERE_DOC\n\nsed -i ionic.project -e '/gulpSartupTasks/a \"coffee\",'\n\nsed -i gulpfile.js -e '/var sass/a \\\nvar coffee = require(\"gulp-coffee\");'\n\nsed -i gulpfile.js -e '/var paths/a \\\n  coffee: [\"./www/**/*.coffee\"],'\n\nsed -i gulpfile.js -e '/gulp.task..watch/a \\\n  gulp.watch(paths.coffee, [\"coffee\"]);'\n\nsed -i gulpfile.js -e '/gulp.task..default/c \\\n  gulp.task(\"default\", [\"sass\", \"coffee\", \"watch\"]);'\n\ncat &gt;&gt; gulpfile.js &lt;&lt; 'HERE_DOC'\n\ngulp.task('coffee', function(done) {\n  gulp.src(paths.coffee)\n  .pipe(coffee({bare: true}).on('error', gutil.log))\n  .pipe(concat('_coffeescript_build.js'))\n  .pipe(gulp.dest('./www/js'))\n  .on('end', done);\n});\nHERE_DOC\n\n# add to package.json\nnpm install gulp-coffee gulp-concat --save\nsed -i www/index.html -e '/&lt;\\/head&gt;/i \\\n    &lt;!-- coffe script is bundled to this file --&gt;\\\n    &lt;script src=\"js/_coffeescript_build.js\"&gt;&lt;/script&gt;'\n\ngit add . &amp;&amp; git commit -m \"Enable coffee script\"\ntouch www/js/_coffeescript_build.js # just to not raise file not found error\n</code></pre></div></div>\n\n<p><del>Note that it does not work nice on first run <code class=\"highlighter-rouge\">ionic serve</code> , you need to\nupdate some coffee file to get pipe to reload.</del> \n<del>Note that we added coffee to ionic.project gulpStartupTasks, but sometimes\nbrowser cache will prevent some changes to show up, so try to reload the\npage.</del></p>\n\n<p>When I add dependency for default task, than javascript changes are not\nrecognized, sometimes… wip</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// gulpfile.js\ngulp.task('default', ['sass', 'coffee', 'jade']);\n</code></pre></div></div>\n\n<h2 id=\"jade\">Jade</h2>\n\n<p>Adding jade with: <code class=\"highlighter-rouge\">npm install gulp-jade --save-dev</code>. Than</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; .gitignore &lt;&lt; HERE_DOC\n# here we will build html from jade\nwww/jade_build\nHERE_DOC\nsed -i ionic.project -e '/gulpSartupTasks/a \"jade\",'\nsed -i gulpfile.js -e '/var sass/a \\\nvar jade = require(\"gulp-jade\");'\nsed -i gulpfile.js -e '/var paths/a \\\n  jade: [\"./www/**/*.jade\"],'\nsed -i gulpfile.js -e '/gulp.task..watch/a \\\n  gulp.watch(paths.jade, [\"jade\"]),'\ncat &gt;&gt; gulpfile.js &lt;&lt; 'HERE_DOC'\n\ngulp.task('jade', function (done) {\n  return gulp.src(paths.jade)\n    .pipe(jade())\n    .pipe(gulp.dest('www/jade_build/'));\n});\nHERE_DOC\ngit commit -am \"Enable jade\"\n# gulpfile.js\ngulp.task('default', ['sass', 'jade']);\n</code></pre></div></div>\n\n<p>You can convert <a href=\"/2016/04/05/javascript-coffeescript-tips/#jade\">all html files to jade</a> but please\ncheck them. <code class=\"highlighter-rouge\">index.html</code> should be in html format since that path <code class=\"highlighter-rouge\">www</code> is\nfixed.</p>\n\n<p>Also note that template path should be prefixed with <code class=\"highlighter-rouge\">jade_build</code> in your router\nfile, for example <code class=\"highlighter-rouge\">templateUrl: 'jade_build/js/dashboard/dashboard.html'</code> Check\nexample  of <a href=\"/2015/12/20/devise-oauth-angular/#angular-devise\">login controller for ionic</a></p>\n\n<h1 id=\"adding-constant-for-server_url\">Adding CONSTANT for SERVER_URL</h1>\n\n<p>You probably need to change api url from command line, since ionic does not pass\narguments to gulp command, we need to use env variables (note that they must be\nprefix ie before actual command). <a href=\"http://stackoverflow.com/questions/32179464/pass-parameters-to-gulp-task-through-ionic-serve?rq=1\">ionic has some problems passing parameters to gul</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># run with prefix env\nSERVER_URL=my-domain.local:3001 ionic serve\nSERVER_URL=production ionic emulate\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># put in your app\ncat &gt;&gt; www/js/app.constant.coffee &lt;&lt; HERE_DOC\nPRODUCTION_SERVER_URL = 'https://www.trk.in.rs'\nSTAGING_SERVER_URL = 'http://trk.herokuapp.com'\nLOCAL_SERVER_URL = 'http://mylocationsubdomain.my-domain.local:3001'\nSERVER_ENV_URL = 'staging' # this is default\nSERVER_URL = switch SERVER_ENV_URL\n  when 'production' then PRODUCTION_SERVER_URL\n  when 'staging' then STAGING_SERVER_URL\n  when 'local' then LOCAL_SERVER_URL\n  else SERVER_ENV_URL\nangular.module 'starter'\n  .constant 'CONSTANT',\n    SERVER_URL: SERVER_URL\n    ENV: SERVER_ENV_URL\nHERE_DOC\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># put to your gulpfile.js\nnpm install gulp-if gulp-replace --save-dev\nsed -i gulpfile.js -e '/shelljs/a \\\nvar replace = require(\"gulp-replace\");\\\nvar gulpif = require(\"gulp-if\");\\\n\\\nvar serverEnvUrl = false; // default is what is defined in constants.coffee\\\nif ([\"production\", \"staging\", \"local\"].indexOf(process.env.SERVER_ENV_URL) != -1) {\\\n  serverEnvUrl = process.env.SERVER_ENV_URL;\\\n  console.log(\"Using serverEnvUrl=\" + serverEnvUrl);\\\n} else if (process.env.SERVER_ENV_URL) {\\\n  serverEnvUrl = \"http://\" + process.env.SERVER_ENV_URL;\\\n  console.log(\"Using serverEnvUrl=\" + process.env.SERVER_ENV_URL);\\\n} else {\\\n  console.log(\"Using default SERVER_ENV_URL\");\\\n}'\n\nsed -i gulpfile.js -e '/gulp.src(paths.coffee/a \\\n  .pipe(gulpif(!!serverEnvUrl, replace(/SERVER_ENV_URL =.*/g, \"SERVER_ENV_URL = '\" + serverEnvUrl + \"'\")))'\n</code></pre></div></div>\n\n<h1 id=\"adding-other-packages-for-example-railsresource\">Adding other packages, for example RailsResource</h1>\n\n<p>When you add using <code class=\"highlighter-rouge\">bower install angularjs-rails-resource --save</code> you need also to include it in <code class=\"highlighter-rouge\">www/index.html</code> (it can be before or after app.js) and you need to declare dependency in <code class=\"highlighter-rouge\">www/app.js</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    &lt;!-- Rails Resource\n    https://github.com/FineLinePrototyping/angularjs-rails-resource --&gt;\n    &lt;script src=\"lib/angularjs-rails-resource/angularjs-rails-resource.js.min\"&gt;&lt;/script&gt;\n</code></pre></div></div>\n\n<p>Checkout <a href=\"/2015/12/20/devise-oauth-angular/#angular-devise\">adding angular-devise authentication</a></p>\n\n<h1 id=\"adding-tabs-templates\">Adding tabs templates</h1>\n\n<p>This patch was generated with <code class=\"highlighter-rouge\">git diff &gt; patchfile</code> and can be applied with\n<code class=\"highlighter-rouge\">patch -p1 &lt; patchfile</code></p>\n\n<p>You can create different tabs for different users. Just <code class=\"highlighter-rouge\">$state.go\n'customer-tabs.dashboard'</code> after customer logs in. Customer tabs are the same as\nuser tabs (abstract state, controller, template).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gh\">diff --git a/mobileApp/www/index.html b/mobileApp/www/index.html\nindex c0d6225..faa3c73 100644\n</span><span class=\"gd\">--- a/mobileApp/www/index.html\n</span><span class=\"gi\">+++ b/mobileApp/www/index.html\n</span><span class=\"gu\">@@ -22,12 +22,18 @@\n</span>   &lt;/head&gt;\n   &lt;body ng-app=\"starter\"&gt;\n \n<span class=\"gd\">-    &lt;ion-pane&gt;\n-      &lt;ion-header-bar class=\"bar-stable\"&gt;\n-        &lt;h1 class=\"title\"&gt;Ionic Blank Starter&lt;/h1&gt;\n-      &lt;/ion-header-bar&gt;\n-      &lt;ion-content&gt;\n-      &lt;/ion-content&gt;\n-    &lt;/ion-pane&gt;\n</span><span class=\"gi\">+    &lt;!--\n+      The nav bar that will be updated as we navigate between views.\n+    --&gt;\n+    &lt;ion-nav-bar class=\"bar-stable\"&gt;\n+      &lt;ion-nav-back-button&gt;\n+      &lt;/ion-nav-back-button&gt;\n+    &lt;/ion-nav-bar&gt;\n+    &lt;!--\n+      The views will be rendered in the &lt;ion-nav-view&gt; directive below\n+      Templates are in the /templates folder (but you could also\n+      have templates inline in this html file if you'd like).\n+    --&gt;\n+    &lt;ion-nav-view&gt;&lt;/ion-nav-view&gt;\n</span>   &lt;/body&gt;\n &lt;/html&gt;\n<span class=\"gh\">diff --git a/mobileApp/www/js/_coffeescript_build.js b/mobileApp/www/js/_coffeescript_build.js\n</span>deleted file mode 100644\n<span class=\"gh\">index e69de29..0000000\ndiff --git a/mobileApp/www/js/account/account.controller.coffee b/mobileApp/www/js/account/account.controller.coffee\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..ddcd815\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/account/account.controller.coffee\n</span><span class=\"gu\">@@ -0,0 +1,3 @@\n</span><span class=\"gi\">+angular.module 'starter'\n+  .controller 'AccountController', -&gt;\n+    vm = this\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/account/account.html b/mobileApp/www/js/account/account.html\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..2e72f67\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/account/account.html\n</span><span class=\"gu\">@@ -0,0 +1,9 @@\n</span><span class=\"gi\">+&lt;ion-view view-title=\"Account\"&gt;\n+  &lt;ion-content&gt;\n+    &lt;ion-list&gt;\n+    &lt;ion-toggle  ng-model=\"settings.enableFriends\"&gt;\n+        Enable Friends\n+    &lt;/ion-toggle&gt;\n+    &lt;/ion-list&gt;\n+  &lt;/ion-content&gt;\n+&lt;/ion-view&gt;\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/app.config.coffee b/mobileApp/www/js/app.config.coffee\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..ba02b6e\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/app.config.coffee\n</span><span class=\"gu\">@@ -0,0 +1,37 @@\n</span><span class=\"gi\">+angular.module 'starter'\n+  .config ($stateProvider, $urlRouterProvider) -&gt;\n+    $stateProvider\n+      .state 'tab',\n+        url: '/tab'\n+        abstract: true\n+        templateUrl: 'js/tabs/tabs.html'\n+      .state 'tab.dashboard',\n+        url: '/dashboard'\n+        views:\n+          'tab-dashboard':\n+            templateUrl: 'js/dashboard/dashboard.html'\n+            controller: 'DashboardController'\n+            controllerAs: 'vm'\n+    .state 'tab.chats',\n+        url: '/chats'\n+        views:\n+          'tab-chats':\n+            templateUrl: 'js/chats/chats.html'\n+            controller: 'ChatsController'\n+            controllerAs: 'vm'\n+      .state 'tab.chat-detail',\n+        url: '/chats/:chatId'\n+        views:\n+          'tab-chats':\n+            templateUrl: 'js/chats/chatDetails.html'\n+            controller: 'ChatDetailsController'\n+            controllerAs: 'vm'\n+      .state 'tab.account',\n+        url: '/account'\n+        views:\n+          'tab-account':\n+            templateUrl: 'js/account/account.html'\n+            controller: 'AccountController'\n+            controllerAs: 'vm'\n+\n+    $urlRouterProvider.otherwise '/tab/dashboard'\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/chats/chatDetails.controller.coffee b/mobileApp/www/js/chats/chatDetails.controller.coffee\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..f7768da\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/chats/chatDetails.controller.coffee\n</span><span class=\"gu\">@@ -0,0 +1,4 @@\n</span><span class=\"gi\">+angular.module 'starter'\n+  .controller 'ChatDetailsController', ($stateParams, Chats) -&gt;\n+    vm = this\n+    vm.chat = Chats.get $stateParams.chatId\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/chats/chatDetails.html b/mobileApp/www/js/chats/chatDetails.html\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..9ea8222\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/chats/chatDetails.html\n</span><span class=\"gu\">@@ -0,0 +1,8 @@\n</span><span class=\"gi\">+&lt;ion-view view-title=\"\"&gt;\n+  &lt;ion-content class=\"padding\"&gt;\n+    &lt;img ng-src=\"\" style=\"width: 64px; height: 64px\"&gt;\n+    &lt;p&gt;\n+      \n+    &lt;/p&gt;\n+  &lt;/ion-content&gt;\n+&lt;/ion-view&gt;\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/chats/chats.controller.coffee b/mobileApp/www/js/chats/chats.controller.coffee\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..029eedc\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/chats/chats.controller.coffee\n</span><span class=\"gu\">@@ -0,0 +1,15 @@\n</span><span class=\"gi\">+angular.module 'starter'\n+  .controller 'ChatsController', (Chats) -&gt;\n+    # With the new view caching in Ionic, Controllers are only called\n+    # when they are recreated or on app start, instead of every page change.\n+    # To listen for when this page is active (for example, to refresh data),\n+    # listen for the $ionicView.enter event:\n+    #\n+    #$scope.$on('$ionicView.enter', function(e) {\n+    #});\n+\n+    vm = this\n+    vm.chats = Chats.all()\n+    vm.remove = (chat) -&gt;\n+      Chats.remove(chat)\n+    console.log vm.chats\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/chats/chats.html b/mobileApp/www/js/chats/chats.html\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..89ad519\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/chats/chats.html\n</span><span class=\"gu\">@@ -0,0 +1,17 @@\n</span><span class=\"gi\">+&lt;ion-view view-title=\"Chats\"&gt;\n+  &lt;ion-content&gt;\n+    &lt;ion-list&gt;\n+      &lt;ion-item class=\"item-remove-animate item-avatar item-icon-right\"\n+        ng-repeat=\"chat in vm.chats\" type=\"item-text-wrap\" href=\"#/tab/chats/\"&gt;\n+        &lt;img ng-src=\"\"&gt;\n+        &lt;h2&gt;&lt;/h2&gt;\n+        &lt;p&gt;&lt;/p&gt;\n+        &lt;i class=\"icon ion-chevron-right icon-accessory\"&gt;&lt;/i&gt;\n+\n+        &lt;ion-option-button class=\"button-assertive\" ng-click=\"vm.remove(chat)\"&gt;\n+          Delete\n+        &lt;/ion-option-button&gt;\n+      &lt;/ion-item&gt;\n+    &lt;/ion-list&gt;\n+  &lt;/ion-content&gt;\n+&lt;/ion-view&gt;\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/dashboard/dashboard.coffee b/mobileApp/www/js/dashboard/dashboard.coffee\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..520b24e\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/dashboard/dashboard.coffee\n</span><span class=\"gu\">@@ -0,0 +1,4 @@\n</span><span class=\"gi\">+angular.module 'starter'\n+  .controller 'DashboardController', -&gt;\n+    vm = this\n+\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/dashboard/dashboard.html b/mobileApp/www/js/dashboard/dashboard.html\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..88c3906\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/dashboard/dashboard.html\n</span><span class=\"gu\">@@ -0,0 +1,5 @@\n</span><span class=\"gi\">+&lt;ion-view view-title=\"Dashboard\"&gt;\n+  &lt;ion-content class=\"padding\"&gt;\n+    &lt;h2&gt;Welcome to Ionic&lt;/h2&gt;\n+  &lt;/ion-content&gt;\n+&lt;/ion-view&gt;\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/resources/chats.resource.coffee b/mobileApp/www/js/resources/chats.resource.coffee\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..4aa4755\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/resources/chats.resource.coffee\n</span><span class=\"gu\">@@ -0,0 +1,33 @@\n</span><span class=\"gi\">+angular.module('starter')\n+  .factory 'Chats', -&gt;\n+    # Might use a resource here that returns a JSON array\n+    # Some fake testing data\n+    chats = [\n+      {\n+        id: 0\n+        name: 'Ben Sparrow'\n+        lastText: 'You on your way?'\n+        face: 'img/ben.png'\n+      }\n+      {\n+        id: 1\n+        name: 'Max Lynx'\n+        lastText: 'Hey, it\\'s me'\n+        face: 'img/max.png'\n+      }\n+    ]\n+    {\n+      all: -&gt;\n+        chats\n+      remove: (chat) -&gt;\n+        chats.splice chats.indexOf(chat), 1\n+        return\n+      get: (chatId) -&gt;\n+        i = 0\n+        while i &lt; chats.length\n+          if chats[i].id == parseInt(chatId)\n+            return chats[i]\n+          i++\n+        null\n+\n+    }\n</span><span class=\"gh\">diff --git a/mobileApp/www/js/tabs/tabs.html b/mobileApp/www/js/tabs/tabs.html\n</span>new file mode 100644\n<span class=\"gh\">index 0000000..8fb1726\n</span><span class=\"gd\">--- /dev/null\n</span><span class=\"gi\">+++ b/mobileApp/www/js/tabs/tabs.html\n</span><span class=\"gu\">@@ -0,0 +1,25 @@\n</span><span class=\"gi\">+&lt;!--\n+Create tabs with an icon and label, using the tabs-positive style.\n+Each tab's child &lt;ion-nav-view&gt; directive will have its own\n+navigation history that also transitions its views in and out.\n+--&gt;\n+&lt;ion-tabs class=\"tabs-icon-top tabs-color-active-positive\"&gt;\n+\n+  &lt;!-- Dashboard Tab --&gt;\n+  &lt;ion-tab title=\"Status\" icon-off=\"ion-ios-pulse\"\n+    icon-on=\"ion-ios-pulse-strong\" href=\"#/tab/dashboard\"&gt;\n+    &lt;ion-nav-view name=\"tab-dashboard\"&gt;&lt;/ion-nav-view&gt;\n+  &lt;/ion-tab&gt;\n+\n+  &lt;!-- Chats Tab --&gt;\n+  &lt;ion-tab title=\"Chats\" icon-off=\"ion-ios-chatboxes-outline\" icon-on=\"ion-ios-chatboxes\" href=\"#/tab/chats\"&gt;\n+    &lt;ion-nav-view name=\"tab-chats\"&gt;&lt;/ion-nav-view&gt;\n+  &lt;/ion-tab&gt;\n+\n+  &lt;!-- Account Tab --&gt;\n+  &lt;ion-tab title=\"Account\" icon-off=\"ion-ios-gear-outline\" icon-on=\"ion-ios-gear\" href=\"#/tab/account\"&gt;\n+    &lt;ion-nav-view name=\"tab-account\"&gt;&lt;/ion-nav-view&gt;\n+  &lt;/ion-tab&gt;\n+\n+\n+&lt;/ion-tabs&gt;\n</span></code></pre></div></div>\n\n<p>Some version of node have problem starting emulator, so you can start manually\n<code class=\"highlighter-rouge\">emulator @n4 &amp;</code></p>\n\n<p>Generate\n<a href=\"http://ionicframework.com/blog/automating-icons-and-splash-screens/\">icons</a>\nwith <code class=\"highlighter-rouge\">ionic resources</code>. If you update icons than you should run with option\n<code class=\"highlighter-rouge\">--ignore-cache</code> so it does not use cached tmp files <code class=\"highlighter-rouge\">ionic resources\n--ignore-cache</code> (maybe size is too big).</p>\n\n<h1 id=\"ionicmodal\">IonicModal</h1>\n\n<p>Nice feature is to put forms inside\n<a href=\"http://ionicframework.com/docs/api/service/$ionicModal/\">$ionicModal</a>\nYou should clear data when modal is canceled</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># www/js/login/login.jade\n          .text-center\n            a(ng-click=\"vm.resetPasswordModal.show()\") Forgot Password?\n\n# www/js/login/login.controller.coffee\nangular.module 'starter'\n  .controller 'LoginController', ($ionicModal, $scope) -&gt;\n    vm.usernameOrMobileNo = ''\n    $ionicModal.fromTemplateUrl(\n      'jade_build/js/login/resetPassword.html'\n      scope: $scope\n    ).then (modal) -&gt;\n      vm.resetPasswordModal = modal\n\n    # clear modal fields when user cancel modal\n    $scope.$on 'modal.hidden', -&gt;\n      vm.usernameOrMobileNo = ''\n\n    vm.resetPassword = (usernameOrMobileNo) -&gt;\n      CustomerAuth.resetPassword(usernameOrMobileNo).then(\n        (response) -&gt;\n          vm.resetPasswordModal.hide()\n          NotifyService.toast response.data.message\n          vm.usernameOrMobileNo = ''\n        NotifyService.errorToast\n      )\n\n# www/js/login/resetPassword.jade\nion-modal-view\n  ion-header-bar.bar.bar-header.bar-positive\n    h1.title Reset Password\n    button.button.button-clear.button-primary(ng-click=\"vm.resetPasswordModal.hide()\") Cancel\n  ion-content\n    form(ng-submit='vm.resetPassword(vm.usernameOrMobileNo)' ng-autodisable\n      ng-autodisable-class=\"processing\")\n      label.item.item-input.item-stacked-label\n        span.input-label Username Or Mobile Number\n        input(type=\"text\" placeholder=\"Enter your username or mobile number\"\n        ng-init=\"vm.usernameOrMobileNo=''\"\n        ng-model=\"vm.usernameOrMobileNo\")\n      .padding\n        button.button.button-block.button-positive(type=\"submit\") Submit\n\n</code></pre></div></div>\n\n<h1 id=\"common-errors\">Common errors</h1>\n\n<p>For <code class=\"highlighter-rouge\">INSTALL_FAILED_OLDER_SDK</code> you need to lower sdk version requirement.\nIonic drop support below <a href=\"http://stackoverflow.com/questions/30203266/cordova-build-release-android-always-picks-the-highest-api-level\">SDK\n14</a>\nso in your <code class=\"highlighter-rouge\">config.xml</code> put</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;preference name=\"android-minSdkVersion\" value=\"14\"/&gt;\n</code></pre></div></div>\n\n<p>On <code class=\"highlighter-rouge\">adb install my_app.apk</code> you could get <code class=\"highlighter-rouge\">Failure\n[INSTALL_FAILED_ALREADY_EXISTS] rm failed for -f, No such file or directory</code>.\nOr Failure <code class=\"highlighter-rouge\">[INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES]</code> or\n<code class=\"highlighter-rouge\">[INSTALL_FAILED_UPDATE_INCOMPATIBLE]</code></p>\n\n<p>Solution is to remove old application. You can use my helper\n<code class=\"highlighter-rouge\">ionic_find_package_name</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>adb uninstall `ionic_find_package_name my_app.apk`\n\n# to find package name use ionic_find_package_name my_app.apk that is similar to\n~/Android/Sdk/build-tools/21.1.2/aapt dump badging my-app-debug.apk  | grep package\n</code></pre></div></div>\n\n<p>You can start cordova app main activity from command line with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>adb shell am start -a android.intent.action.MAIN -n `ionic_find_package_name my_app.apk`/.MainActivity\n</code></pre></div></div>\n\n<h2 id=\"emulator-tips\">Emulator tips</h2>\n\n<ul>\n  <li>copy paste links to emulator or device <code class=\"highlighter-rouge\">adb shell input text \"some text\"</code></li>\n  <li>new chrome will upcase first leter for some fields first name</li>\n  <li>old native browser on Android 4.0.3 does not support WebSockets</li>\n</ul>\n\n<h2 id=\"virtualbox-and-android-emulator\">VirtualBox and Android Emulator</h2>\n\n<p>If you want to emulate and get this error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ioctl(KVM_CREATE_VM) failed: Device or resource busy\nko:failed to initialize KVM\n</code></pre></div></div>\n\n<p>it’s because VirtualBox is running and using kvm. You can edit emulator\n<code class=\"highlighter-rouge\">tools/android --avd</code> to use some other than x86, for example <code class=\"highlighter-rouge\">armeabi-v7a</code>. Then they can work in the same time <code class=\"highlighter-rouge\">ionic serve --target myArmeabiDevice</code> <a href=\"http://stackoverflow.com/questions/16168799/android-emulator-and-virtualbox-cannot-run-at-same-time\">l</a>.\nBut <em>Intel Atom (x86)</em> is much faster. Also enable <em>Emulation Options:</em> <em>Use\nHost GPU</em>.</p>\n\n<h2 id=\"adb-devices-offline\">Adb devices offline</h2>\n\n<p>If your phone is <code class=\"highlighter-rouge\">offline</code>, try to shut down and turn on again.</p>\n\n<h1 id=\"debug-with-adb\">Debug with ADB</h1>\n\n<p>You can see android device logs with grep (key with space does not work)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>adb help 2&gt;&amp;1 | less -R\n# option needs to be before other arguments\nadb -e shell\nadb -d logcat | grep 'Web Console' # -d is for device only\nadb logcat | grep 'chromium\\|Web Console' # new androids use chromium\nadb install -r platforms/android/build/outputs/apk/android-debug.apk\n# adb help will show you that -r means replace\n\nadb -s emulator-5556 install my-app.apk # if you have two emulators you can\n# specify which emulator\nadb -d install my-app.apk # directs to only connected usb device\n\ntelnet localhost 5554\n  geo fix 19 45 # to fix gps location, first is longitude than latitude\n</code></pre></div></div>\n\n<h1 id=\"dns-for-local-server\">DNS for local server</h1>\n\n<p>On Android emulator <code class=\"highlighter-rouge\">127.0.0.1</code> will not point to your machine! Also your\n<code class=\"highlighter-rouge\">/etc/hosts</code> file will not be used. You can change <em>hosts</em> file on android\nphone. On old sdk all changes last only until you reboot emulator so in order to\nmake it permanent, we copied <strong>system.img</strong> to <strong>system-qemu.img</strong> (from your\nandroid sdk system image folder to your avd folder in your home) <a href=\"https//developer.android.com/studio/run/emulator-commandline.html#defaultimages\">about\nimages</a>.\n<code class=\"highlighter-rouge\">cp $ANDROID_HOME/system-images/android-17/default/x86/system.img ~/.android/avd/n4.avd/system-qemu.img</code>\nWe also needed to increase <strong>partition-size</strong>.</p>\n\n<p>On new SDK you only need to start emulator with option <strong>-writable-system</strong> and\n<strong>adb root;adb remount</strong> before those changes. You need to use\n<code class=\"highlighter-rouge\">-writable-system</code> option for all future starting of emulator because if won’t\nboot up.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>emulator -writable-system -avd n4 &amp;\nadb root\nadb remount\nadb pull /system/etc/hosts .\necho \"192.168.2.4 my-domain.local\" &gt;&gt; hosts\necho \"192.168.2.4 mylocationsubdomain.my-domain.local\" &gt;&gt; hosts\nadb push hosts /system/etc\nadb shell 'cat /etc/hosts'\n</code></pre></div></div>\n\n<h1 id=\"root-android-device\">Root android device</h1>\n\n<p><a href=\"https://www.xda-developers.com/root/\">xda root</a>.</p>\n\n<h1 id=\"releasing-the-app-and-deploy-to-google-play-store\">Releasing the app and deploy to google play store</h1>\n\n<p>If you don’t have a key, you should generate and always use that. If app is\nalready installed on a phone with different keys, user can not update it (since\nit uses the same package name, he needs to remove the app and than install\nagain).\nIf you lost the keystore, than only solution is to publish as different package\non <a href=\"https://play.google.com/apps/publish\">google play</a>. You need to rename\nexisting app <code class=\"highlighter-rouge\">Store Listing -&gt; Title</code> so you can create new one with same name.\nAlso you can not use the same package name so choose different if you are using\ndifferent key to sign.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>keytool -genkey -v -keystore ~/config/keys/my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000\n</code></pre></div></div>\n\n<p>You should remove all unnecessary stuff for\n<a href=\"http://ionicframework.com/docs/guide/publishing.html\">publishing</a> like <code class=\"highlighter-rouge\">cordova\nplugin rm cordova-plugin-console</code></p>\n\n<p>Also you need to update <code class=\"highlighter-rouge\">config.xml</code> to customize your project.</p>\n\n<ul>\n  <li>use your reverse domain for widget id: <code class=\"highlighter-rouge\">id=rs.in.trk.123</code></li>\n  <li>customize name, description and author</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cordova build --release android\n# this will generate platforms/android/build/outputs/apk/android-release-unsigned.apk\njarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore ~/config/keys/my-release-key.keystore platforms/android/build/outputs/apk/android-release-unsigned.apk alias_name # this change the file inline\nzipalign -v 4 platforms/android/build/outputs/apk/android-release-unsigned.apk my_app.apk\n</code></pre></div></div>\n\n<p>You can use\n<a href=\"https://github.com/duleorlovic/config/blob/master/my_bashrc.sh\">ionic_publish</a>\nmy bash function.</p>\n\n<p>When you want to publish another release, you need to update <code class=\"highlighter-rouge\">config.xml</code>\nversion attribute (do not touch id attribute).</p>\n\n<p>On google play, when you create new application and upload apk, you need to fill\nstore listing: title, short and full description, high-res icon, feature\ngraphic, 2 non android screenshots, target country, mark as free app…</p>\n\n<h1 id=\"old-browsers\">Old browsers</h1>\n\n<p>Since old phones without Chromium suffer from poor javascript performance, maybe\n<a href=\"https://crosswalk-project.org/\">crosswalk</a> could help.</p>\n\n<h1 id=\"ngcordova\">NgCordova</h1>\n\n<p>When you use wrapper around some plugin than you need to install\n<a href=\"http://ngcordova.com/docs/install/\">ngCordova</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bower install ngCordova\nsed -i www/index.html -e '/&lt;\\/head&gt;/i \\\n    &lt;!-- ngCordova that is installed using bower --&gt;\\\n    &lt;script src=\"lib/ngCordova/dist/ng-cordova.js\"&gt;&lt;/script&gt;'\n</code></pre></div></div>\n\n<p>Angular <a href=\"https://docs.angularjs.org/api/ng/provider/$logProvider\">$log</a>\nservice <code class=\"highlighter-rouge\">$log.debug(myObj);</code> can be used and disabled easilly in\napp.config.js with <code class=\"highlighter-rouge\">$logProvider.debugEnabled(false)</code> so only <code class=\"highlighter-rouge\">$log.error()</code>\nor <code class=\"highlighter-rouge\">$log.info()</code> will be shown (don’t know how to disable those two).</p>\n\n<p>If you see <code class=\"highlighter-rouge\">[object Object]</code> (probably old angular version) than you can use\n<code class=\"highlighter-rouge\">$log.debug(JSON.stringify(response.data));</code>. Better way is to create\n<code class=\"highlighter-rouge\">window.log</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># www/js/app.js\nwindow.old_console = window.console;\nwindow.console = (function() {\n  var console = {};\n  console.log = function(message) {\n    if (typeof(message) == 'object')\n      message = JSON.stringify(message);\n    window.old_console.log(message);\n  };\n  return console;\n})();\n</code></pre></div></div>\n\n<h1 id=\"notifications\">Notifications</h1>\n\n<p>I would rather user android toast instead of ngMessages.\n<a href=\"https://github.com/EddyVerbruggen/Toast-PhoneGap-Plugin\">Toast-PhoneGap-Plugin</a>\nis a source for cordova-plugin-x-toast.\nWe could use wrapper <a href=\"http://ngcordova.com/docs/plugins/toast/\">$cordovaToast</a>,\nbut it is not neccessary.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cordova plugin add cordova-plugin-x-toast # or https://github.com/EddyVerbruggen/Toast-PhoneGap-Plugin.git\nionic state save\nmkdir www/js/services\ncat &gt;&gt; www/js/services/notify.service.coffee &lt;&lt; 'HERE_DOC'\nangular.module('starter')\n  .service 'NotifyService', () -&gt;\n    prepareMessage = (message) -&gt;\n      text = message;\n      if typeof message == 'object'\n        text = JSON.stringify(message)\n      text\n    this.toast = (message) -&gt;\n      text = prepareMessage(message)\n      if window.plugins &amp;&amp; window.plugins.toast\n        window.plugins.toast.show text, 'long', 'center'\n      else\n        alert text\n      console.log text\n    this.errorToast = (message) -&gt;\n      # if message is response, try to get message.data.error\n      this.toast(message)\n      # notify your server\n    this.log = (message) -&gt;\n      text = prepareMessage(message)\n      $log.debug text\n    return\nHERE_DOC\n</code></pre></div></div>\n\n<h1 id=\"content-security-policy\">Content security policy</h1>\n\n<p><a href=\"http://content-security-policy.com/\">http://content-security-policy.com/</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;meta</span> <span class=\"na\">http-equiv=</span><span class=\"s\">\"Content-Security-Policy\"</span> <span class=\"na\">content=</span><span class=\"s\">\"\n    default-src * 'self' data: gap: https://ssl.gstatic.com;\n    style-src 'self' 'unsafe-inline';\n    script-src * 'unsafe-inline';\n    media-src *;\n    \"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<ul>\n  <li>ui-router can add <code class=\"highlighter-rouge\">resolve: { auth: function($auth) { return\n$auth.validateUser() } }</code>, it will hang if user is not logged in. In ionic\nscreens are nested states so it will be blank page. Better is to use\ncompletelly different state and resolve auth on abstract tabs</li>\n  <li>ui-router for subpages should be on same level as page, since we render them\non whole <code class=\"highlighter-rouge\">&lt;ion-nav-view&gt;</code></li>\n  <li><a href=\"https://github.com/cyu/rack-cors\">rack-cors</a> use all actions <code class=\"highlighter-rouge\">[:get, :post,\n:delete, :put, :patch, :options, :head]</code>. I have strange error that all\nrequests were <em>OPTIONS</em> instead of <em>POST</em>.</li>\n</ul>\n\n<h1 id=\"ready\">Ready</h1>\n\n<p>For cordova plugins you should wait for ready and test if it exists.\n<code class=\"highlighter-rouge\">$ionicPlatform.ready</code> is also fired in browser, so you need to check if plugin\nexists.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>angular.module 'starter'\n  .controller 'DashCtrl', ($scope, $ionicPlatform) -&gt;\n    $ionicPlatform.ready -&gt;\n      window.SignalStrength &amp;&amp; window.SignalStrength.dbm (db) -&gt;\n        $scope.signal = db\n</code></pre></div></div>\n\n<h1 id=\"local-storage\">Local storage</h1>\n\n<p>Cookies are sent for each request, so do not use it to store data.\n<code class=\"highlighter-rouge\">localStorage</code> or <code class=\"highlighter-rouge\">sessionStorage</code> (expires when browser tab or window is\nclosed) is much more reliable.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>window.localStorage.setItem(\"url\", \"http://trk.in.rs\");\nwindow.localStorage.getItem(\"url\");\nwindow.localStorage.removeItem(\"url\");\n</code></pre></div></div>\n\n<h1 id=\"devise-authentication\">Devise authentication</h1>\n\n<p>For backend you should <a href=\"/2015/11/26/angular-and-ruby-on-rails/#cors\">enable CORS</a></p>\n\n<p><a href=\"/2015/12/20/devise-oauth-angular/\">angular_devise</a>\ngem works nice.\nJust follow README.</p>\n\n<p><a href=\"https://github.com/lynndylanhurley/ng-token-auth#authvalidateuser\">ng-token-auth#validateUser</a>\nis called on page load so user does not need to log in again.</p>\n\n<p>Token can be save to localStorage to work on device and emulator.\nI’ve not succeed to have working auth in browser for ionic.</p>\n\n<p>if something is not working, wipe <code class=\"highlighter-rouge\">node_modules</code> and run <code class=\"highlighter-rouge\">npm install</code></p>\n\n<p>LocalStorage (or ng-token-auth) does not work with <code class=\"highlighter-rouge\">emulator -l</code> livereload, so\ndon’t use <code class=\"highlighter-rouge\">-l</code>.</p>\n\n<p>Do not check if user is valid with <code class=\"highlighter-rouge\">angular.equals($scope.user, {})</code> in\ncontroller since <code class=\"highlighter-rouge\">validateUser</code> returns promise that will resolve after\ncontroller has been initialized.\nBetter is to</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// login.controller.js\n  $auth.validateUser()\n  .then(function() {\n    $state.go('tab.dashboard');\n  });\n</code></pre></div></div>\n\n<p>Or the best approach is to store all login state redirections in run</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code></code></pre></div></div>\n\n<p><a href=\"http://yeghishe.github.io/2015/08/13/my-gulp-files-ionic-app.html\">http://yeghishe.github.io/2015/08/13/my-gulp-files-ionic-app.html</a>\n<a href=\"https://github.com/pluralsight/guides/blob/master/published/front-end-javascript/ionic-framework-a-definitive-10-000-word-guide/article.md\">https://github.com/pluralsight/guides/blob/master/published/front-end-javascript/ionic-framework-a-definitive-10-000-word-guide/article.md</a></p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>to find ionic version run in browser and type in console <code class=\"highlighter-rouge\">ionic.version</code> (or\ngrep <code class=\"highlighter-rouge\">bower.json</code> file). <code class=\"highlighter-rouge\">ionic -v</code> will give you ionic CLI version which is\nnot related to ionic version</li>\n  <li>to clean files that are inside www but git ignored, you can <code class=\"highlighter-rouge\">git clean -xdf\nwww</code> but you need to <code class=\"highlighter-rouge\">npm install &amp;&amp; bower install</code></li>\n  <li>\n    <p><a href=\"http://ionicframework.com/docs/api/directive/ionRefresher/\">ion-refresher</a> is\nnice widget to refresh on pulling. For automatic refresh when you navigate to\npreview view</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  # With the new view caching in Ionic, Controllers are only called\n  # when they are recreated or on app start, instead of every page change.\n  # To listen for when this page is active (for example, to refresh data),\n  # listen for the $ionicView.enter event:\n  #\n  #$scope.$on('$ionicView.enter', function(e) {\n  #});\n</code></pre></div>    </div>\n\n    <p>This is also called on initial navigation (when controller is instantiated).\nSo I write like</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  # www/js/customers/customers.controller.coffee\n  $scope.$on '$ionicView.enter', (e) -&gt;\n    vm.doRefresh()\n</code></pre></div>    </div>\n\n    <p>If you want to reload whole app (probably you want to clear some cache of\ncontrollers and services), go to root or login url and reload. On some old\ndevices it will stay on that page (account page) and reload, which is not as\nintended.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  console.log \"You have been signed out\"\n  $state.go 'login'\n  window.location.reload() # this is not necessary\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>external links can not be used but you can use plugin inappbrowser\n<a href=\"https://www.thepolyglotdeveloper.com/2014/07/launch-external-urls-ionicframework/\">link</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cordova plugin add cordova-plugin-inappbrowser\n\n# www/js/login/login.controller.coffee\n  vm.open = -&gt;\n    cordova.InAppBrowser.open(\n      'http://www.google.com'\n      '_blank'\n      'location=yes'\n    )\n</code></pre></div>    </div>\n\n    <p>if you want to run some javascript than you should use\n<a href=\"https://gist.github.com/esfand/9638882\">jQueryLite</a> since it already exists\nin app or <a href=\"https://gist.github.com/thegitfather/9c9f1a927cd57df14a59c268f118ce86\">vanila\njavascript</a>\n<code class=\"highlighter-rouge\">console.log</code> inside page will be the same as in ionic app. If you need to\npost to external url which did not enable cors, you can not use <code class=\"highlighter-rouge\">$http.post</code>\nbut plain form submittion. Since I like to keep working in browser and\nemulator, I moved submit button outsite of form and than ng-click will submit\nthe form or load inappbrowser and pass the data.\nClosing inappbrowser could be navigating to <code class=\"highlighter-rouge\">mobile/close</code> for which I set\neventListener. Passing data to inappbrowser could be with <code class=\"highlighter-rouge\">executeScript</code> and\nretrieving with <code class=\"highlighter-rouge\">executeScript</code> with callback.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n# www/js/dashboard.controller.coffee\n  vm.proceedOnlinePayment = (paymentFields) -&gt;\n    # since cors is not enabled we will use inappbrowser for device,\n    # or submit form for emulation\n    if window.cordova &amp;&amp; window.cordova.InAppBrowser\n      browser = cordova.InAppBrowser.open(\n        'payu-form.html'\n        '_blank'\n        'location=yes'\n      )\n      browser.addEventListener 'loadstop', -&gt;\n        console.log 'loadstop'\n        data =\n          form_fields: paymentFields.form_fields\n          url: paymentFields.payu_link\n        browser.executeScript(\n          code:\n            \"\"\"\n            processData('#{JSON.stringify(data)}');\n            console.log(\"calling processData from inappbrowser\");\n\n            \"\"\"\n        )\n    else\n      document.forms.myForm.submit()\n\n// www/js/dashboard/onlinePaymen.jade\nion-modal-view\n  ion-header-bar.bar.bar-header.bar-positive\n    h1.title \n    button.button.button-clear.button-primary(ng-click=\"onlinePaymentModal.hide()\") Cancel\n  ion-content\n    form(id=\"payment-form\" action=\"https://test.payu.in/_payment.php\"\n      accept-charset=\"UTF-8\" method=\"post\" name='myForm')\n      input(type=\"hidden\" ng-repeat=\"i in vm.paymentFields.form_fields\"\n      name=\"\" id=\"\" value=\"\")\n      label.item.item-input.item-stacked-label\n        span.input-label Total Amount\n        strong \n\n      div(ng-if=\"vm.paymentFields.example_credit_card\")\n        span This is example card used only in development\n        input(value=\"\")\n        div Name \n        div CCV \n        div Month/Year\n          | /\n    .padding\n      button.button.button-block.button-positive(ng-click=\"vm.proceedOnlinePayment(vm.paymentFields)\") Pay Now\n</code></pre></div>    </div>\n  </li>\n  <li>you can push your code and assets without going through app store. Ionic\nDeploy, Code Push, PhoneGap ContentSync, PhoneGap hydration.</li>\n  <li>use authentication can we implemented with 3th party service: Firebase Auth,\nGCP Auth, Auth.io, Auth0, Stormpath, Fabric Digits, Amazon Cognito, Azure Auth,\nIonic Auth</li>\n</ul>\n\n<h1 id=\"android-studio\">Android studio</h1>\n\n<p>if you receive error</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>org.gradle.api.tasks.TaskExecutionException: Execution failed for task ':app:transformClassesAndResourcesWithProguardForDebug'.\n</code></pre></div></div>\n\n<p>than disable minify</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/build.gradle\n#android {\n#  buildTypes {\n#    debug {\n-      minifyEnabled true\n+     minifyEnabled false\n</code></pre></div></div>\n\n<p>if you receive error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>java.lang.RuntimeException: com.android.builder.dexing.DexArchiveMergerException: Error while merging dex archives:\n</code></pre></div></div>\n\n<p>than</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/build.gradle\n# android {\n#   defaultConfig {\n+     multiDexEnabled true //important\n</code></pre></div></div>\n\n<p>if you receive error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>org.gradle.api.tasks.TaskExecutionException: Execution failed for task ':app:transformClassesWithMultidexlistForDebug'.\n</code></pre></div></div>\n\n<p>than you need to increase memory for dex\nhttps://stackoverflow.com/questions/32807587/com-android-build-transform-api-transformexception</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># local.properties\n+ org.gradle.jvmargs=-XX:MaxHeapSize\\=512m -Xmx512m\n\n# maybe this could help, but not neccessary\n# app/build.gradle\n# android {\n+    dexOptions {\n+        javaMaxHeapSize \"4g\" //specify the heap size for the dex process\n+    }\n</code></pre></div></div>\n\n<p>To Invalidate gradle cache you should go to File -&gt; Invalidate Caches /\nRestart…</p>\n\n<p>Build -&gt; Clean Project</p>\n\n<p>rm -rf .gradle/ app/build\n~~~</p>\n\n"
    } ,
  
    {
      "title"    : "Testing in javascript",
      "category" : "",
      "tags"     : "",
      "url"      : "/2016/01/08/testing-in-javascript/",
      "date"     : "2016-01-08 00:00:00 +0100",
      "content"  : "<h1 id=\"mocha\">Mocha</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install --save-dev mocha\n./node_modules/mocha/bin/mocha\n\n# or if you put in package.json\n# \"scripts\": {\n#   \"test\": \"mocha\"\n# }\n\nnpm test\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// test/test.js\nvar assert = require('assert');\ndescribe('alertTextShowHide', function() {\n  describe('#elementText', function() {\n    it('should show message', function() {\n      assert.equal(1, 1);\n    });\n  });\n});\n</code></pre></div></div>\n\n<h1 id=\"sinon\">Sinon</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install --save-dev sinon\n# var sinon = require('sinon');\n</code></pre></div></div>\n\n<h2 id=\"spy\">Spy</h2>\n\n<p>Spies can be used to test how many times, and how functions or methods are\ncalled</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>it('should call_method'), () =&gt; {\n  const spy = sinon.spy(object, 'method')\n  object.method(3)\n  assert(spy.withArgs(3).calledOnce)\n}\n</code></pre></div></div>\n\n<h1 id=\"todo\">TODO</h1>\n\n<p>gem ‘teaspoon-jasmine’\ngem ‘phantomjs’</p>\n\n<p>Teaspoon and jasmine</p>\n\n<p>Do not use <code class=\"highlighter-rouge\">it</code> outside of inner describe block</p>\n\n<p>Todo</p>\n\n<p>https://developers.google.com/web/updates/2017/06/headless-karma-mocha-chai</p>\n\n<p>https://medium.com/welldone-software/an-overview-of-javascript-testing-in-2018-f68950900bc3</p>\n"
    } ,
  
    {
      "title"    : "Ionic &amp; Rails Direct S3 image upload",
      "category" : "",
      "tags"     : "ionic, aws, s3, angular",
      "url"      : "/2015/12/24/ionic-direct-aws-s3-upload/",
      "date"     : "2015-12-24 00:00:00 +0100",
      "content"  : "<p>In rails you can upload using <a href=\"/2015/04/05/common-rails-bootstrap-snippets/\n#carrierwave-for-uploading\">carrierwave for uploading</a> which works also for direct uploading to AWS.</p>\n\n<p>But <a href=\"https://github.com/blueimp/jQuery-File-Upload\">jQuery-File-Upload</a>\nis much cleaner way of uploading and you can upload multiplefiles at once and\nyou can limit the size and choose name of uploaded files.\n<a href=\"https://devcenter.heroku.com/articles/direct-to-s3-image-uploads-in-rails\">heroku\ntutorial</a>\nuses\n<a href=\"http://docs.aws.amazon.com/sdkforruby/api/Aws/S3/PresignedPost.html\">PresignedPost</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# direct S3 uploading\ngem 'aws-sdk', '~&gt; 2'\nHERE_DOC\n\nsed -i config/secrets.yml -e '/^test:/i \\\n  # aws s3\\\n  aws_bucket_name: &lt;%= ENV[\"AWS_BUCKET_NAME\"] %&gt;\\\n  aws_access_key_id: &lt;%= ENV[\"AWS_ACCESS_KEY_ID\"] %&gt;\\\n  aws_secret_access_key: &lt;%= ENV[\"AWS_SECRET_ACCESS_KEY\"] %&gt;\\\n  # region is important for all non us-east-1 regions\\\n  aws_region: &lt;%= ENV[\"AWS_REGION\"] || \"us-east-1\" %&gt;\\\n'\n\ncat &gt;&gt; config/initializers/aws.rb &lt;&lt; HERE_DOC\nS3_MAX_FILE_SIZE = 10 * 1024 * 1024 # 10 MB\n\nAws.config.update({\n  region: Rails.application.secrets.aws_region,\n  credentials: Aws::Credentials.new(\n    Rails.application.secrets.aws_access_key_id,\n    Rails.application.secrets.aws_secret_access_key\n  ),\n})\n\nif Rails.application.secrets.aws_bucket_name\n  S3_BUCKET = Aws::S3::Resource.new.bucket(\n    Rails.application.secrets.aws_bucket_name\n  )\nelse\n  class FakeAws\n    def presigned_post(args)\n      Rails.logger.error \"Please provide AWS credentials\"\n      OpenStruct.new fields: {}, url: \"https://bucket-name.s3-ap-southeast-1.amazonaws.com\"\n    end\n  end\n  S3_BUCKET = FakeAws.new\nend\nHERE_DOC\n</code></pre></div></div>\n\n<p>To get aws keys add this to controller</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/constollers/posts_controller.rb\nbefore_action :set_s3_direct_post, only: [:new, :edit, :create, :update]\n\ndef set_s3_direct_post\n  @s3_direct_post = S3_BUCKET.presigned_post(\n    key: \"uploads/#{SecureRandom.uuid}/${filename}\",\n    success_action_status: '201', # Aws will respond with XML\n    acl: 'public-read',\n    content_length_range: 1..S3_MAX_FILE_SIZE,\n  )\nend\n</code></pre></div></div>\n\n<p>This is how we can use plugin</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt; app/assets/javascripts/direct_upload.coffee.erb &lt;&lt; 'HERE_DOC'\n@directUpload = ($fileInput, callback) -&gt;\n  progressBar  = $(\"&lt;div class='bar'&gt;&lt;/div&gt;\")\n  barContainer = $(\"&lt;div class='progress'&gt;&lt;/div&gt;\").append(progressBar)\n  $fileInput.after(barContainer)\n\n  url = $fileInput.data 'url'\n  formData = $fileInput.data 'formData'\n  $fileInput.fileupload(\n    fileInput: $fileInput\n    url: url\n    type: 'POST'\n    autoUpload: true\n    formData: formData\n    paramName: 'file'\n    dataType: 'XML'\n    replaceFileInput: true\n    acceptFileTypes: /(\\.|\\/)(gif|jpe?g|png|pdf)$/i\n    maxFileSize: &lt;%= S3_MAX_FILE_SIZE.to_s %&gt;\n    maxNumberOfFiles: 3\n    messages: {\n      maxFileSize: 'File exceeds maximum allowed size of &lt;%= ActionView::Base.new.number_to_human_size S3_MAX_FILE_SIZE %&gt;'\n      acceptFileTypes: 'File type should be: jpg, png or pdf'\n    }\n    progressall: (e, data) -&gt;\n      progress = parseInt(data.loaded / data.total * 100, 10)\n      progressBar.css('width', progress + '%')\n\n    start: (e) -&gt;\n      console.log 'start'\n      progressBar.\n        css('background', 'green').\n        css('display', 'block').\n        css('width', '0%').\n        text(\"Loading...\")\n\n    done: (e, data) -&gt;\n      console.log 'done'\n      progressBar.text(\"Uploading done\")\n\n      # extract key and generate URL from response\n      key = $(data.jqXHR.responseXML).find(\"Key\").text()\n      url = '//' + $fileInput.data('host') + '/' + key\n      callback(url)\n\n    fail: (e, data) -&gt;\n      console.log 'fail'\n      progressBar.\n        css(\"background\", \"red\").\n        text(\"Failed\")\n  ).on 'fileuploadprocessalways', (e, data) -&gt;\n    currentFile = data.files[data.index]\n    if (data.files.error &amp;&amp; currentFile.error)\n      # there was an error, do something about it\n      console.log(currentFile.error)\n      alert(currentFile.error)\nHERE_DOC\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/file_upload_adminlte.coffee\nwindow.setupFileUpload = ($fileInput)-&gt;\n  directUpload $fileInput, (url) -&gt;\n    randomId = Math.floor(Math.random() * 9999 + 100)\n    # here should we create new element with random number\n    #  name: 'customer[documents_attributes][' + randomId + '][key]'\n    if url.match(/\\.(png|jpeg|jpg|png)$/)\n      # create with img\n    else\n      # create with pdf\n\n    $('#file-list').append new_element\n</code></pre></div></div>\n\n<p>jQuery file upload <a href=\"https://github.com/blueimp/jQuery-File-Upload/wiki/Basic-plugin\">minimal\nsetup</a> requires\njQuery (usually already included in rails), jquery.ui.widget (you can find that\nin download package), jquery.fileupload.js. To make sure it is installed run in\nconsole <code class=\"highlighter-rouge\">console.log($().fileupload)</code>\nJust copy them to your asset path and include (<code class=\"highlighter-rouge\">require_tree .</code> probably loads\nin wrong order so it is better to manually include them).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/javascripts/application.js\n//= require jquery.ui.widget\n//= require jquery.fileupload\n//= require jquery.fileupload-process\n//= require jquery.fileupload-validate\n</code></pre></div></div>\n\n<p>Add some styles</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; app/assets/stylesheets/main.scss &lt;&lt; HERE_DOC\n.document {\n  padding: 5px;\n  .document-thumbnail {\n    width: 50px;\n    // for fa pdf icon\n    font-size: 50px;\n  }\n}\nHERE_DOC\n</code></pre></div></div>\n\n<p>You can save one or many urls in <code class=\"highlighter-rouge\">documents</code> field (type text) and use\n<code class=\"highlighter-rouge\">serialize :documents, Array</code> but if you have more logic its better to keep them\nin separate model</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g model document name key documentable:references{polymorphic}\nrake db:migrate\n\nsed -i app/models/document.rb -e '/^end/i \\\n  validates_presence_of :key\\\n\\\n  def file_name\\\n    \"#{key}\".split(\"/\").last\\\n  end'\n\nsed -i app/models/post.rb -e '/class Post/a \\\n  has_many :documents, as: :documentable\\\n  accepts_nested_attributes_for :documents, allow_destroy: true'\n\nsed -i app/controllers/posts_controller.rb -e '/params.require/c \\\n      params.require(:post).permit(\\\n        :name, :title,\\\n        documents_attributes: [:key, :name, :_destroy, :id]\\\n      )'\n</code></pre></div></div>\n\n<p>In form you can add new</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/posts/_form.html.erb\n    &lt;div id=\"file-list\"&gt;\n      &lt;%= f.fields_for :documents do |document_form| %&gt;\n        &lt;%= document_form.hidden_field :key %&gt;\n        &lt;div class=\"document row form-inline\"&gt;\n          &lt;%= link_to \"#\", \"data-toggle\" =&gt; \"modal\", \"data-target\" =&gt; \"#documentModal\", \"data-set-modal-source\" =&gt; \"http:#{document_form.object.key}\", class: 'col-sm-5' do %&gt;\n            &lt;% if document_form.object.key =~ /.\\.(png|jpeg|jpg|png)$/ %&gt;\n              &lt;img src='&lt;%= document_form.object.key %&gt;' class='document-thumbnail'&gt;\n            &lt;% else %&gt;\n              &lt;i class=\"fa fa-file-pdf-o document-thumbnail\" aria-hidden=\"true\"&gt;&lt;/i&gt;\n            &lt;% end %&gt;\n            &lt;%= document_form.object.file_name %&gt;\n          &lt;% end %&gt;\n          &lt;div class=\"col-sm-5\"&gt;\n            &lt;%= document_form.text_area :name, placeholder: \"My File Description\", skip_label: true %&gt;\n          &lt;/div&gt;\n          &lt;div class=\"col-sm-2\"&gt;\n            &lt;%= document_form.check_box :_destroy, label: \"Mark for delete\" %&gt;\n          &lt;/div&gt;\n        &lt;/div&gt;\n      &lt;% end %&gt;\n    &lt;/div&gt; &lt;!--&lt;div id=\"file-list\"&gt;--&gt;\n    &lt;div class=\"m-t-10 text-center\"&gt;\n      &lt;a href=\"#\" class=\"btn btn-success btn-block\" onclick=\"$('#fileupload').trigger('click')\"&gt;\n        &lt;i class=\"fa fa-plus\" aria-hidden=\"true\"&gt;&lt;/i&gt;\n        Add more files\n      &lt;/a&gt;\n    &lt;/div&gt;\n    &lt;%= file_field_tag \"files[]\", id: 'fileupload', multiple: true, data: { 'form-data': @s3_direct_post.fields, 'url': @s3_direct_post.url, 'host': URI.parse(@s3_direct_post.url).host }, style: 'position: absolute;left: -1500px' %&gt;\n    &lt;script&gt;\n      setupFileUpload($('#fileupload'))\n    &lt;/script&gt;\n</code></pre></div></div>\n\n<p>In view you can list</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  &lt;% if @post.documents.size.zero? %&gt;\n    No Documents available\n  &lt;% end %&gt;\n  &lt;% @post.documents.each do |document| %&gt;\n    &lt;div class=\"document row\"&gt;\n      &lt;%= link_to \"#\", \"data-toggle\" =&gt; \"modal\", \"data-target\" =&gt; \"#documentModal\", \"data-set-modal-source\" =&gt; \"http:#{document.key}\", class: 'col-sm-5' do %&gt;\n        &lt;% if document.key =~ /.\\.(png|jpeg|jpg|png)$/ %&gt;\n            &lt;img src='&lt;%= document.key %&gt;' class='document-thumbnail'&gt;\n          &lt;% else %&gt;\n            &lt;i class=\"fa fa-file-pdf-o document-thumbnail\" aria-hidden=\"true\"&gt;&lt;/i&gt;\n        &lt;% end %&gt;\n        &lt;%= document.file_name %&gt;\n      &lt;% end %&gt;\n      &lt;div class=\"col-md-6 document-name\"&gt;\n        &lt;%= document.name %&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  &lt;% end %&gt;\n</code></pre></div></div>\n\n<p>And you can preview in bootstrap modal</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;div id=\"documentModal\" class=\"modal fade\" role=\"dialog\"&gt;\n  &lt;div class=\"modal-dialog modal-lg\"&gt;\n    &lt;!-- Modal content--&gt;\n    &lt;div class=\"modal-content\"&gt;\n      &lt;div class=\"modal-header\"&gt;\n        &lt;button type=\"button\" class=\"close\" data-dismiss=\"modal\"&gt;&amp;times;&lt;/button&gt;\n        &lt;a href=\"\" id=\"download-link\"&gt;\n          &lt;h4 class=\"modal-title\"&gt;Download document\n            &lt;i class=\"icon-download-alt\"&gt;&lt;/i&gt;\n          &lt;/h4&gt;\n        &lt;/a&gt;\n      &lt;/div&gt;\n      &lt;div class=\"modal-body\"&gt;\n        &lt;img id=\"image-preview\" src=\"\" class=\"center-block\"&gt;\n        &lt;iframe src=\"\" frameborder=\"0\" width=\"100%\" class=\"iframe\" id=\"pdf-preview\"&gt;&lt;/iframe&gt;\n        &lt;%= image_tag 'loader.gif', class: 'center-block loader' %&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n&lt;/div&gt;\n</code></pre></div></div>\n\n<p>To limit max width in javascript you can use https://github.com/blueimp/jQuery-File-Upload/wiki/Client-side-Image-Resizing</p>\n\n<h1 id=\"aws-bucket\">AWS Bucket</h1>\n\n<ul>\n  <li>create a bucket <strong>video-uploading-demo</strong>. You can choose any region. But\nchoose one word (without dots) because of <em>Insecure connection</em> error</li>\n  <li>go to the <a href=\"https://console.aws.amazon.com/iam/home\">IAM page</a> to create user,\nsave credentials and create <a href=\"/2016/02/29/amazon-aws-s3/\">inline policy</a> to give access to the bucket\n<strong>video-uploading-demo</strong></li>\n  <li>I’m not sure about <a href=\"https://github.com/asafdav/ng-s3upload\">step 2</a> (grant\nput/delete and Upload/Delete permissions) since\nabove inline policy works fine for me</li>\n  <li>add CORS <code class=\"highlighter-rouge\">&lt;AllowedMethod&gt;POST&lt;/AllowedMethod&gt;&lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;</code> to Bucket -&gt; Properties -&gt;\nPermissions -&gt; Add Cors configuration <a href=\"/2016/02/29/amazon-aws-s3/#cors\">2016-02-29-amazon-aws-s3#cors</a></li>\n</ul>\n\n<h1 id=\"record-image\">Record image</h1>\n\n<p>Read docs on\n<a href=\"https://github.com/apache/cordova-plugin-camera\">cordova-plugin-camera</a> rather\nthan on <a href=\"http://ngcordova.com/docs/plugins/camera/\">ngCordova camera</a>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bower install ngCordova --save-dev\nsed -i '/&lt;\\/head&gt;/i \\\n    &lt;!-- plugins --&gt;\n    &lt;script src=\"lib/ngCordova/dist/ng-cordova.js\"&gt;&lt;/script&gt;\\\n' www/index.html\nionic plugin add cordova-plugin-camera\n</code></pre></div></div>\n\n<p>Example app <a href=\"https://github.com/sirius2013/Angluarjs-Ionic-Schedule-App\">Angluarjs-Ionic-Schedule-App</a></p>\n\n<p>Android emulator needs SD card before using camera, so add some MB in\n<code class=\"highlighter-rouge\">tools/android avd</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cordova plugin add cordova-plugin-file-transfer\n</code></pre></div></div>\n\n<p><a href=\"http://aws.amazon.com/articles/1434\">AWS S3</a> conditions can prevent user\nuploading on different location.</p>\n\n<p>starts-with should be set for all files…</p>\n"
    } ,
  
    {
      "title"    : "From simple Devise to Oauth on Angular",
      "category" : "",
      "tags"     : "angular, devise, oauth",
      "url"      : "/2015/12/20/devise-oauth-angular/",
      "date"     : "2015-12-20 00:00:00 +0100",
      "content"  : "<h1 id=\"devise\">Devise</h1>\n\n<p>Basic example application with <a href=\"https://github.com/plataformatec/devise\">Devise</a>\ndefault signup/login views.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt;HERE_DOC\n\n# user authentication\ngem 'devise'\nHERE_DOC\nbundle\nrails generate devise:install\ngit add . &amp;&amp; git commit -m \"rails g devise:install\"\nrails g devise User\nlast_migration\n# add:\n# t.string :name, null: false, default: ''\n# t.string :locale, null: false, default: ''\n# t.boolean :superadmin, null: false, default: false\n# uncomment Trackable and Confirmable and add_index\nrake db:migrate\ngit add . &amp;&amp; git commit -m \"rails g devise user\"\n</code></pre></div></div>\n\n<p>Copy views</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g devise:views\ngit add . &amp;&amp; git commit -m \"rails g devise:views\"\n</code></pre></div></div>\n\n<p>Override default devise views with my views with locales, follow instructions on\nhttps://github.com/duleorlovic/devise-views-i18n</p>\n\n<p>You can add facebook auth below.</p>\n\n<p>Read <em>config/initializers/devise.rb</em> about default configuration.\nYou need to set default sender:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># devise\nsed -i config/initializers/devise.rb -e '/mailer_sender/c \\\n  config.mailer_sender = Rails.application.secrets.mailer_sender'\n</code></pre></div></div>\n\n<p>You can use <code class=\"highlighter-rouge\">before_action :authenticate_user!</code> in controllers that will\nredirect to <code class=\"highlighter-rouge\">/users/sign_in</code>. You need to <a href=\"/2015/04/05/common-rails-bootstrap-snippets/\">set up\nemails</a>\nto actually receive registration email.</p>\n\n<p>If you enable <code class=\"highlighter-rouge\">lockable</code> than user will be locked when number of failed login\nattempts reaches 20. You can send internal notification when that happens by\noverriding devise mailer and method <code class=\"highlighter-rouge\">def unlock_instructions(record, token,\nopts={})</code></p>\n\n<p>When user is logged in, than in session there is a id of current_user\n<code class=\"highlighter-rouge\">session['warden.user.user.key'] # =&gt; [[9], \"$2a$10$TUfyHaPAWV.A1/6JLuCTGO\"]</code></p>\n\n<p>Errors like <code class=\"highlighter-rouge\">ActionView::Template::Error (undefined method new_confirmation_path\nfor Did you mean?  new_user_confirmation_path user_confirmation_path):</code> occurs\nwhen you add, for example <code class=\"highlighter-rouge\">confirmable</code> in model, but gem are already loaded in\nspring, so you need to <code class=\"highlighter-rouge\">spring stop</code> and restart rails server.</p>\n\n<p>To enable additional fields to be permited attributes for new columns, for\nexample <code class=\"highlighter-rouge\">:username</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class ApplicationController &lt; ActionController::Base\n  before_action :configure_permitted_parameters, if: :devise_controller?\n\n  protected\n\n  def configure_permitted_parameters\n    devise_parameter_sanitizer.permit(:sign_up, keys: [:username])\n  end\nend\n</code></pre></div></div>\n\n<p>Errors like <code class=\"highlighter-rouge\">NoMethodError (undefined method 'users_url' for\n#&lt;DeviseRegistrationsController:0x007ff6068d92b8&gt;):</code></p>\n\n<p>IF you need to check user.authenticate_with password you can use valid password</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>user.valid_password? 'new_password'\n</code></pre></div></div>\n\n<p>There are some modules which you can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/user.rb\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable, :confirmable,\n         :omniauthable\n</code></pre></div></div>\n\n<h1 id=\"sign-in-on-development\">Sign in on development</h1>\n\n<p>Put links to be able to sign in by GET request on staging and local</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/devise/sessions/new.html.erb\n&lt;% if Rails.env.development? || Rails.application.secrets.is_staging %&gt;\n  &lt;small&gt;\n    Only on development or staging\n    &lt;dl&gt;\n      &lt;dt&gt;admin&lt;/dt&gt;\n      &lt;dd&gt;\n        &lt;% User.joins(:club_users).where(club_users: { admin: true }).order(:created_at).limit(5).each do |user| %&gt;\n          &lt;%= link_to user.email, sign_in_development_path(user) %&gt;\n        &lt;% end %&gt;\n      &lt;/dd&gt;\n      &lt;dt&gt;non admin&lt;/dt&gt;\n      &lt;dd&gt;\n        &lt;% User.joins(:club_users).where(club_users: { admin: false }).order(:created_at).limit(10).each do |user| %&gt;\n          &lt;%= link_to user.email, sign_in_development_path(user) %&gt;\n        &lt;% end %&gt;\n      &lt;/dd&gt;\n    &lt;/dl&gt;\n  &lt;/small&gt;\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/pages_controller.rb\nclass PagesController &lt; ApplicationController\n  def home\n    @recent_activities = Result.joins(check_points: [:discipline])\n  end\n\n  def sign_in_development\n    return unless Rails.env.development? || Rails.application.secrets.is_staging\n\n    user = User.find params[:id]\n    sign_in :user, user, byepass: true\n    redirect_to params[:redirect_to] || root_path\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/routes.rb\n  get 'sign-in-development/:id', to: 'pages#sign_in_development', as: :sign_in_development\n</code></pre></div></div>\n\n<h1 id=\"devise-and-omniauth\">Devise and Omniauth</h1>\n\n<p>Read <a href=\"https://github.com/plataformatec/devise/wiki/OmniAuth:-Overview\">wiki</a> to\nadd facebook and google authentication. It’s easy installation.\nFor facebook we use\n<a href=\"https://github.com/mkdynamic/omniauth-facebook\">omniauth-facebook</a>\nand excellent <a href=\"https://www.youtube.com/watch?v=E_XACDrZSiI\">rails casts #360</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt;HERE_DOC\ngem 'omniauth-facebook'\ngem 'omniauth-google-oauth2', '0.2.5'\n# https://github.com/zquestz/omniauth-google-oauth2/issues/204\n# fix to 1.3.1 because of redirect_uri_mismatch\ngem \"omniauth-oauth2\", '1.3.1'\n# 1.2.1 to skip_jwt issue\n# Could not find a valid mapping for path \"/omniauth/google_oauth2/callback\"\nHERE_DOC\nbundle\nrails g migration AddOmniauthToUsers provider:index uid:index\nrake db:migrate\nsed -i config/initializers/devise.rb -e '/APP_ID/a \\\n  config.omniauth :facebook,\\\n                  Rails.application.secrets.facebook_key,\\\n                  Rails.application.secrets.facebook_secret,\\\n                  scope: \"public_profile,email\",\\\n                  info_fields: \"email,name\"\\\n  config.omniauth :google_oauth2,\\\n                  Rails.application.secrets.google_client_id,\\\n                  Rails.application.secrets.google_client_secret,\\\n                  {} # skip_jwt: true'\n# skip_jwt only needed for omniauth &gt; 1.2.2\n# https://github.com/zquestz/omniauth-google-oauth2/issues/197\n\nsed -i config/secrets.yml -e '/^test:/i \\\n  # Facebook Autentication\\\n  facebook_key: &lt;%= ENV[\"FACEBOOK_KEY\"] %&gt;\\\n  facebook_secret: &lt;%= ENV[\"FACEBOOK_SECRET\"] %&gt;\\\n  # Google signup\\\n  google_client_id: &lt;%= ENV[\"GOOGLE_CLIENT_ID\"] %&gt;\\\n  google_client_secret: &lt;%= ENV[\"GOOGLE_CLIENT_SECRET\"] %&gt;\\\n'\n</code></pre></div></div>\n\n<p>If you need to send some params to callback (for example current user, or some\nother state) you can do it and access using <code class=\"highlighter-rouge\">params['omniauth.params']</code> env\nfield.  There are also: <code class=\"highlighter-rouge\">[\"omniauth.strategy\", \"omniauth.origin\",\n\"omniauth.params\", \"omniauth.auth\"]</code>. <code class=\"highlighter-rouge\">omniauth.origin</code> is usefull to redirect\nback to the page on which he logs in.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i app/views/layouts/application.html.erb -e '/&lt;body&gt;/a \\\n&lt;%= link_to \"Sign in with Facebook\",\nuser_facebook_omniauth_authorize_path(my_param: 1) %&gt;'\n\nvi app/models/user.rb # add :omniauthable\n# no need for , :omniauth_providers =&gt; [:facebook], but :omniauthable is needed\n\n# config/routes.rb\n  devise_for :users, controllers: {\n    omniauth_callbacks: 'devise/my_omniauth_callbacks',\n    confirmations: 'devise/my_confirmations',\n    registrations: 'devise/my_registrations',\n  }\n\n# app/controllers/devise/my_omniauth_callbacks_controller.rb\nmodule Devise\n  class MyOmniauthCallbacksController &lt; OmniauthCallbacksController\n    # https://github.com/plataformatec/devise/wiki/OmniAuth:-Overview\n    # data is in request.env[\"omniauth.auth\"]\n    [:facebook, :google_oauth2, :twitter].each do |provider| # yaho_oauth2\n      define_method provider do\n        # use request.env[\"omniauth.params\"][\"my_param\"]\n        @user = User.from_omniauth(request.env[\"omniauth.auth\"])\n\n        if @user.persisted?\n          sign_in_and_redirect @user, event: :authentication\n          # this will throw if @user is not activated\n          set_flash_message(:notice, :success, kind: provider) if is_navigational_format?\n        else\n          session[\"devise.facebook_data\"] = request.env[\"omniauth.auth\"]\n          redirect_to new_user_registration_url\n        end\n      end\n    end\n    def failure\n      # this could be: no_authorization_code # when we did not whitelisted domain\n      # on facebook app settings\n      redirect_to root_path, alert: \"Can't sign in. #{request.env['omniauth.error'].try(:message)} #{request.env['omniauth.error.type']}\"\n    end\n  end\nend\n\n# app/models/user.rb\n  def self.from_omniauth(auth)\n    user = find_by(email: auth.info.email)\n    return user if user\n    # user changed his email on facebook\n    user = find_by(provider: auth.provider, uid: auth.uid)\n    return user if user\n    # create new user with some passwor\n    user = User.create!(\n      email: auth.info.email,\n      password: Devise.friendly_token[0, 20],\n      provider: auth.provider,\n      uid: auth.uid,\n    )\n    user.skip_confirmation! # this will just add confirmed_at = Time.now\n    # user.name = auth.info.name # assuming the user model has a name\n    # user.image = auth.info.image # assuming the user model has an image\n    user\n  end\n</code></pre></div></div>\n\n<p>If you need multiple identities per account than create separate table for\nidentity.</p>\n\n<p>Note this situations:</p>\n\n<ul>\n  <li>\n    <p>user changed email address (lost password for old one) and updated on\nfacebook profile. He should be able to add new email address, not just to\nchange old one. Maybe he used the same password which he can not recover. If\nuser can recover password only using original email than they are blocked.\nHackerrank has a button to “Add another email”.\nSo we should check if his facebook email address was updated and add add that\nemail to our database as well.</p>\n  </li>\n  <li>user click forgot password, it change password, than it is asked to login,\nthan he should not see again forgot password page</li>\n  <li>when user change the password it should stay logged in\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  current_user.password='asdfasdf'\n  current_user.password_confirmation='asdfasdf'\n  current_user.save!\n  bypass_sign_in current_user\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"facebook-app\">Facebook app</h1>\n\n<p>Is you use <code class=\"highlighter-rouge\">omniauth-facebook</code> alone than there are problems with devise (it\ndouble redirect and raise csrf exception). So do not use with devise, or\nconfigure devise to use facebook auth.</p>\n\n<ol>\n  <li>\n    <p>Create app on <a href=\"http://developers.facebook.com\">developers.facebook.com</a>. By\ndefault fb app is in development mode and can only be used by app admins,\ndevelopers and testers. Add Contact Email if not already there on\nhttps://developers.facebook.com/apps/FACEBOOK_APP_ID/settings/</p>\n  </li>\n  <li>\n    <p>For production you need to go <em>App Review</em>\nhttps://developers.facebook.com/apps/FACEBOOK_APP_ID/review-status/ and\ntoggle switch on</p>\n  </li>\n  <li>\n    <p>Add <em>Facebook Login</em> product and go to settings\nhttps://developers.facebook.com/apps/FACEBOOK_APP_ID/fb-login/ (before it was\ninside advance settings\nhttps://developers.facebook.com/apps/FACEBOOK_APP_ID/settings/advanced)\nFind input for <em>Valid OAuth redirect URIs</em> and fill with all links that are\nredirected. You can find the link on facebook error page url\n<code class=\"highlighter-rouge\">www.facebook.com/dialog/oauth?client_id=...&amp;redirect_uri=...</code>. You can add\njust domain (<code class=\"highlighter-rouge\">/omniauth/facebook/callback</code> is not needed)\nNote that this are server url (not frontend url):</p>\n\n    <ul>\n      <li><code class=\"highlighter-rouge\">http://localhost.local:3003</code></li>\n      <li><code class=\"highlighter-rouge\">http://localhost:9000</code> and for https also</li>\n      <li><code class=\"highlighter-rouge\">https://localhost.local:3003</code></li>\n    </ul>\n  </li>\n</ol>\n\n<p>Changes are visible immediatelly.\nMore on blog facebook share buttons.</p>\n\n<p>Notes:</p>\n\n<ul>\n  <li>no need to check if email is verified, since facebook will not allow\nunverified accounts to use oauth</li>\n</ul>\n\n<h1 id=\"google-console\">Google console</h1>\n\n<p>Create a project in <a href=\"https://console.developers.google.com/apis/\">https://console.developers.google.com/apis/</a> and enable\n<em>Google+ API</em>.\nCreate <em>OAuth 2.0 client ID</em> (or edit exists one clicking on its\nname) and set <em>Authorized redirect URIs</em> to all urls that will be used (not just\ndomain like for facebook, we need whole url path), like redirect_uri</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">http://localhost:3000/users/auth/google_oauth2/callback</code> this is default\n<code class=\"highlighter-rouge\">devise_for :users</code></li>\n  <li><code class=\"highlighter-rouge\">http://localhost:9000/omniauth/google_oauth2/callback</code> and also for https</li>\n  <li><code class=\"highlighter-rouge\">https://localhost.local/omniauth/google_oauth2/callback</code></li>\n  <li>also fill the <em>Authorized JavaScript origins</em> with domains and port like\n<code class=\"highlighter-rouge\">http://localhost.local</code>.</li>\n</ul>\n\n<p>Dont forget to save <strong>Changes needs 5 min to propagate</strong></p>\n\n<h1 id=\"twitter-app\">Twitter app</h1>\n\n<p>On <a href=\"https://apps.twitter.com/\">https://apps.twitter.com/</a> you can create application.\nSetup callbacks urls to point to you server, but this is not required with\ntwitter.\n<code class=\"highlighter-rouge\">app//keys</code> will give you TWITTER_API_KEY and TWITTER_API_SECRET</p>\n\n<p>Twitter\n<a href=\"https://github.com/arunagw/omniauth-twitter#authentication-hash\">response</a> do\nnot provide user’s email address.</p>\n\n<h1 id=\"linkedin\">Linkedin</h1>\n\n<p>Create app on <a href=\"https://www.linkedin.com/developer/apps\">https://www.linkedin.com/developer/apps</a> and save to\nLINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET.\nAdd <code class=\"highlighter-rouge\">gem 'omniauth-linkedin'</code></p>\n\n<h1 id=\"angular-authentication\">Angular authentication</h1>\n\n<p>I tried two approaches for authentication</p>\n\n<ul>\n  <li><a href=\"https://github.com/cloudspace/angular_devise\">angular_devise</a></li>\n  <li><a href=\"https://github.com/lynndylanhurley/ng-token-auth\">ng-token-auth</a></li>\n</ul>\n\n<p>For demo usage checkout my repository\n<a href=\"https://github.com/duleorlovic/angular-devise-ng-token-auth\">angular-devise-ng-token-auth</a></p>\n\n<h2 id=\"ng-token-auth-demo-example\">ng-token-auth demo example</h2>\n\n<p>Angular <a href=\"https://github.com/lynndylanhurley/ng-token-auth\">ng-token-auth</a> is\nused with\n<a href=\"https://github.com/lynndylanhurley/devise_token_auth\">devise-token-auth</a>.</p>\n\n<p>Run <a href=\"https://github.com/lynndylanhurley/ng-token-auth#development\">client</a> with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cd ng-token-auth\nnpm install\ncd test &amp;&amp; bower install\nvi config/default.yml # edit API_URL to match server port\n# SITE_DOMAIN is only required for sitemap\ncd ..\ngem install sass\ngulp dev\ngnome-open http://localhost:7777/\n</code></pre></div></div>\n\n<p>For server side you can see <a href=\"https://github.com/lynndylanhurley/devise_token_auth_demo/compare/dbf0a69b1e67e34862906c3d24747bc98ffff815...master\">devise_token_auth_demo\ncompare</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cd devise_token_auth_demo\nvi config/database.yml # change to your username\necho -e 'gem \"letter_opener\", :group =&gt; :development' &gt;&gt; Gemfile\nsed -i '/end$/i \\  config.action_mailer.delivery_method = :letter_opener' config/environments/development.rb\n\n# hosts should be the same as in ng-token-auth/test/config/default.html\n# config/environments/development.rb redirection url\n# OmniAuth.config.full_host = \"http://localhost.local:3003\"\n\nexport GITHUB_KEY=asd GITHUB_SECRET=asd GOOGLE_KEY=$GOOGLE_CLIENT_ID GOOGLE_SECRET=$GOOGLE_CLIENT_SECRET FACEBOOK_KEY=$FACEBOOK_KEY FACEBOOK_SECRET=$FACEBOOK_SECRET\nrails s\n</code></pre></div></div>\n\n<h2 id=\"ng-token-auth-from-scratch-with-yeoman\">ng-token-auth from scratch with Yeoman</h2>\n\n<p>When use signin, he get <code class=\"highlighter-rouge\">access-token</code> in Response Header. Than he uses that\n<code class=\"highlighter-rouge\">access-token</code> for next request (Request Header), and for it he gets new\n<code class=\"highlighter-rouge\">access-token</code> in response <a href=\"https://github.com/lynndylanhurley/devise_token_auth#token-header-format\">Token Header\nFormat</a></p>\n\n<p>IMPORTANT:</p>\n\n<p>Mount path is important. <code class=\"highlighter-rouge\">mount_devise_token_auth_for 'User', at: '/auth'</code> so if\nyou access <code class=\"highlighter-rouge\">api/v1</code> and <code class=\"highlighter-rouge\">api/v2/...</code> it will send headers. If you mount under\n<code class=\"highlighter-rouge\">api/v1/auth</code> than headers will not be send for <code class=\"highlighter-rouge\">api/v2/articles</code></p>\n\n<p>Rails 4.2.5 use uppercase header names (Access-Token), but that does not affect\nthe app. Also the method you fetch the resource does not matter, it could be\n$http, angular-rails-resource… headers will be send with ng-token-auth</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails new my_app\ncd my_app\ncat &gt;&gt; Gemfile &lt;&lt;HERE_DOC\n# user auth with devise and ng-token-auth\ngem 'devise_token_auth', '=0.1.37.beta4' # fix version because of url localhost:3000//api/ issue\n# github: 'lynndylanhurley/devise_token_auth'\ngem 'omniauth'\nHERE_DOC\nbundle\nrails g devise_token_auth:install User auth\nrake db:migrate\ngit add . &amp;&amp; git commit -m \"rails g devise_token_auth:install User auth\"\nrails g devise:install\ngit add . &amp;&amp; git commit -m \"rails g devise:install\"\n\n# leave original route auth for mount_devise_token_auth_for\n\n# config/environments/development.rb\n# OmniAuth.config.full_host = \"http://localhost:9000/\" # this is url for google callback, not needed since it will read from request\n\n# on registration, do not raise exception\nsed -i app/controllers/application_controller.rb \\\n-e '/end$/i\\\n  protect_from_forgery with: :null_session\\\n  respond_to :json'\n\n# allow unconfirmed access\nsed -i config/initializers/devise.rb -e '/config.allow_unconfirmed_access_for/a \\\n  config.allow_unconfirmed_access_for = 7.days'\n\n</code></pre></div></div>\n\n<p>Perform some <a href=\"/2015/04/05/common-rails-bootstrap-snippets/\">common bootstrap stuff for secrets and emails</a> and add <a href=\"#devise-and-omniauth\">oauth\ninstallation as above</a>.</p>\n\n<p>For client start with steps at <a href=\"/2015/11/26/angular-and-ruby-on-rails/\">2015-11-26-angular-and-ruby-on-rails</a>.</p>\n\n<p>We will use <a href=\"https://material.angularjs.org/latest/demo/dialog\">md-dialog</a> to\nshow signup buttons or login form in another\n<a href=\"https://material.angularjs.org/latest/demo/tabs\">tab</a>.</p>\n\n<p>I have some problems to stay logged in immediatelly after log in and than hit\nrefresh (while some params in url). We need to remove those params.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cd client\nbower install ng-token-auth --save\n\n# add module dependency\nsed -i src/app/index.module.coffee  -e \"/]/i \\  'ng-token-auth',\"\n\n# inject dependencies\nsed -i src/app/components/navbar/navbar.directive.coffee -e \":a;N;\\$!ba;s/    NavbarController.*return/$(sed ':a;N;$!ba;s/\\n/ћ/g;s:\\\\:\\\\\\\\:g;s:/:\\\\/:g;' &lt;&lt;'MY_TEXT'\n    NavbarController = (moment, $mdDialog, $auth, $rootScope) -&gt;\n      'ngInject'\n      dialog = null\n      vm = this\n      # \"vm.creation\" is avaible by directive option \"bindToController: true\"\n      vm.relativeDate = moment(vm.creationDate).fromNow()\n\n      vm.showLoginDialog = (ev) -&gt;\n        dialog = $mdDialog.show\n          controller: 'LoginController'\n          controllerAs: 'vm'\n          templateUrl: 'app/login/login.html'\n          parent: angular.element(document.body)\n          targetEvent: ev\n          clickOutsideToClose: true\n\n      vm.signOut = -&gt;\n        $auth.signOut()\n\n      $rootScope.$on 'auth:login-success', (ev, user) -&gt;\n        $mdDialog.hide dialog\n      return\nMY_TEXT\n)/g;s/ћ/\\n/g\"\n\n# add links\nsed -i src/app/components/navbar/navbar.html \\\n-e '/Contact/a \\\n    &lt;md-button href=\"#\" ng-show=\"!$root.user.id\" ng-click=\"vm.showLoginDialog()\"&gt;Try For Free&lt;/md-button&gt;\\\n    &lt;div ng-show=\"!!$root.user.id\"&gt;Hello { { $root.user.email }}&lt;/div&gt;\\\n    &lt;md-button href=\"#\" ng-show=\"!!$root.user.id\" ng-click=\"vm.signOut()\"&gt;Sign Out&lt;/md-button&gt;'\n\n# config routes since default /api/auth/facebook does not match rails /auth/:provider\nsed -i src/app/index.config.coffee \\\n-e 's/config (/config ($authProvider, /' \\\n-e '$a\\\n    $authProvider.configure\\\n      apiUrl: \"/\"\\\n      authProviderPaths:\\\n        google:   \"/auth/google_oauth2\"\\\n        facebook: \"/auth/facebook\"'\nmkdir src/app/login\ncat &gt; src/app/login/login.html &lt;&lt;\\HERE_DOC\n&lt;md-dialog aria-label=\"login\" ng-cloak&gt;\n  &lt;md-toolbar&gt;\n    &lt;div class=\"md-toolbar-tools\"&gt;\n      &lt;h2&gt;Try for free!&lt;/h2&gt;\n    &lt;/div&gt;\n  &lt;/md-toolbar&gt;\n  &lt;md-dialog-content&gt;\n    &lt;md-tabs md-selected=\"vm.tabsData.selectedIndex\" md-align-tabs=\"bottom\"\n    md-dynamic-height&gt;\n      &lt;md-tab label=\"defalt\"&gt;\n        &lt;md-content class=\"md-padding\"&gt;\n          &lt;md-button ng-click=\"$root.authenticate('google')\"&gt;Sign in with Gmail&lt;/md-button&gt;\n          &lt;md-button ng-click=\"$root.authenticate('facebook')\"&gt;Sign in with Facebook&lt;/md-button&gt;\n          &lt;md-button ng-click=\"vm.tabsData.selectedIndex=1\"&gt;\n            Sign in with email\n          &lt;/md-button&gt;\n        &lt;/md-content&gt;\n      &lt;/md-tab&gt;\n\n      &lt;md-tab label=\"Email\"&gt;\n        &lt;md-content class=\"md-padding\"&gt;\n          &lt;form ng-submit=\"vm.submitLogin(vm.login, loginForm)\" name=\"loginForm\" role=\"form\"&gt;\n            &lt;md-input-container class=\"md-block\"&gt;\n              &lt;label&gt;Email&lt;/label&gt;\n              &lt;input ng-model=\"vm.login.email\" ng-required=\"true\" name=\"email\" placeholder=\"Email\" type=\"email\"&gt;\n              &lt;div ng-messages=\"loginForm.email.$error\"&gt;\n                &lt;div ng-message=\"required\"&gt;Email is required.&lt;/div&gt;\n                &lt;div ng-message=\"server\"&gt;\n                  { { vm.serverErrors.login.email }}.\n                &lt;/div&gt;\n              &lt;/div&gt;\n            &lt;/md-input-container&gt;\n            &lt;md-input-container class=\"md-block\"&gt;\n              &lt;label&gt;Password&lt;/label&gt;\n              &lt;input ng-model=\"vm.login.password\" name=\"password\"\n              placeholder=\"Password\" type=\"password\" ng-required=\"true\"&gt;\n              &lt;div ng-messages=\"loginForm.password.$error\"&gt;\n                &lt;div ng-message=\"required\"&gt;Password is required.&lt;/div&gt;\n                &lt;div ng-message=\"server\"&gt;\n                  { { vm.serverErrors.login.join(', ') }}.\n                &lt;/div&gt;\n              &lt;/div&gt;\n            &lt;/md-input-container&gt;\n            &lt;md-button type=\"submit\" class=\"md-raised md-primary\"&gt;Sign in&lt;/md-button&gt;\n            or\n            &lt;md-button ng-click=\"vm.tabsData.selectedIndex=2\"&gt;\n              Register with email\n            &lt;/md-button&gt;\n          &lt;/form&gt;\n        &lt;/md-content&gt;\n      &lt;/md-tab&gt;\n\n      &lt;md-tab label=\"Registration\"&gt;\n        &lt;md-content&gt;\n          &lt;form name=\"registrationForm\"\n            ng-submit=\"vm.handleRegBtnClick(vm.registration, registrationForm)\" role=\"form\"&gt;\n            &lt;md-input-container class=\"md-block\"&gt;\n              &lt;md-icon&gt;email&lt;/md-icon&gt;\n              &lt;input ng-model=\"vm.registration.email\" type=\"email\"\n              placeholder=\"Email (required)\" ng-required=\"true\" name=\"email\"\n              ng-email=\"true\"&gt;\n              &lt;div ng-messages=\"registrationForm.email.$error\"&gt;\n                &lt;div ng-message=\"required\"&gt;Email is required.&lt;/div&gt;\n                &lt;div  ng-message=\"email\"&gt;Must look like email.&lt;/div&gt;\n                &lt;div ng-message=\"server\"&gt;\n                  { { vm.serverErrors.registration.email.join(', ') }}.\n                &lt;/div&gt;\n              &lt;/div&gt;\n            &lt;/md-input-container&gt;\n            &lt;md-input-container md-no-float class=\"md-block\"&gt;\n              &lt;input ng-model=\"vm.registration.password\" type=\"password\"\n              placeholder=\"password\" ng-required=\"true\" ng-minlength=6\n              ng-maxlength=20 name=\"password\"&gt;\n              &lt;div ng-messages=\"registrationForm.password.$error\"&gt;\n                &lt;div ng-message=\"required\"&gt;Password is required.&lt;/div&gt;\n                &lt;div ng-message=\"minlength,maxlength\"&gt;Password should be between 6 and 20\n                  chars.&lt;/div&gt;\n                &lt;div ng-message=\"server\"&gt;\n                  { { vm.serverErrors.registration.password.join(', ') }}.\n                &lt;/div&gt;\n              &lt;/div&gt;\n            &lt;/md-input-container&gt;\n            &lt;md-input-container md-no-float class=\"md-block\"&gt;\n              &lt;input ng-model=\"vm.registration.password_confirmation\"\n              type=\"password\" placeholder=\"Password confirmation\"\n              name=\"password_confirmation\" ng-required=\"true\"&gt;\n              &lt;div ng-messages=\"registrationForm.password_confirmation.$error\"&gt;\n                &lt;div ng-message=\"required\"&gt;Password confirmation is required.&lt;/div&gt;\n                &lt;div ng-message=\"password_match\"&gt;Passwords don't match.&lt;/div&gt;\n              &lt;/div&gt;\n              &lt;div\n            ng-messages=\"vm.serverErrors.registration.password_confirmation\"&gt;\n                &lt;div&gt;{ { vm.serverErrors.registration.password_confirmation.join(', ') }}&lt;/div&gt;\n              &lt;/div&gt;\n            &lt;/md-input-container&gt;\n\n            &lt;md-button type=\"submit\" class=\"md-raised md-primary\"\n            &gt;Register&lt;/md-button&gt;\n          &lt;/form&gt;\n        &lt;/md-content&gt;\n      &lt;/md-tab&gt;\n    &lt;/md-tabs&gt;\n  &lt;/md-dialog-content&gt;\n&lt;/md-dialog&gt;\nHERE_DOC\n\ncat &gt; src/app/login/login.controller.coffee &lt;&lt;\\HERE_DOC\nangular.module 'client'\n  .controller 'LoginController', ($mdDialog, $auth, $log, $scope) -&gt;\n    'ngInject'\n    vm = this\n    vm.login = {}\n    vm.registration = {}\n    # vm.registration =\n    #   email: 'asd@asd.asd'\n    #   password: 'asdasd'\n    #   password_confirmation: 'asdasd'\n    # vm.login =\n    #   email: 'asd@asd.asd'\n    #   password: 'asdasd'\n\n    vm.tabsData = {\n      selectedIndex: 0,\n    }\n\n    vm.submitLogin = (login, loginForm) -&gt;\n      handleError = (resp) -&gt;\n        loginForm.password.$setValidity('server',false)\n        $scope.vm.serverErrors =\n          login: resp.errors\n        $log.debug loginController: 'submitLogin handleError', resp_errors: resp.errors\n      $auth.submitLogin(login)\n        .then (resp) -&gt;\n          $log.debug  loginController: 'submitLogin then', resp: resp\n        .catch handleError\n      return\n\n    vm.handleRegBtnClick = (registration, registrationForm) -&gt;\n      handleError = (resp) -&gt;\n        for field of resp.data.errors\n          if registrationForm[field]\n            registrationForm[field].$setValidity('server',false)\n        $scope.vm.serverErrors =\n          registration: resp.data.errors\n        $log.debug 'handleError'\n      $auth.submitRegistration(registration)\n        .then (resp) -&gt;\n          $auth.submitLogin\n            email: $scope.vm.registration.email\n            password: $scope.vm.registration.password\n          $log.debug 'submitRegistration then'\n        .catch handleError\n    return\nHERE_DOC\n</code></pre></div></div>\n\n<p>When you want to override default initial behavior, for example create another\ntable that will hold identities, you need to override a lot of things\n<a href=\"https://github.com/lynndylanhurley/devise_token_auth/issues/23\">#23</a>\n<a href=\"https://github.com/lynndylanhurley/devise_token_auth/pull/453\">#453</a> Another\napproach (plan B) is to put your business logic in another model let say,\n<code class=\"highlighter-rouge\">participant</code> thas has many <code class=\"highlighter-rouge\">users</code>. This has a problem of assigning oauth\naccount to the current email-user participant (we need to pass current\nemail-user token to oauth session so we know that we can connect those two users\nto the same participant). Also adds new unnecessary model.</p>\n\n<p>Easiest solution is to add uniqueness to email field and rescue with signing in.\nThen we just repeat whole proccess from <code class=\"highlighter-rouge\">omniauth_success</code> from\ndevise_token_auth gem.\nSimilar approach is in this opensource rails angular app\n<a href=\"https://github.com/manshar/manshar/pull/177/files\">manshar</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g migration add_uniq_index_to_users\nsed -i db/migrate/*add_uniq_index_to_users* -e '/change/a\\\n    remove_index :users, :email\\\n    add_index :users, :email, unique: true'\nrake db:migrate\n\nsed -i config/routes.rb -e \"s^\\(mount_devise_token_auth_for.*$\\)^\\1, controllers: {\\n\\\n    omniauth_callbacks: 'users/omniauth_callbacks',\\n  }^\"\nmkdir app/controllers/users\ncat &gt; app/controllers/users/omniauth_callbacks_controller.rb &lt;&lt;\\HERE_DOC\nmodule Users\n  class OmniauthCallbacksController &lt;\n    DeviseTokenAuth::OmniauthCallbacksController\n\n    rescue_from ActiveRecord::RecordNotUnique,\n                with: :user_already_registered_with_this_email\n\n    def user_already_registered_with_this_email\n      # repeat whole omniauth_success method for this user\n      @resource = User.find_by_email(@resource.email)\n      # get_resource_from_auth_hash\n      create_token_info\n      set_token_on_resource\n      create_auth_params\n\n      if resource_class.devise_modules.include?(:confirmable)\n        # don't send confirmation email!!!\n        @resource.skip_confirmation!\n      end\n\n      sign_in(:user, @resource, store: false, bypass: false)\n\n      unless @resource.image.present?\n        @resource.image = auth_hash['info']['image']\n      end\n      @resource.save!\n\n      render_data_or_redirect(\n        'deliverCredentials',\n        @auth_params.as_json,\n        @resource.as_json\n      )\n    end\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<p>Also override session and password controller to use\n<code class=\"highlighter-rouge\">email</code> field instead of <code class=\"highlighter-rouge\">uid</code> field. That way oauth users can use email login\nand email users can use oauth login without rescue exceptions (only first time)</p>\n\n<p>Some links for Ionic authentication:</p>\n\n<ul>\n  <li>Ionic does not like ipCookies <a href=\"https://github.com/lynndylanhurley/ng-token-auth/issues/222\">#222</a> <a href=\"https://github.com/lynndylanhurley/ng-token-auth/issues/90\">#90</a></li>\n  <li><a href=\"https://github.com/jwako/ionic_rails_sample\">ionic-rails-sample</a></li>\n  <li><a href=\"https://github.com/search?q=ionic+ng-token-auth&amp;ref=reposearch&amp;type=Code&amp;utf8=%E2%9C%93\">ionic\nng-token-auth</a></li>\n  <li><a href=\"https://github.com/search?utf8=%E2%9C%93&amp;q=ionic+rails\">ionic rails</a></li>\n</ul>\n\n<h2 id=\"angular-devise\">Angular-devise</h2>\n\n<p>IMPORTANT:</p>\n\n<p>For angular_devise, path could be default <code class=\"highlighter-rouge\">users/sign_in.json</code> (no need to place\nit on the root).\nIn order to send headers and cookies, you need to add\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Requests_with_credentials\">$httpProvider.defaults.withCredentials =\ntrue</a>\nto the <code class=\"highlighter-rouge\">index.config.coffee</code>.</p>\n\n<p>If protect_from_forgery is enabled, you need to pass <code class=\"highlighter-rouge\">XSRF-TOKEN</code> token as\ncookie, and it will be returned later. We will read from that cookie (not from\nhidden input fields as rails does).</p>\n\n<p>Sometime rails responds multiple times, and last cookie is used.</p>\n\n<p><del>Note that <code class=\"highlighter-rouge\">Set-Cookie</code> is only of GET request</del> Set-cookie could be\nmissing if you use <code class=\"highlighter-rouge\">protect_from_forgery with: :null_session</code>. Best way is to\nalways rise exception, so you know when xsrf happens.</p>\n\n<p>Note that cookies are stored per domain. In ajax, if you request two different\ndomains a.local and b.local, they will receive different sessions cookies (in\nrails for example <code class=\"highlighter-rouge\">session[:customer_id]</code> will show different values)\nChrome Developer Tools hides cookies for other domains…\nI do not know how to clear cookies for other domain since I can not see them in\nDeveloper Tools Resources…\nSo it is imporant to have same AuthProvider loginPath and logoutPath (login\nat a.local and logout at b.local will not work).</p>\n\n<p>Protect from forgery is for all requests except HEAD and GET\n<a href=\"http://api.rubyonrails.org/classes/ActionController/RequestForgeryProtection/ClassMethods.html\">link</a>.\n<a href=\"http://api.rubyonrails.org/classes/ActionController/RequestForgeryProtection.html\">link2</a></p>\n\n<p>It is important if you <code class=\"highlighter-rouge\">Set-Cookie</code> on before OR after action. If it is\n<code class=\"highlighter-rouge\">after_action</code> than if request is not authorized (<code class=\"highlighter-rouge\">before_action\n:authenticate_user!</code>) than that after_action will not be done, so NO XSRF-TOKEN\nwill be set. So better is to use <code class=\"highlighter-rouge\">before_action</code>.</p>\n\n<p><code class=\"highlighter-rouge\">request.xhr?</code> is strange. It returns nil for angular requests. Also, when there\nare not cookies and login POST is sent, it passes <code class=\"highlighter-rouge\">before_action\n:set_csrf_cookie_for_ng, if: -&gt; { request.xhr? }</code> but <code class=\"highlighter-rouge\">puts request.xhr?\n'XHR=true' : 'XHR=nil'</code> shows nil.</p>\n\n<p>Example application\n<a href=\"https://github.com/duleorlovic/angular-devise-ng-token-auth\">angular-devise-ng-token-auth</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\n\n  protect_from_forgery with: :exception\n\n  # http://stackoverflow.com/questions/14734243/rails-csrf-protection-angular-js-protect-from-forgery-makes-me-to-log-out-on\n  after_action :set_csrf_cookie_for_ng # , if: -&gt; { request.xhr? }\n\n  def set_csrf_cookie_for_ng\n    cookies['XSRF-TOKEN'] = form_authenticity_token if protect_against_forgery?\n  end\n\n  rescue_from ActionController::InvalidAuthenticityToken do |exception|\n    respond_to do |format|\n      format.html { raise exception }\n      format.json do\n        set_csrf_cookie_for_ng\n        render json: { error: 'Invalid authenticity token' }, status: :unprocessable_entity\n      end\n    end\n  end\n\nprotected\n\n  def verified_request?\n    super || valid_authenticity_token?(session, cookies['XSRF-TOKEN'])\n  end\n</code></pre></div></div>\n\n<p>Here is example login controller for ionic</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bower install --save angular-devise\n\n# www/index.html\n    &lt;!-- Devise https://github.com/cloudspace/angular_devise --&gt;\n    &lt;script src=\"lib/AngularDevise/lib/devise-min.js\"&gt;&lt;/script&gt;\n\n# www/js/app.js\nangular.module('starter', ['ionic', 'Devise'])\n\n# www/js/app.config.cofee\nangular.module 'starter'\n  .config (AuthProvider, $httpProvider, CONSTANT, AuthInterceptProvider) -&gt;\n    AuthProvider.loginPath CONSTANT.SERVER_URL + '/users/sign_in.json'\n    AuthProvider.logoutPath CONSTANT.SERVER_URL + '/users/sign_out.json'\n    $httpProvider.defaults.withCredentials = true\n    $httpProvider.interceptors.unshift 'csrfInterceptor'\n    AuthInterceptProvider.interceptAuth true\n    console.log 'config'\n\n# www/js/interceptors/csrf.interceptor.coffee\n# http://stackoverflow.com/questions/14734243/rails-csrf-protection-angular-js-protect-from-forgery-makes-me-to-log-out-on\nwindow.csrfRepeated = false\nangular.module 'starter'\n  .factory 'csrfInterceptor', ($q, $injector) -&gt;\n    responseError: (rejection) -&gt;\n      if rejection.status == 422 &amp;&amp;\n      rejection.data.error == 'Invalid authenticity token'\n        console.log \"CSRF error so try again and only one time\"\n        if ! window.csrfRepeated\n          window.csrfRepeated = true\n          deferred = $q.defer()\n\n          successCallback = (resp) -&gt;\n            deferred.resolve(resp)\n          errorCallback = (resp) -&gt;\n            deferred.reject(resp)\n\n          $http = $http || $injector.get('$http')\n          $http(rejection.config).then(successCallback, errorCallback)\n          return deferred.promise\n\n      $q.reject(rejection)\n\n# www/js/login/login.jade\nion-view(view-title=\"Sign In\")\n  ion-content\n    .list\n      form(ng-submit='vm.handleSubmitLogin(vm.login)')\n        label.item.item-input.item-stacked-label\n          span.input-label Username\n          input(type=\"text\" placeholder=\"Your username\"\n          ng-model=\"vm.login.email\")\n        label.item.item-input.item-stacked-label\n          span.input-label Password\n          input(type=\"password\" placeholder=\"Your password\"\n          ng-model=\"vm.login.password\")\n        .padding\n          button.button.button-block.button-positive Sign In\n\n# www/js/login/login.controller.coffee\nangular.module 'starter'\n  .controller 'LoginController', (Auth, $state) -&gt;\n    vm = this\n    vm.login =\n      email: 'asd@asd.asd'\n      password: 'asdfasdf'\n\n    init = -&gt;\n      Auth.currentUser().then(\n        (user) -&gt;\n          console.log user\n          $state.go 'tab.dashboard'\n        (error) -&gt;\n          console.log error\n      )\n\n    vm.handleSubmitLogin = (login) -&gt;\n      Auth.login(login).then(\n        (user) -&gt;\n          console.log user\n          $state.go 'tab.dashboard'\n        (error) -&gt;\n          console.log error\n      )\n\n    init()\n    return\n\n\n# www/js/app.router.coffee\nangular.module 'starter'\n  .config ($stateProvider, $urlRouterProvider) -&gt;\n    $stateProvider\n      .state 'login',\n        url: '/login'\n        templateUrl: 'jade_build/js/login/login.html'\n        controller: 'LoginController'\n        controllerAs: 'vm'\n      .state 'tab',\n        url: '/tab'\n        abstract: true\n        templateUrl: 'jade_build/js/tabs/tabs.html'\n        controller: 'TabsController'\n      .state 'tab.dashboard',\n        url: '/dashboard'\n        views:\n          'tab-dashboard':\n            templateUrl: 'jade_build/js/dashboard/dashboard.html'\n            controller: 'DashboardController'\n            controllerAs: 'vm'\n      .state 'tab.account',\n        url: '/account'\n        views:\n          'tab-account':\n            templateUrl: 'jade_build/js/account/account.html'\n            controller: 'AccountController'\n            controllerAs: 'vm'\n\n    $urlRouterProvider.otherwise '/login'\n\n# www/js/app.run.coffee\nangular.module 'starter'\n  .run ($rootScope, NotifyService, $state) -&gt;\n    $rootScope.$on 'devise:login', (event, currentUser) -&gt;\n      console.log 'devise:login'\n\n    $rootScope.$on 'devise:new-session', (event, currentUser) -&gt;\n      console.log 'devise:new-session user logs in with Auth.login'\n\n    $rootScope.$on 'devise:unauthorized', (event, xhr, deferred) -&gt;\n      NotifyService.toast \"Unauthorized. Please log in again\"\n      $state.go 'login'\n\n    return\n\n# www/js/tabs/tabs.controller.coffee\nangular.module 'starter'\n  .controller 'TabsController', (Auth, $state, $rootScope) -&gt;\n    init = -&gt;\n      Auth.currentUser().then(\n        (user) -&gt;\n          $rootScope.user = user\n        (error) -&gt;\n          console.log error\n          $state.go 'login'\n      )\n    init()\n    console.log 'TabsController'\n    return\n\n</code></pre></div></div>\n\n<h1 id=\"resend-confirmation-email-on-login\">Resend confirmation email on login</h1>\n\n<p>When user has not confirmed email and <code class=\"highlighter-rouge\">config.allow_unconfirmed_access_for =\n3.days</code> has expired, and when he login there will be an error:</p>\n\n<blockquote>\n  <p>Failed to login because A confirmation email was sent to your account at\nasd@asd.asd. You must follow the instructions in the email before your account\ncan be activated</p>\n</blockquote>\n\n<p>We can resend confirmation in this failed login attempt (don’t resend email in\ncase <code class=\"highlighter-rouge\">allow_unconfirmed_access_for</code> is not set or zero and you automatically log\nin user after registration). You can also check if confirmation is send more\nthan 1.day ago and update <code class=\"highlighter-rouge\">@resource.confirmation_sent_at = Time.now.utc -\nDevise.allow_unconfirmed_access_for</code> (this substraction is needed because\nsomeone can try to login right after confirmation email is send).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/routes.rb\n#   mount_devise_token_auth_for( 'User', controllers: { sessions: 'users/sessions' })\n# config/initializers/devise_token_auth.rb define url or use from secrets\n#  config.default_confirm_success_url = 'http://localhost:9000'\n#  config.default_confirm_success_url = \\\n#    \"http://#{Rails.application.secrets.default_url['host']}\" \\\n#    \":#{Rails.application.secrets.default_url['port']}\"\n\ncat &gt; app/controllers/users/sessions_controller.rb &lt;&lt;\\HERE_DOC\nmodule Users\n  class SessionsController &lt; DeviseTokenAuth::SessionsController\n    def render_create_error_not_confirmed\n      @redirect_url = DeviseTokenAuth.default_confirm_success_url\n      @resource.send_confirmation_instructions(\n        redirect_url: @redirect_url,\n      )\n      super\n    end\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<p>Problem with <code class=\"highlighter-rouge\">ng-token</code> is that is returns user object with snake\n<code class=\"highlighter-rouge\">user.first_name</code> instead of camelCase <code class=\"highlighter-rouge\">user.firstName</code> as it is for Rails\nResources</p>\n\n<h1 id=\"sign-in-after-user-click-on-confirmation-link\">Sign in after user click on confirmation link</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/confirmations_controller.rb\nclass ConfirmationsController &lt; Devise::ConfirmationsController\n  def show\n    super\n    sign_in resource if resource.confirmed?\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/routes.rb\n  devise_for :users, controllers: {\n    confirmations: :confirmations\n  }\n</code></pre></div></div>\n\n<h1 id=\"admin-sign-in-as-another-user\">Admin sign in as another user</h1>\n\n<p>If admin wants to become some other user <code class=\"highlighter-rouge\">login_as</code> he can use <code class=\"highlighter-rouge\">sign_in(:user,\n@user, { :bypass =&gt; true })</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/layouts/application.html.erb\n&lt;% if Rails.env.development? %&gt;\n  &lt;small&gt;\n    only_on_development\n    &lt;% User.first(10).each do |user| %&gt;\n      &lt;%= link_to user.email, sign_in_as_path(user_id: user.id) %&gt;\n    &lt;% end %&gt;\n  &lt;/small&gt;\n&lt;% end %&gt;\n\n# config/routes.rb\n  get 'sign_in_as', to: 'application#sign_in_as'\n\n# app/controllers/application_controller.rb\n  before_action :authenticate_user!, except: [:sign_in_as]\n  def sign_in_as\n    return unless Rails.env.development?\n    user = User.find params[:user_id]\n    request.env['devise.skip_trackable'] = true\n    sign_in :user, user, bypass: true\n    redirect_to root_path\n  end\n</code></pre></div></div>\n\n<p>With ng-token is similar</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def sign_in_as\n  @resource = @user\n  # copy original code\n  # https://github.com/lynndylanhurley/devise_token_auth/blob/master/app/controllers/devise_token_auth/sessions_controller.rb#L33\n  # create client id\n  @client_id = SecureRandom.urlsafe_base64(nil, false)\n  @token     = SecureRandom.urlsafe_base64(nil, false)\n\n  @resource.tokens[@client_id] = {\n    token: BCrypt::Password.create(@token),\n    expiry: (Time.zone.now + DeviseTokenAuth.token_lifespan).to_i\n  }\n  @resource.save\n\n  sign_in(:user, @resource, store: false, bypass: false)\n  render json: @user\nend\n</code></pre></div></div>\n\n<p>just note that user need to be <code class=\"highlighter-rouge\">user.active_for_authentication?</code>. In seed you\nneed to have <code class=\"highlighter-rouge\">user.skip_confirmation!</code> since you will not be able to log in as.</p>\n\n<h1 id=\"serialization\">Serialization</h1>\n\n<p>Devise will show only id, email, create_at and updated_at. To add more fields\noverride user as_json</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/user.rb\n  def as_json(options={})\n    r = super(options)\n    r[\"domains\"] = 'trk.in.rs'\n    r\n  end\n</code></pre></div></div>\n\n<h1 id=\"redirection-after-sign-in\">Redirection after sign in</h1>\n\n<p>Stored location for resource is usually kept in <code class=\"highlighter-rouge\">session[:user_return_to]</code>. Yo\nenable it you have to add before action\nhttps://github.com/plataformatec/devise/wiki/How-To:-Redirect-back-to-current-page-after-sign-in,-sign-out,-sign-up,-update</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\nclass ApplicationController &lt; ActionController::Base\n  before_action :_store_user_location!, if: :_storable_location?\n  # The callback which stores the current location must be added before you authenticate the user\n  # as `authenticate_user!` (or whatever your resource is) will halt the filter chain and redirect\n  # before the location can be stored.\n\n  # Its important that the location is NOT stored if:\n  # - The request method is not GET (non idempotent)\n  # - The request is handled by a Devise controller such as Devise::SessionsController as that could cause an \n  #    infinite redirect loop.\n  # - The request is an Ajax request as this can lead to very unexpected behaviour.\n  def _storable_location?\n    request.get? &amp;&amp; is_navigational_format? &amp;&amp; !devise_controller? &amp;&amp; !request.xhr?\n  end\n\n  def _store_user_location!\n    # :user is the scope we are authenticating\n    # this path can be fetched with path = stored_location_for(resource)\n    store_location_for(:user, request.path)\n  end\n\n  # https://www.rubydoc.info/github/plataformatec/devise/Devise/Controllers/Helpers:after_sign_in_path_for\n  # override in ApplicationController since if you override in\n  # SessionsController and it wont be used in RegistrationController (for example\n  # user already signed in and needs to be redirected)\n  def after_sign_in_path_for(resource)\n    # we need save stored location in variable since it is not indenpotent\n    # if we call twice stored_location_for(:user) than second will be nil\n    # so do not use stored_location_for in views or anywhere else... you can use\n    # session[:user_return_to] if you really need\n    redirect_url = stored_location_for(resource)\n    return redirect_url if redirect_url.present?\n    # calculate default paths for user\n  end\n\n\n# app/controllers/users/registrations_controller.rb\nnote that inside Devise controllers and also in application controller you can\nuse `stored_location_for :user`\n\n</code></pre></div></div>\n\n<p>If you need to store landing page for future analitics or you need to redirect\nusers after specific actions, you can implement your own</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\n  before_action :set_back_variable_into_session_if_exists\n  before_action :save_landing_page, unless: :current_user\n\n  def set_back_variable_into_session_if_exists\n    session[:_back] = params[:_back] if params[:_back].present?\n    # facebook login overwrite params and querystring so we need to use request.env to get _back param\n    # https://github.com/intridea/omniauth-oauth2/issues/28\n    session[:_back] = request.env['omniauth.params'].try(:[],'_back') if request.env['omniauth.params'].try(:[],'_back').present?\n  end\n  def save_landing_page\n    if ! session[:landing_page].present?\n      session[:landing_page] = request.fullpath\n    end\n  end\n\n  # this overrides devise default\n  def after_sign_in_path_for(resource)\n    view_context.after_log_in_path_for(resource)\n  end\n\n# app/helpets/application_helper.rb\n  def after_log_in_path_for(user)\n    track_sign_in(user) if user.customer?\n    origin = request.env['omniauth.origin'] unless [new_user_session_url, signup_jobseeker_url, signup_employer_url, user_omniauth_authorize_url(:linkedin), user_omniauth_authorize_url(:facebook)].include? \"#{request.env['omniauth.origin']}\".split('?').first\n    session[:_back] || origin || controller.stored_location_for(user) || if user.user?\n      job_seeker_first_step_path\n    elsif user.customer?\n      employer_after_signup_path(:subscribe)\n    elsif user.admin?\n      users_path\n    elsif user.superadmin?\n      users_path\n    else\n      root_path\n    end\n  end\n</code></pre></div></div>\n\n<h1 id=\"testing\">Testing</h1>\n\n<p>You can use <a href=\"/2015/11/09/rails-testing/\n#login-helper\">test login helpers</a>\nIn <code class=\"highlighter-rouge\">spec/rails_helper.rb</code> uncomment line that require all <code class=\"highlighter-rouge\">spec/support/**/*.rb</code>\nfiles and create that login helper.</p>\n\n<p>And you can use in your acceptance tests <code class=\"highlighter-rouge\">login_as user</code> where <code class=\"highlighter-rouge\">user =\nUser.create email: 'asd@.asd.asd', password: 'asdasd'</code></p>\n\n<p>To suppress error in tests <code class=\"highlighter-rouge\">ERROR -- omniauth: (facebook) Authentication\nfailure! invalid_credentials encountered.  </code> you can use this helper</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  def silence_omniauth\n    previous_logger = OmniAuth.config.logger\n    OmniAuth.config.logger = Logger.new(\"/dev/null\")\n    yield\n  ensure\n    OmniAuth.config.logger = previous_logger\n  end\n\n  silence_omniauth { click_link 'Sign in using Facebook' }\n</code></pre></div></div>\n\n<h1 id=\"http-basic-auth\">HTTP Basic auth</h1>\n\n<p>You can use basic http auth but you should <code class=\"highlighter-rouge\">config.force_ssl = true</code> for\nproduction env.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/admin/admin_controller.rb\nmodule Admin\n  class AdminController &lt; ApplicationController\n    http_basic_authenticate_with(\n      name: Rails.application.secrets.admin_username,\n      password: Rails.application.secrets.admin_password\n    )\n  end\nend\n\n# app/controllers/admin/users_controller.rb\nmodule Admin\n  class UsersController &lt; Admin::AdminController\n  end\nend\n</code></pre></div></div>\n\n<p>If you want different password for different request type</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class ApplicationController &lt; ActionController::Base\n  protect_from_forgery with: :exception\n  skip_before_action :verify_authenticity_token, if: :json_request?\n\n  before_action :authenticate\n\n  def authenticate\n    return true if Rails.env.test?\n    authenticate_or_request_with_http_basic do |username, password|\n      return true if request.format.html? &amp;&amp; username == Rails.application.secrets.admin_username &amp;&amp; password == Rails.application.secrets.admin_password\n      return true if request.format.json? &amp;&amp; username == Rails.application.secrets.admin_json_username &amp;&amp; password == Rails.application.secrets.admin_json_password\n      false\n    end\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"sorcery\">Sorcery</h1>\n\n<p><a href=\"https://github.com/Sorcery/sorcery\">https://github.com/Sorcery/sorcery</a></p>\n\n<h1 id=\"devise-send-email-in-background\">Devise send email in background</h1>\n\n<p>Read this gem\nhttps://github.com/plataformatec/devise/wiki/How-To:-Send-devise-emails-in-background-(Resque,-Sidekiq-and-Delayed::Job)\nor you can add manually (just put lines in User model, so it overrides devise’s)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/user.rb\n  devise :database_authenticatable, :device_async\n\n# config/initializers/devise.rb\n# Register devise-async model in Devise\nDevise.add_module(:devise_async, model: 'devise_async')\n\n# app/models/concerns/devise_async.rb\nmodule DeviseAsync\n  extend ActiveSupport::Concern\n\n  included do\n    # This method overwrites devise's own `send_devise_notification`\n    # message = devise_mailer.send(notification, self, *args)\n    # message.deliver_now\n    # also need to fetch user in MyDeviseMailer\n    # protected is required, or ActionView::Template::Error: undefined method `main_app'\n    protected\n    def send_devise_notification(notification, *args)\n      message = devise_mailer.send(notification, self, *args)\n      message.deliver_later\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>or oneliner instead of all above</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/user.rb\n  # https://github.com/plataformatec/devise#activejob-integration\n  def send_devise_notification(notification, *args)\n    devise_mailer.send(notification, self, *args).deliver_later\n  end\n</code></pre></div></div>\n\n<p>Look below if you have problem with serilization</p>\n\n<h1 id=\"custom-devise-mailer\">Custom devise mailer</h1>\n\n<p>https://github.com/plataformatec/devise/wiki/How-To:-Use-custom-mailer\nI override becaus I wante dto use delive_later but have a problem with\nserilization (Neo4j objects)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActiveJob::SerializationError: Unsupported argument type: User\n</code></pre></div></div>\n\n<p>so I send <code class=\"highlighter-rouge\">id</code> instead of <code class=\"highlighter-rouge\">self</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/user.rb\n  # This method overwrites devise's own `send_devise_notification`\n  # message = devise_mailer.send(notification, self, *args)\n  # message.deliver_now\n  # also need to fetch user in MyDeviseMailer\n  # protected is required, or ActionView::Template::Error: undefined method `main_app'\n\n  protected\n\n  def send_devise_notification(notification, *args)\n    message = devise_mailer.send(notification, id, *args)\n    message.deliver_later\n  end\n</code></pre></div></div>\n\n<p>So My devise mailer just call super with same arguments</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/mailers/my_devise_mailer.rb\nclass MyDeviseMailer &lt; Devise::Mailer\n  helper :application # gives access to all helpers defined within `application_helper`.\n  include Devise::Controllers::UrlHelpers # Optional. eg. `confirmation_url`\n  default template_path: 'devise/mailer' # to make sure that your mailer uses the devise views\n\n  def confirmation_instructions(record_id, token, opts = {})\n    record = User.find record_id\n    super record, token, opts\n  end\n\n  def reset_password_instructions(record_id, token, opts = {})\n    record = User.find record_id\n    super record, token, opts\n  end\n\n  def unlock_instructions(record_id, token, opts = {})\n    record = User.find record_id\n    super record, token, opts\n  end\n\n  def email_changed(record_id, opts = {})\n    record = User.find record_id\n    super record, opts\n  end\n\n  def password_change(record_id, opts = {})\n    record = User.find record_id\n    super record, opts\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"session-expired\">Session expired</h1>\n\n<p>For ajax requests when session is expired we need to redirect\nhttps://coderwall.com/p/zxe6dq/devise-redirect-ajax-request-when-session-timed-out-timeoutable-module</p>\n\n<h1 id=\"detect-if-already-signed-in-to-social-sites\">Detect if already signed in to social sites</h1>\n\n<p>http://www.tomanthony.co.uk/blog/detect-visitor-social-networks/</p>\n"
    } ,
  
    {
      "title"    : "Angular Testing",
      "category" : "",
      "tags"     : "angular, testing, jasmine, protractor",
      "url"      : "/2015/12/18/angular-testing/",
      "date"     : "2015-12-18 00:00:00 +0100",
      "content"  : "<p><a href=\"https://www.youtube.com/watch?v=iP0Vl-vU3XM\">video</a> TDD helps to write proper\ntests (so tests don’t have bugs). Tests helps to maintain and refactor code.\nAlso is easier to understand code if test titles are properly constructed. It’s\nvery helpfull is to do test code review in person (pair programming). RTMF\n(readable, trustworthy, maintainable, fast).</p>\n\n<p>One big mistake is to use mocking too much. Difference between mock object and\nstub is that mock is verified, but stub is not. Unit of work can have 3\noutcomes: return value/exception, noticeable state change and 3th party call\n(only here should use mock, that code should be less than 5% of all test code).\nSo only when end result should be a call to 3 service, we create mock object.\nStub is just data flow get/return.</p>\n\n<p>Don’t specify internal implementation, it’s better to create method that will\nreturn result (different result when state change). Example\n<code class=\"highlighter-rouge\">userMgr.createUser('asd','pas')</code> should not test\n<code class=\"highlighter-rouge\">equal(userMgr._internalUsers[0].name,'asd')</code> but it’s better to test\n<code class=\"highlighter-rouge\">ok(login('asd','pas'))</code> because other methods can use different internal\nimplement.</p>\n\n<ul>\n  <li>don’t mix unit and integration tests (integration are more brittle).</li>\n  <li>keep variable declaration and it’s usage close to each other</li>\n  <li>don’t comment out test, remove them</li>\n  <li>small tests. if method has multiple end results, than create test for each end\nresult and choose good name</li>\n  <li>unit testing controllers: usually initial values (no business logic) and\ncopuling UI actions to services</li>\n  <li>unit testing services: correct business logic</li>\n  <li>unit test directive: inject <code class=\"highlighter-rouge\">$compile</code>, manually call <code class=\"highlighter-rouge\">$digest()</code> for that\nscope.</li>\n  <li>e2e protractor\n<a href=\"http://angular.github.io/protractor/#/api?view=ElementArrayFinder\">ElementArrayFinder</a>\nuses <a href=\"http://www.protractortest.org/#/locators\">locators</a> argument</li>\n</ul>\n\n<h1 id=\"protractor\">Protractor</h1>\n\n<p><a href=\"https://egghead.io/lessons/angularjs-protractor-interactive\">egghead\nprotractor</a></p>\n\n<ul>\n  <li>use <a href=\"https://docs.google.com/presentation/d/1B6manhG0zEXkC-H-tPo2vwU06JhL8w9-XCF9oehXzAQ/edit#slide=id.gf9c971a8_00\">page\nobjects</a>\nto define elements, by css, repeater,\n<a href=\"https://github.com/angular/protractor/issues/456\">text</a>\n    <ul>\n      <li><code class=\"highlighter-rouge\">this.imgEl = element(by.css('img'));</code></li>\n      <li><code class=\"highlighter-rouge\">this.rowItems = element.all(by.repeater('row in vm.rows'));</code></li>\n      <li><code class=\"highlighter-rouge\">this.elWithText = element(by.xpath(\"//*[contains(text(),'Log in')]\"));</code></li>\n    </ul>\n  </li>\n  <li>action\n    <ul>\n      <li><code class=\"highlighter-rouge\">browser.get('/index.html');</code></li>\n      <li><code class=\"highlighter-rouge\">page.emailInput.sendKeys('asd@asd.asd' + protractor.Key.TAB +\n'asdasd');</code>need to be inside same sandKeys</li>\n      <li><code class=\"highlighter-rouge\">page.loginButton.click();</code></li>\n    </ul>\n  </li>\n  <li>expectations\n    <ul>\n      <li><code class=\"highlighter-rouge\">expect(page.imgEl.getAttribute('src')).toMatch(/image.png$/);</code></li>\n      <li><code class=\"highlighter-rouge\">expect(page.rowItems.count()).toBeGreatedThan(5);</code></li>\n      <li><code class=\"highlighter-rouge\">expect(element(by.binding('person.name')).isPresent()).toBe(true);</code> that is\n``</li>\n      <li><code class=\"highlighter-rouge\">expect(page.someEl.isDisplayed()).toBe(true, \"Should be displayed\");</code> is\ndifferent from <code class=\"highlighter-rouge\">isPresent()</code></li>\n    </ul>\n  </li>\n</ul>\n\n<p><a href=\"https://github.com/angular/protractor/blob/master/docs/debugging.md\">debug</a></p>\n\n<p>Debugging using <code class=\"highlighter-rouge\">browser.pause()</code> to get WebDriver control flow, than <code class=\"highlighter-rouge\">c</code> to\nmove to next webdriver command, <code class=\"highlighter-rouge\">d</code> to next debugger statement, <code class=\"highlighter-rouge\">repl</code> to get\ninteractive mode where you can <code class=\"highlighter-rouge\">element(by.css('red')).isEnabled()</code>.  Chrome Dev\nTools does not work in this regime</p>\n\n<p>The same debug/repl is with <code class=\"highlighter-rouge\">browser.debugger()</code> and call with <code class=\"highlighter-rouge\">protractor\ndebug</code></p>\n\n<p>Run single test with <code class=\"highlighter-rouge\">protractor protractor.conf.js --specs\ne2e/login/oauth.spec.js</code></p>\n\n<p>https://docs.angularjs.org/tutorial/step_05#test During test we use angular\n<code class=\"highlighter-rouge\">inject</code> and <code class=\"highlighter-rouge\">module</code>.  When we inject <code class=\"highlighter-rouge\">_flash_</code> , Angular knows that service\n<code class=\"highlighter-rouge\">flash</code> should be injected (_ are ignored_)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># src/app/compoments/mycomponent/myService_spec.coffee\ndescribe(\"myService\", function() {\n  var httpBackend, scope, ctrl;\n  beforeEach(module('myService'));\n  beforeEach(inject(function($httpBackend, $scope, $controller){\n    httpBackend = $httpBackend;\n    scope = $scope;\n    ctrl = $controller('myService', {$scope: scope});\n  }));\n\n  it(\"should load phones.json\", function(){\n    httpBackend.expectGET('phones.json').respond([{name: 'A1'}]);\n    expect(scope.phones).toBeUndefined();`\n    httpBackend.flush();\n    expect(scope.phones).toEqual([{name: 'A1'}]);\n  });\n});\n</code></pre></div></div>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">expectGet</code> is expecting request so it fails when there are no requests</li>\n</ul>\n\n<p>Instead of <code class=\"highlighter-rouge\">$httpBackend</code> we could create a mock <code class=\"highlighter-rouge\">apiService</code> <a href=\"https://www.youtube.com/watch?v=UDB-jm8MWro\">video</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># src/app/compoments/mycomponent/myController_spec.coffee\ndescribe('Controller: MainCtrl', function () {\n  beforeEach(module('diyBrewControllerApp'));\n  var MainCtrl;\n  var scope;\n  var apiService;\n  var status;\n  var q;\n\n  beforeEach(inject(function ($controller, $rootScope, $q) {\n    q = $q;\n    scope = $rootScope.$new();\n    MainCtrl = $controller('MainCtrl', {\n        $scope: scope,\n        ControllerApi: apiService\n    });\n  }));\n  beforeEach(function () {\n    status = { \"temperatureCelsius\": \"22\" }\n    apiService = {\n      getSettings: function () {\n        deferred = q.defer();\n        return deferred.promise;\n      },\n      updateSettings: function () {\n        return;\n      }\n    };\n  });\n  it('should request current status during init', function () {\n    spyOn(apiService, 'getStatus').andCallThrough();\n\n    scope.init();\n\n    deferred.resolve(status);\n    scope.$root.$digest();\n\n    expect(apiService.getStatus).toHaveBeenCalled();\n    expect(scope.currentStatus.temperatureCelsius).toBe(\"22\");\n  })\n});\n</code></pre></div></div>\n\n<h1 id=\"jasmine\">Jasmine</h1>\n\n<p><a href=\"http://jasmine.github.io/1.3/introduction.html\">Jasmine</a> have similar syntax to rspec.</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">describe</code> <code class=\"highlighter-rouge\">it</code> (prefix with x to disable suite or specifix spec)</li>\n  <li><code class=\"highlighter-rouge\">spyOn(foo, 'setBar')</code> is a spy (test double is defined with <code class=\"highlighter-rouge\">foo={setBar: function(v) {}};</code> that can track calls and arguments with this two matchers <code class=\"highlighter-rouge\">expect(foo.setBar).toHaveBeenCalled();</code> and <code class=\"highlighter-rouge\">expect(foo.setBar).toHaveBeenCalledWith(123)</code></li>\n  <li>Chain spy with <code class=\"highlighter-rouge\">spyOn(foo, 'getBar').andCallThrough();</code> to actually delegate to implementation. Chain spy with <code class=\"highlighter-rouge\">spyOn(foo, 'getBar').andReturn(745);</code> so all calls to <code class=\"highlighter-rouge\">foo.getBar</code> will return 745 (similar to <code class=\"highlighter-rouge\">.andCallFake(function(){});</code>)</li>\n  <li>To create a mock with multiple spies with one command, use <code class=\"highlighter-rouge\">tape = jasmine.createSpyObj('tape', ['play','pause']);</code>.</li>\n</ul>\n\n<p>TODO\nhttp://artofunittesting.com/</p>\n\n"
    } ,
  
    {
      "title"    : "Angular begginer examples",
      "category" : "",
      "tags"     : "angular",
      "url"      : "/2015/12/10/angular-begginer-examples/",
      "date"     : "2015-12-10 00:00:00 +0100",
      "content"  : "<p>Some of angular attribute directives:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">ng-app=\"store\"</code> defines root element of module “store” which can have many\ncontrollers</li>\n  <li><code class=\"highlighter-rouge\">ng-controller=\"StoreController as store\"</code> defines controller, but it is\nusually defined in routes for specific template</li>\n  <li><code class=\"highlighter-rouge\">ng-repeat=\"product in store.products\"</code> iteration of this element (you can\nuse also <code class=\"highlighter-rouge\">ng-if=\"$even\"</code>, or <code class=\"highlighter-rouge\">$index</code> variables). Iterating over object is\n<code class=\"highlighter-rouge\">ng-repeat=\"(key, value) in data\"</code></li>\n  <li><code class=\"highlighter-rouge\">ng-show=\"product.CanPurchase\"</code>,<code class=\"highlighter-rouge\">ng-hide=\"expession\"</code>, <code class=\"highlighter-rouge\">ng-disabled=\"mySwitch\"</code>\nto show/hide/disable element. In contrast, <code class=\"highlighter-rouge\">ng-if</code> adds new scope or totally\nremoves DOM element.</li>\n  <li><code class=\"highlighter-rouge\">&lt;img ng-src=\"{{ product.image}}\"&gt;</code> to prevent browser to load empty\nsrc, this is only place where directive use {{ }}</li>\n  <li><code class=\"highlighter-rouge\">ng-click=\" tab = 2 \"</code> to run a code on click</li>\n  <li><code class=\"highlighter-rouge\">ng-class=\"{ active: tab === 1 }\"</code> set class to key when value is true (good\nto have <code class=\"highlighter-rouge\">ng-init=\"tab = 0\"</code>)</li>\n  <li><code class=\"highlighter-rouge\">ng-model=\"review.terms\"</code> bind value of current input element to variable</li>\n  <li><code class=\"highlighter-rouge\">ng-bind=\"review.terms\"</code> bind innerHTML of this element to the variable (can\nbe expression)</li>\n  <li><code class=\"highlighter-rouge\">ng-submit=\"reviewCtrl.addReview(product)\"</code> call function on submit</li>\n  <li><code class=\"highlighter-rouge\">ng-include=\"'product-title.html'\"</code> include template</li>\n  <li><code class=\"highlighter-rouge\">ng-view</code> is placeholder where routes inject templates</li>\n</ul>\n\n<p>Angular expressions can’t have conditionals and loops, but have filters.\nNote that angular expressions don’t have access to <code class=\"highlighter-rouge\">window</code> only <code class=\"highlighter-rouge\">scope</code> so no\nhelp from <code class=\"highlighter-rouge\">parseInt()</code>, <code class=\"highlighter-rouge\">String()</code> and similar.</p>\n\n<p><code class=\"highlighter-rouge\">$scope.$watch('email', function() { $scope.test(); })</code> can be used to rerun\nvalidation check.\n<a href=\"https://docs.angularjs.org/api/ng/type/$rootScope.Scope\">watch</a> first argument\n(string or function) is evalued on each digest and second argument (callback\nlistener) is called when a returning value of first argument is changed (for\narray, use length).\nTo use with <code class=\"highlighter-rouge\">controllerAs</code> syntax you need to use bind</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>app.controller('Ctrl', function ($scope) {\n  this.name = 'name';\n\n  $scope.$watch(angular.bind(function () {\n    return this.title\n  }), function (oldVal, newVal) {\n\n  });\n});\n</code></pre></div></div>\n\n<p>Expressions in angular directives <code class=\"highlighter-rouge\">&lt;button ng-click=\"foo = 5\"&gt;</code> are parsed and\nevaluated. <code class=\"highlighter-rouge\">$parse()</code> takes expression and returns function which takes two\narguments: context and locals (overrides).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$scope.foo = 3;\n\nvar parseFn = $parse(‘foo = 5’);\nparseFn($scope);\n// or\n$scope.$eval(‘foo = 5’);\n\n$scope.foo; // returns 5\n</code></pre></div></div>\n\n<p>You can check if some property <code class=\"highlighter-rouge\">bar</code> on <code class=\"highlighter-rouge\">foo</code> is not null:\n<code class=\"highlighter-rouge\">$parse('bar.baz.quux')(foo)</code> will return undefined instead of throwing an\nexception.</p>\n\n<p>You can manually trigger digest with <code class=\"highlighter-rouge\">$scope.$apply(\"foo = 5\")</code> it calls\n<code class=\"highlighter-rouge\">$rootScope.$digest()</code> which propagates down to every child scope\n<a href=\"https://docs.angularjs.org/api/ng/type/$rootScope.Scope#$apply\">link</a>.\nWith ControllerAs syntax, you need to inject <code class=\"highlighter-rouge\">$scope</code> and can not use\nexpression, but just empty <code class=\"highlighter-rouge\">$scope.$apply()</code>. You can not call <code class=\"highlighter-rouge\">$apply</code> in\ncallbacks for <code class=\"highlighter-rouge\">ng-mouseover</code> <code class=\"highlighter-rouge\">ng-click</code> since digest is in progress. It is\nusable in non angular callbacks <code class=\"highlighter-rouge\">document.getElementById('b').addEventListener\n'mouseover'</code>.</p>\n\n<h1 id=\"filters---data--filteroptions-\">Filters:  {{ data | filter:options }}</h1>\n\n<ul>\n  <li>strings <code class=\"highlighter-rouge\">{{ 'Some string' | date:'MM/dd/yyy @ h:mma' }}</code> can also be\n<code class=\"highlighter-rouge\">currency, lowecase, uppercase</code></li>\n  <li>iterators <code class=\"highlighter-rouge\">ng-repeat=\"product in store.products | filter: search | orderBy:\n'-price' | limitTo: -5 \"</code> use only products that match value of search (any\nproperty of product that match search string) order by desc price and show\nlast 5. If we want to filter only product.name than bind input to\n<code class=\"highlighter-rouge\">search.name</code> so search becomes object, for example <code class=\"highlighter-rouge\">ng-model=\"search.name\"</code>.</li>\n</ul>\n\n<p>View can use directives, filters. Controller and services can depend on some\nproviders.</p>\n\n<ul>\n  <li>all objects are joined using <a href=\"https://docs.angularjs.org/guide/di\">dependency\ninjection</a>\nfor <a href=\"https://docs.angularjs.org/guide/providers\">specialized objects</a> \n(controllers, directives, filters, animations) or custom service. There are 5\ntypes of recipe for creating object with injector: Provider (is the main one,\nother are syntactic sugar on top of this provider recipe), Value, Factory,\nService and  Constant.\nYou can use DI when defining components (only controller can have <code class=\"highlighter-rouge\">$scope</code> and\n<code class=\"highlighter-rouge\">resolve</code> dependency) or in <code class=\"highlighter-rouge\">run</code> methods (can not inject Providers) or \n<code class=\"highlighter-rouge\">config</code> method (can not inject Service or Value) on module. Only module can\ndefine other components: <code class=\"highlighter-rouge\">controller</code> and factories: <code class=\"highlighter-rouge\">directive</code>, <code class=\"highlighter-rouge\">filter</code>,\n<code class=\"highlighter-rouge\">value</code>, <code class=\"highlighter-rouge\">factory</code>, <code class=\"highlighter-rouge\">service</code>.</li>\n  <li>all services in Angular are singletons. injector uses each recipe at most once\nto create the object. The injector then caches the reference for all future\nneeds. Controllers are instantiated every time app needs it.</li>\n  <li>use strict dependency injection <code class=\"highlighter-rouge\">ng-app=\"myApp\" ng-strict-di\"</code> to raise error\nwhen we use implicit annotations (<code class=\"highlighter-rouge\">function($scope)</code> instead of <code class=\"highlighter-rouge\">['$scope',\nfunction($scope)]</code>)</li>\n</ul>\n\n<h2 id=\"special-purpose-objects-controlles-filters-directives-animations\">Special Purpose Objects: controlles, filters, directives, animations</h2>\n\n<ul>\n  <li>controller methods can be defined on $scope or on this (so we reference them\n<code class=\"highlighter-rouge\">MyController.myMethod</code>)</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>angular.module('myApp',['controllers']);\nangular.module('controllers', [])\n  .controller('MyController', ['$http', '$scope', function($http, $scope) {\n    this.my_value = 2;\n    $scope.myMethod = function() { return 2 };\n}]);\n</code></pre></div></div>\n\n<ul>\n  <li>new filter definition should return function</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># filter\nangular.module('myApp',['myFilters']);\nangular.module('myFilters',[])\n.filter('checkmark', function() {\n  return function(input) {\n    return input ? '\\u2713' : '\\u2718';\n  };\n});\n</code></pre></div></div>\n\n<p>It can be used like <code class=\"highlighter-rouge\">{{ phone.available | checkmark }}</code></p>\n\n<ul>\n  <li>\n    <p>two types of directives: element directive (UI widget)\n<code class=\"highlighter-rouge\">&lt;product-title&gt;&lt;/product-title&gt;</code> or attribute directive (mixins like tooltip)\n<code class=\"highlighter-rouge\">&lt;div product-title&gt;&lt;/div&gt;</code>.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>angular.module('myApp')\n  .directive('productTitle', function(){\n    return {\n      restict: 'E', // 'E' element, 'A' attribute (default), 'C' class\n      templateUrl: 'product-title.html',\n  \n      controller: function() {},\n      controllerAs: 'panel',\n    };\n  });\n  .directive('enter', function(scope, element, attrs){}\n    // default is 'A' so no need to write return {  link: function(){}\n    return function(scope,element, attrs) {\n      element.bind(\"mouseenter\", function() {\n        scope.$apply(attrs.enter); # this will call argument string, ie some controller method\n      });\n    };\n  });\n</code></pre></div>    </div>\n\n    <ul>\n      <li>directives has <code class=\"highlighter-rouge\">transclusion()</code> to create new scope</li>\n      <li><code class=\"highlighter-rouge\">controllerAs: 'vm'</code> have some problems (but works as <code class=\"highlighter-rouge\">vm1</code>)</li>\n    </ul>\n  </li>\n</ul>\n\n<h2 id=\"services-for-creating-objects-value-factory-service-provider-constant\">Services for creating objects: Value, Factory, Service, Provider, Constant</h2>\n\n<ul>\n  <li><a href=\"https://egghead.io/playlists/learn-when-to-use-a-service-factory-or-provider-e2507e4b\">egghead learn when to use a service, factory, or provider</a></li>\n  <li>\n    <p>Value recipe, can’t have other dependencies</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>var myApp = angular.module('myApp', []);\nmyApp.value('clientId', 'a12345654321x');\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>Factory recipe use other services, is a function and lazy initialized. It\nreturns object</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># factory\nangular.module('myApp',['myServices']);\nangular.module('myServices')\n.factory('sport', function() { \n  return {\n    title: \"Kayak\"\n  }\n});\n# factory that use ngResource provider\nangular.module('myServices',['ngResource'])\n  .factory('Phone', ['$resource', function($resource) {\n    return $resource('phones/:phoneId', { phoneId: \"@id\", format: 'json' }, {\n      query: {method: 'GET', params: { phoneId: 'phones' }, isArray: true },\n      save:  { method: 'PUT' },\n      create: { method: 'POST' }\n    });\n  }]);\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>service can be added with <code class=\"highlighter-rouge\">.factory</code> which returns <code class=\"highlighter-rouge\">new SomeFun(arg)</code>, but\nit’s shorter with <code class=\"highlighter-rouge\">.service</code> function. Service methods are defined as\nproperties of <code class=\"highlighter-rouge\">this</code>.  Service just use $injector to create new instance of\nservice’s contructor function.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function UnicornLauncher(apiToken) {\n\n  this.launchedCount = 0;\n  this.launch = function() {\n    this.launchedCount++;\n  }\n}\nmyApp.factory('unicornLauncher', [\"apiToken\", function(apiToken) {\n  return new UnicornLauncher(apiToken);\n}]);\n// or\nmyApp.service('unicornLauncher', [\"apiToken\", UnicornLauncher]);\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>Factory has more flexibility since they can return functions which can be\n<code class=\"highlighter-rouge\">new</code>ed.</p>\n\n<ul>\n  <li>\n    <p>Provider is broader factory, it returns object with a <code class=\"highlighter-rouge\">$get</code> method that is a\nfactory function.  Provider can be configured. For provider name\n<code class=\"highlighter-rouge\">unicornLauncher</code> angular registers <code class=\"highlighter-rouge\">unicornLauncher</code> and\n<code class=\"highlighter-rouge\">unicornLauncherProvider</code> injectables.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>myApp.provider('unicornLauncher', function UnicornLauncherProvider_name_not_important() {\n  var useTinfoilShielding = false;\n\n  this.useTinfoilShielding = function(value) {\n    useTinfoilShielding = !!value;\n  };\n\n  this.$get = [\"apiToken\", function unicornLauncherFactory(apiToken) {\n    return new UnicornLauncher(apiToken, useTinfoilShielding);\n  }];\n});\n\nmyApp.config([\"unicornLauncherProvider\", function(unicornLauncherProvider) {\n  unicornLauncherProvider.useTinfoilShielding(true);\n}]);\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p><a href=\"https://docs.angularjs.org/api/ngResource/service/$resource\">$resource</a> by\ndefault <code class=\"highlighter-rouge\">save</code> is POST, so we need to change for rails PUT, and add <code class=\"highlighter-rouge\">create</code>.\nFactories need to return object. That object is bindable in all places where\nwe use <code class=\"highlighter-rouge\">Phone</code> factory.\nIt can be used like <code class=\"highlighter-rouge\">$scope.phone = Phone.get({ phoneId: $routeParams.phoneId\n}); $scope.phones = Phone.query();</code></p>\n  </li>\n  <li>\n    <p>Constant recipe can create value that is available in both config and run\nphase. Don’t use for example DEFAULT image_url since is better to do that in\nbackend on one place</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>angular.module('starter')\n  .constant( 'CONFIG', {\n    SERVER_URL: 'http://192.168.3.2:3001',\n    S3UPLOAD: {\n      BUCKET: 'duleorlovic-test1',\n      API_URL: '/api/v1/s3_access_token',\n    },\n    USER_ROLES: {\n      ADMIN: 'admin',\n      EDITOR: 'editor',\n      GUEST: 'guest',\n    },\n  });\n  .run(['CONFIG','$rootScope',function(CONFIG, $rootScope) { \n    // in html use $root.CONFIG.USER_ROLES.ADMIN\n    $rootScope.CONFIG = CONFIG\n}])\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"rootscope\">RootScope</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">$rootScope</code> has not parent and was created directly from <code class=\"highlighter-rouge\">Scope()</code> class (not\nthrough <code class=\"highlighter-rouge\">$.new</code> method). It is used for event handling <code class=\"highlighter-rouge\">$.broadcast()</code> (down\nto child scopes) and <code class=\"highlighter-rouge\">$.emit()</code> (up in the scope hierarchy).</li>\n  <li>you can also use for something that does not change often, like\n<code class=\"highlighter-rouge\">$rootScope.user = user</code>. In templates you can just write <code class=\"highlighter-rouge\">\nand it will find `user` at root scope (can't use</code>).</li>\n</ul>\n\n<h1 id=\"share-error-messages\">Share error messages</h1>\n\n<p>For form name <em>myForm</em> we can check <code class=\"highlighter-rouge\">myForm.$valid</code> for all fields that we put\nvalidation with <code class=\"highlighter-rouge\">required</code> property on input elements (form can have\n<code class=\"highlighter-rouge\">novalidate</code> attribute to prevent browser default behavior, or we can use\n<code class=\"highlighter-rouge\">ng-required=\"true\"</code>). Also fields have internal properties: <code class=\"highlighter-rouge\">$dirty</code> (user has\ninteracted), <code class=\"highlighter-rouge\">$valid</code>, <code class=\"highlighter-rouge\">$invalid</code> and<code class=\"highlighter-rouge\">$pristine</code> (has not interacted with field\nyet).  To show client side errors, you can use\n<a href=\"https://docs.angularjs.org/api/ngMessages\">ng-messages</a> instead of dealing with\n<code class=\"highlighter-rouge\">ng-show</code>.  Some example validations are: <code class=\"highlighter-rouge\">ng-minlength=5</code> <code class=\"highlighter-rouge\">ng-maxlength=20</code>\n<code class=\"highlighter-rouge\">ng-required=\"true\"</code>.  We can share messages with <code class=\"highlighter-rouge\">ng-messages-include</code>, but\nthat somehow does not work well.  There are also errors from server\n(<code class=\"highlighter-rouge\">resp.errors</code> or <code class=\"highlighter-rouge\">resp.data.errors</code>).  Button is disabled until form is valid.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;form name=\"editMenuItemForm\" ng-submit=\"vm.update(vm.email,editMenuItemForm)\"&gt;\n  &lt;input type=\"email\" name=\"email\" ng-model=\"vm.menuItem.email\"\n  ng-required=\"true\" ng-pattern=\"/^.+@.+\\..+$/\"\n  ng-change=\"editMenuItemForm.email.$setValidity('server', true)\"&gt;\n  &lt;div ng-messages=\"editMenuItemForm.email.$error\"&gt;\n    &lt;div ng-message=\"required\"&gt;This field is required&lt;/div&gt;\n    &lt;div ng-message=\"email\"&gt;This field must be an email&lt;/div&gt;\n    &lt;div ng-message=\"minlength\"&gt;Your field is too short&lt;/div&gt;\n    &lt;div ng-message=\"pattern\"&gt;Must look like an email&lt;/div&gt;\n    &lt;div ng-message=\"server\"&gt;{ { vm.serverErrors.editMenuItemForm.email.toString() }}&lt;/div&gt;\n  &lt;/div&gt;\n\n  &lt;md-button type=\"submit\" class=\"md-raised md-primary\"\n  ng-disabled=\"!editMenuItemForm.$valid\"&gt;Update&lt;/md-button&gt;\n&lt;/form&gt;\n</code></pre></div></div>\n\n<p>This works also for nested attributes, just need to reference them with\n<code class=\"highlighter-rouge\">editMenuItemForm[\"menu_item_options.price\"]</code> (snake case is rails style) and\ncreate one in controller <code class=\"highlighter-rouge\">vm.menuItem.menu_item_options_attributes = [{}] unless\nvm.menuItem.id</code> and reference with\n<code class=\"highlighter-rouge\">input(ng-model='vm.menuItem.menu_item_options_attributes[0].price'</code></p>\n\n<p>This has problem with destroy button and serverside validation since ng-message\nis visible only when you focus that input (probably digest is perfomed only on\nsubmit)</p>\n\n<p>On server we should respond with <code class=\"highlighter-rouge\">render json: @menu_item.errors, status:\n:bad_request</code> so we catch model errors, for example <code class=\"highlighter-rouge\">resp.data.email</code>. If that\nfield is not on form, for example unauthorized response <code class=\"highlighter-rouge\">resp.data.errors =\n['Authorized only']</code> than we show toast. If you need to show toast but don’t\nknow if <code class=\"highlighter-rouge\">resp.data</code> is object or array than you can use <code class=\"highlighter-rouge\">toastr.error\nJSON.stringify resp.data</code>. It should be object and you need to know the key.</p>\n\n<p>For arrays you can use two methods: <code class=\"highlighter-rouge\">s.toString()</code> and <code class=\"highlighter-rouge\">String(s)</code>.\n<code class=\"highlighter-rouge\">[].toString()</code> works fine but will raise if instead of <code class=\"highlighter-rouge\">[]</code> is nil. So I prefer\nto use <code class=\"highlighter-rouge\">String(...)</code> in controllers <code class=\"highlighter-rouge\">String(null)==\"null\"</code>. Please not that\n<code class=\"highlighter-rouge\">String</code> is <code class=\"highlighter-rouge\">window</code> function so it is not available in angular expressions ie\nfor <code class=\"highlighter-rouge\">ng-message</code> but there we are sure that value is not nill.</p>\n\n<p>Fields that are not valid (for example we put space in name\n<code class=\"highlighter-rouge\">menuItem.name == undefined</code>) are not sent so we need to disable button when\nform is not valid or check if <code class=\"highlighter-rouge\">editMenuItemForm.$valid</code> before we call\n<code class=\"highlighter-rouge\">menuItem.update()</code>.  If we disable button than we need to put\n<code class=\"highlighter-rouge\">ng-change=\"form.field.$setValidity('server', true)\"</code> to remove server error on\nchange, so  submit button is shown again.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># in controller\nvm.update = (menuItem, editMenuItemForm) -&gt;\n  menuItem.update(menuItem).then(\n    (menu_item_from_server) -&gt;\n      $mdDialog.hide()\n    (resp) -&gt;\n      $log.debug adminEditMenuItemController: 'update error', resp_data: resp.data\n      for field of resp.data\n        if editMenuItemForm[field]\n          editMenuItemForm[field].$setValidity('server', false)\n        else\n          toastr.error String resp.data[field]\n      vm.serverErrors =\n        editMenuItemForm: resp.data\n  )\n</code></pre></div></div>\n\n<h1 id=\"q-service\">$q service</h1>\n\n<p>In <a href=\"https://docs.angularjs.org/api/ng/service/$q\">$q service</a> for promise object\nwe can call <code class=\"highlighter-rouge\">then(successCallback, errorCallback, notifyCallback)</code> but also\n<code class=\"highlighter-rouge\">finally(callback, notifyCallback)</code> for clean up.</p>\n\n<p>Here is example of Customer service</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># www/js/services/customerAuth.service.coffee\nangular.module 'starter'\n  .service 'CustomerAuth', ($http, CONSTANT, $q) -&gt;\n    service = this\n    service.sessionId = null\n\n    service.login = (customer_login) -&gt;\n      $q(\n        (resolve, reject) -&gt;\n          $http.post(\n            CONSTANT.SERVER_URL + '/customer/sessions.json'\n            customer_session: customer_login\n          ).then(\n            (response) -&gt;\n              resolve response\n            (response) -&gt;\n              reject response\n          )\n      )\n</code></pre></div></div>\n\n<h1 id=\"tips\">Tips:</h1>\n\n<ul>\n  <li>use <code class=\"highlighter-rouge\">controller as vm</code> in view and <code class=\"highlighter-rouge\">var vm = this</code> in controller so you don’t\nneed to inject <code class=\"highlighter-rouge\">$scope</code> (we need <code class=\"highlighter-rouge\">$scope</code> when we want to access something in\npromise <code class=\"highlighter-rouge\">catch = -&gt; $scope.vm.profileForm = \"a\"</code>)</li>\n  <li>\n    <p>in directives you need to prefix <code class=\"highlighter-rouge\">$root</code> to access rootScope, for example\n<code class=\"highlighter-rouge\">$root.user</code></p>\n  </li>\n  <li>\n    <p>by <a href=\"https://github.com/mgechev/angularjs-style-guide\">Angular conventions</a>,\nlowerCamelCase is used for factory names that won’t be new’ed. Controllers and\nservices should be UpperCased.</p>\n\n    <p>Filenames are lowerCamerCase, but folders are underscored or dashed\n<code class=\"highlighter-rouge\">src/app/menu_items/menuItems.jade</code>. Template always match controller name</p>\n  </li>\n  <li><a href=\"https://github.com/johnpapa/angular-styleguide#controlleras-controller-syntax\">johnpapa style guide</a>\n    <ul>\n      <li>use <code class=\"highlighter-rouge\">var vm = this;</code> (or more descriptive <code class=\"highlighter-rouge\">loginVm</code>). Use <code class=\"highlighter-rouge\">$scope</code> only for publish/subscribe events <code class=\"highlighter-rouge\">$emit</code>, <code class=\"highlighter-rouge\">$broadcast</code> and <code class=\"highlighter-rouge\">$on</code>.</li>\n      <li>use <code class=\"highlighter-rouge\">factory</code> that returns  instead of <code class=\"highlighter-rouge\">service</code></li>\n    </ul>\n  </li>\n  <li>for enabling html5 links, you need to put <code class=\"highlighter-rouge\">&lt;base href=\"/\"&gt;</code> before <code class=\"highlighter-rouge\">app.css</code>\n<a href=\"http://stackoverflow.com/questions/28807251/relative-href-path-goes-wrong-in-angularjs-with-html5mode\">link</a></li>\n  <li>sometimes you need to <code class=\"highlighter-rouge\">rm -rf .tmp</code> since gulp server cache miss</li>\n  <li>\n    <p><a href=\"https://docs.angularjs.org/api/ng/function/angular.copy\">angular.copy</a> is\nusefull for forms and cancel button. Note that object is disconnected, so if\nyou store a list of all items, you need to angular.copy back to original.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code></code></pre></div>    </div>\n\n    <p>Also when you receive an array from server <code class=\"highlighter-rouge\">MyService.locations =\nlocationsFromServer</code> will assign new pointer, but old <code class=\"highlighter-rouge\">vm.locations =\nMyService.locations</code> will still point to old array.</p>\n  </li>\n  <li>\n    <p><a href=\"https://docs.angularjs.org/api/ng/service/$log\">$log</a> can show object with\nsource location, for example <code class=\"highlighter-rouge\">$log.debug adminController: 'update error',\nresp_data: resp.data</code>. It is angular service which you can disable in\nproduction</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>angular.module 'my-module'\n  .config($logProvider) -&gt;\n    $logProvider.debugEnabled = false\n</code></pre></div>    </div>\n  </li>\n  <li>inside ui router resolve, js errors are completelly hidden</li>\n</ul>\n\n<p>Check some <a href=\"https://github.com/gianarb/awesome-angularjs\">awesome links</a></p>\n\n<h1 id=\"testing\">Testing</h1>\n\n<h1 id=\"confirm\">Confirm</h1>\n\n<p>Usage <code class=\"highlighter-rouge\">&lt;md-button ng-really-click=\"vm.delete(item)\"\nng-really-reject=\"vm.cancel(item)\" ng-really-message=\"Are you\nsure?\"&gt;Remove&lt;/md-button&gt;</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/components/ng-really-click.directive.coffee\nangular.module 'myApp'\n  .directive 'ngReallyClick', -&gt;\n    restrict: 'A'\n    link: (scope, element, attrs) -&gt;\n      element.bind 'click', -&gt;\n        message = attrs.ngReallyMessage\n        if message &amp;&amp; confirm(message)\n          scope.$apply attrs.ngReallyClick\n        else if attrs.ngReallyReject\n          scope.$apply attrs.ngReallyReject\n</code></pre></div></div>\n\n<h1 id=\"data-disable-with-processing\">Data disable with Processing…</h1>\n\n<p>Similar to rails <code class=\"highlighter-rouge\">data-disable-with=\"Processing...\"</code> here is directive.\nAngular ignores <code class=\"highlighter-rouge\">data-</code> from <code class=\"highlighter-rouge\">data-disable-with</code>.\nSimilar to\n<a href=\"https://github.com/kirstein/angular-autodisable\">angular-autodisable</a>\nThere was some problem with JQlite and find with <code class=\"highlighter-rouge\">[type=submit]</code> so use <a href=\"https://github.com/duleorlovic/angular-autodisable\">my\nfork</a></p>\n\n<h1 id=\"errors\">Errors</h1>\n\n<p>If you get circular dependency error like <code class=\"highlighter-rouge\">Uncaught Error: [$injector:cdep]\nCircular dependency found: $state &lt;- unauthorizedInterceptor &lt;- $http &lt;-\n$templateFactory &lt;- $view &lt;- $state</code>, than use <code class=\"highlighter-rouge\">$injector</code> and `$state =\n$injector.get ‘$state’ like in the following example.</p>\n\n<p>Redirect to login state on every <code class=\"highlighter-rouge\">unauthorized</code> response</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># www/js/interceptors/unauthorized.interceptor.coffee\nangular.module 'starter'\n  .factory 'unauthorizedInterceptor', ($q, $injector) -&gt;\n    responseError: (rejection) -&gt;\n      if rejection.status == 401\n        $state = $injector.get('$state')\n        $state.go 'login'\n      $q.reject rejection\n\n# www/js/app.config.coffee\nangular.module 'starter'\n  .config ($httpProvider) -&gt;\n    $httpProvider.interceptors.unshift 'unauthorizedInterceptor'\n</code></pre></div></div>\n\n<p>Interceptor that will set <code class=\"highlighter-rouge\">data.error</code> in case there is network error</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>angular.module 'starter'\n  .factory 'connectionInterceptor', ($q, NotifyService) -&gt;\n    responseError: (rejection) -&gt;\n      if rejection.status &lt;= 0 # server offline\n        unless rejection.data &amp;&amp; rejection.data.error\n          rejection.data =\n            error: 'There is a problem with connection'\n      $q.reject rejection\n</code></pre></div></div>\n\n<h1 id=\"ui-view-angular-route\">UI View, Angular route</h1>\n\n<p><code class=\"highlighter-rouge\">angular-route</code> is separated package and need to be added as module dependency\nand configured. <code class=\"highlighter-rouge\">config</code> needs Providers (factory for service that will be\nconfigured) for example <code class=\"highlighter-rouge\">$routeProvider</code> and <code class=\"highlighter-rouge\">run</code> or <code class=\"highlighter-rouge\">controller</code> needs service\nfor example <code class=\"highlighter-rouge\">$route</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>angular.module('myApp',[ 'ngRoute', 'myAppControllers' ])\n.config(function($routeProvider, $locationProvider){\n  $routeProvider\n  .when('/phones/:id', {\n    templateUrl: 'details.html',\n    controller: 'PhoneDetailCtrl',\n  })\n  .when('/phones', {\n    templateUrl: 'list.html',\n    controller: 'PhoneListCtrl',\n  })\n  .otherwise({redirectTo: '/phones'});\n});\n</code></pre></div></div>\n\n<p>It is used with directive <code class=\"highlighter-rouge\">&lt;ng-view&gt;&lt;/ng-view&gt;</code> which is replaced with given\ntemplate.</p>\n\n<h1 id=\"ui-router\">UI Router</h1>\n\n<p><a href=\"https://github.com/angular-ui/ui-router\">ui-router</a> is nice but documentation \nis not so simple, so here are examples:</p>\n\n<ul>\n  <li><a href=\"https://github.com/angular-ui/ui-router/wiki/URL-Routing#stateparams-service\">stateParams</a>\ncan be defined with <code class=\"highlighter-rouge\">:contactId</code> or <code class=\"highlighter-rouge\">{contactId}</code></li>\n  <li>query params are defined like <code class=\"highlighter-rouge\">?contactId</code></li>\n  <li>navigating with\n<a href=\"https://github.com/angular-ui/ui-router/wiki/Quick-Reference#ui-sref\">ui-sref</a>\n<code class=\"highlighter-rouge\">ui-sref=\"admin.menu_items({staurantId: restaurant.id})\"</code> or with <code class=\"highlighter-rouge\">$state.go\n'tab.location_ticket_details', locationTicketId: locationTicket.id</code></li>\n  <li><a href=\"http://angular-ui.github.io/ui-router/site/#/api/ui.router.state.directive:ui-sref-active\">ui-sref-active</a> to add class on navigational links that are active</li>\n  <li>\n    <p>if you want to completely change the template with edit template, than wrap it</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># show.html\n&lt;ui-view&gt;\n  My name is \n&lt;/ui-view&gt;\n\n# edit.html\n&lt;form&gt;\n  &lt;input name=\"name\"&gt;\n&lt;/form&gt;\n\n# my.router.coffee\nangular.module 'my'\n.config ($stateProvider) -&gt;\n  $stateProvider\n    .state 'myAccount',\n      url: '/my-account'\n      templateUrl: 'show.html'\n      controller: 'MyController'\n      controllerAs: 'vm'\n      resolve:\n        myAccountInitialData: (myAccountInitialData) -&gt;\n          myAccountInitialData()\n\n    .state 'myAccount.edit',\n      url: '/edit'\n      templateUrl: 'edit.html'\n      # no need to resolve here since this is inside MyController\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>When you need double click to go to nested state, you are probably coverting\n  that state with some other state\n  <a href=\"http://stackoverflow.com/questions/25548798/angular-ui-router-having-to-click-twice-for-view-to-update-as-expected-with-d\">stackoverflow</a>\n  route resolution problem.</p>\n  </li>\n  <li>\n    <p>resolve initialData before new state is activated\n<a href=\"http://odetocode.com/blogs/scott/archive/2014/05/20/using-resolve-in-angularjs-routes.aspx\">link</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># src/app/my_account/myAccountInitialData.coffee\n# http://odetocode.com/blogs/scott/archive/2014/05/20/using-resolve-in-angularjs-routes.aspx\n# https://promisesaplus.com/#point-41 the promise resolution procedue, ie\n# onFulfilled returns promise, when it is fulfilled than fullfill parent\nangular.module 'menucardsAngular'\n.factory \"myAccountInitialData\", (Restaurant, $auth, $q) -&gt;\n  -&gt;\n    user =  $auth.validateUser()\n    $q.all([user]).then (results) -&gt;\n      restaurant = Restaurant.query({}, { id: results[0].restaurant_id })\n      $q.all([restaurant]).then ( results ) -&gt;\n        restaurant: results[0]\n\n# src/app/my_account/myAccount.controller.coffee\nangular.module 'menucardsAngular'\n  .controller 'MyAccountController', (myAccountInitialData, $log) -&gt;\n    'ngInject'\n    $log.debug \"MyAccountController\"\n    vm = this\n    vm.restaurant = myAccountInitialData.restaurant\n    return\n\n# src/app/my_account/myAccount.router.coffee\nangular.module 'menucardsAngular'\n  .config ($stateProvider) -&gt;\n    'ngInject'\n    $stateProvider\n      .state 'myAccount',\n        url: '/my-account'\n        templateUrl: 'app/my_account/myAccount.html'\n        controller: 'MyAccountController'\n        controllerAs: 'vm'\n        resolve:\n          myAccountInitialData: (myAccountInitialData) -&gt;\n            myAccountInitialData()\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>if you need to do some jQuery on state change (not only when controller loads,\nbut when we change states inside current controller) you can listen to events\non <code class=\"highlighter-rouge\">$scope</code> (this scope is destroyed when controller is destroyed)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$scope.$on '$stateChangeStart', (e, toState, toParams, fromState, fromParams) -&gt;\n  $scope.sectionName = toParams.sectionName\n  if toState.name == 'menu'\n    $timeout -&gt;\n      new scrollItem 'cart'\n  return\n# this is when user lands on menu page\n$timeout -&gt;\n  if $('#cart').first()\n    new scrollItem 'cart'\n</code></pre></div>    </div>\n  </li>\n  <li><a href=\"https://github.com/angular-ui/ui-router/wiki/Multiple-Named-Views\">multiple\nviews</a> you\ncan not have two different active state, so it will toggle</li>\n</ul>\n\n<h1 id=\"batarang\">Batarang</h1>\n\n<p><a href=\"https://egghead.io/lessons/angularjs-angularjs-batarang\">egghead batarang</a>.\nJust select element and in console type <code class=\"highlighter-rouge\">$scope.vm.name = 'dule';$scope.apply()</code></p>\n\n<p>Usually I define module <code class=\"highlighter-rouge\">angular.module 'name', []</code> only in one place\n<em>src/app/index.module.coffee</em></p>\n\n<p>Since some old deleted templates could remove stuff, I run with <code class=\"highlighter-rouge\">gulp clean &amp;&amp;\ngulp serve --api localhost:3001 -l</code></p>\n\n<h1 id=\"interval-for-automatic-updates\">Interval for automatic updates</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Order.query({status: 'active'}, {restaurantId: user.restaurant_id}).then (orders) -&gt;\n  vm.orders = orders\n\nvm.youngerThan = new Date\n# could be that order happens after previous query on server and before current time, not likely\n# more likely is that order happened before query on server but after current time\n# so it will show up twice, that's why we check if alredy there\n$interval(\n  -&gt;\n    Order.query({status: 'active', youngerThan: vm.youngerThan}, {restaurantId: user.restaurant_id}).then (orders) -&gt;\n      for order in orders.reverse\n        vm.orders.unshift(order) if vm.orders[0] &amp;&amp; vm.orders[0].id != order.id\n    vm.youngerThan = new Date\n  15000)\n</code></pre></div></div>\n\n<h1 id=\"pagination\">Pagination</h1>\n\n<p>You can use\n<a href=\"https://github.com/begriffs/angular-paginate-anything\">angular-paginate-anything</a>\nto show pagination links on your page. On server you can use <a href=\"http://www.tejusparikh.com/2014/pagination-in-angular-js.html\">kaminari with\nsome before\nfilter</a> or\n<a href=\"https://github.com/begriffs/clean_pagination\">clean_pagination</a> which I prefer.\nIt is very easy to start. For angular-rails-resource I need to use <a href=\"https://github.com/begriffs/angular-paginate-anything/issues/95\">$timeout hack</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$scope.$on 'pagination:loadPage', (event, status, config) -&gt;\n  $timeout -&gt;\n    vm.users = vm.usersObject.map (userObject) -&gt; new User userObject\n</code></pre></div></div>\n\n<h1 id=\"tips-1\">Tips</h1>\n\n<ul>\n  <li>you can have another ng-click inside ng-click (ie button inside button) and\nyou can stop propagation with <code class=\"highlighter-rouge\">ng-click=\"vm.edit();\n$event.stopPropagation();\"</code></li>\n  <li>\n    <p>don’t know why someone would use <code class=\"highlighter-rouge\">ng-repeat=\"o in vm.objects tack by o.id</code>\nsince DOM is updated always, even <code class=\"highlighter-rouge\">o.title</code> is changed.\n<a href=\"http://www.codelord.net/2014/04/15/improving-ng-repeat-performance-with-track-by/\">link</a>\nonly usage is that directive link function is not called until we add new\nitems or updateId <a href=\"http://jsfiddle.net/6k834fzx/4\">look console log</a>. If we\nupdate title Link function will not be called although DOM will be updated.</p>\n  </li>\n  <li>sample app https://angular-expenses.herokuapp.com/</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Vim",
      "category" : "",
      "tags"     : "",
      "url"      : "/2015/12/01/vim-tips/",
      "date"     : "2015-12-01 00:00:00 +0100",
      "content"  : "<h1 id=\"internals\">Internals</h1>\n\n<p>keynames:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">&lt;c-d&gt;</code> is control Ctrl + d, in help it can be written as <code class=\"highlighter-rouge\">CTRL-D</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;esc&gt;</code> is escape key</li>\n  <li><code class=\"highlighter-rouge\">&lt;space&gt;</code> space</li>\n  <li><code class=\"highlighter-rouge\">&lt;cr&gt;</code> sometimes it is <code class=\"highlighter-rouge\">&lt;Enter&gt;</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;bs&gt;</code> backspace</li>\n  <li><code class=\"highlighter-rouge\">&lt;left&gt;</code> left arrow</li>\n  <li><code class=\"highlighter-rouge\">&lt;s-left&gt;</code> shift left</li>\n  <li><code class=\"highlighter-rouge\">&lt;c-left&gt;</code> control left</li>\n  <li><code class=\"highlighter-rouge\">^I</code> is when we insert <code class=\"highlighter-rouge\">&lt;tab&gt;</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;nl&gt;</code> new line. If you use <code class=\"highlighter-rouge\">echom \"a\\nb\"</code> you will see <code class=\"highlighter-rouge\">a^@b</code> (<code class=\"highlighter-rouge\">CTRL-v</code> +\n<code class=\"highlighter-rouge\">CTRL-j</code>)</li>\n  <li><code class=\"highlighter-rouge\">&lt;tab&gt;</code> tab</li>\n</ul>\n\n<p>If you press <code class=\"highlighter-rouge\">c-s</code> ctrl+s than terminal will freeze all output and looks like\nvim hangs and stop working, but you need to run <code class=\"highlighter-rouge\">c-q</code> ctrl+q to exit from that.</p>\n\n<p>special variables</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">&lt;leader&gt;</code> by default is <code class=\"highlighter-rouge\">\\ </code> but I use <code class=\"highlighter-rouge\">&lt;space&gt;</code>. To check current value use:\n<code class=\"highlighter-rouge\">:echo mapleader</code>, to set use <code class=\"highlighter-rouge\">:let mapleader=\" \"</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;localleader&gt;</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;non-keyword-character&gt;</code> maps all non keyword chars: <code class=\"highlighter-rouge\">:set iskeyword?</code>\nreturns <code class=\"highlighter-rouge\">iskeyword=@,48-57,_,192-255,-</code> ie alphabetic ascii, digits 0-9, _ ,\nand some special chars</li>\n  <li><code class=\"highlighter-rouge\">&lt;nop&gt;</code> no operation, usefull when you want to disable some keys</li>\n</ul>\n\n<h1 id=\"my-vimrc\">My Vimrc</h1>\n\n<p>Good starting poing for <strong>.vimrc</strong> is  <a href=\"http://vim.wikia.com/wiki/Example_vimrc\">http://vim.wikia.com/wiki/Example_vimrc</a>\nYou can find my <a href=\"https://github.com/duleorlovic/config/blob/master/.vimrc\">.vimrc</a></p>\n\n<p>Note that control key can be written as caret <code class=\"highlighter-rouge\">^</code> so instead <code class=\"highlighter-rouge\">Ctrl + n</code> it can\nbe written as <code class=\"highlighter-rouge\">^n</code>.</p>\n\n<p>Use vim help, with:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">:help</code></li>\n  <li><code class=\"highlighter-rouge\">:helpgrep windows</code></li>\n  <li><code class=\"highlighter-rouge\">:help ctrl-i</code> what Ctrl + i do in normal mode (normal is by default searched)\nwe could also write <code class=\"highlighter-rouge\">:help ^i</code></li>\n  <li><code class=\"highlighter-rouge\">:help i_^i</code> what ctrl+i do in insert mode</li>\n  <li><code class=\"highlighter-rouge\">:help v_^i</code> what ctrl+i do in visual mode</li>\n  <li><code class=\"highlighter-rouge\">:help c_^i</code> what ctrl+i do in command mode</li>\n</ul>\n\n<p>other help commands can be found <code class=\"highlighter-rouge\">:help usr_02.txt</code>. Follow link with <code class=\"highlighter-rouge\">ctrl+]</code>\nand jump back with <code class=\"highlighter-rouge\">ctrl+o</code></p>\n\n<p>Instead of <code class=\"highlighter-rouge\">^o</code> I would write <code class=\"highlighter-rouge\">ctrl-o</code>.</p>\n\n<p>Some keys:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">&lt;c-o&gt;</code> is ctrl-o, take to normal mode for just one command, so if you want to\ngo up in insert mode <code class=\"highlighter-rouge\">&lt;c-o&gt; k</code>. Other usefull commands in insert mode:\n    <ul>\n      <li><code class=\"highlighter-rouge\">&lt;c-o&gt; &lt;c-t&gt;</code> <code class=\"highlighter-rouge\">&lt;c-o&gt; &lt;c-d&gt;</code> indent deindent in insert mode</li>\n      <li><code class=\"highlighter-rouge\">&lt;c-o&gt; d</code> delete everything to the right of cursor</li>\n      <li><code class=\"highlighter-rouge\">&lt;c-u&gt;</code> delete everything to the left</li>\n      <li><code class=\"highlighter-rouge\">&lt;c-w&gt;</code> delete word to the left of cursor</li>\n      <li><code class=\"highlighter-rouge\">&lt;c-h&gt;</code> backspace</li>\n      <li><code class=\"highlighter-rouge\">&lt;c-j&gt;</code> return</li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">&lt;c-o&gt;&lt;s-o&gt;</code> (i don’t know exactly but it stays in insert mode and run s-o)</li>\n</ul>\n\n<p>Command line mode <code class=\"highlighter-rouge\">:help usr_20.txt</code> is when using <code class=\"highlighter-rouge\">:</code> or search <code class=\"highlighter-rouge\">/</code>,<code class=\"highlighter-rouge\">?</code>.</p>\n\n<ul>\n  <li>You can press <code class=\"highlighter-rouge\">&lt;Enter&gt;</code> anywhere inside line</li>\n  <li>Navigation with cursors <code class=\"highlighter-rouge\">&lt;Left&gt;</code>, <code class=\"highlighter-rouge\">&lt;S-Left&gt;</code> (one word left) and\n<code class=\"highlighter-rouge\">CTRL+B</code>/<code class=\"highlighter-rouge\">CTRL+E</code> begin/end of line (only difference with bash is that <code class=\"highlighter-rouge\">CTRL+B</code>\nis char left and <code class=\"highlighter-rouge\">CTRL+F</code> enters <em>Replace mode</em> in comand line window)</li>\n  <li>\n    <p>Delete with <code class=\"highlighter-rouge\">&lt;BS&gt;</code> or <code class=\"highlighter-rouge\">CTRL-W</code> delete whole word, <code class=\"highlighter-rouge\">CTRL+U</code> delete all before\ntext</p>\n  </li>\n  <li>tab completetion works and you can see all matches with <code class=\"highlighter-rouge\">CTRL-D</code> (match is\nwhen command starts or short name starts with that)</li>\n  <li>\n    <p>command line history can be used when you type start of command and <code class=\"highlighter-rouge\">:se&lt;UP&gt;</code>\n<code class=\"highlighter-rouge\">CTRL-P</code> ignore what is already typed.</p>\n  </li>\n  <li>Command line window <code class=\"highlighter-rouge\">q:</code> or <code class=\"highlighter-rouge\">CTRL-F</code> is used to edit long commands. <code class=\"highlighter-rouge\">&lt;CR&gt;</code> to\nexecute comand end exit. Exit with <code class=\"highlighter-rouge\">:q</code> or <code class=\"highlighter-rouge\">CTRL-C</code>.</li>\n</ul>\n\n<p>You can join multiple commands with <code class=\"highlighter-rouge\">|</code> or <code class=\"highlighter-rouge\">&lt;NR&gt;</code> (more help with\n<code class=\"highlighter-rouge\">cmdline-lines</code>)</p>\n\n<p>Update to vim 8 use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo add-apt-repository ppa:jonathonf/vim\nsudo apt-get update\nsudo apt-get install vim\n</code></pre></div></div>\n\n<h1 id=\"plugins\">Plugins</h1>\n\n<p>Pathogen is no longer needed since you can install packages to\n<code class=\"highlighter-rouge\">.vim/pack/my-packages/start</code>.</p>\n\n<p>Install <a href=\"https://github.com/tpope/vim-pathogen\">pathogen</a> and other interesting\nplugins:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mkdir -p ~/.vim/autoload ~/.vim/bundle &amp;&amp; \\\ncurl -LSso ~/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim\n\ncd ~/.vim/bundle\ngit clone git://github.com/tpope/vim-rails.git # example: Rview\n</code></pre></div></div>\n\n<p>You can find <a href=\"https://github.com/duleorlovic/config/blob/master/vim/update_vim_bundle.sh#L8\">my list of\nplugins</a></p>\n\n<ul>\n  <li>rails-vim is nice\n    <ul>\n      <li>if you want to use rspec instead of minitest, you need to remove <code class=\"highlighter-rouge\">tests</code>\nfolder so <code class=\"highlighter-rouge\">:Espec</code> works</li>\n      <li>run <code class=\"highlighter-rouge\">&lt;leader&gt;s</code> to run nearest spec (also <code class=\"highlighter-rouge\">t,l,a</code> for file, last and all\nspecs)</li>\n      <li>there are mappings for minitests: <code class=\"highlighter-rouge\">Efunctionaltest</code> are controller tests,\n<code class=\"highlighter-rouge\">Eunittest</code> are model tests, <code class=\"highlighter-rouge\">Eintegrationtest</code> are integration between\ncontrollers. Do not know how to jump system tests.</li>\n      <li>use projections to add custom commands, for example <code class=\"highlighter-rouge\">app/services</code></li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>let g:rails_projections = {\n    \\ \"app/services/*.rb\": {\n    \\   \"command\": \"service\",\n    \\   \"template\":\n    \\     [\"class {camelcase|capitalize|colons}\", \"end\"],\n    \\   \"test\": [\n    \\     \"test/services/{}_test.rb\",\n    \\     \"spec/models/{}_spec.rb\"\n    \\   ],\n    \\ }}\n</code></pre></div>    </div>\n  </li>\n  <li>ctrlp ctrl+p\n    <ul>\n      <li>to seach already opened buffers, hit <code class=\"highlighter-rouge\">&lt;c-p&gt;</code> and than <code class=\"highlighter-rouge\">&lt;c-f&gt;</code></li>\n      <li>to open in horizontal sprit use <code class=\"highlighter-rouge\">&lt;c-p&gt;</code> and <code class=\"highlighter-rouge\">&lt;c-x&gt;</code></li>\n      <li>to open in current buffer, instead of patching <code class=\"highlighter-rouge\">autoload/ctrlp.vim:1309</code> to\nuse <code class=\"highlighter-rouge\">let md = 'r'</code> instead of  <code class=\"highlighter-rouge\">let md = argmaps</code> you can configure\ndifferent prompt mappings for <code class=\"highlighter-rouge\">&lt;c-o&gt;</code> to immediatelly replace buffer.</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\" make ctrl-o immediatelly replace buffer so we don't need to answer OpenMulti prompt\n\" Open Selected: [t]ab/[v]ertical/[h]orizontal/[r]eplace/h[i]dden? \nlet g:ctrlp_prompt_mappings = {\n\\ 'PrtSelectMove(\"j\")':   ['&lt;down&gt;'],\n\\ 'AcceptSelection(\"r\")': ['&lt;c-j&gt;'],\n\\ }\n</code></pre></div>    </div>\n  </li>\n  <li><a href=\"https://github.com/AndrewRadev/splitjoin.vim\">splitjoin</a> for inline ruby\nblocks <code class=\"highlighter-rouge\">{ }</code> to convert do multiline <code class=\"highlighter-rouge\">do\\n end</code>.</li>\n</ul>\n\n<p>Some not used anymore</p>\n\n<ul>\n  <li>\n    <p>You complete me: its too much visualisation</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># http://vimawesome.com/plugin/vim-rspec-sad-beautiful-tragic # :RunSpec\ngit clone git@github.com:Valloric/YouCompleteMe.git &amp;&amp; cd YouCompleteMe &amp;&amp; ./install.sh &amp;&amp; cd -\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p><a href=\"https://github.com/plasticboy/vim-markdown\">vim-markdown</a>: issue with syntax\nhighlight for * inside code block</p>\n  </li>\n  <li>\n    <p><a href=\"https://github.com/Townk/vim-autoclose\">vim-autoclose</a>: annoying O char\nwaiting next input</p>\n  </li>\n</ul>\n\n<h1 id=\"running-ruby-in-vim-and-show-in-separate-window\">Running ruby in vim and show in separate window</h1>\n\n<p><a href=\"http://vim.wikia.com/wiki/Preview_output_from_interpreter_in_new_window\">link</a>\nPress <code class=\"highlighter-rouge\">F7</code> to run selected or all code. Shift + F7 close the window.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\"save code, run ruby, show output in preview window\nfunction! Ruby_eval_vsplit() range\n  let src = tempname()\n  let dst = tempname()\n  execute \": \" . a:firstline . \",\" . a:lastline . \"w \" . src\n  execute \":silent ! ruby \" . src . \" &gt; \" . dst . \" 2&gt;&amp;1 \"\n  execute \":pclose!\"\n  execute \":redraw!\"\n  execute \":vsplit\"\n  execute \"normal \\&lt;C-W&gt;l\"\n  execute \":e! \" . dst\n  execute \":set pvw\"\n  execute \"normal \\&lt;C-W&gt;h\"\nendfunction\nvmap &lt;silent&gt; &lt;F7&gt; :call Ruby_eval_vsplit()&lt;CR&gt;\nnmap &lt;silent&gt; &lt;F7&gt; mzggVG&lt;F7&gt;`z\nimap &lt;silent&gt; &lt;F7&gt; &lt;Esc&gt;&lt;F7&gt;a\nmap &lt;silent&gt; &lt;S-F7&gt; &lt;C-W&gt;l:bw&lt;CR&gt;\nimap &lt;silent&gt; &lt;S-F7&gt; &lt;Esc&gt;&lt;S-F7&gt;a\n</code></pre></div></div>\n\n<h1 id=\"seeing-is-believing\">Seeing is believing</h1>\n\n<p>Show ruby return values on each line in vim.\nInstall <a href=\"https://github.com/JoshCheek/seeing_is_believing\">seeing_is_believing</a>\nwith <code class=\"highlighter-rouge\">gem install seeing_is_believing --version 3.0.0.beta.7</code> and add plugin <code class=\"highlighter-rouge\">cd\n~/.vim/bundle &amp;&amp; git clone https://github.com/hwartig/vim-seeing-is-believing</code>\nand add mappins: <code class=\"highlighter-rouge\">F4</code> mark, <code class=\"highlighter-rouge\">F5</code> run (not in visual) and <code class=\"highlighter-rouge\">enter</code> mark and run\n(not in insert mode)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\" .vimrc Enable seeing-is-believing mappings only for Ruby\naugroup seeingIsBelievingSettings\n  autocmd!\n\n  autocmd FileType ruby nmap &lt;buffer&gt; &lt;Enter&gt; &lt;Plug&gt;(seeing-is-believing-mark-and-run)\n  autocmd FileType ruby xmap &lt;buffer&gt; &lt;Enter&gt; &lt;Plug&gt;(seeing-is-believing-mark-and-run)\n\n  autocmd FileType ruby nmap &lt;buffer&gt; &lt;F4&gt; &lt;Plug&gt;(seeing-is-believing-mark)\n  autocmd FileType ruby xmap &lt;buffer&gt; &lt;F4&gt; &lt;Plug&gt;(seeing-is-believing-mark)\n  autocmd FileType ruby imap &lt;buffer&gt; &lt;F4&gt; &lt;Plug&gt;(seeing-is-believing-mark)\n\n  autocmd FileType ruby nmap &lt;buffer&gt; &lt;F5&gt; &lt;Plug&gt;(seeing-is-believing-run)\n  autocmd FileType ruby imap &lt;buffer&gt; &lt;F5&gt; &lt;Plug&gt;(seeing-is-believing-run)\naugroup END\n</code></pre></div></div>\n\n<h1 id=\"theory\">Theory</h1>\n\n<ul>\n  <li><a href=\"http://tnerual.eriogerg.free.fr/vimqrc.html\">quick reference card</a></li>\n  <li><a href=\"http://www.viemu.com/a_vi_vim_graphical_cheat_sheet_tutorial.html\">tutorial</a></li>\n  <li><code class=\"highlighter-rouge\">nnoremap ,html :asd</code> first letter <code class=\"highlighter-rouge\">n</code> means that this applies only in normal\nmode, <code class=\"highlighter-rouge\">no remap</code> means do not reinvoke if those commands <code class=\"highlighter-rouge\">,html</code> are used for\nsomething else, <code class=\"highlighter-rouge\">map</code> means simply when I type <code class=\"highlighter-rouge\">,html</code> please type <code class=\"highlighter-rouge\">:asd</code>\nOther modes are: <code class=\"highlighter-rouge\">cmap</code> control.</li>\n  <li><code class=\"highlighter-rouge\">cabbrev E e</code> can be used to replace <code class=\"highlighter-rouge\">E </code> with <code class=\"highlighter-rouge\">e </code> on command line.</li>\n  <li><code class=\"highlighter-rouge\">normal!</code> (with bang) means execute this exactly as I write (<code class=\"highlighter-rouge\">normal</code> will not\nignore mappings that user could have written and destroy your commands)</li>\n  <li>\n    <p>functions can be used to wrap some commands and give it a name.\nUse <code class=\"highlighter-rouge\">function!</code> so you can overwrite it without error. Undo will undo whole\nfunction at once.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function! MyFuction()\n  normal! mmu`m\nendfunction\nnnoremap &lt;leader&gt;sp :call MyFuction()&lt;cr&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>source current file <code class=\"highlighter-rouge\">nnoremap &lt;leader&gt;sop :source %&lt;cr&gt;</code> is used to source\n.vimrc so you do not need to exit and start vim again. You can reload any\n<code class=\"highlighter-rouge\">.vim</code> file, for example <code class=\"highlighter-rouge\">:source ~/config/vim/syntastic.vim</code></li>\n  <li>\n    <p>conditionals</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function! MF(level)\n  if a:level == 1\n    normal! yy\n  elseif a:level == 2\n    \" ....\n  endif\nendfunction\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"movements-and-navigation\">Movements and Navigation</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">gj</code> <code class=\"highlighter-rouge\">gk</code> for long lines that are wrapped to multiple lines, it will go up and\ndown</li>\n  <li><code class=\"highlighter-rouge\">$</code> end of line, <code class=\"highlighter-rouge\">0</code> start of line (or <code class=\"highlighter-rouge\">^</code>), use <code class=\"highlighter-rouge\">_</code> to select end of line\nbefore new line character</li>\n  <li><code class=\"highlighter-rouge\">+</code> and <code class=\"highlighter-rouge\">-</code> move line up or down on the first letter</li>\n  <li><code class=\"highlighter-rouge\">{</code> and <code class=\"highlighter-rouge\">}</code> move on paragraph (empty line)</li>\n  <li><code class=\"highlighter-rouge\">^B</code>(<code class=\"highlighter-rouge\">^U</code>) or <code class=\"highlighter-rouge\">^F</code> (<code class=\"highlighter-rouge\">^D</code>) scroll up (half) or down (half) page</li>\n  <li><code class=\"highlighter-rouge\">H</code> <code class=\"highlighter-rouge\">M</code> <code class=\"highlighter-rouge\">L</code> move to the top/middle/bottom of the window, so you can scroll</li>\n  <li><code class=\"highlighter-rouge\">mA</code> then <code class=\"highlighter-rouge\">'A</code> jump there (downcase letter <code class=\"highlighter-rouge\">a</code> can jump only on current\nbuffer), <code class=\"highlighter-rouge\">:marks</code> gives the jump location, two ‘ <code class=\"highlighter-rouge\">''</code> is jump back, <code class=\"highlighter-rouge\">'.</code> jump to\nlast change</li>\n  <li><code class=\"highlighter-rouge\">^o</code> and <code class=\"highlighter-rouge\">^i</code> will jump to previos and next location. <code class=\"highlighter-rouge\">^]</code> to jump to section\nunder cursor - hyperlink - ctags</li>\n  <li><code class=\"highlighter-rouge\">%</code> jump closing brackets or other matching brace</li>\n  <li><code class=\"highlighter-rouge\">5G</code> or <code class=\"highlighter-rouge\">:5</code> goes to the line 5</li>\n  <li><code class=\"highlighter-rouge\">gg</code> goes top, <code class=\"highlighter-rouge\">G</code> goes bottom</li>\n  <li><code class=\"highlighter-rouge\">g,</code> and <code class=\"highlighter-rouge\">g;</code> jump to next/prev change on current buffer</li>\n  <li><code class=\"highlighter-rouge\">:set scrollbind</code> in two buffers will make them scroll simultaneously. toggle\nscrolling with <code class=\"highlighter-rouge\">:set scb!</code></li>\n  <li>show line numbers <code class=\"highlighter-rouge\">:set number</code> or relative numbers <code class=\"highlighter-rouge\">:set relativenumber</code> (or\nshorter <code class=\"highlighter-rouge\">:set rnu</code>. To disable you can <code class=\"highlighter-rouge\">:set norelativenumber</code></li>\n  <li>show approx position in text <code class=\"highlighter-rouge\">^G</code></li>\n  <li><code class=\"highlighter-rouge\">gf</code> follow that file</li>\n</ul>\n\n<h1 id=\"motions-and-selections\">Motions and selections</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">ciw</code> change inner word, <code class=\"highlighter-rouge\">caw</code> including spaces that follows the word\n    <ul>\n      <li><code class=\"highlighter-rouge\">ca]</code> change all inside brackets including both [ ]</li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">daw</code> removes the inner word</li>\n  <li><code class=\"highlighter-rouge\">dt </code> delete until the space, <code class=\"highlighter-rouge\">df </code> delete until the space including space</li>\n  <li><code class=\"highlighter-rouge\">dap}p</code> switch two paragraph</li>\n  <li><code class=\"highlighter-rouge\">dE</code> removes to the End of the string</li>\n  <li><code class=\"highlighter-rouge\">vit</code> inner or <code class=\"highlighter-rouge\">vat</code> outer visual select (including html tag) <code class=\"highlighter-rouge\">:h tag-blocks</code>\n    <ul>\n      <li>repeat <code class=\"highlighter-rouge\">at</code> to select wraped tag</li>\n      <li>jump to closing (Oposite) html tag with <code class=\"highlighter-rouge\">o</code>. more on <code class=\"highlighter-rouge\">:help\nvisual-operators</code> <code class=\"highlighter-rouge\">:help v_it</code></li>\n      <li><code class=\"highlighter-rouge\">vap</code> select paragraph (until next empty line, including that empty line)</li>\n      <li><code class=\"highlighter-rouge\">dst</code> delete surround tag with vim surround plugin.</li>\n      <li><code class=\"highlighter-rouge\">cil</code> change inner line with line text object plugin</li>\n      <li><code class=\"highlighter-rouge\">vii</code> select same indent level with indent text object</li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">va'</code> visually select all inside ‘ including ‘</li>\n  <li><code class=\"highlighter-rouge\">cgn</code> change visually selected text using previous search</li>\n  <li>recording macro to q with <code class=\"highlighter-rouge\">qq</code>, exit with <code class=\"highlighter-rouge\">q</code>, run with <code class=\"highlighter-rouge\">@q</code></li>\n  <li>paste commands in insert mode with <code class=\"highlighter-rouge\">^Rq</code></li>\n  <li><code class=\"highlighter-rouge\">^T</code> indent <code class=\"highlighter-rouge\">^D</code> dedent in insert mode.\nIn normal mode you can select and indent with <code class=\"highlighter-rouge\">=</code>\nTo indent whole file you can jump to begging and indent to last line <code class=\"highlighter-rouge\">gg=G</code>.\nIn visual mode <code class=\"highlighter-rouge\">gq</code> will format text to 80 char lines (good for markdown)</li>\n</ul>\n\n<p>HTML indent works fine but note when to avoid erb tags. It detects <code class=\"highlighter-rouge\">%&gt;</code> as\nclosed tag except when line starts with <code class=\"highlighter-rouge\">&lt;%</code>. Do not use comment in the middle\nof erb since that line somehow is not indented. Better is to add another comment\ntag inline <code class=\"highlighter-rouge\">&lt;%# if condition? %&gt;</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Instead\n&lt;div&gt;\n  text node &lt;%= name %&gt;\n&lt;/div&gt;\n\nUse\n&lt;div&gt;\n  text node\n  &lt;%= name %&gt;\n&lt;/div&gt;\n\nFor if else anotation use separated tag\n&lt;% if b %&gt;\n&lt;% else %&gt;&lt;%# if b %&gt;\n&lt;% end %&gt;&lt;%# if b %&gt;\n\nFor multiline ruby there is a problems so use single line erb\n&lt;% one %&gt;\n&lt;% two %&gt;\n\nFor case switch there is a problem since it is not recognized as valid ruby\n    &lt;fieldset&gt;\n      &lt;% case searchable %&gt;\n      &lt;% when Book %&gt;\n        &lt;legend&gt;Book&lt;/legend&gt;\n        &lt;%= searchable.title %&gt;\n      &lt;% when User %&gt;\n      &lt;% end %&gt;\nonly solution is to merge two line into one\n    &lt;fieldset&gt;\n      &lt;% case searchable when Book %&gt;\n        &lt;legend&gt;Book&lt;/legend&gt;\n        &lt;%= searchable.title %&gt;\n      &lt;% when User %&gt;\n      &lt;% end %&gt;\n</code></pre></div></div>\n\n<h1 id=\"motion-in-visual-mode\">Motion in visual mode</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">'&lt;</code> to the first line (<code class=\"highlighter-rouge\">\\</code>&lt;` char) of last selected visual area. Note that\nyou need to exit current visual area and than jump to first or last line/char</li>\n  <li><code class=\"highlighter-rouge\">gv</code> to select previous selected visual area</li>\n</ul>\n\n<p>ragtag plugin in insert mode:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">&lt;c-x&gt;/</code> close last html tag</li>\n  <li><code class=\"highlighter-rouge\">&lt;c-x&gt;=</code> append <code class=\"highlighter-rouge\">&lt;%= %&gt;</code>, use <code class=\"highlighter-rouge\">&lt;c-x&gt;+</code> to wrap around last line</li>\n  <li><code class=\"highlighter-rouge\">&lt;c-x&gt;-</code> append <code class=\"highlighter-rouge\">&lt;% %&gt;</code>, use <code class=\"highlighter-rouge\">&lt;c-x&gt;_</code> to wrap around last line</li>\n  <li><code class=\"highlighter-rouge\">&lt;c-x&gt;@</code> insert stylesheet or <code class=\"highlighter-rouge\">&lt;c-x&gt;$</code> javascript tags</li>\n</ul>\n\n<h1 id=\"copy-paste\">Copy paste</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">\"+y</code> copy visual selection to system clipboard, ubuntu should run <code class=\"highlighter-rouge\">sudo\napt-get install vim-gtk</code>.</li>\n  <li>select which register to use with (use character not number) for example:\nyank link to register <code class=\"highlighter-rouge\">a</code> and paste: <code class=\"highlighter-rouge\">\"add</code> <code class=\"highlighter-rouge\">\"ap\"</code>. When deleting or changing it\nwill override default register, so you need to select some other register, like\nblack hole register <code class=\"highlighter-rouge\">\"_</code> if you want to paste same stuff multiple times, for\nexample <code class=\"highlighter-rouge\">\"_d</code> or <code class=\"highlighter-rouge\">\"_c</code> will keep default register untouched.</li>\n  <li><code class=\"highlighter-rouge\">%y+</code> copy all lines to clipboard</li>\n  <li>to move a line to buffer on the left you can record macro (something like\n<code class=\"highlighter-rouge\">yy ^wh p ^wl</code>)</li>\n  <li>to paste with proper indend use <a href=\"https://github.com/tpope/vim-unimpaired\">vim-unimpaired</a> <code class=\"highlighter-rouge\">]p</code> , also from plugin <code class=\"highlighter-rouge\">:help unimpaired</code></li>\n  <li><code class=\"highlighter-rouge\">[l</code> <code class=\"highlighter-rouge\">]l</code> ale errors</li>\n  <li><code class=\"highlighter-rouge\">]b</code> buffers</li>\n  <li><code class=\"highlighter-rouge\">]q</code> go next <code class=\"highlighter-rouge\">[q</code> prev Quick fix, Alss next error or warning with <code class=\"highlighter-rouge\">:lnext</code> or\n<code class=\"highlighter-rouge\">:lpr</code> or using <code class=\"highlighter-rouge\">[l</code> <code class=\"highlighter-rouge\">]l</code>. More are in <code class=\"highlighter-rouge\">:help unimpaired-next</code></li>\n  <li><code class=\"highlighter-rouge\">]ow</code> to enable wrap, toggle with <code class=\"highlighter-rouge\">yow</code>, more <code class=\"highlighter-rouge\">:help unimpaired-toggling</code></li>\n</ul>\n\n<p>To close error window you need to <code class=\"highlighter-rouge\">:lcl</code>. I use map for quickfix to <code class=\"highlighter-rouge\">:.cc</code></p>\n\n<ul>\n  <li>insert text from external command is with <code class=\"highlighter-rouge\">:read !date</code></li>\n</ul>\n\n<h1 id=\"exploring\">Exploring</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">:edit .</code> (short <code class=\"highlighter-rouge\">:e.</code>) opens (<code class=\"highlighter-rouge\">:vsp</code>) splits netrw of folder,</li>\n</ul>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>open file on specific line <code class=\"highlighter-rouge\">vi +10 README</code></li>\n</ul>\n\n<h2 id=\"netrw\">Netrw</h2>\n\n<p><a href=\"https://github.com/duleorlovic/config/blob/master/vim/netrw.vim\">netrw.vim</a> is\nnative exprorer.\n<code class=\"highlighter-rouge\">:Explore</code>(short <code class=\"highlighter-rouge\">:E</code>) <code class=\"highlighter-rouge\">:Vex</code> of current editing file\nTo change current folder just press c on folder line <code class=\"highlighter-rouge\">help :netrw-c</code>.\nThat’s better than <code class=\"highlighter-rouge\">cd ../path</code> which change in all tabs. It will not affect\nalready opened windows, so it should be done on the first window in the tab.</p>\n\n<p>Inside netrw:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">%</code> create new file, more info <code class=\"highlighter-rouge\">:help netrw-%</code></li>\n  <li><code class=\"highlighter-rouge\">d</code> create new directory</li>\n  <li><code class=\"highlighter-rouge\">R</code> rename file/directory under cursor</li>\n  <li><code class=\"highlighter-rouge\">D</code> delete file/directory under cursor</li>\n</ul>\n\n<h2 id=\"nerd-tree\">NERD tree</h2>\n\n<ul>\n  <li>to change current directory to selected folder, type in normal mode <code class=\"highlighter-rouge\">cd</code>. It\nwill change directory only in current buffer.</li>\n  <li>refresh with <code class=\"highlighter-rouge\">r</code> (selected dir) or <code class=\"highlighter-rouge\">R</code> (all)</li>\n</ul>\n\n<h1 id=\"searching\">Searching</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">/</code> for searching, to search in oposite direction <code class=\"highlighter-rouge\">?</code> (<code class=\"highlighter-rouge\">n</code> and <code class=\"highlighter-rouge\">N</code> for next\nand previous result). If search string is all lowercased than it will search\nignore case, but if you have at leat on uppercased letter than case is important</li>\n  <li><code class=\"highlighter-rouge\">:grep subject -R *\n--exclude-dir={log,spec,public,features,tmp,vendor,assets,db} -I</code>. Instead of\n<code class=\"highlighter-rouge\">:grep</code> I use <code class=\"highlighter-rouge\">:Ack</code> (which uses ag)</li>\n</ul>\n<p><a href=\"https://github.com/ggreer/the_silver_searcher\">https://github.com/ggreer/the_silver_searcher</a>. It will ignore all from\n<code class=\"highlighter-rouge\">.gitignore</code> so no need to exclude dir. Here are some ack.vim helpers:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">?</code> quick summary of keys, <code class=\"highlighter-rouge\">h</code> open in horizontal split</li>\n  <li>\n    <p><code class=\"highlighter-rouge\">ag pattern -G show</code> will search only filenames like <code class=\"highlighter-rouge\">show.html.erb</code> (<code class=\"highlighter-rouge\">-G</code>\n  is short for <code class=\"highlighter-rouge\">--file-search-regex patter</code>), <code class=\"highlighter-rouge\">-i</code> ignore case, <code class=\"highlighter-rouge\">-l</code> show only\n  filenames. <code class=\"highlighter-rouge\">--ignore-dir=lib</code> will ignore specific folders (regex not\n  supported). Filter only specific file type <code class=\"highlighter-rouge\">ag --list-file-types| less</code> you\n  can use <code class=\"highlighter-rouge\">ag MyClass --ruby</code>.</p>\n  </li>\n  <li>grep end of the word <code class=\"highlighter-rouge\">/usan\\&gt;</code> help with <code class=\"highlighter-rouge\">:h /\\&gt;</code></li>\n  <li><code class=\"highlighter-rouge\">:%s/old/new/gc</code></li>\n  <li><code class=\"highlighter-rouge\">q:</code> shows history of commands</li>\n  <li><code class=\"highlighter-rouge\">q/</code> shows history of searches</li>\n  <li><code class=\"highlighter-rouge\">:argdo %s/foo/bar/ge | update</code>  replace (substitute) in all arg</li>\n  <li><code class=\"highlighter-rouge\">:set nowrapscan</code> is usefull when you want to stop search when you hit bottom\nof a file. With <code class=\"highlighter-rouge\">gg</code> you can jump to begging. <code class=\"highlighter-rouge\">:set wrapscan</code> when you want to\nback to wrapped search</li>\n  <li>clear highlights until nex search <code class=\"highlighter-rouge\">:noh</code>, to clear completely <code class=\"highlighter-rouge\">set nohlsearch</code>\nor toggle <code class=\"highlighter-rouge\">nnoremap &lt;F3&gt; :set hlsearch!&lt;CR&gt;</code></li>\n  <li><code class=\"highlighter-rouge\">vim my_string **/*.md | copen</code> search only md files for my_string and show\nresults</li>\n  <li>beggining and end of line marks like <code class=\"highlighter-rouge\">/^asd</code> and <code class=\"highlighter-rouge\">/asd$</code> works fine (not in\nthe middle <code class=\"highlighter-rouge\">/asd^qwe</code>. For multiline search you can use: <code class=\"highlighter-rouge\">\\n</code> new line, <code class=\"highlighter-rouge\">\\_s</code>\nspace,tab or newline, <code class=\"highlighter-rouge\">\\_.</code> any char including new line, <code class=\"highlighter-rouge\">\\_^</code> and <code class=\"highlighter-rouge\">\\_$</code> are\nbeggining and end of line. You can use minimum matcher <code class=\"highlighter-rouge\">\\{-}</code> to stop as soon as\npossible (instead of <code class=\"highlighter-rouge\">*</code> which will stop at last occurrence).\n    <ul>\n      <li><code class=\"highlighter-rouge\">/asd\\_.\\{-}qwe</code> find asd followed with any character (including new line)\nand stop at qwe. You can use <a href=\"http://vim.wikia.com/wiki/Search_across_multiple_lines#Searching_over_multiple_lines_with_a_user_command\">S and S!\nsnippet</a></li>\n    </ul>\n  </li>\n</ul>\n\n<p><code class=\"highlighter-rouge\">:Ack</code> can be used to find in files. In vim it uses <code class=\"highlighter-rouge\">ag</code> instead of <code class=\"highlighter-rouge\">grep</code> or\n<code class=\"highlighter-rouge\">Ack</code>. To search specific types use option <code class=\"highlighter-rouge\">-G</code> and regexp like: <code class=\"highlighter-rouge\">:Ack\nmontserrat -G 'css$'</code>\nFor two line search you can use: <code class=\"highlighter-rouge\">:Ack 'destroy\\n.*authorize'  app/controllers/</code>\nFor multiline (dot not matter how many lines are in between) <code class=\"highlighter-rouge\">:Ack\n'destroy(\\n.*)*flash.now..notice'  app/controllers/</code></p>\n\n<h1 id=\"windows-buffers-and-tabs\">Windows buffers and tabs</h1>\n\n<p><a href=\"http://vim.wikia.com/wiki/Easier_buffer_switching\">terminology</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">:tabe file</code> open file in new tab, <code class=\"highlighter-rouge\">gt</code> switch between tabs</li>\n  <li><code class=\"highlighter-rouge\">:help Ctrl-W_T</code> move current buffer in new tab, Disable default Terminal -&gt;\nPreferences -&gt; Shortcuts</li>\n  <li><code class=\"highlighter-rouge\">gx</code> open link under cursor with <code class=\"highlighter-rouge\">gnome-open</code>.\n<a href=\"https://github.com/vim/vim/issues/1386\">Issue #1386</a></li>\n  <li><code class=\"highlighter-rouge\">:vsp #1</code>  vertically split window with file #1</li>\n  <li><code class=\"highlighter-rouge\">:on</code> or <code class=\"highlighter-rouge\">Ctrl+W+o</code> closes all windord except current</li>\n  <li><code class=\"highlighter-rouge\">:buffers</code>, <code class=\"highlighter-rouge\">:b1</code>, <code class=\"highlighter-rouge\">:bun</code> closes the buffer</li>\n  <li><code class=\"highlighter-rouge\">CTRL+^</code> (shift+6) jump to previous buffer</li>\n  <li><code class=\"highlighter-rouge\">retab</code> this will actually reformat all source</li>\n  <li><code class=\"highlighter-rouge\">ctrl+w+f</code> is the same as <code class=\"highlighter-rouge\">gf</code> but opens in new vertical split window</li>\n  <li><code class=\"highlighter-rouge\">b substring_of_filename</code> open buffer that matches substring (press tab in\ncase of multiple mathces)</li>\n</ul>\n\n<p>Quickfix window can be opened with <code class=\"highlighter-rouge\">:copen</code></p>\n\n<h1 id=\"completion\">Completion</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">^n</code> or <code class=\"highlighter-rouge\">^p</code> in insert mode to autocomplete strings and get next/previous item</li>\n  <li><code class=\"highlighter-rouge\">^x^o</code> to autocomplete using omni completion <code class=\"highlighter-rouge\">:set\nomnifunc=csscomplete#CompleteCSS</code></li>\n  <li><code class=\"highlighter-rouge\">^x^n</code> only strings from current file</li>\n  <li><code class=\"highlighter-rouge\">^x^l</code> complete whole lines</li>\n  <li><code class=\"highlighter-rouge\">^x^f</code> to complete filename (keep <code class=\"highlighter-rouge\">^x^f</code> when you navigate subfolders)</li>\n  <li><code class=\"highlighter-rouge\">^x^]</code> for tags find other shortcuts with <code class=\"highlighter-rouge\">:help ins-completion</code></li>\n  <li><code class=\"highlighter-rouge\">^a</code> and <code class=\"highlighter-rouge\">^x</code> to increment and decrement numbers\n<a href=\"https://github.com/tpope/vim-speeddating\">speeddating</a> if you want to increment\ndates</li>\n  <li>for commands you can use <code class=\"highlighter-rouge\">^d</code> to show all completion and <code class=\"highlighter-rouge\">&lt;tab&gt;</code> to use it</li>\n</ul>\n\n<h1 id=\"tips-1\">Tips</h1>\n\n<ul>\n  <li>Repeat last colon command <code class=\"highlighter-rouge\">@:</code>, repeat last command <code class=\"highlighter-rouge\">@@</code></li>\n  <li><code class=\"highlighter-rouge\">:args app/*/*</code>  to add all files to arg list</li>\n  <li><code class=\"highlighter-rouge\">:nnoremap _ f_x~</code> find next <code class=\"highlighter-rouge\">_</code>, remove and uppercase\n<a href=\"http://vim.wikia.com/wiki/Converting_variables_to_or_from_camel_case\">link</a>\nfor moving underscore to CamelCase</li>\n  <li>using vim inside irb or rails console with gem\n<a href=\"https://github.com/jberkel/interactive_editor\">interactive_editor</a>. Its\nusefull since you can paste only limited number of chars to irb line. Now you\ncan write your input data in file/ruby code and insert byebug/debugger/pry in\nrails code, and start hunting for bugs</li>\n  <li><code class=\"highlighter-rouge\">set showcmd</code> enable showing all keys that I’m typing in bottom right corner,\nvery usefull when explaining to someone</li>\n  <li>snippet <code class=\"highlighter-rouge\">nnoremap ,html :-1read $HOME/.vim/.skeleton.html&lt;CR&gt;3jwf&gt;a</code> <a href=\"https://github.com/duleorlovic/config/tree/master/vim/snippets\">my\nsnippets</a></li>\n  <li><code class=\"highlighter-rouge\">K</code> in normal mode opens documentation for that keyword, for example\n<code class=\"highlighter-rouge\">image_tag</code> or <code class=\"highlighter-rouge\">select</code> will open documentation for all gems which defines that\nkeyword</li>\n  <li>black screen is caused to silent command\nhttps://github.com/vim/vim/issues/1253 use <code class=\"highlighter-rouge\">:redraw!</code></li>\n</ul>\n\n<h1 id=\"books-videos-tutorials\">Books, videos tutorials</h1>\n\n<ul>\n  <li>vim begginer tutorial <code class=\"highlighter-rouge\">:help vimtutor</code> or run in shell <code class=\"highlighter-rouge\">vimtutor</code></li>\n  <li><a href=\"/2017/06/05/vim-theory/\">vim theory</a></li>\n  <li><a href=\"https://www.youtube.com/watch?v=5r6yzFEXajQ\">https://www.youtube.com/watch?v=5r6yzFEXajQ</a></li>\n  <li>\n    <p>start vim without plugin , no plugins\n<a href=\"https://www.youtube.com/watch?v=XA2WjJbmmoM\">–noplugin</a> or start vanila vim\nwithout vimrc initialization <code class=\"highlighter-rouge\">vim -u NONE</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># fuzzy finder\nset path+=**\nfind *-vim #\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"ctags\">CTAGS</h1>\n\n<p>You need to generate tags file with <code class=\"highlighter-rouge\">ctags -R .</code>. You can use default params.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># ~/.ctags\n--recurse=yes\n--exclude=.git\n--exclude=log\n--languages=ruby\n</code></pre></div></div>\n\n<p>Some vim keys:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>^] # ctrl + ] : jump to tag under cursos\n^t # jump back in tags stack (stack is when you go into definition with ^])\n^o ^i # similar move back and forward, but all jumps (not just tags)\n^x^] # autocomplete tags\ng] # list all ambiguous tags: same method could be defined in multiple classes\n\n:ts my_met # select tags for this search, also ctrp tags\n</code></pre></div></div>\n\n<p>To generate tags for all gems install <a href=\"https://github.com/tpope/gem-ctags\">https://github.com/tpope/gem-ctags</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem install gem-ctags\ngem ctags\n</code></pre></div></div>\n\n<p>Create template to git hook\n<a href=\"http://tbaggery.com/2011/08/08/effortless-ctags-with-git.html\">http://tbaggery.com/2011/08/08/effortless-ctags-with-git.html</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code></code></pre></div></div>\n\n<p>Also use CtrlPTag so you can navigate to tag</p>\n\n<h1 id=\"syntastic-checker\">Syntastic checker</h1>\n\n<p>Instead of synstastic I use ALE <a href=\"https://github.com/w0rp/ale\">https://github.com/w0rp/ale</a>\nResults are put in location list so you can navigate with <code class=\"highlighter-rouge\">] l</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\" config/vim/ale.vim\n\" change message\nlet g:ale_echo_msg_format = '[%linter%] %s [%severity%]'\n\n\" disable linter on change\nlet g:ale_lint_on_text_changed = 'never'\n\n\" use only erubylint\nlet g:ale_linters = {'eruby': ['erubylint']}\n\n\" enable airline\nlet g:airline#extensions#ale#enabled = 1\n\n\" use less invansive color for warnings\nhighlight ALEWarning ctermbg=DarkMagenta\n\n\" disable ale for all subrepositories under real-world-rails\nlet g:ale_pattern_options = {\n\\ '.*real-world-rails.*': { 'ale_enabled': 0},\n\\}\n</code></pre></div></div>\n\n<p>You can disable ALE with <code class=\"highlighter-rouge\">ALEToggle</code>. You can see error message <code class=\"highlighter-rouge\">ALEDetail</code>. Yo\nsee all configuration options <code class=\"highlighter-rouge\">ALEInfo</code>.\nThere was issue with erb <a href=\"https://github.com/w0rp/ale/issues/580\">https://github.com/w0rp/ale/issues/580</a> but this\nerubylint was recently removed from ale linters.</p>\n\n<h2 id=\"syntastic-deprecated-use-ale-instead\">Syntastic (deprecated, use ALE instead)</h2>\n\n<p><a href=\"https://github.com/scrooloose/syntastic\">syntastic</a> vim plugin is great to\nwrite your code. Just need to install external syntac checkers and they will be\neabled. <code class=\"highlighter-rouge\">SyntasticInfo</code> can give you current checkers and <code class=\"highlighter-rouge\">help\nsyntastic-checkers</code> will show you all available checkers.</p>\n\n<p>To check if some checker is installed you can try with system command (here we\nshow current path):</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:echo syntastic#util#system('echo \"$PATH\"')\n</code></pre></div></div>\n\n<p>You need to activate checkers for specific <strong>filetype</strong> and you can customise\nspeific <strong>checker</strong></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>let g:syntastic_&lt;filetype&gt;_checkers = ['&lt;checker-name&gt;']\nlet g:syntastic_&lt;filetype&gt;_&lt;checker&gt;_args = \"--my --args --here\"\n</code></pre></div></div>\n\n<p>Here is my configuration for syntastic and vim\n<a href=\"https://github.com/duleorlovic/config/blob/master/vim/syntastic.vim\">https://github.com/duleorlovic/config/blob/master/vim/syntastic.vim</a>\nYou need to install this tools:</p>\n\n<ul>\n  <li>Markdown <code class=\"highlighter-rouge\">gem install mdl</code></li>\n  <li>Ruby, Rails <code class=\"highlighter-rouge\">gem install rubocop</code>. You can automatically fix some errors with\n<code class=\"highlighter-rouge\">rubocop --auto-correct Gemfile</code>.\nConfiguration is in .rubocop.yml in $HOME or project root. You can disable all\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># .rubocop.yml\nAllCops:\n  DisabledByDefault: true\n</code></pre></div>    </div>\n\n    <p>My preferred configuration is\nhttps://github.com/duleorlovic/config/blob/master/.rubocop.yml</p>\n\n    <ul>\n      <li>inline in comment <code class=\"highlighter-rouge\"># rubocop:disable Metrics/AbcSize, Metrics/MethodLength</code></li>\n      <li>gem ‘rubocop-rspec’ is nice linter for rspec.\nYou can run manually with <code class=\"highlighter-rouge\">-D</code> param to see cop names.</li>\n    </ul>\n  </li>\n</ul>\n\n<p>To disable some errors define quiet messages in <code class=\"highlighter-rouge\">syntastic.vim</code> (<code class=\"highlighter-rouge\">:help\nsyntastic_quiet_messages</code>)\n  <a href=\"https://github.com/duleorlovic/config/blob/master/vim/syntastic.vim#L21\">g:syntastic_eruby_ruby_quiet_message</a></p>\n<ul>\n  <li>\n    <p>fix <code class=\"highlighter-rouge\">possibly useless use of a constant in void context</code> in erb is with\n<code class=\"highlighter-rouge\">&lt;%= CONST.to_s %&gt;</code>, when is problem with + than fix with assign <code class=\"highlighter-rouge\">&lt;%= total =\na + b; total %&gt;</code></p>\n  </li>\n  <li>for js I use <code class=\"highlighter-rouge\">jshint</code> with es6 and disabled semicolons</li>\n  <li>semicolons also disabled in <code class=\"highlighter-rouge\">eslint</code> (which extends from airbnb-base)</li>\n  <li>for styleles I use <code class=\"highlighter-rouge\">stylelint</code> and local <code class=\"highlighter-rouge\">.stylelintrc</code> since version 9.10\ndoes not pick my home configuration</li>\n  <li>Javascript <code class=\"highlighter-rouge\">npm install -g jscs jscs-angular</code> and create files [.jscs](</li>\n  <li>\n    <p>json <code class=\"highlighter-rouge\">npm install -g jsonlint</code> <a href=\"https://github.com/jaxbot/syntastic-react/issues/4\">link to issue</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\" .vimrc\nau BufRead,BufNewFile *.json set filetype=json\nlet g:syntastic_json_checkers=['jsonlint']\n</code></pre></div>    </div>\n  </li>\n  <li>coffeescript <code class=\"highlighter-rouge\">npm install -g coffeelint</code></li>\n</ul>\n\n<h1 id=\"vimium-chrome-extension\">Vimium chrome extension</h1>\n\n<p>https://github.com/philc/vimium</p>\n\n<p>Normal mode:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">j</code> and <code class=\"highlighter-rouge\">k</code> down and up on a page</li>\n  <li><code class=\"highlighter-rouge\">f</code> follow links <code class=\"highlighter-rouge\">F</code> follow in new tab</li>\n  <li><code class=\"highlighter-rouge\">H</code> and <code class=\"highlighter-rouge\">L</code> back and forward in history</li>\n  <li><code class=\"highlighter-rouge\">J</code> and <code class=\"highlighter-rouge\">K</code> prev and next tab</li>\n  <li><code class=\"highlighter-rouge\">o</code> search and open history links</li>\n  <li><code class=\"highlighter-rouge\">T</code> search open tabs</li>\n  <li><code class=\"highlighter-rouge\">r</code> reload the page</li>\n  <li><code class=\"highlighter-rouge\">gg</code> top or <code class=\"highlighter-rouge\">G</code> bottom of the page</li>\n  <li><code class=\"highlighter-rouge\">gi</code> go to first input element</li>\n</ul>\n\n<p>Additional navigation commands:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">yy</code> copy current url to clipboard</li>\n  <li><code class=\"highlighter-rouge\">gu</code> go up one level in URL path</li>\n  <li><code class=\"highlighter-rouge\">gU</code> go to root of domain</li>\n</ul>\n\n<p>Find mode, enter with <code class=\"highlighter-rouge\">/</code>:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">n</code> and <code class=\"highlighter-rouge\">N</code> next and prev search match</li>\n</ul>\n\n<p>Insert mode, enter with <code class=\"highlighter-rouge\">i</code>. So if you notice that <code class=\"highlighter-rouge\">x</code> closes tab even you are\ninside input, jump into insert mode first…</p>\n\n<p>Since gmail has own <code class=\"highlighter-rouge\">j</code> <code class=\"highlighter-rouge\">k</code> prev and next email, I added rule to ignore all\n(<code class=\"highlighter-rouge\">*</code>) keys</p>\n\n<p>Do not know https://stackoverflow.com/questions/53918093/why-is-class-demo-button-so-special-in-vimium?noredirect=1#comment94679088_53918093</p>\n\n<h1 id=\"vimum-vimfx\">Vimum VimFx</h1>\n\n<p><a href=\"https://addons.mozilla.org/ru/firefox/addon/vimfx/\">VimFx</a>\n<a href=\"https://github.com/akhodakivskiy/VimFx\">source</a> is vimium for\nfirefox. <code class=\"highlighter-rouge\">f</code> for navigation and clicks, <code class=\"highlighter-rouge\">/</code> for search (n N), <code class=\"highlighter-rouge\">x</code> <code class=\"highlighter-rouge\">X</code> for close\nand reopen tab, <code class=\"highlighter-rouge\">J</code> <code class=\"highlighter-rouge\">K</code> switch, <code class=\"highlighter-rouge\">space</code> <code class=\"highlighter-rouge\">shift+space</code> page down up.\n<a href=\"https://github.com/akhodakivskiy/VimFx/blob/master/documentation/commands.md\">Hints\nmode</a>:</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">f</code> anything clicable <code class=\"highlighter-rouge\">F</code> opens in new tab (or press Ctrl) <code class=\"highlighter-rouge\">ew</code> new window</li>\n  <li>by default lowercase letter will filter hint strings, but you can use\nuppercase letter to filter by text (you can see what is entered in lower right\ncorner)</li>\n  <li><code class=\"highlighter-rouge\">yf</code> copy text and links</li>\n</ul>\n\n<h1 id=\"rails-vim\">Rails vim</h1>\n\n<p>Some todos:</p>\n\n<p>Pluralize</p>\n\n<ul>\n  <li>When I type <code class=\"highlighter-rouge\">:Rcontroller customer</code> it should go to <code class=\"highlighter-rouge\">:Rcontroller customers</code>\ninstead of error: <code class=\"highlighter-rouge\">No such controller customer</code>. This usually happens when I\nhave a lot of models <code class=\"highlighter-rouge\">customer_invoices</code>, <code class=\"highlighter-rouge\">customer_payments</code> and <code class=\"highlighter-rouge\">customers</code>.</li>\n</ul>\n\n<p>Localize</p>\n\n<ul>\n  <li>When I’m in <code class=\"highlighter-rouge\">index.html.erb</code> and I type <code class=\"highlighter-rouge\">:Rcontroller</code> than I jump to\ncontroller, but if I’m on <code class=\"highlighter-rouge\">index.in.html.erb</code> than there is an error <code class=\"highlighter-rouge\">Argument\nrequired</code>. Also problem with <code class=\"highlighter-rouge\">:Eview another_</code></li>\n</ul>\n\n<p>Jump to system tests</p>\n\n<h1 id=\"create-scripts-for-vim\">Create scripts for vim</h1>\n\n<p><code class=\"highlighter-rouge\">help usr_41.txt</code> is Write a vim script in user manual.\n<a href=\"https://en.wikibooks.org/wiki/Learning_the_vi_Editor/Vim/VimL_Script_language\">https://en.wikibooks.org/wiki/Learning_the_vi_Editor/Vim/VimL_Script_language</a></p>\n\n<p>Detect if some features are enabled, for example only on macOS <code class=\"highlighter-rouge\">:help\nfeature-list</code>:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\" copy to clipboard on macOS need to use pbcopy\nif has('macunix')\n  vnoremap \"+y :w !pbcopy&lt;cr&gt;&lt;cr&gt;\nendif\n</code></pre></div></div>\n\n<h2 id=\"vim-scripts-in-ruby\">Vim scripts in ruby:</h2>\n\n<p>https://subvisual.co/blog/posts/139-how-to-program-vim-using-ruby/</p>\n\n<h2 id=\"vim-ruby-support\">Vim ruby support</h2>\n\n<p><code class=\"highlighter-rouge\">:help ruby</code>\nSome integrated stuff in vim\nhttps://github.com/vim-ruby/vim-ruby/blob/master/doc/vim-ruby.txt\nhttps://github.com/vim-ruby/vim-ruby/wiki/VimRubySupport</p>\n\n<h1 id=\"whereami-my-plugin-to-show-dedented-lines\">WHEREAMI my plugin to show dedented lines</h1>\n\n<p>When looking at large files in small window (I have 4 vim windows in my single\nterminal window) than I want to see to which block current line belongs.\nIn schema.rb, current line in which table ?</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActiveRecord::Schema.define(version: 20170124131420) do\n  create_table \"projects\", force: :cascade do |t|\n    ... long ...\n    t.integer title\n</code></pre></div></div>\n\n<p>In ability.rb, current ability to which user ?</p>\n\n<p>When I’m in long spec file, I want to see setup block for current example and\nall outer example groups (maybe to group all descriptions in one sentence).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.describe Project do\n let(:project) { Project.new }\n before\n ... long ...\n describe \"create task\" do\n   ... long ...\n   it \"order by date\" do\n     project\n</code></pre></div></div>\n\n<p>Also in view, I want to be able where current element belongs, so list all\nwrapped elements. And when I’m in scss I want to see all parent selector,\nclasses and media queries.</p>\n\n<p>Solution is to use similar row as in https://github.com/chrisbra/csv.vim\n<code class=\"highlighter-rouge\">:Header</code></p>\n\n<h1 id=\"rubocopfix-vim-plugin-rubocop\">RubocopFix vim plugin rubocop</h1>\n\n<p>Fix current rubocop error, by adding <code class=\"highlighter-rouge\">rubocop:disable</code></p>\n\n<h1 id=\"graph-visualization-in-markdown\">Graph visualization in markdown</h1>\n\n<p><a href=\"https://markvis-editor.js.org/\">https://markvis-editor.js.org/</a></p>\n\n<h1 id=\"debug-profile-startup-time\">Debug profile startup time</h1>\n\n<ul>\n  <li>if vim does not show properly, blank or empty screen, try <code class=\"highlighter-rouge\">:redraw!</code></li>\n</ul>\n<p><a href=\"https://github.com/bchretien/vim-profiler\">https://github.com/bchretien/vim-profiler</a></p>\n<ul>\n  <li><a href=\"https://github.com/vim-scripts/Decho\">https://github.com/vim-scripts/Decho</a></li>\n</ul>\n\n<h1 id=\"undo\">Undo</h1>\n\n<p><a href=\"https://github.com/mbbill/undotree\">https://github.com/mbbill/undotree</a> and remaped to F5 so you can easilly revert\nback to some earlier file.</p>\n\n<h1 id=\"vim-test\">Vim test</h1>\n\n<p>https://8thlight.com/blog/chris-jordan/2016/06/13/running-tests-in-vim.html</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\" run single rspec test example for current line\nnnoremap &lt;leader&gt;rs :execute \"!rspec %:\" . line(\".\")&lt;cr&gt;\n\n\" set compiler\n:compiler rspec\n:make %\n</code></pre></div></div>\n\n<p>Place language specific (file type) plugins inside <code class=\"highlighter-rouge\">~/.vim/ftplugin/ruby.vim</code> so\nthey are automatically loaded when you open ruby file.</p>\n\n<p>Use https://github.com/janko-m/vim-test</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">&lt;leader&gt;t</code> test nearest spec to the line (if not inside example, whole file\nwill be run) <code class=\"highlighter-rouge\">:TestNearest</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;leader&gt;T</code> test whole file <code class=\"highlighter-rouge\">:TestFile</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;leader&gt;a</code> test whole suite <code class=\"highlighter-rouge\">:TestSuite</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;leader&gt;l</code> test last, usefull if you navigate to the code and see if test\npass <code class=\"highlighter-rouge\">:TestLast</code></li>\n  <li><code class=\"highlighter-rouge\">&lt;leader&gt;g</code> visit test, jump back to the test to write more tests <code class=\"highlighter-rouge\">:TestVisit</code></li>\n</ul>\n\n<p>I use strategy <code class=\"highlighter-rouge\">let test#strategy = \"dispatch\"</code>. Asyncrun will not correctly\nparse errors:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># instead of one error\n# AsyncRun show two\n\nexpected `#&lt;User id: 1061, email: \"my-user@asd.asd\", created_at: \"2017-09-23 09|19| 48\", updated_at: \"2017-09-23 09:19:48\"&gt;.confirmed?` to return true, got false\nspec/features/user_confirmation_spec.rb|25| in `block (2 levels) in &lt;top (required)&gt;'\n</code></pre></div></div>\n\n<p>I prefer to use xdotool and send command to actual window</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\" config/vim/ftplugin/ruby.vim\nfunction! EchoStrategy(cmd)\n  let current_window = system('xdotool getactivewindow | tr -d \"\\n\"')\n  let target_window = system('xdotool search --classname vp_3_class_slash | tr -d \"\\n\"')\n  execute 'Dispatch!  xdotool windowactivate --sync '.target_window.' type \"'.a:cmd.'\"; xdotool key --delay 50 space Return windowactivate '.current_window\nendfunction\n\nlet g:test#custom_strategies = {'echo': function('EchoStrategy')}\nlet g:test#strategy = 'echo'\n</code></pre></div></div>\n\n<h1 id=\"vim-plugin\">Vim plugin</h1>\n\n<p><a href=\"https://github.com/junegunn/vim-plug\">https://github.com/junegunn/vim-plug</a> vim plugin manager is installed with one\ncommand <code class=\"highlighter-rouge\">curl -fLo ~/.vim/autoload/plug.vim --create-dirs\nhttps://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim</code> and setup\nin .vimrc</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>call plug#begin('~/.vim/plugged')\n\" Make sure you use single quotes\n\" Shorthand notation; fetches https://github.com/junegunn/vim-easy-align\nPlug 'junegunn/vim-easy-align'\ncall plug#end()\n</code></pre></div></div>\n\n<p>And install with <code class=\"highlighter-rouge\">PlugInstall</code></p>\n\n<h1 id=\"vim-color-scheme\">Vim Color Scheme</h1>\n\n<p><a href=\"https://github.com/nightsense/vimspectr\">https://github.com/nightsense/vimspectr</a> is installed using vim-plug</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Plug 'nightsense/vimspectr'\ncolorscheme vimspectr60flat-dark\n</code></pre></div></div>\n\n<p>but I prefer to tweek one by one color</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>highlight Comment cterm=underline ctermbg=Blue ctermfg=White\n</code></pre></div></div>\n\n<p><code class=\"highlighter-rouge\">cterm</code> accepts <code class=\"highlighter-rouge\">bold</code> <code class=\"highlighter-rouge\">underline</code> <code class=\"highlighter-rouge\">reverse</code> <code class=\"highlighter-rouge\">italic</code> but no colors.\n<code class=\"highlighter-rouge\">ctermfg</code> and <code class=\"highlighter-rouge\">ctermbg</code> accepts colors, list of all on <code class=\"highlighter-rouge\">:help cterm-color</code>\nHighlight groups can be found on\n<a href=\"http://vimdoc.sourceforge.net/htmldoc/syntax.html#highlight-groups\">highlight-groups</a></p>\n\n<p>To see where the color is defined use <code class=\"highlighter-rouge\">verbose</code>, for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>verbose hi Comment\n</code></pre></div></div>\n\n<p>Using ALE I see <code class=\"highlighter-rouge\">:help g:ale_set_highlights</code> that groups are <code class=\"highlighter-rouge\">ALEError</code>,\n<code class=\"highlighter-rouge\">ALEWarning</code> … so I use less invasive color:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>hi ALEWarning m\n</code></pre></div></div>\n\n<h1 id=\"folding\">Folding</h1>\n\n<p>You can hide copy right sections of other comments.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\" .vimrc\n\" https://stackoverflow.com/questions/2250011/can-i-have-vim-ignore-a-license-block-at-the-top-of-a-file\nfunction! FoldCopyright()\n  if !exists( \"b:foldedCopyright\" )\n    let b:foldedCopyright = 1\n    silent! 1,/# Copyright/;/USA\\.$/fold\n  endif\nendfunction\nautocmd BufNewFile,BufRead *.rb call FoldCopyright()\n</code></pre></div></div>\n\n<p>If you use <code class=\"highlighter-rouge\">autocmd FileType vim setlocal foldmethod=marker</code> marker method than\nany lines that starts and ends with <em>{ { { …. }}}</em> can be toggled with <code class=\"highlighter-rouge\">za</code></p>\n\n<h1 id=\"database\">Database</h1>\n\n<p>Use https://github.com/tpope/vim-db and access with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>:DB mysql://username:password@localhost/my_db_test\n</code></pre></div></div>\n\n<h1 id=\"tmux\">Tmux</h1>\n\n<p>Not using for now</p>\n\n<ul>\n  <li>strange characters instead of single quote I see <code class=\"highlighter-rouge\">&lt;91&gt;</code> and <code class=\"highlighter-rouge\">&lt;92&gt;</code> in vim.\nhttps://superuser.com/questions/199799/vim-shows-strange-characters-91-92 run\n<code class=\"highlighter-rouge\">:%s/[\\x91\\x92]/'/g</code> to replace them</li>\n</ul>\n\n<p>https://handbook.infinum.co/books/rails/Editors/Vim\nhttps://emily.st/2018/11/13/vim-in-the-future/</p>\n"
    } ,
  
    {
      "title"    : "Angular 1.x and Ruby on Rails",
      "category" : "",
      "tags"     : "angular, testing, rails",
      "url"      : "/2015/11/26/angular-and-ruby-on-rails/",
      "date"     : "2015-11-26 00:00:00 +0100",
      "content"  : "<h1 id=\"rails-as-asset-pipeline\">Rails as asset pipeline</h1>\n\n<p>I like to have Rails doing all javascript assets so I choose\n<a href=\"https://github.com/pitr/angular-rails-templates\">angular-rails-templates</a> to\ncache all templates and <a href=\"https://github.com/rharriso/bower-rails\">bower-rails</a>\ngem to install all scripts under vendor folder (nice\n<a href=\"http://angular-rails.com/bootstrap.html\">tutorial</a>). When angular requests\ntemplates, it needs url of that file. Since rails uses asset pipeline we need to\nuse erb <code class=\"highlighter-rouge\">templateUrl: '&lt;%= asset_path 'template' %&gt;'</code> (when we store assets on\nCDN, than we need to allow CORS since angular is loaded on our domain). Other\nsolution is\n<a href=\"https://github.com/pitr/angular-rails-templates\">angular-rails-templates</a> gem\nwhich create angular cache for all templates that found in\n<code class=\"highlighter-rouge\">app/assets/javascript/templates</code> (if you want to place templates outside of\nthat folder watch this\n<a href=\"https://github.com/pitr/angular-rails-templates/issues/107\">issue</a>). Keep in\nmind that you need latest gem version (1.4 does not work).</p>\n\n<p>Since rails use minification, we need to write angular dependency inject\narguments inside ‘’ like <code class=\"highlighter-rouge\">'$scope'</code> so they survive minification that happens to\njavascript. Those arguments are all except last one which is a function in\n<code class=\"highlighter-rouge\">app.controller(\"MyController\",['$scope',...,myController])</code></p>\n\n<p>It is easier to follow callstack if we don’t use anonymous function. On other\nhand it’s difficult to keep sync injection params with actual definition params,\nso I use <a href=\"https://github.com/kikonen/ngannotate-rails\">ng-annotate</a>.</p>\n\n<h1 id=\"railsresourcefactory\">railsResourceFactory</h1>\n\n<p>There is a angular factory for resource\n<a href=\"https://github.com/FineLinePrototyping/angularjs-rails-resource\">angularjs-rails-resource</a>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bower install angularjs-rails-resource --save\n# resolve with latest angular, it works find with 1.5.3\n</code></pre></div></div>\n\n<p>You can start from <a href=\"https://github.com/FineLinePrototyping/angularjs-rails-resource/blob/master/EXAMPLES.md\">EXAMPLES</a> and search applications for it’s usage\n<a href=\"https://github.com/search?q=saveIndicatorInterceptor&amp;type=Code&amp;utf8=%E2%9C%93\">saveIndicatorInterceptor</a></p>\n\n<p>Here is simple example for ionic</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># www/js/app.js\nangular.module 'starter', ['ionic', 'rails']\n\n# www/index.html\n    &lt;!-- Rails Resource\n    https://github.com/FineLinePrototyping/angularjs-rails-resource --&gt;\n    &lt;script src=\"lib/angularjs-rails-resource/angularjs-rails-resource.min.js\"&gt;&lt;/script&gt;\n\n# www/js/resources/locationTiken.resource.coffee\nangular.module 'starter'\n  .factory 'LocationTicket', (railsResourceFactory, CONSTANT) -&gt;\n    railsResourceFactory\n      url: CONSTANT.SERVER_URL + '/location_tickets'\n      name: 'location_ticket'\n\n# www/js/locationTicke/locationTicket.controller.coffee\n</code></pre></div></div>\n\n<p>Note that\n<a href=\"https://github.com/FineLinePrototyping/angularjs-rails-resource#resource-urls\">resource-url</a>\ncould be a function that will be evaluated at runtime (usefull if you need to\nchange api url depending on which user is logged in).  You can set context with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Item.query({category: 'Software'}, {storeId: 123}) // would generate a GET to /stores/123/items?category=Software\nItem.get({storeId: 123, id: 1}) // would generate a GET to /stores/123/items/1\n</code></pre></div></div>\n\n<p>I use that context to change url for my custom methods.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># some controller\nLocationTicket.query({}, info: true).then (info) -&gt;\n  vm.info = info\n\n# www/js/resources/locationTicket.resource.coffee\nangular.module 'starter'\n  .factory 'LocationTicket', (railsResourceFactory, CustomerAuth) -&gt;\n    railsResourceFactory\n      url: (context) -&gt;\n        if context &amp;&amp; context.id\n          CustomerAuth.locationServerUrl + '/api/v1/location_tickets/' +\n          context.id\n        else if context.info\n          CustomerAuth.locationServerUrl + '/api/v1/location_tickets/info'\n        else\n          CustomerAuth.locationServerUrl + '/api/v1/location_tickets'\n      name: 'location_ticket'\n</code></pre></div></div>\n\n<p>I use interceptor for loader. Also show toast if flag is set like\n<code class=\"highlighter-rouge\">cart.showToastOnError = true; cart.delete()</code>. For some resource I show toast\nfor all errors by adding <code class=\"highlighter-rouge\">interceptors: [notifyInterceptor]</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># src/app/resource/myResourceFactory.interceptor.coffee\nangular.module 'myapp.resources'\n  # https://github.com/FineLinePrototyping/angularjs-rails-resource/blob/master/vendor/assets/javascripts/angularjs/rails/resource/resource.js#L860\n  .factory 'myResourceFactory', (RailsResource, saveIndicatorInterceptor) -&gt;\n    (config) -&gt;\n      Resource = () -&gt;\n        Resource.__super__.constructor.apply(this, arguments)\n        return\n      RailsResource.extendTo Resource\n      config[\"interceptors\"] ||= []\n      config[\"interceptors\"].push saveIndicatorInterceptor\n      Resource.configure config\n      Resource\n  .factory 'saveIndicatorInterceptor', ($rootScope, $q, toastr) -&gt;\n    beforeRequest: (httpConfig, resourceConstructor, context) -&gt;\n      $rootScope.isLoading = true\n      httpConfig\n    afterResponse: (result, resourceConstructor, context) -&gt;\n      $rootScope.isLoading = false\n      result\n    afterResponseError: (rejection, resourceConstructor, context) -&gt;\n      $rootScope.isLoading = false\n      if context.showToastOnError\n        if rejection.data.error\n          message = rejection.data.error\n        else\n          message = JSON.stringify rejection.data\n        toastr.error message\n      $q.reject rejection\n  # https://github.com/FineLinePrototyping/angularjs-rails-resource#example-interceptor\n  .factory 'notifyInterceptor', (toastr, $q) -&gt;\n    afterResponseError: (rejection, resourceConstructor, context) -&gt;\n      message = JSON.stringify rejection.data\n      toastr.error message\n      $q.reject rejection\n</code></pre></div></div>\n\n<p>So I use <code class=\"highlighter-rouge\">myResourceFactory</code> as base for all my resources.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>angular.module 'myapp.resources'\n  .factory 'Restaurant', (myResourceFactory, railsSerializer, CONFIG) -&gt;\n    myResourceFactory\n      url: (context) -&gt;\n        # https://github.com/FineLinePrototyping/angularjs-rails-resource/issues/141\n        # https://github.com/FineLinePrototyping/angularjs-rails-resource#resource-urls\n        if context &amp;&amp; context.id\n          CONFIG.API_URL + '/restaurants/'+context.id\n        else if context &amp;&amp; context.userId\n          CONFIG.API_URL + '/users/'+context.userId+'/restaurants'\n        else if context &amp;&amp; context.link\n          CONFIG.API_URL + '/restaurants/'+context.link+'/by-link'\n        else\n          CONFIG.API_URL + '/restaurants'\n      name: 'restaurant'\n      serializer: railsSerializer( -&gt;\n        this.resource 'menuSections', 'MenuSection'\n      )\n      interceptors: [notifyInterceptor]\n</code></pre></div></div>\n\n<p>If you need to add property to resorce object (to have custom url) you should\nuse finally to clean up that resource for later <code class=\"highlighter-rouge\">.save()</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    vm.signInAs = (user) -&gt;\n      user.signInAs = true\n      user.save().then (resp) -&gt;\n        toastr.info \"Authenticated as #{user.firstName}. Please refresh\"\n      .finally -&gt;\n        user.signInAs = false\n</code></pre></div></div>\n\n<p><a href=\"https://github.com/FineLinePrototyping/angularjs-rails-resource/blob/master/EXAMPLES.md#adding-custom-methods-to-a-resource\">Adding custom\nmethods</a></p>\n\n<h1 id=\"example-apps-for-angular-rails\">Example apps for Angular Rails:</h1>\n\n<p>Tutorial videos (first are free) <a href=\"https://egghead.io/technologies/angularjs?order=ASC\">egghead</a></p>\n\n<ul>\n  <li><a href=\"https://github.com/jesalg/RADD\">RADD</a>: custom session with devise, api docs\nare generated\n<a href=\"https://github.com/zipmark/rspec_api_documentation\">rspec_api_documentation</a></li>\n  <li><a href=\"https://github.com/duleorlovic/flapper-news\">flapper-news</a>\n<a href=\"https://thinkster.io/angular-rails\">thinkster</a>\n<a href=\"https://github.com/cloudspace/angular_devise\">angular-devise</a></li>\n  <li><a href=\"https://github.com/jasonswett/lunch_hub\">lunch_hub</a>\n<a href=\"https://www.airpair.com/ruby-on-rails/posts/authentication-with-angularjs-and-ruby-on-rails\">post</a>\n<a href=\"https://github.com/lynndylanhurley/ng-token-auth\">ng-token-auth</a>, grunt</li>\n  <li><a href=\"https://github.com/mkwiatkowski/todo-rails4-angularjs\">todo-rails4-angularjs</a>\n<a href=\"https://shellycloud.com/blog/2013/10/how-to-integrate-angularjs-with-rails-4\">shellycloud</a>\nturbolinks, html auth</li>\n  <li><a href=\"https://github.com/davetron5000/receta\">receta</a>\n<a href=\"http://angular-rails.com/\">angular-rails</a> CRUD (no auth), TDD, angular-flash</li>\n  <li><a href=\"https://github.com/lynndylanhurley/ng-token-auth\">ng-token-auth</a>\n<a href=\"https://github.com/lynndylanhurley/devise_token_auth_demo\">devise-token-auth-demo</a>\ndevise-token-auth <code class=\"highlighter-rouge\">cd ng-token-auth/test &amp;&amp; bower install</code> update\n<code class=\"highlighter-rouge\">config/default.yml</code> so <code class=\"highlighter-rouge\">API_URL='//devise-token-auth-demo.local:3000'</code> and run\n<code class=\"highlighter-rouge\">gulp dev</code> and go to <a href=\"http://localhost:7777\">localhost:7777</a>. In another\nwindow <code class=\"highlighter-rouge\">cd devise_token_auth_demo &amp;&amp; bundle &amp;&amp; rails s</code>.\n<a href=\"https://github.com/search?utf8=%E2%9C%93&amp;q=ng-token-auth&amp;type=Code&amp;ref=searchresults\">ng-token-auth</a>\nis used ~2.5K times. On server use gem\n<a href=\"https://github.com/lynndylanhurley/devise_token_auth\">devise_token_auth</a>, run\napplication with <code class=\"highlighter-rouge\">gulp dev</code> and run <a href=\"https://github.com/lynndylanhurley/devise_token_auth_demo.git\">demo\nserver</a>.</li>\n  <li><a href=\"https://www.angularonrails.com/ruby-on-rails-angularjs-single-page-application/\">angularonrails.com</a></li>\n  <li>\n    <p><a href=\"https://web.telegram.org/#/login\">telegram.org</a> encrypted json</p>\n  </li>\n  <li>\n    <p>for start from scratch using ng-token-auth look at</p>\n\n    <p><a href=\"/2015/12/20/devise-oauth-angular/\">devise-oauth-angular</a></p>\n  </li>\n</ul>\n\n<h2 id=\"angular-inside-rails-asset-pipeline\">Angular inside rails asset pipeline</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo '\n# js package manager\ngem \"bower-rails\"\n# cache all templates\ngem \"angular-rails-templates\"\n' &gt;&gt; Gemfile\nbundle\nrails g bower_rails:initialize\ngit add . &amp;&amp; git commit -m \"rails g bower_rails:initialize\"\n\necho '\nRails.application.config.assets.paths &lt;&lt; Rails.root.join(\"vendor\",\"assets\",\"bower_components\")\nRails.application.config.assets.paths &lt;&lt; Rails.root.join(\"vendor\",\"assets\",\"bower_components\",\"bootstrap-sass-official\",\"assets\",\"fonts\")\nRails.application.config.assets.precompile &lt;&lt; %r(.*.(?:eot|svg|ttf|woff|woff2)$)\n' &gt;&gt; config/initializers/bower_rails.rb\n\necho '\nasset \"angular\"\nasset \"bootstrap-sass-official\"\n# vim: ft-ruby\n' &gt;&gt; Bowerfile\n\nrake bower:install\n\ngit rm app/assets/stylesheets/application.css\necho '\n@import \"bootstrap-sass-official/assets/stylesheets/bootstrap-sprockets\";\n@import \"bootstrap-sass-official/assets/stylesheets/bootstrap\";\n' &gt;&gt; app/assets/stylesheets/application.scss\n\nsed -i '/jquery_ujs/a \\\n//= require angular/angular' app/assets/javascripts/application.js\n\ngit add . &amp;&amp; git commit -am \"rake bower:install angular &amp; boostrap\"\n</code></pre></div></div>\n\n<h2 id=\"angular-and-rails-totally-separated-using-gulp\">Angular and Rails totally separated using gulp</h2>\n\n<p>Asset pipeline using gulp.\nGood reference is <a href=\"https://github.com/grantgeorge/railsAngularTutorial\">railsAngularTutorial</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># first create rails server side\nrails new --database=postgresql air\ncd air\ngit init &amp;&amp; git add . &amp;&amp; git commit -m \"rails new air  --database=postgresql\"\n\nrails g scaffold articles title:string body:text\nrake db:migrate\ngit add . &amp;&amp; git commit -m \"rails g scaffold articles title:string body:text\"\necho \"Article.create(title: 'Test Article', body: 'A test article. Cool')\" &gt;&gt; db/seeds.rb\nrake db:seed\nmkdir app/controllers/v1\ngit mv app/controllers/articles_controller.rb app/controllers/v1/articles_controller.rb\nsed -i \"/articles/c \\\\\\n\\\n  scope '/api' do\\n\\\n    namespace :v1, defaults: { format: :json } do\\n\\\n      resources :articles, except: [:new, :edit]\\n\\\n    end\\n\\\n  end\\n\\\n\" config/routes.rb\nsed -i '/class ArticlesController/c class V1::ArticlesController &lt; ApplicationController' app/controllers/v1/articles_controller.rb\nmkdir app/views/v1\ngit mv app/views/articles/ app/views/v1/\nsed -i '/article_url/c \\  json.url v1_article_url(article, format: :json)' app/views/v1/articles/index.json.jbuilder\ngit add . &amp;&amp; git commit -m \"Move Articles to api/v1 namespace\"\n\necho \"gem 'rails_12factor', group: :production\" &gt;&gt; Gemfile\nbundle install\ngit add . &amp;&amp; git commit -m \"Heroku uses 12 factor\"\nheroku create\nheroku addons:create heroku-postgresql:hobby-dev\ngit push heroku master --set-upstream\nheroku run rake db:migrate db:seed\nheroku open api/v1/articles\n</code></pre></div></div>\n\n<p>Yeoman yo <a href=\"https://github.com/Swiip/generator-gulp-angular\">gulp-angular</a> is great since it provides some initial tools.\nI use <code class=\"highlighter-rouge\">$log</code> for logging objects, for example <code class=\"highlighter-rouge\">$log.debug loginController: 'submitLogin then', resp: resp</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># than creating angular client side\nnpm install -g yo generator-gulp-angular\nmkdir client &amp;&amp; cd $_\nyo gulp-angular myappAngular # don't --default\n# choose coffe cript and Angular material\ngit add . &amp;&amp; git commit -m \"yo gulp-angular with coffeescript and Material\"\n# config proxy for /api and /omniauth, add params -p and -o\nsed -i gulp/server.js -f - &lt;&lt;HERE_DOC\n/function browserSyncInit(baseDir, browser) {/c \\\nfunction browserSyncInit(baseDir, browser, port, open, livereload) {\\n\\\n  port = port === undefined ? '3000' : port;\\n\\\n  open = open === undefined ? false : open;\\n\\\n  var snippetOptions = livereload === true ? {} : { rule: { match: /xxx/ } };\n\n/routes: routes/i \\    middleware: [\\n\\\n      proxyMiddleware([\"/api\",\"/omniauth\"], { target: \"http://localhost:\"+port }),\\n\\\n    ],\n/browserSync.instance/a \\\\\n    port: 9000,\\n\\\n    ui: {\\n\\\n      port: 8080,\\n\\\n    },\\n\\\n    open: open,\\n\\\n    snippetOptions: snippetOptions,\ns/task('serve'/task('serve_original'/\nHERE_DOC\ncat &gt;&gt; gulp/server.js &lt;&lt;'HERE_DOC'\ngulp.task('serve', ['watch'], function () {\n  // http://stackoverflow.com/questions/28538918/pass-parameter-to-gulp-task\n  var port, open, livereload, i;\n  i = process.argv.indexOf(\"-p\");\n  if (i&gt;-1) {\n    port = process.argv[i+1];\n    console.log(\"Find parameter -p \" + port);\n  }\n  i = process.argv.indexOf(\"-o\");\n  if (i&gt;-1) {\n    open = true;\n    console.log(\"Find parameter -o\");\n  }\n  i = process.argv.indexOf(\"-l\");\n  if (i&gt;-1) {\n    livereload = true;\n    console.log(\"Find parameter -l\");\n  }\n  browserSyncInit([path.join(conf.paths.tmp, '/serve'), conf.paths.src], undefined, port, open, livereload);\n});\nHERE_DOC\ngit add . &amp;&amp; git commit -m \"Config middleware to 3000 or -p param\"\n\n# better formating\nsed -i src/app/index.module.coffee \\\n  -e 's/, /,\\n  /g' \\\n  -e 's/  \\[/\\[\\n  /g' \\\n  -e 's/\\]/,\\n\\]/'\n\n# use latest angular material\nsed -i bower.json -e '/angular-material/c\\\n    \"angular-material\": \"*\",'\nbower update angular-material --save\n</code></pre></div></div>\n\n<p>Example articles factory:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mkdir src/app/components/articles\ncat &gt; src/app/components/articles/article.factory.js &lt;&lt; \\EOF\n'use strict';\n\nangular.module('myappAngular')\n  .factory('Article', function ($resource) {\n    return $resource('api/v1/articles/:articleId', {\n      articleId: '@id'\n    }, {\n      update: {\n        method: 'PUT'\n      }\n    });\n  });\nEOF\n\necho note that this works for javascript not for coffeescript\nsed -i '/vm.showToastr/a \\\n    Article.query(function (res) {\\\n      vm.articles = res;\\\n    });' src/app/main/main.controller.js\nsed -i '/function MainController/c \\  function MainController($timeout, webDevTec, toastr, Article) {' src/app/main/main.controller.js\nsed -i '/Allo/c \\\n    &lt;h1&gt;Articles&lt;/h1&gt;\\\n    &lt;div ng-repeat=\"article in main.articles\"&gt;\\\n      &lt;h2&gt;{{ article.title }}&lt;/h2&gt;\\\n      &lt;p&gt;{{ article.body }}&lt;/p&gt;\\\n    &lt;/div&gt;\\\n' src/app/main/main.html\ncd .. # back to root\ngit add . &amp;&amp; git commit -m \"Adding angular Article resource and show on main page\"\n</code></pre></div></div>\n\n<p>To run on linux/windows, install git (Use Git from the Windows Command Prompt)\nand nodejs.  Run in windows command line cmd: <code class=\"highlighter-rouge\">npm install -g gulp</code> and <code class=\"highlighter-rouge\">npm\ninstall</code> and <code class=\"highlighter-rouge\">gulp serve</code></p>\n\n<p>If you want to completely split front end code, than use some <a href=\"/2016/03/02/gulp-tasks/\">Gulp tasks</a></p>\n\n<h1 id=\"angular-httpprovider-cant-send-json-patch-request\">Angular httpProvider can’t send json patch request</h1>\n\n<p>Can’t set <code class=\"highlighter-rouge\">'Content-Type': 'application/json'</code> for angular <code class=\"highlighter-rouge\">$http(method:\n'PATCH')</code>. I tried with both inline <code class=\"highlighter-rouge\">header</code> and config\n<code class=\"highlighter-rouge\">$httpProvider.defaults.headers.patch = 'Content-Type': 'application/json'</code>but\nnot luck. It is always http request.</p>\n\n<p>UPDATE: it can send, but url needs to be <code class=\"highlighter-rouge\">.json</code>\nDo not use <code class=\"highlighter-rouge\">patch</code> because old browsers (if you use ionic, that means old\nphones).</p>\n"
    } ,
  
    {
      "title"    : "Google Maps and Locations",
      "category" : "",
      "tags"     : "",
      "url"      : "/google/location-suggestion/maps/2015/11/20/google-maps-and-locations/",
      "date"     : "2015-11-20 00:00:00 +0100",
      "content"  : "<h1 id=\"installation\">Installation</h1>\n\n<p>As for any other google api, <a href=\"https://developers.google.com/maps/documentation/javascript/tutorial\">Google Maps Javascript\nAPI</a>\nrequires GOOGLE_API_KEY. You need it when you loading the script</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;script src=\"https://maps.googleapis.com/maps/api/js?key=GOOGLE_API_KEY&amp;callback=initMap\"\n    async defer&gt;&lt;/script&gt;\n</code></pre></div></div>\n\n<p>You can load additional libraries using <code class=\"highlighter-rouge\">libraries=</code> parameter. If the map is\nnot the main feauture of the site, I prefer to load it in javascript when\nneeded.</p>\n\n<p>For your google console project you need to enable relevant api:</p>\n\n<ul>\n  <li><em>Google Maps Javascript API</em> (to load gmap on the page)</li>\n  <li><em>Google Static Maps API</em> (to show image with pin marker)</li>\n  <li><em>Google Places API Web Service</em> (to search by address, restauran or other\nplace) note that I can not find this in search apis but only using this link</li>\n</ul>\n<p><a href=\"https://console.developers.google.com/apis/api/places_backend?project=_\">https://console.developers.google.com/apis/api/places_backend?project=_</a></p>\n\n<p>Start with samples, for example:</p>\n\n<ul>\n  <li><a href=\"https://developers.google.com/maps/documentation/javascript/examples/geocoding-simple\">geocoding</a>\ninput is address, output is location</li>\n  <li><a href=\"https://developers.google.com/maps/documentation/javascript/examples/places-autocomplete\">autocomplete</a>\nshow suggestions for adress input</li>\n</ul>\n\n<h1 id=\"edit-location-for-some-object\">Edit location for some object</h1>\n\n<p>Use this helper in edit.html with form object, and on show page with object.\nYou need to provide input fields: <code class=\"highlighter-rouge\">text_field</code> or <code class=\"highlighter-rouge\">hidden_field</code> so they will be\nupdated in javascript callback.</p>\n\n<p>If you show/hide whole map (with <code class=\"highlighter-rouge\">display: none</code>), than you need to trigger\nresize with setCenter and setZoom or map.fitBounds (probably inside setTimeout\nif you are still in digest loop).\nBetter is to use opacity 0, 1 and move element below.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.hide-with-opacity {\n  opacity: 0;\n  &amp;.active {\n    opacity: 1;\n  }\n}\n</code></pre></div></div>\n\n<p>Note that when <code class=\"highlighter-rouge\">resize</code> is triggered than center is changed, so you need to grab\ncenter before resize, than call resize (so map is actually shown) and than call\nsetCenter or panTo the original center. To get map object we use mapObject data</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$(document).on 'ready page:load', -&gt;\n  # if you do not have map object, you can trigger resize on window\n  # google.maps.event.trigger(window, 'resize', {})\n  # but the problem is when map is initialized to hidden element, than center is\n  # on top right corner, so when you trigger resize, pin will be on top-right\n  # We need to getCenter and call setCenter again after we trigger resize\n  if $('#preview-map').length\n    $('.nav-tabs').on 'shown.bs.tab', -&gt;\n      map = $('#preview-map').data('mapObject')\n      originalCenter = map.getCenter()\n      # google.maps.event.trigger(window, 'resize', {})\n      # map.setCenter c\n      google.maps.event.trigger map, 'resize'\n      map.panTo originalCenter\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/helpers/map_helper.rb\n# rubocop:disable Metrics/ModuleLength\n# rubocop:disable Metrics/MethodLength\n# rubocop:disable Metrics/AbcSize\n# rubocop:disable Style/MultilineTernaryOperator\n# rubocop:disable Layout/SpaceInsideStringInterpolation\nmodule MapHelper\n  INITIAL_LATITUDE = 45.2671352\n  INITIAL_LONGITUDE = 19.83354959999997\n  INITIAL_ZOOM = 12\n  GOOGLE_API_KEY = Rails.application.secrets.google_api_key\n\n  # You need to provide input fields: `text_field` or `hidden_field` so they\n  # will be updated in javascript callback.\n  #  &lt;%= f.text_field :latitude, id: 'latitude-input' %&gt;\n  #  &lt;%= f.text_field :longitude, id: 'longitude-input' %&gt;\n  #  &lt;%= edit_map f.object, \"#latitude-input\", \"#longitude-input\" %&gt;\n  #\n  # If you are showing inside bootstrap tab or modal than you need to trigger\n  # resize. If you do not have map object, you can trigger resize on window\n  # google.maps.event.trigger(window, 'resize')\n  # but the problem is when map is initialized to hidden element, than center is\n  # on top right corner, so when you trigger resize, pin will be on top-right\n  # We need to getCenter and call setCenter again after we trigger resize so I\n  # did it using addDomListener on window object and fire that resize on modal\n  # show:\n  #\n  # somewhere inside function initialize_google() {\n  #        google.maps.event.addDomListener(window, \"resize\", function() {\n  #          var center = map.getCenter();\n  #          google.maps.event.trigger(map, \"resize\");\n  #          map.setCenter(center);\n  #          console.log('map resize');\n  #        });\n  # somewhere in your javascript/coffeescript:\n  # $(document).on 'shown.bs.modal', -&gt;\n  #   window.dispatchEvent(new Event('resize'))\n  #\n  # If you are destroying modal on hide (so it loads new content based on\n  # response), than map will be destroyed too.\n  #\n  # $(document).on 'hidden.bs.modal', '.modal', -&gt;\n  #   $(this).removeData('bs.modal')\n  #\n  # Problem is that javascript in form response (on this page) is run only once,\n  # so you can not trigger initialize_google() from this page. but only on shown\n  # good is that you do not need to trigger resize since we draw map again:\n  #\n  # $(document).on 'shown.bs.modal', '.modal', -&gt;\n  #   if this.innerHTML.indexOf('initialize_google') &gt; -1\n  #     initialize_google()\n  def edit_map(object, latitude_input, longitude_input)\n    if object.latitude\n      latitude = object.latitude\n      longitude = object.longitude\n      zoom_level = 17\n    else\n      latitude = INITIAL_LATITUDE\n      longitude = INITIAL_LONGITUDE\n      zoom_level = INITIAL_ZOOM\n    end\n    address_id = \"address-suggestion\" # -#{SecureRandom.hex 3}\"\n    content = text_field_tag(\n      address_id, nil, placeholder:\n      I18n.t('write_address_than_move_marker'), size: 50\n    )\n    map_id = \"preview-map\" #-#{SecureRandom.hex 3}\"\n    content &lt;&lt; content_tag(:div, nil, id: map_id, class: 'edit-map-container')\n    content &lt;&lt; %(\n      &lt;script&gt;\n        function updateFields(position) {\n          $(\"#{latitude_input}\").val(position.lat());\n          $(\"#{longitude_input}\").val(position.lng());\n        }\n        function initialize_google() {\n          console.log('initializing google autocomplete');\n          // https://wiki.openstreetmap.org/wiki/Google_Maps_Example\n          var mapTypeIds = [];\n          for(var type in google.maps.MapTypeId) {\n           mapTypeIds.push(google.maps.MapTypeId[type]);\n          }\n          mapTypeIds.push(\"OSM\");\n          var map = new google.maps.Map(document.getElementById('#{map_id}'), {\n            center: {lat: #{latitude}, lng: #{longitude} },\n            zoom: #{zoom_level},\n            mapTypeId: \"OSM\",\n            mapTypeControlOptions: {\n              mapTypeIds: mapTypeIds\n            },\n          });\n\n          map.mapTypes.set(\"OSM\", new google.maps.ImageMapType({\n            getTileUrl: function(coord, zoom) {\n              // See above example if you need smooth wrapping at 180th meridian\n              return \"http://tile.openstreetmap.org/\" + zoom + \"/\" + coord.x + \"/\" + coord.y + \".png\";\n              },\n            tileSize: new google.maps.Size(256, 256),\n            name: \"OpenStreetMap\",\n            maxZoom: 18,\n          }));\n          var autocomplete = new google.maps.places.Autocomplete(\n            document.getElementById('#{address_id}'),\n            { componentRestrictions: {country: 'rs'} }\n          );\n          var marker = new google.maps.Marker({\n            map: map,\n            anchorPoint: new google.maps.Point(0, -29),\n            draggable: true,\n            animation: google.maps.Animation.DROP,\n            #{object.latitude.present? ?\n              \"position: {\n                lat: #{latitude},\n                lng: #{longitude},\n              },\" : '' }\n          });\n          autocomplete.bindTo('bounds', map);\n          autocomplete.addListener('place_changed', function() {\n            marker.setVisible(false);\n            var place = autocomplete.getPlace();\n            if (!place.geometry) {\n             window.alert(\"#{I18n.t('autocomplete_contains_no_geometry')}\");\n             return;\n            }\n            // If the place has a geometry, then present it on a map.\n            if (place.geometry.viewport) {\n             map.fitBounds(place.geometry.viewport);\n            } else {\n             map.setCenter(place.geometry.location);\n             map.setZoom(17);  // Why 17? Because it looks good.\n            }\n            marker.setPosition(place.geometry.location);\n            marker.setVisible(true);\n            updateFields(place.geometry.location);\n            console.log('place_changed');\n          });\n\n          google.maps.event.addListener(marker, \"dragend\", function(e) {\n            updateFields(marker.getPosition());\n          });\n        } // function initialize_google\n      &lt;/script&gt;\n    ).html_safe\n    content &lt;&lt; async_load\n  end\n\n  # https://developers.google.com/maps/documentation/static-maps/intro\n  def show_static_map(object, options = {})\n    latitude = object.latitude\n    longitude = object.longitude\n    return \"&lt;div class='map-not-set'&gt;Map position is not set&lt;/div&gt;\".html_safe unless latitude\n    img_options = {}\n    img_options[:class] = options[:class] if options[:class].present?\n    url = \"//maps.googleapis.com/maps/api/staticmap?\"\n    url += \"size=70x70\"\n    # custom icon must be http:// not https://\n    # markers=icon:http://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png|\n    url += \"&amp;markers=|#{latitude},#{longitude}\"\n    # you need to enable \"Google Static Maps API\"\n    url += \"&amp;key=#{GOOGLE_API_KEY}\"\n    link_to \"http://maps.google.com/?q=#{latitude},#{longitude}\" do\n      image_tag url, img_options\n    end\n  end\n\n  def show_map(object, options = {})\n    latitude = object.latitude\n    longitude = object.longitude\n    return \"&lt;div class='map-not-set'&gt;Map position is not set&lt;/div&gt;\".html_safe unless latitude\n    content = content_tag(:div, nil, id: 'preview-map', class: \"show-map-container #{options[:class]}\")\n    content &lt;&lt; %(\n      &lt;script&gt;\n        function initialize_google() {\n          console.log('initializing google autocomplete');\n          var previewMapElement = document.getElementById('preview-map');\n          var map = new google.maps.Map(previewMapElement, {\n            center: {lat: #{latitude}, lng: #{longitude} },\n            zoom: 17,\n          });\n          var marker = new google.maps.Marker({\n            map: map,\n            animation: google.maps.Animation.DROP,\n            #{object.latitude.present? ?\n              \"position: {\n                lat: #{latitude},\n                lng: #{longitude},\n              },\" : '' }\n          });\n          $(previewMapElement).data('mapObject', map);\n        } // function initialize_google\n      &lt;/script&gt;\n    ).html_safe\n    content &lt;&lt; async_load\n  end\n\n  def show_all_map(objects, options = {})\n    data = objects.map do |object|\n      next if !object.latitude.present? || !object.longitude.present?\n      {\n        position: {\n          lat: object.latitude,\n          lng: object.longitude,\n        },\n        name: object.name,\n        description: object.description,\n        url: location_node_path(object),\n      }\n    end.compact\n    content = content_tag(:div, nil, id: 'preview-map', class: \"show-all-map-container #{options[:class]}\")\n    content &lt;&lt; %(\n      &lt;script&gt;\n        function initialize_google() {\n          console.log('initializing google autocomplete');\n          var map = new google.maps.Map(document.getElementById('preview-map'), {\n            center: {lat: #{INITIAL_LATITUDE}, lng: #{INITIAL_LONGITUDE}},\n            zoom: #{INITIAL_ZOOM},\n          });\n          var data = #{data.to_json};\n          var markers = [];\n          var bounds = new google.maps.LatLngBounds();\n          var infoWindow = new google.maps.InfoWindow({\n            content: \"&lt;div&gt;&lt;a href='' id='info-url'&gt;&lt;h4 id='info-name'&gt;&lt;/h4&gt;&lt;/a&gt;&lt;p id='info-description'&gt;&lt;/p&gt;&lt;/div&gt;\"\n          });\n          for(var i = 0; i &lt; data.length; i++ ) {\n            var marker = new google.maps.Marker({\n              animation: google.maps.Animation.DROP,\n              position: data[i].position,\n              name: data[i].name,\n              description: data[i].description,\n              url: data[i].url,\n            });\n            bounds.extend(marker.getPosition());\n            markers[i] = marker;\n            setTimeout(dropMarker(i), i * 100);\n            google.maps.event.addListener(marker, 'click', function() {\n              infoWindow.open(map, this);\n              $('#info-name').html(this.name);\n              $('#info-description').html(this.description);\n              $('#info-url').attr('href', this.url);\n            });\n          }\n          map.fitBounds(bounds);\n          function dropMarker(i) {\n            return function() {\n              markers[i].setMap(map);\n            };\n          }\n        } // function initialize_google\n      &lt;/script&gt;\n    ).html_safe\n    content &lt;&lt; async_load\n  end\n\n  private\n\n  def async_load\n    %(\n      &lt;script&gt;\n        // https://developers.google.com/maps/documentation/javascript/examples/map-simple-async\n        function loadScript() {\n          var script = document.createElement('script');\n          script.type = 'text/javascript';\n          script.src = 'https://maps.googleapis.com/maps/api/js?libraries=places' +\n              '&amp;key=#{GOOGLE_API_KEY}&amp;callback=initialize_google';\n          document.body.appendChild(script);\n        }\n        // http://stackoverflow.com/questions/9228958/how-to-check-if-google-maps-api-is-loaded\n        if (typeof google === 'object' &amp;&amp; typeof google.maps === 'object') {\n          // it is loaded but we need to bind on newly created object\n          initialize_google();\n        } else {\n          loadScript();\n        }\n      &lt;/script&gt;\n    ).html_safe\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/contacts/_form.html.erb\n  &lt;%= edit_map f %&gt;\n\n# app/views/contacts/show.html.erb\n  &lt;%= show_map @contact %&gt;\n\n# app/views/contacts/index.html.erb\n  &lt;%= show_all_map @contacts %&gt;\n  &lt;%= show_static_map @contact %&gt;\n\n# app/assets/stylesheets/maps.scss\n.edit-map-container,.show-all-map-container {\n  height: 300px;\n  width: 100%;\n}\n.show-map-container {\n  height: 30px;\n}\n</code></pre></div></div>\n\n<h1 id=\"stimulus-and-man-in-bootstrap-4-modal\">Stimulus and man in bootstrap 4 modal</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code></code></pre></div></div>\n\n<h1 id=\"location-search-field\">Location search field</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/home/search.html.erb %&gt;\n&lt;%= form_for @search, builder: MyFormBuilder, url: search_path, method: :get, html: { id: \"filter_form\" } do |f| %&gt;\n  &lt;%= f.location_field :address, placeholder: \"Address\" %&gt;\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/search.rb\nclass Search\n\n  # http://api.rubyonrails.org/classes/ActiveModel/Model.html\n  include ActiveModel::Model\n\n  attr_accessor :address, :food\n\n  def initialize( attributtes = {} )\n    super\n    @address ||= \"New York\"\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/home_controller.rb\ndef search\n  @search = Search.new params[:search]\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/form_builders/my_form_builder.rb\n# http://api.rubyonrails.org/classes/ActionView/Helpers/FormBuilder.html\nclass MyFormBuilder &lt; ActionView::Helpers::FormBuilder\n\n  # https://developers.google.com/maps/documentation/javascript/places\n  def location_field( method, options={} )\n    if options[:text_area] == true\n      content = text_area(method, options)\n    else\n      content = text_field(method, options)\n    end\n    if options[:location_field_id].present?\n      location_field_id = options[:location_field_id]\n    else\n      location_field_id = object_name + \"_\" + method.to_s\n    end\n    content &lt;&lt; \"\n      &lt;script&gt;\n        function initialize_google() {\n          var options = {\n          //  types: ['(cities)'],\n            componentRestrictions: {country: '#{ options[:country] || 'us' }'}\n          };\n          console.log('initializing google autocomplete');\n          input = document.getElementById('#{location_field_id}');\n          var autocomplete = new google.maps.places.Autocomplete(input, options);\n        }\n        // https://developers.google.com/maps/documentation/javascript/examples/map-simple-async\n        function loadScript() {\n          var script = document.createElement('script');\n          script.type = 'text/javascript';\n          script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&amp;' + 'libraries=places&amp;' +\n              'callback=initialize_google';\n          document.body.appendChild(script);\n        }\n        // http://stackoverflow.com/questions/9228958/how-to-check-if-google-maps-api-is-loaded\n        if (! (typeof google === 'object' &amp;&amp; typeof google.maps === 'object'))\n        {\n          loadScript();\n        }\n        else\n        {\n           // it is loaded but we need to bind on newly created object\n           initialize_google();\n        }\n      &lt;/script&gt;\".html_safe\n  end\nend\n</code></pre></div></div>\n\n<p>Map with markers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/home_controller.rb\n  def search\n    @search = Search.new params[:search]\n    @target_location = Geocoder.search(@search.address)\n    @users = User.chef.near(@search.address)\n  end\n</code></pre></div></div>\n\n<p>When creating a map, you need to provide zoom option.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# app/views/home/search.html.erb %&gt;\n&lt;div id=\"all_map\"&gt;&lt;/div&gt;\n&lt;ul&gt;\n  &lt;% @users.each_with_index do |user,i| %&gt;\n    &lt;li data-marker-array-index=\"&lt;%= i %&gt;\"&gt;\n      &lt;h4&gt;&lt;%= user.name %&gt;&lt;/h4&gt;\n    &lt;/li&gt;\n  &lt;% end %&gt;\n&lt;/ul&gt;\n\n&lt;script&gt;\n  var map = new google.maps.Map(document.getElementById('all_map'), {\n    zoom: 4,\n    &lt;% center = { lat: (@target_location.try(:latitude)||25), lng: (@target_location.try(:longitude)||131) } %&gt;\n    center: &lt;%=raw center.to_json %&gt;,\n    });\n  var chefs = &lt;%=raw @users.select {|u| u.geocoded? }.map {|u| { name: u.name, position: { lat: u.latitude, lng: u.longitude } }}.to_json %&gt;;\n  var markersArray = [];\n  for(var i=0; i &lt; chefs.length; i++ ) {\n    var marker = new google.maps.Marker({\n        title: chefs[i].name,\n        map: map,\n        position: chefs[i].position,\n      });\n    markersArray.push(marker);\n  }\n  bounds = new google.maps.LatLngBounds();\n  for (var i = 0; i &lt; markersArray.length; i++) {\n    marker = markersArray[i];\n    bounds.extend(marker.position);\n  }\n  if(markersArray.length &gt; 0){\n    map.fitBounds(bounds);\n    var mapzoom = map.getZoom();\n    if(mapzoom &gt; 16){\n      map.setZoom(16);\n    };\n\n  }\n  $('[data-marker-array-index]').hover(function() {\n      console.log(\"hover\");\n      var marker =markersArray[ parseInt($(this).data('marker-array-index'))]\n      marker.setAnimation(google.maps.Animation.BOUNCE);\n    }, function() {\n      console.log(\"out hover\");\n      var marker =markersArray[ parseInt($(this).data('marker-array-index'))]\n      marker.setAnimation(null);\n    });\n&lt;/script&gt;\n</code></pre></div></div>\n\n<h1 id=\"geocoder-gem\">Geocoder gem</h1>\n\n<p>You can geocode ActiveRecord object by latitude longitude or by ip address.\nResults (reverse_geocode) can be written in addres, city, country. You can use\nin console</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Geocoder.coordinates(\"25 Main St, Cooperstown, NY\")\n# Google Geocoding API error: over query limit.\nGeocoder.coordinates(\"178.222.169.10\") #=&gt; [\"46.1\", \"19.6\"]\n\nGeocoder.search(\"Paris\", :bounds =&gt; [[32.1,-95.9], [33.9,-94.3]])\n</code></pre></div></div>\n\n<p>You can download MaxMind local database (only for ip geocode) and import to psql</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># generate migration to create tables\nrails generate geocoder:maxmind:geolite_city\n\n# download, unpack, and import data\nrake geocoder:maxmind:geolite:load PACKAGE=city\n\n# configure\nGeocoder.configure(ip_lookup: :maxmind_local, maxmind_local: {package: :city})\n\n# now you can use offline\nGeocoder.coordinates(\"178.222.169.10\") #=&gt; [\"46.1\", \"19.6\"]\n</code></pre></div></div>\n\n<p>Since for GOOGLE API there is a limit of free 2_500 request per day you can\ngeocode if change in latitude and longitude is big</p>\n<blockquote>\n  <p>Each degree of latitude is approximately 69 miles (111 kilometers) apart. The range varies (due to the earth’s slightly ellipsoid shape) from 68.703 miles (110.567 km) at the equator to 69.407 (111.699 km) at the poles. This is convenient because each minute (1/60th of a degree) is approximately one [nautical] mile.\nA degree of longitude is widest at the equator at 69.172 miles (111.321) and gradually shrinks to zero at the poles. At 40° north or south the distance between a degree of longitude is 53 miles (85 km)</p>\n</blockquote>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/user.rb\nclass User &lt; ActiveRecord::Base\n  MIN_LATITUDE_CHANGE_FOR_GEOCODE = 0.2 # 1 degree is 69 miles (111 km)\n  MIN_LONGITUDE_CHANGE_FOR_GEOCODE = 0.3 # 1 degree on equator 69 miles (111km), on 40deg 53 miles (85km)\n  reverse_geocoded_by :latitude, :longitude, address: :reverse_geocoded_address do |obj, results|\n    # next unless (obj.latitude_changed? &amp;&amp; obj.longitude_changed?) || !obj.current_city_by_latitude_longitude.present?\n    if geo = results.first\n      obj.current_city_by_latitude_longitude    = geo.city\n      obj.current_address_by_latitude_longitude = geo.address\n      obj.save!\n    end\n  end\n  # do not run on each validation since api limit is 2_500\n  # after_validation :reverse_geocode\n\n  def submit_reverse_geocode\n    return false if latitude.nil? || longitude.nil?\n    if current_city_by_latitude_longitude.nil? || last_geocoded_latitude.nil? || last_geocoded_longitude.nil?  ||\n        (last_geocoded_latitude - latitude).abs &gt; MIN_LATITUDE_CHANGE_FOR_GEOCODE ||\n        (last_geocoded_longitude - longitude).abs &gt; MIN_LONGITUDE_CHANGE_FOR_GEOCODE\n      reverse_geocode\n      self.last_geocoded_latitude = latitude\n      self.last_geocoded_longitude = longitude\n      save!\n    else\n      false\n    end\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"geolocating\">Geolocating</h1>\n\n<p>Here are the steps that I usually do for geolocating users:</p>\n\n<ul>\n  <li>try to get lat/long pair from browser</li>\n  <li>use free service <a href=\"http://www.geoplugin.com/webservices/json\">http://www.geoplugin.com/webservices/json</a></li>\n  <li>ask user for address and geocode it on client <a href=\"https://developers.google.com/maps/documentation/javascript/geocoding\">Google Maps Javascript\nAPI</a>\nGeocoding Service</li>\n  <li>ask user for address and geocode it on server <a href=\"https://developers.google.com/maps/documentation/geocoding/intro\">Google Maps Geocoding\nAPI</a></li>\n</ul>\n\n<h2 id=\"get-brower-location\">Get Brower location</h2>\n\n<h2 id=\"get-geoplugin-location\">Get Geoplugin location</h2>\n\n<p>Here is example in angular using their\n<a href=\"http://www.geoplugin.com/webservices/json\">json</a> service. \nYou can buy cheap <a href=\"http://www.geoplugin.com/webservices/ssl\">ssl</a> packet and use <code class=\"highlighter-rouge\">https://ssl.geoplugin.net/json.gp?k=...</code> endpoint.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    this.getGeoPluginLocation = -&gt;\n      deferred = $q.defer()\n      # $http has a problem with Access-Control-Allow-Origin since request is\n      # OPTIONS instead of GET method\n      # $http.get('http://www.geoplugin.net/json.gp?jsoncallback=?').then (response) -&gt;\n      $.getJSON('http://www.geoplugin.net/json.gp?jsoncallback=?').then (response) -&gt;\n        userLocationData.latLng.lat = parseFloat response.geoplugin_latitude\n        userLocationData.latLng.lng = parseFloat response.geoplugin_longitude\n        userLocationData.address = response.geoplugin_city + \" \" + response.geoplugin_countryName\n        deferred.resolve()\n      return deferred.promise\n</code></pre></div></div>\n\n<p><a href=\"https://developers.google.com/maps/documentation/geolocation/intro#wifi_access_point_object\">Google Maps Geolocation\nAPI</a>\ncan use wifi or tower ids to give you latLng.</p>\n\n<h1 id=\"apple-mapkit\">Apple MapKit</h1>\n\n<p>https://developer.apple.com/videos/play/wwdc2018/212/</p>\n\n"
    } ,
  
    {
      "title"    : "Seo Advices",
      "category" : "",
      "tags"     : "",
      "url"      : "/2015/11/11/seo-advices/",
      "date"     : "2015-11-11 00:00:00 +0100",
      "content"  : "<p>Test your site on\n<a href=\"https://developers.google.com/speed/pagespeed/insights/\">https://developers.google.com/speed/pagespeed/insights/</a>\n<a href=\"https://search.google.com/test/mobile-friendly\">https://search.google.com/test/mobile-friendly</a>\n<a href=\"https://search.google.com/search-console/inspect\">https://search.google.com/search-console/inspect</a>\n<a href=\"https://search.google.com/test/rich-results\">https://search.google.com/test/rich-results</a>\n<a href=\"https://search.google.com/structured-data/testing-tool/u/0/\">https://search.google.com/structured-data/testing-tool/u/0/</a>\n<a href=\"https://gtmetrix.com/\">https://gtmetrix.com/</a></p>\n\n<p>Free trial seo report rank <a href=\"https://www.woorank.com/\">https://www.woorank.com/</a>\nAlso on <a href=\"https://www.webpagetest.org/\">https://www.webpagetest.org/</a></p>\n\n<h1 id=\"webpagetest\">WEBPAGETEST</h1>\n\n<p>Videos https://www.youtube.com/watch?v=6UeRMMI_IzI&amp;index=7&amp;list=PLWa0Ky8nXQTaFXpT_YNvLElTEpHUyaZi4\nGithub https://github.com/WPO-Foundation/webpagetest\nDocs https://sites.google.com/a/webpagetest.org/docs/advanced-features/webpagetest-restful-apis</p>\n\n<h1 id=\"general-tips\">General Tips</h1>\n\n<ul>\n  <li>Be sure that each page has a unique title on each page <code class=\"highlighter-rouge\">&lt;title&gt;Nice\npage&lt;/title&gt;</code>, 10-70 chars, with keywords</li>\n  <li>also <code class=\"highlighter-rouge\">&lt;meta name=\"description\" content=\"It's really nice page &lt;%=\n@user.name if @user.present? %&gt;\"&gt;</code> should be 70-160 chars, uniq per page</li>\n  <li>use one <code class=\"highlighter-rouge\">&lt;h1&gt;</code> per page with keywords but do not duplicate title, use h2-h6\nfor other keywords.</li>\n  <li>use alt atribute for description of images, but also image source link should\nwe unique and self explanatory</li>\n  <li>Links within your content tend to carry more weight than links within a\nsidebar or footer.</li>\n  <li>try to have more and more inbound links from other sites. Increase link count\nusing: social media, directories, some sites links to competition, try to write\nthem explaining why your site is better. To find inbound links use google\nwebmaster tools, <a href=\"https://moz.com/researchtools/ose/\">https://moz.com/researchtools/ose/</a></li>\n  <li>if your content expires (like job posts, wheater data) than link old pages to\ncategory pages (group of similar results)</li>\n  <li>outbound links can be no-follow, especially outgoing links that are not\nrelevant (do not have quality content). For example, links to a Feedburner page.</li>\n  <li>anchor text plays the most important role in link building. If you want to\nrank for ‘blue widget’ then you want the anchor text of the link to be <code class=\"highlighter-rouge\">&lt;a&gt;blue\nwidget&lt;/a&gt;</code></li>\n  <li>25-70% should be only text (not html markup tags)</li>\n  <li>add <a href=\"#sitemap\">XML sitemap</a> (with correct protocol http/s, subdomain,\ntrailing slash) if more than 100 than only most popular</li>\n  <li>use 301 redirect from root to www domain (or vice versa) do not split value to\ntwo different domains (also from IP address)</li>\n  <li>replace undrescore _ with dash (hyphens) - in urls</li>\n  <li>flash and frames are not indexed</li>\n  <li>nice mobile rendering (buttons at least 48px width/height, 32px padding around\ntap targets)</li>\n  <li>add viewport meta tag <code class=\"highlighter-rouge\">&lt;meta name=\"viewport\" content=\"initial-scale=1.0,\nwidth=device-width\"&gt;</code> and use CSS media queries to apply different style\ndepending of screen size</li>\n  <li>enable gzip compresion, optimize image, use <code class=\"highlighter-rouge\">srcset</code> for responsive images,\nspecify image dimensions\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;img src=\"https://example.com/images/image.png\" srcset=\"https://example.com/images/image-1024.png 1024w, https://example.com/images/image-512.png 512w\" sizes=\"100vw\"&gt;\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>eliminate render-blocking javascript\nand css, leverage browser caching, minify css, to have small page size (less\nthan 320Kb) and load under one second\n<a href=\"https://fonts.googleapis.com/css?family=Montserrat|Open+Sans\">google web\nfonts</a> are\ncached only for one day (each day, it is downloaded again). For\ndifferent browsers it uses diffent files: woff2, svg … Download fonts using\n<a href=\"https://google-webfonts-helper.herokuapp.com/fonts\">this heroku app</a>. Change\nfolder prefix to <code class=\"highlighter-rouge\">poppins/</code>, and extract downloaded fonts (without folder) to\n<code class=\"highlighter-rouge\">app/assets/fonts/poppins</code> so you can see the file\n<code class=\"highlighter-rouge\">app/assets/fonts/poppins/poppins-v1-latin-regular.svg</code>. Copy/paste the\ncontent to some <code class=\"highlighter-rouge\">app/assets/stylesheets/popins.scss</code> file and include in\n<code class=\"highlighter-rouge\">applications.scss</code> with <code class=\"highlighter-rouge\">@import 'popins';</code></p>\n  </li>\n  <li>add favicon. It is fine just to add to the root of web site\n(for rails just copy your png to <code class=\"highlighter-rouge\">public/favicon.ico</code>) Size should be 32x32.\nSome of the best favicons is\nhttps://cdn.shopify.com/shopify-marketing_assets/static/shopify-favicon.png\nMore info on\nhttps://en.wikipedia.org/wiki/Favicon#How_to_use</li>\n  <li>custom 404 error page</li>\n  <li>add language <code class=\"highlighter-rouge\"><span class=\"nt\">&lt;html</span> <span class=\"na\">lang=</span><span class=\"s\">\"en\"</span><span class=\"nt\">&gt;</span></code></li>\n  <li>SSL secure (http should redirect to https), add STS in header,\nxml sitemap, link to css files to use https</li>\n  <li>social media</li>\n  <li>optimize css https://csswizardry.com/2018/11/css-and-network-performance/</li>\n</ul>\n\n<h1 id=\"rails-gzip\">Rails gzip</h1>\n\n<p>It should show in Response Headers:</p>\n\n<p>Content-Encoding:gzip</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngem 'heroku-deflater', :group =&gt; :production\n\n# config/environments/production.rb\n  config.assets.compress = true\n</code></pre></div></div>\n\n<h1 id=\"robots\">Robots</h1>\n\n<p>https://en.wikipedia.org/wiki/Robots_exclusion_standard</p>\n\n<p><code class=\"highlighter-rouge\">/robots.txt</code> is used to tell some good crawlers wheter they should read or not.\nBad crawlers will read the site anyway.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># public/robots.txt\n# See http://www.robotstxt.org/robotstxt.html for documentation on how to use the robots.txt file\n#\n# To ban all spiders from the entire site uncomment the next two lines:\n# User-agent: *\n# Disallow: /\n# Sitemap: http://www.example.com/sitemap.xml.gz\n</code></pre></div></div>\n\n<p>You can use meta tags to disable some well known robots. Add <code class=\"highlighter-rouge\">&lt;meta\nname=\"robots\" content=\"noodp,noydir\"&gt;</code> to disable Open Directory Project and\nYahoo Directory to provide description for your site</p>\n\n<h1 id=\"sitemap\">Sitemap</h1>\n\n<p><a href=\"https://github.com/kjvarga/sitemap_generator\">sitemap_generator</a> gem is\nexcellent tool.\nThis gem follows <a href=\"http://www.sitemaps.org/protocol.html\">protocol</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo \"gem 'sitemap_generator'\" &gt;&gt; Gemfile\nbundle\nrake sitemap:install # this will generate config/sitemap.rb\nvi config/sitemap.rb # put some `add path, options`\nrake sitemap:refresh:no_ping # to generate sitemap to public folder without ping\nless public/sitemap.xml.gz\ngunzip public/sitemap.xml.gz &amp;&amp; chromium-browser public/sitemap.xml\n</code></pre></div></div>\n\n<p>Use <code class=\"highlighter-rouge\">Post.find_each</code> instead of <code class=\"highlighter-rouge\">Post.all.each</code> since we do not want to load all\nposts in memory.</p>\n\n<p>To run every day, you can use <a href=\"https://github.com/javan/whenever\">whenever</a> to\ncall <code class=\"highlighter-rouge\">rake sitemap:refresh -s</code></p>\n\n<h2 id=\"sitemapgeneratorsitemap-options\"><code class=\"highlighter-rouge\">SitemapGenerator::Sitemap</code> options</h2>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">Sitemap.default_host = 'http://example.com'</code> is your default url</li>\n  <li><code class=\"highlighter-rouge\">Sitemap.create_index = true</code> always create index file\n<code class=\"highlighter-rouge\">&lt;sitemapindex&gt;&lt;sitemap&gt;&lt;loc&gt;http://www.example.com/sitemap1.xml.gz&lt;/loc&gt;&lt;/sitemap&gt;&lt;/sitemapindex&gt;</code>\nthat will link to other sitemap files\n<a href=\"http://www.sitemaps.org/protocol.html#index\">definition</a></li>\n  <li><code class=\"highlighter-rouge\">Sitemap.sitemaps_host = 'http://s3.amazonaws.com/my-site/'</code> where we will\ndeploy sitemaps. User with <code class=\"highlighter-rouge\">Sitemap.adapter = </code>\n    <ul>\n      <li>Here <code class=\"highlighter-rouge\">include_index</code> (include\n<code class=\"highlighter-rouge\">&lt;url&gt;&lt;loc&gt;http://www.example.com/sitemap.xml.gz&lt;/loc&gt;&lt;/url&gt;</code>) be off since\n<code class=\"highlighter-rouge\">sitemaps_host</code> is different than <code class=\"highlighter-rouge\">default_host</code> and we can not have different\ndomains in same sitemap</li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">Sitemap.public_path</code> directory used to write localy before eventual upload\n (default is ‘public/’).</li>\n  <li><code class=\"highlighter-rouge\">Sitemap.sitemaps_path = 'my-folder/'</code> is relative folder where to store\nsitemaps, it will be used to determine url in index file.</li>\n</ul>\n\n<p>Options for\n<a href=\"https://github.com/kjvarga/sitemap_generator#supported-options-to-add\">add</a>\nbase on <a href=\"http://www.sitemaps.org/protocol.html#xmlTagDefinitions\">Sitemaps.org\nprotocol</a> are:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">changefreq</code> default is <code class=\"highlighter-rouge\">weekly</code></li>\n  <li><code class=\"highlighter-rouge\">lastmod</code> default is <code class=\"highlighter-rouge\">Time.now</code></li>\n  <li><code class=\"highlighter-rouge\">priority</code> default is <code class=\"highlighter-rouge\">0.5</code></li>\n  <li><code class=\"highlighter-rouge\">expires</code> request removal <code class=\"highlighter-rouge\">expires: Time.now + 1.day</code></li>\n</ul>\n\n<p>You can add some existing sitemaps with <code class=\"highlighter-rouge\">add_to_index '/my-old-sitemap.xml.gz'</code></p>\n\n<h2 id=\"heroku\">Heroku</h2>\n\n<p>For heroku you need to move it on\n<a href=\"https://github.com/kjvarga/sitemap_generator/wiki/Generate-Sitemaps-on-read-only-filesystems-like-Heroku#configure-carrierwave\">S3</a>.\nIt is straighforward configuration, AWS S3 does not need to be public.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>SitemapGenerator::Sitemap.sitemaps_host = \"http://\"\\\n \"#{Rails.application.secrets.aws_bucket_name}\"\\\n \".s3.amazonaws.com/\"\nSitemapGenerator::Sitemap.sitemaps_path = 'my-sitemaps/'\nSitemapGenerator::Sitemap.adapter = SitemapGenerator::S3Adapter.new(\n  fog_provider: 'AWS',\n  aws_access_key_id: Rails.application.secrets.aws_access_key_id,\n  aws_secret_access_key: Rails.application.secrets.aws_secret_access_key,\n  fog_directory: Rails.application.secrets.aws_bucket_name,\n)\n</code></pre></div></div>\n\n<p>If your bucket is not on <code class=\"highlighter-rouge\">us-east-1</code> region you need to add fog_region option to\nadapter</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  fog_region: Rails.application.secrets.aws_region\n</code></pre></div></div>\n\n<p>Than you need robots txt to point to that sitemap url (\n<code class=\"highlighter-rouge\">bucket-name</code>.s3.amazonaws.com/<code class=\"highlighter-rouge\">filename</code>)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># public/robots.txt\nSitemap: http://s3.amazonaws.com/my-site/my-folder/sitemap_index.xml.gz\n</code></pre></div></div>\n\n<p>Test with <code class=\"highlighter-rouge\">heroku run sitemap:refresh</code>.</p>\n\n<p>Also interesting tool to check validity of sitemap is\nhttps://www.websiteplanet.com/webtools/sitemap-validator/</p>\n\n<h2 id=\"webmaster-tools\">Webmaster tools</h2>\n\n<p>Check your sitemap on <a href=\"https://www.google.com/webmasters/tools/home?hl=en\">google\nwebmaster tools</a>.\nJust click <em>Add property</em> and and verify your domain.\n(For AWS S3 you need to enable website hosting).\nRefresh robots.txt to point on new sitemap location.</p>\n\n<p>From <a href=\"http://www.sitemaps.org/protocol.html#index\">sitemaps.org</a> you can see\nthat one sitemap should not have more than 50.000 links and uncompressed size\n10MB.\nUrl should be less than 2048 chars.</p>\n\n<p>You can use search to see current <a href=\"https://support.google.com/webmasters/answer/35256\">index\nstatus</a>\nJust type <code class=\"highlighter-rouge\">info:www.my-site.com</code> and you can find links there.\nOr you can add to https://www.google.rs/search?q=site:<code class=\"highlighter-rouge\">www.my-site.com</code></p>\n\n<ul>\n  <li>site: search only for this domain or even subdirectory. You can use this to\nsee if some page is indexed, just add uniq part of page url</li>\n  <li>link: find links for specific domain or subdirectory or pages (this is no\nlonger supported as of Jan 2017)</li>\n  <li>cache: see current archived copy of domain or page. It is better to use\n<a href=\"https://www.google.com/webmasters/tools/googlebot-fetch\">https://www.google.com/webmasters/tools/googlebot-fetch</a> since google crawler\ncan execute javascript. You can submit to index on the page, but even google\nrenders it properly (with ajax/angular data) it will not add to index for some\nother reasons.</li>\n</ul>\n\n<p>Some reasons could be\n<a href=\"https://moz.com/ugc/8-reasons-why-your-site-might-not-get-indexed\">post</a></p>\n\n<ul>\n  <li>server can not respond fast enough to all crawler requests, maybe it will\n  help to reoder sitemap</li>\n</ul>\n\n<p>All links in sitemap should return 200 (not redirection 3xx). Also you need to\ncheck <a href=\"https://support.google.com/webmasters/answer/2642366?hl=en\">this answer</a>\nfor duplicates (this is common for angular since data is fetched after page\nload), canonical url (this is common when you have search queries that return\nsame results).</p>\n\n<p>If you have more domains on same server than you need to iterate for each\n<code class=\"highlighter-rouge\">default_host</code> and to call <code class=\"highlighter-rouge\">SitemapGenerator::Sitemap.ping_search_engines</code>\n(since by default is to ping when whole sitemap process finishes, so than it\nwill ping only last one).</p>\n\n<h1 id=\"other-tools\">Other tools</h1>\n\n<p>Chrome plugins</p>\n\n<ul>\n  <li><a href=\"https://chrome.google.com/webstore/detail/browserstack-local/mfiddfehmfdojjfdpfngagldgaaafcfo?utm_source=chrome-app-launcher-info-dialog\">https://chrome.google.com/webstore/detail/browserstack-local/mfiddfehmfdojjfdpfngagldgaaafcfo?utm_source=chrome-app-launcher-info-dialog</a></li>\n  <li><a href=\"https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk?utm_source=chrome-app-launcher-info-dialog\">https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk?utm_source=chrome-app-launcher-info-dialog</a></li>\n</ul>\n\n<h1 id=\"schemaorg\">Schema.org</h1>\n\n<p>You can follow <a href=\"http://schema.org/docs/gs.html\">http://schema.org/docs/gs.html</a> to add microdata in your markup\nlike: <code class=\"highlighter-rouge\">&lt;div itemscope&gt;&lt;h1 itemprop=\"name\"&gt;Duke&lt;/h1&gt;&lt;/div&gt;</code></p>\n\n<p>You can add head tags for facebook <a href=\"http://ogp.me/\">open graph protocol</a>. In\nRails it will be like:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/ haml\n- content_for :head do\n  %meta{property: \"og:type\",        content: \"article\"}\n  %meta{property: \"og:title\",       content: \"MySite | #{@post.title}\"}\n  %meta{property: \"og:image\",       content: share_image_url(@post)}\n  %meta{property: \"og:description\", content: @post.description}\n  %meta{property: \"og:url\",         content: post_url(@post.id)}\n  %meta{property: \"og:site_name\",   content: \"MySite\"}\n  %meta{name: \"twitter:card\",       content: \"photo\"}\n  %meta{name: \"twitter:site\",       content:\"@mysite\"}\n  %meta{name: \"twitter:title\",      content: \"MySite | #{@post.title}\"}\n  %meta{name: \"twitter:image\",      content: share_image_url(@post)}\n  %meta{name: \"twitter:url\",        content: post_url(@post.id)}\n</code></pre></div></div>\n\n<h1 id=\"addwords\">Addwords</h1>\n\n<p>You can enable <code class=\"highlighter-rouge\">Destination URL Auto-tagging. Automatically tag my ad\ndestination URLs</code> in Account Settings -&gt; Preferences</p>\n\n<h1 id=\"user-mailing-list\">User mailing list</h1>\n\n<p>If someone is linking your site or your competitor site, you can email the site\nowner (need a script that will search for email address on that site) saying\nthat you have some new content, video or other material that will be interesting\nfor his audience.</p>\n\n<h1 id=\"customer-analitics\">Customer Analitics</h1>\n\n<p>You can use some of the services: Google Analytics, Firebase anal, Amazon anal,\nFabric Answers, Mixpanel, Keen, Segment, Amplitude, Localytics, Ionic Analytics</p>\n\n<p>Go to https://analytics.google.com and on left sidebar click Admin to add\nproperty and get UA code.</p>\n\n<h1 id=\"seo-search-enginge-optimization\">SEO search enginge optimization</h1>\n\n<p>hangouts tutorials <a href=\"https://plus.google.com/collection/oSHR9\">https://plus.google.com/collection/oSHR9</a></p>\n\n<ul>\n  <li>subdomain is not bad for rank, since google can treat as two different sites</li>\n</ul>\n<p><a href=\"https://www.youtube.com/watch?v=onNwqFa-e_s#t=2904\">https://www.youtube.com/watch?v=onNwqFa-e_s#t=2904</a></p>\n<ul>\n  <li>url is most important and should point to single state (not multiple states).\nAfter hash <code class=\"highlighter-rouge\">#</code> usually everythings is ignored so that should not be a router for\nyour app. Do not use secret stuff in url like <code class=\"highlighter-rouge\">/session=1234/...?user=john</code></li>\n  <li>canonical url is the main key for this content, and can be defined using link\nrel canonical, redirects, sitemaps</li>\n  <li>imporant content that needs to be indexed should be on visible part of the\npage, not on ajax call since crawl will be able to index that</li>\n</ul>\n\n<p>TODO\nhttps://www.youtube.com/watch?v=Afy7H04X9Us</p>\n"
    } ,
  
    {
      "title"    : "Rails Testing",
      "category" : "",
      "tags"     : "",
      "url"      : "/2015/11/09/rails-testing/",
      "date"     : "2015-11-09 00:00:00 +0100",
      "content"  : "<p>Usually we start with integration test, than we go in details for frontend\ncontroller (Angular), than backend controller, than model … all to make\nsure integration (feature) test pass.\nYou should follow <a href=\"https://github.com/thoughtbot/guides/tree/master/style/testing\">style guide for\ntesting</a> and\nread some <a href=\"https://github.com/thoughtbot/guides/tree/master/best-practices\">best\npractices</a>.</p>\n\n<p>Integration tests usually test only hapy path. All possible edge cases should be\nunit tested. External api should be stubbed and repeatable.</p>\n\n<p>Integration tests are generic name for any test than combine more than one unit\ntests and are often black-box tests, end-to-end, what user see.\nAcceptance testing is subset of integration testing and test that behavior is\ncorrect from customer perspective.\nThere should not be ruby code except setup data or find specific item that we\nneed to check if it exists on page. We should use only capybara finders and\nmatchers since we can’t see <code class=\"highlighter-rouge\">request</code> object.\nIntegration test should not cover special error cases, when data is nil or\nimplementation details.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Given [role and state]\nWhen [an event occurs]\nThen [the benefit]\n\nAs a instructor\nI want to be able to sign in/sign/out/reset my password\n\n- Standard password reset via email\n- Login via social buttons\n\nor AAA:\nArange - set data - SETUP\nAct - run code - EXERCISE\nAssert - verify that code did what is expected - VERIFICATION\nTeardown - eventual TEARDOWN\n# note that multiple assets is OK only if they are related\n</code></pre></div></div>\n\n<h1 id=\"setup-test-env\">Setup test env</h1>\n\n<p>You need to setup db with a command</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bin/rails db:environment:set RAILS_ENV=test\n</code></pre></div></div>\n\n<p>or use <code class=\"highlighter-rouge\">rake db:test:prepare</code>. I was trying to do <code class=\"highlighter-rouge\">RAILS_ENV=test rake db:drop\ndb:create db:migrate</code> but it did not work because of some missing tables.</p>\n\n<p>Capybara javascript test also rely on precompiled assets so you need to run\n<code class=\"highlighter-rouge\">rake assets:precompile</code> or put <code class=\"highlighter-rouge\">config.assets.compile = true</code> in\n<code class=\"highlighter-rouge\">conig/environments/test.rb</code> (this could slow down).\nSomehow when running with headless driver than I do not need to precompile\nassets for those js tests (this is when I run <code class=\"highlighter-rouge\">rake</code>).\nBut when I run single test <code class=\"highlighter-rouge\">rspec ./spec/features/my_spec.rb</code> I need to <code class=\"highlighter-rouge\">rm -rf\npublic/assets</code> (do not know how they appear here) and also <code class=\"highlighter-rouge\">spring stop</code> so than\nit will use fresh code (not precompiled)</p>\n\n<h1 id=\"rspec\">Rspec</h1>\n\n<h2 id=\"vanilla-rspec\">Vanilla rspec</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rspec --init\n</code></pre></div></div>\n\n<p>This will generate <code class=\"highlighter-rouge\">spec/spec_helper.rb</code> and <code class=\"highlighter-rouge\">.rspec</code> (option <code class=\"highlighter-rouge\">--require\nspec_helper</code> will automatically load spec_helper so you do not need to write\n<code class=\"highlighter-rouge\">require \"spec_helper\"</code>). Also rspec will add <code class=\"highlighter-rouge\">spec/</code> folder to <code class=\"highlighter-rouge\">$LOAD_PATH</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/simple_test_spec.rb\nRSpec.describe \"simplest test\" do\n  it \"can check equality\" do\n    expect(2).to eq(1+1)\n  end\nend\n</code></pre></div></div>\n\n<p>You can run simple test example with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rspec spec/simple_test_spec.rb\nrspec -b # to show full backtrace in case of exceptions\n</code></pre></div></div>\n\n<p>When you want to stop on first failed test (and not to wait whole test suite to\nfinish) you can use</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rspec spec --fail-fast\n</code></pre></div></div>\n\n<p>Rspec examples are written using <code class=\"highlighter-rouge\">describe</code> (ExampleGroup, you can nest multuple\ndescribe blocks), <code class=\"highlighter-rouge\">let</code> statements and <code class=\"highlighter-rouge\">it</code> blocks (Example). If you need to\nassert count you can use <code class=\"highlighter-rouge\">before {}</code> (it is <code class=\"highlighter-rouge\">before(:example)</code> and is run after\n<code class=\"highlighter-rouge\">let</code> statemets) to instantinize all let objects since there are lazy (or you\ncan use <code class=\"highlighter-rouge\">let!</code>).\nAlso you can use <code class=\"highlighter-rouge\">before(:context) { Location.delete_all}</code> (this is run before\n<code class=\"highlighter-rouge\">let</code> statements) to remove any test data, for example if you have fixtures,\nthey will be loaded for every example.\n<a href=\"https://github.com/thoughtbot/guides/blob/master/style/testing/avoid_let_spec.rb\">thoughtbot</a>\ndo not suggest using let, but to extract methods.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/location_spec.rb\nrequire \"location\"\ndescribe Location do\n  let(:latitude) { 123 }\n  let(:longitude) { 321 }\n  let(:location) { Location.new latitude: latitude, longitude: longitude }\n  before do\n    # initiate lazy let when we need to assert count\n    [location]\n  end\n  subject { location }\n  describe \"#initialize\" do\n    it { should have_attributes latitude: latitude }\n    it { should have_attributes longitude: longitude }\n  end\n  describe \"#near\" do\n    context \"for near location\" do\n      let(:near_location) do\n        Location.new(latitude: latitude + 1, longitude: longitude + 1)\n      end\n      it { should be_near(near_location, 2) }\n    end\n    context \"for not near location\" do\n      let(:not_near_location) { Location.new latitude: 1, longitude: 2 }\n      it { should_not be_near(not_near_location, 2) }\n    end\n    it \"raise exception for negative radius\" do\n      expect { location.near?(location, -1) }.to raise_error ArgumentError\n    end\n  end\nend\n</code></pre></div></div>\n\n<p><a href=\"http://www.relishapp.com/rspec/rspec-core/docs\">rspec-core</a> and <a href=\"https://github.com/reachlocal/rspec-style-guide\">style\nguide</a></p>\n<ul>\n  <li>example groups <code class=\"highlighter-rouge\">describe \"...\" do</code> or <code class=\"highlighter-rouge\">context \"...\" do</code>.\nDescribe use hash <code class=\"highlighter-rouge\">#method_name</code> and dot <code class=\"highlighter-rouge\">.class_method_name</code>\nContext is alias for describe, but it is used to group examples with same state\n(for example <code class=\"highlighter-rouge\">context 'when not logged in</code> or <code class=\"highlighter-rouge\">context 'when resource is not\nfound'</code>). Context description always start with <code class=\"highlighter-rouge\">when</code> and always have a oposite\ncontext.</li>\n  <li>example is <code class=\"highlighter-rouge\">it \"...\" do</code>. <code class=\"highlighter-rouge\">it</code> description should not end with conditional\nlike this bad example: <code class=\"highlighter-rouge\">it 'returns name if it is present'</code> (better <code class=\"highlighter-rouge\">context\n'when name is present' it 'returns name'</code>)</li>\n  <li>Example group is a class in which <code class=\"highlighter-rouge\">describe</code> or <code class=\"highlighter-rouge\">context</code> is evaluated, and\n<code class=\"highlighter-rouge\">it</code> is evaluated on instance of that class</li>\n  <li><a href=\"http://www.relishapp.com/rspec/rspec-core/v/3-5/docs/subject/explicit-subject\">subject</a>\nis used in group scope (<code class=\"highlighter-rouge\">describe</code>) to define value that is returned by\n<code class=\"highlighter-rouge\">subject</code> method in example (<code class=\"highlighter-rouge\">it</code>) scope.</li>\n  <li><a href=\"http://www.relishapp.com/rspec/rspec-core/v/3-5/docs/subject/one-liner-syntax\">one liner it\nsyntax</a>\nInstead of <code class=\"highlighter-rouge\">it { expect(subject).to be_empty }</code> you can use\n<code class=\"highlighter-rouge\">it { is_expected.to be_empty }</code> or <code class=\"highlighter-rouge\">it { should be_empty }</code> (deprecated). If\nyou need to access properties of an object for one liner syntax, than use <code class=\"highlighter-rouge\">it\n{ is_expected.to have_attribute :name }</code>. So do not use <code class=\"highlighter-rouge\">subject</code> inside <code class=\"highlighter-rouge\">it</code>\nblock.</li>\n  <li><a href=\"http://www.relishapp.com/rspec/rspec-core/v/3-5/docs/helper-methods/let-and-let\">let</a>\nis used to memoize value so it is shared inside one example, but not between\nexamples</li>\n  <li><a href=\"http://www.relishapp.com/rspec/rspec-core/v/3-5/docs/hooks/before-and-after-hooks\">before</a>\nand after hooks are used to execute arbitrary code before and after\nexample or context is run. You can use alias <code class=\"highlighter-rouge\">before(:each)</code> is the same as\n<code class=\"highlighter-rouge\">before(:example)</code> and <code class=\"highlighter-rouge\">before(:all) == before(:context)</code></li>\n</ul>\n\n<p>DRY is accomplished with <code class=\"highlighter-rouge\">shared_context</code> (and <code class=\"highlighter-rouge\">shared_examples</code>) so you can\nshare contex so do not need to repeat let and before.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.describe User do\n  shared_context 'one_user' do\n    let(:user) { create :user }\n  end\n\n  describe do\n    include_context 'one_user'\n  end\nend\n</code></pre></div></div>\n\n<p>Testing included modules and concerns is done with\n<a href=\"https://www.relishapp.com/rspec/rspec-core/docs/example-groups/shared-examples\">shared_examples</a>\nso we test with <code class=\"highlighter-rouge\">it_behaves_like \"linkable\"</code> or <code class=\"highlighter-rouge\">include_examples 'linkable'</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.shared_examples 'payment check_no' do\n  it 'allows long check_no' do\n    check_no = '356431 575017004 201705 11'\n    customer_payment = create :customer_payment, check_no: check_no\n    expect(customer_payment.new_record?).to be_falsy\n  end\nend\n\nRSpec.describe CustomerPayment do\n  describe 'validations' do\n    it_behaves_like 'payment check_no'\n  end\nend\n</code></pre></div></div>\n\n<p>Also valid factory can be shared between tests</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spe/models/user_spec.rb\nRSpec.describe User do\n  it_behaves_like 'has_valid_factory'\nend\n\n# spec/support/factory_bot.rb\nRSpec.shared_examples 'has_valid_factory' do\n  it 'has a valid factory' do\n    expect(create(described_class.name.underscore)).to be_valid\n  end\nend\nRSpec.configure do |config|\n  config.include FactoryBot::Syntax::Methods\nend\n</code></pre></div></div>\n\n<p>Some <a href=\"http://www.relishapp.com/rspec/rspec-expectations/docs\">rspec\nexpectations</a> built in\nmatchers</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">expect(object).to be(expected)</code>, <code class=\"highlighter-rouge\">expect(object).to be &gt;\n3</code>, <code class=\"highlighter-rouge\">expect(object).to eq(expected)</code>…\n    <ul>\n      <li><code class=\"highlighter-rouge\">be</code> is object identity <code class=\"highlighter-rouge\">a.equal? b</code> (refer to the same object)</li>\n      <li><code class=\"highlighter-rouge\">eq</code> is object equivalence with type conversion <code class=\"highlighter-rouge\">a == b</code> (same value)</li>\n    </ul>\n  </li>\n  <li><a href=\"http://www.relishapp.com/rspec/rspec-expectations/docs\">predicate\nmatchers</a> for any\nmethod that begin with <code class=\"highlighter-rouge\">has_</code> or ends with <code class=\"highlighter-rouge\">?</code> you can use <code class=\"highlighter-rouge\">have_</code> and <code class=\"highlighter-rouge\">be_</code>\n<code class=\"highlighter-rouge\">expect(object).not_to be_empty</code> or <code class=\"highlighter-rouge\">be_near near_location</code></li>\n  <li>\n    <p><a href=\"https://relishapp.com/rspec/rspec-expectations/v/3-7/docs/built-in-matchers/type-matchers\">type\nmatchers</a>\n<code class=\"highlighter-rouge\">expect(obj).to be_kind_of(Type)</code> or <code class=\"highlighter-rouge\">be_a</code> type of Type</p>\n  </li>\n  <li>\n    <p><code class=\"highlighter-rouge\">expect { do_something }.to change { object.attribute }</code>.\nYou can also specify values <code class=\"highlighter-rouge\">expect {}.to change\n{session[:me]}.from(nil).to(\"dule\")</code>\nIt is also possible to detect changes in two tables\n<a href=\"http://www.relishapp.com/rspec/rspec-expectations/v/3-5/docs/built-in-matchers/change-matcher\">http://www.relishapp.com/rspec/rspec-expectations/v/3-5/docs/built-in-matchers/change-matcher</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>it \"should increment the counters\" do\n  expect { Foo.bar }.to change { Counter.count }.by(1).and \\\n                        change { AnotherCounter.count }.by(1)\nend\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">expect(object).to have_attributes name: 'duke'</code>\n<a href=\"https://www.relishapp.com/rspec/rspec-expectations/docs/built-in-matchers/have-attributes-matcher#basic-usage\">have_attributes</a> to check values</li>\n  <li><code class=\"highlighter-rouge\">expect(object).to have_attribute :name</code> to check just attribute (no value)</li>\n  <li><code class=\"highlighter-rouge\">expect { do_something }.to raise_error ArgumentError</code></li>\n  <li><code class=\"highlighter-rouge\">expect(object).to match /expression/</code></li>\n  <li><code class=\"highlighter-rouge\">expect(object).to be_a(Class)</code></li>\n  <li><code class=\"highlighter-rouge\">expect(object).to satisfy { block }</code></li>\n</ul>\n\n<p>You can use <code class=\"highlighter-rouge\">not_to</code> for all matchers (expect raise_error).</p>\n\n<p>Instead of multiple <code class=\"highlighter-rouge\">expect</code> statements inside <code class=\"highlighter-rouge\">it</code>, you could change it to\n<code class=\"highlighter-rouge\">describe</code> and use inline <code class=\"highlighter-rouge\">it</code> statements (pros: all assertions will be checked,\ncons: it could be slower because of setup and dificult to read to know how test\nwas setup). Another solution is to use compound matchers.\nAll matchers have alternate form (an_object_having…) so it reads better when\nusing compose (or compound) matchers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>expect(a[0]).to eq(5)\nexpect(a[1]).to eq(6)\n# is the same as\nexpect(a).to match([an_object_eq_to(5), an_object_eq_to(6)])\n\n# or\n\ndescribe \"build three tasks\" do\n  let(:tasks_string) { \"My Task:2\\nYour Task:3\\nHis Task:1\\n\" }\n  it do\n    expect(tasks.map(&amp;:title)).to eq(['My Task', 'Your Task', 'His Task'])\n  end\n  it { expect(tasks.map(&amp;:size)).to eq([2, 3, 1]) }\nend\n# is the same as\ndescribe \"build three tasks\" do\n  let(:tasks_string) { \"My Task:2\\nYour Task:3\\nHis Task:1\\n\" }\n  it do\n    expect(tasks).to match(\n      [an_object_having_attributes(title: 'My Task', size: 2),\n       an_object_having_attributes(title: 'Your Task', size: 3),\n       an_object_having_attributes(title: 'His Task', size: 1)]\n    )\n  end\nend\n</code></pre></div></div>\n\n<p>You can use <code class=\"highlighter-rouge\">.or</code> and <code class=\"highlighter-rouge\">.and</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>expect(a).to include(\"a\").and match(/.*1.*/)\n</code></pre></div></div>\n\n<p><a href=\"http://www.rubydoc.info/github/rspec/rspec-expectations/RSpec/Matchers\">rubydoc\nmatchers</a></p>\n\n<p>For pending tests, you can write empty it blocks or just add <code class=\"highlighter-rouge\">skip</code> or prefix\n<code class=\"highlighter-rouge\">x</code> like <code class=\"highlighter-rouge\">xit</code> or <code class=\"highlighter-rouge\">xdescribe</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>it '...', :skip do\nend\n\nit \"...\" do\n  skip \"pending\"\nend\n\nxit \"skipped\" do\nend\n</code></pre></div></div>\n\n<p>For slow test you can mark with <code class=\"highlighter-rouge\">:really_slow</code> and exclude specific tags with\n<code class=\"highlighter-rouge\">rspec --tag ~really_slow</code>. Or you can add to add to <code class=\"highlighter-rouge\">spec/spec_helper.rs</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/spec_helper.rb\nRSpec.configure do |config|\n  config.filter_run_excluding(really_slow: true)\nend\n</code></pre></div></div>\n\n<p>Note that if you run specific line <code class=\"highlighter-rouge\">bin/rspec spec/features/my_spec.rb:10</code> than\nit will not be excluded. Only if you run all or speficic file <code class=\"highlighter-rouge\">bin/rspec\nspec/features/my_spec.rb</code></p>\n\n<p>If you want to run specific task then than add tag <code class=\"highlighter-rouge\">rspec --tag really_slow</code>. If you\nwant to run all and specific tasks than use env variable:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/spec_helper.rb\nRSpec.configure do |config|\n  # If you really want to run then than add tag `bin/rspec --tag really_slow` to run\n  # only that tag, or to run all and some tags use\n  # INCLUDING_TAGS=chrome_remote_selenium bin/rspec\n  %i(\n    really_slow chrome_remote_selenium\n    headless_chrome_remote_selenium edit_hosts\n  ).each do |tag|\n    config.filter_run_excluding(tag) unless ENV['INCLUDING_TAGS'].to_s.include? tag.to_s\n  end\nend\n</code></pre></div></div>\n\n<p>You can exclude specific folder\n<a href=\"https://relishapp.com/rspec/rspec-core/v/3-3/docs/configuration/exclude-pattern\">https://relishapp.com/rspec/rspec-core/v/3-3/docs/configuration/exclude-pattern</a>\n<code class=\"highlighter-rouge\">rspec --exclude-pattern \"spec/features/*\"</code> I do not know why quotes are needed\nhere, but it works only with quotes.</p>\n\n<p><code class=\"highlighter-rouge\">rspec --profile</code> will give you list of 10 slowest tests.</p>\n\n<p>Rspec config before each example for particular group</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/rails_helper.rb\nRSpec.configure do |config|\n  config.before :each do\n    DatabaseCleaner.start\n  end\n  config.before :each, type: lambda {|v| v != :feature } do\n    allow_any_instance_of(Paperclip::Attachment).to receive(:save).and_return(true)\n  end\n  config.include Warden::Test::Helper, type: :features\nend\n</code></pre></div></div>\n\n<p>Better is you include <code class=\"highlighter-rouge\">config.before</code> only for specific tests using filter\nsymbols\nhttps://relishapp.com/rspec/rspec-core/v/3-6/docs/hooks/filters#filtering-hooks-using-symbols</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.configure do |config|\n  config.before :example, :setup_xxx do\n    xxx\n  end\nend\nRSpec.describe 'invoke xxx', :setup_xxx do\n  it 'in all nested examples' do\n  end\nend\n</code></pre></div></div>\n\n<p>Change capybara driver for specific tests</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.configure do |config|\n  config.before(:each, remote_selenium: true) do\n    Capybara.current_driver  = :remote_selenium\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"rspec-rails\">Rspec rails</h2>\n\n<p>To install you need to add <a href=\"https://github.com/rspec/rspec-rails\">rspec-rails</a>\ngem and generate <code class=\"highlighter-rouge\">.rspec</code>, <code class=\"highlighter-rouge\">rails_helper.rb</code> and <code class=\"highlighter-rouge\">spec_helper.rb</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development, :test do/a  \\\n  gem \"rspec-rails\"'\nbundle\nrails generate rspec:install\n# you should stub everything rails related so you do not need to load it\n# echo \"--require rails_helper\" &gt;&gt; .rspec\n# enable experimental settings, note config.profile_examples = 10 is too noisy\n# sed -i spec/spec_helper.rb -e '/=begin/d'\n# sed -i spec/spec_helper.rb -e '/=end/d'\ngit add . &amp;&amp; git commit -m \"rails generate rspec:install\"\n</code></pre></div></div>\n\n<p>You should write <code class=\"highlighter-rouge\">require \"rails_helper\"</code> at the begging of each spec, or you\ncan add option to <code class=\"highlighter-rouge\">.rspec</code> (this is perfomance penalty since some tests does not\nrequire rails can perform faster without this option).\nOnce you put gem in gemfile inside development group, rspec generators will be\navailable: <code class=\"highlighter-rouge\">rails g model posts</code> will generate rspec instead of minitest.\nAlso there are generators like <code class=\"highlighter-rouge\">rails g integration_test</code> and rspec will\ngenerate <code class=\"highlighter-rouge\">spec/requests/password_resets_spec.rb</code></p>\n\n<p>Write test file that ends <code class=\"highlighter-rouge\">_spec.rb</code> in particular folders (so it inherits type\n).</p>\n\n<h1 id=\"guard\">Guard</h1>\n\n<p>You can also use guard, just add to development group</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development do/a  \\\n  gem \"guard-rspec\"'\nbundle\nguard init rspec\ngit add . &amp;&amp; git commit -m \"Adding guard init rspec\"\n</code></pre></div></div>\n\n<p>You can run <code class=\"highlighter-rouge\">guard</code> that will run your specs.</p>\n\n<p>More options for\n<a href=\"https://github.com/guard/guard-rspec#list-of-available-options\">guard</a>\nMy favorite is <code class=\"highlighter-rouge\">failed_mode: :focus</code> which reruns last failed test.\nAlso you can use <a href=\"https://github.com/jonleighton/spring-commands-rspec\">spring for\nrspec</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development do/a  \\\n  gem \"spring-commands-rspec\"'\nbundle\nbundle exec spring binstub rspec\n</code></pre></div></div>\n\n<p>Now you can run tests with <code class=\"highlighter-rouge\">bin/rspec</code> which will be faster than <code class=\"highlighter-rouge\">rspec</code>. If you\nare using guard, use this line</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Guardfile\nguard :rspec, cmd: \"bundle exec bin/rspec\", failed_mode: :focus do\nend\n</code></pre></div></div>\n\n<h2 id=\"shoulda-matchers\">Shoulda matchers</h2>\n\n<p>You can use <a href=\"https://github.com/thoughtbot/shoulda-matchers\">shoulda matchers</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development, :test do/a  \\\n  gem \"shoulda-matchers\", \"~&gt; 3.1\"'\nbundle\ncat &gt;&gt; spec/rails_helper.rb &lt;&lt; HERE_DOC\nShoulda::Matchers.configure do |config|\n  config.integrate do |with|\n    with.test_framework :rspec\n    with.library :rails\n  end\nend\nHERE_DOC\nbundle\ngit add . &amp;&amp; git commit -m \"Adding shoulda matchers\"\n</code></pre></div></div>\n\n<h2 id=\"rspec-controller-specs\">RSpec Controller specs</h2>\n\n<p><a href=\"https://www.relishapp.com/rspec/rspec-rails/docs/controller-specs\">controller\nspecs</a> can\nuse <code class=\"highlighter-rouge\">get</code>,<code class=\"highlighter-rouge\">post</code> and validate <code class=\"highlighter-rouge\">response</code> (to <code class=\"highlighter-rouge\">render_template :new</code>, to\n<code class=\"highlighter-rouge\">redirect_to posts_path</code>).\nTesting <code class=\"highlighter-rouge\">assings</code> and <code class=\"highlighter-rouge\">render_template</code> is deprecated.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>subject { get \"/posts\" }\nexpect(subject).to render_template(:index)\nexpect(assigns(:posts)).to be([post])\n</code></pre></div></div>\n\n<blockquote>\n  <p>assigns has been extracted to a gem. To continue using it, add <code class=\"highlighter-rouge\">gem\n 'rails-controller-testing'</code> to your Gemfile.</p>\n</blockquote>\n\n<p>Move all business logic and ActiveRecord calls out from controller and test only\ntriggers to services or model methods (using mocks) and check responses. Testing\nroutes is done separately.</p>\n\n<p>Controller spec should be for each method (CRUD) in context of authorized and in\ncontext of unauthorized user (testing security), and for valid and some invalid\nrequests.</p>\n\n<p><code class=\"highlighter-rouge\">get</code>, <code class=\"highlighter-rouge\">delete</code>, <code class=\"highlighter-rouge\">head</code>, <code class=\"highlighter-rouge\">patch</code>, <code class=\"highlighter-rouge\">post</code> and <code class=\"highlighter-rouge\">put</code> takes 4 params, usually used\nonly first two. Third is session (used only if you have some multistep process\nthat use session for continuity) and fourth is flash param (not used in\ncontroller test).\n(in <code class=\"highlighter-rouge\">ActionController::TestCase</code> you can use <code class=\"highlighter-rouge\">session:</code> keyword arg like <code class=\"highlighter-rouge\">get\n:show, params:{ id: 3}, session: { 'user_id': 3}</code>, but in\n<code class=\"highlighter-rouge\">ActionDispatch::IntegrationTest</code> you can not set session (no <code class=\"highlighter-rouge\">@session</code>))\nSimilar <code class=\"highlighter-rouge\">xhr</code> (for testing ajax) takes three arguments.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>get :show, params: { id: @task.id }\npost :create, logo: fixture_file_upload('/test/data/logo.png', 'image/png')\nxhr :post, :create, params: { id: \"3\" }\n</code></pre></div></div>\n\n<p>In controller test you have access to <code class=\"highlighter-rouge\">@request</code>, <code class=\"highlighter-rouge\">@controller</code> and <code class=\"highlighter-rouge\">@response</code>\nYou can validate <code class=\"highlighter-rouge\">response.status</code> or <code class=\"highlighter-rouge\">expect(response).to\nhave_http_status(:success)</code> matcher.  You can use <code class=\"highlighter-rouge\">:success</code>, <code class=\"highlighter-rouge\">:redirect</code>,\n<code class=\"highlighter-rouge\">:missing</code>, <code class=\"highlighter-rouge\">:error</code>.</p>\n\n<p>To set a <a href=\"https://stackoverflow.com/a/29037481\">host name</a></p>\n<ul>\n  <li><code class=\"highlighter-rouge\">host! \"my.awesome.host\"</code> for integration test <a href=\"http://guides.rubyonrails.org/testing.html#helpers-available-for-integration-tests\">available\nhelpers</a></li>\n  <li>in controller specs use <code class=\"highlighter-rouge\">@request.host = 'my.awesome.host'</code>\n(<code class=\"highlighter-rouge\">ActionController::TestCase</code>)</li>\n  <li>In view specs use <code class=\"highlighter-rouge\">controller.request.host = \"my.awesome.host\"</code></li>\n  <li>In capybara use <code class=\"highlighter-rouge\">Capybara.default_host = \"http://my.awesome.host\"</code>,</li>\n</ul>\n\n<p>When you need to create params to for testing, you can use\n<code class=\"highlighter-rouge\">ActionController::Parameters.new name: 'Duke'</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/controllers/users_controller_spec.rb\nRSpec.describe UsersController do\n  describe 'new' do\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"rspec-request-specs\">Rspec Request specs</h2>\n\n<p><a href=\"https://www.relishapp.com/rspec/rspec-rails/docs/request-specs/request-spec\">requests spec</a>\nare used for full stack testing without stubbing.\nIt is faster than system but can not use capybara…\nUsually for oauth (doorkeeper gem).\nIf request is not performed (<code class=\"highlighter-rouge\">get</code> <code class=\"highlighter-rouge\">xhr</code>) than something is different (current\nuser is not initialized, or something).\n<code class=\"highlighter-rouge\">post url, name: 'my name'</code> is used without <code class=\"highlighter-rouge\">params</code> key\nTo set headers you can use third param</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  get login_path, nil, { 'Authentication' =&gt; 'MyToken' }\n\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/requests/oauth_password_flow_spec.rb\nRSpec.describe \"OAUTH\" do\n  let :email_address do\n    \"test@email.com\"\n  end\n  let :password do\n    \"asdfasdf\"\n  end\n  let! :user do\n    FactoryBot.create :user, email_address: email_address, password: password\n  end\n\n  it \"creates a token when credentials are valid\" do\n    # https://aaronparecki.com/oauth-2-simplified/#password\n    post \"/oauth/token\", params: {\n      grant_type: \"password\",\n      username: email_address,\n      password: password\n    }\n    expect(response.status).to eq 200\n    expect(JSON.parse(response.body)[\"access_token\"]).not_to be_nil\n  end\n\n  it \"does not issue token when credentials are invalid\" do\n    post \"/oauth/token\", params: {\n      grant_type: \"password\",\n      username: email_address,\n      password: \"wrong_password\"\n    }\n    expect(response.status).to eq 401\n    expect(JSON.parse(response.body)[\"access_token\"]).to be_nil\n  end\n\n  it 'redirect' do\n    post '/'\n    expect(response).to redirect_to error_path\n    follow_redirect!\n  end\nend\n\nexpect(response.body).to include 'Logout'\n# use html encoding when you have quote, so you do not need to match &amp;#39;\nexpect(response.body).to include ERB::Util.html_escape \"Some text with ' quote\"\nexpect(response.body.scan(/&lt;tr&gt;/).size).to be 3\nexpect(response.body).to match /button.*Publish Package.*\\/button/\n# for multiline math response.body text you can use modifier m\nexpect(response.body).to match /dl.*dl/m\n</code></pre></div></div>\n\n<p>Sometimes I get error if you use <code class=\"highlighter-rouge\">sign_in user</code> but do not perform <code class=\"highlighter-rouge\">get</code> or\n<code class=\"highlighter-rouge\">post</code> requests, ie you use empty <code class=\"highlighter-rouge\">it 'bla bla' do;end</code>. Than it pass when\nspecific tests are run, but fail when all test from file are run.</p>\n\n<h2 id=\"rspec-router-specs\">RSpec Router specs</h2>\n\n<p><a href=\"https://www.relishapp.com/rspec/rspec-rails/v/3-5/docs/routing-specs\">router\nspecs</a> is\nnot so usefull, so you should write only for some the you do not want to exists\nor when you have some extra logic in routing.</p>\n\n<p>Usefull matchers are <code class=\"highlighter-rouge\">route_to</code> and <code class=\"highlighter-rouge\">be_routable</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/routing/project_routing_spec.rb\nrequire 'rails_helper'\nRSpec.describe 'project routing', type: :routing do\n  it 'routes projects' do\n    expect(get: '/projects/1/edit/').to route_to(\n      controller: 'project', action: 'edit', id: 'id')\n  end\n\n  it 'does not route by name' do\n    expect(get: '/projects/search/duke').not_to be_routable\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"rspec-helper-specs\">RSpec Helper specs</h2>\n\n<p>You have access to <code class=\"highlighter-rouge\">helper</code> object so you can call methods on it.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/helpers/project_helper_spec.rb\nrequire 'rails_helper'\nRSpec.describe ProjectsHelper do\n  let(:project) { Project.new name: 'Duke' }\n  it \"adds class if not finished\" do\n    allow(project).to receive(:on_schedule?).and_return(true)\n    actual = helper.name_with_status(project)\n    expect(actual).to have_selector('span.on_schedule', text: 'Duke')\n  end\nend\n\n# app/helpers/projects_helper.rb\nmodule ProjectsHelper\n  def name_with_status(project)\n    content_tag(:span, project.name, class: 'on_schedule')\n  end\nend\n</code></pre></div></div>\n\n<p>Helper tests does not go to views, so to test if it actually works write some\nview tests</p>\n\n<h2 id=\"rspec-view-specs\">RSpec View specs</h2>\n\n<p>You can set instance variables and call <code class=\"highlighter-rouge\">render</code> (which will render outermost\ndescribe block name or you can call <code class=\"highlighter-rouge\">render 'projects/index'</code> or <code class=\"highlighter-rouge\">render\npartial: 'projects/_form', locals: { admin: true }</code>).\nWe can stub helpers using view object like\n<code class=\"highlighter-rouge\">view.stub(:current_user).and_return(User.new)</code>\nOutput is available in <code class=\"highlighter-rouge\">rendered</code> object.\nWe can use capybara <code class=\"highlighter-rouge\">have_selector</code>, <code class=\"highlighter-rouge\">have_no_selector</code> instead of default\n<code class=\"highlighter-rouge\">match</code> rspec matcher.\nWe can use rails <code class=\"highlighter-rouge\">assert_select</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/views/projects/index.html.erb_spec.rb\nrequire 'rails_helper'\n\nRSpec.describe \"projects/index\" do\n  let(:on_schedule) { Project.create! name: 'Dule' }\n  it \"show on schedule\" do\n    @projects = [on_schedule]\n    render\n    expect(rendered).to have_selector(\n      \"#project_#{on_schedule.id} .on-schedule\",\n      text: on_schedule.name,\n      count: 1\n    )\n    assert_select \".on-schedule\", count: 1\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"rspec-presenters-specs\">RSpec Presenters specs</h2>\n\n<p>Bigger logic in view should be replaced with presenter. Ruby core\n<a href=\"https://ruby-doc.org/stdlib-2.1.1/libdoc/delegate/rdoc/SimpleDelegator.html\">SimpleDelegator</a>\ndelegates all messages to the object passed to the contructor.\nWe can use test doubles and instead of <code class=\"highlighter-rouge\">rails_helpers</code> use implicit\n<code class=\"highlighter-rouge\">spec_helper</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/presenters/project_presenter_spec.rb\nRSpec.describe ProjectPresenter do\n  let(:project) { Project.new name: 'My Name' }\n  let(:project_presenter) { ProjectPresenter.new project }\n\n  it \"show name with state\" do\n    expect(project_presenter.name_with_status).to eq(\"My Name on_schedule\")\n  end\nend\n\n# app/presenters/project_presenter.rb\nclass ProjectPresenter &lt; SimpleDelegator\n  def name_with_status\n    \"#{name} on_schedule\"\n  end\nend\n</code></pre></div></div>\n\n<p>There is <code class=\"highlighter-rouge\">draper</code> gem</p>\n\n<h2 id=\"rspec-mailer-specs\">RSpec Mailer specs</h2>\n\n<p>In controller we check if send mail is actually triggered and maybe just one\nline of content <code class=\"highlighter-rouge\">email.html_part.body.to_s</code> matches title</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/controllers/tasks_controller_spec.rb\nrequire 'rails_helper'\n\nRSpec.describe TasksController, type: :controller do\n  before { ActionMailer::Base.deliveries.clear }\n\n  describe \"PATCH incomplete update\" do\n    let(:task) { Task.create! title: \"Yo!\" }\n    it \"does not send email\" do\n      patch :update, id: task.id, task: { size: 3 }\n      expect(ActionMailer::Base.deliveries.size).to eq(0)\n    end\n  end\n\n  describe \"PATCH complete update\" do\n    let(:task) { Task.create! title: \"Yo!\" }\n    it \"does send email\" do\n      patch :update, id: task.id, task: { size: 3, completed: true }\n      expect(ActionMailer::Base.deliveries.size).to eq(1)\n      email = ActionMailer::Base.deliveries.first\n      expect(email.html_part.body.to_s).to match(\"Yo!\")\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>Full content we check in mailer spec</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/mailers/task_mailer.rb\nrequire \"rails_helper\"\n\nRSpec.describe TaskMailer, type: :mailer do\n  let(:task) { Task.new title: 'Yoo' }\n  describe \"task_completed_email\" do\n    let(:mail) { TaskMailer.task_completed_email(task) }\n\n    it \"renders the headers\" do\n      expect(mail.subject).to eq(\"Task completed email\")\n      expect(mail.to).to eq([\"to@example.org\"])\n      expect(mail.from).to eq([\"from@example.com\"])\n    end\n\n    it \"renders the body\" do\n      expect(mail.body.encoded).to match(\"Yoo\")\n    end\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"rspec-model-specs\">RSpec Model specs</h2>\n\n<p><a href=\"https://www.relishapp.com/rspec/rspec-rails/docs/model-specs\">model\nspecs</a> is a thin\nwrapper for <code class=\"highlighter-rouge\">ActiveSupport::TestCase</code>. Every example is in separate\n<a href=\"https://www.relishapp.com/rspec/rspec-rails/v/3-5/docs/model-specs/transactional-examples\">transaction</a>\nYou can use\n<a href=\"https://www.relishapp.com/rspec/rspec-rails/v/3-5/docs/model-specs/verified-doubles\">instance_double</a>\nIf not defined, <code class=\"highlighter-rouge\">subject</code> is an instance of the model.\nUsually have following parts: attributes, relationships, validations,\nhooks(callbacks), scopes and other methods.</p>\n\n<p><a href=\"https://gist.github.com/kyletcarlson/6234923\">model cheatsheet</a></p>\n\n<h3 id=\"attributes\">Attributes</h3>\n\n<p>It is good to write all column names at the top of the test so you can see what\nit is about</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/models/auction_spec.rb\nRSpec.describe Auction do\n  describe \"attributes\" do\n    %w[\n      user_id\n      ends_at\n      time_zone_id\n    ].each do |attribute|\n      it { is_expected.to have_attribute attribute }\n    end\n\n    # or in this one by one form. breakthrough is two. for three and more use\n    # above method\n\n    it { is_expected.to have_attribute :ends_at }\n    it { is_expected.to have_attribute :time_zone_id }\n  end\n</code></pre></div></div>\n\n<h3 id=\"relationships\">Relationships</h3>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  describe \"relationships\" do\n    it { is_expected.to have_many :auction_admins }\n    it { is_expected.to belong_to :user }\n  end\n</code></pre></div></div>\n\n<p>For belongs_to validations it is advised to validate object (<code class=\"highlighter-rouge\">user</code> not\n<code class=\"highlighter-rouge\">user_id</code>) so you can use <code class=\"highlighter-rouge\">build</code> strategy in factory bot.</p>\n\n<h3 id=\"validations\">Validations</h3>\n\n<p>You can install <a href=\"https://github.com/thoughtbot/shoulda-matchers\">shoulda\nmatchers</a> for simple inline\nvalidations:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n  gem 'shoulda-matchers', '~&gt; 3.1'\n\n# spec/rails_helper.rb\nrequire 'shoulda/matchers'\nShoulda::Matchers.configure do |config|\n  config.integrate do |with|\n    with.test_framework :rspec\n    with.library :rails\n  end\nend\n</code></pre></div></div>\n\n<p>You should check for presence for both not null and references fields, with\nsimple line:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  descibe 'validations' do\n    subject { build :sport } # we need to use factory bot since implicit subject is empty\n    it { is_expected.to validate_presence_of :name }\n    it { is_expected.to validate_uniqueness_of :name }\n  end\n</code></pre></div></div>\n\n<p>For complex validation you can test validation as simply <code class=\"highlighter-rouge\">l =\nLocation.new; expect(l).not_to be_valid</code> but it’s better to go into details of\nerrors message</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/models/location_spec.rb\nrequire \"rails_helper\"\nRSpec.describe Location do\n  describe \"validations\" do\n    before { subject.valid? }\n    context \"when latitude is missing\" do\n      subject { Location.new latitude: '' }\n      it \"should not allow blank latitude and longitude\" do\n        expect(subject.errors[:latitude]).to include \"can't be blank\"\n        expect(subject.errors[:longitude]).to include \"can't be blank\"\n      end\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>Validate uniqueness should be explicitly written (not shoulda matchers) with\ntwo objects: <code class=\"highlighter-rouge\">original</code> (that exists in db) and <code class=\"highlighter-rouge\">duplicate</code> that is going to be\nsaved</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  it \"validates uniqueness of user_id scoped to auction_id\" do\n    original = FactoryBot.create :auction_admin\n    duplicate = FactoryBot.build :auction_admin, user: original.user, auction: original.auction\n    duplicate.valid?\n    expect(duplicate.errors[:email]).to include \"has already been taken\"\n  end\n</code></pre></div></div>\n\n<p>It is advised to write test for valid factory (so you know that your factory\ncan be created)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  it \"has a valid factory\" do\n    expect(FactoryBot.create(:auction)).to be_persisted\n  end\n\n  # or more general\n\n  it 'has a valid factory' do\n    # expect(create(described_class.name.underscore)).to be_persisted\n    expect(build(described_class.name.underscore)).to be_valid\n  end\n</code></pre></div></div>\n\n<p>Test enum is with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  it \"has enum fulfillment_typs\" do\n    expect(described_class.fulfillment_types).to eq({\n      \"item\" =&gt; 0,\n      \"certificate\" =&gt; 1,\n    })\n  end\n</code></pre></div></div>\n\n<p>Test default values from database and in after hooks.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n</code></pre></div></div>\n\n<h2 id=\"test-migration\">Test migration</h2>\n\n<p>You can test data migration. Do not perfom migration, come just before it</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rake db:drop db:create db:migrate VERSION=20180503095528\nrake db:migrate:status\nYou have 1 pending migration:\n  20180508073700 RemoveLocationVoucherType\n# Run `rake db:migrate` to update your database then try again.\n# I tried to ignore with `config.active_record.migration_error = false` but it\n# gives me error message. You should move or rename migration file while you run\nrake db:drop db:create db:migrate &amp;&amp; bin/rspec spec/migrations/my_migration_specc.rb\n</code></pre></div></div>\n\n<p>You should also rename test file so it is not run with all other, or ignore\nspecific tag metadata.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class MyMigration &lt; ActiveRecord::Migration\n  # this is local Location class used only inside this migration\n  class Location &lt; ActiveRecord::Base\n  end\n  def up\n    rename_column :locations, :name, :name2\n    # this is needed since renamed columns will be ignored on \"save\"\n    Location.reset_column_information\n    Location.find_each do |location|\n      location.name2 = 'updated in migration'\n      location.save!\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>I tried with\n<a href=\"https://github.com/xevix/activerecord_migration_testing_example/blob/53ee8c52f5c4d21a616f4a2f40cdc2481ccbd73c/spec/migrations/move_sales_price_to_user_item_spex.rb\">Migrator.migrate</a>\nbut nothing happens (no sql migration commands), so I simply run\n<code class=\"highlighter-rouge\">MyMigration.new.up</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/migrations/my_migration_spec.rb\nload 'spec/spec_helper.rb'\nload 'tmp/20180508073700_remove_location_voucher_type.rb'\n# run test with this command\n# rake db:drop db:create db:migrate STEP=20180503095528 &amp;&amp; bin/rspec spec/migrations/remove_location_voucher_type_spec.rb --tag migration_specs\nRSpec.describe RemoveLocationVoucherType, migration_specs: true do\n\n  it 'up' do\n    # ActiveRecord::Migrator.migrate(migrations_paths, previous_version)\n    my_user = create :user\n    MyMigration.new.up\n    my_user.reload\n    expect(my_user.name2).to be 'updated in migration'\n  end\nend\n</code></pre></div></div>\n\n<p>If there is an error than skip DatabaseCleaner</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># error\n\n# spec/support/database_cleaner.rb\nRSpec.configure do |config|\n  config.around(:each) do |example|\n    if example.metadata[:migration_specs]\n      example.run\n    else\n      # Start transaction\n      DatabaseCleaner.cleaning do\n        example.run\n      end\n    end\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"refactoring\">Refactoring</h1>\n\n<p>Refactoring in 3 types:</p>\n\n<ul>\n  <li>break up complexity: boolean logic <code class=\"highlighter-rouge\">has_purchased_before?</code>, convert local\nvariables to methods and extract other methods from comments (part of methods)</li>\n  <li>combine duplication: duplication of fact (use class constant or instance\nmethod), duplication of logic (use before actions), find missing abstractions\n(replace some group of methods that are used together as parameters, with a\nnew class with those instance methods, like value objects)</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class User &lt; ActiveRecord::Base\ndelegate :full_name, :sort_name, to: :name\ndef name\n  Name.new(first_name, last_name)\nend\n\nclass Name\n  attr_accessor :first_name, :last_name\n  def initialize(first_name, last_name)\n    @first_name, @last_name = first_name, last_name\n  end\n  def full_name\n    \"#{first_name} #{last_name}\"\n  end\n  def sort_name\n    \"#{last_name}, #{first_name}\"\n  end\nend\n</code></pre></div></div>\n\n<ul>\n  <li>usually do not test associations</li>\n  <li>testing class methods, do not create more objects than it is needed\n    <ul>\n      <li>when testing filter, than create two objects, one that satisfy and other\ndoes not</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>it \"finds completed tasks\" do\n  complete = Task.create!(completed_at: 1.day.ago, title: 'Completed')\n  incomplete = Task.create!(completed_at: nil, title: 'Incompleted')\n  expect(Task.complete.map(&amp;:title)).to eq(['Completed'])\n  # or\n  expect(Task.complete).to match(\n    [an_object_having_attributes(title: 'Completed')]\n  )\nend\n</code></pre></div>    </div>\n  </li>\n  <li>class methods could be stubbed</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'rails_helper'\nRSpec.describe User do\n  context \".latest\" do\n    let(:user) { build :user, :published }\n    before { allow(User).to receive(:latest).and_return([:user]) }\n    it { expect(User.latest).to include user }\n  end\nend\n\nRSpec.describe \"Post #create\" do\n  context 'when password is invalid' do\n    it 'renders the page with error' do\n      user = create(:user)\n      post :create, session: { email: user.email, password: 'invalid' }\n      expect(response).to render_template(:new)\n      expect(flash[:notice]).to match(/^Email and password do not match/)\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>You can stub request.remote_ip</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>allow_any_instance_of(ActionDispatch::Request).to receive(:remote_ip).and_return('192.168.0.1')\n</code></pre></div></div>\n\n<p>Also you can stub helper methods</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>allow_any_instance_of(ApplicationHelper).to receive(:generate_password).and_return '111000'\n</code></pre></div></div>\n\n<h1 id=\"selenium\">Selenium</h1>\n\n<p><a href=\"https://github.com/SeleniumHQ/selenium/wiki/Ruby-Bindings\">https://github.com/SeleniumHQ/selenium/wiki/Ruby-Bindings</a>\nSelenium for ruby use gem <code class=\"highlighter-rouge\">selenium-webdriver</code>.\nYou also need executables for firefox <code class=\"highlighter-rouge\">geckodriver</code> (just download from\n<a href=\"https://github.com/mozilla/geckodriver/releases\">https://github.com/mozilla/geckodriver/releases</a> to <code class=\"highlighter-rouge\">/usr/local/bin</code>)\nand for chrome <code class=\"highlighter-rouge\">chromedriver</code> (download from\n<a href=\"https://sites.google.com/a/chromium.org/chromedriver/downloads\">https://sites.google.com/a/chromium.org/chromedriver/downloads</a> to\n<code class=\"highlighter-rouge\">/usr/local/bin</code>) or you can use <code class=\"highlighter-rouge\">gem 'chromedriver-helper'</code> that will install\nchromedriver to <code class=\"highlighter-rouge\">.rvm/gems/ruby-2.3.3/bin/chromedriver</code>.</p>\n\n<p>Make sure you have version of firefox and chrome that matches drivers.</p>\n\n<p>Instead of using <code class=\"highlighter-rouge\">get</code> and <code class=\"highlighter-rouge\">response.body</code> we can use only what end user see\n<code class=\"highlighter-rouge\">visit</code>, <code class=\"highlighter-rouge\">fill_in</code> and <code class=\"highlighter-rouge\">page.should</code>. Also it can use the\nsame DSL to drive browser (selenium-webdriver, chrome-driver or capybara-webkit)\nor headless drivers (<code class=\"highlighter-rouge\">:rack_test</code> or phantomjs). <code class=\"highlighter-rouge\">Capybara.current_driver</code> could\nbe <code class=\"highlighter-rouge\">:rack_test</code> (when no <code class=\"highlighter-rouge\">js: true</code>) or <code class=\"highlighter-rouge\">:headless_chrome</code> or <code class=\"highlighter-rouge\">':chrome</code>.</p>\n\n<h2 id=\"errors\">Errors</h2>\n\n<p>If you see error <code class=\"highlighter-rouge\">unable to obtain stable firefox connection in 60 seconds\n(127.0.0.1:7055) (Selenium::WebDriver::Error::WebDriverError)</code> you need to <code class=\"highlighter-rouge\">gem\nupdate selenium-webdriver</code> or to install matched version.</p>\n\n<p>Minitest is included in ruby and also in rails. If your system tests shows error\n<code class=\"highlighter-rouge\">Selenium::WebDriver::Error::WebDriverError: unable to connect to chromedriver\n127.0.0.1:9515</code> than add gem <code class=\"highlighter-rouge\">gem 'chromedriver-helper'</code> to your development and\ntest group.</p>\n\n<p>If you see <code class=\"highlighter-rouge\">KeyError: key not found: 102</code> than upgrade chromedriver to 2.33 by\ndownloading from <a href=\"https://sites.google.com/a/chromium.org/chromedriver/\">https://sites.google.com/a/chromium.org/chromedriver/</a> and <code class=\"highlighter-rouge\">mv\nchromedriver bin</code> or if you are using <code class=\"highlighter-rouge\">chromedriver-helper</code> run</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rm -rf ~/.chromedriver-helper/\nchromedriver-update\n</code></pre></div></div>\n\n<p>For <code class=\"highlighter-rouge\">Selenium::WebDriver::Error::UnknownError: unknown error: call function\nresult missing 'value' (Session info: headless chrome=67.0.3396.48)</code> you need to\nupdate chromedriver to 2.38</p>\n\n<p>If you see error <code class=\"highlighter-rouge\">SocketError: getaddrinfo: Name or service not known</code> than make\nsure you have defined localhost <code class=\"highlighter-rouge\">127.0.0.1 localhost</code> in <code class=\"highlighter-rouge\">/etc/hosts</code></p>\n\n<p>If you see error <code class=\"highlighter-rouge\">Selenium::WebDriver::Error::StaleElementReferenceError: stale\nelement reference: element is not attached to the page document</code> it could be\nthat element was removed, page reloaded in javascript, or when you use <code class=\"highlighter-rouge\">within\n#id</code> and than make expectation inside <code class=\"highlighter-rouge\">within</code> block. Try to move expectation\noutsite of <code class=\"highlighter-rouge\">within</code> block or to reload</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>page.driver.browser.navigate.refresh\npage.evaluate_script 'window.location.reload()'\n</code></pre></div></div>\n\n<p>Chrome driver usually starts with <code class=\"highlighter-rouge\">data:,</code> url and than redirects to for example\n<a href=\"http://127.0.0.1:34623/posts\">http://127.0.0.1:34623/posts</a></p>\n\n<p>In rails console you should see starting browser with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>options = Selenium::WebDriver::Chrome::Options.new\noptions.add_argument('--headless')\ndriver = Selenium::WebDriver.for :chrome #, options: options\n</code></pre></div></div>\n\n<p>To run in browser javascript use <code class=\"highlighter-rouge\">js: true</code>. Note that in this mode, drop down\nlinks are not visible, you need to click on dropdown. Also <code class=\"highlighter-rouge\">data-confirm</code> will\nbe ignored.\nNote that in this mode you can’t use <code class=\"highlighter-rouge\">rails-rspec</code> default\n<code class=\"highlighter-rouge\">config.use_transactional_fixtures</code> since selenium can’t know that refresh or\nnavigation to another page should be in the same transaction, so you need to use\n<code class=\"highlighter-rouge\">database_cleaner</code> as we do configuration below.\n<a href=\"http://elementalselenium.com/tips/29-chrome-driver\">http://elementalselenium.com/tips/29-chrome-driver</a>\n<a href=\"https://robots.thoughtbot.com/headless-feature-specs-with-chrome\">https://robots.thoughtbot.com/headless-feature-specs-with-chrome</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/capybara.rb\nrequire \"selenium/webdriver\"\n\nCapybara.register_driver :chrome do |app|\n  # set download directory using Profile (can be set using :prefs in options)\n  profile = Selenium::WebDriver::Chrome::Profile.new\n  profile[\"download.default_directory\"] = DownloadFeatureHelpers::PATH.to_s\n  Capybara::Selenium::Driver.new(app, browser: :chrome, profile: profile)\nend\n\nCapybara.register_driver :headless_chrome do |app|\n# I prefer to use Options instead Capabilities\n#   capabilities = Selenium::WebDriver::Remote::Capabilities.chrome(\n#     chromeOptions: { args: %w(headless disable-gpu window-size=1024,768) }\n#   )\n#   Capybara::Selenium::Driver.new app, browser: :chrome, desired_capabilities: capabilities\n  options = Selenium::WebDriver::Chrome::Options.new(\n    args: %w[headless disable-gpu window-size=1024,768],\n    # can not use prefs for headless driver since it is not supported\n    # prefs: {\n    #   \"download.default_directory\": DownloadFeatureHelpers::PATH.to_s,\n    # }\n  )\n\n  Capybara::Selenium::Driver.new(app, browser: :chrome, options: options)\nend\n\nRSpec.configure do |config|\n  files = config.instance_variable_get :@files_or_directories_to_run\n  if files == [\"spec\"]\n    # when run all spec use headless\n    Capybara.javascript_driver = :headless_chrome\n  else\n   Capybara.javascript_driver = :chrome\n  end\nend\nCapybara.enable_aria_label = true\n\n\n# if you need to use custom domain , you can set host, but also set server port\nCapybara.app_host = \"http://my-domain.loc:3333\"\nCapybara.server_port = 3333\n# you can read host and port\nCapybara.current_session.server.host\nCapybara.current_session.server.port\n# normally chrome starts with url: data; and than redirects to app_host\n# app_host should ends with .loc or .lvh.me so it point to localhost\n</code></pre></div></div>\n\n<p>For newer Firefox I needed to download\n<a href=\"https://github.com/mozilla/geckodriver/releases\">geckodriver</a> and put it\nsomewhere like <code class=\"highlighter-rouge\">/user/local/bin/geckodriver</code>. Also <a href=\"https://ftp.mozilla.org/pub/firefox/releases/47.0.1/\">Firefox\n47.0.1</a> is suggested, but\nmy ver 50 also works.</p>\n\n<h1 id=\"remote-selenium\">Remote Selenium</h1>\n\n<p>You can control remote selenium server. Download\n<a href=\"https://www.seleniumhq.org/download/\">selenium-server-standalone.jar</a> and run\nselenium server.  For error <code class=\"highlighter-rouge\">Unsupported major.minor\nversion 52.0</code> you need to update java: 51 -&gt; java7, 52 -&gt; java8, 53 -&gt; java9.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>java -jar selenium-server-standalone.jar\n</code></pre></div></div>\n\n<p>To test in <code class=\"highlighter-rouge\">rails c</code> try</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># chrome\ndriver = Selenium::WebDriver.for :remote, desired_capabilities: :chrome, url: \"http://192.168.5.56:4444/wd/hub\"\n# same as\n# driver = Selenium::WebDriver.for :chrome, url: \"http://192.168.5.56:4444/wd/hub\"\ndriver.navigate.to 'http://google.com' #=&gt; nil\n\n# firefox\n# driver = Selenium::WebDriver.for :firefox, url: \"http://192.168.5.56:4444/wd/hub\"\n\n# headless chrome\noptions = Selenium::WebDriver::Chrome::Options.new(\n  args: %w[headless disable-gpu window-size=1024,768],\n)\ndriver = Selenium::WebDriver.for :chrome, url: \"http://192.168.5.56:4444/wd/hub\", options: options\n</code></pre></div></div>\n\n<p>If there is a screen you can run both headless and not. If you run server from\nssh (there is no screen) than you can run headless or you can run server using X\nvirtual frame buffer</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>xvfb-run java -Dwebdriver.chrome.driver=/usr/local/bin/chromedriver -jar /usr/local/bin/selenium-server-standalone.jar\n</code></pre></div></div>\n\n<p>Open new tab</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># http://www.rubydoc.info/github/jnicklas/capybara/Capybara/Window\n    old_window = page.driver.browser.window_handles.last\n    new_window = page.open_new_window\n    page.switch_to_window new_window\n    # page.current_window.close\n    page.driver.browser.close # this will close tab, not whole window\n    page.switch_to_window old_window\n</code></pre></div></div>\n\n<h1 id=\"capybara\">Capybara</h1>\n\n<p>Capybara is used only with\n<a href=\"https://www.relishapp.com/rspec/rspec-rails/docs/feature-specs/feature-spec\">feature\nspec</a>\nJust install the gem in require it:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development, :test do/a  \\\n  gem \"capybara\"\\\n  gem \"capybara-email\"\\\n  gem \"selenium-webdriver\"\\\n  # for save_and_open_page in browser\\\n  gem \"launchy\"\\\n  # to clean db when using js mode\\\n  gem \"database_cleaner\"'\nbundle\nsed -i spec/rails_helper.rb -e '/require .rspec.rails/a  \\\nrequire \"capybara/rspec\"\\\nrequire \"capybara/email/rspec\"'\n\ncat &gt; spec/support/database_cleaner.rb &lt;&lt; HERE_DOC\nRSpec.configure do |config|\n  # If you're not using ActiveRecord, or you'd prefer not to run\n  # each of your examples within a transaction, remove the following\n  # line or assign false instead of true.\n  config.use_transactional_fixtures = false\n\n  # Clean up and initialize database before\n  # running test exmaples\n  config.before(:suite) do\n    # Truncate database to clean up garbage from\n    # interrupted or badly written examples\n    DatabaseCleaner.clean_with(:truncation)\n\n    # Seed dataase. Use it only for essential\n    # to run application data.\n    load \"#{Rails.root}/db/seeds.rb\"\n  end\n\n  config.around(:each) do |example|\n    # Use really fast transaction strategy for all\n    # examples except 'js: true' capybara specs\n    # that is Capybara.current_driver != :rack_test\n    # https://github.com/DatabaseCleaner/database_cleaner#what-strategy-is-fastest\n    DatabaseCleaner.strategy = example.metadata[:js] ? :truncation : :transaction\n\n    # Start transaction\n    DatabaseCleaner.cleaning do\n\n      # Run example\n      example.run\n    end\n\n    load \"#{Rails.root}/db/seeds.rb\" if example.metadata[:js]\n\n    # Clear session data\n    Capybara.reset_sessions!\n  end\nend\nHERE_DOC\n\nsed -i spec/rails_helper.rb -e '/use_transactional_fixtures/c  \\\n  config.use_transactional_fixtures = false'\n\ngit add . &amp;&amp; git commit -m \"add capybara\"\n</code></pre></div></div>\n\n<p><a href=\"https://github.com/DockYard/capybara-email\">capybara-email</a> is using\n<code class=\"highlighter-rouge\">open_email 'my@email.com'</code> to set <code class=\"highlighter-rouge\">current_email</code> for which you can\n<code class=\"highlighter-rouge\">current_email.click_link</code></p>\n\n<p>Capybara adds some aliases:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">feature</code> is alias for <code class=\"highlighter-rouge\">describe ..., type: :feature</code> or <code class=\"highlighter-rouge\">context</code></li>\n  <li><code class=\"highlighter-rouge\">background</code> is alias for <code class=\"highlighter-rouge\">before</code></li>\n  <li><code class=\"highlighter-rouge\">scenario</code> is an alias for <code class=\"highlighter-rouge\">it</code></li>\n  <li><code class=\"highlighter-rouge\">given</code> is alias for <code class=\"highlighter-rouge\">let</code></li>\n</ul>\n\n<p>Some of the most used capybara methods\n<a href=\"https://gist.github.com/duleorlovic/042178b92f1badc09490\">link</a> or <a href=\"https://thoughtbot.com/upcase/test-driven-rails-resources/capybara.pdf\">cheat\nsheet</a></p>\n\n<p><strong>Session methods</strong> you can set expectation for <code class=\"highlighter-rouge\">current_path</code> or <code class=\"highlighter-rouge\">current_url</code>\n<code class=\"highlighter-rouge\">page</code> is actually <code class=\"highlighter-rouge\">Capybara::Session</code> class so better is to use <code class=\"highlighter-rouge\">sessions</code>\nname. When you find some element you get <code class=\"highlighter-rouge\">Capybara::Node::Element</code>, but you can\ncreate new node without going to selenium, using html text</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>node = Capybara.string &lt;&lt;-HTML\n  &lt;ul&gt;\n    &lt;li id=\"home\"&gt;Home&lt;/li&gt;\n    &lt;li id=\"projects\"&gt;Projects&lt;/li&gt;\n  &lt;/ul&gt;\nHTML\nnode.class # =&gt; Capybara::Node::Simple\nnode.find('#projects').text # =&gt; 'Projects'\n</code></pre></div></div>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">visit \"/\"</code>, <code class=\"highlighter-rouge\">visit new_project_path</code>. Remember that if you want to go to\ndifferent domain than <code class=\"highlighter-rouge\">Capybara.app_host</code> than you need to use full url (with\nprotocol) so no <code class=\"highlighter-rouge\">visit 'www.google.com</code> but rather <code class=\"highlighter-rouge\">visit\n'http://google.con'</code>. Any relative url will use <code class=\"highlighter-rouge\">Capybara.app_host</code> just note\nthat it also needs protocol <code class=\"highlighter-rouge\">Capybara.app_host = 'http://...'</code> otherwise error\n<code class=\"highlighter-rouge\">undefined method  +  for nil:NilClass</code></li>\n  <li><code class=\"highlighter-rouge\">within \"#login-form\" do</code></li>\n  <li>\n    <p>generate capybara post request using submit (this does not work for <code class=\"highlighter-rouge\">js:\ntrue</code>, so please use <code class=\"highlighter-rouge\">js: false</code>)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  session = Capybara.current_session.driver\n  session.submit :post, customer_sign_up_path, mac: mac\n</code></pre></div>    </div>\n  </li>\n  <li>scroll to the bottom of the page since since elements needs to be visible when\n<code class=\"highlighter-rouge\">js: true</code> you can use <code class=\"highlighter-rouge\">page.execute_script \"window.scrollBy(0,10000)\"</code> or make\nanchor and use hash url <code class=\"highlighter-rouge\">url/#my-form</code> since execute script is not available\nwhen not <code class=\"highlighter-rouge\">js: true</code>. For pagination I prefer to use helper\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def scroll_down\n  page.execute_script(&lt;&lt;-SCRIPT)\n  var next = $('a.next_page[rel=\"next\"]');\n  var maxScrolls = 15;\n  var myInterval = setInterval(function(){\n    window.scrollBy(0,10000)\n    next = $('a.next_page[rel=\"next\"]');\n    maxScrolls -= 1;\n    if (next.length &amp;&amp; maxScrolls &gt; 0) {\n      console.log(maxScrolls);\n    } else {\n      clearInterval(myInterval);\n    }\n  }, 200);\n  SCRIPT\nend\n</code></pre></div>    </div>\n  </li>\n  <li>back button <code class=\"highlighter-rouge\">page.driver.go_back</code></li>\n  <li><a href=\"http://www.rubydoc.info/github/teamcapybara/capybara/master/Capybara/Session#visit-instance_method\">more</a></li>\n</ul>\n\n<p><strong>Node actions</strong> target elements by their: id (without <code class=\"highlighter-rouge\">#</code>), name, label text,\nalt text, inner text\n<a href=\"http://www.rubydoc.info/github/jnicklas/capybara/master/Capybara/Node/Actions\">more</a>\nNote that locator is case sensitive. You can NOT use css or xpath (this is\nonly for finders). You can use substring or you can define <code class=\"highlighter-rouge\">exact: true</code></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">click_on \"Submit\"</code> (both buttons and links) <code class=\"highlighter-rouge\">click_button \"Sign in\"</code>,\n<code class=\"highlighter-rouge\">click_link \"Menu\"</code>. Find can be used for click, for example\n<code class=\"highlighter-rouge\">find('.class').click</code> but I prefer to enable aria labels and use that\n<code class=\"highlighter-rouge\">Capybara.enable_aria_label = true</code> and <code class=\"highlighter-rouge\">click 'my-aria-label'</code></li>\n  <li><code class=\"highlighter-rouge\">fill_in \"email\", with: 'asd@asd.asd'</code> (alternative is find set\n<code class=\"highlighter-rouge\">find(\"input[name='cc']\").set 'asd@asd.asd'</code>, or using javascript\n<code class=\"highlighter-rouge\">page.execute_script \"$('#my-id').val('asd@asd.asd')\"</code></li>\n  <li>to click on select2 I use <code class=\"highlighter-rouge\">find('#original-select-id+span').click</code> so we find\nfirst next sibling of original select which was disabled and replaced by\nselect2 spans. Also works <code class=\"highlighter-rouge\">find('li', text: select.label).click</code> but I can not\nfind that <code class=\"highlighter-rouge\">li</code> in dom.</li>\n  <li><code class=\"highlighter-rouge\">check 'my checkbox'</code> (or by id but without # <code class=\"highlighter-rouge\">check 'my_check_id'</code>), <code class=\"highlighter-rouge\">choose\n 'my radio button'</code>, <code class=\"highlighter-rouge\">select 'My Option or Value', from: 'My Select Box'</code>, also\n uncheck <code class=\"highlighter-rouge\">uncheck 'my checkbox'</code>, <code class=\"highlighter-rouge\">unselect</code>, <code class=\"highlighter-rouge\">attach_file 'Image',\n '/path/to/image.jpg'</code></li>\n</ul>\n\n<p><strong>Node finders</strong> <a href=\"http://www.rubydoc.info/github/jnicklas/capybara/Capybara/Node/Finders#find-instance_method\">find</a> can use css, xpath, or text (see some <a href=\"scrapper post\">xpath examples</a>)</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">find 'th', text: 'Total Customers'</code></li>\n  <li><code class=\"highlighter-rouge\">find('ng-model=\"newExpense.amount\"').set('123')</code></li>\n  <li><code class=\"highlighter-rouge\">find_all('input').first.set(123)</code> but I think it is better to use\n<code class=\"highlighter-rouge\">find('input', match: :first)</code> since it do not need to find all</li>\n  <li><code class=\"highlighter-rouge\">find('[data-test=\"id\"]', visible: false)</code> to find invisible element</li>\n  <li><code class=\"highlighter-rouge\">find('#selector').find(:xpath, '..')</code> find parent node of selector\n<code class=\"highlighter-rouge\">.find(:xpath, '../..')</code> is parent of parent (grandparent).</li>\n  <li>label as child of next adjacent\n<code class=\"highlighter-rouge\">&lt;h3&gt;Name2&lt;/h3&gt;&lt;div&gt;&lt;label&gt;enabled&lt;/label&gt;&lt;label&gt;disabled&gt;&lt;/div&gt;</code> is\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>find(:xpath, \"//h3[contains(text(),'Name2')]/following-sibling::div/label[contains(text(),'enabled')]\")\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>If you need to fill_in iframe than you can access it by id or number</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  within_frame 0 do\n  end\n</code></pre></div></div>\n\n<p>If you need to switch jump into new window opened by target <code class=\"highlighter-rouge\">_blank</code> than you\ncan</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>new_window = window_opened_by { click_link 'Something' }\n# or\nnew_window = page.driver.browser.window_handles.last\n\npage.within_window new_window do\n  # code\nend\n</code></pre></div></div>\n\n<p><strong>Node matchers</strong> and rspec matchers <a href=\"http://www.rubydoc.info/github/jnicklas/capybara/master/Capybara/Node/Matchers\">more</a> <a href=\"http://www.rubydoc.info/github/jnicklas/capybara/master/Capybara/RSpecMatchers\">rspecmatchers</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">expect(page.has_css?('.asd')).to be true</code></li>\n  <li><code class=\"highlighter-rouge\">expect(page).to have_css(\".title\", text: \"my title\")</code>, <code class=\"highlighter-rouge\">have_text /hi|bye/</code>,\n<code class=\"highlighter-rouge\">have_content</code>, <code class=\"highlighter-rouge\">have_link</code>, <code class=\"highlighter-rouge\">have_button</code>, <code class=\"highlighter-rouge\">have_selector(\"#project_#{project.id} .name\",\ntext: 'duke')</code> .\n<code class=\"highlighter-rouge\">have_no_selector</code> for opposite. It is not same <code class=\"highlighter-rouge\">expect(page).not_to have_text</code>\nand <code class=\"highlighter-rouge\">expect(page).to have_no_text</code> since in later case it will wait until it\ntries to fulfill expectation.\nWith all you can use <code class=\"highlighter-rouge\">text: '...'</code> and <code class=\"highlighter-rouge\">count: 2</code> which is number of occurences.\nInstead of <code class=\"highlighter-rouge\">page.body.include? text</code> (this will compare html tags) use\n<code class=\"highlighter-rouge\">page.has_text? text</code> (this will compare only text).\nFor testing if something is on the page, for example 3 rows, you can use\n<code class=\"highlighter-rouge\">page.has_selector? '[name=\"customer_ids[]\"]', count: 3</code></li>\n  <li>If element is not visible, you can provide <code class=\"highlighter-rouge\">visible: false</code> (does not work\nwith <code class=\"highlighter-rouge\">have_content \"d\", visible: false</code> but works with <code class=\"highlighter-rouge\">have_css 'div', text:\n'd', visible: false</code>. Note that this is triggered only if <code class=\"highlighter-rouge\">js: true</code> (and pass\nif <code class=\"highlighter-rouge\">js: false</code>) so it is better to allways use visible: false for some elements\nin popups.</li>\n  <li>\n    <p>test sort order is with regex <code class=\"highlighter-rouge\">expect(page).to have_text\n/first.*second.*third/</code>  create three objects with first in the middle. If you\nhave new lines, than you can match multiline <code class=\"highlighter-rouge\">/first.*second.*third/m</code> or\nreplace <code class=\"highlighter-rouge\">page.body.gsub \"\\n\", ''</code></p>\n  </li>\n  <li>test if input has value:\n    <ul>\n      <li><code class=\"highlighter-rouge\">expect(page).to have_xpath(\"//input[@value='John']\")</code></li>\n      <li><code class=\"highlighter-rouge\">expect(page).to have_selector(\"input[value='John']\")</code></li>\n      <li><code class=\"highlighter-rouge\">expect(page).to have_field('Your name', with: 'John')</code> this does not match\ndisabled input field. of you want to match disabled use <code class=\"highlighter-rouge\">have_field('Your\nname', disabled: true, with: 'John')</code></li>\n    </ul>\n  </li>\n</ul>\n\n<p>Node element <a href=\"http://www.rubydoc.info/github/jnicklas/capybara/master/Capybara/Node/Element\">more</a></p>\n<ul>\n  <li><code class=\"highlighter-rouge\">find('input').trigger('focus')</code> (does not work in selenium)</li>\n</ul>\n\n<p>Confirm dialog</p>\n<ul>\n  <li>selenium <code class=\"highlighter-rouge\">page.driver.browser.switch_to.alert.accept  # can also be .dismiss</code></li>\n  <li>webkit <code class=\"highlighter-rouge\">page.accept_confirm { click_link \"x\" } }</code> so actions is wrapped with\nthis <code class=\"highlighter-rouge\">page.accept_confirm</code></li>\n</ul>\n\n<p>We can setup data using <code class=\"highlighter-rouge\">let</code>, or <code class=\"highlighter-rouge\">before</code> block, or simply inside\n<code class=\"highlighter-rouge\">it/scenario</code>.\n<a href=\"https://robb.weblaws.org/2016/10/20/why-i-dont-use-letlet-in-my-rspec/?\">post</a>\nsuggests that <code class=\"highlighter-rouge\">let</code> should be replaced with instance variable.</p>\n\n<p>Fixtures are good for integration tests because they are faster in creating a\nlot of objects (in contrast to unit test, where we need clean situation and\na few objects).</p>\n\n<p>Capybara example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/features/search_spec.rb\nrequire 'rails_helper'\n\nRSpec.feature \"Search recipes\", js: true do\n# write data inside or\n  # fixtures :all  # or\n  before do\n    Recipe.create! name: 'Baked Potato'\n  end\n  scenario \"successfully\" do\n    visit \"/\"\n    fill_in \"keywords\", with: \"baked\"\n\n    click_button \"Search\"\n\n    expect(page).to have_content(\"Baked Potato\")\n    expect(page).to_not have_content(\"Garlic\")\n    expect(page.has_link?('Sign up')).to be true\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"oauth-specs\">Oauth specs</h2>\n\n<p>https://github.com/elizabrock/coursewareofthefuture/blob/25372c671f73525e09927344d8f2031b6acf82d0/spec/support/features/authentication_helper.rb</p>\n\n<p>Controller tests https://gist.github.com/jittuu/792715\nHelper https://gist.github.com/spyou/1200365/b0bb95e5cf9144b5a9a58bb6c1fc33aee4c34e47</p>\n\n<h1 id=\"rspec-helpers\">Rspec Helpers</h1>\n\n<p>You an define your helpers in separate file and include it in Rspec\nconfig.</p>\n\n<p>Imporant note that helpers can be used only inside examples (not example groups)</p>\n\n<h2 id=\"custom-matchers\">Custom matchers</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec::Matchers.define :be_able_to_see do |*projects|\n  match do |user|\n    expect(user.visible_projects).to eq(projects)\n    projects.all? { |p| expect(user.can_view?(p)).to be_truthy }\n    (all_projects - projects).all? { |p| expect(user.can_view?(p)).to be_falsy }\n  end\nend\n\nlet(:all_projects) { [project_1, project_2] }\nexpect(user).to be_able_to_see(project_1, project_2)\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/a/equal_when_sorted_by_id.rb\nrequire 'rspec/expectations'\n\n# When using `Timecop.freeze Date.parse('2018-06-06 10:00:00') do` than ordering\n# from database could be random (since created_at are all the same) so you might\n# get failed tests when comparing some scopes.\nRSpec::Matchers.define :equal_when_sorted_by_id do |expected|\n  match do |actual|\n    actual.sort_by(&amp;:id) == expected.sort_by(&amp;:id)\n  end\nend\n</code></pre></div></div>\n\n<p>For flash messages in feature tests</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/a/flash_message_feature_helpers.rb\n# instead of expect(page).to have_selector 'div', text: 'Flash message', visible: false\n# you should use: expect(page).to have_flash_message 'Flash message'\n\nrequire 'rspec/expectations'\n\nRSpec::Matchers.define :have_flash_message do |expected|\n  match do |page|\n    expect(page).to have_selector 'div', text: expected, visible: false\n  end\n  failure_message do |page|\n    \"expected find text '#{expected}' in #{page.body}\"\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"login-helper\">Login helper</h2>\n\n<p>In controller tests you can use devise helpers.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.describe ProjectsController, type: :controller do\n  let(:user) { FactoryBot.create :user }\n  describe \"authenticated user\" do\n    before(:example) do\n      sign_in user\n    end\n\n    # Note that you can change user and it will affect current_user\n    describe \"has some projects\" do\n      before { user.projects &lt;&lt; project }\n      it \"user has project\" do\n        expect(controller.current_user.projects.count).to eq(1)\n      end\n    end\n</code></pre></div></div>\n\n<p>Since in Rails 5, instead of controller tests, we should use integration helper\nand use <code class=\"highlighter-rouge\">sign_in user</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class ActiveSupport::TestCase\n  # provide `sign_in user`\n  include Devise::Test::IntegrationHelpers\nend\n</code></pre></div></div>\n\n<p>Alternatively, you can stub <code class=\"highlighter-rouge\">current_user</code>.</p>\n\n<p>https://github.com/plataformatec/devise/wiki/How-To:-Test-controllers-with-Rails-3-and-4-(and-RSpec)#controller-specs</p>\n\n<p>Use <a href=\"https://github.com/thoughtbot/clearance#fast-feature-specs\">clearance\nbackdoor</a> for\nbypassing login and simply <code class=\"highlighter-rouge\">visit my_profile_path(as: user)</code></p>\n\n<p>In feature tests there we can’t use devise helpers but we can manually log in or\nuse <code class=\"highlighter-rouge\">login_as</code> warden method which is outside of rails stack</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/features/authentication_helpers.rb\nmodule Features\n  module AuthenticationHelpers\n    def user_manual_sign_in(email, password)\n      visit new_user_session_path\n      fill_in 'Email', with: email\n      fill_in 'Password', with: password\n      click_button 'Sign In'\n    end\n\n    def create_logged_in_user\n      user = FactoryBot.create(:user)\n      login_as user\n      user\n    end\n\n    def mock_facebook_auth(user = {})\n      # info https://github.com/omniauth/omniauth/wiki/Integration-Testing\n      auth = {\n        provider: 'facebook',\n        uid: user.try(:facebook_uid) || '1234567',\n        info: {\n          email: user.try(:email) || 'joe@bloggs.com',\n          name: user.try(:name) || 'Joe Bloggs',\n          first_name: 'Joe',\n          last_name: 'Bloggs',\n          image: 'http://graph.facebook.com/1234567/picture?type=square',\n          verified: true\n        },\n        credentials: {\n          token: 'ABCDEF...', # OAuth 2.0 access_token, which you may wish to store\n          expires_at: 1321747205, # when the access token expires (it always will)\n          expires: true # this will always be true\n        },\n      }\n\n      OmniAuth.config.test_mode = true\n      OmniAuth.config.add_mock(:facebook, auth)\n    end\n\n    def mock_facebook_invalid_auth\n      OmniAuth.config.test_mode = true\n      OmniAuth.config.mock_auth[:facebook] = :invalid_credentials\n    end\n\n    def silence_omniauth\n      previous_logger = OmniAuth.config.logger\n      OmniAuth.config.logger = Logger.new(\"/dev/null\")\n      yield\n    ensure\n      OmniAuth.config.logger = previous_logger\n    end\n  end\nend\n\nRSpec.configure do |config|\n  config.include Features::AuthenticationHelpers, type: :feature\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/devise.rb\nRSpec.configure do |config|\n  # this enable sign_in, sign_out devise methods in controller and view specs\n  config.include Devise::Test::ControllerHelpers, type: :controller\n  config.include Devise::Test::ControllerHelpers, type: :view\n  # for devise &lt;= 4.1.0\n  # config.include Devise::TestHelpers\nend\n# configure only for features\nRSpec.configure do |config|\n  # login_as is warden method\n  config.include Warden::Test::Helpers\nend\n</code></pre></div></div>\n\n<p>I got error: <code class=\"highlighter-rouge\">UncaughtThrowError: uncaught throw :warden</code> and that is because\nuser was unconfirmed. Better is be by default confirmed:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  factory :user do\n    sequence(:email) { |n| \"email#{n}@trk.in.rs\" }\n    password 'asdfasdf'\n    confirmed_at { Time.current }\n\n    factory :unconfirmed_user do\n      confirmed_at nil\n    end\n  end\n</code></pre></div></div>\n\n<p>Note that devise confirmation email is sent\n<a href=\"https://github.com/plataformatec/devise/blob/4-1-stable/lib/devise/models/confirmable.rb#L48\">after_commit</a>\nwhich is not happen if you are using database_cleaner. Solution is to jump to\n<code class=\"highlighter-rouge\">js</code> or manually initiate sending email confirmation after create\n<a href=\"https://github.com/plataformatec/devise/issues/2688#issuecomment-187173433\">link</a></p>\n\n<h2 id=\"mailer-helper\">Mailer helper</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/mailer_helpers.rb\nmodule MailerHelpers\n  # you should call this manually for specific test\n  # not for all tests like: config.before(:each) { reset_email }\n  def clear_emails\n    ActionMailer::Base.deliveries = []\n  end\n\n  def last_email\n    fail 'please use give_me_last_mail_and_clear_mails'\n    ActionMailer::Base.deliveries.last\n  end\n\n  # some usage is like:\n  # mail = give_me_last_mail_and_clear_mails\n  # assert_equal [email], mail.to\n  # assert_match t('user_mailer.landing_signup.confirmation_text'), mail.html_part.decoded\n  # confirmation_link = mail.html_part.decoded.match(\n  #   /(http:.*)\"&gt;#{t(\"confirm_email\")}/\n  # )[1]\n  # visit confirmation_link\n  def give_me_last_mail_and_clear_mails\n    email = ActionMailer::Base.deliveries.last\n    ActionMailer::Base.deliveries = []\n    email\n  end\nend\nRSpec.configure do |config|\n  config.include(MailerHelpers)\nend\n</code></pre></div></div>\n\n<p>Testing emails rspec is different for Devise 3 and Devise 4 (there is a problem\nthat I can’t open regitration email in devise 4).</p>\n\n<h2 id=\"pause-helpers\">Pause helpers</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/pause_helpers.rb\nmodule PauseHelpers\n  # you can use byebug, but it will stop rails so you can not navigate to other\n  # pages or make another requests in chrome while testing\n  def pause\n    $stderr.write 'Press CTRL+J or ENTER to continue'\n    $stdin.gets\n  end\nend\nRSpec.configure do |config|\n  config.include PauseHelpers, type: :feature\nend\n</code></pre></div></div>\n\n<h2 id=\"download-helpers\">Download helpers</h2>\n\n<p>Inspect file that is downloaded like <code class=\"highlighter-rouge\">respond_to do |format| format.csv { render\ntext: CSV.generate { |csv| csv &lt;&lt; [1,2] } } end</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/download_feature_helpers.rb\n# https://collectiveidea.com/blog/archives/2012/01/27/testing-file-downloads-with-capybara-and-chromedriver\n#\n#    csv_content = DownloadHelpers.download_content\n#    expect(csv_content.count(\"\\n\")).to eq 3\n#    expect(csv_content).to include first_customer.name\n#\nmodule DownloadFeatureHelpers\n  TIMEOUT = 10\n  PATH    = Rails.root.join(\"tmp/downloads\")\n\n  extend self\n\n  def downloads\n    Dir[PATH.join(\"*\")]\n  end\n\n  def download\n    downloads.first\n  end\n\n  def download_content\n    wait_for_download\n    File.read(download)\n  end\n\n  def wait_for_download\n    Timeout.timeout(TIMEOUT) do\n      sleep 0.1 until downloaded?\n    end\n  end\n\n  def downloaded?\n    !downloading? &amp;&amp; downloads.any?\n  end\n\n  def downloading?\n    downloads.grep(/\\.crdownload$/).any?\n  end\n\n  def clear_downloads\n    FileUtils.rm_f(downloads)\n  end\nend\n\nRSpec.configure do |config|\n  config.include DownloadFeatureHelpers, type: :feature\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require \"selenium/webdriver\"\nCapybara.register_driver :chrome do |app|\n  profile = Selenium::WebDriver::Chrome::Profile.new\n  profile[\"download.default_directory\"] = DownloadFeatureHelpers::PATH.to_s\n  Capybara::Selenium::Driver.new(app, browser: :chrome, profile: profile)\nend\n\n# another way to set profile is with prefs in desired_capabilities\n# Currently it does not work if you use headless chrome since it is not\n# supported &lt;https://github.com/SeleniumHQ/selenium/issues/4437&gt;\n# Probably works in headless firefox.\n\nCapybara.register_driver :headless_chrome do |app|\n  desired_capabilities = Selenium::WebDriver::Remote::Capabilities.chrome(\n    chromeOptions: { args: %w(headless disable-gpu window-size=1024,768) },\n    prefs: {\n      \"download.default_directory\": DownloadFeatureHelpers::PATH.to_s,\n    }\n  )\n\n  Capybara::Selenium::Driver.new(\n    app,\n    browser: :chrome,\n    desired_capabilities: desired_capabilities,\n  )\nend\n</code></pre></div></div>\n\n<p>Usage in test is to clear downloads first since failing expectation will break\nand not remove files.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.describe 'Location Reports', js: true do\n  it 'downloads' do\n    DownloadFeatureHelpers.clear_downloads\n    click_on 'Generate Report'\n    csv_content = DownloadFeatureHelpers.download_content\n    expect(csv_content.count(\"\\n\")).to eq 3\n    expect(csv_content).to include first_customer.name\n  end\nend\n</code></pre></div></div>\n\n<h2 id=\"debug\">Debug</h2>\n\n<p>Debug capybara</p>\n<ul>\n  <li>using byebug you can <code class=\"highlighter-rouge\">page.find('[data-id]')</code></li>\n  <li><code class=\"highlighter-rouge\">save_and_open_page</code> to visually inspect the page. It works when <code class=\"highlighter-rouge\">js: false</code>\nand uses <code class=\"highlighter-rouge\">lunchy</code> gem. It does not load images with relative path (images on\nyour server).</li>\n  <li><a href=\"https://github.com/mattheworiordan/capybara-screenshot\">https://github.com/mattheworiordan/capybara-screenshot</a> screen shots and\nhtml are saved in <code class=\"highlighter-rouge\">tmp/capybara</code>. You you use <code class=\"highlighter-rouge\">chrome</code> or another driver that is\nnot <code class=\"highlighter-rouge\">selenium</code> than register with</li>\n</ul>\n<p><a href=\"https://github.com/mattheworiordan/capybara-screenshot/issues/84\">https://github.com/mattheworiordan/capybara-screenshot/issues/84</a>\n<a href=\"https://github.com/mattheworiordan/capybara-screenshot/blob/master/lib/capybara-screenshot.rb#L159\">https://github.com/mattheworiordan/capybara-screenshot/blob/master/lib/capybara-screenshot.rb#L159</a></p>\n\n<p>Also if you use system test you will see screenshot in terminal. to disable you\ncan <code class=\"highlighter-rouge\">export RAILS_SYSTEM_TESTING_SCREENSHOT=simple</code> or set ENV\nhttps://github.com/rails/rails/blob/5-1-stable/actionpack/lib/action_dispatch/system_testing/test_helpers/screenshot_helper.rb#L58</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/capybara_screenshot.rb\nENV[\"RAILS_SYSTEM_TESTING_SCREENSHOT\"] = 'simple'\nCapybara::Screenshot.register_driver(:chrome) do |driver, path|\n  driver.browser.save_screenshot(path)\nend\nCapybara::Screenshot.register_driver(:headless_chrome) do |driver, path|\n  driver.browser.save_screenshot(path)\nend\n# after Saver#save_html\nCapybara::Screenshot.after_save_html do |path|\n  $stderr.write('Press ENTER to continue') &amp;&amp; $stdin.gets\nend\n# after Saver#save_screenshot\nCapybara::Screenshot.after_save_screenshot do |path|\n  Launchy.open path\nend\n</code></pre></div></div>\n\n<p>You can create gifs from test in two steps. First capture all pages that you are\ninterested with manual screenshot <code class=\"highlighter-rouge\">screenshot_and_save_page</code>, review them and\nrename last one to <code class=\"highlighter-rouge\">final.png</code> and than create animated gif\nwith a http://www.imagemagick.org/Usage/anim_basics</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>convert -delay 50 -loop 0 tmp/capybara/m/screenshot_2018-*.png -delay 400 tmp/capybara/m/final.png animated.gif\n</code></pre></div></div>\n\n<p>If you want to show immediatelly errors while whole test suite is running you\ncan use <a href=\"https://github.com/grosser/rspec-instafail\">https://github.com/grosser/rspec-instafail</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\ngroup :development, :test do\n  gem 'rspec-instafail', require: false\nend\n\n# .rspec\n--require rspec/instafail\n--format RSpec::Instafail\n--format progress # to keep dots ap\n</code></pre></div></div>\n\n<h2 id=\"waiting-ajax\">Waiting ajax</h2>\n\n<p><a href=\"https://github.com/teamcapybara/capybara#asynchronous-javascript-ajax-and-friends\">https://github.com/teamcapybara/capybara#asynchronous-javascript-ajax-and-friends</a>\ncapybara is smart enough to wait if some ajax is called and text is not found.\nSo it will retry (default_max_wait_time=2) untill failure is not raised. Note\nthat <code class=\"highlighter-rouge\">!page.has_xpath?('a')</code> is not the same as <code class=\"highlighter-rouge\">page.has_xpath?('a')</code> in\nexample where you are removing <code class=\"highlighter-rouge\">a</code> in ajax. First will fail since it find <code class=\"highlighter-rouge\">a</code>\nnegate (it does not wait when capybara is success). Second will wait untill it\nis removed. So use expectations which are goint to be met untill after ajax.</p>\n\n<p>Wait for ajax to finish is not needed in latest capybara, but here is reference:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/features/wait_helper.rb\n# https://robots.thoughtbot.com/automatically-wait-for-ajax-with-capybara\n\nmodule WaitHelper\n  # You can use this flash and force driver to wait more time, expecially on\n  # destroy action when there is slow deleting data\n  # app/views/users/destroy.js.erb\n  # window.location.assign('&lt;%= customer_path @customer %&gt;');\n  # jQuery.active = 1;\n  #\n  def wait_for_ajax\n    printf \"jQuery.active\"\n    start_time = Time.current\n    Timeout.timeout(Capybara.default_max_wait_time) do\n      loop until _finished_all_ajax_requests?\n    end\n    printf '%.2f', Time.current - start_time\n  rescue Timeout::Error\n    printf \"timeout#{Capybara.default_max_wait_time}\"\n  end\n\n  def _finished_all_ajax_requests?\n    output = page.evaluate_script('jQuery.active')\n    printf \".\" unless output.zero?\n    output.zero?\n  end\n\n  def wait_for_visible(target)\n    Timeout.timeout(Capybara.default_max_wait_time) do\n      loop until page.find(target).visible?\n    end\n  rescue Timeout::Error\n    flunk \"Expected #{target} to be visible.\"\n  end\nend\nRSpec.configure do |config|\n  config.include WaitHelper, type: :feature\nend\n# for minitest use\nclass ActionDispatch::SystemTestCase\n  include WaitHelper\nend\n</code></pre></div></div>\n\n<p>This is not needed any more, also\n<a href=\"https://www.varvet.com/blog/why-wait_until-was-removed-from-capybara/\">wait_until</a>\nis removed from capybara.</p>\n\n<p>I see only two problem: first is ajax loaded form in modal and you click on\nbutton to submit it immediatelly, but modal uses <code class=\"highlighter-rouge\">fade</code> and is not visible yet.\nSolution is to remove <code class=\"highlighter-rouge\">fade</code> class.\n<a href=\"https://github.com/teamcapybara/capybara/issues/1890\">https://github.com/teamcapybara/capybara/issues/1890</a></p>\n\n<p>Second is when respone is redirection <code class=\"highlighter-rouge\">window.location.assign('/users/1')</code>\n(usually just to reload a page). Capybara does not wait for this\n<code class=\"highlighter-rouge\">window.location</code> change when it is run in <code class=\"highlighter-rouge\">headless_chrome</code> driver. I tried\nwith <code class=\"highlighter-rouge\">window.location.replace</code> and <code class=\"highlighter-rouge\">$(location).attr('href',)</code>. Only solution is\nto use expectation that find element which is not yet on a page. Maybe <code class=\"highlighter-rouge\">visit\ncustomer_path customer</code> again, before expectation, could help.</p>\n\n<p>I noticed that when using <code class=\"highlighter-rouge\">js: true</code> session is preserved between examples even\nfrom multiple files. This is on both chrome and headless_chrome. Since there is\nrandomization, that could be a tricky problem to reproduce. I tried to add</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  config.before(:example) do\n    Capybara.reset_sessions!\n  end\n  before do\n    Capybara.reset_session!\n    browser = Capybara.current_session.driver.browser\n    if browser.respond_to?(:clear_cookies)\n      # Rack::MockSession\n      browser.clear_cookies\n    elsif browser.respond_to?(:manage) and browser.manage.respond_to?(:delete_all_cookies)\n      # Selenium::WebDriver\n      browser.manage.delete_all_cookies\n    else\n      raise \"Don't know how to clear cookies. Weird driver?\"\n    end\n  end\n</code></pre></div></div>\n\n<p>but still problem, sometimes fails/sometimes pass.</p>\n\n<h2 id=\"helpers-inside-spec-file\">Helpers inside spec file</h2>\n\n<p>You can add methods to your spec file, usually for integration specs using\n<code class=\"highlighter-rouge\">yield</code> (click some button on some page) that can be customized for each test\nexample</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/features/user_forgot_password_spec.rb\nrequire 'rails_helper'\n\nRSpec.feature 'User forgot password' do\n  let(:email) { 'my@email.com' }\n  before do\n    create :user, email: email\n    reset_email\n    Rails.cache.clear\n  end\n\n  def request_forgot_password(&amp;block)\n    visit new_user_session_path\n    click_link 'Forgot your password?'\n\n    fill_in 'Email', with: 'user@test.com'\n    yield if block_given?\n\n    click_button 'Send me reset password instructions'\n  end\n\n  scenario 'with existing email' do\n    request_forgot_password do\n      fill_in 'Email', with: email\n    end\n    expect(page).to have_content 'You will receive an email with instructions about how to reset your password in a few minutes.'\n    expect(last_email.to).to include email\n    expect(all_emails.size).to eq 1\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"fixtures\">Fixtures</h1>\n\n<p>All data is cleared between tests. Although we touch database (huge third party\ndependency) we call it <em>unit</em> test. All data is available on each tests. Rails\nstarts db transaction at the begining of each tests and roll back at the end of\ntest (if you do not want transaction you can disable\n<code class=\"highlighter-rouge\">config.use_transactional_fixtures = false</code>)</p>\n\n<p>We define it using <a href=\"/2017/01/10/get-syntax-right-in-jade-yaml-haml/#yaml\">yml file</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test/fixtures/projects.yml\nmy_project:\n  name: My Project Name\n  due_date: 2017-01-01\n</code></pre></div></div>\n\n<p>In tests you can access those data with <code class=\"highlighter-rouge\">projects(:my_project)</code>.\nFixture loading mechanism bypasses ActiveRecord validations.\nYou can use yaml identifier to create associations</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>simple_task:\n  title: Simple task\n  project: my_project\n</code></pre></div></div>\n\n<p>You can use erb to add dynamic attributes or to specify multiple entries</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;% 10.times do |i| %&gt;\ntask_&lt;%= i %&gt;:\n  name: \"Task &lt;%= i %&gt;\"\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<p>Pros:</p>\n\n<ul>\n  <li>fixtures are usefull for global semi static data (like job_types)</li>\n  <li>very fast since all data is loaded at once. It’s better than factory bot\n  since <code class=\"highlighter-rouge\">FactoryBot.create :task</code> 10 times will create 10 projects (association\n  objects) as well.</li>\n</ul>\n\n<p>Cons:</p>\n\n<ul>\n  <li>fixtures are global so all edge cases will increase database data for each\n test</li>\n  <li>fixture are for specific models, so sometime it is hard to track\n complex setup (comment for that task for this project for that owner)</li>\n  <li>fixtures are distant and far away of test so you need look into it to figure\n out actual test setup</li>\n  <li>\n    <p>fixtures define database column so you need erb to define password hash.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>user:\n  email: \"test@example.com\"\n  encrypted_password: &lt;%= User.new.send(:password_digest, 'password') %&gt;\n</code></pre></div>    </div>\n\n    <p>In factory bot you can use model methods.</p>\n  </li>\n</ul>\n\n<h1 id=\"factory-bot\">Factory Bot</h1>\n\n<p>(former Factory girl)\nAfter you install</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development, :test do/a  \\\n  gem \"factory_bot_rails\"'\nbundle\nmkdir spec/support\ncat &gt;&gt; spec/support/factory_bot.rb &lt;&lt; HERE_DOC\n# so we do not need to prefix with FactoryBot.create :user\nRSpec.configure do |config|\n  config.include FactoryBot::Syntax::Methods\nend\nHERE_DOC\n\nsed -i spec/rails_helper.rb -e '/require .spec_helper/a  \\\nrequire \"support/factory_bot\"'\n</code></pre></div></div>\n\n<p>To use factories in console you can simply use: <code class=\"highlighter-rouge\">FactoryBot.create :user</code></p>\n\n<p>You can create factories in <code class=\"highlighter-rouge\">spec/factories.rb</code> or <code class=\"highlighter-rouge\">spec/factories/*.rb</code>. It is\nrecomended to use only one file since it should be bare minimum, and should not\nchange while the application grows (although it could get bigger).\nSo write minimum that meets validation and use inheritance to create variations\nof data.</p>\n\n<p><a href=\"https://github.com/thoughtbot/factory_bot/blob/master/GETTING_STARTED.md#configure-your-test-suite\">Getting\nstarted</a></p>\n\n<ul>\n  <li>factory name is used to determine the class (it has to be same or you need to\nuse <code class=\"highlighter-rouge\">class: Project</code>), dynamic attributes are defined with a block\n<code class=\"highlighter-rouge\">date_of_birth { 11.years.ago }</code> in which you can use other attributes</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/factories.rb\nFactoryBot.define do\n  factory :project do\n    name \"My Project\"\n    full_name { \"exiting #{name}\" }\n    due_date Date.parse(\"2017-01-10\")\n    # note that Time.zone.now is evaluated at begining of test suite so that\n    # expired_at = Time.zone now - 20.mins if you test suite lasts 20.mins\n    expired_at Time.zone.now\n    # here is evaluated when we create :project\n    expired_at { Time.zone.now }\n    # also\n    before :create do |project|\n      project.expired_at = Time.zone.now\n    end\n  end\nend\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>belongs_to associations attributes, you do not need to write any attributes if\nit match the class name, or you can specify which factory and which strategy to\nuse when it is used. Note that you do not use <code class=\"highlighter-rouge\">_id</code> for field name, use class\nname as usuall. In validation, you can validate presence for object but not id\n<code class=\"highlighter-rouge\">validates :user, presence: true</code> (but not <code class=\"highlighter-rouge\">validates :user_id, presence: true</code>)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>factory :comment do\n  user\n  # or\n  association :user\n  # if you want that user is built but not save to database\n  association :user, strategy: :build\n  # you can define class and additional attributes\n  association :updated_by, factory: :user, name: \"Admin User\"\n  # another form\n  user.association :user, name: 'My User'\nend\n</code></pre></div>    </div>\n\n    <p>If you have circular dependency ie two associations that are not independent,\nthan you can setup object in after build block (one of them is less important\nand another is more, which will always used as parameter and not used as\ngenerated, for example it will not happen <code class=\"highlighter-rouge\">create :location_ticket, location:\nlocation</code> without customer it will generate customer from some other\nlocation).</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># location_ticket --------&gt; location\n#                 --&gt; customer --^\nfactory :location_ticket do\n  # location - we set in after build because of circular dependency\n  customer\n  after(:build) do |location_ticket|\n    location_ticket.location = location_ticket.customer.location\n  end\nend\n\n# if you have three dependencies than you can set both in after block.\nfactory :location_package_sale do\n  # location - we set in after build because of circular dependency\n  # customer - we set in after build because of circular dependency\n  # location_package - we set in after build because of circular dependency\n  after(:build) do |location_package_sale|\n    location = location_package_sale.location_package&amp;.location\n    location ||= location_package_sale.customer&amp;.location\n    unless location\n      location = create :location\n    end\n    location_package_sale.location = location\n    unless location_package_sale.customer.present?\n      location_package_sale.customer = create :customer, location: location\n    end\n    unless location_package_sale.location_package.present?\n      location_package_sale.location_package = create :location_package, location: location\n    end\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>transient attributes can be used to set some configuration for dynamic\nattributes, that is not part of model attributes. Mostly used for has_many\nassociations and <em>create_list</em> method</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>factory :post do\n  user\nend\n\nfactory :user do\n  transient do\n    posts_count 5\n  end\n\n  # the after(:create) yields two values; the user instance itself and the\n  # evaluator, which stores all values from the factory, including transient\n  # attributes; `create_list`'s second argument is the number of records\n  # to create and we make sure the user is associated properly to the post\n  after(:create) do |user, evaluator|\n    create_list(:post, evaluator.posts_count, user: user)\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>callbacks <code class=\"highlighter-rouge\">after(:create) do</code>, <code class=\"highlighter-rouge\">after(:build)</code>, <code class=\"highlighter-rouge\">before(:create)</code>,\n<code class=\"highlighter-rouge\">after(:stub)</code>. Note that there is no <code class=\"highlighter-rouge\">before(:build)</code>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>password 'asdfasdf'\nconfirmed_at { Time.current }\n\nfactory :unconfirmed_user do\n  confirmed_at nil\nend\n</code></pre></div>    </div>\n  </li>\n  <li>if you need to use existing record and not create new, you can like this\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>factory :company do\ncountry { Country.first || create(:country) }\ncreated_by { User.first || create(:user) }\nend\n</code></pre></div>    </div>\n  </li>\n  <li>if you need polymorphic, than use <code class=\"highlighter-rouge\">factory: :model</code> attribute. Also you can\nput params in <code class=\"highlighter-rouge\">association</code>\nhttps://robots.thoughtbot.com/aint-no-calla-back-girl</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class SmsAlert &lt; ActiveRecord::Base\n  belongs_to :smsable, polymorphic: true\nend\nclass Customer &lt; ActiveRecord::Base\n  has_many :sms_alerts, as: :smsable\nend\nfactory :sms_alert do\n  message 'a'\n  factory :customer_sms_alert do\n    smsable factory: :customer\n  end\nend\n</code></pre></div></div>\n\n<ul>\n  <li>nested factory is usefull if you need different kind of objects. It is\nsimilar to inheritance. Note that if you have model <code class=\"highlighter-rouge\">UserWithPosts</code> nested\nfactory will use parent factory class <code class=\"highlighter-rouge\">User</code>, not the <code class=\"highlighter-rouge\">UserWithPosts</code>.\nYou can also define as <code class=\"highlighter-rouge\">parent: :user</code> attribute</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>factory :user_without_profile do\n  factory :user do\n    after :create do |user|\n      create :profile, user: user\n    end\n  end\nend\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>sequences are used to generate values (not AR objects) which will be\nincremented every time it is called during test (test sessions is whole <code class=\"highlighter-rouge\">rake\ntest</code> process or <code class=\"highlighter-rouge\">rails c -e test</code> session). It is used for columns that\nneed uniqueness like email field. Usually only one field in table can be\nsequence, other can use it with dynamic attributes</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># seq could be defined outside factory and reused\nsequence :username { |n| \"username#{n}\" }\nfactory :user do\n  username\n  another_uniq_field { generate :username }\n  sequence(:email) { |n| \"user#{n}@asd.asd\" }\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>traits are used to group attributes so you can apply them to any factory. They\ncan be used with hash also <code class=\"highlighter-rouge\">build :user, :admin, name: 'Mike'</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>factory :user do\n  name \"Duke\"\n  username { name }\n\n  trait :admin do\n    username { \"admin-#{name}\" }\n    is_admin true\n  end\n\n  # do not create profile for all users since that is not required in all test\n  trait :with_profile do\n    after :create do |user|\n      create :user_profile, user: user\n    end\n  end\nend\n</code></pre></div>    </div>\n  </li>\n  <li>4 ways of using: you can pass the block to any of it, or you can override with\nhash attributes <code class=\"highlighter-rouge\">build(:user, name: 'My Name')</code>\n    <ul>\n      <li><code class=\"highlighter-rouge\">build(:user)</code> it is not saved but if you have associated <code class=\"highlighter-rouge\">belongs_to\n:project</code> than it will trigger <code class=\"highlighter-rouge\">create(:project)</code> to get <code class=\"highlighter-rouge\">project_id</code> and all\nits associated objects… you can try with <code class=\"highlighter-rouge\">strategy: :build</code> but that could\nbe a problem since associated_ids do not exists. Solution is to use\n<code class=\"highlighter-rouge\">build_stubbed</code> or do not define association at all and define them in tests\n(code need to be testable without associations)</li>\n      <li><code class=\"highlighter-rouge\">create(:user)</code> it is saved. Use this only when need to test find/query db.</li>\n      <li><code class=\"highlighter-rouge\">attributes_for(:user)</code> get hash of attributes so you can use in params_for\nfor example: <code class=\"highlighter-rouge\">xhr :post, users_path, user: attributes_for(:user)</code></li>\n      <li><code class=\"highlighter-rouge\">build_stubbed(:user)</code> object with all AR attributes stubbed out (like\n<code class=\"highlighter-rouge\">save</code>). It will raise an exception if they are called. Very fast since we do\nnot create AR objects. It has rails ID and we can use associations. This is\npreferred way of creating data.</li>\n    </ul>\n  </li>\n  <li>multiple records can be <code class=\"highlighter-rouge\">build_list :user, 25</code> or <code class=\"highlighter-rouge\">create_list :user, 25</code> or\n<code class=\"highlighter-rouge\">build_stubbed_list :user, 25</code></li>\n</ul>\n\n<p>You can debug factory bot in rails console. After debugging test data will stay\nin database so you need to clean it manually</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RAILS_ENV=test rake db:drop db:create db:migrate\nrails c -e test # Better to work in test so you can drop db\n\n# require \"factory_bot\" no needed if you have gem factory_bot_rails\nrequire \"./spec/factories\"\nFactoryBot.build :user\n\ninclude FactoryBot::Syntax::Methods\nbuild :user, name: 'Dule'\n\nRAILS_ENV=test rake db:drop db:create db:migrate\n</code></pre></div></div>\n\n<p>Factory bot can’t be used as seed file as suggested <a href=\"https://robots.thoughtbot.com/factory_girl-for-seed-data\">thoughtbot\npost</a> mainly because\nit is used to create new data (not to use existing) and used in a way that you\ndo should not define all attributes.</p>\n\n<p>Use fixtures for integration or complex controller tests. Use factories for unit\ntests.</p>\n\n<h1 id=\"testing-uploading-files\">Testing uploading files</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>joe.photo = File.new(File.join(Rails.root, 'spec', 'support', 'files', 'pookie.jpg'))\njoe.save!\njoe.photo_before_type_cast.should == \"pookie.jpg\"\n</code></pre></div></div>\n\n<p>For files you can use</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n</code></pre></div></div>\n\n<h1 id=\"testing-time-and-date\">Testing time and date</h1>\n\n<p>Using rails native helpers\nhttp://edgeapi.rubyonrails.org/classes/ActiveSupport/Testing/TimeHelpers.html\nUse <code class=\"highlighter-rouge\">ActiveSupport::Testing::TimeHelpers#travel</code> (usefull when you want time to\npass) and <code class=\"highlighter-rouge\">travel_to</code> <code class=\"highlighter-rouge\">travel_back</code> (time does not move for the duration of the\ntest).</p>\n\n<p>Most ActiveSupport methods (such as <code class=\"highlighter-rouge\">6.days.ago</code>) returns <code class=\"highlighter-rouge\">DateTime</code>. If you\nwant to compare with <code class=\"highlighter-rouge\">Date</code> objects than you need to convert <code class=\"highlighter-rouge\">.to_date</code>, or\nuse <code class=\"highlighter-rouge\">.to_time</code> or <code class=\"highlighter-rouge\">.to_datetime</code>. The most robust way to compare is to use\n<code class=\"highlighter-rouge\">to_s(:db)</code> for example <code class=\"highlighter-rouge\">5.days.ago.to_date.to_s(:db)</code></p>\n\n<p>When you want to set particular <code class=\"highlighter-rouge\">created_at</code> than you can do like for any other\nattribute, in fixture or update method. Sometimes for <code class=\"highlighter-rouge\">updated_at</code> you need to\nprevent rails callbacks with <code class=\"highlighter-rouge\">Project.record_timestamps = false;\n@project.updated_at = 5.days.ago; @project.save; Project.record_timestamps =\ntrue</code></p>\n\n<p>Use gem Timecop https://github.com/travisjeffery/timecop timecoop\nSimilar to mock which will return same value for all subsequent calls…</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>assert now\nTimecop.freeze(Date.today + 30) do\n  assert in one month\nend\n\n# Recomended is to use block syntax since\nTimecop.freeze(Date.today + 30)\nTime.now # will always return same value\nTime.now # will always return same value even in different test\nTimecop.return\n\n# or travel with block syntax\nTimecop.travel(Date.today + 30) do\n  Time.now # will show Date.today + 30 + 1s...\nend\n\n# Note that factory bot definitions are used before timecop, so if you have\nfactory :user do\n  renewed_at: Time.zone.today\nend\n\nTimecop.freeze Date.parse('2018-01-15') do\n  user = create :user\n  user.renewed_at # =&gt; 2018-05-05\nend\n</code></pre></div></div>\n\n<h1 id=\"using-test-doubles-as-mocks-and-stubs\">Using test doubles as mocks and stubs</h1>\n\n<p><a href=\"https://relishapp.com/rspec/rspec-mocks\">https://relishapp.com/rspec/rspec-mocks</a>\nA test double is fake object (<code class=\"highlighter-rouge\">double</code>) or method (<code class=\"highlighter-rouge\">allow</code> and\n<code class=\"highlighter-rouge\">receive</code>) used in place of real when it is:</p>\n\n<ul>\n  <li>difficult to create it (network failure)</li>\n  <li>to isolate env so it tests only specific method</li>\n  <li>to test behavior during this test (what is called and how) and not just end\nresults.</li>\n</ul>\n\n<p>We can set expectation on arguments with <code class=\"highlighter-rouge\">with</code> methods.</p>\n\n<p>A <strong>TEST DOUBLE</strong> (serbian “kaskader” or “dvojnik”) is a term for any object\nthat stands in for a real object. You can create with <code class=\"highlighter-rouge\">double</code> method and by\ndefault they are strict: any message you have not allowed or expected will\ntrigger an error.  If you do not want that exception is raised when some other\nmethod is called than you can <code class=\"highlighter-rouge\">double(:user).as_null_object</code> or <code class=\"highlighter-rouge\">spy(:user)</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># this will raise exception for user.country, but not for user.name\nuser = double(:user, name: 'Duke')\n# this will not raise exception for user.country\nuser = spy(:user)\n</code></pre></div></div>\n\n<p><strong>VERYFING DOUBLE</strong> is used to mimic specific object and check if message passed\nto double is actually real method on real object and that arguments arity is the\nsame.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>instance_user = instance_double(User)\n</code></pre></div></div>\n\n<p>There are also <code class=\"highlighter-rouge\">class_double(User)</code> and <code class=\"highlighter-rouge\">object_double(User.new)</code>.</p>\n\n<p>All those have spy forms <code class=\"highlighter-rouge\">instance_spy</code>, <code class=\"highlighter-rouge\">class_spy</code> and <code class=\"highlighter-rouge\">object_spy</code> giving\nverification that message exists without having to specify a return value.</p>\n\n<p>In RSpec 3 configuration <code class=\"highlighter-rouge\">mocks.verify_partial_doubles = true</code> will verify all\npartial doubles so you can not stub non existing method.</p>\n\n<p>A <strong>STUB</strong> is test double that returns predetermined preconfigured value for a\nmethod call (without calling actual method on actual object). It is defined\nusing <code class=\"highlighter-rouge\">allow().to receive().and_return()</code>. It can also use <code class=\"highlighter-rouge\">and_raise(Exception,\n\"message\")</code> or to provide a block to specify return value, verify arguments,\nperform calculation.\n<a href=\"https://relishapp.com/rspec/rspec-mocks/v/3-7/docs/configuring-responses\">https://relishapp.com/rspec/rspec-mocks/v/3-7/docs/configuring-responses</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>allow(thing).to receive(:name).and_return(\"Duke\")\n# you can define methods and return values in bulk\nallow(thing).to receive(first_name: 'Duke', last_name: 'Orl')\n</code></pre></div></div>\n\n<p>Stubs are used to prepare test data, and mocks are used to expect some calls.\nA <strong>MOCK</strong> is similar to stub, but it sets expectation (<code class=\"highlighter-rouge\">expect</code> instead\n<code class=\"highlighter-rouge\">allow</code>) that method will actually <strong>be called</strong> till the end of a example. It\nuse <code class=\"highlighter-rouge\">expect().to receive.and_return</code>. If it is not called, mock object triggers\ntest failure. We can also set with <strong>which arguments it should be called</strong>\n<a href=\"https://relishapp.com/rspec/rspec-mocks/v/3-5/docs/setting-constraints/matching-arguments\">https://relishapp.com/rspec/rspec-mocks/v/3-5/docs/setting-constraints/matching-arguments</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>expect(thing).to receive(:name).and_return(\"Duke\")\n\nservice_double = instance_double(CreatesProject, create: true)\n\nexpect(CreatesProject).to receive(:new)\n  .with(name: 'Duke', tasks_string: nil)\n  .and_return(service_double)\npost ...\n</code></pre></div></div>\n\n<p>A <strong>SPY</strong> is similar to mock but we set expectation later using <code class=\"highlighter-rouge\">allow().to\nreceive</code> and <code class=\"highlighter-rouge\">expect().to have_received()</code> (so we follow\nGiven/When/Then structure)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>allow(thing).to receive(:name).and_return(\"Duke\")\n# body of test\nexpect(thing).to have_received(:name)\n</code></pre></div></div>\n\n<p><strong>PARTIAL DOUBLE</strong> is when you stub particular methods of real object, a <strong>FULL\nDOUBLE</strong> is when you use totally fake object that responds only to specified API\n(<code class=\"highlighter-rouge\">double</code>) (so we do not care about behavior, only about public interface).</p>\n\n<p>You can use mocks for controller tests, so you do not need to know valid and\ninvalid params and a bug in CreatesProject will not fail this test. Usually when\nI use double to mock some class, than use small integration test to cover both\nclasses (so I know that change of class API is not an issue here). It is fine\nthat stubbed method returns a stub or double, but is not recomended that double\ncontains other stub or doubles (<code class=\"highlighter-rouge\">double(create: true, project: double(name:\n'Duke', tasks: [double(title: 'Hi')]))</code>).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.describe ProjectsController, type: :controller do\n  it \"create a project\" do\n    fake_action = instance_double(CreatesProject, create: true)\n    expect(CreatesProject).to receive(:new)\n      .with(name: 'Duke', tasks_string: nil)\n      .and_return(fake_action)\n    post :create, params: { project: { name: 'Duke' } }\n    expect(response).to redirect_to projects_path\n  end\n  it \"goes back to the form on failure\" do\n    action_stub = double(create: false, project: Project.new)\n    expect(CreatesProject).to receive(:new).and_return(action_stub)\n    post :create, params: { project: { name: 'na' } }\n    expect(response).not_to redirect_to projects_path\n  end\n  it \"fails update gracefully\" do\n    sample = Project.create!(name: \"Test Project\")\n    expect(sample).to receive(:update_attributes).and_return(false)\n    allow(Project).to receive(:find).and_return(sample)\n    patch :update, id: sample.id, project: {name: \"Fred\"}\n    expect(response).to render_template(:edit)\n  end\nend\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>usually do not stub methods that you have not written. Extract external\nservice to separate classes. Usually test double could still works but actual\nobject does not receive or return reasonable value. If you mock external code\nwhich could easilly change, than your tests will still pass. One way to deal\nwith it is to create wrappers</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Project\n  def self.create_from_controller(params)\n    create(params)\n  end\nend\n\nit \"creates a project\" do\n  allow(Project).to receive(:create_from_controller).and_return(Project.new)\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>if you need big fake objects it’s better to use stubs rather than mocks. Do\nnot need to set expectation for current test (cover that object separatelly). We\njust stub external call and use some returned value. Use mock only when you need\nto trigger sending email.</p>\n  </li>\n  <li>\n    <p>if you need to change behavior of real objects, and can’t do dependency\ninjection (<code class=\"highlighter-rouge\">process(date, validator)</code> and stub/mock on <code class=\"highlighter-rouge\">validator</code>, than you can\nuse <code class=\"highlighter-rouge\">allow_any_instance_of</code> and <code class=\"highlighter-rouge\">expect_any_instance_of</code>:</p>\n  </li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  context 'with invalid data' do\n    it 'raises Error' do\n      allow_any_instance_of(Validator).to receive(:valid?).and_return(false)\n      expect { processor.process('foo') }.to raise_error(DataProcessor::Error)\n    end\n  end\n</code></pre></div></div>\n\n<p>There is a gem than can create stub for any activerecord model\n<a href=\"https://github.com/zeisler/active_mocker\">https://github.com/zeisler/active_mocker</a></p>\n\n<h1 id=\"testing-external-service\">Testing External service</h1>\n\n<ul>\n  <li><strong>client</strong> is our app, <strong>server</strong> is external service, <strong>adapter</strong> is between\nclient and server, <strong>fake server</strong> returns a fake response</li>\n  <li><em>smoke test</em> is using real server, not used often, but could be helpfull</li>\n  <li><em>integration test</em> is using fake server</li>\n  <li><em>client unit test</em> ends at adapter</li>\n</ul>\n\n<h2 id=\"webmock\">Webmock</h2>\n<p>After installing and requiring <a href=\"https://github.com/bblimke/webmock\">webmock</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e $'/group :development, :test do/a  \\\n  gem \\'rspec-rails\\'\\\n  gem \\'webmock\\''\nbundle\nsed -i spec/rails_helper.rb -e '/require .spec_helper/a  \\\nrequire \\'support/factory_bot\\''\n</code></pre></div></div>\n\n<p>you can not make any external request <code class=\"highlighter-rouge\">WebMock::NetConnectNotAllowedError:</code> will\nbe raised and information how to stub requests will be shown which you can use\nin your <code class=\"highlighter-rouge\">before</code> of <code class=\"highlighter-rouge\">setup</code> block, or in some helper like\nhttps://github.com/nebulab/cangaroo/blob/4effc172c6ee36ccf2b844e90dcc7041035d49cc/spec/support/spec_helpers.rb#L11-L30\nYou can also save real response in  a file <code class=\"highlighter-rouge\">curl -is\nhttp://api.twitter.com/1/users/show/marnen.json &gt; tests/responses/canned_response.json</code>\nand <code class=\"highlighter-rouge\">stub_request(:get, \"api.twitter.com/1/users/show/marnen.json\").to_return(File.new 'canned_response.json'</code>\nYou can match partial query\n<a href=\"https://github.com/bblimke/webmock#matching-partial-query-params-using-hash\">hash_including</a>\nor using a block <code class=\"highlighter-rouge\">{}</code> (<code class=\"highlighter-rouge\">do end</code> wont work).</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">stub_request(method, uri)</code>, uri needs to be full (including query string) or\nuse regexp</li>\n  <li>uri, body and headers and query params can be matched agains regexp\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>stub_request(:get, '/webmock/')\nstub_request(:get, '\n`.with(body: //, headers:\n{ \"Content-Type\": // )`\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/a/webmock_helper.rb\nmodule WebmockHelper\n  SMS_URI = /control.msg91.com/\n  def stub_sms_to(mobile = \"1111111111\", messageRegexp = nil)\n    if messageRegexp\n      stub_request(:get, SMS_URI)\n        .with(query: hash_including(mobiles: mobile)) { |request| request.uri.query_values['message'] =~ messageRegexp }\n        .to_return(status: 200, body: \"376967743076313037373133\", headers: {}).times(1)\n    else\n      stub_request(:get, SMS_URI)\n        .with(query: hash_including(mobiles: mobile))\n        .to_return(status: 200, body: \"376967743076313037373133\", headers: {})\n    end\n  end\n\n  def stub_sms_and_raise(mobile = \"1111111111\", error = Net::ReadTimeout)\n    stub_request(:get, SMS_URI)\n      .with(query: hash_including(mobiles: mobile))\n      .to_raise(error)\n  end\nend\nRSpec.configure do |config|\n  config.include(WebmockHelper)\nend\n</code></pre></div></div>\n\n<p>Last reponse is repeated infinitely (times) and you can specify number of times\ngiven response should be returned. You can set expecation on how many\ntimes request has been made.</p>\n\n<p>Error like <code class=\"highlighter-rouge\">stub_request(:get, \"http://127.0.0.1:9516/shutdown\").</code> is issue with\n<a href=\"https://github.com/bblimke/webmock/issues/163#issuecomment-37257333\">spring</a>\nAlso the error</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>WebMock::NetConnectNotAllowedError: Real HTTP connections are disabled. Unregistered request: POST http://127.0.0.1:9515/session with body '{\"desiredCapabilities\":{\"browserName\":\"chrome\",\"version\":\"\",\"platform\":\"ANY\",\"javascriptEnabled\":true,\"cssSelectorsEnabled\":true,\"takesScreenshot\":false,\"nativeEvents\":false,\"rotatable\":false},\"capabilities\":{\"firstMatch\":[{\"browserName\":\"chrome\"}]}}' with headers {'Accept'=&gt;'application/json', 'Accept-Encoding'=&gt;'gzip;q=1.0,deflate;q=0.6,identity;q=0.3', 'Content-Length'=&gt;'250', 'Content-Type'=&gt;'application/json; charset=UTF-8', 'User-Agent'=&gt;'selenium/3.14.1 (ruby linux)'}\n</code></pre></div></div>\n<p>To fix you need to write initializer that call <code class=\"highlighter-rouge\">disable_net_connect!</code></p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/webmock.rb\nif Rails.env.test?\n  require 'webmock'\n  WebMock.disable_net_connect!(allow_localhost: true)\nend\n</code></pre></div></div>\n\n<p>You can not use webmock for requests in javascript (capybara tests).</p>\n\n<h2 id=\"vcr\">VCR</h2>\n\n<p>VCR records <strong>outgoing</strong> HTTP requests.\nVCR is using cassetes so you do not need to manualy stub requests using curl.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/support/vcr.rb\nVCR.configure do |config|\n  config.cassette_library_dir = \"spec/vcr_cassettes\"\n  config.hook_into :webmock\n  # config.allow_http_connections_when_no_cassette = true\n  config.ignore_localhost = true\n\n  # custom matcher ignore message\n  config.default_cassette_options = {\n    match_requests_on: [ :method,\n      VCR.request_matchers.uri_without_params(:message)]\n  }\nend\n\n# we can use implicit form with macros use_vcr_cassete, but that is deprecated,\n# use metadata\n# https://relishapp.com/vcr/vcr/v/3-0-3/docs/test-frameworks/usage-with-rspec-metadata\n</code></pre></div></div>\n\n<p>If you really need external requests you can</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/a/webmock.rb\nrequire 'webmock/rspec'\nWebMock.disable_net_connect!\nRSpec.configure do |config|\n  config.around :example, :live do |example|\n    WebMock.allow_net_connect!\n    VCR.turn_off!\n    example.run\n    VCR.turn_on!\n    WebMock.disable_net_connect!\n  end\nend\n</code></pre></div></div>\n\n<p>Use cassete inside <code class=\"highlighter-rouge\">it</code> example block</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RSpec.describe \"Location direct sms\", js: true do\n  it 'sends successfully' do\n    VCR.use_cassette \"sms_success_1111111111_cassette\" do\n      visit customer_path customer, open_chat: true\n      click_button 'Send', visible: true\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>If you allow multiple requests (for example uploading csv with multiple users\nwith same mobile number) than add <code class=\"highlighter-rouge\">allow_playback_repeats: true</code>\n<a href=\"https://relishapp.com/vcr/vcr/v/3-0-3/docs/request-matching/playback-repeats\">https://relishapp.com/vcr/vcr/v/3-0-3/docs/request-matching/playback-repeats</a></p>\n\n<p>If you are not sure if sms will be sent (it is based on some other\nconfiguration) than <code class=\"highlighter-rouge\">allow_unused_http_interactions: false</code></p>\n\n<h1 id=\"testing-railscache\">Testing Rails.cache</h1>\n\n<p>By default in <code class=\"highlighter-rouge\">config/environments/test.rb</code> we have\n<code class=\"highlighter-rouge\">config.action_controller.perform_caching = false</code>. Note that this applies only\nfor <code class=\"highlighter-rouge\">action_controller</code> so any page, fragment or custom caching still works.\nYou can disable all caching, ie caching is enabled but any write to cache is\ndiscarded with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/environments/test.rb\nRails.application.configure do\n  config.cache_store = :null_store\nend\n</code></pre></div></div>\n\n<p>I you need to test some caching (if rails state depend on cache value) than you\ncan clear (purge) cache before example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>before :each do\n  Rails.cache.clear\nend\n</code></pre></div></div>\n\n<h1 id=\"when-not-to-write-tests\">When not to write tests</h1>\n\n<ul>\n  <li>when things are too hard to test, for example setting up model that external\nservices need to use</li>\n  <li>too trivial tests</li>\n  <li>overtesting when we use same model method on severall controllers</li>\n  <li>exploratory coding (code that will not go to production)</li>\n</ul>\n\n<h1 id=\"coverage\">Coverage</h1>\n\n<p><a href=\"https://github.com/colszowka/simplecov\">https://github.com/colszowka/simplecov</a></p>\n\n<p><code class=\"highlighter-rouge\">rake stats</code> can give you LOC  Code to Test ratio, which should be 1:2 - 1:3.</p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>write tests that descibe behavior not implementation, so it does not change\nwhen implementation changes (completed? could be boolean true/false, or presence\nof completed_at),</li>\n  <li>only when dealing with edge cases you can look at implementation (time/dates\nand off-by-one error)</li>\n  <li>all unit tests should be (Rails 4 Test Prescriptions book):\n    <ul>\n      <li>Straightforward: since method should do one thing we should split tests into\nsmaller semantically meaningful parts which are easy to understand. Do not use\ntricks to write short test code, since it should be simple.</li>\n      <li>Well defined: repeatability could be problem in case of datetime, random and\nthird-party calls.</li>\n      <li>Independent: does not depend on other tests (single line of code breaks\nmultiple tests or order of test cause failure) or external data like fixtures</li>\n      <li>Fast: big startup time, dependencies that create a lot of objects, database\nusage</li>\n      <li>Truthful: do not fail while code still works (in view tests we can replace\nexact match “Some title” with “#id.class” that rarely change). or do not pass\nwhile code has an issue (mock objects)</li>\n    </ul>\n  </li>\n  <li>if you find yourself writting tests that already pass, that means you are\nwriting too much code. You shoult apply “sliming”, write only code that make\nmakes test pass</li>\n  <li>big method does not clearly separate individual steps, depend on side effects\nrher than return values.</li>\n  <li>first write initial state, than simple successful path than alternate\nsuccessful paths and than error edge cases that break code (one by one)</li>\n  <li>there is a difference between integration test (when we do not use doubles)\nand top level unit test, when we use stubs since we only test that method is\ncalling other methods, which will be unit tested separately. We could write unit\ntest for those other methods first, that is bottom up approach, we need to fake\ndata. Symetrically, top down approach is when we first write top level unit test\nand fake calls to other methods. You should cover edge cases in top level unit\ntest (using doubles), and not writting a lot of integration tests which are slow\nand more likely to fail as it needs to call all other methods.</li>\n  <li>on legacy app, when code is intertwined, there are a lot of dependencies\nbetween parts of the code, it is hard to write unit test. You can start with\nfeature tests, than write characterization test <code class=\"highlighter-rouge\">(assert(result).to\neq('correct')</code> that are used only to check old behavior, than use TDD to write\nnew tests and code, and than refactor while characterization tests keep old\nbehavior.</li>\n  <li>do not use test doubles too much when code has a lot of depencencies. It is\nbetter that test is fragile than writting/updating test double setup</li>\n</ul>\n\n<blockquote>\n  <p>Overly aggressive test doubles that set unneeded expectations are also a\ncommon cause of test fragility, so if a test fails because of an expectation\non the double, it’s useful to ask whether the expectation needs to be there in\nthe first place.</p>\n</blockquote>\n\n<ul>\n  <li>you do not need to write tests for part of the framework.</li>\n  <li>YAGNI is not used in tests</li>\n  <li>repeat Red-Green-Refactor cycle in small increments, because a lot of changes\nwill have a lot of places where code could broke. Refactoring step should not\nneed to change any tests, just code.</li>\n  <li>\n    <p>simulate network timeouts with</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># if you perform request with `res = Net::HTTP.get_response(uri)`\nexpect(Net::HTTP).to receive(:get_response).and_raise(Net::OpenTimeout)\nclick_button 'Make Request'\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"todo\">TODO:</h1>\n\n<p>Antipaterns</p>\n\n<p><a href=\"http://code.tutsplus.com/articles/antipatterns-basics-rails-tests--cms-26011\">http://code.tutsplus.com/articles/antipatterns-basics-rails-tests--cms-26011</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spect/support/geocoder.rb\nGeocoder.configure(lookup: :test)\n\nGeocoder::Lookup::Test.set_default_stub(\n  [\n    {\n      'latitude'     =&gt; 40.7143528,\n      'longitude'    =&gt; -74.0059731,\n      'address'      =&gt; 'New York, NY, USA',\n      'state'        =&gt; 'New York',\n      'state_code'   =&gt; 'NY',\n      'country'      =&gt; 'United States',\n      'country_code' =&gt; 'US',\n      'city'         =&gt; 'New York',\n    }\n  ]\n)\n</code></pre></div></div>\n\n<p>Acts as taggable</p>\n\n<p>If you have <code class=\"highlighter-rouge\">acts_as_taggable_on :cuisines</code> you can create with <code class=\"highlighter-rouge\">_list</code> method: <code class=\"highlighter-rouge\">FactoryBot.create :user, cuisine_list: ['American', 'Indian']</code>.</p>\n\n<p>In fixtures you should put only what is neccesarry to create object (only validated field) so our test do not need to know about validations when they test something different. Define all neccessary stuf (like Tags) in test on the fly. Do not let your tests depend on fixtures.</p>\n\n<p>Some references:</p>\n\n<p>guidlines <a href=\"http://betterspecs.org/\">betterspecs</a>\n<a href=\"https://github.com/thoughtbot/guides/tree/master/best-practices#testing\">thoughtbot</a></p>\n<ul>\n  <li>avoid using instance variables in tests</li>\n  <li>do not test private methods</li>\n  <li>use <a href=\"https://robots.thoughtbot.com/spy-vs-spy\">stubs and spies</a> instead of\nmocks since it clearly separate SETUP, EXERSIZE and VERIFICATION phase.</li>\n</ul>\n\n<h1 id=\"parallel-tests\">Parallel tests</h1>\n\n<p>https://github.com/grosser/parallel_tests</p>\n\n<h1 id=\"opensource-examples-with-tests\">Opensource examples with tests</h1>\n\n<p>Best source is real word rails applications\n<a href=\"https://github.com/eliotsykes/real-world-rails\">https://github.com/eliotsykes/real-world-rails</a>\nand real world rspec examples with prescriptions\n<a href=\"https://github.com/eliotsykes/rspec-rails-examples\">https://github.com/eliotsykes/rspec-rails-examples</a></p>\n\n<ul>\n  <li><a href=\"https://github.com/discourse/discourse\">https://github.com/discourse/discourse</a></li>\n  <li><a href=\"https://github.com/manshar/manshar\">https://github.com/manshar/manshar</a> rails and angular</li>\n  <li><a href=\"https://github.com/scottwillson/racing_on_rails\">https://github.com/scottwillson/racing_on_rails</a> minitests</li>\n  <li><a href=\"https://github.com/bikeindex/bike_index\">https://github.com/bikeindex/bike_index</a> rspec, api, swagger</li>\n  <li><a href=\"https://github.com/mabranches/Olympic\">https://github.com/mabranches/Olympic</a> swagger, jsonapi</li>\n  <li><a href=\"http://stackoverflow.com/questions/4421174/what-are-some-good-example-open-source-ruby-projects-that-use-cucumber-and-rspec\">http://stackoverflow.com/questions/4421174/what-are-some-good-example-open-source-ruby-projects-that-use-cucumber-and-rspec</a></li>\n</ul>\n\n<p>clean https://github.com/ni3t/tweetfire\nhttps://github.com/elizabrock/coursewareofthefuture exaples for all tests</p>\n\n<h1 id=\"live-coding-and-other-video-tutorials\">Live Coding and other video tutorials</h1>\n\n<ul>\n  <li><a href=\"https://www.youtube.com/watch?v=Q00H6BPVNQI&amp;list=PL6XWIjBFDFOIiJyDK61thx6ILIbaUMEAb\">Advance API Phil\nSturgeon list</a> author of Building APIs your won’t hate</li>\n  <li><a href=\"https://www.youtube.com/watch?v=jk016koiMAI\">gregg pollack and carlos souza</a>\nminispec rails api</li>\n  <li><a href=\"https://www.youtube.com/playlist?list=PL93_jRSrU7hzEUNmevlnMeUx6F35Za638\">Sean Devine Live code a charity auction\napplication</a>\n<a href=\"https://github.com/barelyknown/charity_auction-server\">source code</a></li>\n  <li><a href=\"https://www.youtube.com/watch?v=sj5TXzgZ1Sk\">thoughbot workshop intro to tdd</a> also <a href=\"https://www.youtube.com/watch?v=8368hGNIJMQ\">mocking</a></li>\n  <li><a href=\"https://www.youtube.com/watch?v=H1Czc3NL4c4\">matt smith</a></li>\n  <li><a href=\"https://www.youtube.com/watch?v=9f08KzNO4qo\">Paul Hiatt</a></li>\n  <li><a href=\"http://railscasts.com/episodes?utf8=%E2%9C%93&amp;search=test\">Railscasts</a></li>\n  <li><a href=\"https://www.youtube.com/watch?v=YjHKetQxk5I\">Mocking Luca Pradovera</a></li>\n  <li><a href=\"https://www.youtube.com/watch?v=CDC7zA8a-mA\">Carlos Souza</a></li>\n</ul>\n\n<p>Rspec book <a href=\"http://www.betterspecs.org/\">http://www.betterspecs.org/</a></p>\n\n<ul>\n  <li><a href=\"https://www.youtube.com/watch?v=URSWYvyc42M\">sandy metz</a></li>\n</ul>\n\n<p>Improve speed of the tests</p>\n\n<p>https://github.com/palkan/test-prof</p>\n\n<p>TODO</p>\n\n<p>https://player.fm/series/series-1401837/46-joe-ferris-test-driven-rails\nhttps://www.youtube.com/watch?v=yTkzNHF6rMs\nhttps://vimeo.com/44807822\nhttps://www.youtube.com/watch?v=9f08KzNO4qo\nhttps://m.patrikonrails.com/how-i-test-my-rails-applications-cf150e347a6b\nhttps://robots.thoughtbot.com/headless-feature-specs-with-chrome\nhttps://building.buildkite.com/5-ways-weve-improved-flakey-test-debugging-4b3cfb9f27c8\n<a href=\"http://blog.arkency.com/2017/06/acceptance-testing-ruby-using-actors-personas\">aceptance\ntesting</a>\neasy system testings https://rlafranchi.github.io/system_tester/</p>\n\n"
    } ,
  
    {
      "title"    : "Ruby Books",
      "category" : "",
      "tags"     : "",
      "url"      : "/2015/11/07/ruby-books/",
      "date"     : "2015-11-07 00:00:00 +0100",
      "content"  : "<p>Here is what I did not think about long time ago so I am writting here to better\nmemorize.</p>\n\n<p>But first, more imporant is to list Resources:</p>\n\n<ul>\n  <li>http://ruby-doc.com/docs/ProgrammingRuby/</li>\n  <li>https://en.wikibooks.org/wiki/Ruby_Programming</li>\n  <li>http://www.toptal.com/ruby-on-rails</li>\n  <li>http://www.toptal.com/ruby</li>\n  <li><a href=\"http://www.rubyist.net/~slagell/ruby/\">Ruby User’s Guide</a></li>\n  <li><a href=\"http://www.sapphiresteel.com/ruby-programming/The-Book-Of-Ruby.html\">The Book Of\nRuby</a> or\nshorter version <em>The Little Book Of Ruby</em></li>\n</ul>\n\n<p>Listing free books:</p>\n\n<ul>\n  <li>http://www.allrubybooks.com/</li>\n  <li>https://www.ruby-lang.org/en/documentation/</li>\n  <li>http://www.e-booksdirectory.com/programming.php</li>\n  <li>http://www.dmoz.org/Computers/Programming/Languages/Ruby/</li>\n  <li>http://iwanttolearnruby.com/</li>\n  <li>https://rubymonk.com/</li>\n  <li>\n    <p>github list of books\n<a href=\"https://github.com/EbookFoundation/free-programming-books/blob/master/free-programming-books.md#professional-development\">https://github.com/EbookFoundation/free-programming-books/blob/master/free-programming-books.md#professional-development</a>\nBundle</p>\n  </li>\n  <li>http://www.railsbookbundle.com/</li>\n  <li>http://rubybookbundle.com/</li>\n  <li>awesome coding style guides <a href=\"http://awesome-ruby.com/#-coding-style-guides\">http://awesome-ruby.com/#-coding-style-guides</a></li>\n</ul>\n\n<p>Questions</p>\n\n<ul>\n  <li><a href=\"https://gist.github.com/ryansobol/5252653\">https://gist.github.com/ryansobol/5252653</a> 15 questions</li>\n</ul>\n\n<h1 id=\"ruby\">Ruby</h1>\n\n<h2 id=\"object-and-classes\">Object and classes</h2>\n\n<p>As everything in Ruby is object, so <code class=\"highlighter-rouge\">class A;end</code> is also object with type\nClass.  Instead of keyword <code class=\"highlighter-rouge\">class</code> we can create a class object with <code class=\"highlighter-rouge\">a =\nClass.new</code> and instance with <code class=\"highlighter-rouge\">o = a.new</code>. <code class=\"highlighter-rouge\">class Name;end</code> defines constant\n<code class=\"highlighter-rouge\">Name</code> which holds class object.  Class <code class=\"highlighter-rouge\">Class</code> extends a class called <code class=\"highlighter-rouge\">Module</code>\nie <code class=\"highlighter-rouge\">A.class.superclass #=&gt; Module</code>. That is why classes has more features than\nmodules (can be instantied, can be extended by other classes). On other side,\nmodule can be included (ie all module’s instance methods become avaiable as\ninstance methods in the class) very similar to inheritance. Module can also be\nextended (ie all module’s instance methods become class methods). Also usefull\nis that module extends self <code class=\"highlighter-rouge\">module M; extend self; def m;end;end</code> so you can\nuse <code class=\"highlighter-rouge\">M.m</code> instead of <code class=\"highlighter-rouge\">M::m</code>.\nYou can see all superclasses and mixin modules with\n<a href=\"http://ruby-doc.com/docs/ProgrammingRuby/html/ospace.html\">A.ancestors</a>.\nModule class object have <code class=\"highlighter-rouge\">new</code> method, but it’s instance (Module instance) does\nnot have (on other hand <code class=\"highlighter-rouge\">Class</code> object <code class=\"highlighter-rouge\">a = Class.new</code> have <code class=\"highlighter-rouge\">a.new</code> method).\nYou can see all constants for particular class <code class=\"highlighter-rouge\">Object.constants; A.constants</code></p>\n\n<p>Ruby gems use <code class=\"highlighter-rouge\">self.included</code> hook to modify class that is including a module\n(Rails version of this is <code class=\"highlighter-rouge\">ActiveSupport::Concern</code>). So when you include some\nmodule in your class, beside instance methods, it will extend and add some class\nmethods as well. For example\n<a href=\"https://gist.github.com/duleorlovic/724b8ab1eb44d7f847ee\">Linkable</a></p>\n\n<p>For rails concerns you can see <a href=\"/2016/04/12/rails-tips/#concerns\">concerns</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>module Emailable\n  included do\n    # before_ has_ macros\n  end\n\n  # instance methods\n\n  def ClassMethods\n  end\n</code></pre></div></div>\n\n<p>Singleton mixin is used when you want to disallow multiple instance of some\nclass, ie we set <code class=\"highlighter-rouge\">private_class_method :new</code>, and create it in some other class\nmethod <code class=\"highlighter-rouge\">def Logger.create;@@loger = new unless @logger;end</code></p>\n\n<p><code class=\"highlighter-rouge\">true.class # TrueClass</code> there is only one copy of these objects (true, false,\nnil). This is example of singleton pattern.</p>\n\n<p>Access:</p>\n\n<ul>\n  <li>public methods can be called by anyone, all methods are public by default\n(except <code class=\"highlighter-rouge\">initialize</code> which is private)</li>\n  <li>protected methods can be invoked by anyone (explicit receiver), but only\nwithin context of methods of defining class or its subclasses (at calling time\nself is from same class hierarchy) <code class=\"highlighter-rouge\">a=A.new;a.protected_method</code> does not work\nif the call is outside of instance-method for A, but we can extend the class\nand than call it <code class=\"highlighter-rouge\">class B&lt;A;def call_protected_method_for_a_and_self(a);\na.protected_method;protected_method;end;end</code>\n<code class=\"highlighter-rouge\">B.new.call_protected_method_for_a_and_self(a)</code>. Protected is like private but\ncaller (self) and receiver object are from same class inheritance.</li>\n  <li>private methods can be called only for that object in defining class or\nsubclasses. Can not be called with explicit receiver: <code class=\"highlighter-rouge\">a.private_method</code> does\nnot work, only exception is that you can call private writter method with\nexplicit receiver as long as the receiver is exactly the self <code class=\"highlighter-rouge\">self.value=1</code>.\nSo private methods can be called inside any method of descendand class <code class=\"highlighter-rouge\">class\nB&lt;A;def p;private_method_from_A;end;end</code>. Note that top-level methods are\nprivate instance method of Object class. Thats why thay can be easily called\nin bareword style (no explicit receiver).</li>\n</ul>\n\n<p>Methods:</p>\n\n<ul>\n  <li>top-level methods (outside of any definition block) are private to all objects</li>\n  <li>instance-method in class <code class=\"highlighter-rouge\">class C;def m;self;end;end;</code> self is instance of C</li>\n  <li>instance-method in module <code class=\"highlighter-rouge\">module M;def m;end;end;</code> self is object extended by\nM or instance of class that mixes in M</li>\n  <li>singleton method on specific object <code class=\"highlighter-rouge\">def obj.m;self;end</code> self is that obj</li>\n  <li>class definition <code class=\"highlighter-rouge\">class C;puts self;def self.class_method;self;end;end</code> self\nin both class definition (singleton on class object) and class method is class\nobject</li>\n  <li>module definition is the same as class definition</li>\n</ul>\n\n<p>When you call <code class=\"highlighter-rouge\">some_method</code> it is called on current self <code class=\"highlighter-rouge\">self.some_method</code>.\nOnly place where you need self is assignment <code class=\"highlighter-rouge\">self.some_identifier = 1</code>.</p>\n\n<p><code class=\"highlighter-rouge\">load \"filename.rb\"</code> includes that resource every time method is executed (like\ncopy paste code), but <code class=\"highlighter-rouge\">require</code> only once and only when needed. <code class=\"highlighter-rouge\">ruby -e 'puts\n$:'</code> will list all load paths. <code class=\"highlighter-rouge\">load</code> is usefull to overwrite with new changes\nof a particular file.</p>\n\n<p><code class=\"highlighter-rouge\">require</code> is more suitable for features (no need <code class=\"highlighter-rouge\">.rb</code>).  It does not know for\ncurrent folder, so you need to use <code class=\"highlighter-rouge\">./</code> dot that explicitly define path <code class=\"highlighter-rouge\">require\n\"./f.rb\"</code> or <code class=\"highlighter-rouge\">$: &lt;&lt; \".\"</code> or <code class=\"highlighter-rouge\">require_relative \"f\"</code>(extension is not needed\n<code class=\"highlighter-rouge\">.rb</code>)</p>\n\n<p>Variables are not objects. They just hold a reference to objects. You can use\n<code class=\"highlighter-rouge\">var.dup</code> to create another object or you can <code class=\"highlighter-rouge\">var.freeze</code> to prevent\nmodifications. <code class=\"highlighter-rouge\">var.clone</code> is the same as <code class=\"highlighter-rouge\">dup</code> but if you clone freezed object,\nresult is also freezed. <code class=\"highlighter-rouge\">freeze</code> is only one level, nested objects are not\nfreezed <code class=\"highlighter-rouge\">a=[\"a\",\"b\"];a.freeze;a[0][0]='b'</code> or <code class=\"highlighter-rouge\">a={a:{b:1}};a.freeze;a[:a][:b]=2</code></p>\n\n<p>Ruby look up for methods for current object metaclass (eigenclass) than in\nancestors classes. Object metaclass contains those singleton methods defined\nonly for that particular object after it was created <code class=\"highlighter-rouge\">o={};def o.t;puts\n1;end;o.t()</code> - common in GUI - different action for different buttons.</p>\n\n<p>Module can be mixed in in two ways: <code class=\"highlighter-rouge\">include M</code> and <code class=\"highlighter-rouge\">prepend M</code>. Methods are\nsearched in prepend modules, than in class methods and than in included methods.\nLast defined (first time, multiple includes do not have effect) module is\nsearched first, the same as with same_name methods in class definition. You can\nsee the order of modules with <code class=\"highlighter-rouge\">C.ancestors</code> (prepended, class, included,\nprepended of superclass, superclass, included of superclass). <code class=\"highlighter-rouge\">super</code> calls the\nsame method at upper level. Since modules don’t have instances they generally\nrepresent properties of something of some class, and they have adjective names\n(albeit class tend to be nouns). Modules also can be used for namespacing some\nclasses. When we see <code class=\"highlighter-rouge\">M::C</code> we don’t know if <code class=\"highlighter-rouge\">C</code> is constant, module or class,\nbut <code class=\"highlighter-rouge\">M</code> is a class or module since it has nested items.</p>\n\n<p>Proc are objects that can be called (executed) <code class=\"highlighter-rouge\">p = proc { puts 1 };p.call</code></p>\n\n<p>Variables and scope</p>\n\n<p>Ruby define scope of variable using its name, precisely, first char:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">$</code> global <code class=\"highlighter-rouge\">$FIRST_NAME</code> available on every scope</li>\n  <li><code class=\"highlighter-rouge\">@</code> instance <code class=\"highlighter-rouge\">@first_name</code> you can list with <code class=\"highlighter-rouge\">self.instance_variables</code> and\nget value with <code class=\"highlighter-rouge\">self.instance_variable_get :@first_name</code> (note that we need\nboth <code class=\"highlighter-rouge\">:</code> and <code class=\"highlighter-rouge\">@</code>) and set value <code class=\"highlighter-rouge\">self.instance_variable_set :@first_name,\n'me'</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">[a-z]|_</code> local <code class=\"highlighter-rouge\">first_name</code> in every definition block: proc, loop, def end,\nclass end, module end, and is reset on each call. Local variable is very\nscoped (you can not access in another nested method)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = 1\ndef p\n  puts a\nend\np # NameError: undefined local variable 'a'\n</code></pre></div>    </div>\n\n    <p>but you can access from closure definitions such: <code class=\"highlighter-rouge\">define_method</code>, <code class=\"highlighter-rouge\">proc</code> or\n<code class=\"highlighter-rouge\">lambda</code> or plain old <code class=\"highlighter-rouge\">begin end</code> block</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">[A-Z]</code> constant <code class=\"highlighter-rouge\">FIRST_NAME</code> (only exception is <code class=\"highlighter-rouge\">nil</code> which is constant and\n<code class=\"highlighter-rouge\">self</code> which is global maintaned by interpreter). Constant can be changed\n(with warning) so you can include one file several times. Object that\nconstant reffers can be changed freely. Constant has global reachability\nwhen you know the chain of nested definition <code class=\"highlighter-rouge\">C::M::X</code>, absolute path is\n<code class=\"highlighter-rouge\">::String</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">@@</code> class variable <code class=\"highlighter-rouge\">@@class_variable</code> are shared only between class and all\ninstances of that class. Instance variable for class object are not\navailable in instances of class so can not be shared between instances :(\nalso globals and constants can be changed everywhere so that’s bad too.\nIt can be used in class definition, class methods and instance methods. It\nis shared with all ancestor classes so better is to store data at class\nobject instance and create attr_accessor for that.\n<a href=\"https://apidock.com/ruby/Module/class_variable_set\">class_variable_set</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Fred\n  @@foo = 99\n  def foo\n    @@foo\n  end\nend\nFred.class_variable_set(:@@foo, 101)     #=&gt; 101\nFred.new.foo                             #=&gt; 101\n</code></pre></div>    </div>\n\n    <p>In rails 5.2 we can have <code class=\"highlighter-rouge\">class_attribute :settings, default: {}</code> so you can\nuse <code class=\"highlighter-rouge\">MyClass.settings = 'asd'</code> which will set <code class=\"highlighter-rouge\">@@settings = 'asd'</code>.</p>\n  </li>\n</ul>\n\n<p>Every method call create its own local scope. Ruby does some preprocessing\ncompile time where it recognizes all local variables (class @@x instance @x and\nglobal $x are recognized by their appearance)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>if false\n  x = 1\nend\nputs x # x is created but not assigned\nputs y # Fatal error: y is unknown\n</code></pre></div></div>\n\n<p>In recursion, self is the same but scope is generated each time. But procedure\nlocal objects share the same scope with parent. That way we can create something\nsimilar to closures to simulate classes.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ruby&gt; def box\n    |   contents = nil\n    |   get = proc{contents}\n    |   set = proc{|n| contents = n}\n    |   return get, set\n    | end\n   nil\nruby&gt; reader, writer = box\n   [#&lt;Proc:0x40170fc0&gt;, #&lt;Proc:0x40170fac&gt;]\nruby&gt; reader.call\n   nil\nruby&gt; writer.call(2)\n   2\nruby&gt; reader.call\n   2\n</code></pre></div></div>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">attr_accessor :price</code> creates getter and setter method. its better to write\nall instance variable like that at beggining so we know what defines state\n(in rails when including <code class=\"highlighter-rouge\">ActiveModel::Model</code> you can call <code class=\"highlighter-rouge\">Model.new\nmodel_params</code> and those accessor will be assigned, ie no need to write\ninitialized and manually assign)</li>\n  <li>required and optional arguments for methods <code class=\"highlighter-rouge\">def f(a, b=1, *c, d)</code> prefix\nasterix means that all other arguments will be sponged up an array <code class=\"highlighter-rouge\">c</code>. <code class=\"highlighter-rouge\">a</code>\nand <code class=\"highlighter-rouge\">d</code> are required, ie you can not call <code class=\"highlighter-rouge\">f(1)</code>. <code class=\"highlighter-rouge\">b</code> has default value</li>\n  <li>\n    <p><a href=\"http://docs.ruby-lang.org/en/2.2.0/Matrix.html#method-c-5B-5D\">matrix</a> <code class=\"highlighter-rouge\">[]=</code>\nis private but we can\n<a href=\"http://stackoverflow.com/questions/12683772/how-to-modify-a-matrix-ruby-std-lib-matrix-class/21559458#21559458\">open</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Matrix\n  public :\"[]=\", :set_element, :set_component\nend\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">(1..10).tap {|x| puts x.inspect}.to_a</code> is used to perfom operation on\nintermediate results of operations. It returns object <code class=\"highlighter-rouge\">x</code>. Usually used with\ninitialization of objects: <code class=\"highlighter-rouge\">Class.new(name: name).tap do |c| ... end</code></li>\n</ul>\n\n<p>#loops</p>\n\n<h1 id=\"keywords\">Keywords</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">C.superclass # =&gt; Object</code> shows superclass</li>\n  <li><code class=\"highlighter-rouge\">ruby -e \"class C;end;puts C.ancestors\" # [C, Object, Kernel, BasicObject]</code>\nshows mixed in modules <code class=\"highlighter-rouge\">Kernel</code> and superclases</li>\n  <li><code class=\"highlighter-rouge\">C.public_method_defined? 'my_method'</code> to chech if method is defined</li>\n  <li><code class=\"highlighter-rouge\">echo \"puts RbConfig::CONFIG['sitedir']\" | ruby - | xargs ls -R</code> will show all\nC extensions (.so files). Use <code class=\"highlighter-rouge\">CONFIG[\"site_ruby\"]</code> to list libraries.</li>\n  <li>global variables <code class=\"highlighter-rouge\">$0</code> filename, <code class=\"highlighter-rouge\">$$</code> processID, <code class=\"highlighter-rouge\">$:</code> or <code class=\"highlighter-rouge\">$LOAD_PATH</code> paths\n(you can add folder to load path with <code class=\"highlighter-rouge\">$:.unshift 'lib'</code> or <code class=\"highlighter-rouge\">$: &lt;&lt; '.'</code>)</li>\n  <li><code class=\"highlighter-rouge\">defined? a</code> is operator that can say if variable is defined.</li>\n  <li><code class=\"highlighter-rouge\">ruby -e 'p Kernel.private_instance_methods.sort'</code> prints all usefull script\ncommands (require, load, raise)</li>\n  <li><code class=\"highlighter-rouge\">puts caller</code> to print callstack</li>\n  <li><code class=\"highlighter-rouge\">p method(:my_method).source_location</code> to find method implementation. To print\nmethod source you can use <code class=\"highlighter-rouge\">user.method(:name).source.display</code></li>\n  <li>\n    <p>if <code class=\"highlighter-rouge\">method</code> is overwritten in some class, we can unbind from kernel and\nrebind to request object\n<a href=\"https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html\">link</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>method = Kernel.instance_method(:method)\np method.bind(request).call(:headers).source_location\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>to list all methods that are called from <code class=\"highlighter-rouge\">render</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def index\n  @users = User.all\n  tp = TracePoint.new(:call) do |x|\n    p x\n  end\n  tp.enable\n  render 'index'\nensure\n  tp.disable\nend\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">{}</code> and <code class=\"highlighter-rouge\">do end</code> have <a href=\"https://github.com/bbatsov/rubocop/issues/1520\">different\nprecedence</a> so when rubocop\nalerts for <code class=\"highlighter-rouge\">Style/Lambda: Use the </code>lambda<code class=\"highlighter-rouge\"> method for multi-line lambdas</code> you\nneed parenthesis for example <code class=\"highlighter-rouge\">scope :active, (lambda do ... end)</code></li>\n  <li><code class=\"highlighter-rouge\">! a == b</code> is not the same as <code class=\"highlighter-rouge\">a != b</code></li>\n  <li>you should memoize with <code class=\"highlighter-rouge\">return @current_isp if defined? @current_isp</code> instead\nof <code class=\"highlighter-rouge\">@current_isp ||= blabla; return @current_isp</code> since it handles <code class=\"highlighter-rouge\">false</code>\nvalue as well (it will not rerun the check if @current_isp = false)</li>\n  <li>\n    <p>when you iterate over some hashes you can assign variables with <code class=\"highlighter-rouge\">name:</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[{name: 'Duke', value: 1},].each do |name:, value:|\n  puts name, value\nend\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>big multiline strings can be concatenated from lines similar to HERE_DOC. It\nwill show <code class=\"highlighter-rouge\">\\n</code> and will insert spaces because text is indented. There is\n<code class=\"highlighter-rouge\">~HERE_DOC</code> version to strip spaces for all lines based on first line indent.\nMinus in <code class=\"highlighter-rouge\">&lt;&lt;-HERE_DOC</code> means that it will not strip spaces based on first line.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>MY_TEMPLATE = <span class=\"nt\">&lt;</span><span class=\"err\">&lt;</span><span class=\"na\">HTML</span>\n  <span class=\"err\">&lt;</span><span class=\"na\">html</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;/html&gt;</span>\nHTML\n\nMY_TEMPLATE #=&gt; \"  <span class=\"nt\">&lt;html&gt;</span>\\n  <span class=\"nt\">&lt;/html&gt;</span>\\n\"\n\nINDENT = <span class=\"nt\">&lt;</span><span class=\"err\">&lt;~</span><span class=\"na\">HERE_DOC</span>\n  <span class=\"na\">1</span>\n    <span class=\"na\">2</span>\n  <span class=\"na\">3</span>\n<span class=\"na\">HERE_DOC</span>\n\n<span class=\"na\">INDENT</span> <span class=\"err\">#=</span><span class=\"nt\">&gt;</span> \"1\\n  2\\n3\\n\"\n\n# also without assignment\ndef html_boilerplate\n  <span class=\"nt\">&lt;</span><span class=\"err\">&lt;~</span><span class=\"na\">HTML</span>\n  <span class=\"na\">HTML</span>\n<span class=\"na\">end</span>\n\n<span class=\"err\">#</span> <span class=\"na\">you</span> <span class=\"na\">can</span> <span class=\"na\">create</span> <span class=\"na\">single</span> <span class=\"na\">line</span> <span class=\"na\">from</span> <span class=\"na\">it</span>\n<span class=\"na\">sql = </span><span class=\"s\">&lt;&lt;-SQL.gsub(\"\\n\",</span> <span class=\"err\">'</span> <span class=\"err\">').</span><span class=\"na\">squish</span>\n  <span class=\"na\">SELECT</span> <span class=\"na\">MIN</span><span class=\"err\">(</span><span class=\"na\">u</span><span class=\"err\">.</span><span class=\"na\">popularity</span><span class=\"err\">)</span>\n  <span class=\"na\">FROM</span> <span class=\"na\">users</span> <span class=\"na\">u</span>\n  <span class=\"na\">WHERE</span>\n    <span class=\"na\">u</span><span class=\"err\">.</span><span class=\"na\">created_at</span> <span class=\"err\">&lt;=</span> <span class=\"err\">#{</span><span class=\"na\">Time</span><span class=\"err\">.</span><span class=\"na\">now</span><span class=\"err\">}</span> <span class=\"na\">AND</span> <span class=\"na\">u</span><span class=\"err\">.</span><span class=\"na\">created_at</span> <span class=\"nt\">&gt;</span>= #{Time.now - 7.days}\nSQL\n\n# you can pass as parameter to method\n  Person.joins(<span class=\"nt\">&lt;</span><span class=\"err\">&lt;</span><span class=\"na\">-SQL</span><span class=\"err\">).</span>\n    <span class=\"na\">LEFT</span> <span class=\"na\">JOIN</span> <span class=\"na\">people</span> <span class=\"na\">managers</span>\n      <span class=\"na\">ON</span> <span class=\"na\">managers</span><span class=\"err\">.</span><span class=\"na\">id = </span><span class=\"s\">people.manager_id</span>\n  <span class=\"na\">SQL</span>\n  <span class=\"na\">where</span><span class=\"err\">(</span><span class=\"na\">managers:</span> <span class=\"err\">{</span> <span class=\"na\">id:</span> <span class=\"na\">Person</span><span class=\"err\">.</span><span class=\"na\">find_by</span><span class=\"err\">!(</span><span class=\"na\">name:</span> <span class=\"err\">'</span><span class=\"na\">Eve</span><span class=\"err\">')</span> <span class=\"err\">})</span>\n</code></pre></div>    </div>\n\n    <p>Same HERE_DOC functionality can be achieved with <code class=\"highlighter-rouge\">%()</code> or <code class=\"highlighter-rouge\">%Q()</code> with\ninterpolation (downcase <code class=\"highlighter-rouge\">%q()</code> is without interpolation, same as <code class=\"highlighter-rouge\">'HTML'</code>).\nIndent is important since lines are joined with <code class=\"highlighter-rouge\">\\n</code>.  First character is not\nimportant <code class=\"highlighter-rouge\">%Q()</code> is the same as <code class=\"highlighter-rouge\">%Q{}</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>my_str = %(\nThis is multiline\n1 + 1 is #{1+1}\n)\n</code></pre></div>    </div>\n\n    <p>You can also write as single line strings (long line), without new line <code class=\"highlighter-rouge\">\\n</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>string = \"this is a \\\n          long string with a lot of spaces\"\nstring = \"this is also one \"\\\n         \"long string but without spaces\"\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p><code class=\"highlighter-rouge\">%W</code> and <code class=\"highlighter-rouge\">%w</code> returns arrays (interpolated or not). Same is with\n<code class=\"highlighter-rouge\">HERE_DOC.split</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&gt;&gt; %W(#{foo} Bar Bar\\ with\\ space)\n=&gt; [\"Foo\", \"Bar\", \"Bar with space\"]\n \n&gt;&gt; %w(#{foo} Bar Bar\\ with\\ space)\n=&gt; [\"\\#{foo}\", \"Bar\", \"Bar with space\"]\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">%x(pwd)</code> is used to call system bash commands. Use Open3 to call system shell\ncommands\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'open3'\nstdout, stderr, status = Open3.capture3(\"sleep 10\")\n</code></pre></div>    </div>\n\n    <p>capture3 will wait for all output, even you use ampersand <code class=\"highlighter-rouge\">sleep 10 &amp;</code> at the\nend of command. You can use <code class=\"highlighter-rouge\">system 'sleep 10 &amp;'</code> to get immediatelly back to\nruby. Also spawn</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pid = spawn('sleep 3') #=&gt; 45376\n# do something while process is running\nProcess.wait pid # wait for process to finishs\n</code></pre></div>    </div>\n\n    <p>Also Open3.capture3 can return back from background process if you\ndont use <code class=\"highlighter-rouge\">stdout.read</code> and use ampersand (sometimes do not block event without\nampersand).\nhttps://www.rubydoc.info/stdlib/open3/Open3.popen3</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># tmp/r.rb\n# run with: ruby tmp/r.rb\nrequire 'open3'\nputs 'start'\n# system 'sleep 10 &amp;'\nstdin, stdout, stderr, wait_thr = Open3.popen3('sleep 10 &amp;&amp; ls &amp;')\npid = wait_thr[:pid]  # pid of the started process\nstdin.close # stdin, stdout and stderr should be closed explicitly in this form.\n# if you uncommend this line, than it will wait for output\n# puts stdout.read\nstdout.close\nstderr.close\nexit_status = wait_thr.value  # Process::Status object returned.\nputs 'end'\n</code></pre></div>    </div>\n\n    <p>Another solution to run in background is using <code class=\"highlighter-rouge\">IO</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'open3'\nrequire 'byebug'\n\nputs \"start in #{Process.pid}\"\ncmd = 'touch tmp/txt &amp;&amp; sleep 10 &amp;&amp; ls'\nio = IO.popen cmd\nputs \"cmd started in #{io.pid}\"\n# does not exist the loop\n# begin\n#   while true do\n#     Process.getpgid io.pid\n#     printf '.'\n#     sleep 1\n#   end\n# rescue Errno::ESRCH\n#   puts 'cmd exits'\n# end\nProcess.wait io.pid\nputs 'end'\n</code></pre></div>    </div>\n\n    <p>Also <code class=\"highlighter-rouge\">Process.fork { sleep 1 }</code>\nhttps://ruby-doc.org/core-2.1.3/Process.html#method-c-exit</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Process.kill(\"HUP\", pid)\n</code></pre></div>    </div>\n  </li>\n  <li>to send some data as json you can do it <code class=\"highlighter-rouge\">user.templates.map {|t| t.slice :id,\n:name}.to_json</code></li>\n  <li>return multiple values from method, you can use arrays and <code class=\"highlighter-rouge\">a, b = method</code> but\nit is better to create new class for result.</li>\n  <li>if your service needs a lot of validation, raise exceptions to return message.\nLook at <a href=\"/2016/04/12/rails-tips/\">rails tips service example</a>.</li>\n  <li>its convetion to use keyword <code class=\"highlighter-rouge\">fail</code> instead of <code class=\"highlighter-rouge\">raise</code> (it is used only if you re-raise exception)</li>\n  <li>ruby caret operator <code class=\"highlighter-rouge\">^</code> is bitwise XOR, if you want square use power\n(exponent) <code class=\"highlighter-rouge\">**</code></li>\n  <li>\n    <p>if you do not know where something is called, for example some validation\nerrors is added, you can dynamically extend objects\n<a href=\"http://blog.iempire.ru/2016/09/23/breaking-points\">link</a>. So create module in\nruntime and extend the object or class, so it will stop on next <code class=\"highlighter-rouge\">errors#add</code>\nmethod</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mod = Module.new do\n  def add(*args)\n    binding.pry\n    super\n  end\nend\ncredit_card.errors.extend(mod)\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>you can open singleton_class of the object and redefine</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>num = Object.new\nnum.instance_exec {\n  def == other\n    other == 3\n  end\n}\nnum == 4\n# =&gt; false\nnum == 3\n# =&gt; true\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>you can open a class with module_exec</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Thing\nend\n\nThing.module_exec(arg) do |arg|\n  def hello\n    \"Hi\"\n  end\nend\n\nputs Thing.new.hello\n</code></pre></div>    </div>\n  </li>\n  <li>get class based on string <code class=\"highlighter-rouge\">klass = Object.const_get \"User\"</code></li>\n  <li>get constant of class <code class=\"highlighter-rouge\">User::MAX</code>, <code class=\"highlighter-rouge\">User.const_get 'MAX'</code> or\n<code class=\"highlighter-rouge\">user.class.const_get :MAX</code>. To check if exists use <code class=\"highlighter-rouge\">const_defined?</code></li>\n  <li>random number <code class=\"highlighter-rouge\">[*1..100].sample</code></li>\n  <li>iterate over elements until first match <code class=\"highlighter-rouge\">a.take_while {|i| i &lt; 3}</code></li>\n  <li>get a class from value <code class=\"highlighter-rouge\">my_string.constantize</code></li>\n  <li>\n    <p>you can call lambda in different ways</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>my_lambda = -&gt; { puts \"hi\" }\n\nmy_lambda.call # preferred\nmy_lambda[]\nmy_lambda.()\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>lamda are strict about arguments but procs are not</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>my_lambda = -&gt;(a, b)  { a + b }\nmy_proc   = Proc.new  { |a, b| a + b }\n\nmy_lambda.call(2)\n# ArgumentError: wrong number of arguments (1 for 2)\n\nmy_proc.call(2)\n# TypeError: nil can't be coerced into Fixnum\n</code></pre></div>    </div>\n  </li>\n  <li>you can find method using grep <code class=\"highlighter-rouge\">o.methods.grep /iden/</code></li>\n  <li>you can list all instance methods in current class but not in parrent class\nwith <code class=\"highlighter-rouge\">o.methods - o.class.superclass.instance_methods</code></li>\n  <li>in rails it is enough to exclude all default object methods <code class=\"highlighter-rouge\">o.methods -\nObject.methods</code></li>\n</ul>\n\n<h1 id=\"irb\">Irb</h1>\n\n<ul>\n  <li>\n    <p>to suppress out of commands use <code class=\"highlighter-rouge\">;</code> in irb</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require 'rest-client'\nRestClient.get('blackbytes.info');\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>underscore variable <code class=\"highlighter-rouge\">_</code> holds value of the last command. When used in code\nthan it means we are not going to use it.</p>\n  </li>\n</ul>\n\n<h1 id=\"expections\">Expections</h1>\n\n<ul>\n  <li><a href=\"https://www.youtube.com/watch?v=BlTjn_SZQT0\">exception ruby video</a></li>\n  <li>\n    <p>before ruby program exists it uses some callbacks</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>trap(\"EXIT\") { puts 'trap(\"EXIT\")' }\nat_exit { puts \"at_exit\" }\nEND { puts \"END\" }\nraise \"Not handled\"\n\noutput:\n\ntrap(\"EXIT\")\nEND\nat_exit\na.rb:4:in `&lt;main&gt;': Not handled (RuntimeError)\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"procs\">Procs</h1>\n\n<p><a href=\"https://en.wikibooks.org/wiki/Ruby_Programming/Syntax/Method_Calls#Understanding_blocks.2C_Procs_and_methods\">https://en.wikibooks.org/wiki/Ruby_Programming/Syntax/Method_Calls#Understanding_blocks.2C_Procs_and_methods</a>\nUsing Proc ruby can be used in functional programming (it enable first-class\nfunctions - function can be created at runtime, assigned to variable, passed as\nargument and be return value from other functions).\nRuby differs from other functional languages for which we can use name of\nfunction as variable with function type (in ruby we need to use Proc).\nFirst-class functions can be used for higher-order functions (functions which\ntakes other functions as arguments).</p>\n\n<blockquote>\n  <p>Proc objects are blocks of code that have been bound to a set of local\nvariables. Once bound, the code may be called in different contexts and still\naccess those variables.</p>\n</blockquote>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def gen_times(factor)\n  shared = 1\n  _proc = Proc.new {|n| n*factor*shared }\n  shared = 2\n  _proc\nend\ntimes3 = gen_times(3)\ntimes5 = gen_times(5)\n\nputs times3.call(12) # 12 * 3 * 2\nputs times5.call(5) # 5 * 5 * 2\n</code></pre></div></div>\n\n<p>That is very similar to <a href=\"/2016/02/10/javascript-theory/\">closures</a></p>\n\n<p>You can exit from proc with <code class=\"highlighter-rouge\">next</code> (<code class=\"highlighter-rouge\">return</code> exits from method, <code class=\"highlighter-rouge\">break</code> exits\nfrom loop). Or you can raise exception.</p>\n\n<p>Proc object can be used as argument for functor (functor is higher-order\nfunction, ie takes function as argument).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def functor(a, b)\n  a.call b\nend\n\np = Proc.new { |i| puts i }\nfunctor(p, 1) # 1\n</code></pre></div></div>\n\n<p>Shorthand notation for creating Procs is <code class=\"highlighter-rouge\">p = lambda {|i| puts i}</code> but there are\ndifferences:</p>\n\n<ul>\n  <li>proc object does not check the number of params (you can call <code class=\"highlighter-rouge\">p.call 1,2,3</code>\nor <code class=\"highlighter-rouge\">p.call</code> i will be nil). Lambda throws an error if number of params does not\nmatch</li>\n  <li>also if you use <code class=\"highlighter-rouge\">return</code> inside proc object, it will stop current method, but\nfor lambda it will not.</li>\n</ul>\n\n<p>You can call using <code class=\"highlighter-rouge\">p.call some_param</code> or <code class=\"highlighter-rouge\">p[some_param]</code>.\nBlock can’t live alone, it is used as last param of methods. Every method has\nimplicit argument for that block and since we do not have name, we use <code class=\"highlighter-rouge\">yield</code>\nto call it. Someone prefer to use explicit argument so we know that method\nexpects block.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def f(a, &amp;p)\n  # we can use explicit\n  p.call a\n  # but also we can use\n  yield a\nend\n\nf(1) { |i| puts i }\n</code></pre></div></div>\n\n<p>Note that proc is not an actual argument and you can not use parenthesis around\n<code class=\"highlighter-rouge\">f(1, lambda {|i| puts i})</code>. But you can use ampersand <code class=\"highlighter-rouge\">&amp;</code> in method call to\nconvert it to block.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def f(a)\n  yield a\nend\np = lambda {|i| puts i}\nf(1, &amp;p)\n</code></pre></div></div>\n\n<p>This is used for example in  <code class=\"highlighter-rouge\">map</code> functor. If we use ampersand for symbol, than\nit will be converted <code class=\"highlighter-rouge\">Symbol#to_proc</code> and passed in.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class Symbol\n  def to_proc\n    lambda {|x, *args| x.send(self, *args)}\n  end\nend\n\nwords = %w(Jane, aara, multiko)\nupcase_words = words.map {|w| w.upcase}\nupcase_words = words.map {|w| w.send :upcase}\nupcase_words = words.map(&amp;:upcase)\n</code></pre></div></div>\n\n<ul>\n  <li>there are special methods in ruby\n    <ul>\n      <li><code class=\"highlighter-rouge\">method_missing(method, *args)</code> can be used to catch all missing methods</li>\n      <li><code class=\"highlighter-rouge\">initialize</code> to instantiate class</li>\n    </ul>\n  </li>\n  <li>call method can be called (invoked) using three (maybe four) ways:\n    <ul>\n      <li>dot notation <code class=\"highlighter-rouge\">o.my_method</code></li>\n      <li>send <code class=\"highlighter-rouge\">o.send :my_method</code> or <code class=\"highlighter-rouge\">o.send :my_property=, 'some_value'</code></li>\n      <li>grab method and call it <code class=\"highlighter-rouge\">o.method(:my_method).call</code></li>\n      <li>interpolated method call is using send like <code class=\"highlighter-rouge\">current_user.send\n\"is_#{@model}_admin?\"</code></li>\n    </ul>\n\n    <p><a href=\"https://gist.github.com/kidlab/72fff6e239b0af1dd3e5\">https://gist.github.com/kidlab/72fff6e239b0af1dd3e5</a> for something that need\ntest or we just want to showcase</p>\n  </li>\n  <li>\n    <p>in rails there is\n<a href=\"https://simonecarletti.com/blog/2009/09/inside-ruby-on-rails-extract_options-from-arrays/\">args.extract_options!</a>\nmodify args and return last hash (or empty hash if there is no hash). Userfull\nif you need to pass attrs by position and as keyword arguments</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def my_method(*args)\n  options = args.extract_options!\n  puts \"Arguments (array):  #{args.inspect}\"\n  puts \"Options (hash):    #{options.inspect}\"\nend\n\nmy_method(1, 2, :a =&gt; :b)\n# Arguments:  [1, 2]\n# Options:    {:a=&gt;:b}\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>in rails you can set up default options with <a href=\"https://apidock.com/rails/Hash/reverse_merge\">reverse\nmerge</a></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>options = options.reverse_merge(size: 25, velocity: 10)\n# is equivalent to\noptions = { size: 25, velocity: 10 }.merge(options)\n</code></pre></div>    </div>\n\n    <p>if you need to deep merge (deep_merge method is deprecated) you can not use\n<code class=\"highlighter-rouge\">merge</code> since it will override existing value. In this case it is better to\nset in initialization</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># this will override params[:project][:subscriber_attributes]\ndef _project_params\n  params.require(:project).permit(\n    :name, :description, :priority, subscriber_attributes: Subscriber::PARAMS\n  ).merge(\n    company: current_user.company,\n    subscriber_attributes: {\n      company_id: current_user.company.id\n    }\n  )\nend\n\n# so only way to put inside initialization\n  @project = current_user.company.projects.new(\n    subscriber: Subscriber.new(company: current_user.company),\n  )\n</code></pre></div>    </div>\n  </li>\n  <li>to merge hash in conditional way you can use:\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>hash = {\n  a: 1\n}.merge(condition ? {b: 2} : {})\n</code></pre></div>    </div>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>hash.tap do |h|\n  h[:b] = 2 if condition\nend\n</code></pre></div>    </div>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>hash = {\n  a: 1,\n  b: (2 if condition),\n}.reject { |k, v| v.nil? }\n# or in Ruby 2.4\n}.compact\n</code></pre></div>    </div>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>hash = {\n  a: 1,\n  **(condition ? {b: 2} : {})\n}\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>to run script and require byebug you can use</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ruby -rbyebug my_script_with_byebug.rb\n</code></pre></div>    </div>\n\n    <p>if you want to debug some ruby cli you can write scripts that check for rvm\nruby version</p>\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">#!/usr/bin/env ruby</span>\n</code></pre></div>    </div>\n    <p>If you use some gems like byebug, add <code class=\"highlighter-rouge\">gem 'byebug'</code> to Gemfile and from that\nfolder run</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ruby -rbyebug $(which vagrant) up\nbundle exec ruby -rbyebug $(which vagrant) up\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>you can use Resolv ruby class, but sometimes you get error <code class=\"highlighter-rouge\">uninitialized\nconstant Resolv</code>. You should reload all services or you can add to Gemfile</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># http://stackoverflow.com/questions/42967546/ruby-puma-error-unable-to-load-application-nameerror-uninitialized-constant\ngem 'rubysl-resolv'\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"fast-ruby-using-optimizations-for-speed\">Fast ruby using optimizations for speed</h1>\n\n<p>List of methods that are faster than other methods\n<a href=\"https://github.com/PerfectMemory/fast-ruby\">fast-ruby</a>\n<a href=\"https://www.youtube.com/watch?v=fGFM_UrSp70\">video</a>\n<a href=\"https://github.com/ombulabs/benches\">benches</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">enum.map { }.flatten(1)</code> should be replaced with <code class=\"highlighter-rouge\">enum.flat_map {}</code> since we\ndo not need to traverse twice</li>\n  <li><code class=\"highlighter-rouge\">[1,2,3].map{ |n| next if n.even? ; 2*n }</code> will return <code class=\"highlighter-rouge\">[2, nil, 6]</code> so if you\nneed to filter you can apply <code class=\"highlighter-rouge\">.compact</code></li>\n  <li>for big arrays you can use rails <code class=\"highlighter-rouge\">User.find_each do |user| end</code> so it loads in\nbatch of 1000 (It returns <code class=\"highlighter-rouge\">nil</code>). You can use map, <code class=\"highlighter-rouge\">User.find_each.map </code> but\nthan you again load all users at once.</li>\n  <li>use mutation methods (with !) so you do not need to create new objects. For\nexample <code class=\"highlighter-rouge\">return hash.merge a: 1</code> should be replaced with <code class=\"highlighter-rouge\">return hash.merge! a:\n1</code> but for hash we can also use <code class=\"highlighter-rouge\">hash[:a] = 1</code> whih is faster.</li>\n  <li>hash fetch method can be used to define default value if the key does not\nexists. You can use block instead of second argument to define default value,\nand it is faster since block is not called if key is not found so\n<code class=\"highlighter-rouge\">hash.fetch(:foo, :my_default_value_computation)</code> should be replaced with\n<code class=\"highlighter-rouge\">hash.fetch(:foo) { my_default_value_computation }</code> so\nmy_default_value_computation is only evaluated when <code class=\"highlighter-rouge\">hash[:foo]</code> is nil</li>\n  <li><code class=\"highlighter-rouge\">string.gsub(\"asd\", \"qwe\")</code> should be replaced with <code class=\"highlighter-rouge\">string.sub(\"asd\", \"qwe\")</code>\nif we need to replace only first occurence, so no need to scan string to the\nend. Also you can use <code class=\"highlighter-rouge\">string.tr(\" \", \"_\")</code></li>\n  <li>\n    <p>replace all double new lines <code class=\"highlighter-rouge\">\"\\n\\n\"</code> with single <code class=\"highlighter-rouge\">\"\\n\"</code> with\n<code class=\"highlighter-rouge\">s.squeeze(\"\\n\")</code> so you can string with</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def strip(text)\n  text.tr(\"\\n\", \" \").squeeze(\" \")\nend\n</code></pre></div>    </div>\n  </li>\n  <li>do not use exception for controll flow, so better is to check before</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>begin\n  foo\nrescue NoMethodError\n  bar\nend\n</code></pre></div></div>\n\n<p>should be replaced</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>if respond_to?(:foo)\n  foo\nelse\n  bar\nend\n</code></pre></div></div>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">Time.parse('2001-01-01 06:06:06 UTC')</code> should be raplaced with\n<code class=\"highlighter-rouge\">Time.at(999232123).utc)</code> since we do not need to parse every time</li>\n  <li>instead of <code class=\"highlighter-rouge\">map(&amp;:id)</code> use <code class=\"highlighter-rouge\">pluck(:id)</code></li>\n  <li>\n    <p>to assign multiple attributes to active record object you can use <code class=\"highlighter-rouge\">Hash.slice</code>\n(<code class=\"highlighter-rouge\">pluck</code> is for database query) and <code class=\"highlighter-rouge\">assign_attributes</code> to self</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>user.assign_attributes other_user.slice :email, :phone\n</code></pre></div>    </div>\n\n    <p>On hash there is <code class=\"highlighter-rouge\">values_at</code> but that is only values. To fetch all attributes\nuse <code class=\"highlighter-rouge\">other_user.attributes</code> or specific ones <code class=\"highlighter-rouge\">other_user.attributes.values_at\n'id', 'email'</code> (if you have array of fields you need to expand\n<code class=\"highlighter-rouge\">other_user.attributes.values_at *fields</code>). NOTE that we use string instead of\nsymbols.\nOn Rails 5.2 you can directly use slice on AR model <code class=\"highlighter-rouge\">user.slice :id, :name</code>\n(before that you can do on <code class=\"highlighter-rouge\">user.attributes.slice :id</code>)</p>\n  </li>\n  <li>safe navigation operator <code class=\"highlighter-rouge\">&amp;.</code> can be used instead of <code class=\"highlighter-rouge\">.try</code> for example: <code class=\"highlighter-rouge\">user\n&amp;&amp; user.name</code> can be written as <code class=\"highlighter-rouge\">user&amp;.name</code>. It is usefull with find_by for\nexample <code class=\"highlighter-rouge\">User.find_by(email: 'a@b.c')&amp;.tap { |u| }</code></li>\n  <li>In ruby 2.3 there is also <code class=\"highlighter-rouge\">Array#dig</code> and <code class=\"highlighter-rouge\">Hash#dig</code> so instead of\n<code class=\"highlighter-rouge\">params[:a].try(:[], :b)</code> you can <code class=\"highlighter-rouge\">params.dig(:a, :b)</code>. when you need to take\nvalue and not sure if provided (usually in some json response)</li>\n  <li>rails has hash except <code class=\"highlighter-rouge\">my_hash.except :my_key</code> to ignore only my_key value and\nreturns also the hash. Also oposite select is slice <code class=\"highlighter-rouge\">my_hash.slice :my_key</code> to\npick <code class=\"highlighter-rouge\">{my_key: 1}</code> (also returns hash)</li>\n  <li>If you need only values for specific keys use <code class=\"highlighter-rouge\">my_hash.values_at :my_key,\n:my_other_key</code>. Also given some value you can find key <code class=\"highlighter-rouge\">my_hash.key some_value</code></li>\n  <li>rails has\n<a href=\"https://apidock.com/rails/v4.0.2/Hash/deep_transform_keys\">deep_transform_keys</a>\nthat can transform keys for your select <code class=\"highlighter-rouge\">hash.deep_transform_keys{ |key|\nkey.to_s.titleize }</code></li>\n  <li>find in array by object property and return array of selected items\n<code class=\"highlighter-rouge\">array.select {|i| i.user == current_user }</code>.</li>\n  <li>ruby has <code class=\"highlighter-rouge\">Hash#invert</code> which will replace keys and values.\nHash#invert <code class=\"highlighter-rouge\">{a: 1, b: 2}.invert # {1: a, 2: b}</code></li>\n  <li>you can create hash with <code class=\"highlighter-rouge\">Hash[]</code>.\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&gt;&gt; [['a','b'], [1, 2]].transpose #=&gt; [[\"a\", 1], [\"b\", 2]]\n&gt;&gt; Hash[[['a','b'], [1, 2]].transpose] #=&gt; {\"a\"=&gt;1, \"b\"=&gt;2}\n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">map</code> and <code class=\"highlighter-rouge\">collect</code> are the same methods</li>\n  <li>to check if string starts with or ends with some substring prefix sufix you\ncan use <code class=\"highlighter-rouge\">s.start_with? prefix</code> or <code class=\"highlighter-rouge\">s.end_with? suffix</code></li>\n  <li>get substring based on position <code class=\"highlighter-rouge\">s[3..-4]</code> or <code class=\"highlighter-rouge\">s[3, s.length - 3]</code></li>\n</ul>\n\n<h1 id=\"rubocop\">Rubocop</h1>\n\n<p>In old project you can generate <code class=\"highlighter-rouge\">.rubocop.yml</code> file that will ignore all\noffenses, than you can gradually fix one by one.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rubocop --auto-gen-config\n# this will generate .rubocop_todo.yml which you can include\ncat &gt;&gt; .rubocop.yml &lt;&lt; HERE_DOC\ninherit_from: .rubocop_todo.yml\nHERE_DOC\n</code></pre></div></div>\n\n<h1 id=\"url-encode\">Url encode</h1>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">URI.escape</code></li>\n  <li><code class=\"highlighter-rouge\">CGI::escape</code></li>\n  <li><code class=\"highlighter-rouge\">ERB::Util.url_encode</code></li>\n</ul>\n\n<h1 id=\"retry-from-rescue\">Retry from rescue</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>begin\n  retries ||= 0\n  puts \"try ##{ retries }\"\n  raise \"the roof\"\nrescue\n  retry if (retries += 1) &lt; 3\nend\n\n# output:\n# try #0\n# try #1\n# try #2\n</code></pre></div></div>\n\n<h1 id=\"pry\">Pry</h1>\n\n<p>https://github.com/pry/pry\nInstert a line <code class=\"highlighter-rouge\">binding.pry</code> (or <code class=\"highlighter-rouge\">binding.irb</code> if you want irb)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pry\nu = User.last\ncd u\n\nls # list all methods, constants and variables for this user object\nshow-method full_name # or aliases: show-source or $\nfind-method xpath Nokogiri\nstat Nokogiri::CSS.xpath_for\nedit full_name # edit the source and reload utomatically\nfull_name\n\nplay -l 123 # run line 123\n\nwtf? # show stack trace of last exception\nwtf??? # more lines\ncat --ex # show exact line of exception\n\n.git diff # run linux commands, just add prefix .\n</code></pre></div></div>\n\n<p>todo https://www.youtube.com/watch?v=4hfMUP5iTq8</p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>insert in strings with percentage <code class=\"highlighter-rouge\">\"Nums are %f %f\" % [1, 2]</code></li>\n  <li><a href=\"http://6ftdan.com/allyourdev/2016/01/13/101-ruby-code-factoids/\">101 ruby code factoids</a></li>\n  <li>you can return only from methods, but not from <code class=\"highlighter-rouge\">do end</code> blocks</li>\n  <li>\n    <p>ruby regex match will return\n<a href=\"https://ruby-doc.org/core-2.2.0/MatchData.html\">matchData</a> for which you can\ncall <code class=\"highlighter-rouge\">captures</code> to get matched groups. You can use block instead of <code class=\"highlighter-rouge\">if</code></p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>exception.message.match(/for column (.*) at row/) do |match_data|\n  detail += \" for the field #{match_data.captures.first}\"\nend\n</code></pre></div>    </div>\n\n    <p>for error <code class=\"highlighter-rouge\">Lint/AmbiguousRegexpLiteral: Ambiguous regexp literal. Parenthesize\nthe method arguments if it's surely a regexp literal, or add a whitespace to\nthe right of the / if it should be a division</code> you can use alternative forms\nfor regular expressions</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = '[\\w\\s]+'\n/#{a}/\n%r[#{a}]\nRegexp.new a\n\n\nRegexp.new(t('user_mailer.welcome'))\n</code></pre></div>    </div>\n  </li>\n  <li>decorators poro presenters\n<a href=\"https://robots.thoughtbot.com/evaluating-alternative-decorator-implementations-in\">thoughtbot</a>\nexample code <a href=\"http://nithinbekal.com/slides/decorator-pattern/#/\">slides</a>\n<a href=\"https://www.youtube.com/watch?v=bHpVdOzrvkE\">video railsconf</a></li>\n  <li>you can count non nil values in array with <code class=\"highlighter-rouge\">[nil, 1, 2].compact # =&gt; [1,2]</code></li>\n  <li>you can call methods with dot but also with double colon <code class=\"highlighter-rouge\">\"a\".size</code> or\n<code class=\"highlighter-rouge\">\"a\"::size</code>. You can put spaces or new lines anywhere <code class=\"highlighter-rouge\">a   .   size</code>.</li>\n  <li>if you see error <code class=\"highlighter-rouge\">method_missing': undefined method this</code> than you need to\nreinstall ruby <code class=\"highlighter-rouge\">rvm reinstall 2.3.1</code>. But is related to rubygems\n<a href=\"https://github.com/rubygems/rubygems/issues/1420\">1420</a> and best patch is\n<a href=\"https://github.com/rubygems/rubygems/issues/1420#issuecomment-169178431\">tenderlove\ncomment</a></li>\n  <li>\n    <p>argument list length could be variable, there is\n<a href=\"https://en.wikibooks.org/wiki/Ruby_Programming/Syntax/Method_Calls#Variable_Length_Argument_List.2C_Asterisk_Operator\">splat</a>\nstar/asterix/expand <code class=\"highlighter-rouge\">*</code> operator, where all other parameters are collected in\narray (note you can not use splat and last hash attribute) (splat is only for\nassignment for function parameters)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def f(x, y, *allOtherValues)\nend\nf(1, 2, 3, c: 4) # allOtherValues = [3, { c: 4} ]\nf(1, 2) # allOtherValues = []\n</code></pre></div>    </div>\n\n    <p>If it is used in method call than it is oposed:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = [1, 2]\nf(*a) # is the same as f(1, 2)\n</code></pre></div>    </div>\n\n    <p>Note that assigning variables by unpacking the array</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = [1, 2, 3]\nb, *rest = *a\n\nb    # =&gt; 1\nrest # =&gt; [2, 3]\na # =&gt; [1, 2, 3]\n</code></pre></div>    </div>\n\n    <p>so you can use destructuring block arguments (params), for example</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>a = [[1, 2], [3, 4]]\na.each_with_index do |(first, last), i|\nend\n</code></pre></div>    </div>\n\n    <p>Last argument could be hash so it can grab all params</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def f(args)\n  puts args.inspect\nend\nf(a: 1, b: 2) # { a: 1, b: 2 }\n</code></pre></div>    </div>\n\n    <p>method default parameters can be set using ruby 2.0 keyword arguments <code class=\"highlighter-rouge\">def\nmy_method(name:, position: 1);end</code> They looks better than position arguments.\nIt will be an error if we call without required arguments, for example\n<code class=\"highlighter-rouge\">my_method position: 2</code>. It will be an error if we call with non existing arg\n<code class=\"highlighter-rouge\">my_method name: 'me', date: 3</code>. You can mix with position arguments. It does\nnot work if you instead of hash use object <code class=\"highlighter-rouge\">ActionController::Parameters.new\nname: 'me'</code> so you need to call with <code class=\"highlighter-rouge\">my_method name:\nActionController::Parameters.new(name: 'me').name</code>\nIn ruby &gt; 2.0 you can use keyword arguments (params are exploded decomposed),\nfor which you can define default values or they need to be required (hash key\nis required)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def f(x, y, c: , d: 1)\nend\nf(1, 2, c: 1, d: 2)\nf(1, 2) # ArgumentError: missing keyword: c\n</code></pre></div>    </div>\n\n    <p>There exists double splats (**) which is used for hashes\n<a href=\"https://alexcastano.com/everything-about-ruby-splats/\">link</a>\nSingle splat convert to array, but double splat convert to hash. Note that it\nonly takes symbol keys (and leave string keys). And double splat differs from\nhash last arg since hash can have default value, but it can be overwritten\nwith some non hash. So use splat if you really need last param to be hash</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def f_with_hash(a, h = {})\nend\ndef f_with_double(a, **d)\nend\nf_with_hash 1, 2 # =&gt; h = 2\nf_with_double 1, 2 # =&gt; ArgumentError: wrong number of arguments (given 2, expected 1)\n</code></pre></div>    </div>\n\n    <p>To see parameters of some function you can use</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Object.instance_method(:f).parameters\n</code></pre></div>    </div>\n\n    <p>Similar to asteriks, last parameter can be prefixed with ampersand (&amp;) which\nmeans function expect a code block. A Proc object will be created and assigned\nto parameter.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def f(a, &amp;p)\n  p.call a\nend\n# parenthesis for method params are required when passing using {}\nf(1) { |i| puts i } # output: 1\n# parenthesis are not required for do end\nf 1 do |i| puts i; end # output: 1\n</code></pre></div>    </div>\n\n    <p>Similarly, using ampersand in method call for a Proc object, it will be\nextrapolated/replaced with block <code class=\"highlighter-rouge\">f2 &amp;p</code> for which you can use:\n<code class=\"highlighter-rouge\">def f2; yield; end</code>. This <code class=\"highlighter-rouge\">&amp;p</code> exists inside method with code block\nparam.</p>\n  </li>\n  <li>sort hash by keys with <code class=\"highlighter-rouge\">h.sort</code> and by values with <code class=\"highlighter-rouge\">h.sort {|a,b|\na[1]&lt;=&gt;b[1]}</code> or using <code class=\"highlighter-rouge\">sort_by</code> with method <code class=\"highlighter-rouge\">o.sort_by &amp;:published_at</code></li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>h = { \"a\" =&gt; 20, \"b\" =&gt; 30, \"c\" =&gt; 10  }\nh.sort                       #=&gt; [[\"a\", 20], [\"b\", 30], [\"c\", 10]]\nh.sort {|a,b| a[1]&lt;=&gt;b[1]}   #=&gt; [[\"c\", 10], [\"a\", 20], [\"b\", 30]]\n</code></pre></div></div>\n\n<p>in rails you can get from ActiveRecord some objects by array of ids and if you\nwant to keep order you can with <code class=\"highlighter-rouge\">index_by(&amp;:id)</code> that will create hash of <code class=\"highlighter-rouge\">{3:\nuser3, 8: user8, 1: user1}</code> but with no order, so you can sort that or slice</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Something.find(array_of_ids).index_by(&amp;:id).slice(*array_of_ids).values\n\n# or\npeople_by_id = Person.find(ids).index_by(&amp;:id) # Gives you a hash indexed by ID\nids.map {|id| people_by_id[id] }\n</code></pre></div></div>\n\n<p>But also ordering and other filtering can be done in sql\nhttps://stackoverflow.com/questions/10150152/find-model-records-by-id-in-the-order-the-array-of-ids-were-given/38378457#38378457</p>\n\n<ul>\n  <li>switch case example</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>case a\nwhen 1..5\n  \"between 1 and 5\"\nelse\n  \"other\"\nend\n</code></pre></div></div>\n\n<p>When you need to match object class to not use <code class=\"highlighter-rouge\">object.class</code> in case statement\nhttp://batsov.com/articles/2012/10/14/ruby-tip-number-3-matching-on-an-objects-class-in-a-case-expression/</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># not case receiver.class\n# better not to use receiver.class == Customer, but receiver.is_a? Customer\n# triple equal is used for that (for a.is_a? b, I can put label b on a)\n# for module it tests for `.is_a?`\n# for range it test for `.includes?`\n# for regexp it test for `.match`\ncase receiver\nwhen Customer\nend\n</code></pre></div></div>\n\n<p>New in  Ruby 2.5</p>\n<ul>\n  <li>\n    <p><code class=\"highlighter-rouge\">Module#attr, attr_accessor, attr_reader, attr_writer, define_method,\nalias_method, undef_method</code> and <code class=\"highlighter-rouge\">remove_method</code> are now all public.</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class A\n  def initialize\n    @some_instance = 1\n  end\nend\n\na = A.new # &lt;A: @some_instance=1&gt;\nA.attr_accessor :some_instance\na.some_instance = 2\n</code></pre></div>    </div>\n  </li>\n  <li>rescue/else/ensure are allowed inside do/end blocks (without begin/end)</li>\n  <li>bundler is standard library</li>\n  <li><code class=\"highlighter-rouge\">Hash#transform_keys</code></li>\n  <li>yield_self (similar to rails’s <code class=\"highlighter-rouge\">try</code>) (<code class=\"highlighter-rouge\">tap</code> returns object instead of last\nline of the block).</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>to_upper = -&gt; (str) { str.upcase }\n\"string\".yield_self(&amp;to_upper)\n        .yield_self(&amp;add_greeting)`\n</code></pre></div></div>\n\n<ul>\n  <li>tripple equal <code class=\"highlighter-rouge\">===</code> is operator that for ranges calls <code class=\"highlighter-rouge\">.includes?</code>, for regexp\ncalls <code class=\"highlighter-rouge\">.match?</code>, for proc calls <code class=\"highlighter-rouge\">.call</code></li>\n  <li>fake objects could be generated from hash with:\n  <code class=\"highlighter-rouge\">Struct.new(:name, :type, :years).new 'Dule', :kayak, 35</code>\n  <code class=\"highlighter-rouge\">OpenStruct.new name: 'Dule'</code>\nIf you need recursively generated OpenStruct than you can convert to json and\nparse with Open struct class: <code class=\"highlighter-rouge\">h = { a: 1, b: { c: 1 }};\no=JSON.parse(h.to_json, object_class: OpenStruct); o.b.c # =&gt; '1'</code>. You can\nuse rails <code class=\"highlighter-rouge\">h = ActionController::Parameters.new</code> so you can <code class=\"highlighter-rouge\">h.merge! b:1</code></li>\n  <li>raise error when hash key does not exists (instead of returning <code class=\"highlighter-rouge\">nil</code>).\n<code class=\"highlighter-rouge\">default_proc</code> will be executed if key does not exists</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/constants.rb\nclass Constant\n  def self.hash_or_error_if_key_does_not_exists(h)\n    # https://stackoverflow.com/questions/30528699/why-isnt-an-exception-thrown-when-the-hash-value-doesnt-exist\n    # raise if key does not exists h[:non_exists] or h.values_at[:non_exists]\n    h.default_proc = -&gt; (_h, k) { raise KeyError, \"#{k} not found!\" }\n    # raise when value not exists h.key 'non_exists'\n    def h.key(value)\n      k = super\n      raise KeyError, \"#{value} not found!\" unless k\n      k\n    end\n    h\n  end\n\n  def self.CUSTOMER_EVENTS\n    hash_or_error_if_key_does_not_exists(\n      EDIT: 'edit',\n    )\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># spec/models/constant_spec.rb\nRSpec.describe Constant do\n  it 'store string values' do\n    expect(Constant.CUSTOMER_EVENTS[:EDIT]).to eq 'edit'\n    expect(Constant.CUSTOMER_EVENTS.key 'edit').to eq :EDIT\n  end\n\n  it 'raise error if key does not exists' do\n    expect do\n      Constant.CUSTOMER_EVENTS[:not_exists]\n    end.to raise_error KeyError\n\n    expect do\n      Constant.CUSTOMER_EVENTS.values_at 'not_exists'\n    end.to raise_error KeyError\n\n    expect do\n      Constant.CUSTOMER_EVENTS.key 'not_exists'\n    end.to raise_error KeyError\n  end\nend\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>use <code class=\"highlighter-rouge\">enumerator.map do ... end</code> block when there is a side effects and curly\nbraces than you need return value <code class=\"highlighter-rouge\">enumerator.map { ... }</code></p>\n  </li>\n  <li>documentation using\n <a href=\"https://en.wikibooks.org/wiki/Ruby_Programming/RubyDoc\">rdoc</a> SimpleMarkup\n format which is pretty mature, example is on\n https://ruby-doc.org/core-2.4.0/String.html but also Rails uses it\n https://guides.rubyonrails.org/api_documentation_guidelines.html\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># test rdoc in command line\necho \"+:to_param+\" | rdoc --pipe\n</code></pre></div>    </div>\n  </li>\n  <li>yard is newer and it supports links https://www.rubydoc.info/github/rails/rails</li>\n  <li>convert single value and array value to array <code class=\"highlighter-rouge\">Array(1)</code> and <code class=\"highlighter-rouge\">Array([1])</code>https://stackoverflow.com/questions/18358717/ruby-elegantly-convert-variable-to-an-array-if-not-an-array-already</li>\n  <li>hash with indifferent access (symbol or string) this is Rails ActiveSupport\n<code class=\"highlighter-rouge\">h = HashWithIndifferentAccess.new a: 2</code> so you can use <code class=\"highlighter-rouge\">h[:a]</code> or <code class=\"highlighter-rouge\">h['a']</code></li>\n  <li>inserting key value in hash at specific position\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># https://stackoverflow.com/a/17251424/287166\nclass Hash\ndef insert_before(key, kvpair)\n  arr = to_a\n  pos = arr.index(arr.assoc(key))\n  if pos\n    arr.insert(pos, kvpair)\n  else\n    arr &lt;&lt; kvpair\n  end\n  replace Hash[arr]\nend\nend\n</code></pre></div>    </div>\n  </li>\n  <li>if you need snake case from class name, you can\n<code class=\"highlighter-rouge\">described_class.name.underscore</code>. Of you need class from controller name\n<code class=\"highlighter-rouge\">users_controller</code> you can <code class=\"highlighter-rouge\">controller_name.classify.constantize</code> which returns\n<code class=\"highlighter-rouge\">UsersController</code></li>\n  <li>to create array of hashes or array of new objects you can not use <code class=\"highlighter-rouge\">[{}]*2</code> or\n<code class=\"highlighter-rouge\">[User.new]*2</code> since that will be the same object in both places. You have to\nuse <code class=\"highlighter-rouge\">Array.new(2) { User.new }</code></li>\n</ul>\n\n<p>todo</p>\n\n<p>http://norswap.com/ruby-dark-corners/\nhttps://www.amazon.com/Eloquent-Ruby-Addison-Wesley-Professional/dp/0321584104\nhttp://www.confidentruby.com/\nhttp://www.poodr.com/\nhttp://poignant.guide/book/chapter-5.html\nhttps://prograils.com/posts/ruby-on-rails-books-experienced-level</p>\n"
    } ,
  
    {
      "title"    : "Free SSL for https on apache or nginx",
      "category" : "",
      "tags"     : "https, ssl, apache, nginx",
      "url"      : "/2015/10/08/free-ssl-for-https-on-apache-or-nginx/",
      "date"     : "2015-10-08 00:00:00 +0200",
      "content"  : "<h1 id=\"lets-encrypt-for-heroku\">Lets encrypt for heroku</h1>\n\n<p>https://letsencrypt.org/\nIs free and Heroku supports it using\n<a href=\"https://devcenter.heroku.com/articles/automated-certificate-management\">ACM</a>\nbut only for paid dynos.\nUse cloudflare.com for free ssl, and we point directly to https herokuapp (no\nneed to setup dns on heroku).\nOn Crypto tab on Cloud Flare select FULL (not Flexible) SSL.\nYou can check the Always use HTTPS (<code class=\"highlighter-rouge\">Redirect all requests with scheme “http” to\n“https”. This applies to all http requests to the zone</code>) or create Page rules\nthat redirects from http to https.\nThere could be a problem when we using http on Rails and submitting the form on\nhttps, heroku logs will give</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>HTTP Origin header (https://www.premesti.se) didn't match request.base_url (http://www.premesti.se)\nCompleted 422 Unprocessable Entity in 6ms\nActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\n</code></pre></div></div>\n\n<p>On Page rules add redirect non www to www.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://premesti.se/* -&gt; https://www.premesti.se/$1\n\n# Also we you did not use  `Always use HTTPS` you can add rules that redirects\nhttp://premesti.se/* -&gt; https://www.premesti.se/$1\nhttp://www.premesti.se/* -&gt; https://www.premesti.se/$1\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>dig premesti.se\n# should have\n;; ANSWER SECTION:\npremesti.se.\t\t78\tIN\tA\t104.28.14.137\npremesti.se.\t\t78\tIN\tA\t104.28.15.137\n\ncurl premesti.se -I\n# should have\nHTTP/1.1 301 Moved Permanently\nLocation: https://www.premesti.se/\n\ncurl https://premesti.se -I\n# should have\nHTTP/1.1 301 Moved Permanently\nLocation: https://www.premesti.se/\n</code></pre></div></div>\n\n<h1 id=\"old-way\">Old way</h1>\n\n<p>Following <a href=\"https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-with-a-free-signed-ssl-certificate-on-a-vps\">this tutorial</a> here are some screenshots from Startssl how I registered <a href=\"http://www.kontakt.in.rs\">www.kontakt.in.rs</a>.</p>\n\n<h1 id=\"startssl\">StartSSL</h1>\n\n<p>StartSSL is not working since they issues certs for sites that did not check.\nHere is example only for reference.</p>\n\n<p>Go to the <a href=\"http://www.startssl.com/\">www.startssl.com</a> and on left menu find: <em>StartSSL Products</em> &gt; <em>StartSSL Free</em> . Before you can get the keys, you need to authenticate yourself. Go to <a href=\"https://www.startssl.com/?app=12\">Certificate Control Panel</a>. There are links for login using existing keys, but we will use signup.</p>\n\n<h1 id=\"signup-and-install-browser-certificate\">Signup and install browser certificate</h1>\n\n<p><img src=\"/assets/post_free_ssl/1_signup_form.jpg\" alt=\"Sign up form\" /></p>\n\n<p>than you will receive a code in email, and it should be pasted on</p>\n\n<p><img src=\"/assets/post_free_ssl/2_complete_registration.jpg\" alt=\"Somplete registration\" /></p>\n\n<p>Wait until they authorize your email account</p>\n\n<p><img src=\"/assets/post_free_ssl/3_notice_for_review.jpg\" alt=\"Notice for review\" /></p>\n\n<p>Once your account is approved and you receive email, click on link provided and copy verification code</p>\n\n<p><img src=\"/assets/post_free_ssl/4_verify_approved_request.jpg\" alt=\"Verify approved request\" /></p>\n\n<p>Generate private key</p>\n\n<p><img src=\"/assets/post_free_ssl/5_generate_private_key.jpg\" alt=\"Generate private key\" /></p>\n\n<p>Install certificate</p>\n\n<p><img src=\"/assets/post_free_ssl/6_install_certificate.jpg\" alt=\"Install certificate\" /></p>\n\n<p>Congratulations for browser certificate</p>\n\n<p><img src=\"/assets/post_free_ssl/7_congratulations_for_browser_certificate.jpg\" alt=\"Congratulations for browser certificate\" /></p>\n\n<h1 id=\"validation-wizard-for-domain\">Validation wizard for domain</h1>\n\n<p>Pick web ssl</p>\n\n<p><img src=\"/assets/post_free_ssl/validation_wizard1_chose_web_ssl.jpg\" alt=\"Chose web ssl\" /></p>\n\n<p>Enter domain name</p>\n\n<p><img src=\"/assets/post_free_ssl/validation_wizard2_enter_domain_name.jpg\" alt=\"Enter domain name\" /></p>\n\n<p>Choose email</p>\n\n<p><img src=\"/assets/post_free_ssl/validation_wizard3_choose_email.jpg\" alt=\"Choose email\" /></p>\n\n<p>Verify email</p>\n\n<p><img src=\"/assets/post_free_ssl/validation_wizard4_verify_email.jpg\" alt=\"Verify email\" /></p>\n\n<p>Success</p>\n\n<p><img src=\"/assets/post_free_ssl/validation_wizard5_success.jpg\" alt=\"Success\" /></p>\n\n<h1 id=\"certificates-wizard\">Certificates wizard</h1>\n\n<p>Pick web ssl</p>\n\n<p><img src=\"/assets/post_free_ssl/cert_wizard1_chose_web_ssl.jpg\" alt=\"chose web ssl\" /></p>\n\n<p>Enter password</p>\n\n<p><img src=\"/assets/post_free_ssl/cert_wizard2_enter_password.jpg\" alt=\"Enter password\" /></p>\n\n<p>Save <strong>ssl.key</strong></p>\n\n<p><img src=\"/assets/post_free_ssl/cert_wizard3_save_ssl_key.jpg\" alt=\"save ssl.key\" /></p>\n\n<p>Pick domain</p>\n\n<p><img src=\"/assets/post_free_ssl/cert_wizard4_select_domain.jpg\" alt=\"Select domain\" /></p>\n\n<p>Add subdomain www</p>\n\n<p><img src=\"/assets/post_free_ssl/cert_wizard5_add_subdomain_www.jpg\" alt=\"Add subdomain www\" /></p>\n\n<p>Processing</p>\n\n<p><img src=\"/assets/post_free_ssl/cert_wizard6_processing.jpg\" alt=\"Processing\" /></p>\n\n<p>Additinal check</p>\n\n<p><img src=\"/assets/post_free_ssl/cert_wizard7_additional_check.jpg\" alt=\"Additional check\" /></p>\n\n<h1 id=\"final-cert-files\">Final cert files</h1>\n\n<p>After you got email that certificate is ready, go to toolbox and download it</p>\n\n<p><img src=\"/assets/post_free_ssl/cert_wizard7_download_certificate.jpg\" alt=\"Download certificate\" /></p>\n\n<p>We need two additional files:</p>\n\n<ul>\n  <li>StartCom Root CA (ca.pem)</li>\n  <li>StartSSL’s Class 1 Intermediate Server CA (sub.class1.server.ca)</li>\n</ul>\n\n<p>which you can find in Toolbox section.</p>\n\n<p>Since server needs unencrypted version we need to create that (so it won’t ask for password)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>openssl rsa -in ssl.key -out private.key \n</code></pre></div></div>\n\n<p>Copy those four files to server</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>scp {ca.pem,private.key,sub.class1.server.ca.pem,ssl.crt} YOURSERVER:~ \n</code></pre></div></div>\n\n<h1 id=\"local-test\">Local test</h1>\n\n<p>You can test localy in virtual box, we will use ports 8080 and 8081</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>vagrant init\nsed -i '/base/c \\  config.vm.box = \"ubuntu/trusty64\"\\\n  config.vm.network \"forwarded_port\", guest: 80, host: 8080\\\n  config.vm.network \"forwarded_port\", guest: 443, host: 8081\\\n' Vagrantfile\nvagrant up\nvagrant ssh\n</code></pre></div></div>\n\n<h2 id=\"install-ssl-on-apache2\">Install ssl on apache2</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get update # get right sources\nsudo apt-get -y install apache2\nsudo a2enmod ssl\nsudo mkdir /etc/apache2/ssl\ncd /vagrant\nsudo cp {ca.pem,private.key,sub.class1.server.ca.pem,ssl.crt} /etc/apache2/ssl\n# copy configuration for http\ncat /etc/apache2/sites-enabled/000-default.conf | sudo tee -a /etc/apache2/sites-enabled/000-default.conf\n# add ssl configuration\nsudo sed -i '1c &lt;VirtualHost *:443&gt;' /etc/apache2/sites-enabled/000-default.conf\nsudo sed -i '/VirtualHost...443/a SSLEngine on\\\n  SSLProtocol all -SSLv2\\\n  SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM\\\n  SSLCertificateFile /etc/apache2/ssl/ssl.crt\\\n  SSLCertificateKeyFile /etc/apache2/ssl/private.key\\\n  SSLCertificateChainFile /etc/apache2/ssl/sub.class1.server.ca.pem \\\n' /etc/apache2/sites-enabled/000-default.conf\nsudo service apache2 restart\nsudo tail -f /var/log/apache2/error.log\n</code></pre></div></div>\n\n<h2 id=\"install-on-ngxin\">Install on ngxin</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo apt-get update # get right sources\nsudo apt-get -y install nginx\nsudo mkdir /etc/nginx/ssl\nsudo sed -i '/listen.80.default_server/a \\\\tlisten 443 ssl;\\\n\\tssl_certificate /etc/nginx/ssl/ssl.crt;\\\n\\tssl_certificate_key /etc/nginx/ssl/private.key;\\\n' /etc/nginx/sites-enabled/default\nsudo cp /vagrant/private.key /vagrant/ssl.crt /etc/nginx/ssl\nsudo service nginx restart\nsudo tail -f /var/log/nginx/error.log\n</code></pre></div></div>\n\n<p>Temporary change <code class=\"highlighter-rouge\">www.kontakt.in.rs</code> to point to localhost <code class=\"highlighter-rouge\">127.0.0.1</code> and go to\n<a href=\"http://www.kontakt.in.rs:8080\">http://www.kontakt.in.rs:8080</a> \n<a href=\"https://www.kontakt.in.rs:8081\">https://www.kontakt.in.rs:8081</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo -e \"127.0.0.1\\twww.kontakt.in.rs\" | sudo tee -a /etc/hosts\n</code></pre></div></div>\n\n<p>You should see certificate on apache</p>\n\n<p><img src=\"/assets/post_free_ssl/final_apache_cert.jpg\" alt=\"final apache cert\" /></p>\n\n<p>and green lock on ngxin</p>\n\n<p><img src=\"/assets/post_free_ssl/final_nginx_cert.jpg\" alt=\"final nginx cert\" /></p>\n\n<p>Don’t forget to remove temporary dns in hosts</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo sed -i '/www.kontakt.in.rs/c #127.0.0.1\\twww.kontakt.in.rs' /etc/hosts\n</code></pre></div></div>\n\n<p>On ubuntu, you can rename <code class=\"highlighter-rouge\">ssl.crt</code> to <code class=\"highlighter-rouge\">ssl.crt.p12</code> (or ssl.crt.key) and double click will show you\ndetails of certificate.</p>\n\n<p>For heroku you can follow <a href=\"https://gist.github.com/meskyanichi/3354578\">https://gist.github.com/meskyanichi/3354578</a></p>\n\n<p>If in windows 7 can not open www.xda-developers.com because\nof invalid certificate, The certificate cannot be verified up to a trused\ncertification authority… This server could not prove that it is\nwww.xda-developers.com its secity certificate is not trusted by your computer’s\noperating system…</p>\n"
    } ,
  
    {
      "title"    : "Jekyll tips for github pages",
      "category" : "",
      "tags"     : "jekyll, github, rakefile",
      "url"      : "/2015/10/01/jekyll-tips-for-github-pages/",
      "date"     : "2015-10-01 00:00:00 +0200",
      "content"  : "<h1 id=\"installation\">Installation</h1>\n\n<p>Here are the steps you can follow to generate myblog</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gem install jekyll\njekyll new myblog\ncd myblog\ngit init .\ngit add .\ngit commit -m \"Initial jekyll new myblog\"\n</code></pre></div></div>\n\n<p>Live reload is now built in (no need for <code class=\"highlighter-rouge\">guard-livereload</code>). You just need to\nrun with option <code class=\"highlighter-rouge\">jekyll serve --livereload</code></p>\n\n<p>For livereload you need to install <a href=\"https://chrome.google.com/webstore/detail/livereload/jnihajbhpnppcggbcgedagnkighmdlei/related?hl=en\">Chrome\nplugin</a>\nenable it and activate by clicking on icon when you open a page.\nThere is also plugin for firefox https://addons.mozilla.org/en-US/firefox/addon/livereload-web-extension/\nYou can use javascript version.</p>\n\n<h1 id=\"custom-domain\">Custom domain</h1>\n\n<p>If your repo is the only or is primary, you can use <duleorlovic.github.io> url\nyou just need to rename repository to that name.</duleorlovic.github.io></p>\n\n<p>Do not need to rename if you want custom domain, you can  enable it from\nsettings <a href=\"https://github.com/duleorlovic/trk.in.rs/settings\">https://github.com/duleorlovic/trk.in.rs/settings</a> or you can just\ncreate CNAME file manually since that is the same</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git chechout -t origin/gh-pages\necho \"www.trk.in.rs\" &gt; CNAME\n</code></pre></div></div>\n\n<p>You need to configure your domain name provider to point to your github\nrespository with <a href=\"https://help.github.com/articles/setting-up-a-www-subdomain/\">CNAME\nrecord</a>\nto point to <code class=\"highlighter-rouge\">{username}.github.io</code>, for example <code class=\"highlighter-rouge\">CNAME duleorlovic.github.io</code>.\nCheck when it is updated, usually in one hour</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># note that second column is TTL time to live in secods\ndig +nostats +nocomments +nocmd www.trk.in.rs\n;www.trk.in.rs.\t\t\tIN\tA\nwww.trk.in.rs.\t\t3600\tIN\tCNAME\tkulakajak.github.io.\nkulakajak.github.io.\t3600\tIN\tA\t185.199.111.153\nkulakajak.github.io.\t3600\tIN\tA\t185.199.110.153\n</code></pre></div></div>\n\n<p>Use this only for subdomains (www.trk.in.rs, blog.trk.in.rs) and not for apex\ndomain. Adding CNAME record to the root of your domain will disable MX and TXT\nrecords. If you need to apex domain (and not to destroy other records) you can\ntry with ANAME record (not supported in loopia), or use Cloudflare\n<a href=\"https://support.cloudflare.com/hc/en-us/articles/200169056-CNAME-Flattening-RFC-compliant-support-for-CNAME-at-the-root\">flattening</a></p>\n\n<p>Default <code class=\"highlighter-rouge\">duleorlovic.github.io</code> is serverd under HTTPS, but custom domain is\nserverd under HTTP. To enable HTTPS for custom domains you can try\n<a href=\"https://www.cloudflare.com/\">cloudflare</a> but recently, all github pages are\nenypted with free <a href=\"https://letsencrypt.org/\">https://letsencrypt.org/</a> certificate.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>dig  +nostats +nocomments +nocmd projektor.trk.in.rs\n;projektor.trk.in.rs.\t\tIN\tA\nprojektor.trk.in.rs.\t3405\tIN\tCNAME\td1ub4fmsp3scvp.cloudfront.net.\nd1ub4fmsp3scvp.cloudfront.net. 47 IN\tA\t13.32.22.82\n</code></pre></div></div>\n\n<h1 id=\"loopia\">Loopia</h1>\n\n<p>If you want redirection from non www to www, than use Forwatd -&gt; Url redirect\n(301 or 302) but uncheck “Synchronize the domain and subdomain www”\n<img src=\"/assets/posts/loopia_dns.png\" alt=\"loopia dns\" title=\"Loopia DNS\" /></p>\n\n<h1 id=\"jekyll-on-github\">Jekyll on github</h1>\n\n<p>Easiest way to start a blog on github it to fork\n<a href=\"https://github.com/barryclark/jekyll-now\">https://github.com/barryclark/jekyll-now</a> and rename it to\n<code class=\"highlighter-rouge\">duleorlovic.github.io</code> and start editing using <a href=\"http://prose.io/\">http://prose.io/</a>. There is\nnothing special there, just simple jekyll project, with\n<a href=\"https://github.com/duleorlovic/jekyll-now/tree/master/_includes\">_includes</a> for\ndiscuss, analytics, meta and uses <code class=\"highlighter-rouge\">gems: jekyll-sitemap</code> which github supports.\nIt does not use theme. It is very similar to default jekyll theme\n<a href=\"https://github.com/jekyll/minima\">minima</a></p>\n\n<p>Jekyll default template minima can be overriden with</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bundle show minima\n# ~/.rvm/gems/ruby-2.5.1/gems/minima-2.5.0\nmkdir _includes\ncp `bundle show minima`/_includes/@(footer|header|head).html _includes/\ngit add .\ngit commit -am 'cp `bundle show minima`/_includes/@(footer|header|head).html _includes/'\n</code></pre></div></div>\n\n<h1 id=\"travis\">Travis</h1>\n\n<p>This <a href=\"https://gist.github.com/domenic/ec8b0fc8ab45f39403dd\">gist</a> explain what\nto do. In additional you need to use <code class=\"highlighter-rouge\">bundle install &amp;&amp; bundle exec jekyll build\n-d out</code> as build command, use proper ruby supported by travis <code class=\"highlighter-rouge\">rvm: - 2.2</code>,\nexclude <code class=\"highlighter-rouge\">vendor</code> from jekyll, and note the label string that <code class=\"highlighter-rouge\">travis</code> cli\ngenerate when you encrypt.</p>\n\n<p>You need to generate keys which Travis will use to deploy. You need to write to\n<code class=\"highlighter-rouge\">deploy_key</code> and to not label from travis cli.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ssh-keygen -t rsa -b 4096 -C \"your_email@example.com\" deploy_key\ntravis encrypt-file deploy_key\ngit add deploy_key.enc\nmv deploy_key deploy_key.pub ~/.ssh/\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; deploy.sh &lt;&lt; HERE_DOC\n#!/bin/bash\nset -e # Exit with nonzero exit code if anything fails\n\nSOURCE_BRANCH=\"master\"\nTARGET_BRANCH=\"gh-pages\"\n\nfunction doCompile {\n  bundle install\n  bundle exec jekyll build -d out\n}\n\n# Pull requests and commits to other branches shouldn't try to deploy, just build to verify\nif [ \"$TRAVIS_PULL_REQUEST\" != \"false\" -o \"$TRAVIS_BRANCH\" != \"$SOURCE_BRANCH\" ]; then\n    echo \"Skipping deploy; just doing a build.\"\n    doCompile\n    exit 0\nfi\n\n# Save some useful information\nREPO=`git config remote.origin.url`\nSSH_REPO=${REPO/https:\\/\\/github.com\\//git@github.com:}\nSHA=`git rev-parse --verify HEAD`\n\n# Clone the existing gh-pages for this repo into out/\n# Create a new empty branch if gh-pages doesn't exist yet (should only happen on first deply)\ngit clone $REPO out\ncd out\ngit checkout $TARGET_BRANCH || git checkout --orphan $TARGET_BRANCH\ncd ..\n\n# Clean out existing contents\nrm -rf out/**/* || exit 0\n\n# Run our compile script\ndoCompile\n\n# Now let's go have some fun with the cloned repo\ncd out\ngit config user.name \"Travis CI\"\ngit config user.email \"$COMMIT_AUTHOR_EMAIL\"\n\n# If there are no changes to the compiled out (e.g. this is a README update) then just bail.\nif [ -z `git diff --exit-code` ]; then\n    echo \"No changes to the output on this push; exiting.\"\n    exit 0\nfi\n\n# Commit the \"changes\", i.e. the new version.\n# The delta will show diffs between new and old versions.\ngit add .\ngit commit -m \"Deploy to GitHub Pages: ${SHA}\"\n\n# Get the deploy key by using Travis's stored variables to decrypt deploy_key.enc\nENCRYPTED_KEY_VAR=\"encrypted_${ENCRYPTION_LABEL}_key\"\nENCRYPTED_IV_VAR=\"encrypted_${ENCRYPTION_LABEL}_iv\"\nENCRYPTED_KEY=${!ENCRYPTED_KEY_VAR}\nENCRYPTED_IV=${!ENCRYPTED_IV_VAR}\nopenssl aes-256-cbc -K $ENCRYPTED_KEY -iv $ENCRYPTED_IV -in deploy_key.enc -out deploy_key -d\nchmod 600 deploy_key\neval `ssh-agent -s`\nssh-add deploy_key\n\n# Now that we're all set up, we can push.\ngit push $SSH_REPO $TARGET_BRANCH\nHERE_DOC\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; .travis.yml &lt;&lt; HERE_DOC\nlanguage: ruby\nscript: bash ./deploy.sh\nrvm:\n  - 2.2\nenv:\n  global:\n  - ENCRYPTION_LABEL: \"find-label-in-output\"\n  - COMMIT_AUTHOR_EMAIL: \"your-email@gmail.com\"\nHERE_DOC\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; _config.yml &lt;&lt; HERE_DOC\nexclude:\n  - Gemfile\n  - Gemfile.lock\n  - vendor\n  - deploy.sh\nHERE_DOC\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git add deploy.sh .travis.yml _config.yml deploy_key.enc\ngit commit -m \"Adding travis deploy scripts\"\n</code></pre></div></div>\n\n<p>Very usefull one line command when debugging travis</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git add . &amp;&amp; git commit --amend --no-edit &amp;&amp; git push -f\n</code></pre></div></div>\n\n<p>You can edit online with <a href=\"http://prose.io\">http://prose.io</a>. Make sure you are editing <code class=\"highlighter-rouge\">master</code>\nbranch. Make sure github setting\n<a href=\"https://github.com/duleorlovic/blog/settings/branches\">https://github.com/duleorlovic/blog/settings/branches</a>\ndefault branch is master branch.</p>\n\n<p>You can add prose related\n<a href=\"https://github.com/prose/prose/wiki/Prose-Configuration\">config</a>.\nYou can exclude files with <code class=\"highlighter-rouge\">ignore: </code>.\nYou can add custom fields for some front matter with <code class=\"highlighter-rouge\">metadata: _posts: ...</code>.\nFirst key is folder name not the ruby class so if you have page or post inside\nfolder, than use folder name instead of <code class=\"highlighter-rouge\">_posts</code>. \nTitle is updated in header so do not need to define title metadata. Use <code class=\"highlighter-rouge\">\"\"</code> for\nall files. Nice <a href=\"https://github.com/ccppbrasil/ccppbrasil.github.io/blob/master/_config.yml\">example of\nprose</a>.</p>\n\n<h1 id=\"heroku\">Heroku</h1>\n\n<p>There is heroku buildpack than can build jekyll for you and serve static site so\nyou can use any plugins.\nhttps://blog.heroku.com/jekyll-on-heroku</p>\n\n<h1 id=\"serve-under-subfolder\">Serve under subfolder</h1>\n\n<p>Since github pages serve your project under subfolder\n<code class=\"highlighter-rouge\">username.github.io/project-name</code> you need to use special <a href=\"http://jekyllrb.com/docs/configuration/\">config\nvariable</a> <code class=\"highlighter-rouge\">baseurl</code>.  Add to your\n<code class=\"highlighter-rouge\">_config.yml</code> a line <code class=\"highlighter-rouge\">baseurl: /blog</code>. This is not needed if you use custom\ndomain like <a href=\"blog.trk.in.rs\">blog.trk.in.rs</a></p>\n\n<p>To properly serve your assets and link your pages you need to prepend all links\nwith <em>site.baseurl</em>. For example in markdown <code class=\"highlighter-rouge\">![My picture]({ { site.baseurl\n}}/assets/my_picture.png)</code> or <code class=\"highlighter-rouge\">&lt;link rel=\"stylesheet\" href=\"{ { site.baseurl\n}}/assets/css/main.css\"&gt;</code> or <code class=\"highlighter-rouge\">&lt;a class=\"post-link\" href=\"{ { post.url | prepend:\nsite.baseurl }}\"&gt;{ { post.title }}&lt;/a&gt;</code></p>\n\n<h1 id=\"development-environment\">Development environment</h1>\n\n<p>If you need to separate production from development (for example analytics), you\ncan use liquid variable <code class=\"highlighter-rouge\">jekyll.environment</code> which can be exported or used\ninline with <code class=\"highlighter-rouge\">JEKYLL_ENV=development jekyll serve --watch</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c\">&lt;!-- index.html --&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    {% if jekyll.envirnoment == \"development\" %}\n      Hello admin\n    {% endif %}\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<h1 id=\"automatic-deploy-to-gh-pages-using-rake\">Automatic deploy to gh-pages using rake</h1>\n\n<p>Rake tasks are perfect for deploying since you need just to type <code class=\"highlighter-rouge\">rake</code> and it\nwill be live (if you set up properly). This is my Rakefile that builds my blog\n(stored on bitbucket) and push to github.\nThis is nice since I do not want to share history (all commits from the\nbeggining). On github, you can find only one commit “Site updated at …”</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git remote add origin git@bitbucket.org:duleorlovic/trk.in.rs.git\ngit remote add github git@github.com:duleorlovic/trk.in.rs.git\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Rakefile\n#\n# You need to set up git remote to github, for example:\n#\n# git remote add github git@github.com:duleorlovic/blog.git\n#\n# Require jekyll to compile the site.\nrequire \"jekyll\"\nrequire 'tmpdir'\n\ntask :default =&gt; \"blog:publish\"\n# Github pages publishing.\nnamespace :blog do\n  #\n  # Because we are using 3rd party plugins for jekyll to manage the asset pipeline\n  # and suchlike we are unable to just branch the code, we have to process the site\n  # localy before pushing it to the branch to publish.\n  #\n  # We built this little rake task to help make that a little bit eaiser.\n  #\n\n  # Usaage:\n  # bundle exec rake blog:publish\n  desc \"Publish blog to gh-pages\"\n  task :publish do\n    # Compile the Jekyll site using the config.\n    Jekyll::Site.new(Jekyll.configuration({\n      \"source\"      =&gt; \".\",\n      \"destination\" =&gt; \"_site\",\n      \"config\" =&gt; \"_config.yml\"\n    })).process\n\n    # Get the origin to which we are going to push the site.\n    origin = `git config --get remote.github.url`\n\n    # Make a temporary directory for the build before production release.\n    # This will be torn down once the task is complete.\n    Dir.mktmpdir do |tmp|\n      # Copy accross our compiled _site directory.\n      cp_r \"_site/.\", tmp\n\n      # Switch in to the tmp dir.\n      Dir.chdir tmp\n\n      # Prepare all the content in the repo for deployment.\n      system \"git init\" # Init the repo.\n      system \"git add . &amp;&amp; git commit -m 'Site updated at #{Time.now.utc}'\" # Add and commit all the files.\n\n      # Add the origin remote for the parent repo to the tmp folder.\n      system \"git remote add origin #{origin}\"\n\n      # Push the files to the gh-pages branch, forcing an overwrite.\n      system \"git push origin master:refs/heads/gh-pages --force\"\n    end\n\n    # Done.\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"adding-table-of-content\">Adding Table of Content</h1>\n\n<p>If you need automatic Toc than use\n<a href=\"https://github.com/dafi/jekyll-toc-generator\">dafi jekyll-toc-generator</a>.</p>\n\n<p>I modify to use original id-s (that is hypernated version of header content) in\n<a href=\"https://github.com/duleorlovic/jekyll-toc-generator/commit/9c83b67e183600bb51dcea533aaa8eeeae4eb18a\">duleorlovic/jekyll-toc-generator</a></p>\n\n<p>You can put\n<a href=\"http://jekyllrb.com/docs/configuration/#front-matter-defaults\">defaults</a> to not\nhave a Toc, and enable on post that you want Toc to show.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># _config.yml\ndefaults:\n  -\n    scope:\n      path: \"\"\n      type: \"posts\"\n    values:\n      noToc: true\n</code></pre></div></div>\n\n<h1 id=\"adding-sitemap\">Adding sitemap</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo \"gem 'jekyll-sitemap'\" &gt;&gt; Gemfile\nbundle\necho \"url: https://trk.in.rs\ngems:\n  - jekyll-sitemap\n\" &gt;&gt; _config.yml\n</code></pre></div></div>\n\n<p>Sitemap will be automatically generated with <code class=\"highlighter-rouge\">jekyll serve</code>. Add <code class=\"highlighter-rouge\">sitemap:\nfalse</code> for pages that you don’t want to appear in sitemap (like google site\nverification).</p>\n\n<h1 id=\"jekyll-variables-and-categories\">Jekyll variables and categories</h1>\n\n<p>Jekyll contains <a href=\"https://jekyllrb.com/docs/variables/\">variables</a>: <code class=\"highlighter-rouge\">site</code>,\n<code class=\"highlighter-rouge\">layout</code>, <code class=\"highlighter-rouge\">content</code>, <code class=\"highlighter-rouge\">paginator</code> and <code class=\"highlighter-rouge\">page</code>.</p>\n\n<p><code class=\"highlighter-rouge\">{ { site }}</code> is <code class=\"highlighter-rouge\">Jekyll::Drops::SiteDrop</code> class and contains</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">site.posts</code> array of all posts objects <code class=\"highlighter-rouge\">Jekyll::Document collection=post</code></li>\n  <li><code class=\"highlighter-rouge\">site.pages</code> array of all pages <code class=\"highlighter-rouge\">Jekyll::Page</code></li>\n</ul>\n\n<p><code class=\"highlighter-rouge\">{ { page }}</code> is an object with</p>\n<ul>\n  <li><code class=\"highlighter-rouge\">page.content</code> preproccessed content</li>\n  <li><code class=\"highlighter-rouge\">page.name</code> like <code class=\"highlighter-rouge\">contact.md</code></li>\n  <li><code class=\"highlighter-rouge\">page.path</code> like <code class=\"highlighter-rouge\">example/contact.md</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">page.url</code> like <code class=\"highlighter-rouge\">/example/contact.html</code></p>\n  </li>\n  <li>all front matters variables like <code class=\"highlighter-rouge\">page.layout</code>, <code class=\"highlighter-rouge\">page.title</code></li>\n</ul>\n\n<p>if current page is post we have additional properties</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">page.title</code></li>\n  <li><code class=\"highlighter-rouge\">page.excerpt</code></li>\n  <li><code class=\"highlighter-rouge\">page.date</code></li>\n  <li><code class=\"highlighter-rouge\">page.id</code></li>\n  <li><code class=\"highlighter-rouge\">page.categories</code></li>\n  <li><code class=\"highlighter-rouge\">page.tags</code></li>\n  <li><code class=\"highlighter-rouge\">page.next</code> <code class=\"highlighter-rouge\">page.previous</code></li>\n</ul>\n\n<p>You can put your posts inside folder, for examle <code class=\"highlighter-rouge\">kayak/canoe/_posts</code>. This\nmeans that posts will have <code class=\"highlighter-rouge\">['kayak', 'canoe']</code> categories. You can add more\ncategories using front matter <code class=\"highlighter-rouge\">categories: sprint</code>.</p>\n\n<p>Since pages do not have category, you cat mark them manually or check path, like\nthis</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{ % capture page_category = page.path | split: '/' | first %}\n</code></pre></div></div>\n\n<p>To list similar posts you can  use this snippet in <code class=\"highlighter-rouge\">_layout/default.html</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;style type='text/css'&gt;\n  .similar-links {\n    display: inline-block;\n    padding: 10px;\n  }\n&lt;/style&gt;\n{% for cat in page.categories %}\n  {% if site.categories.[cat].size != 1  %}\n    &lt;ul class=\"similar-links\"&gt;\n      &lt;li&gt;Look similar &lt;b&gt; {{ cat }}&lt;/b&gt; tag:&lt;/li&gt;\n      {% for p in site.categories.[cat] %}\n        {% unless p.url == page.url  %}\n          &lt;li&gt;\n            &lt;a href=\"{{ p.url }}\"&gt;{{ p.title }}&lt;/a&gt;\n          &lt;/li&gt;\n        {% endunless %}\n      {% endfor %}\n    &lt;/ul&gt;\n  {% endif  %}\n{% endfor %}\n</code></pre></div></div>\n\n<h1 id=\"search\">Search</h1>\n\n<p>Just copy and paste <code class=\"highlighter-rouge\">search.json</code> and other snippets from\n<a href=\"https://github.com/christian-fei/Simple-Jekyll-Search\">Simple-Jekyll-Search</a></p>\n\n<h1 id=\"404\">404</h1>\n\n<p>For gh-pages, you just need <code class=\"highlighter-rouge\">404.html</code> at root for server to use it when it does\nnot find the page.</p>\n\n<h1 id=\"config\">Config</h1>\n\n<p>You can serve using different port, just add <code class=\"highlighter-rouge\">port: 4001</code> to your <code class=\"highlighter-rouge\">_config.yml</code>\nfile.</p>\n\n<h1 id=\"theme\">Theme</h1>\n\n<p>If you want to <a href=\"https://jekyllrb.com/docs/themes/#creating-a-gem-based-theme\">create\ntheme</a> you can\nfollow this steps:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>jekyll new-theme jekyll-theme-booster\nvi jekyll-theme-booster.gemspec\n# edit description and url\ngem build jekyll-theme-booster.gemspec\ngem install jekyll-theme-booster-0.1.0.gem\n</code></pre></div></div>\n\n<h2 id=\"running-example-site\">Running example site</h2>\n\n<p>You can put posts inside root folder but than you do not know which file belongs\nto theme and which is just example. So better is to use separated folder and use\n<code class=\"highlighter-rouge\">rake example</code> to run that site.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Rakefile\n# based on\n# https://github.com/mmistakes/minimal-mistakes/blob/master/Rakefile\nrequire \"bundler/gem_tasks\"\nrequire \"jekyll\"\nrequire \"listen\"\n\ndef listen_ignore_paths(base, options)\n  [\n    /_config\\.ya?ml/,\n    /_site/,\n    /\\.jekyll-metadata/\n  ]\nend\n\ndef listen_handler(base, options)\n  site = Jekyll::Site.new(options)\n  Jekyll::Command.process_site(site)\n  proc do |modified, added, removed|\n    t = Time.now\n    c = modified + added + removed\n    n = c.length\n    relative_paths = c.map{ |p| Pathname.new(p).relative_path_from(base).to_s }\n    print Jekyll.logger.message(\"Regenerating:\", \"#{relative_paths.join(\", \")} changed... \")\n    begin\n      Jekyll::Command.process_site(site)\n      puts \"regenerated in #{Time.now - t} seconds.\"\n    rescue =&gt; e\n      puts \"error:\"\n      Jekyll.logger.warn \"Error:\", e.message\n      Jekyll.logger.warn \"Error:\", \"Run jekyll build --trace for more information.\"\n    end\n  end\nend\n\ntask :example do\n  base = Pathname.new('.').expand_path\n  options = {\n    \"source\"        =&gt; base.join('example').to_s,\n    \"destination\"   =&gt; base.join('example/_site').to_s,\n    \"force_polling\" =&gt; false,\n    \"serving\"       =&gt; true,\n    \"theme\"         =&gt; \"jekyll-theme-booster\"\n  }\n\n  options = Jekyll.configuration(options)\n\n  ENV[\"LISTEN_GEM_DEBUGGING\"] = \"1\"\n  listener = Listen.to(\n    base.join(\"_includes\"),\n    base.join(\"_layouts\"),\n    base.join(\"_sass\"),\n    base.join(\"assets\"),\n    options[\"source\"],\n    :ignore =&gt; listen_ignore_paths(base, options),\n    :force_polling =&gt; options['force_polling'],\n    &amp;(listen_handler(base, options))\n  )\n\n  begin\n    listener.start\n    Jekyll.logger.info \"Auto-regeneration:\", \"enabled for '#{options[\"source\"]}'\"\n\n    unless options['serving']\n      trap(\"INT\") do\n        listener.stop\n        puts \"     Halting auto-regeneration.\"\n        exit 0\n      end\n\n      loop { sleep 1000 }\n    end\n  rescue ThreadError\n    # You pressed Ctrl-C, oh my!\n  end\n\n  Jekyll::Commands::Serve.process(options)\nend\n</code></pre></div></div>\n\n<h2 id=\"editing-theme\">Editing theme</h2>\n\n<p>Only files that are in repository are used for gem. gemspec uses <code class=\"highlighter-rouge\">git ls-files</code>\nand default gemspec is to inlude <code class=\"highlighter-rouge\">assets</code>, <code class=\"highlighter-rouge\">_includes</code>, <code class=\"highlighter-rouge\">_layouts</code> and <code class=\"highlighter-rouge\">_sass</code>.\nYou can see what is in gem with <code class=\"highlighter-rouge\">gem open jekyll-theme-booster</code>.</p>\n\n<p>Some files will not be used: <code class=\"highlighter-rouge\">_config.yml</code>.</p>\n\n<h2 id=\"using-theme\">Using theme</h2>\n\n<p>When you edit template, you need to build, install and restart your jekyll serve\nproccess to load updated gem.</p>\n\n<p>It is enough to specify\npath as <code class=\"highlighter-rouge\">&lt;link rel=\"stylesheet\" href=\"assets/css/animate.css\"&gt;</code> but for relative\nfolder <code class=\"highlighter-rouge\">&lt;link rel=\"stylesheet\" href=\"{ { \"assets/css/animate.css\" | relative_url }}\"&gt;</code> (that is needed for all navigational links).</p>\n\n<p>It is advised to be in same ruby version <code class=\"highlighter-rouge\">rvm list</code> and <code class=\"highlighter-rouge\">rvm gemset list</code>.</p>\n\n<p>Another theme example is\n<a href=\"https://github.com/mmistakes/minimal-mistakes\">minimal-mistakes-jekyll</a></p>\n\n<p>Yet another theme\n<a href=\"https://tympanus.net/codrops/2018/04/20/freebie-oasis-jekyll-website-template\">https://tympanus.net/codrops/2018/04/20/freebie-oasis-jekyll-website-template</a></p>\n\n<h1 id=\"markdown\">Markdown</h1>\n\n<ul>\n  <li><a href=\"https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet#tables\">table</a>\ncan be generated with <code class=\"highlighter-rouge\">|header1|header2</code></li>\n  <li>url can be written like <code class=\"highlighter-rouge\">&lt;http://projektor.trk.in.rs&gt;</code> (<code class=\"highlighter-rouge\">http://</code> at the\nbeggining is mandatory) instead of writting it twice\n<code class=\"highlighter-rouge\">[http://projektor.trk.in.rs](http://projektor.trk.in.rs)</code></li>\n  <li>internal link to post is with <code class=\"highlighter-rouge\">{% %}</code> like\n<code class=\"highlighter-rouge\">[My page]({% link 2016-03-02-my-page.markdown %})</code></li>\n  <li>images <code class=\"highlighter-rouge\">![alt text]({ { site.base_url }}/assets/path_to_image \"Title text\")</code></li>\n  <li>strikethrough (words crossed, deleted, removed text) can be used with\n<code class=\"highlighter-rouge\">&lt;s&gt;Example&lt;/s&gt;</code> or <code class=\"highlighter-rouge\">&lt;del&gt;Example&lt;/del&gt;</code> (with kramdown no shortcut works\nlike <code class=\"highlighter-rouge\">-- ~~</code>)</li>\n  <li>for code you can use <code class=\"highlighter-rouge\">{% highlight javascript  %}</code>, <code class=\"highlighter-rouge\">{%\nhighlight ruby %}</code>, <code class=\"highlighter-rouge\">{% highlight bash %}</code></li>\n</ul>\n\n<h1 id=\"liquid-in-markdown\">Liquid in markdown</h1>\n\n<ul>\n  <li>to show jekyll mustache inline you can add space, like <code class=\"highlighter-rouge\">{ % bla_tag %}</code>. Note\nthat in blocks of code you can use mustache, so this is only for inside tick.</li>\n  <li>to show <code class=\"highlighter-rouge\">{{  }}</code> using <em>markdown</em> you need to escape them like\n<code class=\"highlighter-rouge\">{{ '{{  ' }} }}</code> first closing brackets will close everything that\ncomes after first opening brackets. All other closing brackets are simply\nrendered. This does not work if that line breaks in mutliple lines (probably\nstring need + or something). To simplify I just put space between first\n<code class=\"highlighter-rouge\">{ { }}</code></li>\n  <li>if you need to show <strong>`</strong> than use backslash or put a space ` so it\nwont be applied`</li>\n</ul>\n\n<h1 id=\"liquid-tags\">Liquid Tags</h1>\n\n<p><a href=\"https://github.com/Shopify/liquid/wiki/Liquid-for-Designers\">Liquid for\ndesigners</a> and\n<a href=\"http://shopify.github.io/liquid/\">http://shopify.github.io/liquid/</a> are all docs you need.\n<a href=\"http://cheat.markdunkley.com/\">http://cheat.markdunkley.com/</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">{ % assign my_var = [1, 2] %}</code> assigns some value to variable</li>\n  <li><code class=\"highlighter-rouge\">{ % capture my_id %} name-{ { item.name | handleize }} { % endcapture %}</code>\ncaptures block text</li>\n  <li><code class=\"highlighter-rouge\">{ % include some_file id=\"some_value\" %}</code> include snippet, you can pass\narguments to include and use it inside like <code class=\"highlighter-rouge\">{ % if include.id %} { % assign\ntarget_page = page.[include.id] %} { % endif %}</code></li>\n  <li><code class=\"highlighter-rouge\">{ % comment %} my comment { % endcomment %}</code></li>\n  <li><code class=\"highlighter-rouge\">{ % if statement %} { % elsif false %} { % endif %}</code> where statement can be\n    <ul>\n      <li>comparison <code class=\"highlighter-rouge\">==</code>, <code class=\"highlighter-rouge\">!=</code>, <code class=\"highlighter-rouge\">&lt;=</code></li>\n      <li>arrays <code class=\"highlighter-rouge\">contains</code></li>\n      <li>boolean operator <code class=\"highlighter-rouge\">and</code> <code class=\"highlighter-rouge\">or</code></li>\n      <li>There is no negative, not <code class=\"highlighter-rouge\">!</code> and there is no parentheses (use nested if)</li>\n    </ul>\n  </li>\n  <li><code class=\"highlighter-rouge\">{ % for item in array %} { % break %} { % continue %} { % endfor %}</code>\n    <ul>\n      <li>when iterating a hash <code class=\"highlighter-rouge\">item[0]</code> is key and <code class=\"highlighter-rouge\">item[1]</code> is value</li>\n      <li>iterating over ranges <code class=\"highlighter-rouge\">{ % for i in (1..item.quantity) %}</code> or <code class=\"highlighter-rouge\">{ % for\nmember in ste.data.members %}</code></li>\n      <li>helper variables inside loop <code class=\"highlighter-rouge\">forloop.length</code>, <code class=\"highlighter-rouge\">forloop.index0</code>,\n<code class=\"highlighter-rouge\">forloop.last</code></li>\n      <li>3 optional arguments <code class=\"highlighter-rouge\">{ % for item in array limit:2 offset:3 reversed %}</code></li>\n      <li>you can use <code class=\"highlighter-rouge\">{ % else %}</code> to show when array is empty</li>\n    </ul>\n  </li>\n  <li>\n    <p><code class=\"highlighter-rouge\">{ % cycle 'blue', 'white', 'red' %}</code> will repeat those colors, Usefull when\niterating for bootstrap row col</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    \n</code></pre></div>    </div>\n  </li>\n  <li><code class=\"highlighter-rouge\">{ % case my_var %} { % when 'dule' or 'mile' %} { % else } { % endcase %}</code></li>\n</ul>\n\n<p>Internal jekyll tags</p>\n\n<p><a href=\"https://jekyllrb.com/docs/templates/#links\">link</a>\nNote that you do not have to use quotes: <code class=\"highlighter-rouge\">'</code> or <code class=\"highlighter-rouge\">\"</code>.</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">{ % post_url %}</code>. Note that you can not use string filters like <code class=\"highlighter-rouge\">prepend: </code>\n inside tags (works only with double curly brackets <code class=\"highlighter-rouge\">{ { }}</code>, so for link to\nanother post (by it’s file name) when <code class=\"highlighter-rouge\">site.baseurl</code> is set, <a href=\"https://github.com/jekyll/jekyll/issues/3708\">you\nneed</a> <code class=\"highlighter-rouge\">[my-post]({ {\nsite.baseurl }}{ % post_url 2015-12-20-my-post %})</code></li>\n  <li>when you want to link assets you can use <code class=\"highlighter-rouge\">{ { \"/assets/style.css\" |\nrelative_url }}</code></li>\n  <li>you can link to (link_to) pages also (not just posts) with <code class=\"highlighter-rouge\">{ { site.baseurl\n}}{ % link news/index.html %}</code>. Parameter for <code class=\"highlighter-rouge\">link</code> should contain extension\n(for example <code class=\"highlighter-rouge\">.md</code>).</li>\n</ul>\n\n<h1 id=\"types\">Types:</h1>\n\n<ul>\n  <li>boolean, nil, string, integer, array and hash\n    <ul>\n      <li>integer can be incremented <code class=\"highlighter-rouge\">{ % increment my_int %}</code> or <code class=\"highlighter-rouge\">{ % decrement\nmy_int %}</code></li>\n      <li>range is defined similar to ruby <code class=\"highlighter-rouge\">{ % for i in (1..my_int) %}</code></li>\n      <li>to use sum operation, for example add two number you can use</li>\n    </ul>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  \n{ % for i in (1..number_of_columns) %}\n</code></pre></div>    </div>\n  </li>\n  <li>array elements can be accessed only like <code class=\"highlighter-rouge\">my_array[2]</code></li>\n  <li>hash elements can be accessed with <code class=\"highlighter-rouge\">my_hash['name']</code> or <code class=\"highlighter-rouge\">my_hash.name</code></li>\n  <li>you can call <code class=\"highlighter-rouge\">my_array.size</code> or <code class=\"highlighter-rouge\">my_hash.size</code></li>\n  <li>all yml files from <code class=\"highlighter-rouge\">_data</code> folder will be available under\n<code class=\"highlighter-rouge\">site.data.file_name.item</code></li>\n</ul>\n\n<h1 id=\"filters\">Filters</h1>\n\n<p>Filters or pipes is used to process data inside <code class=\"highlighter-rouge\">{ { }}</code>. Filter nam could be\nfollowed with colon <code class=\"highlighter-rouge\">:</code> to pass additinal params, for example <code class=\"highlighter-rouge\">{ { page.path |\nsplit: '/' | first | alert }}</code></p>\n\n<ul>\n  <li><a href=\"https://help.shopify.com/themes/liquid/filters/string-filters\">strings</a>\n<code class=\"highlighter-rouge\">append</code>, <code class=\"highlighter-rouge\">prepend</code>, <code class=\"highlighter-rouge\">capitalize</code>, <code class=\"highlighter-rouge\">date</code>, <code class=\"highlighter-rouge\">escape</code>, <code class=\"highlighter-rouge\">lstrip</code>, <code class=\"highlighter-rouge\">replace</code>,\n<code class=\"highlighter-rouge\">strip_html</code>, <code class=\"highlighter-rouge\">truncate</code>, <code class=\"highlighter-rouge\">url_encode</code>\n    <ul>\n      <li><code class=\"highlighter-rouge\">{ { page.date| date: 'B %d, %Y' }}</code> or <code class=\"highlighter-rouge\">{ { page.date | date_to_string }}</code>\nor <code class=\"highlighter-rouge\">{ { page.date | date: '%d-%m-%Y]]</code></li>\n    </ul>\n  </li>\n  <li><a href=\"https://help.shopify.com/themes/liquid/filters/array-filters\">arrays</a>\n<code class=\"highlighter-rouge\">first</code>, <code class=\"highlighter-rouge\">join</code>, <code class=\"highlighter-rouge\">last</code>, <code class=\"highlighter-rouge\">map</code>, <code class=\"highlighter-rouge\">reverse</code>, <code class=\"highlighter-rouge\">size</code>, <code class=\"highlighter-rouge\">slice</code>, <code class=\"highlighter-rouge\">uniq</code>\n    <ul>\n      <li><code class=\"highlighter-rouge\">map</code> uses string as argument (<code class=\"highlighter-rouge\">\" \"</code> are required). Another example is\n<a href=\"https://shopify.github.io/liquid/filters/map/\">liquid github</a></li>\n      <li>create with <code class=\"highlighter-rouge\">{ % assign my_array = \"ants, bugs, bees, bugs, ants\" | split:\n\", \" %}</code></li>\n    </ul>\n  </li>\n</ul>\n\n<p>If you need to assign filter output to variable you can use <code class=\"highlighter-rouge\">{ % capture\nmy_var %} { { var | my_filter }} { % endcapture %}</code> or use it inside \nassign tag <code class=\"highlighter-rouge\">{ % assign all_categories = site.posts | map: \"categories\" %}</code>.</p>\n\n<p>Note that in liquid version 4 you can use <code class=\"highlighter-rouge\">concat</code> filter but it is not\nsupported in jekyll 3.4 (liquid 3.0.6) <a href=\"https://help.shopify.com/themes/liquid/filters/array-filters#concat\">concat\nexample</a>.\nIn old liquid you can use <code class=\"highlighter-rouge\">append</code> but that is only for strings.\nYou should point to latest jekyll from github which uses Liquid 4</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># get latest jekyll which uses liquid 4\ngem \"jekyll\", github: 'jekyll/jekyll'\n</code></pre></div></div>\n\n<h1 id=\"debug\">Debug</h1>\n\n<p>Debug liquid is simply output <code class=\"highlighter-rouge\">{ { my_var | inspect }}</code></p>\n\n<p>Somehow if I use <code class=\"highlighter-rouge\">contains_</code> variable name</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{ % assign contains_sidebar = true %}\n{ { contains_sidebar }}\n</code></pre></div></div>\n\n<p>than I got error like:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[:comparison, \"contains\"] is not a valid expression in \"contains_sidebar ==\nfalse\" in /_layouts/page.html`\n</code></pre></div></div>\n\n<p>Show I rename variable ``</p>\n\n<h1 id=\"adding-tag-filter\">Adding tag, filter</h1>\n\n<p>All <a href=\"https://jekyllrb.com/docs/plugins/\">plugins</a> will be loaded from <code class=\"highlighter-rouge\">_plugins</code>\nfolder. Githib ignore this folder.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># _plugins/alert_tag.rb\nmodule Jekyll\n  module AlertFilter\n    def alert(text)\n      unescaped = if text.class == String\n                  CGI.unescapeHTML text\n               else\n                 text.to_s\n               end\n      %(&lt;script&gt;\n        alert('#{unescaped}');\n        &lt;/script&gt;)\n    end\n  end\nend\nLiquid::Template.register_filter(Jekyll::AlertFilter)\n</code></pre></div></div>\n\n<p>This is used to alert text <code class=\"highlighter-rouge\">{ % alert this is text %}</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># _plugins/alert_filter.rb\nmodule Jekyll\n  module AlertFilter\n    def alert(text)\n      unescaped = if text.class == String\n                  CGI.unescapeHTML text\n               else\n                 text.to_s\n               end\n      %(&lt;script&gt;\n        alert('#{unescaped}');\n        &lt;/script&gt;)\n    end\n  end\nend\nLiquid::Template.register_filter(Jekyll::AlertFilter)\n</code></pre></div></div>\n\n<p>Filter is used like <code class=\"highlighter-rouge\">{ { page | alert }}</code></p>\n\n<h1 id=\"scss\">Scss</h1>\n\n<p>For adding scss support, you need to put your main scss file inside for example\n<code class=\"highlighter-rouge\">css/main.scss</code> and it needs to have double three lines <code class=\"highlighter-rouge\">---</code>. From there you\ncan use <code class=\"highlighter-rouge\">@import \"file_from_scss\";</code> to load partials from <code class=\"highlighter-rouge\">_sass</code> folder</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>---\n# this is css/main.scss which imports other scss files\n---\n\n@import \"overrides\";\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;!-- override default template file _includes/head.html --&gt;\n...\n  &lt;link rel=\"stylesheet\" href=\"/assets/main.css\"&gt;\n</code></pre></div></div>\n\n<h1 id=\"coffee-script\">Coffee script</h1>\n\n<p>To enable coffee script you need to add to config.yml</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; _config.yml &lt;&lt; HERE_DOC\ngems:\n  - jekyll-coffeescript\nHERE_DOC\n</code></pre></div></div>\n\n<p>And you coffee files need to have three lines <code class=\"highlighter-rouge\">---</code> for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>---\n# assets/js/cart.coffee\n---\nclass Cart\n  constructor: (@buttons, @cart) -&gt;\n    @buttons.click (event) =&gt;\n      @textContent = 'Added'\n      do event.preventDefault\n      itemContainer = event.target.parentNode.parentNode.parentNode\n      itemNumber = do $ itemContainer\n      .find 'h3.panel-title'\n      .text\n\n      listItem = do $ @cart\n      .find 'li:last'\n      .clone\n\n      listItem.text itemNumber\n      @cart.append listItem\n      .hide()\n      .fadeIn 'slow'\n\n\n      console.log itemContainer\n\n$ -&gt;\n  cart = new Cart $('form button'), $('ul#cart')\n</code></pre></div></div>\n\n<p>and they will be compiled, so you can include them <code class=\"highlighter-rouge\">&lt;script\nsrc=\"assets/js/cart.js\"&gt;&lt;/script&gt;</code></p>\n\n<h1 id=\"rails\">Rails</h1>\n\n<p>https://www.sitepoint.com/jekyll-rails/</p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>if you want to move page it is advised to leave old page some time so you do\nnot confuse crawlers. You can add redirection in html</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c\">&lt;!-- narucivanje.html --&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;meta</span> <span class=\"na\">http-equiv=</span><span class=\"s\">\"refresh\"</span> <span class=\"na\">content=</span><span class=\"s\">\"0; url=http://tasterkljuc.rs/naruci\"</span><span class=\"nt\">/&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    You are redirected to http://tasterkljuc.rs/naruci\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<h1 id=\"slides\">Slides</h1>\n\n<p>Google io slides can be found https://github.com/willnorris/io-slides\nAfter you clone the repository</p>\n\n<p><a href=\"https://jekyllrb.com/docs/plugins/\">https://jekyllrb.com/docs/plugins/</a>\n<a href=\"https://github.com/planetjekyll/awesome-jekyll\">https://github.com/planetjekyll/awesome-jekyll</a>\n<a href=\"https://github.com/planetjekyll/awesome-jekyll-plugins\">https://github.com/planetjekyll/awesome-jekyll-plugins</a></p>\n\n<p>https://mademistakes.com/articles/using-jekyll-2016/</p>\n\n"
    } ,
  
    {
      "title"    : "Ruby memory leak trackdown",
      "category" : "",
      "tags"     : "",
      "url"      : "/2015/09/10/ruby-memory-leak-track/",
      "date"     : "2015-09-10 00:00:00 +0200",
      "content"  : "<h1 id=\"plotting-on-png\">Plotting on png</h1>\n\n<p>In any ruby code you can use this snippet</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/memory_profiler.rb\n# Show current process memory in log. Creat memory.log with\n# tail log/production.log -f | grep -o MEMORY.* --line-buffered | tee log/memory.log\n# you need to remove *rails_12factor* heroku gem to see *log/production.log'\n# and export RAILS_SERVE_STATIC_FILES=true\nif Rails.application.secrets.memory_profiler\n  Thread.new do\n    Kernel.loop do\n      pid = Process.pid\n      rss = `ps -eo pid,rss | grep #{pid} | awk '{print $2}'`.to_i\n      Rails.logger.info \"MEMORY[#{pid}]: time: #{Time.now} rss: #{rss}, live_objects: #{GC.stat[:heap_live_slots]}\"\n      sleep 1\n    end\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/secrets.yml\n  # memory profiler\n  memory_profiler: &lt;%= ENV[\"MEMORY_PROFILER\"] || false %&gt;\n</code></pre></div></div>\n\n<p>You can use <a href=\"https://github.com/schneems/get_process_mem\">get_process_mem gem</a>\nbut it would be the same number as this <code class=\"highlighter-rouge\">rss</code> local value. Note that those are\nkilobytes.\n<code class=\"highlighter-rouge\">GC.stat[:heap_live_slots]</code> is not available before ruby 2.1.</p>\n\n<p>It’s good to have similar env as on production, so it’s better to <a href=\"/2016/04/12/rails-tips/#dump-database\">dump\ndatabase</a>\nand <a href=\"/2016/04/12/rails-tips/#run-rails-in-production-mode\">run in production mode</a> than to\ncreate fake seed data.</p>\n\n<p>You don’t need to download database if you can deploy and download memory log.\nOn heroku you can use <code class=\"highlighter-rouge\">heroku logs -t | tee log/production.log</code> or just download\nif you some log service enabled (like Logentries).</p>\n\n<p>You can see which pages are most used by greping only GET requests, <code class=\"highlighter-rouge\">-o</code>\nis only, <code class=\"highlighter-rouge\">s/</code> is supstitute, <code class=\"highlighter-rouge\">-v</code> don’t include auth pages.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>grep -o 'Started GET \".*\" for' log/development.log |\nsed 's/Started GET \"/http:\\/\\/localhost:3000/' |\nsed 's/\" for$//' |\ngrep -v auth |\ntee urls.txt\n</code></pre></div></div>\n\n<p>To plot data you need to grep specific format to create <em>log/memory_profile.log</em>\nand to run <code class=\"highlighter-rouge\">gnuplot lib/memory_profile.gp</code>\nand open image with <code class=\"highlighter-rouge\">gnome-open tmp/memory_profile.png</code>. If your\nimage viewer does not automatically refresh, you open image in firefox <code class=\"highlighter-rouge\">firefox\n./tmp/memory_prifile.png</code> or using <code class=\"highlighter-rouge\">feh --reload 2 tmp/memory_profile.png</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>tail log/development.log -f | grep -o MEMORY.* --line-buffered | tee log/memory_profile.log | gnuplot lib/memory_profile.gp\n\n# or my function\nshow_memory\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># lib/memory_prifile.gp\n#!/usr/bin/gnuplot\n\n# to see image, run with:\n# gnuplot docs/memory_profile.gp\n# gnome-open tmp/memory_profile.png\n\nreset\nset terminal png\nset output \"tmp/memory_profile.png\"\n\nset xdata time\nset timefmt \"%Y-%m-%d %H:%M:%S\"\nset format x \"%H:%M\"\nset xlabel \"time\"\n\nset ylabel \"memory\"\nset y2label \"heap_live_objects\"\n#set yrange [0:1000000]\nset y2tics\n\nset title \"rss\"\nset grid\nset style data linespoints\n\nplot \"log/memory_profile.log\" using 3:7 with lines title \"rss\", \\\n  \"\" using 3:9 with lines lc rgb 'blue' title \"heap_live_objects\" axes x1y2\n\npause 5\nreread\n</code></pre></div></div>\n\n<p><img src=\"/assets/posts/memory_profile.png\" alt=\"memory profile\" /></p>\n\n<p>You can see that live objects (blue line) goes up and down, and memory rss is\nusually increasing (around 600MB)</p>\n\n<h1 id=\"tutorials\">Tutorials</h1>\n\n<p>videos\nGoruco 2010 Aman Gupta: memprof https://vimeo.com/12748731\nGoruco 2014 Aaron Quint: ruby perfomance tooling https://www.youtube.com/watch?v=cOaVIeX6qGg\nRocky Mountain Ruby 2014, Hemant Kumar, RBKit https://www.youtube.com/watch?v=hcaYjiAIres</p>\n\n<p>blog post from github https://github.com/blog/1475-escape-velocity</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>types = Hash.new(0)\nObjectSpace.each_object do |obj|\ntypes[obj.class] += 1\nend\npp types.sort_by { |klass,num| num }\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>./bin.rbtrace -p 8963 -e 'GC.start(full_mark: true); require \"objspace\";\\\nObjectSpace.dump_all( output: File.open(\"heap.json\",\"w\"))\"\n</code></pre></div></div>\n\n<p>http://blog.codeship.com/debugging-a-memory-leak-on-heroku/</p>\n\n<h2 id=\"discourse\">Discourse</h2>\n\n<ul>\n  <li>http://samsaffron.com/archive/2013/11/22/demystifying-the-ruby-gc</li>\n  <li>benchmarking localy https://meta.discourse.org/t/benchmarking-discourse-locally/9070</li>\n  <li></li>\n</ul>\n\n<h1 id=\"about-gc-garbage-collector\">About GC Garbage collector</h1>\n\n<h2 id=\"helpers\">Helpers</h2>\n\n<p>We will use those helpers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>def gc_stat_for(property = :total_freed_objects)\n  init = GC.stat(property)\n  yield\n  GC.stat(property) - init\nend\n\ndef mem\n  `ps -eo pid,rss | grep #{$PID} | awk '{print $2}'`.to_i * 1.kilobyte\nend\n\ndef gc_start(options = { full_mark: true, immediate_sweep: true })\n  GC.start options\nend\n\ndef h number\n  ActionController::Base.helpers.number_to_human number\nend\n\ndef hs number\n  ActionController::Base.helpers.number_to_human_size number\nend\n</code></pre></div></div>\n\n<h2 id=\"allocated-memory-is-slowly-released\">Allocated memory is slowly released</h2>\n\n<p>Allocated memory of ryby process in practice is never decreasing. Once is\nallocated, GC can clear it but it will not return to the OS. It will stay\nreferenced for that ruby proccess some time. So if one request makes a lot of\nobjects, memory will stays big and you will be charged for that memory until\nprocess dies. So advice is to find those requests and optimize them\n(pagination).</p>\n\n<p>For example, if we stop GC and allocate a bunch or arrays but do not\nreturn them from method, than memory will stay the same before and after we\nGC.start.</p>\n\n<p>Note that to actually allocate memory.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gc_start\nGC.disable\n\ndef make_objects\n  non_return_array = []\n  1.upto(1_000_000).each { |i| non_return_array &lt;&lt; \"#{i}\" }\n  return nil\nend\nmake_objects\n\nGC.enable\nbefore = GC.stat[:total_freed_objects]\ngc_start\nafter = GC.stat[:total_freed_objects]\nh after - before\nhs mem\n# we can see that objects are freed but process still has a lot of memory\n</code></pre></div></div>\n\n<h2 id=\"initial-gc\">Initial GC</h2>\n\n<p>There is slight memory backlog before GC starts.\nYou can manually rub GC with <code class=\"highlighter-rouge\">GC.start</code>. Than you can see that in first\niteration, not all MB is free,</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>GC.start\ngc_stat_for { 1_000_000.times { local = \"asdf\" } }\n# =&gt; \"727 Thousand\"\ngc_stat_for { 1_000_000.times { local = \"asdf\" } }\n# =&gt; \"1 Million\"\n</code></pre></div></div>\n\n<h2 id=\"gc-commands\">GC commands</h2>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">GC.enable</code> <code class=\"highlighter-rouge\">GC.disable</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">GC.start full_mark: true, </code>immediate_sweep: true`</p>\n  </li>\n  <li><code class=\"highlighter-rouge\">GC.stat[:total_allocated_objects]</code></li>\n  <li><code class=\"highlighter-rouge\">GC.stat[:total_freed_objects]</code> number of objects that are GC-ed</li>\n  <li><code class=\"highlighter-rouge\">GC.stat[:heap_live_slots]</code></li>\n</ul>\n\n<h1 id=\"server-loading\">Server loading</h1>\n\n<p>For ajax requests, you need to set <code class=\"highlighter-rouge\">-H 'Content-Type:application/javascript;'</code>\n(I don’t know why this does not work on rails).For logged in users you need to\nset <code class=\"highlighter-rouge\">-H 'Cookie: asd=asd'</code> where <em>asd</em> is keys which you can find in Chrome -&gt;\nChrome developer tools -&gt; tab Resources -&gt; submenu Cookies -&gt; localhost -&gt; very\nbig <em>name</em> (~127 chars) and <em>value</em> (~542 chars)</p>\n\n<p>Simulate load</p>\n\n<p><code class=\"highlighter-rouge\">ab -n 500 -c 5 -C 'asd123=asd123' http://yourapp.com/</code></p>\n\n<h1 id=\"tips\">Tips</h1>\n\n<ul>\n  <li>\n    <p>in-place modification is faster since it does not create new objects</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>e.downcase.gsub\n# in place is faster\ne.downcase!\ne.gsub!\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>limit number of columns that you retrieve from db</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Post.all.select [:id, :name]\nPost.all.joins(:comments).select(\"posts.name\", \"comments.body\")\nPost.find_in_batches\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>do plain sql to retreive array instead of ActiveRecord (3x size of data, and\nallocate 2 objects per data value)</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ActiveRecord::Base.connection.execute(\"...\")\n</code></pre></div>    </div>\n  </li>\n  <li>\n    <p>kill ruby process if it takes more than 200MB since GC will take more than\n100ms to run <a href=\"https://youtu.be/5dgjeCdVEPs?t=2550\">video</a></p>\n  </li>\n</ul>\n\n<h1 id=\"links\">Links</h1>\n\n<ul>\n  <li>memory_profiler gem <a href=\"https://github.com/SamSaffron/memory_profiler\">https://github.com/SamSaffron/memory_profiler</a></li>\n</ul>\n\n<h1 id=\"todo\">TODO</h1>\n\n<p>http://thorstenball.com/blog/2014/03/12/watching-understanding-ruby-2.1-garbage-collector/</p>\n\n<h2 id=\"ttm1\">TTM1</h2>\n\n<ul>\n  <li>http://tmm1.net/</li>\n  <li>http://tmm1.net/ruby21-rgengc/</li>\n</ul>\n\n<h2 id=\"how-rails-show-fixes-in-memory\">How rails show fixes in memory</h2>\n\n<ul>\n  <li>https://github.com/rails/rails/pull/21523</li>\n</ul>\n\n<h1 id=\"rack-memory-profiles\">Rack memory profiles</h1>\n\n<p>Gem rack-mini-profiler <a href=\"https://github.com/MiniProfiler/rack-mini-profiler\">https://github.com/MiniProfiler/rack-mini-profiler</a>\nI add simple widget on top left corner of the page. Does not work when <code class=\"highlighter-rouge\">render\njson: data</code> (it has to be html).\nAdd to your gemfile</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># for profiling memory and sql\ngem 'rack-mini-profiler'\ngem 'flamegraph'\ngem 'stackprof' # ruby 2.1+ only\ngem 'memory_profiler'\n</code></pre></div></div>\n\n<p>By default it is enabled, to disable you need to</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/rack_profiler.rb\nRack::MiniProfiler.config.authorization_mode = :whitelist\n</code></pre></div></div>\n\n<p>To enable for specific users you need to</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/application_controller.rb\n  before_action :enable_rack_miniprofiler_for_admin\n  def enable_rack_miniprofiler_for_admin\n    if current_user &amp;&amp; Rails.application.secrets.admin_emails.include?(current_user.email) &amp;&amp; params[:profiler] == \"true\"\n       Rack::MiniProfiler.authorize_request\n    end\n  end\n</code></pre></div></div>\n\n<h1 id=\"links-1\">Links</h1>\n\n<ul>\n  <li><a href=\"https://github.com/tmm1/rblineprof\">rblineprof</a></li>\n  <li><a href=\"https://github.com/tmm1/stackprof\">stackprof</a> replacing <a href=\"https://github.com/tmm1/perftools.rb\">perftools</a></li>\n  <li><a href=\"https://github.com/quirkey/stackprof-remote\">stackprof-remote</a>\nallocation_tracer</li>\n</ul>\n\n<p><a href=\"https://github.com/ruby-prof/ruby-prof\">ruby-prof</a>\nhttps://github.com/tmm1/rbtrace</p>\n\n<p>http://blog.skylight.io/hunting-for-leaks-in-ruby/\nhttp://www.slideshare.net/engine_yard/debugging-ruby</p>\n\n<p>http://www.linuxatemyram.com/play.html\nhttps://tunemygc.com/configs/f4179cc82e52ba59155dc285802e0a89</p>\n\n<p>videos</p>\n\n<ul>\n  <li><a href=\"https://www.youtube.com/watch?v=yxhrYiqatdA\">https://www.youtube.com/watch?v=yxhrYiqatdA</a></li>\n</ul>\n\n<p>https://medium.com/rubyinside/how-we-halved-our-memory-consumption-in-rails-with-jemalloc-86afa4e54aa3</p>\n"
    } ,
  
    {
      "title"    : "Svg Css3 Transforms And Animations",
      "category" : "",
      "tags"     : "",
      "url"      : "/2015/08/22/svg-css3-transforms-and-animations/",
      "date"     : "2015-08-22 00:00:00 +0200",
      "content"  : "<h1 id=\"animatecss-and-wow\">Animate.css and WoW</h1>\n\n<p>Before you dive into details, you can try\n<a href=\"https://github.com/daneden/animate.css\">animate</a> and\n<a href=\"https://github.com/matthieua/WOW\">wow</a> to trigger it on scroll.\nSo you can just add classes to your elements, like <code class=\"highlighter-rouge\">hinge</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n  <span class=\"nt\">&lt;link</span> <span class=\"na\">rel=</span><span class=\"s\">\"stylesheet\"</span> <span class=\"na\">href=</span><span class=\"s\">\"https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.4.0/animate.css\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;script </span><span class=\"na\">src=</span><span class=\"s\">\"https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.js\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;/script&gt;</span>\n  <span class=\"nt\">&lt;script&gt;</span>\n    <span class=\"k\">new</span> <span class=\"nx\">WOW</span><span class=\"p\">().</span><span class=\"nx\">init</span><span class=\"p\">();</span>\n  <span class=\"nt\">&lt;/script&gt;</span>\n<span class=\"nt\">&lt;/head&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"animated fadeInRightBig\"</span><span class=\"nt\">&gt;</span>\n      Content to Reveal Here\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<h1 id=\"transform-property\">Transform property</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>div {\n  transform: scale(2,3);\n}\n</code></pre></div></div>\n\n<p>Note that element still occupy initial size. If you wrap with <code class=\"highlighter-rouge\">&lt;span&gt;</code> than you\nneed to set <code class=\"highlighter-rouge\">display: inline-block</code> (<code class=\"highlighter-rouge\">width</code> and <code class=\"highlighter-rouge\">height</code> can only be applied to\ninline-block or block).</p>\n\n<p>2D transforms:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">translate(50px, 100px)</code> is 50px right and 100px down</li>\n  <li><code class=\"highlighter-rouge\">rotate(20deg)</code> clockwise</li>\n  <li><code class=\"highlighter-rouge\">scale(2,3)</code> width 2 times and height 3 times bigger</li>\n  <li><code class=\"highlighter-rouge\">skewX(20deg)</code> <code class=\"highlighter-rouge\">skewY(-10deg)</code> and <code class=\"highlighter-rouge\">skew(20deg,-10deg)</code></li>\n  <li><code class=\"highlighter-rouge\">matrix(6 params)</code></li>\n</ul>\n\n<p>another usefull property is <code class=\"highlighter-rouge\">transform-origin: 50% 50% 0</code> which\nmove the base of transform, on x, y and z axis (for 3D).</p>\n\n<p>3D transforms:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">rotateX(20deg)</code> around X axis (horizontal)</li>\n  <li><code class=\"highlighter-rouge\">rotateY(20deg)</code> around Y axis (vertical)</li>\n  <li><code class=\"highlighter-rouge\">rotateZ(20deg)</code> around Z axis (toward user)</li>\n  <li>translate3d scale3d rotate3d</li>\n</ul>\n\n<p>usefull property is <code class=\"highlighter-rouge\">perspective: 400px</code> is how many pixes is\n3D element placed from the view and <code class=\"highlighter-rouge\">perspective-origin: 10% 10%</code> bootom\nposition on x and y axis.</p>\n\n<h1 id=\"transition-property\">Transition property</h1>\n\n<p>Transition allows that element change property smoothly, over given duration.\nSome of the timing functions could be: <code class=\"highlighter-rouge\">ease</code>, <code class=\"highlighter-rouge\">ease-in</code>, <code class=\"highlighter-rouge\">ease-in-out</code>,\n<code class=\"highlighter-rouge\">linear</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>div {\n  transition: width 2s ease-out 1s;\n  // or\n  transition-property: width;\n  transition-duration: 2s;\n  transition-timing-function: ease-out;\n  transition-delay: 1s;\n}\n</code></pre></div></div>\n\n<p>usually we change properties on hover.</p>\n\n<h1 id=\"animation-property\">Animation property</h1>\n\n<p>so you don’t need user action to animate…</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>div {\n  animation: example 5s linear 2s infinite alternate;\n  // or\n  animation-name: example;\n  animation-duration: 5s;\n  animation-timing-function: linear;\n  animation-delay: 2s;\n  animation-iteration-count: infinite;\n  animation-direction: alternate;\n\n  animation-fill-mode: forwards;\n}\n\n@keyframes example {\n  0% { width: 10px; }\n  25% { width: 100px; }\n  100% { width: 110px; }\n}\n</code></pre></div></div>\n\n<h1 id=\"inkscape\">Inkscape</h1>\n\n<p>Usefull shortcuts:</p>\n\n<ul>\n  <li>select two elements and <code class=\"highlighter-rouge\">CTRL + +</code> union, <code class=\"highlighter-rouge\">CTRL + -</code> difference (top image is\nsubstracted from bottom image)</li>\n  <li>to see the SVG code use Edit -&gt; XML Editor</li>\n  <li>inkspace fish <a href=\"https://www.youtube.com/watch?v=l3BHcregNUs&amp;t=300s\">https://www.youtube.com/watch?v=l3BHcregNUs&amp;t=300s</a></li>\n  <li>sozi <a href=\"http://sozi.baierouge.fr/pages/10-about.html\">http://sozi.baierouge.fr/pages/10-about.html</a></li>\n</ul>\n\n<h1 id=\"svg\">Svg</h1>\n\n<p>You can create SVG in Inkscape (Gimp can not export in SVG).\nIf you open existing svg or copy paste some paths, in Inkscape you can Edit -&gt;\n“Resize page to selection” to crop to fit size to include only paths.\nWhen you export you should optimize online\n<a href=\"https://jakearchibald.github.io/svgomg/\">https://jakearchibald.github.io/svgomg/</a> or inline</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>svgo file_name.svg --pretty --disable=cleanupIDs\n</code></pre></div></div>\n\n<p>or download inkscape extension\n<a href=\"https://github.com/juanfran/svgo-inkscape\">https://github.com/juanfran/svgo-inkscape</a> and use <code class=\"highlighter-rouge\">Save as \"optimized with\nsvgo\"</code> and uncheck <code class=\"highlighter-rouge\">Plugin 2 -&gt; CleanupIDS</code> if you want your grouped ids to\nremain, so you can target them in css.</p>\n\n<p>In rails you can use svg inliner <a href=\"https://github.com/jamesmartin/inline_svg\">https://github.com/jamesmartin/inline_svg</a>\nIn inkscape we can use multiple layers with same name, so id is autogenerated,\nand cleaned with svgo, so better is to use groups.</p>\n\n<ul>\n  <li>main <code class=\"highlighter-rouge\">&lt;svg width=\"123\" height=\"123\" viewBox=\"0 0 123 123\"&gt;</code>\n    <ul>\n      <li>view box has four params: x, y, width, height (those are units inside svg)</li>\n    </ul>\n  </li>\n  <li>group <code class=\"highlighter-rouge\">&lt;g id=\"petals\" fill=\"#f00\"&gt;</code> group elements</li>\n  <li>text <code class=\"highlighter-rouge\">&lt;text x=\"0\" y=\"200\" dx=\"10\"&gt;Some text&lt;/text&gt;</code> x is distance from left, y\nfrom top, dx is another drift</li>\n  <li>circle <code class=\"highlighter-rouge\">&lt;circle cx=\"1\" cy=\"1\" r=\"5\" stroke=\"green\"/&gt;</code> cx is center x, r is\nradius.</li>\n  <li>rectangle <code class=\"highlighter-rouge\">&lt;rect x=\"1\" y=\"1\" width=\"10\" height=\"10\" rx=\"1\" style=\"\" /&gt;</code> rx is\nradius of corner</li>\n  <li>ellipse <code class=\"highlighter-rouge\">&lt;ellipse cx cy rx=\"10\" ry=\"20\"/&gt;</code> cx is horizontal radius</li>\n  <li>line <code class=\"highlighter-rouge\">&lt;line x1=\"0\" y1=\"0\" x2=\"10\" y2=\"20\" /&gt;</code></li>\n  <li>polygon and polyline <code class=\"highlighter-rouge\">&lt;polygon points=\"200,10 250,190 160,210\"/&gt;</code></li>\n  <li>path: M - moveto, L - lineto, Z - closepath, H - horizontal, V -vertical\nlowercase letters is relative position, uppercase is absolutely.\n<code class=\"highlighter-rouge\">&lt;path d=\"M 50 0 L 75 200 L 225 200 Z\" /&gt;</code></li>\n</ul>\n\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths#Curve_commands\">https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths#Curve_commands</a>\nC cubic curve <code class=\"highlighter-rouge\">C x1 y1, x2, y2, x, y</code> first two are control points, (x,y) is end\nof curve.\nC followed with S <code class=\"highlighter-rouge\">S x2 y2, x y</code> is shorten version of C which is reflection.\nQ quadratic curve <code class=\"highlighter-rouge\">Q x1 y1, x y</code> is simpler since both slopes are equal. Also it\ncould be followed with T <code class=\"highlighter-rouge\">T x y</code> which will use same reflection.</p>\n\n<p>Elliptical arcs are complex to write <code class=\"highlighter-rouge\">A rx ry x-axis-rotation large-arc-flag\nsweep-flag x y</code></p>\n\n<p>Reuse components with <code class=\"highlighter-rouge\">&lt;defs&gt;</code> and <code class=\"highlighter-rouge\">&lt;simbol&gt;</code>.\n<a href=\"http://vanseodesign.com/web-design/svg-definition-reuse/\">http://vanseodesign.com/web-design/svg-definition-reuse/</a></p>\n\n<p>Attach another element with <code class=\"highlighter-rouge\">&lt;marker&gt;</code>\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG/Element/marker\">https://developer.mozilla.org/en-US/docs/Web/SVG/Element/marker</a></p>\n\n<h1 id=\"css-animations\">CSS Animations</h1>\n\n<p>You can animate using 3 ways: with css, with <code class=\"highlighter-rouge\">&lt;animate&gt;</code> and with javascript.\n<a href=\"https://www.youtube.com/watch?v=lM7cuk5DPgc&amp;feature=youtu.be\">video</a></p>\n\n<h2 id=\"svg-animate-with-css\">SVG Animate with css</h2>\n\n<p>For SVG there are custom css which can be inline like <code class=\"highlighter-rouge\">fill=\"blue\"</code> or in css</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">fill: blue</code> color of element area</li>\n  <li><code class=\"highlighter-rouge\">stroke: pink</code> color of line, text or outline</li>\n  <li><code class=\"highlighter-rouge\">stroke-width: 5</code> thickness or line, text or outline</li>\n  <li><code class=\"highlighter-rouge\">stroke-linecap: butt</code> <code class=\"highlighter-rouge\">round</code> <code class=\"highlighter-rouge\">square</code> ending of open path</li>\n  <li><code class=\"highlighter-rouge\">stroke-dasharray: 10</code> length of dashes and spaces</li>\n  <li><code class=\"highlighter-rouge\">stroke-dashoffset: 10</code> when to start dash or space, this is used for\nline animation along the path</li>\n  <li><code class=\"highlighter-rouge\">transform:rotate(20deg)</code> <code class=\"highlighter-rouge\">translate(x,y)</code></li>\n</ul>\n\n<p>Here is some example of text shadows:\nhttps://www.w3.org/People/Dean/svg/texteffects/index.html\nhttps://www.w3schools.com/graphics/svg_feoffset.asp</p>\n<ul>\n  <li>to add blur\n~~~\n    <defs>\n  <filter id=\"f1\" x=\"0\" y=\"0\">\n    <feGaussianBlur stdDeviation=\"0.1\" />\n  </filter>\n</defs>\n    <text filter=\"url(#f1)\">asd</text>\n  </li>\n</ul>\n<p>&lt;/degs&gt;</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\nBut better is to add another original item after filtered (so filtered is in\nbackground).\n\nIf you want to apply multiple times (so it is bolder) you can use `feMergeNode`\n\n</code></pre></div></div>\n<filter id=\"glow\" x=\"-30%\" y=\"-30%\" width=\"160%\" height=\"160%\">\n  <feGaussianBlur stdDeviation=\"1\" result=\"glow\" />\n  <feMerge>\n    <feMergeNode in=\"glow\" />\n    <feMergeNode in=\"glow\" />\n    <feMergeNode in=\"glow\" />\n  </feMerge>\n</filter>\n<p>&lt;/defs&gt;</p>\n<text style=\"filter: url(#glow); fill: #0c9\" x=\"5\" y=\"5\">Simple Glow</text>\n<text x=\"5\" y=\"5\" style=\"fill: white\">Simple Glow</text>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n* to show text along the path use\n\n</code></pre></div></div>\n<path id=\"ca\" class=\"abc__color-c\" d=\"M 3 90 Q 3 3, 47 3 \" />\n\n<text class=\"abc__title--ca abc__color-multistroke-3\"><textPath xlink:href=\"#ca\" startOffset=\"80%\">&lt;%= t 'site_title' %&gt;</textPath></text>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n![text along path](/assets/text_along_path.png \"Text along\npath\")\n\n* pure text in pure css can be different color with help of fill transparend and\n  background\n  https://mawla.io/team/\n\n</code></pre></div></div>\n<p>.colorize-text-background\n    background: radial-gradient($color-a, $color-b 60%, $color-c %20)\n    -webkit-background-clip: text\n    -webkit-text-fill-color: transparent</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\n  You can also animate saturation or sepia using filter\n  https://www.cssfilters.co/\n\n# SVG Mask\n\n* jpeg does not support mask (png does but is not optimized for big images), to\nuse jpeg and png mask and one svg to combine them\n\n</code></pre></div></div>\n<mask id=\"mars-mask\">\n  <image width=\"1\" heigh=\"1\" xlink:href=\"images/mars-mask.png\">\n&lt;/mask&gt;\n<image width=\"1\" height=\"1\" xlink:href=\"images/mars.jpg\" mask=\"url(#mars-mask)\" />\n~~~\n\n* fill in text with png mask\n[video](https://www.youtube.com/watch?v=B5ol4ss-mi4&amp;index=9&amp;list=PLWjCJDeWfDdeYtU0NMvYvfqqFA1Jsh3NM)\n~~~\n<style>\n  text {\n  mask: url(#text-mask);\n  }\n</style>\n<defs>\n  <mask id=\"text-mask\">\n    <image width=\"10\" height=\"10\" xlink:href=\"images/text-mask.png\">\n  &lt;/mask&gt;\n&lt;/defs&gt;\n<text x=\"0\" y=\"0\">Mars</text>\n~~~\n\n* fill in text with jpg image\n[video](https://www.youtube.com/watch?v=lSNnVbfvJJ0&amp;index=11&amp;list=PLWjCJDeWfDdeYtU0NMvYvfqqFA1Jsh3NM)\n~~~\n<svg width=\"1500\" height=\"500\">\n  <style>\n    #kup {\n      font-size: 15rem;\n      font-family: 'Modak', cursive;\n      fill: url(#text-pattern);\n    }\n  </style>\n  <defs>\n    <pattern width=\"500\" height=\"500\" id=\"text-pattern\" patternUnits=\"userSpaceOnUse\">\n      <image width=\"500\" height=\"500\" xlink:href=\"&lt;%= asset_path 'snow.jpg' %&gt;\" />\n    </pattern>\n  </defs>\n  <text x=\"0\" y=\"200\" id=\"kup\">Novosadski Kup</text>\n</svg>\n~~~\n\n* default color is black and that means it is transparent. To cover everything\nexcept text, that fill rectangle and keep text as black (transparent).\n&lt;https://codepen.io/SimonEvans/pen/weoLLB&gt;\n* another example of video inside text https://css-tricks.com/responsive-knockout-text-with-looping-video/\n* curved text\n\n~~~\n    <svg id=\"a\" width=\"100%\" height=\"100%\" viewBox=\"0 0 500 500\">\n      <path id=\"path12\" d=\"M17.413 103.763a86.935 65.39 0 0 1 33.07-49.74 86.935 65.39 0 0 1 72.012-12.602\" fill=\"transparent\" />\n      <text width=\"500\">\n        <textPath xlink:href=\"#path12\">\n          TEXTTTTTTTTTTTTTTTTT\n        </textPath>\n      </text>\n    </svg>\n~~~\n\n# Animate with <animateMotion>\n\n&lt;https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animateMotion&gt;\nExamples can be seen on https://css-tricks.com/guide-svg-animations-smil/\n\nTo move along the path but only on portion of the path, use:\n\n~~~\n<animateMotion calcMode=\"linear\" keyPoints=\"0;0.5\" keyTimes=\"0;1\" />\n~~~\n\n## Animate SVG with javascript\n\nThere is nice library to move elements along path\n&lt;https://github.com/lmgonzalves/path-slider&gt;\n\nTo move arrow and increase line you can also use js libraries:\n[snap.svg](https://github.com/adobe-webplatform/Snap.svg)\n&lt;https://codepen.io/mattsince87/pen/snqLy&gt;\n&lt;https://codepen.io/duleorlovic/pen/zpmXOw&gt;\n[animejs](http://animejs.com/)\n&lt;https://maxwellito.github.io/vivus/&gt;\n&lt;https://codepen.io/Zaku/pen/ALChE&gt;\n\nlive coding https://www.youtube.com/watch?v=-zLiw1GeEGo\n\n* smooth transitions between different svg\n[flubber](https://github.com/veltman/flubber)\n* radial or any path progress bars\n  &lt;https://daverupert.com/2018/03/animated-svg-radial-progress-bars&gt;\n* star heart animation with morphing\nhttps://css-tricks.com/creating-star-heart-animation-svg-vanilla-javascript/\n\n\n# Example of nice landing page with animation\n\n* https://scrumpy.io cat is working on laptop\n* http://taotajima.jp/works/ images and video on hover\n\n# Tips\n\n[scalling](https://css-tricks.com/scale-svg/) raster images like jpg, png and\ngif have defined size and aspect ratio of width to height. You can auto scale to\ncover `width=\"100%\"` (or to cover `height=\"100%\"`). all images has default size\n300px wide 150px tail.  if we change width or heigh of svg, inner image will\nstay the same (similar that font is the same if we scale div).  We can scale to\nfit with and without distorting. CSS `width: 100%` will overwrite width\nattribute on top svg element.  `viewBox=\"x y width height\"` for example\n`viewBox=\"0 0 100 100\"` defined top left corner as (0,0) and bottom right as\n(100,100).  `preserveAspectRatio=\"xMidYMin slice\"` or\n`preserveAspectRatio=\"none\"` if you want to preserve aspect ratio.\n\n\n# Angular\n\nInclude `ngAnimate` and for `ngRepeat` use `ng-enter` and `ng-enter-active` [old\ndoc](https://code.angularjs.org/1.2.22/docs/api/ngAnimate/service/$animate). We\ncould just also watch `ng-leave`, `ng-move` with ngRepeat, `ng-add` and\n`ng-remove` with ngClass, `ng-hide` with ngShow.\n\nThere is nice [ng-fx](https://github.com/AngularClass/ng-fx)\n[egghead](https://egghead.io/lessons/angularjs-introduction-to-ngfx-for-angular-animations)\nso you can use their animations. To install just run `bower instal ng-fx --save`\nand include `ngFx` in your module file. Just add some of [the\nsupported](https://github.com/AngularClass/ng-fx/blob/master/animationList.txt)\nanimations like `div(ng-repeat=\"item in items\" class=\"fx-zoom-left fx-speed-500\nfx-ease-sin fx-stagger-10\")`\n\n# Anime.js\n\n[Animejs](http://animejs.com/documentation/) is nice tool that can animate\nany css properties (opacity, color), transforms (translate, rotate), any dom\nattribute with numberical value (svg points).\n\nhttp://bouncejs.com/\n\n\n# Examples and Tricks\n\n* decorative text animations &lt;https://tympanus.net/Development/DecorativeLetterAnimations/&gt;\n* letter effects short to long words &lt;https://codepen.io/duleorlovic/pen/mXwyGj&gt;\n* infinite loader &lt;https://codepen.io/duleorlovic/pen/rJwaZL&gt;\n* animated download button\n  &lt;https://scotch.io/tutorials/build-a-download-button-full-of-micro-interactions&gt;\n* indent list items\n  ~~~\n  ul {\n    list-style: none;\n  }\n  li {\n    transition: all 0.1s ease-out;\n  }\n  li:hover {\n    margin-left: 8px;\n  }\n  ~~~\n\n\nUI animation tips\nhttps://uxdesign.cc/good-to-great-ui-animation-tips-7850805c12e5\n\nhttps://24ways.org/2010/intro-to-css-3d-transforms/\nhttps://www.youtube.com/watch?v=aVcs-zQ1q4U\nhttps://codepen.io/maattt/pen/RWxOjd\nhttps://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Basic_Shapes\n</animateMotion></image></mask></defs></image></mask>\n"
    } ,
  
    {
      "title"    : "Postgresql Tricks",
      "category" : "",
      "tags"     : "ruby-on-rails, postgresql",
      "url"      : "/2015/07/07/postgresql-tricks/",
      "date"     : "2015-07-07 00:00:00 +0200",
      "content"  : "<h1 id=\"introduction\">Introduction</h1>\n\n<p>Learning database is funny and easy, but when you want to do something more\ncomplicated than <code class=\"highlighter-rouge\">SELECT * FROM products</code> than you need to read documentation.</p>\n\n<p>If you want something more specific data from <code class=\"highlighter-rouge\">products</code> table you need to use\n<a href=\"http://www.postgresql.org/docs/9.4/static/queries-table-expressions.html\">7.2. Table\nExpressions</a>\nthat is:</p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">FROM products p INNER JOIN sales s ON p.id = s.product_id</code> where <em>p</em> and <em>s</em>\nare aliases. In following sql you need to use those aliases <code class=\"highlighter-rouge\">p</code> instead\n<code class=\"highlighter-rouge\">products</code></li>\n  <li>\n    <p>You can create column aliases for columns <code class=\"highlighter-rouge\">SELECT *, t.lat AS latitude</code>\nbut you can not use in <code class=\"highlighter-rouge\">where</code> clause since where clause is logically before\nselect clause (and before alias is created). If you need to use, you need to\nwrite that statement twice, or use sql wrapper wich will contain only that\n<code class=\"highlighter-rouge\">where</code>, this example is using concat:</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># this does not work\nSELECT neededfield, CONCAT(firstname, ' ', lastname) as firstlast\nFROM users\nWHERE firstlast = \"Bob Michael Jones\"\n\n# contact needs to be written twice: in SELECT and WHERE\nSELECT neededfield, CONCAT(firstname, ' ', lastname) as firstlast\nFROM users\nWHERE CONCAT(firstname, ' ', lastname) = \"Bob Michael Jones\"\n\n# or select wrapped\nSELECT * FROM (\n  SELECT neededfield, CONCAT(firstname, ' ', lastname) as firstlast\n  FROM users) base\nWHERE firstLast = \"Bob Michael Jones\"\n</code></pre></div>    </div>\n  </li>\n  <li>after processing <em>FROM</em> clause, thie new virtual table is checked against\nsearch conditions <em>WHERE</em>, for example: <code class=\"highlighter-rouge\">WHERE s.date &gt; CURRENT_DATE -\nINTERVAL '4 weeks'</code> This filtering is done <em>before</em> processing with <em>GROUP BY</em>\nand <em>HAVING</em>. Also you can not use alias in WHERE <code class=\"highlighter-rouge\">SELECT id as as_id FROM\ntable WHERE as_id = 1</code>. You should use <code class=\"highlighter-rouge\">SELECT id AS as_id FROM table HAVING\nas_id = 1</code>.</li>\n  <li><code class=\"highlighter-rouge\">GROUP BY product_id, p.name, p.price, p.cost</code> and <code class=\"highlighter-rouge\">HAVING sum(p.price *\ns.units) &gt; 5000;</code>. If you group by primary key column than you can <em>SELECT</em>\nany column, but if you group by non primary than you need some <a href=\"http://www.postgresql.org/docs/9.4/static/functions-aggregate.html\">9.20.\nAggregate\nFunctions</a>\nsince those columns can be merged.\n    <ul>\n      <li>you can group by hour with <code class=\"highlighter-rouge\">SELECT date_trunc('hour', created_at),  (which\n  can be count(*)\nFROM users GROUP BY date_trunc('hour', created_at) ORDER BY date_trunc('hour',\ncreated_at);</code>. You can reference columns by select position <code class=\"highlighter-rouge\">SELECT\ndate_trunc('hour', created_at), count(*) FROM users GROUP BY 1 ORDER BY 1;</code>\nAlthough you can order by expression of columns <code class=\"highlighter-rouge\">ORDER BY col1 + col2</code>, you\ncan not use order by with calculated col and expression <code class=\"highlighter-rouge\">ORDER BY sum + 1</code>\nhttps://www.postgresql.org/docs/8.3/queries-order.html</li>\n    </ul>\n  </li>\n  <li>you can group by several columns and select count &gt; 2 and get only first\nitem.id <code class=\"highlighter-rouge\">a=Item.reorder(\"\").select('max(\"id\") as max_id').group([:url, :title,\n:feed_id]).having('count(\"id\") &gt; 1')</code></li>\n</ul>\n\n<p>I found very interesting paragraph in <a href=\"http://www.postgresql.org/docs/devel/static/tutorial-agg.html\">tutorial for aggregate\nfunctions</a>.</p>\n\n<blockquote>\n  <p>It is important to understand the interaction between aggregates and SQL’s\n WHERE and HAVING clauses. The fundamental difference between WHERE and HAVING\n is this: WHERE selects input rows before groups and aggregates are computed\n (thus, it controls which rows go into the aggregate computation), whereas\n HAVING selects group rows after groups and aggregates are computed. Thus, the\n WHERE clause must not contain aggregate functions; it makes no sense to try\n to use an aggregate to determine which rows will be inputs to the aggregates.\n On the other hand, the HAVING clause always contains aggregate functions.\n (Strictly speaking, you are allowed to write a HAVING clause that doesn’t use\n aggregates, but it’s seldom useful. The same condition could be used more\n efficiently at the WHERE stage.)</p>\n\n  <p>… This is more efficient than adding the restriction to HAVING, because we\navoid doing the grouping and aggregate calculations for all rows that fail the\nWHERE check.</p>\n</blockquote>\n\n<p>Next step is to learn something about <a href=\"http://www.postgresql.org/docs/9.4/static/functions-formatting.html\">9.8. Data Type Formatting\nFunctions</a>\nwhich you can use in grouping.</p>\n\n<p>Some tips:</p>\n\n<ul>\n  <li>if you want to avoid <em>Division by zero</em> you can use <code class=\"highlighter-rouge\">CASE count(column_name) =\n0 WHEN 0 THEN 1 ELSE count(column_name) END</code>.  Another way is to use\n<code class=\"highlighter-rouge\">COALESCE(NULLIF(column_name,0), 1)</code> .\n<code class=\"highlighter-rouge\">NULLIF</code> is used to show nil, as division by nil is nil.\n<code class=\"highlighter-rouge\">something/NULLIF(column_name,0)</code> If the value of column_name is 0 - result of\nentire expression will be NULL.\nDefaults for <code class=\"highlighter-rouge\">ORDER BY ASC</code> is <code class=\"highlighter-rouge\">NULLS LAST</code> and for desc <code class=\"highlighter-rouge\">NULL FIRST</code> so you\nmaybe want to reverse that.</li>\n  <li><code class=\"highlighter-rouge\">FROM WHERE field IN ('a','b')</code> is the same as <code class=\"highlighter-rouge\">field = 'a' OR field =\n'b'</code></li>\n  <li>you can use IN, ANY, ALL\n<a href=\"https://www.postgresql.org/docs/current/static/functions-comparisons.html#AEN18509\">functions-comparisons</a></li>\n</ul>\n\n<p>Use gem to extent ActiveRecord functionality\nhttps://github.com/georgekaraszi/ActiveRecordExtended</p>\n\n<h1 id=\"tutorial-links\">Tutorial links</h1>\n\n<p><a href=\"https://www.toptal.com/postgresql\">https://www.toptal.com/postgresql</a>\nPostgresql is better than NoSql because of:</p>\n\n<ul>\n  <li>transactionality at system level</li>\n  <li>aggregation functions</li>\n  <li>joins across different tables</li>\n</ul>\n\n<p>NoSql has advantage of scaling (horizontal, a lot of new fields) and that you\ncan store semistructured data (social networks)</p>\n\n<p>For full text search in Postgresql, you can use <code class=\"highlighter-rouge\">@@</code> match operator <code class=\"highlighter-rouge\">SELECT *\nFROM posts WHERE tsvector(title || ‘ ‘ || content) @@\nplainto_tsquery(‘query-string’);</code></p>\n\n<p>High availability is implemented with redudant servers <em>hot standby</em> that copy\ndata and accept only read only queries (only master can write data), and <em>warm\nstandby</em> servers that only follow the changes made to primary server (does not\naccept queries) and wait to be promoted to primary server in case of master\nfailure.</p>\n\n<p><a href=\"https://www.toptal.com/sql/interview-questions\">https://www.toptal.com/sql/interview-questions</a></p>\n\n<ul>\n  <li><code class=\"highlighter-rouge\">UNION</code> (<code class=\"highlighter-rouge\">UNION ALL</code>) merges two structurally compatible tables into single\ntable (with duplication)</li>\n  <li><code class=\"highlighter-rouge\">INNER JOIN</code> (<code class=\"highlighter-rouge\">LEFT OUTER</code> <code class=\"highlighter-rouge\">FULL</code> <code class=\"highlighter-rouge\">CROSS</code>) returns rows that match both\ntables (all rows from left table and matched rows from right, either left or\nright ie union, cartesian product each by each row)</li>\n  <li><code class=\"highlighter-rouge\">SELECT count(*) WHERE cid &lt;&gt; '123'</code> will not count when cid is NULL</li>\n  <li><code class=\"highlighter-rouge\">is null</code> is proper way to check if <code class=\"highlighter-rouge\">null = null</code> or <code class=\"highlighter-rouge\">cid = null</code></li>\n  <li>\n    <p><code class=\"highlighter-rouge\">WHERE cid NOT IN (SELECT wcid FROM t WHERE wcid IS NOT null)</code> we need to\ncheck if null is in table since <code class=\"highlighter-rouge\">NOT IN</code> will return empty set</p>\n  </li>\n  <li>Online exercises <a href=\"https://pgexercises.com/\">https://pgexercises.com/</a></li>\n</ul>\n\n<h1 id=\"time-date\">Time Date</h1>\n\n<ul>\n  <li>there are <a href=\"http://www.postgresql.org/docs/9.1/static/datatype-datetime.html\">4\ntypes</a>:\n<em>timestamp, date, time</em> and <em>interval</em>. When you define value use single\nquotes: <code class=\"highlighter-rouge\">DATE '2016-05-22'</code>. For intervals you need to set unit <code class=\"highlighter-rouge\">INTERVAL '1\nWEEK'</code></li>\n  <li>for all types there is <code class=\"highlighter-rouge\">CURRENT_DATE, CURRENT_TIME</code></li>\n  <li><a href=\"http://www.postgresql.org/docs/9.1/static/functions-datetime.html\">functions</a>\nallows you to:\n    <ul>\n      <li>create next day <code class=\"highlighter-rouge\">DATE '2001-02-01' + INTERVAL '1 DAY'</code></li>\n      <li>extract weekday <code class=\"highlighter-rouge\">EXTRACT(DOW FROM TIMESTAMP '2016')</code></li>\n      <li>check overlaps <code class=\"highlighter-rouge\">(start1, end1) OVERLAPS (start2, end2)</code></li>\n    </ul>\n  </li>\n  <li>typecast can be done: <code class=\"highlighter-rouge\">INTERVAL '1 WEEK'</code> or <code class=\"highlighter-rouge\">'1 WEEK'::INTERVAL</code>\n    <ul>\n      <li>jsonb is much reliable type cast when since json compares as strings\n<a href=\"http://stackoverflow.com/questions/32843213/operator-does-not-exist-json-json\">link</a></li>\n    </ul>\n  </li>\n  <li>to use columns (like <code class=\"highlighter-rouge\">$1</code> or name <code class=\"highlighter-rouge\">a.b</code>) you can use\n    <ul>\n      <li>string concatenation  <code class=\"highlighter-rouge\">(a.b || ' MINUTES')::INTERVAL</code></li>\n      <li>multiplication <code class=\"highlighter-rouge\">a.b * INTERVAL '1 MINUTES'</code> (much nicer)</li>\n    </ul>\n  </li>\n  <li>\n    <p>you can find records for specific month and year with</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>scope :posts_in_month_and_year, -&gt;(month, year) {\n  where('MONTH(posts.created_at) = ? AND YEAR(posts.created_at) = ?', month, year)\n</code></pre></div>    </div>\n  </li>\n  <li>another grouping by day can be <code class=\"highlighter-rouge\">SELECT COUNT(*), to_char(date, 'YYY-MM-DD') as\n'day' FROM orders GROUP BY 'day' ORDER BY 'day'</code></li>\n</ul>\n\n<h1 id=\"practical-example-in-ruby-on-rails\">Practical example in Ruby on Rails</h1>\n\n<p>Complex queries can be written inside <em>database view</em> but that is not easy to\nmaintain since you need migration file for each change.  Also <em>database view</em> is\ncreated in migration, so we don’t have it with <code class=\"highlighter-rouge\">rake db:setup</code>.  You can get it\nwith <code class=\"highlighter-rouge\">rake db:migrate:reset</code> but this sometimes doesn’t work if we used\n<em>ActiveRecord</em> in migration files and we later add some validations\nwhich (of-course) are not satisfied in the past (and this can be solved with\n<code class=\"highlighter-rouge\">class Product&lt;ActiveRecord::Base;end</code> in migration files).</p>\n\n<p>It’s much easier to write long SQL query and use <a href=\"http://www.postgresql.org/docs/devel/static/hstore.html\">F.15.\nhstore</a> functions to\nsimplify representations. You need to install hstore extension\n<a href=\"https://gist.github.com/terryjray/3296171\">link</a> for test and develop db:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo psql -d myapp_development -U orlovic\nCREATE EXTENSION hstore;\n#or in one command: \nsudo su postgres -c \"psql myapp_test -c 'CREATE EXTENSION hstore;'\"\n</code></pre></div></div>\n\n<p>Sometime you can run <code class=\"highlighter-rouge\">rake db:migrate:reset</code> to rerun all migration and check if <em>db/schema.rb</em> is in sync.</p>\n\n<p>You might also alter user to have superuser privileges:\n<code class=\"highlighter-rouge\">sudo su postgres -c \"psql -d postgres -c 'ALTER USER orlovic WITH SUPERUSER;'\"</code></p>\n\n<p>To detect N+1 queries use gem <em>bullet</em>, and to find most expensive queries use heroku postgres analytics.\nTo measure production queries, you can download database from heroku to <code class=\"highlighter-rouge\">a.dump</code> and restore to development database</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo su postgres\npg_restore -d myapp_development --clean --no-acl --no-owner -h localhost a.dump\n</code></pre></div></div>\n\n<p>and run benchmark</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>puts Benchmark.measure { Job.active_per_domain_per_tier(domain,1) }\n</code></pre></div></div>\n\n<p>or you can connect to production database (be carefull).</p>\n\n<h2 id=\"statistics-graph\">Statistics graph</h2>\n\n<p>When you want to show some statistics during some time (time points in sql is <code class=\"highlighter-rouge\">GENERATE_SERIES</code>), for example number of deactivated users:</p>\n\n<p><img src=\"/assets/deactivated_users.png\" alt=\"Time series of deactivated users\" /></p>\n\n<p>What I have learned is that when you use <em>series</em>, never apply <em>WHERE</em> since because it will destroy <em>series</em>.\nBetter is to filter in <em>ON</em> statement. Each subsequent joins should be <em>LEFT OUTER JOIN</em> so <em>series</em> survive.</p>\n\n<p>We need <em>COALESCE</em> because on some days we don’t have records, so we put key <code class=\"highlighter-rouge\">none</code> ( number is 0)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># put this in controller\nif params[:from_date].present?\n  @from_date = Time.new( * params[:from_date].split('-')).to_date\nelse\n  @from_date = (Time.now - 1.month).to_date\nend\nif params[:to_date].present?\n  @to_date = Time.new( * params[:to_date].split('-')).to_date\nelse\n  @to_date = (Time.now - 1.day).to_date\nend\n\n@group_by = params[:group_by] || 'day'\ncase @group_by\nwhen 'day'\n  interval_period = '1 day'\n  interval = 'YY-MM-DD'\nwhen 'week'\n  interval_period = '1 week'\n  interval = 'YY-WW'\nwhen 'month'\n  interval_period = '1 month'\n  interval = 'YY-MM'\nend\n\nquery = &lt;&lt;-SQL\nSELECT\n  hstore(array_agg(COALESCE(res.role::text,'none')),array_agg(res.number::text) ) AS name_mapping,\n  res.datum as datum\nFROM\n(\n    SELECT \n      users.role,\n      count(users.id),\n      dt.series\n    FROM (\n      SELECT GENERATE_SERIES( '#{@from_date}'::date, '#{@to_date}'::date, '#{interval_period}')::date\n      AS series\n    ) AS dt\n    LEFT OUTER JOIN users\n    ON TO_CHAR(users.updated_at,'#{interval}') = TO_CHAR(dt.series,'#{interval}') AND\n      users.status = 0\n    GROUP BY dt.series, users.role\n) AS res(role, number, datum)\nGROUP BY res.datum\nORDER BY res.datum\nSQL\nresults = User.find_by_sql(query)\n# results group by created_at and domain { 'scuddle' =&gt; 3, 'indeed' =&gt; 10 } for each date\n@heading = \"Deactivated users (group by updated_at)\"\n@labels = results.map {|k| k.datum}\nroles = results.map {|k| k.name_mapping.keys}.flatten.uniq.reject {|r| r=='none'}\n# TODO make those data arrays in SQL so we do not need to iterate again here\n@datasets = add_colors roles.map { |r| { label: User.new(role: r).role_to_s, data: results.map { |k| k.name_mapping[r].to_i} } }\nrender 'stats_line_graph'\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># in view file\n&lt;form&gt;\n  &lt;input type=\"date\" name=\"from_date\" value=\"&lt;%= @from_date %&gt;\"&gt;\n  &lt;input type=\"date\" name=\"to_date\" value=\"&lt;%= @to_date %&gt;\"&gt;\n  &lt;select name=\"group_by\"&gt;\n    &lt;option value=\"day\" &lt;%= 'selected=\"selected\"' if @group_by == 'day' %&gt;&gt;Day&lt;/option&gt;\n    &lt;option value=\"week\" &lt;%= 'selected=\"selected\"' if @group_by == 'week' %&gt;&gt;Week&lt;/option&gt;\n    &lt;option value=\"month\" &lt;%= 'selected=\"selected\"' if @group_by == 'month' %&gt;&gt;Month&lt;/option&gt;\n  &lt;/select&gt;\n  &lt;input type=\"submit\"&gt;\n&lt;/form&gt;\n&lt;h4&gt;&lt;%= @heading %&gt;&lt;/h4&gt;\n\n&lt;% if ! @data.present? &amp;&amp; ! @datasets.present? %&gt;\n  &lt;p&gt;\n    No results\n  &lt;/p&gt;\n&lt;% end %&gt;\n&lt;div id=\"legend\" class=\"left\"&gt;&lt;/div&gt;\n&lt;div class=\"left m-l-10\"&gt;\n  &lt;%= @message %&gt;\n&lt;/div&gt;\n&lt;div class=\"clearfix\"&gt;&lt;/div&gt;\n&lt;canvas id=\"myChart\" width=\"800\" height=\"400\"&gt;&lt;/canvas&gt;\n&lt;div id=\"chartjs-tooltip\"&gt;&lt;/div&gt;\n\n&lt;script&gt;\n  &lt;%# http://www.chartjs.org/docs/#line-chart-data-structure%&gt;\n  var data = {\n    labels: &lt;%=raw @labels.to_json %&gt;,\n    &lt;% if @datasets.present? %&gt;\n      &lt;%# for multiple lines %&gt;\n      datasets: &lt;%=raw @datasets.to_json %&gt;,\n    &lt;% else %&gt;\n      &lt;%# for single line %&gt;\n      datasets: [\n        {\n          data: &lt;%=raw @data.to_json %&gt;,\n        }\n      ]\n    &lt;% end %&gt;\n  }\n  &lt;%# https://github.com/nnnick/Chart.js/blob/master/samples/line-customTooltips.html#L53 %&gt;\n  Chart.defaults.global.customTooltips = function(tooltip) {\n\n      var tooltipEl = $('#chartjs-tooltip');\n\n      if (!tooltip) {\n          tooltipEl.css({\n              opacity: 0\n          });\n          return;\n      }\n\n      tooltipEl.removeClass('above below');\n      tooltipEl.addClass(tooltip.yAlign);\n\n      var innerHtml = '';\n      if (tooltip.labels)\n      {\n        for (var i = tooltip.labels.length - 1; i &gt;= 0; i--) {\n          innerHtml += [\n            '&lt;div class=\"chartjs-tooltip-section\"&gt;',\n            '   &lt;span class=\"chartjs-tooltip-key\" style=\"background-color:' + tooltip.legendColors[i].fill + '\"&gt;&lt;/span&gt;',\n            '   &lt;span class=\"chartjs-tooltip-value\"&gt;' + tooltip.labels[i] + ' - ' + myNewChart.datasets[i].label + '&lt;/span&gt;',\n            '&lt;/div&gt;'\n          ].join('');\n        }\n      }\n      else\n      {\n        innerHtml = [\n          '&lt;div class=\"chartjs-tooltip-section\"&gt;',\n          '   &lt;span class=\"chartjs-tooltip-value\"&gt;' + tooltip.text + '&lt;/span&gt;',\n          '&lt;/div&gt;'\n        ].join('');\n      }\n\n      tooltipEl.html(innerHtml);\n\n      tooltipEl.css({\n          opacity: 1,\n          left: tooltip.chart.canvas.offsetLeft + tooltip.x + 'px',\n          top: tooltip.chart.canvas.offsetTop + tooltip.y + 'px',\n          fontFamily: tooltip.fontFamily,\n          fontSize: tooltip.fontSize,\n          fontStyle: tooltip.fontStyle,\n      });\n  };\n\n  var ctx = document.getElementById(\"myChart\").getContext(\"2d\");\n  var myNewChart = new Chart(ctx).Line(data);\n\n  // legend\n  var legendHolder = document.getElementById(\"legend\");\n  legendHolder.innerHTML = myNewChart.generateLegend();\n&lt;/script&gt;\n</code></pre></div></div>\n\n<ul>\n  <li>to find which table has the most rows you can use this\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>SELECT schemaname,relname,n_live_tup\nFROM pg_stat_user_tables\nORDER BY n_live_tup DESC;\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<h1 id=\"other-gems\">Other gems</h1>\n\n<p>I found interesting gems:</p>\n\n<ul>\n  <li><a href=\"https://github.com/ankane/groupdate\">https://github.com/ankane/groupdate</a> for grouping</li>\n  <li>\n    <p><a href=\"https://github.com/ankane/chartkick\">https://github.com/ankane/chartkick</a> simple charts from ruby, support\nchart.js, highcarts, goole charts <a href=\"https://github.com/ankane/chartkick.js\">js\nversion</a></p>\n  </li>\n  <li>interesting <a href=\"https://github.com/mariusandra/insights\">no sql not required data analytics tool\nINSIGHTS</a></li>\n  <li>automatic find indexes that are needed for a database\nhttps://github.com/ankane/dexterhttps://github.com/ankane/dexter</li>\n</ul>\n"
    } ,
  
    {
      "title"    : "Common Rails bootstrap snippets",
      "category" : "",
      "tags"     : "ruby-on-rails, devise, carrierwave",
      "url"      : "/2015/04/05/common-rails-bootstrap-snippets/",
      "date"     : "2015-04-05 00:00:00 +0200",
      "content"  : "<p>Paste this code to create some basic starting application <em>myapp.com</em> with\nauthentication and other funny tools. I extensively use <a href=\"/2016/05/18/echo-sed-grep-command-line-editing/\">echo sed grep</a>\ncommands here.</p>\n\n<blockquote>\n  <p>give a man a fish and you feed him for a day. teach a man to fish and you feed\nhim for a lifetime</p>\n</blockquote>\n\n<h1 id=\"rvm-and-other-tools\">RVM and other tools</h1>\n\n<p>If you do not have <code class=\"highlighter-rouge\">rails</code> or <code class=\"highlighter-rouge\">git</code> you need to install</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3\n\\curl -sSL https://get.rvm.io | bash\nrvm install 2.3.0\ngem install bundle\n\nsudo apt install git postgresql libpq-dev nodejs\n</code></pre></div></div>\n\n<h1 id=\"initial-commit\">Initial commit</h1>\n\n<p>You can choose database with rails param <code class=\"highlighter-rouge\">rails new myapp --database=postgresql</code>\nbut it is better to create <code class=\"highlighter-rouge\">.railsrc</code> so it is used for all rails</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; ~/.railsrc &lt;&lt; HERE_DOC\n-d postgresql # use postgresql\nHERE_DOC\n</code></pre></div></div>\n\n<p>Create new app</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails new myapp\n# to specify version you can use\nrails _5.2.1_ new myapp\ncd myapp\nrails db:create\ngit init . &amp;&amp; git add . &amp;&amp; git commit -m \"rails new myapp\"\n</code></pre></div></div>\n\n<p>For error</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Webpacker can't find application in /home/orlovic/Downloads/rails_6_beta2_stimulus/public/packs/manifest.json. Possible causes:\n</code></pre></div></div>\n<p>you need to install webpack and run initial compilation</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn add @rails/webpacker\nbin/webpack\n</code></pre></div></div>\n\n<h1 id=\"uuid\">UUID</h1>\n\n<p>https://github.com/trkin/contact_form/commit/52532f3378604f59fb16c1e6432cc567542c391d</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bin/rails g migration enable_extension_for_uuid\nlast_migration\n# add following line to migration\n  def change\n    enable_extension 'pgcrypto' unless extension_enabled?('pgcrypto')\n  end\n\ncat &gt;&gt; config/initializers/generators.rb &lt;&lt; HERE_DOC\nRails.application.config.generators do |g|\n  g.orm :active_record, primary_key_type: :uuid\nend\nHERE_DOC\n\nrake db:create db:migrate\ngit add .\ngit commit -m 'Enable uuid in postgresql'\n</code></pre></div></div>\n\n<p>Later, if you add some references, you need to specify <code class=\"highlighter-rouge\">type: :uuid</code> like:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  t.references :post, type: :uuid, index: true\n</code></pre></div></div>\n\n<p>or error will be raised:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>DETAIL:  Key columns \"post_id\" and \"id\" are of incompatible types: bigint and uuid.\n</code></pre></div></div>\n\n<p>Note that ordering by id, uuid is not possible. It is hard to implement on\nexisting projects and on MySQL db.</p>\n\n<h1 id=\"sample-page\">Sample page</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g controller pages home --skip-helper --skip-assets\nsed -i config/routes.rb -e \"/^end$/i \\\\\n  # root page\\n\\\n  root 'pages#home'\\\n\"\n</code></pre></div></div>\n<p>Rubocop cli</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rubocop --auto-correct # to autocorrent correct some files (except lineLength)\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># initial scale on mobile devices\nsed -i app/views/layouts/application.html.erb -e '/title/a \\\n    &lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"&gt;'\n</code></pre></div></div>\n\n<h1 id=\"font-icons\">Font icons</h1>\n\n<p>Fontello provides a icons which you can include in your project using\nhttps://github.com/railslove/fontello_rails_converter</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># Gemfile\n# pick icons\ngem 'fontello_rails_converter'\n\n# select some fonts http://fontello.com/ and download zip to `tmp/fontello.zip`\nbundle exec fontello convert --no-download\ngnome-open http://localhost:3001/fontello-demo.html\n\n# when you want to update you can\nfontello open\n# select new icons\nbundle exec fontello convert\n</code></pre></div></div>\n<p>To configure in rails you need to import</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/stylesheets/application.sass\n// vendor\n@import 'fontello'\n</code></pre></div></div>\n<p>And use with classes</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/layouts/application.html.erb\n&lt;i class=\"demo-icon icon-mobile\"&gt;&lt;/i&gt;\n</code></pre></div></div>\n\n<p>Prepare icons https://github.com/fontello/fontello/wiki/How-to-use-custom-images#preparing-images-in-inkscape</p>\n\n<h1 id=\"gitignore\">Gitignore</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; .gitignore &lt;&lt; 'HERE_DOC'\n# vim temp files\n*.swp\n*.swo\n# carrierwave upload files\n/public/uploads\n# gedit files\n*~\n# vagrant files\n.vagrant\n# byebug\n.byebug_history\n# rspec temporary file\nspec/examples.txt\nHERE_DOC\ngit commit -am \"Update .gitignore\"\n</code></pre></div></div>\n\n<h1 id=\"gemfile-development--production-tools\">Gemfile development &amp; production tools</h1>\n\n<p>Some of the gems could be found on <a href=\"https://github.com/thoughtbot/suspenders\">thoughtbot\nsuspenders</a>\nPaid 3th party service alternative for <code class=\"highlighter-rouge\">bullet</code> is scoutapp, for\n<code class=\"highlighter-rouge\">exception_notification</code> is sentry, informantapp.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\ngroup :development do\n  # pretty print Ruby objects in full color\n  gem 'awesome_print', require: 'ap'\n  # static analysis security vulnerability scanner, run: `brakeman`\n  gem 'brakeman', '~&gt; 3.5.0', require: false\n  # detect N+1 sql queries\n  gem 'bullet'\n  # detect out-of-date or vulnerable gems, run: `gemsurance`\n  gem 'gemsurance'\n  # automatic reload\n  gem 'guard-livereload', require: false\n  # open emails in browser\n  gem 'letter_opener'\n  # detect file changes\n  gem 'listen', '~&gt; 3.0.5'\n  # support for Rails Panel - chrome extension\n  gem 'meta_request'\n  # debugger\n  gem 'pry'\n  gem 'pry-rails'\n  # ruby static code analyzer\n  gem 'rubocop', require: false\n  # spring speeds up development by keeping your application running in the\n  # background. Read more: https://github.com/rails/spring\n  gem 'spring'\n  gem 'spring-watcher-listen', '~&gt; 2.0.0'\nHERE_DOC\n</code></pre></div></div>\n\n<p>Some not used gems</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  # do not show assets in log\\\n  # gem \"quiet_assets # can not find rails 5 version\"\\\n\n  # irbtools includes interactive_editor gem (vim inside irb)\\\n  # just create ~/.irbrc with\\\n  # require \"rubygems\"\\\n  # require \"irbtools\"\\\n  gem \"irbtools\", require: \"irbtools/binding\"\\\n\n  # is not needed since rails will show line on which there is\n  # exception (no need to insert console and use on web page).\n  gem better_errors\n\n  # Access an interactive console on exception pages or by calling 'console' anywhere in the code.\n  gem 'web-console', '&gt;= 3.3.0'\n\n  # config/application.rb\n  # run with rails s -p b 0.0.0.0 to allow local network, allow remote requests\\\n  config.web_console.whiny_requests = false'\n</code></pre></div></div>\n\n<p>Production gems and configurations</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# adding vendor prefixes to css rules\ngem \"autoprefixer-rails\"\n\n# sets timezone based on browser timezone for each request\ngem \"browser-timezone-rails\"\nHERE_DOC\n\n# need some js for timezone\ncat &gt;&gt; app/assets/javascripts/application.js &lt;&lt; HERE_DOC\n//= require js.cookie\n//= require jstz\n//= require browser_timezone_rails/set_time_zone\nHERE_DOC\n\nbundle\nguard init livereload\n# gem https://github.com/guard/guard-livereload suggest some old extension\n# https://addons.mozilla.org/en-US/firefox/addon/livereload/ but there is new\n# https://addons.mozilla.org/en-US/firefox/addon/livereload-web-extension\n# or you can use rack-livereload\n# I receive error No such middleware to insert before: ActionDispatch::Static\n# so better is to use browser plugin instead of gem 'rack-livereload'\n# sed -i config/environments/development.rb -e '/^end/i \\\n#   # livereload\\\n#   # use rack-livereload or browser extension\\\n#   # if guard is not running, there is an error in js console:\\\n#   # Cross-origin plugin content from  must have a visible size larger than 400 x\\\n#   # 300 pixels, or it will be blocked. Invisible content is always blocked.\\\n#   config.middleware.insert_after ActionDispatch::Static, Rack::LiveReload\\\n# '\n\nWhen I get error with command RAILS_ENV=production rails assets:precompile\n No such middleware to insert before: ActionDispatch::Static\nThan solution is to add `gem 'rails_12factor`, group: :production`\nhttps://github.com/AssetSync/asset_sync/issues/221#issuecomment-75492905\n\n\ncat &gt; config/initializers/bullet.rb &lt;&lt; HERE_DOC\nif defined? Bullet\n  Bullet.enable = true\n  Bullet.alert = true\n  Bullet.rails_logger = true\nend\nHERE_DOC\n\ngit add . &amp;&amp; git commit -m \"Adding guard and other useful gems\"\n\n# to run guard live reload, first increase max watches than just run guard\n# https://github.com/guard/listen/wiki/Increasing-the-amount-of-inotify-watchers\n# echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf &amp;&amp; sudo\nsysctl -p\nguard -d\n# livereload debug with `guard -d`. Error if you also run it on another project\n# there should not be eventmachine.rb:530:in `start_tcp_server': no acceptor (port is in use or requires root privileges) (RuntimeError)\n</code></pre></div></div>\n\n<p>Customize log output of rails logger in production with\nhttps://github.com/roidrage/lograge#handle-actioncontrollerroutingerror</p>\n\n<h2 id=\"fonts\">Fonts</h2>\n\n<p>Copy definition from node_modules css files where font-face is defined, and\nchange from <code class=\"highlighter-rouge\">url</code> to <code class=\"highlighter-rouge\">asset-url</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install typeface-roboto\nmkdir app/assets/stylesheets/plugins\ncat &gt;&gt; app/assets/stylesheets/plugins &lt;&lt; HERE_DOC\n@font-face {\n  font-family: 'Roboto';\n  font-style: normal;\n  font-weight: 400;\n  src: local('Roboto Regular'), local('Roboto-Regular'), asset-url('typeface-roboto/files/roboto-latin-400.woff') format('woff'), asset-url('typeface-roboto/files/roboto-latin-400.woff2') format('woff2');\n}\n@font-face {\n  font-family: 'Roboto';\n  font-style: normal;\n  font-weight: 500;\n  src: local('Roboto Medium'), local('Roboto-Medium'), asset-url('typeface-roboto/files/roboto-latin-500.woff') format('woff'), asset-url('typeface-roboto/files/roboto-latin-500.woff2') format('woff2');\n}\n@font-face {\n  font-family: 'Roboto';\n  font-style: normal;\n  font-weight: 600;\n  src: local('Roboto SemiBold'), local('Roboto-SemiBold'), asset-url('typeface-roboto/files/roboto-latin-500.woff') format('woff'), asset-url('typeface-roboto/files/roboto-latin-500.woff2') format('woff2');\n}\n@font-face {\n  font-family: 'Roboto';\n  font-style: normal;\n  font-weight: 700;\n  src: local('Roboto Bold'), local('Roboto-Bold'), asset-url('typeface-roboto/files/roboto-latin-700.woff') format('woff'), asset-url('typeface-roboto/files/roboto-latin-700.woff2') format('woff2');\n}\nHERE_DOC\n\ncat &gt;&gt; app/assets/stylesheets/application.sass &lt;&lt; HERE_DOC\n// plugins\n@import 'plugins/roboto_font_face'\nHERE_DOC\n\ncat &gt;&gt; app/assets/stylesheets/common/body.sass &lt;&lt; HERE_DOC\nbody\n  font-family: 'Roboto', sans-serif\nHERE_DOC\n</code></pre></div></div>\n\n<h2 id=\"twitter-bootstrap-gem\">Twitter bootstrap Gem</h2>\n\n<h2 id=\"adding-flash-both-from-server-and-client\">Adding flash (both from server and client)</h2>\n\n<p>You can use <a href=\"http://getbootstrap.com/css/#type-alignment\">text-center</a> bootstrap\nhelper (ie <code class=\"highlighter-rouge\">text-align: center;</code>). Also the collors</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i app/views/layouts/application.html.erb -e '/yield/c \\\n  &lt;div class=\"text-center\"&gt;\\\n    &lt;span class=\"notice text-success\" id=\"notice\"&gt;&lt;/span&gt;\\\n    &lt;span class=\"alert text-danger\" id=\"alert\"&gt;&lt;/span&gt;\\\n  &lt;/div&gt;\\\n  &lt;script&gt;\\\n    &lt;%=raw \"flash_message(document.getElementById('notice'), '#{j notice}');\" if notice %&gt;\\\n    &lt;%=raw \"flash_message(document.getElementById('alert'), '#{j alert}');\" if alert %&gt;\\\n  &lt;/script&gt;\\\n\\\n  &lt;article&gt;\\\n    &lt;%= yield %&gt;\\\n  &lt;/article&gt;'\n\ncat &gt; app/assets/javascripts/main.js.erb &lt;&lt; 'HERE_DOC'\nvar FLASH_LETTER_STEP = 10;\nvar FLASH_DURATION = 5000;\nfunction flash_appear(element, message, i) {\n  if (i == undefined)\n    i = 0;\n  element.innerText = message.substring(0,i);\n   setTimeout(function(){ \n    if (i&lt;message.length)\n      flash_appear(element, message, i+1);\n  }, FLASH_LETTER_STEP);\n}\nfunction flash_dissapear(element, message, i) {\n  if (message == undefined)\n    message = element.innerText;\n  if (i == undefined)\n    i = message.length-1;\n  element.innerText = message.substring(0,i);\n  setTimeout(function(){ \n    if (i&gt;0)\n      flash_dissapear(element, message,i-1);\n  }, FLASH_LETTER_STEP);\n}\n\nfunction flash_message(element, message) {\n  flash_appear(element, message);\n  setTimeout(function(){ flash_dissapear(element); }, FLASH_DURATION);\n}\nHERE_DOC\ngit add . &amp;&amp; git commit -m \"Adding flash to layout\"\n</code></pre></div></div>\n\n<h2 id=\"bourbon-css-mixins\">Bourbon css mixins</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo '\n# css mixin library http://bourbon.io/\ngem \"bourbon\", '~&gt; 5.0.0.beta' # bourbon 5 is requred by bitters 1.3\n# https://github.com/thoughtbot/bitters/issues/235\ngem \"neat\"\n' &gt;&gt; Gemfile\necho '\n@import \"bourbon\";\n@import \"base/base\"; // this is http://bitters.bourbon.io/\n@import \"neat\";\n' &gt; app/assets/stylesheets/application.scss\ngit rm app/assets/stylesheets/application.css\n\nbundle\ngem install bitters\ncd app/assets/stylesheets &amp;&amp; bitters install\nsed -i '/grid-settings/c @import \"grid-settings\";' base/_base.scss\ncd -\n\ngit add . &amp;&amp; git commit -m \"Adding bourbon, neat and bitters scss\"\n</code></pre></div></div>\n\n<h2 id=\"slim\">Slim</h2>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i Gemfile -e '/group :development do/a  \\\n  # slim templating\\\n  gem \"slim-rails\"'\n\ngem install html2slim\nerb2slim app/views/leads/index.html.erb\n</code></pre></div></div>\n\n<h2 id=\"angular\">Angular</h2>\n\n<p>For various ways of integrating Angular look at\n<a href=\"/2015/11/26/angular-and-ruby-on-rails/\">angular-and-ruby-on-rails</a></p>\n\n<h1 id=\"simplify-secrets-and-add-smtp-credentials\">Simplify secrets and add smtp credentials</h1>\n\n<p>YML file can use anchor (<code class=\"highlighter-rouge\">&amp;</code>) and reference (<code class=\"highlighter-rouge\">*</code>) so you do not repeat the code.\nWhen you use reference <code class=\"highlighter-rouge\">*</code> (as for testing) you can not add or update keys, but\nwith <code class=\"highlighter-rouge\">&lt;&lt;</code> you can (as for production) (more on <a href=\"/2017/01/10/get-syntax-right-in-jade-yaml-haml/#yaml\">get syntax right</a>)\nNote that you can use default values for env variables but only for those\nstrings. Do not use boolean since <code class=\"highlighter-rouge\">&lt;%= ENV['MY_VAR'} || true %&gt;</code> will always\nresolve to true.\nInstead of this</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>development: &amp;default\n  secret_key_base: &lt;%= ENV[\"SECRET_KEY_BASE\"] || 'some_secret' %&gt;\n\ntest: *default\nproduction:\n  &lt;&lt;: *default\n  monitor_mode: true\n</code></pre></div></div>\n\n<p>In rails 5 there are <code class=\"highlighter-rouge\">shared</code> key which will use all stuff.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt; config/secrets.yml &lt;&lt; HERE_DOC\nshared:\n  secret_key_base: &lt;%= ENV[\"SECRET_KEY_BASE\"] || 'some_secret' %&gt;\n\n  # sending emails\n  smtp_username: &lt;%= ENV[\"SMTP_USERNAME\"] %&gt;\n  smtp_password: &lt;%= ENV[\"SMTP_PASSWORD\"] %&gt;\n\n  # for all outgoing emails\n  mailer_sender: &lt;%= ENV[\"MAILER_SENDER\"] || \"My Company &lt;support@example.com&gt;\" %&gt;\n\n  # default_url is required for links in email body or in links in controller\n  # when url host is not available (for example rails console)\n  default_url:\n    host: &lt;%= ENV[\"DEFAULT_URL_HOST\"] || (Rails.env.production? ? \"premesti.se\" : \"www.myapp.localhost\") %&gt;\n    port: &lt;%= ENV[\"DEFAULT_URL_PORT\"] || (Rails.env.development? ? Rack::Server.new.options[:Port] : nil) %&gt;\n\n# `shared` is automatically included, no need to write\n# shared: &amp;default\n# development: *default\n# or\n# development:\n#   &lt;&lt;: *default\nHERE_DOC\n\ngit add . &amp;&amp; git commit -m \"Simplify secrets\"\n</code></pre></div></div>\n\n<h1 id=\"basic-mail-settings\">Basic mail settings</h1>\n\n<p>We can generate application mailer with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails generate mailer UserMailer hello\ngit add . &amp;&amp; git commit -am \"rails generate mailer UserMailer hello\"\n</code></pre></div></div>\n\n<p>Change default from address:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i app/mailers/application_mailer.rb -e '/default/c \\\n  default from: Rails.application.secrets.mailer_sender'\n</code></pre></div></div>\n\n<p>Set default url option, that is domain for <code class=\"highlighter-rouge\">root_url</code>:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># if you need to get from rails 4 use { port: Rails::Server.new.options[:Port] }\n# in config/environments/development.rb and also include\n# require 'rails/commands/server` on the top of the file\n\n# for rails 5 you can use Rack::Server.new.options[:Port] and no need to\n# require anything, but it works only if you provide -p param to rails s\n\n# config/application.rb\n    link = Rails.application.secrets.default_url.symbolize_keys\n    # for link urls in emails\n    config.action_mailer.default_url_options = link\n    # for link urls in rails console\n    config.after_initialize do\n      Rails.application.routes.default_url_options = link\n    end\n    # for asset-url or img_tag in emails\n    config.action_mailer.asset_host = \"http://#{link[:host]}:#{link[:port]}\"\n</code></pre></div></div>\n\n<p>For <a href=\"/2015/12/20/devise-oauth-angular/\">devise</a></p>\n\n<p>For local development use Letter opener:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i '/group :development do/a  \\\n  # open emails in browser\\\n  gem \"letter_opener\"' Gemfile\nsed -i '/^end$/i \\  config.action_mailer.delivery_method = :letter_opener' config/environments/development.rb \nbundle &amp;&amp; git add . &amp;&amp; git commit -m \"Letter opener to see emails in browser\"\nrails runner UserMailer.hello.deliver\n</code></pre></div></div>\n\n<p>For production see\n<a href=\"/2016/05/17/send-and-receive-emails-in-rails/\">send and receive emails in rails</a></p>\n\n<h1 id=\"skip-generators\">Skip generators</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i '/Rails::Application/a \\\n    config.i18n.enforce_available_locales = true\\\n    config.generators do |generate|\\\n      generate.helper false\\\n      generate.javascript_engine false\\\n      generate.request_specs false\\\n      generate.routing_specs false\\\n      generate.stylesheets false\\\n      generate.test_framework :rspec\\\n      generate.view_specs false\\\n    end\\\n    config.action_controller.action_on_unpermitted_parameters = :raise\\\n' config/application.rb\ngit add . &amp;&amp; git commit -m \"Skip generators\"\n</code></pre></div></div>\n\n<h1 id=\"authentication\">Authentication</h1>\n\n<h2 id=\"cleareance-gem\">Cleareance gem</h2>\n\n<p><a href=\"https://github.com/thoughtbot/clearance\">Clearance</a> is simple email authorization. It could work with <a href=\"https://gist.github.com/stevebourne/2394427\">facebook auth</a> but it’s designed to be only email auth.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo \"gem 'clearance'\" &gt;&gt; Gemfile &amp;&amp; bundle\nrails generate clearance:install\nrake db:migrate\nrails generate clearance:routes\ngit add . &amp;&amp; git commit -m \"rails g clearance:install\"\n\nsed -i '/&lt;body&gt;/a \\\\n\\\n  &lt;nav&gt;\\\n    &lt;% if signed_in? %&gt;\\\n      &lt;%= current_user.email %&gt;\\\n      &lt;%= button_to \"Sign out\", sign_out_path, method: :delete %&gt;\\\n    &lt;% else %&gt;\\\n      &lt;%= link_to \"Sign in\", sign_in_path %&gt;\\\n    &lt;% end %&gt;\\\n  &lt;/nav&gt;\\\n' app/views/layouts/application.html.erb\ngit add . &amp;&amp; git commit -m \"Adding sign signout path\"\n</code></pre></div></div>\n\n<h1 id=\"company-scaffold-with-skipped-unused-files\">Company scaffold with skipped unused files</h1>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g scaffold company name:string user:references --no-stylesheets --no-fixture --no-test-framework --no-helper --no-assets --no-jbuilder\nsed -i '/companies/a \\  root \"companies#index\"' config/routes.rb\nrake db:migrate &amp;&amp; git add . &amp;&amp; git commit -m \"rails g scaffold company name:string user:references\"\n</code></pre></div></div>\n\n<h1 id=\"puma\">Puma</h1>\n\n<p>Puma is now default webserver on rails. But by default it runs in single mode\nWEB_CONCURRENCY=1 so on heroku it will allow RAILS_MAX_THREADS connections if GIL is\nnot trigered.\nYou can simulate slow connection with <code class=\"highlighter-rouge\">sleep 10</code>, it does not triggel GIL.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>export RAILS_MAX_THREADS=1\ncurl $u/action_with_sleep_10 &amp;\ncurl $u/action_with_sleep_10 &amp;\n# real 10s\n# real 20s\n\n\nexport RAILS_MAX_THREADS=2\ncurl $u/action_with_sleep_10 &amp;\ncurl $u/action_with_sleep_10 &amp;\n# real 10s\n# real 10s\n</code></pre></div></div>\n\n<p>You can follow <a href=\"https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server\">heroku article</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt;HERE_DOC\ngem 'puma'\nHERE_DOC\nbundle\n\n# Rails 5 puma is default, and config/puma.rb is used, so do not need Procfile\n# but is it advisable to write it and put rakek db:migrate so you do not need to\n# run migration after you deploy. Restart is not needed as it was needed after\n# heroku run rake db:migrate (there are no exception, but update was not\n# actually saved in new columns, so restart was needed)\ncat &gt;&gt; Procfile &lt;&lt;HERE_DOC\nweb: bundle exec puma -C config/puma.rb\nrelease: rake db:migrate\nHERE_DOC\n\n# default puma config is fine, but on production should include those lines\ncat &gt;&gt; config/puma.rb &lt;&lt;HERE_DOC\nworkers Integer(ENV['WEB_CONCURRENCY'] || 2)\nthreads_count = Integer(ENV['RAILS_MAX_THREADS'] || 5)\nthreads threads_count, threads_count\n\npreload_app!\n\nrackup      DefaultRackup\nport        ENV['PORT']     || 3000\nenvironment ENV['RACK_ENV'] || 'development'\n\non_worker_boot do\n  # Worker specific setup for Rails 4.1+\n  # See: https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#on-worker-boot\n  ActiveRecord::Base.establish_connection\nend\nHERE_DOC\n\n# on development always use single mode\nmkdir config/puma\ncat &gt;&gt; config/puma/development.rb &lt;&lt;HERE_DOC\nworkers 0\nHERE_DOC\n</code></pre></div></div>\n\n<h1 id=\"heroku-deploy\">Heroku deploy</h1>\n\n<p>If you need to run separate command for background jobs, you need to write\n<code class=\"highlighter-rouge\">Procfile</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>export MYAPP_NAME=my-app # only dash, not underscore\n# # postgresql on production\n# sed -i Gemfile -e \"/gem 'sqlite3/c \\\n# gem 'pg'\"\n# sed -i '/adapter: sqlite3/c \\  adapter: postgresql' config/database.yml\n# sed -i \"/development.sqlite3/c \\  database: ${MYAPP_NAME}_dev\" config/database.yml\n# sed -i \"/test.sqlite3/c \\  database: ${MYAPP_NAME}_test\" config/database.yml\n# sed -i \"/production.sqlite3/c \\  database: ${MYAPP_NAME}_prod\" config/database.yml\n#\n# rails in production use: production: url: &lt;%= ENV['DATABASE_URL'] %&gt;\n\ncat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\n# heroku uses this 12 factor gem\ngem 'rails_12factor', group: :production\nHERE_DOC\nbundle\ngit commit -am \"Heroku uses 12factor gem\"\n\nheroku apps:create $MYAPP_NAME\nheroku addons:create heroku-postgresql:hobby-dev # this will set DATABASE_URL\ngit push heroku master --set-upstream\n\nheroku run rake db:migrate db:seed\n# heroku run rake db:setup will raise error:\n# PG::ConnectionBad: FATAL:  permission denied for database \"postgres\"\n# DETAIL:  User does not have CONNECT privilege\n# https://kb.heroku.com/why-am-i-seeing-user-does-not-have-connect-privilege-error-with-heroku-postgres-on-review-apps try\n# heroku pg:reset --confirm $MYAPP_NAME\n# heroku restart\n#\n# I do not know how to drop db since db:migrate:reset does not work either\n\n# sometimes you need to recompile assets when you change secrets but assets are\n# not changed, and you need to purge cache, install plugin\n# https://github.com/heroku/heroku-repo\n# heroku plugins:install heroku-repo\n# heroku repo:purge_cache\n\nheroku open\n</code></pre></div></div>\n\n<p>Heroku use ubuntu 16 or Ubuntu 18, you can change</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku apps:info\nheroku stack\nheroku stack:set heroku-16\n</code></pre></div></div>\n\n<p>You can pull from heroku databse https://devcenter.heroku.com/articles/heroku-postgresql#pg-push-and-pg-pull\nYou need to find the name of heroku database by clicking on Postgresl plugin</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails db:drop\nheroku pg:pull postgresql-name-on-heroku my_rails_app_development\n\n# also pushing\nheroku pg:reset\nheroku pg:push buyers_development postgresql-animate-86842\n</code></pre></div></div>\n\n<p>If you need to provision new database (upgrade from free to hobby) than you can\nuse pg copy\nhttps://devcenter.heroku.com/articles/upgrading-heroku-postgres-databases#upgrading-with-pg-copy</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku pg:copy DATABASE_URL HEROKU_POSTGRESQL_TEAL_URL\nheroku pg:promote HEROKU_POSTGRESQL_TEAL_URL\nheroku config # find color of old database\nheroku addons:destroy HEROKU_POSTGRESQL_NAVY_URL\n</code></pre></div></div>\n\n<p>If you need to compile node packages than you need need custom\n<a href=\"https://devcenter.heroku.com/articles/nodejs-support#customizing-the-build-process\">buildpack</a>.\nWe could use 3th party gulp buildpacks but default\n<a href=\"https://docs.npmjs.com/misc/config\">node</a>\n<a href=\"https://github.com/heroku/heroku-buildpack-nodejs\">buildpack</a> works fine.</p>\n\n<p>There is also for mysql <a href=\"https://github.com/Shopify/heroku-buildpack-mysql\">https://github.com/Shopify/heroku-buildpack-mysql</a> or\n<a href=\"https://github.com/din-co/heroku-buildpack-mysql\">https://github.com/din-co/heroku-buildpack-mysql</a></p>\n\n<p><code class=\"highlighter-rouge\">devDependencies</code> need to be renamed to <code class=\"highlighter-rouge\">dependecies</code> since it runs node\nproduction mode (I tried to disable production mode using NPM_CONFIG_ONLY but\nthan other thinks does not work). Imporant is\n<a href=\"https://devcenter.heroku.com/articles/nodejs-support#cache-behavior\">NODE_MODULES_CACHE</a>.\nIf we (by default) cache <code class=\"highlighter-rouge\">/node_modules</code> it will not build new version to public\nfolder.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># deploy to heroku\nheroku buildpacks:set https://github.com/heroku/heroku-buildpack-ruby\nheroku buildpacks:add --index 1 https://github.com/heroku/heroku-buildpack-nodejs\n\nheroku buildpacks # should return  1. nodejs  2. ruby (latest wins :)\n# alternativelly, we can define then in file .buildpacks\n# echo 'https://github.com/heroku/heroku-buildpack-ruby\n# https://github.com/heroku/heroku-buildpack-nodejs ' &gt; .buildpacks\n# heroku config:add BUILDPACK_URL=https://github.com/ddollar/heroku-buildpack-multi.git\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git rm -rf public\necho '/public\n/node_modules' &gt;&gt; .gitignore\ngit add .gitignore\ngit commit -m \"Remove public folder from git repo\"\n\necho '{\n  \"name\": \"rootApp\",\n  \"scripts\": {\n  },\n  \"dependencies\": {\n    \"myappAngular\": \"file:./client\"\n  },\n  \"cacheDirectories\": [\n    \"client/node_modules\",\n    \"client/bower_components\"\n  ]\n}\n' &gt; package.json\ngit add package.json &amp;&amp; git commit -m \"Add package.json for nodejs buildpack detect\"\n\ncd client\nsed -i \"/dist: 'dist/c \\  dist: '../../public',\" gulp/conf.js\nsed -i '/\"scripts\":/a \\    \"postinstall\": \"bower install &amp;&amp; gulp build\",' package.json\nsed -i '/\"devDependencies\":/c \\  \"dependencies\": {\\\n    \"bower\": \"*\",' package.json\ngit add . &amp;&amp; git commit -m \"Configure postinstall gulp build\"\ncd ..\n\ngit push heroku\nheroku config # NPM_CONFIG_PRODUCTION=true NODE_ENV=production NODE_MODULES_CACHE=true\nheroku open\n# usefull command to test is `npm install`\n# git commit --amend --allow-empty --no-edit &amp;&amp; echo \"output is saved: cat log/heroku.log\" &amp;&amp; git push heroku -f &gt; log/heroku.log 2&gt;&amp;1 &amp;&amp; heroku run bash -c 'mysql -v'\n</code></pre></div></div>\n\n<p>On heroku add <em>Papertrail</em> add-on and go to the\n<a href=\"https://papertrailapp.com/events\">https://papertrailapp.com/events</a> and search\nfor “Started GET” , save and create email alert or <a href=\"/2016/05/17/send-and-receive-emails-in-rails/\">add internal\nnotification</a></p>\n\n<p><a href=\"https://devcenter.heroku.com/articles/custom-domains\">https://devcenter.heroku.com/articles/custom-domains</a>\nFor custom domain just add on settings your domain name and create CNAME record\nfor <code class=\"highlighter-rouge\">www</code> with value <code class=\"highlighter-rouge\">myapp.herokuapp.com</code>.\nIf you need to match all subdomains (wildcard), you can put <em>Domain Name</em>\n<code class=\"highlighter-rouge\">*.kontakt.in.rs</code> and CNAME record for <code class=\"highlighter-rouge\">*</code> with same value\n<code class=\"highlighter-rouge\">myapp.herokuapp.com</code>.\nIf you need to add root domain (naked, bare, zone apex) than you can’t use\nloopia but some other suggested domain name providers.</p>\n\n<h2 id=\"deploy-javascript-npm-required-tasks\">Deploy javascript npm required tasks</h2>\n\n<h2 id=\"heroku-dyno-puma-settings\">Heroku dyno puma settings</h2>\n\n<p><a href=\"https://youtu.be/itbExaPqNAE\">https://youtu.be/itbExaPqNAE</a>\nSome Things in system = arrival rate X time spent in system so for server it is:\nhequests_in_system = requests per second X average_response_time (115 req/s *\n0.147s = 16 request in system, so we need at leat 16 workers in same time).\nutilization = requests_in_system / how_many_workers\nfor example = 115 req/s X 147ms response / 45 workers = 37%</p>\n\n<p>Use 3 WEB_CONCURRENCY workers and 3-5 RAILS_MAX_THREADS (not more since each thread\nneed connection to database, and use some on memory).\nhttps://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#workers suggests 2-4 workers\n<code class=\"highlighter-rouge\">sleep</code> also do not lock GIL (so all threads are working).</p>\n<blockquote>\n  <p>On MRI, there is a Global Interpreter Lock (GIL) that ensures only one thread\ncan be run at any time. IO operations such as database calls, interacting with\nthe file system, or making external http calls will not lock the GIL. Most\nRails applications heavily use IO, so adding additional threads will allow\nPuma to process multiple threads, gaining you more throughput. `</p>\n</blockquote>\n\n<p>https://devcenter.heroku.com/articles/scaling#autoscaling</p>\n\n<p>Also increase database, redis and memcached connections.\nHeroku postgresql hobby-basic has limit of 20 connections (enought for 3x5=15)</p>\n\n<h1 id=\"google-app-engine\">Google app engine</h1>\n\n<p>It is not hard to deploy to <a href=\"https://cloud.google.com/ruby/rails/appengine\">google ap engine\n</a></p>\n"
    } ,
  
    {
      "title"    : "Rails settings in cache and beta features",
      "category" : "",
      "tags"     : "ruby-on-rails, settings, cache, beta-features",
      "url"      : "/2015/03/04/rails-settings-in-cache-and-beta-features/",
      "date"     : "2015-03-04 00:00:00 +0100",
      "content"  : "<p>Did you ever wanted to use some configuration options, but you find very difficult to use secrets.yml file (<em>secrets.yml</em> file should be used for secrets, right ?), tired of using <code class=\"highlighter-rouge\">heroku config</code> to often, or even worse, deploying each time you change some constant in your code ?</p>\n\n<p>Here is a nice solution how to use <em>Rails.cache</em> to quickly change some params\nwithout need to restart rails application. Its Rails 3 ready. Some credits go\nto\n<a href=\"https://github.com/catarse/catarse_settings_db/blob/master/app/models/catarse_settings_db/setting.rb\">catarse_settings</a>.</p>\n\n<p>For Heroku, you need addon\n<a href=\"https://devcenter.heroku.com/articles/memcachier\">MemCachier</a> since FileStore\nis not shared between dynos (rails console is separate dyno).\n<a href=\"https://devcenter.heroku.com/articles/rack-cache-memcached-rails31\">rack-cache</a>\nis even better. It is not needed if you have activeAdmin page for updating\nsettings.\nSo here is my beta features code that is accessible for <em>admin</em> user:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/models/my_setting.rb\n# frozen_string_literal: true\nclass MySetting &lt; ActiveRecord::Base\n  validates :name, presence: true\n\n  # Migration file:\n  # rails g migration CreateMySettings name value:text description:text\n  #\n  # class CreateMySettings &lt; ActiveRecord::Migration\n  #   def change\n  #     create_table :my_settings do |t|\n  #       t.string :name\n  #       t.text :value\n  #       t.text :description\n  #     end\n  #   end\n  # end\n\n  # Never update values directly, use MySetting[:foo]='one,two'\n  # You can update using rails console or in your custom methods\n  # Return value is always string.\n  # For unknown key, nil is returned\n  # Integers are OK in format \"123\" so .to_i can be safelly performed\n  # (all money value should be in cents)\n\n  class &lt;&lt; self\n    # This method returns the values of the config simulating a Hash, like:\n    #   MySetting[:foo]\n    # It can also bring Arrays of keys, like:\n    #   MySetting[:foo, :bar]\n    # ... so you can pass it to a method using *.\n    # It is memoized, so it will be correctly cached.\n    def [](*keys)\n      if keys.size == 1\n        get keys.shift\n      else\n        keys.map { |key| get key }\n      end\n    end\n\n    def []=(key, value)\n      set key, value\n    end\n\n    def get_without_cache(key)\n      my_setting = find_by_name(key)\n      return my_setting.value if my_setting\n      # to return nil in case of unknown key\n      nil\n    end\n\n    private\n\n    def get(key)\n      Rails.cache.fetch(\"/configurations/#{key}\") do\n        get_without_cache(key)\n      end\n    end\n\n    def set(key, value)\n      find_or_create_by!(name: key).update(value: value)\n      Rails.cache.write(\"/configurations/#{key}\", value)\n      value\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>In all places in my rails application I use this <code class=\"highlighter-rouge\">beta</code> helper method that uses\ntwo MySetting variable. <code class=\"highlighter-rouge\">live_features</code> are comma separated list of feature\nnames that are live, and <code class=\"highlighter-rouge\">beta_users</code> are emails for users that can see non live\nfeatures (of course only when they are logged in).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/helpers/beta_helper.rb\nmodule BetaHelper\n  # example of usage:\n  # &lt;% if beta :name_of_feature %&gt;\n  #   &lt;div&gt;Something&lt;/div&gt;\n  # &lt;% end %&gt;\n  # &lt;%= beta :name_of_feature, render( \"something\") %&gt;\n  # redirect_to(root_path) if view_context.beta(:name_of_feature)\n  #\n  # to make feature available to all, add it to MySetting[:live_features]\n  # some can see non live features if it is listed in MySettings[:beta_users]\n  # for features on non logged in pages (for example GET homepage) you can\n  # override default with url param: ?enable_feature=name_of_feature\n  # rubocop:disable CyclomaticComplexity\n  # rubocop:disable MethodLength\n  # rubocop:disable AbcSize\n  # rubocop:disable PerceivedComplexity\n  helper_method :beta\n  def beta(symbol_of_feature, content = nil)\n    # to catch emails without blank and , from \"asd@asd.asd,\\r\\ndsa@dsa.dsa\"\n    r = Regexp.new(/\\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}\\b/)\n    if MySetting[:live_features].split(/[\\s,]+/).include? symbol_of_feature.to_s\n      live_feature = true\n    elsif defined?(current_user) &amp;&amp;\n          current_user.class == User &amp;&amp;\n          MySetting[:beta_users].scan(r).include?(current_user.email)\n      beta_user = true\n    elsif defined?(params) &amp;&amp;\n          # in mailer params are not available so check before use it\n          params[:enable_feature] == symbol_of_feature.to_s\n      live_feature_by_param = true\n    end\n\n    if live_feature || beta_user || live_feature_by_param\n      if content.present?\n        content\n      else\n        true\n      end\n    else\n      false\n    end\n  end\nend\n</code></pre></div></div>\n\n<p>To keep track of features I usually write them in seed file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># db/seeds.rb\n[\n  {\n    name: 'beta_users',\n    value: 'asd@asd.asd, admin@asd.asd',\n    description: 'List of emails of users that can see non live features'\n  },\n  {\n    name: 'live_features',\n    value: 'phone_confirmation_feature',\n    description: 'List of features that all users can use.'\\\n                 ' Note that beta_users can always see all features'\n  },\n  {\n    name: 'embed_video_url_for_popup_on_home_page',\n    value: 'https://www.youtube.com/embed/cQr4ua3dxiM',\n    description: 'Url for video in modal, should be embed, something like' \\\n                 ' https://www.youtube.com/embed/'\n  },\n].each do |doc|\n  next if MySetting.find_by name: doc[:name]\n  MySetting[doc[:name]] = doc[:value]\n  MySetting\n    .find_by(name: doc[:name])\n    .update_attribute(:description, doc[:description])\n  puts \"MySetting #{doc[:name]} seeded.\"\nend\n</code></pre></div></div>\n\n<h1 id=\"tests\">Tests</h1>\n\n<p>In your tests simply add  <code class=\"highlighter-rouge\">before { MySetting[:live_features] = 'phone_confirmation_feature' }</code></p>\n\n<h1 id=\"administrate\">Administrate</h1>\n\n<p>For administrate gem, we need to call <code class=\"highlighter-rouge\">MySetting[]</code> methods because we need to update cache</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g administrate:dashboard MySetting\n# add :my_settings to DASHBOARDS in app/dashboards/dashboard_manifest.rb\n# add following code to app/controllers/admin/my_settings_controller.rb\n    def update\n      super\n      MySetting[resource_params[:name]] = resource_params[:value]\n    end\n    def create\n      super\n      MySetting[resource_params[:name]] = resource_params[:value]\n    end\n    def destroy\n      MySetting[requested_resource.name] = \"\"\n      super\n    end\n</code></pre></div></div>\n\n<h1 id=\"activeadmin\">ActiveAdmin</h1>\n\n<p><a href=\"https://github.com/activeadmin/activeadmin\">activeadmin gem</a> is nice way to\nedit stuff. It contains generators, for example <code class=\"highlighter-rouge\">rails g active_admin:resource\nBanner</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/admin/my_setting.rb\nActiveAdmin.register MySetting do\n  permit_params :name, :value, :description\n  controller do\n    def update\n      super\n      MySetting[resource.name] = resource.value\n    end\n    def create\n      super\n      MySetting[resource.name] = resource.value\n    end\n    def destroy\n      MySetting[resource.name] = \"\"\n      super\n    end\n  end\nend\n</code></pre></div></div>\n"
    } ,
  
    {
      "title"    : "Rails through Vagrant to DigitalOcean",
      "category" : "",
      "tags"     : "ruby-on-rails, vagrant, digitalocean",
      "url"      : "/2015/02/16/rails-through-vagrant-to-digitalocean/",
      "date"     : "2015-02-16 00:00:00 +0100",
      "content"  : "<p>When a lot of people are working on the same Rails application, than\n<em>Vagrant</em> could help to set up environment quick and easy.  Even Vagrant\nis not recommended for production, it is very usefull for testing\nbootstrap scripts automatically. For production we can simply copy\nbootstrap script and run commands manually.</p>\n\n<h1 id=\"vagrant\">Vagrant</h1>\n\n<p>Default user/password is <code class=\"highlighter-rouge\">vagrant/vagrant</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>vagrant init\nvagrant up\nvagrant ssh\nvagrant halt\nvagrant destroy\n</code></pre></div></div>\n\n<p>Run command as <code class=\"highlighter-rouge\">deployer</code> user. Usually need to wrap inside <code class=\"highlighter-rouge\">bash</code> if you have\npipe <code class=\"highlighter-rouge\">|</code>, for example <code class=\"highlighter-rouge\">sudo -i -u deployer bash -c \"ls | less -R\"</code></p>\n\n<p>If you have multuple vagrant boxes and there is port collision, you can set auto\nfix</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>config.vm.network :forwarded_port, guest: 8080, host: 80, auto_correct: true\n</code></pre></div></div>\n\n<h1 id=\"deploy-ruby-on-rails-to-virtualbox\">Deploy Ruby on Rails to VirtualBox</h1>\n\n<script src=\"https://gist.github.com/duleorlovic/8815e439905dbd326a41.js\"></script>\n\n<h1 id=\"deploy-ruby-on-rails-on-nginx-and-puma-server\">Deploy Ruby on Rails on Nginx and Puma server</h1>\n\n<script src=\"https://gist.github.com/duleorlovic/762c4ffdf43c8eb31aa7.js\"></script>\n\n"
    } ,
  
    {
      "title"    : "Good rails exception notifier better than tests",
      "category" : "",
      "tags"     : "ruby-on-rails, exception-notification",
      "url"      : "/2015/01/11/good-rails-exception-notification-better-than-tests/",
      "date"     : "2015-01-11 00:00:00 +0100",
      "content"  : "<p>Do not hide your mistakes, instead, make sure that every bug is noticeable.\nThat way you will learn more and thinks that you did not know (that’s why bug\noccurs).</p>\n\n<p>Bugs that I have meet are something like: user uploaded file with non asci\nchars, linkedin identity text is missing graduation date, after_create hook\non model with devise cause <code class=\"highlighter-rouge\">user.save</code> to return <em>true</em> but <em>user.errors</em> is\npresent and user is redirected to update his registration form… You can NOT\nwrite tests for those situations. Better is to have nice notification with all\ninput/session/user data. Any rescue block should use this notification.</p>\n\n<p>Excellent gem for notification is\n<a href=\"https://github.com/smartinez87/exception_notification\">exception_notification</a>.\nIt is rack middleware and configuration is very simple.</p>\n\n<h1 id=\"basic-installation\">Basic installation</h1>\n\n<p>After adding to your Gemfile</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt;HERE_DOC\n# error notification to EXCEPTION_RECIPIENTS emails\ngem 'exception_notification'\nHERE_DOC\nbundle\n</code></pre></div></div>\n\n<p>set email receivers in your secrets:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sed -i config/secrets.yml -e '/^shared:/a \\\n  # for all outgoing emails\\\n  mailer_sender: &lt;%= ENV[\"MAILER_SENDER\"] || \"My Company &lt;support@example.com&gt;\" %&gt;\\\n\\\n  # leave this empty if you do not want to enable server error notifications\\\n  # othervise comma separated emails\\\n  exception_recipients: &lt;%= ENV[\"EXCEPTION_RECIPIENTS\"] %&gt;\\\n'\n</code></pre></div></div>\n\n<p>and add this initialization file (similar to autogenerated with\n<code class=\"highlighter-rouge\">rails g exception_notification:install</code>)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt; config/initializers/exception_notification.rb &lt;&lt; HERE_DOC\nrequire 'exception_notification/rails'\n\nclass Notify\n  # Send notification using string as subject and pass additional argumets (it\n  # will be shown as array) or options (shown as hash) for example:\n  # Notify.message 'some_problem', customers_url, email: customer.email\n  # Rails 5: Notify.message 'text', user.slice :id, :name\n  def self.message(message, *args)\n    data = {}\n    # put first args so it is shown at beginning\n    data[:args] = args if args.present?\n    data.merge! args.extract_options!\n    ExceptionNotifier.notify_exception(Exception.new(message), data: data)\n    # return true so we could use: Notify.message 'hi' and return unless continue?\n    true\n  end\n\n  def self.exception_with_env(message, args)\n    # set env to nil if you do not want sections: Request, Environment, Session\n    # backtrace is not shown for manual notification (only if data section\n    # contains backtrace)\n    # data section is always shown if exists\n    params = {\n      env: args[:env],\n      exception_recipients: args[:exception_recipients],\n      email_prefix: args[:email_prefix],\n      data: args[:data],\n    }.delete_if { |_k, v| v.nil? }\n    ExceptionNotifier.notify_exception(Exception.new(message), params)\n  end\nend\n\n# rubocop:disable Metrics/BlockLength\nif (receivers = Rails.application.secrets.exception_recipients).present?\n  ExceptionNotification.configure do |config|\n    # Ignore additional exception types. Those are already included\n    # ActiveRecord::RecordNotFound\n    # AbstractController::ActionNotFound\n    # ActionController::RoutingError\n    config.ignored_exceptions += %w[\n      ActiveRecord::RecordNotFound\n      AbstractController::ActionNotFound\n      ActionController::RoutingError\n      ActionController::UnknownFormat\n\n      ApplicationController::NotFoundError\n      ApplicationController::DisabledError\n      ApplicationController::AccessDeniedError\n      ApplicationController::InvalidCharactersUsed\n    ]\n\n    # Adds a condition to decide when an exception must be ignored or not.\n    # The ignore_if method can be invoked multiple times to add extra conditions\n    # config.ignore_if do |exception, options|\n    #   not Rails.env.production?\n    # end\n\n    # Ignore crawlers\n    IGNORE_HTTP_USER_AGENT = %w[\n      Googlebot bingbot linkdexbot Baiduspider YandexBot panscient.com MJ12bot\n      SeznamBot\n    ].freeze\n    config.ignore_if do |_exception, options|\n      options[:env] &amp;&amp; Array(IGNORE_HTTP_USER_AGENT).any? do |crawler|\n        options[:env]['HTTP_USER_AGENT'] =~ Regexp.new(crawler)\n      end\n    end\n\n    # Ignore formats\n    IGNORE_HTTP_ACCEPT = %w[Agent-007 image/x-xbitmap].freeze\n    config.ignore_if do |_exception, options|\n      options[:env] &amp;&amp; Array(IGNORE_HTTP_ACCEPT).any? do |format|\n        options[:env]['HTTP_ACCEPT'] =~ Regexp.new(format)\n      end\n    end\n\n    # Ignore too much notifications. throttle by same message\n    THROTTLE_LIMIT = 3 # resets only when nothing is seen in interval window\n    THROTTLE_INTERVAL_SECONDS = 1.hour\n    config.ignore_if do |exception|\n      # to exit from proc we could use 'next' ('return' or 'break' does not work\n      # for proc) but than it returns nil, ie it will notify if true\n      # to skip notification on development clear EXCEPTION_RECIPIENTS env\n      cache_key = exception.message.sub(/0[xX][0-9a-fA-F]+/, '') # ignore eventual object hex id\n      already = Rails.cache.fetch(cache_key)\n      if already\n        Rails.cache.write cache_key,\n                          already + 1,\n                          expires_in: THROTTLE_INTERVAL_SECONDS\n        # do not notify if already send max number of times, return val is true\n        already &gt;= THROTTLE_LIMIT\n      else\n        Rails.cache.write cache_key, 1, expires_in: THROTTLE_INTERVAL_SECONDS\n        # it is ok to notify\n        false\n      end\n    end\n\n    # Ignore specific exceptions that are marked to be ignored\n    # begin\n    # rescue StandardError =&gt; e\n    #   e.ignore_please = true\n    #   raise e\n    # end\n    config.ignore_if { |e| e.respond_to?(:ignore_please) &amp;&amp; e.ignore_please }\n\n    # Notifiers ================================================================\n\n    # Email notifier sends notifications by email.\n    config.add_notifier :email,\n                        email_prefix: '[MyApp] ',\n                        sender_address: Rails.application.secrets.mailer_sender,\n                        exception_recipients: receivers.split(',')\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<p>This will send email for any exception if <code class=\"highlighter-rouge\">EXCEPTION_RECIPIENTS</code> are present.\nAs delivery method you can use very nice <a href=\"/2016/05/17/send-and-receive-emails-in-rails/#letter-opener-for-local-preview\">letter_opener</a>\nfor development.</p>\n\n<p>If you keep receiving unknown <code class=\"highlighter-rouge\">(ActionView::MissingTemplate) \"Missing template</code>\nfor json request (but you only consider html) or for html (but you only consider\njs), you should add something like</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  def index\n    respond_to do |format|\n      format.html\n      format.any { redirect_to root_path }\n    end\n  end\n</code></pre></div></div>\n\n<p>You can test if it properly ignore by setting curl headers</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>curl http://localhost:3000/sample-error # this should open letter opener\ncurl http://localhost:3000/sample-error -A 'Googlebot' # this is ignored\ncurl http://localhost:3000/sample-error -H 'Accept: Agent-007' # this is ignored\ncurl  -H \"Accept: application/json\" http://localhost:3000/ # could trigger\n# MissingTemplate error\n</code></pre></div></div>\n\n<h1 id=\"javascript-notification-and-example-error-pages\">Javascript notification and example error pages</h1>\n\n<p>I would add two pages <em>sample-error</em> and <em>sample-error-in-javascript</em> just\nto have some pages for test if this notification works. First create routes</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\" data-lang=\"ruby\"><span class=\"c1\"># config/routes.rb</span>\n<span class=\"n\">get</span> <span class=\"s1\">'sample-error'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages#sample_error'</span>\n<span class=\"n\">get</span> <span class=\"s1\">'sample-error-in-javascript'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages#sample_error_in_javascript'</span>\n<span class=\"n\">get</span> <span class=\"s1\">'sample-error-in-javascript-ajax'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages#sample_error_in_javascript_ajax'</span>\n<span class=\"n\">post</span> <span class=\"s1\">'notify-javascript-error'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages#notify_javascript_error'</span>\n<span class=\"n\">get</span> <span class=\"s1\">'sample-error-in-resque'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages#sample_error_in_resque'</span>\n<span class=\"n\">get</span> <span class=\"s1\">'sample-error-in-sidekiq'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages#sample_error_in_sidekiq'</span>\n<span class=\"n\">get</span> <span class=\"s1\">'sample-error-in-delayed-job'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages#sample_error_in_delayed_job'</span></code></pre></figure>\n\n<p>than controller method that we will use for manual notification\n<a href=\"https://github.com/smartinez87/exception_notification#manually-notify-of-exception\">ExceptionNotifier.notify_exception</a>\nIn some cases I need just to notify with custom email\n<code class=\"highlighter-rouge\">MyMailer.internal_notification(subject, item).deliver</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/mailers/my_mailer.rb\nclass MyMailer &lt; ActionMailer::Base\n  def internal_notification(subject, item)\n    mail to: INTERNAL_NOTIFICATION_EMAIL,\n         subject: \"[MyApp info] #{subject}\",\n         body: \"&lt;h1&gt;#{subject}&lt;/h1&gt;&lt;strong&gt;Details:&lt;/strong&gt;\" +\n               item\n               .inspect\n               .gsub(', ', ',&lt;br&gt;')\n               .gsub('{', '&lt;br&gt;{&lt;br&gt;')\n               .gsub('}', '&lt;br&gt;}&lt;br&gt;'),\n         content_type: 'text/html'\n  end\nend\n</code></pre></div></div>\n\n<p>For <code class=\"highlighter-rouge\">notify_exception</code> can pass additional information using <code class=\"highlighter-rouge\">:data</code> param. Only\nthe first argument is required (default values you can find\n<a href=\"https://github.com/smartinez87/exception_notification/blob/df0b924e96a8f02c1fc61f88e6a1ed9c31ee43ec/lib/exception_notifier/email_notifier.rb#L162\">here</a>).\nFor less important notification you can change subject with <code class=\"highlighter-rouge\">email_prefix</code>\nparam. Manual notification can be simply as one line\n<code class=\"highlighter-rouge\">ExceptionNotifier.notify_exception(Exception.new('this_user_is_deactived'),\nenv: request.env, email_prefix: 'just to notify that', data: { current_user:\ncurrent_user });</code>.\nHere is what I use:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/pages_controller.rb\nclass PagesController &lt; ApplicationController\n  skip_before_action :verify_authenticity_token, only: %i[\n    notify_javascript_error\n  ]\n\n  def sample_error\n    raise 'This is sample_error on server'\n  end\n\n  def sample_error_in_javascript\n    render layout: true, html: %(\n      Calling manual_js_error_now\n      &lt;script&gt;\n        function manual_js_error_now_function() {\n          manual_js_error_now\n        }\n        console.log('calling manual_js_error_now');\n        manual_js_error_now_function();\n        // you can also trigger error on window.onload = function() { manual_js_error_onload }\n      &lt;/script&gt;\n      &lt;br&gt;\n      &lt;button onclick=\"trigger_js_error_on_click\"&gt;Trigger error on click&lt;/button&gt;\n      &lt;a href=\"/sample-error-in-javascript-ajax\" data-remote=\"true\" id=\"l\"&gt;Trigger error in ajax&lt;/a&gt;\n    ).html_safe\n  end\n\n  def sample_error_in_javascript_ajax\n    render js: %(\n      console.log(\"starting sample_error_in_javascript_ajax\");\n      sample_error_in_javascript_ajax\n    )\n  end\n\n  def notify_javascript_error\n    js_receivers = Rails.application.secrets.javascript_error_recipients\n    if js_receivers.present?\n      ExceptionNotifier.notify_exception(\n        Exception.new(params[:errorMsg]),\n        env: request.env,\n        exception_recipients: js_receivers.to_s.split(','),\n        data: {\n          current_user: current_user,\n          params: params\n        }\n      )\n    end\n    head :ok\n  end\n\n  def sample_error_in_resque\n    Resque.enqueue(TaskWithError)\n    render plain: 'TaskWithError in queue, please run: QUEUE=* rake resque:work'\n  end\n\n  def sample_error_in_sidekiq\n    TaskWithErrorJob.perform_later\n    render plain: 'TaskWithErrorJob in queue, please run: bundle exec sidekiq -C config/sidekiq.yml'\n  end\n\n  def sample_error_in_delayed_job\n    SampleErrorJob.perform_later\n    render plain: 'SampleErrorJob in queue, please run: QUEUE=* rake jobs:work'\n  end\nend\n\nclass TaskWithError\n  @queue = :test\n  def self.perform\n    raise 'This is sample_error_in_resque'\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"delayed-job\">Delayed job</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/delayed_job.rb\nDelayed::Worker.destroy_failed_jobs = false\nDelayed::Worker.max_attempts = 3\nDelayed::Worker.delay_jobs = !Rails.env.test?\n\n### RAILS 5\nmodule CustomFailedJob\n  def handle_failed_job(job, error)\n    super\n    ExceptionNotifier.notify_exception(error, data: {job: job})\n  end\nend\n\nclass Delayed::Worker\n  prepend CustomFailedJob\nend\n\n### Rails 4\n\nDelayed::Worker.logger = Logger.new(File.join(Rails.root, 'log', 'delayed_job.log'))\n\n# when you change this file, make sure that you restart delayed_job process\n# bin/delayed_job stop &amp;&amp; bin/delayed_job start\n# probably DelayedJob is configured to retry 3 times, so you will receive\n# notification emails\n# do not rescue in worker because no notification email will be send\n# http://andyatkinson.com/blog/2014/05/03/delayed-job-exception-notification-integration\n\nclass Exception\n  attr_accessor :ignore_please\nend\n\n# Chain delayed job's handle_failed_job method to do exception notification\nDelayed::Worker.class_eval do\n  def handle_failed_job_with_notification(job, error)\n    handle_failed_job_without_notification(job, error)\n\n    begin\n      # ExceptionNotifier.notify_exception(error) do not use standard notification, use delayed_job partial\n      return if error.ignore_please &amp;&amp; job.attempts &lt; Delayed::Worker.max_attempts\n      env = {}\n      env['exception_notifier.options'] = {\n        sections: %w(backtrace delayed_job),\n        email_prefix: \"[Xceednet Delayed Job Exception] \",\n      }\n      env['exception_notifier.exception_data'] = {job: job}\n      ExceptionNotifier::Notifier.exception_notification(env, error).deliver\n\n    # rescue if ExceptionNotifier fails for some reason\n    rescue Exception =&gt; e\n      Rails.logger.error \"ExceptionNotifier failed: #{e.class.name}: #{e.message}\"\n      e.backtrace.each do |f|\n        Rails.logger.error \"  #{f}\"\n      end\n      Rails.logger.flush\n    end\n  end\n\n  alias_method_chain :handle_failed_job, :notification\nend\n</code></pre></div></div>\n\n<p>If you want to ignore specific timeout exception than use something like</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/jobs/send_sms_job.rb\nclass SendSmsJob &lt; ActiveJob::Base\n  queue_as :webapp\n\n  rescue_from Net::ReadTimeout, SocketError do |e|\n    e.ignore_please = true\n    # re-raise so job is retried\n    raise e\n  end\n  def perform()\n  end\nend\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/jobs/sample_error_job.rb\nclass SampleErrorJob &lt; ActiveJob::Base\n  queue_as :default\n\n  def perform\n    raise 'This is sample_error_in_delayed_job'\n  end\nend\n</code></pre></div></div>\n\n<h1 id=\"sidekiq\">Sidekiq</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/jobs/task_with_error_job.rb\nclass TaskWithErrorJob &lt; ApplicationJob\n  queue_as :default\n  def perform\n    raise 'This is sample_error_in_sidekiq'\n  end\nend\n\n# config/initializers/exception_notification.rb\nSidekiq.configure_server do |config|\n  config.error_handlers &lt;&lt; proc { |ex, context|\n    ExceptionNotifier.notify_exception(ex, data: { sidekiq: context })\n  }\nend\n</code></pre></div></div>\n\n<p>If error occurs in ajax reponse, or in some of your javascript code, we will\nsend another request to server to trigger javascript notification. Note that you\ncan log with <code class=\"highlighter-rouge\">console.error(\"Some error message\")</code> (in console it will look like\nexception) but no notification will be sent.</p>\n\n<p>You can send notifications using formspree service.\nThere is non jQuery fallback but loaded jQuery is preferred.\nYou should create separate file that will be loaded in <code class=\"highlighter-rouge\">&lt;head&gt;</code> and before\napplication.js so it is loaded before any other js code.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/javascripts/exception_notification.js.erb\n// This should be loaded in &lt;head&gt; and separatelly from application.js\n// notification will not work if some error exist in this file\n//\nvar MAX_NUMBER_OF_JS_ERROR_NOTIFICATIONS = 5;\n\nfunction sendExceptionNotification(data) {\n  &lt;% unless Rails.application.secrets.javascript_error_recipients.present? %&gt;\n    return ;\n  &lt;% end %&gt;\n  // maybe error occured before jQuery was loaded\n  if (window.jQuery) {\n    console.log(\"notify server about exception using jQuery\");\n    jQuery.post('/notify-javascript-error', data);\n\n  } else {\n    console.log(\"notify server about exception using plain javascript\");\n    var xhr = new XMLHttpRequest();\n    xhr.open('POST', '/notify-javascript-error', true);\n    xhr.setRequestHeader(\"Content-Type\", \"application/json;charset=UTF-8\");\n    xhr.send(JSON.stringify(data));\n  }\n  // or use formspree service with your email\n  // $.ajax({\n  //   url: \"https://formspree.io/your@gmail.com\", \n  //   method: \"POST\",\n  //   data: data,\n  //   dataType: \"json\"\n  // });\n}\n\nfunction ignoreErrorMsg(errorMsg) {\n  if (errorMsg.length == 0) return true; // no need to notify empty message\n  &lt;% if Rails.env.development? %&gt;\n      return false; // always notify on development\n  &lt;% end %&gt;\n  if (sessionStorage) {\n    var errorMsgs = JSON.parse(sessionStorage.getItem(\"errorMsgs\") || \"[]\");\n    if (errorMsgs.indexOf(errorMsg) != -1) {\n      console.log(\"Ignore already notified error for this session and tab\");\n      return true;\n    } else {\n      sessionStorage.setItem(\"errorMsgs\", JSON.stringify(errorMsgs + [errorMsg]));\n    }\n\n    if (JSON.parse(sessionStorage.getItem(\"numberOfJsErrorNotifications\") || \"0\") &gt;= MAX_NUMBER_OF_JS_ERROR_NOTIFICATIONS) {\n      console.log(\"Ignore error since number of notification reached maxiumum \" + MAX_NUMBER_OF_JS_ERROR_NOTIFICATIONS);\n      return true;\n    }\n  }\n  ignoredErrors = {\n    // https://github.com/kogg/InstantLogoSearch/issues/199\n    tgt: \"Cannot set property 'tgt' of null\",\n    // from extention http://s3.amazonaws.com/js-cache/ddc1b879c920534271.js\n    partnrz: \"Unexpected token &lt; in JSON at position 1\",\n    // from extension http://s3.amazonaws.com/jscache/de53b459ee43e7774f.js\n    monetize: \"SyntaxError: Unexpected end of JSON input\",\n    plugin1: \"TypeError: undefined is not an object (evaluating 'Window.prototype.setTimeout.call')\",\n    deals: \"Uncaught ReferenceError: US is not defined\",\n    // http://pastebin.com/JAPbmEX6\n    reno: \"renoTransGloRef\",\n    // https://bugs.chromium.org/p/chromium/issues/detail?id=590375\n    chrome1: \"__gCrWeb\",\n    // unknown string closingEls\n    closing_els: \"TypeError: Cannot read property 'closingEls' of undefined\",\n    // some unknown\n    show_deepen: \"__show__deepen\",\n    // __firefox__.favicons.getFavicons\n    firefox: \"__firefox__\",\n    // unknown\n    unknown1: \"viewWillDisappear\",\n  }\n  for (var key in ignoredErrors) {\n    if (errorMsg.indexOf(ignoredErrors[key]) != -1) {\n      console.log(\"ignoredErrors key=\" + key);\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction ignoreSourceUrl(sourceUrl) {\nif (typeof(sourceUrl) == \"string\" &amp;&amp; sourceUrl != \"\" &amp;&amp;\n    sourceUrl.indexOf(window.location.hostname) == -1) {\n    console.log(\"ignoreSourceUrl\");\n    return true;\n  }\n  return false;\n}\n\nfunction ignoreStack(stack) {\n  if (stack == null) {\n    return false;\n  }\n  ignoredStacks = {\n    akamai: \"akamaihd.net\",\n  }\n  for (var key in ignoredStacks) {\n    if (stack.indexOf(ignoredStacks[key]) != -1) {\n      console.log(\"ignoredStacks key=\" + key);\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction checkAndSendNotification(notificationData) {\n  var errorMsg = notificationData.errorMsg;\n  if (ignoreSourceUrl(notificationData.sourceUrl)) return;\n  if (ignoreStack(notificationData.stack)) return;\n  if (ignoreErrorMsg(errorMsg)) return;\n  flash_alert(errorMsg);\n  sendExceptionNotification(notificationData);\n  if (sessionStorage) {\n    var numberOfJsErrorNotifications = JSON.parse(sessionStorage.getItem(\"numberOfJsErrorNotifications\") || \"0\");\n    numberOfJsErrorNotifications += 1;\n    sessionStorage.setItem(\"numberOfJsErrorNotifications\", JSON.stringify(numberOfJsErrorNotifications));\n  }\n}\n\n// https://developer.mozilla.org/en/docs/Web/API/GlobalEventHandlers/onerror\n// https://blog.getsentry.com/2016/01/04/client-javascript-reporting-window-onerror.html\nwindow.onerror = function(errorMsg, sourceUrl, lineNumber, column, errorObj) {\n  if (errorObj != null) {\n    errorMsg = errorObj.toString();\n  }\n  var stack;\n  if (errorObj == null || errorObj.stack == null) {\n    stack = new Error().stack;\n  } else {\n    stack = errorObj.stack\n  }\n  var notificationData = { errorMsg: errorMsg, sourceUrl: sourceUrl, lineNumber: lineNumber, column: column, stack: stack };\n  checkAndSendNotification(notificationData);\n}\n\n// another approach is with error event listener\n// window.addEventListener('error', function (e) {\n//     var stack = e.error.stack;\n//     var message = e.error.toString();\n// });\n\n// ajax error handling\n// wait DOM to load\n// http://stackoverflow.com/questions/799981/document-ready-equivalent-without-jquery\n// I tried with document.addEventListener(\"DOMContentLoaded\", function(event) {\n// but $ still not defined\nfunction listenAjaxErrors() {\n // https://github.com/rails/jquery-ujs/wiki/ajax\n $(document).on('ajax:error', '[data-remote]', function(e, xhr, status, errorObj) {\n   flash_alert(\"Please refresh the page. Server responds with: \" + errorObj);\n   var notificationData = { errorMsg: errorObj.toString(), status: status, stack: errorObj.stack };\n   checkAndSendNotification(notificationData);\n });\n}\n\n// http://stackoverflow.com/questions/7486309/how-to-make-script-execution-wait-until-jquery-is-loaded\nfunction defer(method) {\n  if (window.jQuery)\n    method();\n  else\n    setTimeout(function() { defer(method) }, 150);\n}\n\ndefer(listenAjaxErrors);\n\nfunction flash_alert(msg) {\n  if (msg.length == 0) return;\n  // disable eventual popups so user can see the message\n  // $('.active').removeClass('active');\n  // alert(msg);\n  console.log(msg);\n}\n\n// Ensures there will be no 'console is undefined' errors\n// http://stackoverflow.com/questions/9725111/internet-explorer-console-is-not-defined-error\nwindow.console = window.console || (function(){\n    var c = {}; c.log = c.warn = c.debug = c.info = c.error = c.time = c.dir = c.profile = c.clear = c.exception = c.trace = c.assert = function(s){};\n    return c;\n})();\n</code></pre></div></div>\n\n<ul>\n  <li>\n    <p>if you use <code class=\"highlighter-rouge\">require_tree .</code> or your js\nis loaded at the end of &lt;body&gt; (not included in <code class=\"highlighter-rouge\">&lt;head&gt;</code>) than you need to\ninclude this exception notification so it is available <strong>BEFORE</strong> any other js\ncode. In this case you need to stub it so it is not included twice</p>\n\n    <div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/layouts/application.html.erb\n  &lt;head&gt;\n    &lt;%= javascript_include_tag :exception_notification %&gt;\n    &lt;%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %&gt;\n  &lt;/head&gt;\n\n// app/assets/javascripts/application.js\n//= stub exception_notification\n\n# config/initializers/assets.rb\nRails.application.config.assets.precompile += %w[exception_notification.js]\n</code></pre></div>    </div>\n  </li>\n</ul>\n\n<p>Do not forget to define javascript receivers</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-yaml\" data-lang=\"yaml\"><span class=\"c1\"># config/secrets.yml</span>\n  <span class=\"c1\"># leave this empty if you do not want to enable javascript error notification</span>\n  <span class=\"c1\"># othervise comma separated emails</span>\n  <span class=\"na\">javascript_error_recipients</span><span class=\"pi\">:</span> <span class=\"s\">&lt;%= ENV[\"JAVASCRIPT_ERROR_RECIPIENTS\"] %&gt;</span></code></pre></figure>\n\n<p>NOTE that when you <code class=\"highlighter-rouge\">export JAVASCRIPT_ERROR_RECIPIENTS</code> than you need also to\nchange <code class=\"highlighter-rouge\">app/assets/javascripts/exception_notification.js.erb</code> so it is\nrecompiled (touch does not trigger recompilation).</p>\n\n<p>CSP can help your site to prevent loading external js for extensions. Fine grane\ncan enable loading google maps, facebook buttons on specific pages.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Content-Security-Policy: default-src\n</code></pre></div></div>\n\n<h1 id=\"custom-templates\">Custom Templates</h1>\n\n<p>You can change existing sections like https://github.com/smartinez87/exception_notification/blob/master/lib/exception_notifier/views/exception_notifier/_session.text.erb\nby overriding file:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/exception_notifier/_session.text.erb\n* session id: &lt;%= @request.ssl? ? \"[FILTERED]\" : (raw (@request.session['session_id'] || (@request.env[\"rack.session.options\"] and @request.env[\"rack.session.options\"][:id])).inspect.html_safe) %&gt;\n* data: &lt;%= raw PP.pp(@request.session.to_hash, \"\") %&gt;\n\n&lt;% if @request.session['warden.user.user.key'].present? %&gt;\n&lt;%\n  # try to find current_user\n  id = @request.session['warden.user.user.key']&amp;.first&amp;.first\n  user = User.find_by id: id\n%&gt;\n  &lt;% if user %&gt;\n  * user &lt;%= user.email %&gt;\n  &lt;% else %&gt;\n  * user can not be found\n  &lt;% end %&gt;\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<p>You can also set some new sections with <a href=\"https://github.com/smartinez87/exception_notification#sections\">custom\nsections</a>. You\ncan set sections in manual notification or inside settings-&gt;email.  You need to\nwrite text partial (html is not supported) in which you can access to\n<code class=\"highlighter-rouge\">@data</code>,<code class=\"highlighter-rouge\">@request</code>… variables, which you can list with <code class=\"highlighter-rouge\">&lt;%= instance_variables\n%&gt;</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/exception_notifier/_message.text.erb\nJavascript error params\n&lt;%=raw @data[:params].inspect %&gt;\n&lt;br&gt;\nHTTP_USER_AGENT=&lt;%= @request.env[\"HTTP_USER_AGENT\"] %&gt;\n&lt;br&gt;\nHTTP_ACCEPT=&lt;%= @request.env[\"HTTP_ACCEPT\"] %&gt;\n&lt;br&gt;\nREMOTE_ADDR=&lt;%= @request.env[\"REMOTE_ADDR\"] %&gt;\nsession\n</code></pre></div></div>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/views/exception_notifier/_delayed_job.text.erb\nJOB\n&lt;%= instance_variable_get(:@job).inspect %&gt;\n</code></pre></div></div>\n\n<h1 id=\"render-custom-error-pages\">Render custom error pages</h1>\n\n<p>If you want to render error-page and page-not-found with rails you can rescue\nfrom all StandardError exceptions.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\" data-lang=\"ruby\"><span class=\"c1\"># app/controllers/application_controller.rb</span>\n  <span class=\"k\">if</span> <span class=\"no\">Rails</span><span class=\"p\">.</span><span class=\"nf\">application</span><span class=\"p\">.</span><span class=\"nf\">secrets</span><span class=\"p\">.</span><span class=\"nf\">exception_recipients</span><span class=\"p\">.</span><span class=\"nf\">present?</span>\n    <span class=\"n\">rescue_from</span> <span class=\"no\">StandardError</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">exception</span><span class=\"o\">|</span>\n      <span class=\"k\">case</span> <span class=\"n\">exception</span><span class=\"p\">.</span><span class=\"nf\">class</span>\n      <span class=\"k\">when</span> <span class=\"no\">ActiveRecord</span><span class=\"o\">::</span><span class=\"no\">RecordNotFound</span><span class=\"p\">,</span>\n          <span class=\"no\">ActionController</span><span class=\"o\">::</span><span class=\"no\">RoutingError</span><span class=\"p\">,</span>\n          <span class=\"no\">ActionController</span><span class=\"o\">::</span><span class=\"no\">UnknownController</span><span class=\"p\">,</span>\n          <span class=\"no\">ActionController</span><span class=\"o\">::</span><span class=\"no\">MethodNotAllowed</span>\n        <span class=\"n\">redirection_path</span> <span class=\"o\">=</span> <span class=\"n\">page_not_found_path</span>\n      <span class=\"k\">when</span> <span class=\"no\">ActionController</span><span class=\"o\">::</span><span class=\"no\">InvalidAuthenticityToken</span>\n        <span class=\"n\">redirection_path</span> <span class=\"o\">=</span> <span class=\"n\">new_user_session_path</span>\n      <span class=\"k\">else</span>\n        <span class=\"n\">redirection_path</span> <span class=\"o\">=</span> <span class=\"n\">error_page_path</span>\n      <span class=\"k\">end</span>\n      <span class=\"no\">ExceptionNotifier</span><span class=\"p\">.</span><span class=\"nf\">notify_exception</span><span class=\"p\">(</span><span class=\"n\">exception</span><span class=\"p\">,</span>\n                                         <span class=\"ss\">env: </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"nf\">env</span><span class=\"p\">,</span>\n                                         <span class=\"ss\">data: </span><span class=\"p\">{</span> <span class=\"ss\">current_user: </span><span class=\"n\">current_user</span> <span class=\"p\">}</span>\n                                        <span class=\"p\">)</span>\n      <span class=\"no\">Rails</span><span class=\"p\">.</span><span class=\"nf\">logger</span><span class=\"p\">.</span><span class=\"nf\">error</span> <span class=\"n\">exception</span><span class=\"p\">.</span><span class=\"nf\">backtrace</span><span class=\"p\">.</span><span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n      <span class=\"no\">Rails</span><span class=\"p\">.</span><span class=\"nf\">logger</span><span class=\"p\">.</span><span class=\"nf\">error</span> <span class=\"n\">exception</span><span class=\"p\">.</span><span class=\"nf\">message</span>\n      <span class=\"n\">flash</span><span class=\"p\">[</span><span class=\"ss\">:alert</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">exception</span><span class=\"p\">.</span><span class=\"nf\">message</span> <span class=\"k\">if</span> <span class=\"n\">exception</span><span class=\"p\">.</span><span class=\"nf\">message</span><span class=\"p\">.</span><span class=\"nf\">present?</span>\n      <span class=\"n\">respond_to</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"nb\">format</span><span class=\"o\">|</span>\n        <span class=\"nb\">format</span><span class=\"p\">.</span><span class=\"nf\">html</span> <span class=\"p\">{</span> <span class=\"n\">redirect_to</span> <span class=\"n\">redirection_path</span> <span class=\"p\">}</span>\n        <span class=\"nb\">format</span><span class=\"p\">.</span><span class=\"nf\">js</span> <span class=\"k\">do</span>\n          <span class=\"n\">render</span> <span class=\"ss\">text: </span><span class=\"s2\">\"window.location.assign('</span><span class=\"si\">#{</span><span class=\"n\">redirection_path</span><span class=\"si\">}</span><span class=\"s2\">');\"</span>\n        <span class=\"k\">end</span>\n        <span class=\"nb\">format</span><span class=\"p\">.</span><span class=\"nf\">json</span> <span class=\"p\">{</span> <span class=\"n\">render</span> <span class=\"ss\">nothing: </span><span class=\"kp\">true</span> <span class=\"p\">}</span>\n        <span class=\"nb\">format</span><span class=\"p\">.</span><span class=\"nf\">text</span> <span class=\"p\">{</span> <span class=\"n\">render</span> <span class=\"ss\">nothing: </span><span class=\"kp\">true</span> <span class=\"p\">}</span>\n        <span class=\"nb\">format</span><span class=\"p\">.</span><span class=\"nf\">csv</span> <span class=\"p\">{</span> <span class=\"n\">render</span> <span class=\"ss\">nothing: </span><span class=\"kp\">true</span> <span class=\"p\">}</span>\n      <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span></code></pre></figure>\n\n<p>And you should create routes for those <em>page_not_found_path</em> and\n<em>error_page_path</em> and nice templates as well.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\" data-lang=\"ruby\"><span class=\"c1\"># config/routes.rb</span>\n<span class=\"n\">get</span> <span class=\"s1\">'error-page'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages'</span>\n<span class=\"n\">get</span> <span class=\"s1\">'page-not-found'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages'</span>\n<span class=\"n\">get</span> <span class=\"s1\">'javascript-required-page'</span><span class=\"p\">,</span> <span class=\"ss\">to: </span><span class=\"s1\">'pages#javascript_required_page'</span><span class=\"p\">,</span> <span class=\"ss\">as: :javascript_required_page</span></code></pre></figure>\n\n<p>Javascript required page is not needed since all browser use javascript\nnowadays. But if you really want to show that notification use this in layout\nfile, for pages after user logs in (and search bots does not).</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-ruby\" data-lang=\"ruby\"><span class=\"c1\"># app/views/layout/application.html.erb</span>\n<span class=\"o\">&lt;</span><span class=\"sx\">% if </span><span class=\"n\">params</span><span class=\"p\">[</span><span class=\"ss\">:controller</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s2\">\"requests\"</span> <span class=\"o\">||</span> <span class=\"n\">params</span><span class=\"p\">[</span><span class=\"ss\">:controller</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s2\">\"contacts\"</span> <span class=\"o\">%&gt;</span>\n  <span class=\"o\">&lt;</span><span class=\"n\">noscript</span><span class=\"o\">&gt;</span>\n    <span class=\"o\">&lt;</span><span class=\"n\">meta</span> <span class=\"n\">http</span><span class=\"o\">-</span><span class=\"n\">equiv</span><span class=\"o\">=</span><span class=\"s2\">\"refresh\"</span> <span class=\"n\">content</span><span class=\"o\">=</span><span class=\"s2\">\"2;url=/javascript-required-page\"</span><span class=\"o\">&gt;</span>\n  <span class=\"o\">&lt;</span><span class=\"sr\">/noscript&gt;\n&lt;% end %&gt;</span></code></pre></figure>\n\n<h1 id=\"resque\">Resque</h1>\n\n<p>Notifications in resque could be generated with</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails g exception_notification:install --resque\n</code></pre></div></div>\n\n<p>or better is to insert on existing config:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/exception_notification.rb\nrequire 'resque/failure/multiple'\nrequire 'resque/failure/redis'\nrequire 'exception_notification/resque'\n\nResque::Failure::Multiple.classes = [\n  Resque::Failure::Redis, ExceptionNotification::Resque\n]\nResque::Failure.backend = Resque::Failure::Multiple\n</code></pre></div></div>\n\n<p>Note that you need to <code class=\"highlighter-rouge\">export EXCEPTION_RECIPIENTS=asd@asd.asd</code> in shell where\nyou run <code class=\"highlighter-rouge\">QUEUE=* rake resque:work</code> for example:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>EXCEPTION_RECIPIENTS=asd@asd.asd QUEUE=* rake resque:work\n</code></pre></div></div>\n\n<p>Note that this notifications will be triggered for jobs that are inserted using\n<a href=\"/2016/08/26/background-jobs-and-queues/#resque-scheduler-for-recurring-tasks\">resque-scheduler-for-reurring-tasks</a></p>\n\n<h1 id=\"rake\">Rake</h1>\n\n<p>When you are using heroku scheduler to run rake tasks, you can add notification\nthere also.\nTo see output/log of some rake task, you should use <code class=\"highlighter-rouge\">heroku run:detached rake\nroutes</code> instead of <code class=\"highlighter-rouge\">heroku run rake routes</code>\n<a href=\"https://devcenter.heroku.com/articles/one-off-dynos#running-tasks-in-background\">devcenter.heroku</a>.</p>\n\n<p>Exception notifications can be used there also with this\n<a href=\"https://github.com/nikhaldi/exception_notification-rake\">exception_notification-rake</a>\nbut it does not work for rails 5, so better is to manually patch <code class=\"highlighter-rouge\">Rake::Task</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; config/initializers/task.rb &lt;&lt; HERE_DOC\n# http://stackoverflow.com/questions/7161374/rails-exception-notifier-in-rake-tasks\nrequire 'rake/task'\n# rubocop:disable Lint/RescueException\nmodule Rake\n  class Task\n    alias orig_execute execute\n    def execute(args = nil)\n      orig_execute(args)\n    rescue Exception =&gt; exception\n      ExceptionNotifier.notify_exception(exception)\n    end\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<p>You can test with this failing test</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; lib/tasks/my_task.rake &lt;&lt; HERE_DOC\nnamespace :my_task do\n  desc \"my task\"\n  task :run =&gt; :environment do\n    raise \"this is my exception\"\n  end\nend\nHERE_DOC\n</code></pre></div></div>\n\n<p>and run with <code class=\"highlighter-rouge\">EXCEPTION_RECIPIENTS=asd@asd.asd rake my_task:run</code> and you should\nsee the email.</p>\n\n<p>To test in minitest or rspec you can use\nhttps://stackoverflow.com/questions/34862667/test-exceptionnotification-middleware-in-rails-unit-test\nhttps://agileleague.com/blog/rails-3-2-custom-error-pages-the-exceptions_app-and-testing-with-capybara/\nI prefer to test only routing to /404 /422 /500\nNote that you should <code class=\"highlighter-rouge\">js: true</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>config.consider_all_requests_local = false\nconfig.action_dispatch.show_exceptions = true\n</code></pre></div></div>\n\n<p>Usually you need to export <code class=\"highlighter-rouge\">export EXCEPTION_RECIPIENTS=asd@asd.asd</code> in the same\nprocess where it is run (<code class=\"highlighter-rouge\">rails s</code> for immediate exceptions, <code class=\"highlighter-rouge\">rake resque:work</code>\nfor exceptions in background jobs, <code class=\"highlighter-rouge\">rake resque:scheduler</code> usually do not raise\nexception, it justs enque jobs, <code class=\"highlighter-rouge\">rake my_task:run</code> for manual invoke rake\ntasks).</p>\n\n<h1 id=\"deliver-later\">Deliver later</h1>\n\n<p>If you use ActiveJob than you can try to deliver later but there are some issues\n<a href=\"https://github.com/smartinez87/exception_notification/issues/319\">https://github.com/smartinez87/exception_notification/issues/319</a></p>\n\n<p>I receive error <code class=\"highlighter-rouge\">An error occurred when sending a notification using 'email'\nnotifier. ActiveJob::SerializationError: Unsupported argument type: IO</code></p>\n"
    } ,
  
    {
      "title"    : "Ruby on rails and Ajax javascript",
      "category" : "",
      "tags"     : "javascript, ruby_on_rails, ajax",
      "url"      : "/2014/09/02/ruby-on-rails-with-ajax-javascript/",
      "date"     : "2014-09-02 00:00:00 +0200",
      "content"  : "<p>Do you like one page application ? Do you like Rails ? Here is their child…</p>\n\n<h2 id=\"ajax-with-rails\">Ajax with Rails</h2>\n\n<p><a href=\"http://edgeguides.rubyonrails.org/working_with_javascript_in_rails.html\">Rails and\njavascript</a>\ncan live together but some rules has to be established so you know what is going\non. Anytime you can put <code class=\"highlighter-rouge\">debugger;</code> anywhere in javascript code and it should\nstop if you have enabled some of js tools in your browser.</p>\n\n<p><code class=\"highlighter-rouge\">data-remote</code> ajax calls are enabled with\n<a href=\"https://github.com/rails/jquery-ujs/wiki\">jquery_ujs</a>.</p>\n\n<p>There are two approaches when dealing with ajax calls: server responds with\nfinal templates and javascript, or server responds with json so client side\njavascript is responsible for rendering.</p>\n\n<p>For CRUD actions, ajax usually simulate get actions for links (new, show, edit),\npost actions for forms (create, update) and some patch actions for changing the\nstate of item (destroy, activate, pause …).</p>\n\n<p>For example:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># edit.js.erb\n$('#question-&lt;%= @question.id %&gt;').replaceWith(\" &lt;%= j render partial: 'questions/edit_question', { question: @question } %&gt;\");\n</code></pre></div></div>\n\n<p>and</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># update.js.erb\n$('#question-&lt;%= @question.id %&gt;').replaceWith(\" &lt;%= j render partial: 'questions/show_question', { question: @question } %&gt;\");\n</code></pre></div></div>\n\n<p>Do we need for each CRUD action to write this respond.js? No, we can simplify\nthis by rendering respond.html templates and replacing content in javascript. If\nyou need different rendering in index than it is in show action (for example\nshow action has some new buttons etc), than you need to treat them separately,\none partial for index and one template for show.</p>\n\n<p>All data-attributes names should be lower case.</p>\n\n<p>For ajax requests, if there are no coresponding respond.js, rails will fall back\nfor rendering respond.html. We just need to stop layout rendering in this case\nwith this line in controller:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/controllers/surveys_controller.rb\nlayout Proc.new { |controller| false if controller.request.xhr? }\n</code></pre></div></div>\n\n<p>Using this unobtrusive ajax, we do not need ID’s for each element since we know\nwhat is <code class=\"highlighter-rouge\">e.target</code> element so we can use\n<code class=\"highlighter-rouge\">$(e.target).closest('p').replaceWith($new_elem);</code>.</p>\n\n<p>For errors on form validations we could respond with json and some non\nsuccessfully error code, for example <code class=\"highlighter-rouge\">format.js { render json: @question.errors,\nstatus: :unprocessable_entity }</code>, but this is approach is more angular oriented.</p>\n\n<h2 id=\"event-listeners-for-new-elements\">Event listeners for new elements</h2>\n\n<p>If you use javascript code like <code class=\"highlighter-rouge\">$('a[data-activate]').click(...</code> it will not\nbind to new elements created by ajax. Instead you should bind to body or another\nelement that stays on page and and use delegation:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$('body').on('click', 'a[data-activate]', function() {});` \n</code></pre></div></div>\n\n<p>If you  bind on <code class=\"highlighter-rouge\">document</code> element make sure it is called only once, because of\nturbolinks if you navigate 3 times to that page where you are calling the\nscript, you will have 3 event listeners.</p>\n\n<p>If you need something like datepicker you can bind on focus\n<a href=\"http://stackoverflow.com/questions/10433154/putting-datepicker-on-dynamically-created-elements-jquery-jqueryui\">link</a></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$('body').on('focus',\".datepicker_recurring_start\", function(){\n  $(this).datepicker();\n});\n</code></pre></div></div>\n\n<p>Order of binded events on the same element is by definition order. If you want\nto execute on click event <strong>before</strong> other is target that is closer, for example\ninsted of <code class=\"highlighter-rouge\">$(document).on('click','[data-1]',</code> use\n<code class=\"highlighter-rouge\">$('body').on('click','[data-1]',</code>. If you want to execute <strong>after</strong> events that\nare binded to <code class=\"highlighter-rouge\">$(document).on('click'</code> than you should wrapp all that in one\nfunction and call the code with prefered order.</p>\n\n<h2 id=\"disable-with-adding\">Disable with “Adding…”</h2>\n\n<p>When you work with ajax it is advisable to use rails ujs <code class=\"highlighter-rouge\">data: { disable_with:\n\"Adding...\" }</code> because user can click several times on a link before server\nresponds. This is very important for all buttons/links that are not idempotent\nactions (idempotent actions are ones that you can apply them as many times as\nyou want without worries, for example abs(abs(abs(x))) ).</p>\n\n<p>When you are using</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%= link_to path, data: { disable_with: \"Saving\"} do %&gt;\n  &lt;div&gt;..&lt;/div&gt;\n&lt;% end %&gt;\n</code></pre></div></div>\n\n<p>this will not work because whole <code class=\"highlighter-rouge\">&lt;div&gt;..&lt;/div&gt;</code> will\nbe replaced with <code class=\"highlighter-rouge\">Saving</code> (without div’s). It is better to use <code class=\"highlighter-rouge\">disable_with:\n\"&lt;div&gt;Saving&lt;span class='loading-icon'&gt;&lt;/span&gt;&lt;/div&gt;\".html_safe</code>.</p>\n\n<h2 id=\"show-ajax-errors\">Show ajax errors</h2>\n\n<p>In case of network failure or other errors, ajax links (with <code class=\"highlighter-rouge\">[data-remote]</code>) do\nnot inform the user. So it is advisable to attach event listener in case of\nerrors (this is not error in form validations or some other response from\nserver, it is a real error usually timeout because server did not respond).</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// error handling just for debugging\n$(document).on('ajax:error', '[data-remote]', function(e, xhr, status, error) {\n  $('#flash-messages').append('Server responds with ' + status + ' ' + error);\n  LOG &amp;&amp; console.log(\"ajax:error [data-remote] \" + status+' '+error );\n});\n</code></pre></div></div>\n\n<h2 id=\"flash-messages\">Flash messages</h2>\n\n<p>In case of some form validations error or some successul action we can send\nflash message to the user. In rails it is just flash[:notice]=”Message text”,\nbut if we use ajax calls, we should discard flash object otherwise it will show\nup on next page reload\n<a href=\"http://stackoverflow.com/questions/21032465/rails-doesnt-display-flash-messages-after-ajax-call\">link</a>.\nWith ajax server can send error and notice message with X-Message-Flash.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>class ApplicationController &lt; ActionController::Base\n  \n  after_filter :flash_to_headers                                       \n  \n  def flash_to_headers                                                 \n    # http://stackoverflow.com/questions/21032465/rails-doesnt-display-flash-messages-after-ajax-call\n    return unless request.xhr?\n    # in ajax requests we return flash as X message                    \n    response.headers['X-Message-Flash'] = flash.to_json unless flash.empty? \n    # discard flash object otherwise it will show up on next page load \n    flash.discard \n  end                                                                  \nend \n</code></pre></div></div>\n\n<p>This approach should be coupled with writing respond.js block that do not\nredirect for example for update/create action <code class=\"highlighter-rouge\">format.js { render :show, status:\n:ok, location: @survey, content_type: Mime::HTML }</code> so we have those messages in\njavascript. Another solution is not to discard flash and use native redirection\n(the same as for format.html) ie not writing forman.js as use default\nformat.html responses. There is also <code class=\"highlighter-rouge\">flash.now[:notice] = msg</code> if you want to\ncustomize it further, probably on change (PUT, PATCH) requests, but think it\ntwice, because but not on form submit because forms are wrapped with classes\nerrors, and usually on some index pages (where we change some of the object\nproperty and wants to stay on the same page).</p>\n\n<ul>\n  <li>GET INDEX, GET SHOW(:id), GET NEW, GET EDIT(:id), not flash messages, response is template so ajax is ok (format.js == format.html)</li>\n  <li>POST CREATE, usually flash message, respond is redirect and in ajax is ok, second request is GET(:id) (format.js == format.html)</li>\n  <li>PATCH/PUT UPDATE(:id), usually flash message, respond is redirect and in ajax is ok, second request is GET(:id) (format.js == format.html)</li>\n  <li>DELETE DELETE(:id), usually flash message, respond is redirect but in ajax is not fine, second request is stil DELETE in chrome so use <code class=\"highlighter-rouge\">format.js { render nothing: true }</code></li>\n</ul>\n\n<p>To summarize differences between using rails native format.js files and thiw rails unobtrusive ajax:</p>\n<ul>\n  <li>pros: unobtrusive ajax approach knows which link is clicked so it do not require specifix id (but it requres parameter which closest element should be replaced). This is specifically important when we generate forms for new objects (new records does not have id). You do not need to generate some random id-s to target that forms so they could be replaced with show partials.</li>\n</ul>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// Used to add class 'active' to selector\n// example &lt;button data-activate=\".popup\"&gt;&lt;/button&gt;\n$(document).on('click','[data-activate]', function(e) {\n  $( $(this).data('activate')).addClass('active');\n  e.preventDefault();\n  LOG &amp;&amp; console.log(\"click a[data-activate]=\"+$(this).data('activate'));\n});\n// this could be toogle but it is clearer to use activate deactivate\n// Used to remove class 'active' to selector\n// example &lt;button data-deactivate=\".popup\"&gt;&lt;/button&gt;\n$(document).on('click','[data-deactivate]', function(e) {\n  $( $(this).data('deactivate')).removeClass('active');\n  if ( $(this).data('prevent-default') != false)\n    e.preventDefault();\n  LOG &amp;&amp; console.log(\"click a[data-deactivate]=\"+$(this).data('deactivate'));\n});\n</code></pre></div></div>\n\n<p>pros/cons: if there is an error respond.js you will not notice that in console, but in this approach, it will be shown as console error</p>\n\n<p>Custom js functions like select2 or autosize should be defined next to target elements. for example</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>   &lt;%= f.textarea :content %&gt;\n   &lt;% controller.js_functions &lt;&lt; { 'textarea' =&gt; 'autosize' } %&gt;\n</code></pre></div></div>\n\n<p>That way it is much clearer. when you load the partial you do not need to worry what it needs to call (like in .js files), scope is much narrower (you will not change all the textarea, because this function is called on children(‘textarea’) of this partial).</p>\n\n<p>When you are rendering back the form that has some _destoyed submodels, you should not display tham again:</p>\n\n<p>Adding new elements can be done in javascript (without server active) but then the user has to confirm that, ie submit the form.\nYou can add remove new elements with ajax, so there is no need for submitting.</p>\n\n<p>We used both forms.</p>\n\n"
    } ,
  
    {
      "title"    : "RoR polymorphic or sti",
      "category" : "",
      "tags"     : "",
      "url"      : "/2014/07/03/ruby-on-rails-polymorphic-or-sti/",
      "date"     : "2014-07-03 00:00:00 +0200",
      "content"  : "<h1 id=\"polymorphic\">Polymorphic</h1>\n\n<p><a href=\"http://guides.rubyonrails.org/association_basics.html#polymorphic-associations\">Polymorphic</a>\nassociations are used to add refence to something that is shared in different\nmodels, for example locations and banners has many clicks so clicks belongs to\nboth locations and banners, so let’s call them <code class=\"highlighter-rouge\">clickable</code>.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># db/migrate/123_add_polymorphic.rb\n  def change\n    add_reference :clicks, :clickable, polymorphic: true, index: true\n  end\n\n# app/models/click.rb\nclass Click &lt; ActiveRecord::Base\n  belongs_to :clickable, polymorphic: true\nend\n\n# app/models/location.rb\nclass Location &lt; ActiveRecord::Base\n  has_many :clicks, as: :clickable\n  validates_presence_of :name, :link_url\nend\n\n# app/models/banner.rb\nclass Banner &lt; ActiveRecord::Base\n  has_many :clicks, as: :clickable\n  validates_presence_of :name, :link_url\nend\n</code></pre></div></div>\n\n<p>Usage is the same as it is for regular one-to-many relations.</p>\n\n<h1 id=\"single-table-inheritance\">Single table inheritance</h1>\n\n<p><a href=\"http://eewang.github.io/blog/2013/03/12/how-and-when-to-use-single-table-inheritance-in-rails/\">STI</a>\nhttp://enterpriserails.chak.org/full-text/chapter-10-multiple-table-inheritance\nhttp://thibaultdenizet.com/tutorial/single-table-inheritance-with-rails-4-part-1/\nhttps://www.youtube.com/watch?v=t8I4_8HcMPo</p>\n\n<p>STI maps all fields into a single table\nhttp://martinfowler.com/eaaCatalog/classTableInheritance.html CTI maps each\nclass\ninto its own table http://martinfowler.com/eaaCatalog/classTableInheritance.html</p>\n"
    } ,
  
    {
      "title"    : "Ruby on Rails Layouts and rendering",
      "category" : "",
      "tags"     : "layout, render, ruby-on-rails",
      "url"      : "/2014/07/01/ruby-on-rails-layouts-and-rendering/",
      "date"     : "2014-07-01 00:00:00 +0200",
      "content"  : "<h1 id=\"short-reminder-how-rails-use-rendering\">Short reminder how rails use rendering</h1>\n\n<p><a href=\"http://guides.rubyonrails.org/layouts_and_rendering.html\">Guide</a> says that response from the server can be: render, redirect, or just head. <code class=\"highlighter-rouge\">ActionController::Base#render</code> designedly use convention over configuration, that means if we request <em>products#show as HTML</em> it will render <em>app/view/products/show.html.erb</em> template (if there has not been a call to render something else). <code class=\"highlighter-rouge\">ActionController::Base#render</code> method can set up <strong>template</strong> and <strong>partial</strong> to be rendered as <strong>text, json, xml, js</strong> (that is content-type) and set the <strong>response code</strong> (:status =&gt; :ok).</p>\n\n<p>For example <code class=\"highlighter-rouge\">render \"edit\" #or :edit</code>  will change default rendering from <em>show.html.erb</em> to <em>edit.html.erb</em> (in the same controller). We we can render template from another controller, for example <em>carts</em> controller with command <code class=\"highlighter-rouge\">render \"carts/edit\"</code>. It should be explicited with parameter <code class=\"highlighter-rouge\">render template: \"edit\"</code>so we know what is going on (it will render edit template not partial). Another examples of <em>ActionController::Base#render</em>:\n<code class=\"highlighter-rouge\">render text: 'OK'</code> is replaced with <code class=\"highlighter-rouge\">render plain: 'OK'</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>render plain: 'OK'\nrender html: \"&lt;strong&gt;OK&lt;/strong&gt;\".html_safe \nrender xml: @product # automatically calls .to_xml\nrender json: @product # no need for .to_json\nrender js: \"alert('OK');\" # will set content-type MIME text/javascript\n# multiline respond in javascript with ruby code (espaced with j so we can see '\nrender js: %(\n  flash_notice('#{view_context.j I18n.t('successfully_updated')}');\n  window.location.assign('&lt;%= isp_billing_profiles_path %&gt;');\n)\n\n# you can use `head status`\nhead :created, location: photo_path(@photo)\n# this is better than\nformat.js { render nothing: true }\n</code></pre></div></div>\n\n<p>Four options for <em>render</em> are:</p>\n\n<ol>\n  <li><code class=\"highlighter-rouge\">:content_type =&gt; \"text/html\"</code> (or “application/json” or “application/xml” or “application/rss”) this sets MIME content-type</li>\n  <li><code class=\"highlighter-rouge\">:layout =&gt; 'special_layout'</code> (or false) can be set to whole controller. Convention is to look first for the same name as controller</li>\n  <li><code class=\"highlighter-rouge\">:location =&gt; photo_url(@photo)</code> sets HTTP location header</li>\n  <li><code class=\"highlighter-rouge\">:status =&gt; :ok</code> is 200,\n<a href=\"http://guides.rubyonrails.org/layouts_and_rendering.html#the-status-option\">:unprocessable_entity</a>\nis 422</li>\n</ol>\n\n<p>Redirect example is <code class=\"highlighter-rouge\">redirect_to :back</code>.</p>\n\n<p>In Ruby on Rails there are 6 asset tag helpers:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%= auto_discovery_link_tag(:rss, {action: \"feed\"}, {title: \"RSS Feed\"}) %&gt;\n&lt;%= javascript_include_tag \"main\", \"/photos/columns\" %&gt;\n&lt;%= stylesheet_link_tag \"main\", \"photos/columns\" %&gt;\n&lt;%= image_tag \"icons/delete.gif\" %&gt;\n&lt;%= video_tag \"movie.ogg\" %&gt;\n&lt;%= audio_tag \"music/first_song.mp3\" %&gt;\n</code></pre></div></div>\n\n<h1 id=\"asset-pipeline\">Asset pipeline</h1>\n\n<p>All asset files should be inside of <code class=\"highlighter-rouge\">app/assets</code>, <code class=\"highlighter-rouge\">lib/assets</code> or\n<code class=\"highlighter-rouge\">vendor/assets</code> and they are served with\n<a href=\"https://github.com/rails/sprockets\">sprockets</a> hereof three features:\nfingerprint, minification and precompilation of sass and coffeescript. That\nfeatures are not used in development mode, but you can see it when you run in\nproduction environment.</p>\n\n<p><a href=\"http://guides.rubyonrails.org/asset_pipeline.html\">Rails Asset Pipeline</a> hides\n(ignores) the first subfolder, for example <em>app/assets/javascrips/posts.js</em> will\nbe overwritten by <em>app/assets/custom/posts.js</em> and served as <em>assets/posts.js</em>\nin development or included in <em>application-123.js</em> in production.\nIt is important to remember that is <code class=\"highlighter-rouge\">another-folder/application.js</code> uses\n<code class=\"highlighter-rouge\">require main.js</code> that <code class=\"highlighter-rouge\">main.js</code> file could be picked from wrong location (all\nasset paths are searched. If you want to add some path</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/initializers/assets.rb\nRails.application.config.assets.paths &lt;&lt; Rails.root.join('app', 'assets', 'adminlte', 'images')\n</code></pre></div></div>\n\n<p>All files  should be referenced to assets pipeline by <code class=\"highlighter-rouge\">//= require posts</code> or\n<code class=\"highlighter-rouge\">//= require tree .</code> (if it was not referenced, it could be accessible, but only\nin development mode). If we want to include whole library (with special index\nfile for example <em>lib/assets/library_name/index.js</em>) we require just folder name\n<code class=\"highlighter-rouge\">//= require library_name</code>.</p>\n\n<p>If we want to use controller specific assets (that is loaded only when that\ncontroller responds) we should not use <code class=\"highlighter-rouge\">*= require tree .</code> in\n<em>app/assets/stylesheets/application.css</em> or\n<em>app/assets/javascripts/application.js</em> . Since we are including another js or\ncss asset (that is not included in application.js/css) we have to add it to\nassets pipeline, for example in <em>config/initializers/assets.rb</em></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Rails.application.config.assets.precompile += %w( posts.js )\nRails.application.config.assets.precompile += %w( posts.css )\n</code></pre></div></div>\n\n<p>and include them in a view or layout file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%= javascript_include_tag params[:controller] %&gt;\n&lt;%= stylesheet_link_tag params[:controller] %&gt;\n</code></pre></div></div>\n\n<p>Note that is <code class=\"highlighter-rouge\">posts.js</code> is inside another folder, for example\n<code class=\"highlighter-rouge\">app/assets/landing/posts,js</code> than you need to add that folder to asset paths\n<code class=\"highlighter-rouge\">Rails.application.config.assets.paths &lt;&lt; Rails.root.join('app', 'assets',\n'landing')</code>. If not found, it will be ignored and not precompiled.</p>\n\n<p>All non js or css files are included automatically (images, text, pdf) along\nwith applications.js and application.css by the default matcher for compiling:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[ Proc.new { |path, fn| fn =~ /app\\/assets/ &amp;&amp; !%w(.js .css).include?(File.extname(path)) }, /application.(css|js)$/ ]\n</code></pre></div></div>\n\n<p>If you use canonical host you need to disable it <code class=\"highlighter-rouge\">export\nDO_NOT_USE_CANONICAL_HOST=true</code> and remove eventual\n<code class=\"highlighter-rouge\">config.action_controller.asset_host = asdasd</code></p>\n\n<h1 id=\"compile-in-production-mode-and-heroku\">Compile in production mode and Heroku</h1>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RAILS_ENV=production rake db:create\nRAILS_ENV=production rake assets:precompile\n\nexport RAILS_SERVE_STATIC_FILES=true\nrails s -b 0.0.0.0 -e production\n</code></pre></div></div>\n\n<p><a href=\"https://devcenter.heroku.com/articles/rails-4-asset-pipeline#known-issues\">One\nissue</a>\nwith assets precompile is when you use erb in coffee and + secret. If\nyou change secrets without touching javascript files, something old from tmp\ncache will be used. So always change js files when you change secrets, for\nexample <code class=\"highlighter-rouge\">echo \" \" &gt;&gt; app/assets/javascripts/a.coffee</code>.\nSimilar dependcies could be for stylesheets scss + other asset, and you can use\n<code class=\"highlighter-rouge\">depend_on_asset</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># config/secrets.yml\na: &lt;%= ENV[\"A\"] || 'a' %&gt;\n\n# app/assets/javascript/a.coffee\na = '&lt;%= Rails.application.secrets.a %&gt;'\n\n# app/assets/stylesheets/common.scss\n.logo {\n  background-image:url('&lt;%= asset_path(\"logo.png\") %&gt; ');\n}\n\nrake assets:precompile\nexport A=b\nmv logo2.png app/assets/images/logo.png\nrake assets:precompile\ncat public/assets/*\n</code></pre></div></div>\n\n<p>For Heroku you can check assets</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku run bash\nls public/assets\n</code></pre></div></div>\n\n<p>in console you can see exact file name that rails believes it should serve</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku run rails console\nputs helper.asset_path(\"application.js\")\n</code></pre></div></div>\n\n<p>Sometimes on heroku still need to purge 50MB tmp cache</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku plugins:install heroku-repo\nheroku repo:purge_cache\n</code></pre></div></div>\n\n<h1 id=\"scss\">Scss</h1>\n\n<p>Sass is similar to scss just without brackets and with indent. I think scss is\nbetter since any css code is also scss code.</p>\n\n<p>You can use asset path helpers in scss, instead of erb style <code class=\"highlighter-rouge\">background-image:\nurl(&lt;%= asset_url 'logo.png' %&gt;)</code> you can use <code class=\"highlighter-rouge\">asset-url</code> (which replace <code class=\"highlighter-rouge\">&lt;%=%&gt;</code>\nand <code class=\"highlighter-rouge\">url()</code> and file name should be inside quotes like <code class=\"highlighter-rouge\">asset-url('logo.png')</code>.\nRemember that it was underscored in erb, use hyphenated in sass\n<code class=\"highlighter-rouge\">background-image: asset-url(\"logo.png\")</code>. You can not use normal\n<code class=\"highlighter-rouge\">url(\"logo.png\")</code>. Note that asset path <code class=\"highlighter-rouge\">asset-path</code> does not work, you need to\nuse assets url.</p>\n\n<p>Note that for coffeescript you need to add extension <code class=\"highlighter-rouge\">customers.coffee.erb</code> and\nuse this initialization file</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>config/initializers/sprockets.rb\nRails.application.config.assets.configure do |env|\n  env.context_class.class_eval do\n    # include MyAppHelper\n    include Rails.application.routes.url_helpers\n  end\nend\n</code></pre></div></div>\n\n<p>Note that if you are using sass-rails than you should use <code class=\"highlighter-rouge\">@import\n\"filename_without_extension\";</code> instead of <code class=\"highlighter-rouge\">require</code>. That way you can access\nglobal namespace and you can use variables. Do not link filename with extension\nsince than it will use plain css <a href=\"https://developer.mozilla.org/en/docs/Web/CSS/@import\">import\nrule</a> instead of scss\ninserting content.</p>\n\n<p><code class=\"highlighter-rouge\">@import</code> knows current folder so you can write only relative path.</p>\n\n<p>Erb for assets could be used only for asset_data_uri (including data directly\ninto css). Remember that precompiling assets is done only once.</p>\n\n<p>You can set dependency between assets using\n<a href=\"https://github.com/sstephenson/sprockets#the-link-directive\">link</a> <code class=\"highlighter-rouge\">link_tree</code>\nand <code class=\"highlighter-rouge\">link_directory</code> directive.</p>\n\n<p>If you use <code class=\"highlighter-rouge\">require_tree</code> than you can set dependencies between files with\n<code class=\"highlighter-rouge\">require</code> so they are included before this file, for example</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code># app/assets/javascripts/plugins/jquery-validation/localication.init.js\n/*\n* default is english https://github.com/jquery-validation/jquery-validation/blob/dd187b016a1b4eef22ae93500eb37a44bf2ecd0d/src/core.js#L346\n*= require plugins/jquery-validation/localization.messages_sr.js\n*= require plugins/jquery-validation/localization.messages_ar.js\n*/\nvar lang = $('html').attr('lang');\nif (lang == 'sr')\n  setSerbian();\nelse if (lang == 'ar')\n  setArabic();\n</code></pre></div></div>\n\n<h1 id=\"less\">Less</h1>\n\n<p>You can use less and scss in same project but you can not use variables from one\nto another since they are not compatible.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/*\n *= require scss_wrapper\n *= require less_wrapper\n */\n</code></pre></div></div>\n\n<h1 id=\"npm\">NPM</h1>\n\n<p>Add npm to rails app that will install dependecies in <code class=\"highlighter-rouge\">/node_modules</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm init -y # to create package.json, -y to accept defaults\nnpm install jquery-ui-sortable-npm\n\ncat &gt;&gt; .gitignore &lt;&lt; HERE_DOC\n/node_modules\nHERE_DOC\ncat &gt;&gt; config/initializers/assets.rb &lt;&lt; HERE_DOC\nRails.application.config.assets.paths &lt;&lt; Rails.root.join('node_modules')\nRails.application.config.assets.precompile &lt;&lt; /\\.(?:svg|eot|woff|ttf)$/\nHERE_DOC\ngit add . &amp;&amp; git commit -m \"Adding npm\"\n</code></pre></div></div>\n\n<p>For Heroku you need to use two build packs. Follow this\n<a href=\"https://github.com/duleorlovic/heroku-rails-bower/commit/ba7c78a1f4f641cfe5592aa75b471aa142dc855a\">commit</a>.\nIt works for latest node and npm version. Older version could give errors:</p>\n\n<ul>\n  <li>bower version <code class=\"highlighter-rouge\">~1.2</code> gives me error <code class=\"highlighter-rouge\">error Path must be a string. Received\n ...</code> so make sure you use latest bower.</li>\n</ul>\n\n<p>Old approach with assets from gems still works, no worry.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>heroku create myapp-with-bower\nheroku addons:create heroku-postgresql:hobby-dev\nheroku buildpacks:set https://github.com/heroku/heroku-buildpack-ruby\nheroku buildpacks:add --index 1 https://github.com/heroku/heroku-buildpack-nodejs\nheroku buildpacks # should return  1.nodejs  2.ruby (latest will run process)\n# alternativelly, we can define then in file .buildpacks\n# echo 'https://github.com/heroku/heroku-buildpack-ruby\n# https://github.com/heroku/heroku-buildpack-nodejs ' &gt; .buildpacks\n# heroku config:add BUILDPACK_URL=https://github.com/ddollar/heroku-buildpack-multi.git\ngit push heroku master --set-upstream\n</code></pre></div></div>\n\n<p>More info on <a href=\"/2015/04/05/common-rails-bootstrap-snippets/#heroku-deploy\">heroku deploy</a></p>\n\n<h2 id=\"boostrap\">Boostrap</h2>\n\n<p>You can include bootstrap (which is now written in scss instead of less)</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn add bootstrap jquery popper.js\n\ncat &gt;&gt; app/assets/stylesheets/application.scss &lt;&lt; \\HERE_DOC\n\nHERE_DOC\n\nsed -i app/assets/javascripts/application.js -e '/require_tree/i\\\n//  from node_modules\\\n//= require jquery/dist/jquery.js\\\n//= require popper.js/dist/umd/popper.js\\\n//= require bootstrap/dist/js/bootstrap'\n\ngit commit -am \"Adding bootstrap\"\n</code></pre></div></div>\n\n<h2 id=\"adding-icons\">Adding icons</h2>\n\n<p>There is a problem when some image/font files are hardcoded in css files, or\nin case of scss, you can define a path, but not a fingerprint digest sha.\nOne solution is to deploy files without fingerprint, for example\n<a href=\"https://github.com/alexspeller/non-stupid-digest-assets\">non-stupid-digest-assets</a>\ngem you can add non digest version. First your assets should be seen\n(precompiled) with sprockets than they will be again copied without digest.</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cat &gt;&gt; Gemfile &lt;&lt; HERE_DOC\ngem \"non-stupid-digest-assets\"\nHERE_DOC\n\ncat &gt;&gt; config/initializers/assets.rb &lt;&lt; \\HERE_DOC\nRails.application.config.assets.precompile &lt;&lt; /\\.(?:svg|eot|woff|woff2|ttf)$/\n\nNonStupidDigestAssets.whitelist += [\n  /\\.(?:svg|eot|woff|woff2|ttf)$/\n]\nHERE_DOC\n</code></pre></div></div>\n\n<p>Another solution is to override <code class=\"highlighter-rouge\">@font-face</code> which includes proper <code class=\"highlighter-rouge\">asset-url</code></p>\n\n<p>Sprockets <code class=\"highlighter-rouge\">require</code> concatenates after sass compilation. So it’s advices to use\n<code class=\"highlighter-rouge\">@import</code> sass command instead of <code class=\"highlighter-rouge\">require</code>. <code class=\"highlighter-rouge\">@import</code> will work also in\n<code class=\"highlighter-rouge\">application.css</code> but variable definition won’t (like <code class=\"highlighter-rouge\">$var: 1;</code>), so we need\nto move <code class=\"highlighter-rouge\">css -&gt; scss</code>.</p>\n\n<h2 id=\"fontawesome\">Fontawesome</h2>\n\n<p>Here is example adding font awesome from npm https://www.npmjs.com/package/@fortawesome/fontawesome-free</p>\n\n<p>https://fontawesome.com/icons?d=gallery&amp;m=free</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>yarn add @fortawesome/fontawesome-free\n\ncat &gt;&gt; app/assets/stylesheets/application.scss &lt;&lt; \\HERE_DOC\n// node_modules\n@import '@fortawesome/fontawesome-free/css/all.css'\n// plugins\n@import 'plugins/font-awesome-font-face'\nHERE_DOC\n\n# copy @font-face definition from node_modules...all.css and replace url with asset-url\ncat &gt;&gt; app/assets/stylesheets/plugins/font-awersome-font-face.css' &lt;&lt; HERE_DOC\n@font-face {\n  font-family: 'Font Awesome 5 Brands';\n  font-style: normal;\n  font-weight: normal;\n  src: asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-brands-400.eot\");\n  src: asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-brands-400.eot?#iefix\") format(\"embedded-opentype\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-brands-400.woff2\") format(\"woff2\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-brands-400.woff\") format(\"woff\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-brands-400.ttf\") format(\"truetype\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-brands-400.svg#fontawesome\") format(\"svg\");\n}\n\n@font-face {\n  font-family: 'Font Awesome 5 Free';\n  font-style: normal;\n  font-weight: 400;\n  src: asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-regular-400.eot\");\n  src: asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-regular-400.eot?#iefix\") format(\"embedded-opentype\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-regular-400.woff2\") format(\"woff2\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-regular-400.woff\") format(\"woff\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-regular-400.ttf\") format(\"truetype\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-regular-400.svg#fontawesome\") format(\"svg\");\n}\n\n@font-face {\n  font-family: 'Font Awesome 5 Free';\n  font-style: normal;\n  font-weight: 900;\n  src: asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-solid-900.eot\");\n  src: asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-solid-900.eot?#iefix\") format(\"embedded-opentype\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-solid-900.woff2\") format(\"woff2\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-solid-900.woff\") format(\"woff\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-solid-900.ttf\") format(\"truetype\"), asset-url(\"@fortawesome/fontawesome-free/webfonts/fa-solid-900.svg#fontawesome\") format(\"svg\");\n}\nHERE_DOC\n</code></pre></div></div>\n\n<h2 id=\"simple-line-icons\">Simple line icons</h2>\n\n<p>If you need to include for example\n<a href=\"https://github.com/thesabbir/simple-line-icons\">simple-line-icons</a> than you\ncan place it inside <code class=\"highlighter-rouge\">app/assets/simple_line_icons</code> and you need to overwrite\nfont path, ie instead of <code class=\"highlighter-rouge\">url('../fonts/Simple-Line-Icons.eot?v=2.4.0')</code> use\n<code class=\"highlighter-rouge\">asset-url('fonts/Simple-Line-Icons.eot?v=2.4.0');</code></p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>// app/assets/stylesheets/pages.scss\n/*\n *= require css/simple-line-icons\n */\n@font-face {\n  font-family: 'simple-line-icons';\n  src: asset-url('fonts/Simple-Line-Icons.eot?v=2.4.0');\n  src: asset-url('fonts/Simple-Line-Icons.eot?v=2.4.0#iefix')\n  format('embedded-opentype'),\n  asset-url('fonts/Simple-Line-Icons.woff2?v=2.4.0') format('woff2'),\n  asset-url('fonts/Simple-Line-Icons.ttf?v=2.4.0') format('truetype'),\n  asset-url('fonts/Simple-Line-Icons.woff?v=2.4.0') format('woff'), asset-url('fonts/Simple-Line-Icons.svg?v=2.4.0#simple-line-icons') format('svg');\n  font-weight: normal;\n  font-style: normal;\n}\n</code></pre></div></div>\n\n<p>If you are installing from node module, you can not just update the path since\nall font files will be fingerprinted, so the best is to copy to and edit scss\nfile</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>npm install simple-line-icons\n\n// we use asset-url to find a fingerprinted path of font files in\n// node_modules/simple-line-icons/fonts\n$simple-line-font-path: \"simple-line-icons/fonts/\"\n@import 'plugins/simple-line-icons'\n\ncp node_modules/simple-line-icons/scss/simple-line-icons.scss app/assets/stylesheets/plugins\n\n# app/assets/stylesheets/plugins/simple-line-icons.scss\n# replace url with asset-url, like\n// Fonts\n@if $simple-line-font-family == \"simple-line-icons\" {\n  @font-face {\n    font-family: '#{$simple-line-font-family}';\n    src:    asset-url('#{$simple-line-font-path}Simple-Line-Icons.eot?v=2.4.0');\n    src:    asset-url('#{$simple-line-font-path}Simple-Line-Icons.eot?v=2.4.0#iefix') format('embedded-opentype'),\n            asset-url('#{$simple-line-font-path}Simple-Line-Icons.woff2?v=2.4.0') format('woff2'),\n            asset-url('#{$simple-line-font-path}Simple-Line-Icons.ttf?v=2.4.0') format('truetype'),\n            asset-url('#{$simple-line-font-path}Simple-Line-Icons.woff?v=2.4.0') format('woff'),\n            asset-url('#{$simple-line-font-path}Simple-Line-Icons.svg?v=2.4.0#simple-line-icons') format('svg');\n    font-weight: normal;\n    font-style: normal;\n  }\n}\n</code></pre></div></div>\n<p>You can test with:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RAILS_ENV=production rake db:setup db:migrate\nRAILS_ENV=production rake assets:precompile -v\nRAILS_SERVE_STATIC_FILES=true rails s -e production\n</code></pre></div></div>\n\n<p>You can check all current asset paths and write relative to that</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>rails runner \"puts Rails.application.config.assets.paths\"\n</code></pre></div></div>\n\n<h1 id=\"view\">View</h1>\n\n<p>View <code class=\"highlighter-rouge\">render</code> method has nothing to do with controller <code class=\"highlighter-rouge\">render</code> method. <code class=\"highlighter-rouge\">&lt;%= render 'menu' %&gt;</code> will render <em>_menu.html.erb</em> partial. <code class=\"highlighter-rouge\">&lt;%= render 'product/edit' %&gt;</code> will search for product/_edit.html. Partials can be rendered with its own <a href=\"http://guides.rubyonrails.org/layouts_and_rendering.html#partial-layouts\">layout</a> <code class=\"highlighter-rouge\">&lt;%= render partial: 'menu', layout: 'graybar' %&gt;</code></p>\n\n<p>Each partial has local variable with the same name as partial and you can pass an object into it with :object <code class=\"highlighter-rouge\">&lt;%= render partial: \"customer\", object: @new_customer %&gt;</code> or if it is an instance of Customer model shorthand is <code class=\"highlighter-rouge\">&lt;%= render @customer %&gt;</code> which will use <em>_customer.html.erb</em> with local object <code class=\"highlighter-rouge\">customer</code>. I do not recomend this shorthand. It is more self-explanatory when full parameters are used.</p>\n\n<p>It is prefered to use local variables when passing data to partial (instead of <em>@instance</em> variables). This is because partials can be used from different controllers, where some @instance variable is not set. For example, <code class=\"highlighter-rouge\">&lt;%= render partial: 'users/customer', { customer: @customer } %&gt;</code>. Locals of partial should be explained in a comment block:</p>\n\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>&lt;%# customer partial uses locals\n   - customer (required, instance of Customer)\n   - contact_form (true/false, default true)\n %&gt;\n &lt;%# (do not use contact_form||=true since it will override contact_form=false %&gt;\n &lt;%\n   unless defined? contact_form\n     contact_form = true\n   end \n %&gt; \n</code></pre></div></div>\n\n<p>In layouts you can use <code class=\"highlighter-rouge\">&lt;body class=\"controller-&lt;%= controller_name %&gt;\"&gt;</code>.\n<code class=\"highlighter-rouge\">controller_name</code> is <code class=\"highlighter-rouge\">params[:controller]</code>. In you scss you can use:\n<code class=\"highlighter-rouge\">.controller-home .header ...</code> if you have something specific for each action\nyou can add <code class=\"highlighter-rouge\">action_name</code> class.</p>\n\n<p><em>content_for</em> can be controller method with this\n<a href=\"https://gist.github.com/hiroshi/985457\">gist</a></p>\n\n<h1 id=\"errors\">Errors</h1>\n\n<p>If you see error <code class=\"highlighter-rouge\">ActionView::Template::Error (Unrecognised input):</code>  than you\nmight forget semicolon <code class=\"highlighter-rouge\">;</code> in your less file.</p>\n"
    } 
  
  ,
  
   {
     
        "title"    : "About",
        "category" : "",
        "tags"     : "",
        "url"      : "/about/",
        "date"     : "",
        "content"  : "Contact me at: duleorlovic@ twitter/gmail/facebook/Here is my old personalsite.My First Rails contribution https://github.com/rails/rails/pull/34911 (docs)https://github.com/rails/rails/pull/35143 (code) and my conference lightingtalk on Balkan Ruby https://youtu.be/lpkePkbYeoI?t=882.  "
     
   } ,
  
   {
     
   } ,
  
   {
     
   } ,
  
   {
     
   } 
  
]
