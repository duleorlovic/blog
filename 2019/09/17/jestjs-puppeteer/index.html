<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Jestjs Puppeteer</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Jestjs Puppeteer</h1>
    <p class="meta">Sep 17, 2019</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#install"><span class="tocnumber">1</span> <span class="toctext">Install</span></a><ul><li class="toc_level-2 toc_section-2"><a href="#jsdoc"><span class="tocnumber">1.1</span> <span class="toctext">JSDOC</span></a></li></ul></li><li class="toc_level-1 toc_section-3"><a href="#puppeteer"><span class="tocnumber">2</span> <span class="toctext">Puppeteer</span></a></li></ul></td></tr></tbody></table></div><h1 id="install">Install</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn add jest
</code></pre></div></div>
<p>Add script test command</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// package.json
{
  "scripts": {
    "test": "jest"
  }
}
</code></pre></div></div>

<p>Create two files</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// sum.js
function sum(a, b) {
  return a + b
}
module.exports = sum
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// sum.test.js
const sum = require('./sum')

test('adds 1 + 2 returns 3', () =&gt; {
  expect(sum(1, 2)).toBe(3)
}
</code></pre></div></div>

<p>and run with yarn</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn test

# or if you install globally: yarn global add jest
jest sum.test.js

# To run only one single test use `test.only('test', () =&gt; {`
# or use call with testNamePattern option 
jest sum.test.js -t adds

# run single file
jest --runInBand test/initialise.test.js

# debug in chrome, open chrome://inspect and use debugger in test or code
node --inspect $(yarn bin)/jest --runInBand test/initialise.test.js

# watch for file changes, like guard file listener
node --inspect node_modules/.bin/jest --watch
</code></pre></div></div>

<p>Mocking functions</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const mockCallback = jest.fn(x =&gt; 42 + x)
some_func_to_call(mockCallback)
expect(mockCallback.mock.calls.length).toBe(2) // called twice
expect(mockCallback.mock.calls[0][0]).toBe(0) // first call first argument be
expect(mockCallback.mock.calls[0].value).toBe(0) // first call result

</code></pre></div></div>
<p>Instances</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const myMock = jest.fn()
const a = new myMock()
const b = {}
const bound = myMock.bind(b)
bound()

console.log(myMock.mock.instances) // &lt;a&gt; &lt;b&gt;
</code></pre></div></div>

<p>To mock stylesheet files https://jestjs.io/docs/en/webpack</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// package.json
{
  "jest": {
    "moduleNameMapper": {
      "\\.(css|less)$": "&lt;rootDir&gt;/__mocks__/styleMock.js"
    }
  },
}
</code></pre></div></div>

<h2 id="jsdoc">JSDOC</h2>

<p>https://jsdoc.app/index.html#block-tags</p>

<ul>
  <li>start with two stars <code class="language-plaintext highlighter-rouge">/**</code></li>
</ul>

<h1 id="puppeteer">Puppeteer</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn add puppeteer
</code></pre></div></div>

<p>Create file</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// example.js
const puppeteer = require('puppeteer')

(async () =&gt; {
  const browser = await puppeteer.launch()
  const page = await browser.newPage()

  await page.goto('https://mail.google.com')
  await page.screenshot({path: 'mail.png'})

  await browser.close()
})()
</code></pre></div></div>

<p>run with node</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node example.js
# but easier with jest

</code></pre></div></div>

<p>browser</p>

<ul>
  <li>launch in head mode dsable gpu
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const browser = await puppeteer.launch({
  headless: false,
  dumpio: true, // &lt;== output chrome logs to STDOUT
  devtools: true,
  args: [
    '--disable-gpu',
    '--window-size=1280,800',
  ],
})
</code></pre></div>    </div>
  </li>
</ul>

<p>page</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">await page.click('a[href=""])</code>. To click by text
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const [button] = await page.$x("//button[contains(text(), 'Button text')]");
await button.click();
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">await page.type('input[type=email]', process.env.GOOGLE_USER)</code></li>
  <li>when navigation occurs you can wait
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>await page.waitForNavigation();
await page.waitForNavigation({waitUntil: 'load'});
</code></pre></div>    </div>
    <p>this is also used with</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>await page.waitForSelector('#login_field')
</code></pre></div>    </div>
  </li>
  <li>use debugger in brower
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># increase jest.setTimeout(100000) and launch with {devtools: true}
await page.evaluate(() =&gt; {debugger;})
</code></pre></div>    </div>
  </li>
  <li>use debugger in node with [chrome::/inspect/]
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node --inspect $(yarn bin)/jest my.test.js
</code></pre></div>    </div>
  </li>
  <li>capture console log from the browser
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>page.on('console', msg =&gt; console.log('PAGE LOG:', msg.text()));

await page.evaluate(() =&gt; console.log(`url is ${location.href}`));
</code></pre></div>    </div>
  </li>
  <li>to <code class="language-plaintext highlighter-rouge">$eval</code> on specific element you can
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let className = await page.$eval(
  '#my-input',
  (input) =&gt;  input.className
)
</code></pre></div>    </div>
  </li>
  <li>create screenshot <code class="language-plaintext highlighter-rouge">await page.screenshot({path: 'mail.png'})</code></li>
  <li>sleep wait some time
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>await page.waitFor(4000)
</code></pre></div>    </div>
    <p>but it is deprecated since you need to use <code class="language-plaintext highlighter-rouge">waitForSelector('button')</code>,
<code class="language-plaintext highlighter-rouge">waitForFunction(someFunc)</code> or <code class="language-plaintext highlighter-rouge">waitForXPath('//div')</code>.
but if you really want to sleep</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function delay(time) {
   return new Promise(function(resolve) { 
       setTimeout(resolve, time)
   });
}

// and in code

await delay(4000);
</code></pre></div>    </div>
  </li>
</ul>

<p>Helpers
Click (wait before it shows up)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>async clickRedirect(element) {
    const page = this.helpers['Puppeteer'].page;
    await page.waitForSelector(element);
    return await page.click(element);
}
</code></pre></div></div>

<p>Find and click a button or link by its text</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const escapeXpathString = str =&gt; {
  const splitedQuotes = str.replace(/'/g, `', "'", '`);
  return `concat('${splitedQuotes}', '')`;
};

async function clickButton(page, text) {
  xpath = `//*[contains(text(), '${text}')]`
  await page.waitForXPath(xpath)
  const [button] = await page.$x(xpath)
  if (button) {
    await button.click()
  } else {
    throw new Error(`Button not found: ${text}`);
  }
}
</code></pre></div></div>

<p>You can rescue from async exceptions with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const run = async () =&gt; {
  throw new Error(`Some error ${myVar}`)
}
const logErrorAndExit = err =&gt; {
  console.log(err);
  process.exit();
};
run().catch(logErrorAndExit);
</code></pre></div></div>
</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
