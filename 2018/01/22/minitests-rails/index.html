<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Minitests Rails</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Minitests Rails</h1>
    <p class="meta">Jan 22, 2018</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#minitest"><span class="tocnumber">1</span> <span class="toctext">Minitest</span></a></li><li class="toc_level-1 toc_section-2"><a href="#fixtures"><span class="tocnumber">2</span> <span class="toctext">Fixtures</span></a></li><li class="toc_level-1 toc_section-3"><a href="#minitest-classes"><span class="tocnumber">3</span> <span class="toctext">Minitest classes</span></a></li><li class="toc_level-1 toc_section-4"><a href="#minitest-model"><span class="tocnumber">4</span> <span class="toctext">Minitest model</span></a></li><li class="toc_level-1 toc_section-5"><a href="#minitest-services"><span class="tocnumber">5</span> <span class="toctext">Minitest services</span></a><ul><li class="toc_level-2 toc_section-6"><a href="#vcr"><span class="tocnumber">5.1</span> <span class="toctext">VCR</span></a></li></ul></li><li class="toc_level-1 toc_section-7"><a href="#minitest-controllers"><span class="tocnumber">6</span> <span class="toctext">Minitest controllers</span></a></li><li class="toc_level-1 toc_section-8"><a href="#minitest-integration"><span class="tocnumber">7</span> <span class="toctext">Minitest integration</span></a><ul><li class="toc_level-2 toc_section-9"><a href="#minitest-routing"><span class="tocnumber">7.1</span> <span class="toctext">Minitest routing</span></a></li><li class="toc_level-2 toc_section-10"><a href="#minitest-helper"><span class="tocnumber">7.2</span> <span class="toctext">Minitest helper</span></a></li><li class="toc_level-2 toc_section-11"><a href="#minitest-system"><span class="tocnumber">7.3</span> <span class="toctext">Minitest system</span></a></li><li class="toc_level-2 toc_section-12"><a href="#webmock"><span class="tocnumber">7.4</span> <span class="toctext">Webmock</span></a></li><li class="toc_level-2 toc_section-13"><a href="#minitest-helpers"><span class="tocnumber">7.5</span> <span class="toctext">Minitest helpers</span></a></li><li class="toc_level-2 toc_section-14"><a href="#minitest-mock"><span class="tocnumber">7.6</span> <span class="toctext">Minitest Mock</span></a></li><li class="toc_level-2 toc_section-15"><a href="#minitest-mocha-feature-tests"><span class="tocnumber">7.7</span> <span class="toctext">Minitest mocha feature tests</span></a></li></ul></li><li class="toc_level-1 toc_section-16"><a href="#guard"><span class="tocnumber">8</span> <span class="toctext">Guard</span></a></li><li class="toc_level-1 toc_section-17"><a href="#test-background-jobs"><span class="tocnumber">9</span> <span class="toctext">Test background jobs</span></a></li></ul></td></tr></tbody></table></div><h1 id="minitest">Minitest</h1>

<p>Minitest real test examples: openstreetmap, redmine</p>

<p>Mini test for rails <code class="language-plaintext highlighter-rouge">TestCase</code>s (for example <code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code>) inherits
from <code class="language-plaintext highlighter-rouge">Minitest::Test</code> so you can use it <code class="language-plaintext highlighter-rouge">def test_method</code>, but Rails adds <code class="language-plaintext highlighter-rouge">test</code>
method so it can be used like <code class="language-plaintext highlighter-rouge">test "my method" do</code>.  In minitests you can not
have same test descriptions since it will be converted to same <code class="language-plaintext highlighter-rouge">test_my_method</code>.</p>

<p>You can run specific test with <code class="language-plaintext highlighter-rouge">:10</code> or <code class="language-plaintext highlighter-rouge">-n test_name</code>. If test is defined like
<code class="language-plaintext highlighter-rouge">test "my test"</code> than you can use regexp <code class="language-plaintext highlighter-rouge">ruby test/file_test.rb -n /my.test/</code>
This also works for system test (so you do not need <code class="language-plaintext highlighter-rouge">system</code> in <code class="language-plaintext highlighter-rouge">rails
test:system somefile</code>)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails test
rails test:system
# sometimes assets are not compiled properly or node is different version so to
# trigger precompile you should run `rm -rf tmp public &amp;&amp; git checkout tmp public`
# so with `rails test:system` new folder will be created `public/packs-test`
# invoke test by line
rails test test/models/article_test.rb:6
# or name
# works only when you use `def test_example` syntax
# for `test "test_example" do` you should use -n test_test_example
rails test -n test_example
</code></pre></div></div>

<p>You could also use ENV variables <code class="language-plaintext highlighter-rouge">rails test
TEST=test/machine_with_callbacks_test.rb
TESTOPTS="--name=test_should_run_validations_for_specific_state -v"</code></p>

<p>Each test run will load all fixture data, run setup blocks, run test method, run
teardown block, rollback fixtures.</p>

<h1 id="fixtures">Fixtures</h1>

<p>http://api.rubyonrails.org/v5.2.0/classes/ActiveRecord/FixtureSet.html</p>

<p>Rails performs loading fixtures in tree steps: removing old fixture data, load
fixture data and dump data into a method inside test case <code class="language-plaintext highlighter-rouge">users(:david)</code>
Note that when using <code class="language-plaintext highlighter-rouge">smoke: Yes</code> or <code class="language-plaintext highlighter-rouge">smoke: No</code> it might be converted to true
false, so better is to use <code class="language-plaintext highlighter-rouge">smoke: 'Yes'</code> or <code class="language-plaintext highlighter-rouge">smoke: 'No'</code></p>

<p>Defining fixtures:</p>
<ul>
  <li>use labels for associated belongs_to and has_many items (separated by comma)
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/fixtures/users.yml
my_user:
  name: My User
  company: my_company

# test/fixtures/companies.yml
my_company:
  name: My Company
</code></pre></div>    </div>
  </li>
  <li>if you have polymorphic than put class name in brackets
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/fixtures/notifications.yml
notification_for_task:
  notifiable: my_task (Task)
notification_for_comment:
  notifiable: my_comment (Comment)
</code></pre></div>    </div>

    <p>No need to use brackets if you have <code class="language-plaintext highlighter-rouge">belongs_to :associated, class_name:
'Activity'</code></p>
  </li>
  <li>
    <p>for activestorage attachments you do not need to create fake models. just
create real fixtures
https://stackoverflow.com/questions/50453596/activestorage-fixtures-attachments
When I skip <code class="language-plaintext highlighter-rouge">key</code> not null column in fixture than I receive strange errors</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/orlovic/.rvm/rubies/ruby-2.6.3/lib/ruby/2.6.0/drb/drb.rb:565:in `dump': no _dump_data is defined for class PG::Connection (TypeError)
/home/orlovic/.rvm/rubies/ruby-2.6.3/lib/ruby/2.6.0/drb/drb.rb:565:in `dump': can't dump hash with default proc (TypeError)
# those are just backtrace errors for runners, not important, messages before
# this are more important
/home/orlovic/.rvm/rubies/ruby-2.6.3/lib/ruby/2.6.0/drb/drb.rb:1738:in `current_server': DRb::DRbServerNotFound (DRb::DRbServerNotFound)
/home/orlovic/.rvm/gems/ruby-2.6.3/gems/activesupport-6.0.2.1/lib/active_support/testing/parallelization.rb:98:in `block (3 levels) in start': undefined method `exception=' for #&lt;Minitest::UnexpectedError: Unexpected exception&gt; (NoMethodError)
</code></pre></div>    </div>
    <p>Here are fixtures so you have some blobs in db (another way to test is using
fixture_file_upload)</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/fixtures/active_storage/blobs.yml
my_blob:
  key: or9sbwfely5gby30qdvtoa1cu09a
  filename: computer_text.png
  content_type: image/png
  # jsonb
  metadata: '{"identified":true}'
  metadata: &lt;%= { "identified" =&gt; true }.to_json %&gt;
  byte_size: 56024
  checksum: wHaMfHXpSThHCX/zvm5fFg==

# test/fixtures/active_storage/attachments.yml
DEFAULTS: &amp;DEFAULTS
  # you can use same fake blob for all attachments
  blob_id: &lt;%= ActiveRecord::FixtureSet.identify(:my_blob) %&gt;
  created_at: 2019-12-06

my_attachment:
  &lt;&lt;: *DEFAULTS
  &lt;%# this has to be the same name as in has_one_attached %&gt;
  name: file
  record: my_doc (Doc)
  &lt;%# record_type: Doc %&gt;
  &lt;%# record_id: &lt;%= ActiveRecord::FixtureSet.identify(:my_doc) %1&gt; %&gt;
</code></pre></div>    </div>
    <p>If you want to have real file for this blobs, you can use before(:all) setup
before whole suite, to copy file to appropriate location so seed from fixtures
can be used on developing</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/test_helper.rb
  def self.initialize_fixture_blob
    return if File.exist? "#{Rails.root}/tmp/storage/or/9s/or9sbwfely5gby30qdvtoa1cu09a"

    FileUtils.mkdir_p "#{Rails.root}/tmp/storage/or/9s"
    FileUtils.cp(
      "#{Rails.root}/test/fixtures/files/computer_text.png",
      "#{Rails.root}/tmp/storage/or/9s/or9sbwfely5gby30qdvtoa1cu09a"
    )
  end
  initialize_fixture_blob
</code></pre></div>    </div>

    <p>To use in request use <code class="language-plaintext highlighter-rouge">blob.signed_id</code></p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test 'upload one picture' do
  user = users(:user)
  attachment = user.member_profile.member_picture.active_storage_attachment
  sign_in user

  blob = attachment.blob.signed_id
  assert_difference 'ActiveStorage::Blob.count', 0 do
    assert_difference 'MemberPicture.count', 1 do
      patch profile_update_path, params: { member_profile: { id: user.member_profile, member_pictures_attributes: { '0' =&gt; { active_storage_attachment: blob } } } }
      assert_response :redirect
    end
  end
end
</code></pre></div>    </div>

    <p>File upload from <code class="language-plaintext highlighter-rouge">test/fixtures/files/logo.png</code>
https://apidock.com/rails/ActionDispatch/TestProcess/FixtureFile/fixture_file_upload</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># include if not fixture_file_upload is not available

include ActionDispatch::TestProcess # for fixture_file_upload

post :create, logo: fixture_file_upload('files/logo.png', 'image/png')
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">enum parent_relations: %i[child]</code> can be set using erb
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>child:
  parent_relation: &lt;%= User.parent_relations[:child] %&gt;
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code>, <code class="language-plaintext highlighter-rouge">created_on</code> and <code class="language-plaintext highlighter-rouge">updated_on</code> is automatically
Time.now</li>
  <li>use ERB for dynamic creation. Note that you should use fixed dates instead of
<code class="language-plaintext highlighter-rouge">published_at: &lt;%= Date.today.strftime('%Y-%m-%d')</code> so they are stable.
Note that erb is evaluated before yml (for example <code class="language-plaintext highlighter-rouge">$LABEL</code>)
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% 15.times do |i| %&gt;
medium_&lt;%= i %&gt;:
  media_name: My &lt;%= i %&gt; Medium
  published_at: 2018-10-11
&lt;% end %&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>fixture label interpolation (<code class="language-plaintext highlighter-rouge">$LABEL</code> is <code class="language-plaintext highlighter-rouge">me</code>)</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>me:
  name: 'duke'
  subdomain: me
  # or use label
  subdomain: $LABEL
  email: $LABEL@email.com
</code></pre></div>    </div>

    <p>$Label is not interpolated within object like <code class="language-plaintext highlighter-rouge">name: { en: $LABEL }</code> (so I18n
mobility does not work)</p>
  </li>
  <li>defaults
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DEFAULTS: &amp;DEFAULTS
  name: $LABEL Name
  created_on: &lt;%= 3.weeks.ago.to_s(:db) %&gt;

first:
  name: Smurf
  &lt;&lt;: *DEFAULTS

second:
  name: Fraggle
  &lt;&lt;: *DEFAULTS
</code></pre></div>    </div>
  </li>
  <li>if you really want hardcoded ids you can use
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>my_language:
  id: 5
  name: English

course:
  language_id: 5
  # note that this is just yml so you can not use
  language_id: my_language.id
  # but you can use erb
  language_id: &lt;%= ActiveRecord::FixtureSet.identify :my_language %&gt;
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">pre_loaded_fixtures</code></li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">use_transactional_tests</code>. In Rails 4 it was
<code class="language-plaintext highlighter-rouge">use_transactional_fixtures</code> but since it could be factories not fixtures,
that is renamed to <code class="language-plaintext highlighter-rouge">use_transactional_tests</code>. So to disable it you can use</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class FooTest &lt; ActiveSupport::TestCase
  self.use_transactional_tests = false
end
</code></pre></div>    </div>
  </li>
  <li>when defining new fixtures, add them to the end, so you do not break current
test for first page (when you use pagination)</li>
  <li>load fixtures in development <code class="language-plaintext highlighter-rouge">rake db:fixtures:load</code> so put in your seed</li>
  <li>to set devise password, you can add encrypted password on specific items
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin_user:
  encrypted_password: &lt;%= User.new.send(:password_digest, 'password') %&gt;

# without device it is with gem bcrypt
  password_digest: &lt;%= BCrypt::Password.create('password') %&gt;
</code></pre></div>    </div>
  </li>
  <li>if you use <code class="language-plaintext highlighter-rouge">serialize :recurrence</code> than in fixture you have to wrap with
double quotes around and use .to_yaml
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>recurrence: "&lt;%= { a: 1 }.toyaml %&gt;"
</code></pre></div>    </div>
  </li>
  <li>if there are no colomns you can use <code class="language-plaintext highlighter-rouge">user: {}</code> curly brackets</li>
  <li>
    <p>Usage of fixtures</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># note that we are calling method users()
users(:my_user)
# we can get two
users(:duke, mike)
</code></pre></div>    </div>
  </li>
  <li>do not need to put all data in fixtures, you can create simple factories
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/models/user_test.rb
require 'test_helper'

class UserTest &lt; ActiveSupport::TestCase
  def create_user!(attr = {})
    user = users(:user).dup
    user.email = "#{rand}@email.com"
    user.password = "password"
    user.assign_attributes attr
    user.save!
    user
  end

  test "all users" do
  def test_example
    users = []
    users.append create_user!
    users.append create_user! unsubscribe_email_groups: ["remainders"]
    users.append create_user! unsubscribe_email_groups: ["messages"]

    assert_emails 2 do
      result = WeeklyRemainderWorker.new.perform(users)
      assert result.success?
    end
  end
end
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="minitest-classes">Minitest classes</h1>

<p>To see all 6 base test clases go
<a href="http://guides.rubyonrails.org/testing.html#a-brief-note-about-test-cases">http://guides.rubyonrails.org/testing.html#a-brief-note-about-test-cases</a>
ActiveSupport::TestCase
ActionMailer::TestCase
ActionView::TestCase
ActionDispatch::IntegrationTest
ActiveJob::TestCase
ActionDispatch::SystemTestCase</p>

<h1 id="minitest-model">Minitest model</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'test_helper'

class TaskTest &lt; ActiveSupport::TestCase
  test 'a completed' do
    task = Task.new
    refute(task.complete?)
    task.mark_completed
    assert(task.complete?)
  end

  def test_that_is_skipped
    skip "later"
    # similar to xtest xit
  end

  test 'valid fixture' do
    assert_valid_fixture activities
  end

  # test/test_helper.rb
  def assert_valid_fixture(items)
    assert items.map(&amp;:valid?).all?, (items.reject(&amp;:valid?).map { |c| (c.respond_to?(:name) ? "#{c.name} " : '') + c.errors.full_messages.to_sentence })
  end
end
</code></pre></div></div>

<p>Assertions
<a href="http://docs.seattlerb.org/minitest/Minitest/Assertions.html">all</a></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">assert true</code> or <code class="language-plaintext highlighter-rouge">assert_block do end</code></li>
  <li><code class="language-plaintext highlighter-rouge">assert_nil</code></li>
  <li><code class="language-plaintext highlighter-rouge">assert_empty</code></li>
  <li><code class="language-plaintext highlighter-rouge">assert_raises(NameError) do end</code></li>
  <li><code class="language-plaintext highlighter-rouge">assert_match regex, actual_string</code></li>
  <li><code class="language-plaintext highlighter-rouge">assert_includes(collection, object)</code></li>
  <li><code class="language-plaintext highlighter-rouge">assert_equal(expected, actual)</code></li>
</ul>

<p>They all have oposite <code class="language-plaintext highlighter-rouge">refute_</code> methods, or <code class="language-plaintext highlighter-rouge">assert_not</code>
They all accept additional string param that will be error message.</p>

<p><a href="http://guides.rubyonrails.org/testing.html#rails-specific-assertions">http://guides.rubyonrails.org/testing.html#rails-specific-assertions</a>
Rails also defines <code class="language-plaintext highlighter-rouge">assert_difference</code>, <code class="language-plaintext highlighter-rouge">assert_empty</code>, <code class="language-plaintext highlighter-rouge">assert_presence</code>,
<code class="language-plaintext highlighter-rouge">assert_response</code>, <code class="language-plaintext highlighter-rouge">assert_redirected_to</code>, <code class="language-plaintext highlighter-rouge">assert_select</code> (assert select for
custom html text is done with additional argument)
https://stackoverflow.com/questions/4739261/is-there-a-way-to-use-assert-select-on-some-custom-html-text</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    doc = HTML::Document.new(CGI::unescapeHTML(extracted_text)).root
    assert_select(doc, tag, content)
</code></pre></div></div>

<p>You can create your own assertiongs (assert sorted)
Reopen <code class="language-plaintext highlighter-rouge">module MiniTest::Assertions</code> when helper is used in all tests. If you
need only for system tests (assert_selector) or integration test (assert_select)
than you need to reopen that particular class
https://github.com/duleorlovic/premesti.se/blob/master/test/support/assert_equal_when_sorted_by_id.rb</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/a/assert_flash_message.rb
# https://github.com/duleorlovic/minitest_rails/blob/main/test/a/assert_flash_message.rb
class ActionDispatch::IntegrationTest
  # assert_flash_message
  def assert_alert_message(text)
    assert_select '[data-test=alert]', text
  end

  def assert_notice_message(text)
    assert_select '[data-test=notice]', text
  end
end

class ActionDispatch::SystemTestCase
  def assert_alert_message(text)
    assert_selector '[data-test=alert]', text: text
  end

  def assert_notice_message(text)
    assert_selector '[data-test=notice]', text: text
  end
end
</code></pre></div></div>

<p>For any method? you can assert for example</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>assert_kind_of Array, exp
</code></pre></div></div>

<h1 id="minitest-services">Minitest services</h1>

<p>Similar to model test you can create tests for services since there are PORO</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/services/credit_card_service_test.rb
require 'test_helper'

class CreditCardServiceTest &lt; ActiveSupport::TestCase
  test 'it creates charges' do
  end
end
</code></pre></div></div>

<h2 id="vcr">VCR</h2>

<p>To install use</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Gemfile
group :test do
  gem 'vcr'
  gem 'webmock'
end

# test/a/vcr.rb
VCR.configure do |config|
  config.cassette_library_dir = 'test/vcr_cassettes'
  config.hook_into :webmock
  config.ignore_localhost = true
end

# test/services/my_service_test.rb
require 'test_helper'

class MyServiceTest &lt; ActiveSupport::TestCase
  test 'success' do
    VCR.use_cassette 'my_service' do
      result = MyService.new(users(:my)).perform
      assert result.success?
    end
  end

  # you could also use in setup and teardown
  # https://github.com/vcr/vcr/wiki/Usage-with-MiniTest
   before do
      VCR.insert_cassette name
    end

    after do
      VCR.eject_cassette
    end
  end
</code></pre></div></div>

<p>Also works for system test, just I need to retry with delay for long processes
(you can simulate by inserting <code class="language-plaintext highlighter-rouge">sleep 5</code> in your service).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/system/docs_test.rb
require 'application_system_test_case'

class DocsTest &lt; ApplicationSystemTestCase
  test 'creating a Doc' do
    VCR.use_cassette 'detect_text_and_phi_computer_text' do
      visit docs_url
      click_on t_crud('add_new', Doc)

      fill_in 'Name', with: @doc.name
      page.attach_file 'doc[file]', "#{Rails.root}/test/fixtures/files/computer_text.png", make_visible: true
      click_on 'Create Doc'

      retries = 5
      begin
        retries -= 1
        assert_notice 'Doc successfully created'
      rescue Minitest::Assertion =&gt; e
        puts "retries=#{retries}"
        raise e if retries.zero?

        sleep 1
        retry
      end
    end
  end
end
</code></pre></div></div>
<p>More info on rails testing page</p>

<h1 id="minitest-controllers">Minitest controllers</h1>

<p>Deprecated, use minitest integration tests</p>

<h1 id="minitest-integration">Minitest integration</h1>

<p>For integration we use <code class="language-plaintext highlighter-rouge">ActionDispatch::IntegrationTest</code> which gives methods:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">get '/'</code>, <code class="language-plaintext highlighter-rouge">post path, params: {}</code> (params is required in rails_post_5),
 To set format use <code class="language-plaintext highlighter-rouge">patch path, params: { format: :turbo_stream }</code></li>
  <li>also <code class="language-plaintext highlighter-rouge">put</code>, <code class="language-plaintext highlighter-rouge">patch</code>, <code class="language-plaintext highlighter-rouge">head</code>, <code class="language-plaintext highlighter-rouge">delete</code></li>
  <li>for ajax use <code class="language-plaintext highlighter-rouge">post path, xhr: true</code></li>
  <li>add <code class="language-plaintext highlighter-rouge">as: :json</code> as third param for json requests so you can use something like
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get article_path(@article), as: :json
assert_equal "my title", response.parsed_body["title"]
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">follow_redirect!</code></li>
  <li><code class="language-plaintext highlighter-rouge">assert_redirected_to post_url(Post.last)</code>,or you can match only part of url
using <code class="language-plaintext highlighter-rouge">@response</code> object
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> assert_match /https:\/\/www.myapp.com\/path/, @response.redirect_url
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">assert_response :success</code> (for http codes 200-299), <code class="language-plaintext highlighter-rouge">:redirect</code> (300-399), <code class="language-plaintext highlighter-rouge">:missing</code> (404), <code class="language-plaintext highlighter-rouge">:error</code> (500-599).</li>
  <li><code class="language-plaintext highlighter-rouge">assert_select 'h1', user.email</code> . Note that white spaces and new lines are
ignored</li>
  <li><code class="language-plaintext highlighter-rouge">assert_difference 'User.count', 1 do</code></li>
  <li>You have access to <code class="language-plaintext highlighter-rouge">@request</code>, <code class="language-plaintext highlighter-rouge">@controller</code> and <code class="language-plaintext highlighter-rouge">@response</code> object, but only
after you call <code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">post</code>. You can set <code class="language-plaintext highlighter-rouge">request.remote_ip</code> by passing
headers (note that http referrer is written as http referer (single r)
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get sign_up_path, params: { user: { email: 'new@email.com' } }, headers: { 'REMOTE_ADDR': '123.123.123.123', HTTP_REFERER: 'http://domain.com', 'HTTP_USER_AGENT': 'Mozilla'}
</code></pre></div>    </div>
    <p>also you can authenticate basic auth</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get my_path, headers: { Authorization: ActionController::HttpAuthentication::Basic.encode_credentials('dhh', 'secret') }
</code></pre></div>    </div>
  </li>
  <li>to change default host you can use setup block (similar to rspec before) in
test helper
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/test_helper.rb
class ActiveSupport::TestCase
  def setup
    host! 'example.com'
  end
end
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">assert_select 'h1', 'Welcome'</code> is used to test view. View can be tested with
<code class="language-plaintext highlighter-rouge">assert_match /Welcome/', response.body</code>, for multi line you can use <code class="language-plaintext highlighter-rouge">/m</code>
<code class="language-plaintext highlighter-rouge">assert_match /first line.*second line/m, response.body</code>
<code class="language-plaintext highlighter-rouge">refute_match "Welcome", response.body</code> to assert not included text
There are two forms of <em>assert_select selector, [equality], [message]</em> or
using Nokogiri::XML::Node as element <em>assert_select element, selector,
[equality]</em>.
selector can be CSS selector as one string, or array with substitutions
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>assert_select 'div#123' # exists &lt;div id='123'&gt;
assert_select "a[href='http://www.example.com/diary/new']"
assert_select 'a[href=?]', tasks_path
assert_select 'input[value=?]', username   # substitute username
assert_select 'input[value*=?]', username   # match when containing username
assert_select '[data-test=unread-count]', count: 123
assert_select '[data-test=unread-count]', minimum: 123

# use custom pseudo class `:match(attribute_name, attribute_value)`
assert_select "ol&gt;li:match('id', ?)", /item-\d+/       # exists li id='item-1'
assert_select "div:match('id',?)", /\d+/        # exists div with non empty id

assert_select 'div', 'Hello' # exists &lt;div&gt;Hello&lt;/div&gt;
assert_select 'div', /hello/ # if div text matches
assert_select 'div', false # no divs exists
assert_select 'div', 4 # exactly 4 divs
assert_select 'div', 4..5 # number of dives is in range

# multiple attributes
assert_select "input[type=checkbox][value=messages][checked=checked]", 1
</code></pre></div>    </div>

    <p>To perform more than one quality tests in one assert you can use hash
(assert_selector also use this hash param, like presence items
<code class="language-plaintext highlighter-rouge">assert_selector '[data-test^=member-profile-]', count:
Const.limits[:per_page]</code>)</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># instead of refute_select, for no div with my_name you can use count but put
# inside hash: text: and count:
assert_select 'a[href=?]', 'http://link.com', text: /my_name/, count: 0
# https://apidock.com/rails/ActionController/Assertions/SelectorAssertions/assert_select
 # All input fields in the form have a name
assert_select "form input" do
  assert_select "[name=?]", /.+/  # Not empty
end

# https://apidock.com/rails/HTML/Selector
# to target all elements data-test="member-profile-1", data-test="member-profile-2"
assert_select '[data-test^=member-profile-]', 10

# not sure how to use substitution, why this does not work
assert_select '[data-test=member-profile-?]', /.+/, count: 10

assert_select 'div', html: 'p', minimum: 2
</code></pre></div>    </div>

    <p>Error like</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Nokogiri::CSS::SyntaxError: unexpected '$' after '[:equal, "id-1"]'
  (eval):3:in `_racc_do_parse_c'
  (eval):3:in `do_parse'
</code></pre></div>    </div>
    <p>occurs when you forget closing brackets like <code class="language-plaintext highlighter-rouge">assert_selector '[data-test=id-1'</code></p>

    <p>To check html in emails use assert_select_email</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>assert_select_email do
  items = assert_select "ol&gt;li"
  items.each do
    Work with items here...
  end
end
</code></pre></div>    </div>
  </li>
</ul>

<p>Those integration tests are similar to Rspec request spec, and works full stack
with no use of capybara. More info
  https://github.com/rails/rails-dom-testing/blob/master/lib/rails/dom/testing/assertions/selector_assertions.rb
similar to capybara <code class="language-plaintext highlighter-rouge">have_selector</code> but separate implementation <code class="language-plaintext highlighter-rouge">html selector</code>.
<a href="http://www.rubydoc.info/github/rails/rails-dom-testing/Rails%2FDom%2FTesting%2FAssertions%2FSelectorAssertions%3Aassert_select">http://www.rubydoc.info/github/rails/rails-dom-testing/Rails%2FDom%2FTesting%2FAssertions%2FSelectorAssertions%3Aassert_select</a>
  After request is made you can also access <code class="language-plaintext highlighter-rouge">@controller</code>, <code class="language-plaintext highlighter-rouge">@request</code> and
  <code class="language-plaintext highlighter-rouge">@response</code> (same as <code class="language-plaintext highlighter-rouge">response</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/controllers/projects_controller_test.rb
require 'test_helper'

class ProjectsControllerTest &lt; ActionDispatch::IntegrationTest
  setup do
    @project = create :project
  end

  # called after every single test
  teardown do
    # when controller is using cache it may be a good idea to reset it afterwards
    Rails.cache.clear
  end

  test 'show' do
    get project_path(@project)
    assert_select "#tutorial-#{tutorials(:priced_course_first_free_tutorial).id}", /Watch this lesson now/
    assert_select "#tutorial-#{tutorials(:priced_course_third_tutorial).id}", text: /Watch this lesson now/, count: 0

    # or you can parse `response.body` do it manually

    doc = Nokogiri::HTML response.body
    # you can get all respone text with doc.text.split.join(' ')
    el = doc.search "#tutorial-#{tutorials(:priced_course_first_free_tutorial).id}"
    assert_match 'Watch this lesson now', el.text
    el = doc.search "#tutorial-#{tutorials(:priced_course_third_tutorial).id}"
    assert_no_match 'Watch this lesson now', el.text
  end

  test "the create method creates project" do
    post projects_url, params: { project: { name: 'Duke' } }
    assert_redirected_to projects_path
    # also available: assert_response :redirect
    follow_redirect!
    assert_select '#my-id', /dule/
  end
end
</code></pre></div></div>

<h2 id="minitest-routing">Minitest routing</h2>

<p>It uses <code class="language-plaintext highlighter-rouge">assert_routing</code>.</p>

<h2 id="minitest-helper">Minitest helper</h2>

<p>Uses <code class="language-plaintext highlighter-rouge">assert_dom_equal</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/helpers/projects_helper_test.rb
require 'test_helper'
class ProjectsHelperTest &lt; ActionView::TestCase
  test "project on schedule" do
    project = Project.new name: 'Duke'
    project.stubs(:on_schedule?).returns(true)
    actual= name_with_status(project)
    expected = "&lt;span class='on-schedule'&gt;Duke&lt;/span&gt;"
    assert_dom_equal expected, actual
  end
end
</code></pre></div></div>

<h2 id="minitest-system">Minitest system</h2>

<p>Feature tests are run in different process than rails so we need database
cleaner gem. With system tests, we can use internal mechanism to roll back db
changes.
Before we used feature specs for full application integration testing, but now
we should use system specs (which also uses capybara and webdriver with chrome).
Add to gemfile</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # system test
  gem 'capybara' # 3.35.3
  gem 'selenium-webdriver' # 3.142.7
</code></pre></div></div>
<p>and create</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/application_system_test_case.rb
require 'test_helper'

class ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase
  # driven_by :selenium, using: :headless_chrome, screen_size: [1400, 1400]
  driven_by :selenium, using: :chrome, screen_size: [1400, 1400]

  # you can use bye bug, but it will stop rails so you can not navigate to other
  # pages or make another requests in chrome while testing
  def pause
    $stderr.write('Press CTRL+j or ENTER to continue') &amp;&amp; $stdin.gets
  end
end
</code></pre></div></div>

<p>Use nameing like ROLE_ACTION_test.rb for example <em>user_shares_card_test.rb</em></p>

<p>System tests are not included in default test suite if you run <code class="language-plaintext highlighter-rouge">rails test</code> (you
should run <code class="language-plaintext highlighter-rouge">rake test:system</code>), but if you run specific test than it will be run
<code class="language-plaintext highlighter-rouge">rails test test/system/my_test.rb</code>.</p>

<p>Note that if you use puma with multiple workers than
<code class="language-plaintext highlighter-rouge">ActionMailer::Base.deliveries.size</code> could be different in rails process and in
test process, so use <code class="language-plaintext highlighter-rouge">workers 0</code> in <code class="language-plaintext highlighter-rouge">config/puma/test.rb</code>.
Or insclude ActionMailer::TestHelper and use assert_emails method.</p>

<p>To limit number of bowsers (default is number of cores) use</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PARALLEL_WORKERS=1 rails test:system
</code></pre></div></div>

<p>In system test you can’t mock OmniAuth.mock_auth so use integration test for
that.</p>

<p>Capybara assertions
<a href="http://www.rubydoc.info/gems/capybara/Capybara/Minitest/Assertions">http://www.rubydoc.info/gems/capybara/Capybara/Minitest/Assertions</a></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">assert_text /dule/</code> or <code class="language-plaintext highlighter-rouge">assert_text Regexp.new('dule', Regexp::MULTILINE)</code>
(instead of <code class="language-plaintext highlighter-rouge">assert_match /dule/, page.body</code> or in rspec <code class="language-plaintext highlighter-rouge">expect(page).to
include 'dule'</code></li>
  <li><code class="language-plaintext highlighter-rouge">assert_selector 'a', text: 'duke'</code>
 you can assert other html attributes with square brackets
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> assert_selector '#my_id[readonly="readonly"][value="My Name"]'
</code></pre></div>    </div>
    <p>or if you use find.attribute</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> assert_match "avatar_female4", find('[data-test="profile-image"]').native.attribute("src")
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">assert_equal admin_path, page.current_path</code> page.url ie page.current_url
contains also http:// so better is to use page path</li>
</ul>

<h2 id="webmock">Webmock</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Gemfile
gem 'webmock'

# config/initializers/webmock.rb
if Rails.env.test?
  require 'webmock'
  # https://github.com/titusfortner/webdrivers/issues/109
  driver_urls = Webdrivers::Common.subclasses.map do |driver|
    Addressable::URI.parse(driver.base_url).host
  end
  WebMock.disable_net_connect!(allow_localhost: true, allow: driver_urls)
  WebMock.disable_net_connect!(allow_localhost: true)
end

# test/test_helper.rb
require 'webmock/minitest'
</code></pre></div></div>

<h2 id="minitest-helpers">Minitest helpers</h2>

<p>Add a line in <code class="language-plaintext highlighter-rouge">test/test_helper.rb</code> to include files from <code class="language-plaintext highlighter-rouge">test/a</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/test_helper.rb
ENV['RAILS_ENV'] ||= 'test'
require File.expand_path('../../config/environment', __FILE__)
Dir[Rails.root.join('test/a/**/*.rb')].each { |f| require f }
require 'rails/test_help'
require 'minitest/autorun'
require 'webmock/minitest'

class ActiveSupport::TestCase
  # create(:user) instead FactoryBot.create :user
  include FactoryBot::Syntax::Methods

  # stub_something
  include WebmockHelper.

  # t('successfully') instead I18n.t('successfully')
  include AbstractController::Translation

  # devise method: sign_in user
  include Devise::Test::IntegrationHelpers

  # Setup all fixtures in test/fixtures/*.yml for all tests in alphabetical order.
  fixtures :all

  # assert_emails 1
  include ActionMailer::TestHelper

end
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/a/webmock_helper.rb
module WebmockHelpers
  def stub_s3
    stub_request(:get, /s3.amazonaws.com/).to_return(status: 200, body: 'text')
    yield if block_given?
  end

  def stub_ip_info(timezone)
    stub_request(:get, /ipinfo.io/)
      .to_return(headers: {content_type: 'application/json'}, body: {"timezone": timezone}.to_json)
  end
end
</code></pre></div></div>

<p>I prefer to use factories on specific integration test so when I need to remove
specific fixtures I use rails <code class="language-plaintext highlighter-rouge">Courses.delete_all</code>. I do not use database
cleaner because it complicates thinks because I need to load some specific
fixtures (like users) and remove other. Not sure if that will remove fixtures
for other tests
https://stackoverflow.com/a/28539464/287166</p>

<p>For pause</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/a/pause_helper.rb
module PauseHelper
  # you can use byebug, but it will stop rails so you can not navigate to other
  # pages or make another requests in chrome while testing
  def pause
    $stderr.write('Press CTRL+j or ENTER to continue') &amp;&amp; $stdin.gets
  end
end

class ActionDispatch::SystemTestCase
  include PauseHelper
end
</code></pre></div></div>

<h2 id="minitest-mock">Minitest Mock</h2>

<p>You need to require autorun</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/test_helper.rb
require 'minitest/autorun'
</code></pre></div></div>

<p>http://ruby-doc.org/stdlib-2.0.0/libdoc/minitest/rdoc/MiniTest/Mock.html</p>

<p>You can mock return values:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@mock = Minitest::Mock.new
@mock.expect(:meaning_of_life, 42)
@mock.meaning_of_life # =&gt; 42
</code></pre></div></div>

<p>and also for arguments and verify their type or value</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@mock.expect(:do_something_with, true, [some_obj, true])
@mock.do_something_with(some_obj, true) # =&gt; true

@mock.expect(:uses_any_string, true, [String])
@mock.uses_any_string("foo") # =&gt; true
@mock.verify  # =&gt; true

@mock.expect(:uses_one_string, true, ["foo"]
@mock.uses_one_string("bar") # =&gt; true
@mock.verify  # =&gt; raises MockExpectationError
</code></pre></div></div>

<p>You can use <code class="language-plaintext highlighter-rouge">Object.stub</code> https://github.com/seattlerb/minitest#stubs
https://github.com/seattlerb/minitest#mocks
https://stackoverflow.com/questions/10990622/how-do-i-stub-a-method-to-raise-an-error-using-ruby-minitest</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require "minitest/autorun"

class MyModel
  def my_method; end
end

class TestRaiseException &lt; MiniTest::Unit::TestCase
  def test_raise_exception
    my_instance = MyModel.new
    raises_exception = Proc.new { raise ArgumentError, 'hi' }
    my_instance.stub :my_method, raises_exception do
      e = assert_raises(ArgumentError) { my_instance.my_method }
      assert_equal 'hi', e.message
    end
  end
end
</code></pre></div></div>

<p>Stub works also with some custom doubles mock. You can define singleton method
on mock <code class="language-plaintext highlighter-rouge">def mock.apply; end</code> but can not use other methods or variables… in
this case use <code class="language-plaintext highlighter-rouge">mock.expect :method, return_value</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/models/user_test.rb
require 'test_helper'
class UserTest &lt; ActiveSupport::TestCase
  test '#apply_subscription' do
    mock = Minitest::Mock.new
    def mock.apply; true; end
    # or
    mock.expect :apply, true

    SubscriptionService.stub :new, mock do
      user = users(:one)
      assert user.apply_subscription
    end
  end
end
</code></pre></div></div>

<h2 id="minitest-mocha-feature-tests">Minitest mocha feature tests</h2>

<p>Rails calls “integration tests” as “request tests” and it covers both controller
and view code. If logic is more complex, it should be written in model anyway,
and use lower level tests.</p>

<p>With capybara:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Gemfile
  gem "minitest-rails-capybara"
  gem "mocha", require: false

# test/test_helper.rb
require "minitest/rails/capybara"
require "mocha/mini_test"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  test "full double" do
    stubby = stub(name: "Dule", wight: 100)
    assert_equal("Dule", stubby.name)
  end

  test "verifying double" do
    stubby = stub(name: "Dule", weight: 100)
    stubby.responds_like(Project.new)
    # or
    stubby.responds_like_instance_of(Project)
    # this is find since project.name exists
    stubby.name
    # this will raise error
    skip
    stubby.weight
  end

  test "partial double" do
    project = Project.new name: 'Dule'
    # we can stub method on any ruby object
    project.stubs(:name)
    # returns nothing unless we use returns
    assert_nil(project.name)
    # we can stub non existing methods
    project.stubs(:asd)
    assert_nil(project.asd)
    # we can define return
    project.stubs(:due_date).returns(Date.today)
    assert_equal(project.due_date, Date.today)
    # we can stub classes
    Project.stubs(:find).returns(Project.new(name: 'dule'))
    project = Projet.find(1)
    assert_equal('dule', project.name)
    # we can stub any instance
    Project.any_instance.stubs(:save).returns(false)
  end

  test "mock expectation" do
    mock_project = Project.new name: 'Not important since expect returns'
    mock_project.expects(:name).returns('Duke')
    # previous expectation will fail if we have not called it
    assert_equal('Duke', mock_project.name)
    # we can set number of times it is called
    mock_project.expects(:name).twice
    mock_project.name
    mock_project.name
    # we can set arguments
    mock_task = Task.new
    mock_task.expects(:mark_as_completed).with(instance_of(Date)).returns(instance_of(Date))
    mock_task.mark_as_completed Date.today
    mock_task.expects(:mark_as_completed).with(instance_of(String)).returns(nil)
    mock_task.mark_as_completed "bla"
  end
</code></pre></div></div>

<h1 id="guard">Guard</h1>

<p>For guard minitest use <code class="language-plaintext highlighter-rouge">guard-minitest</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sed -i Gemfile -e '/group :development do/a  \
  gem 'guard'
  gem 'guard-minitest'
bundle
guard init minitest
vi Guardfile
# uncomment rails section
# change some lines in Guardfile
guard :minitest, spring: 'bin/rails test', failed_mode: :focus do
</code></pre></div></div>

<ul>
  <li>to show full backtrace use <code class="language-plaintext highlighter-rouge">BACKTRACE=blegga rails test</code></li>
  <li>
    <p>to take screenshot you can call <code class="language-plaintext highlighter-rouge">take_screenshot</code> in tests.
Automatically taking screenshot when tast fails is included in teardown by
default, and you can override it
https://api.rubyonrails.org/v5.2/classes/ActionDispatch/SystemTesting/TestHelpers/ScreenshotHelper.html#method-i-take_screenshot
By default <code class="language-plaintext highlighter-rouge">image_name</code> is
<a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/actionpack/lib/action_dispatch/system_testing/test_helpers/screenshot_helper.rb#L42">method_name</a>
By default <code class="language-plaintext highlighter-rouge">display_image</code> will print <code class="language-plaintext highlighter-rouge">puts image_path</code> but we can open image</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/application_system_test_case.rb
require 'test_helper'

class ApplicationSystemTestCase &lt; ActionDispatch::SystemTestCase
  driven_by :selenium, using: :chrome, screen_size: [1400, 1400]

  def display_image
    system "gnome-open #{image_path} &amp;"
    system "xdg-open #{image_path} &amp;"
    "Opening screenshot: xdg-open #{image_path}"
  end
end
</code></pre></div>    </div>
  </li>
  <li>test og meta tags for jekyll</li>
  <li>https://gist.github.com/thbar/10be2ea924b81f78d24ab800461bfee3</li>
  <li>if you want to run specific test (not all tests in one test file) than you
need to use <code class="language-plaintext highlighter-rouge">require 'rails/all</code> in <code class="language-plaintext highlighter-rouge">config/application.rb</code> and run by line
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/rails test test/controllers/registrations_controller_test.rb:27
</code></pre></div>    </div>
  </li>
  <li>to set cookies you can simply use
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ApplicationControllerTest &lt; ActionDispatch::IntegrationTest
  test '#use_time_zone' do
    user = users(:user)
    cookies['browser.timezone'] = 'UTC'
    get root_path
  end
end
</code></pre></div>    </div>
  </li>
  <li>Using rails native helpers instead of timecop
http://edgeapi.rubyonrails.org/classes/ActiveSupport/Testing/TimeHelpers.html
Use <code class="language-plaintext highlighter-rouge">ActiveSupport::Testing::TimeHelpers#travel</code> (usefull when you want time to
pass) and <code class="language-plaintext highlighter-rouge">travel_to</code> <code class="language-plaintext highlighter-rouge">travel_back</code> (time does not move for the duration of the
test).</li>
</ul>

<h1 id="test-background-jobs">Test background jobs</h1>

<p>You can test job directly by calling perform.now</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/jobs/update_person_job_test.rb
class UpdatePersonJobTest &lt; ActiveJob::TestCase
  test 'update score' do
    person = people(:one)
    UpdatePersonJob.perform_now(person, 3)
    assert_eqal 3, person.reload.score
  end
end
</code></pre></div></div>

<p>https://api.rubyonrails.org/classes/ActiveJob/TestHelper.html#method-i-assert_enqueued_jobs
You can use</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>assert_enqueued_with job: MyJob, args: [user]
perform_enqueued_jobs
assert_performed_jobs 1
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">ActiveJob::Base.queue_adapter = :test</code> will change queue adapter for all
following test.
You can see differences between queue adapters
<a href="http://api.rubyonrails.org/v5.1.4/classes/ActiveJob/QueueAdapters.html">http://api.rubyonrails.org/v5.1.4/classes/ActiveJob/QueueAdapters.html</a>
There is test helpers like <code class="language-plaintext highlighter-rouge">assert_performed_with</code> http://api.rubyonrails.org/classes/ActiveJob/TestHelper.html#method-i-assert_performed_with
example of use is
<a href="https://github.com/eliotsykes/rspec-rails-examples/blob/master/spec/jobs/headline_scraper_job_spec.rb">https://github.com/eliotsykes/rspec-rails-examples/blob/master/spec/jobs/headline_scraper_job_spec.rb</a>
To send email in background Rails use mailers
<a href="https://blog.bigbinary.com/2018/01/15/rails-5-2-allows-mailers-to-use-custom-active-job-class.html">ActionMailer::DeliveryJob</a>
so to test sending in minitest</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'test_helper'

class ProductTest &lt; ActionDispatch::IntegrationTest
  # if you want to actually perform jobs
  include ActiveJob::TestHelper
  test 'mail' do
    perform_enqueued_jobs only: ActionMailer::DeliveryJob do
      ...
    end
  end

  # https://api.rubyonrails.org/v5.1/classes/ActionMailer/TestHelper.html#method-i-assert_emails
  # or you can assert that it is enqueued
  assert_enqueued_jobs 1 do
  # or you can assert how it is called `_with`
  assert_enqueued_with job: ActionMailer::DeliveryJob, args: [1, 'a'] do

  include ActionMailer::TestHelper
  test 'mail' do
    assert_performed_jobs 2, only: ActionMailer::DeliveryJob do
      product.charge(account)
    end
  end

  # for email you can assert
  assert_difference 'ActionMailer::Base.deliveries.size', 1 do
    MyJob.perform_now
  end


  # to test that no jobs are enqueued
  assert_no_enqueued_jobs do
  end
end
</code></pre></div></div>

<ul>
  <li>test unit https://test-unit.github.io and getting started page
https://github.com/test-unit/test-unit/blob/master/doc/text/getting-started.md
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># my.rb
require "test-unit"

# here is my code or
# require "my_code"

class MyTest &lt; Test::Unit::TestCase
  def test_zero
    assert true
  end
end
</code></pre></div>    </div>
    <p>and run with <code class="language-plaintext highlighter-rouge">ruby my.rb</code> or using https://github.com/test-unit/test-unit/blob/master/doc/text/getting-started.md#43-rakefile-no-edit
omit https://test-unit.github.io/test-unit/en/Test/Unit/TestCaseOmissionSupport.html#omit-instance_method</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def test_omission
  omit
  # Not reached here
end
</code></pre></div>    </div>
    <p>hooks https://test-unit.github.io/test-unit/en/Test/Unit/TestCase.html</p>
  </li>
</ul>
</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
