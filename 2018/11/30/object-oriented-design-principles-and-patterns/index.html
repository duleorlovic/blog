<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Object Oriented Design Principles And Patterns</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Object Oriented Design Principles And Patterns</h1>
    <p class="meta">Nov 30, 2018</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#dhh"><span class="tocnumber">1</span> <span class="toctext">DHH</span></a></li><li class="toc_level-1 toc_section-2"><a href="#rails-patterns"><span class="tocnumber">2</span> <span class="toctext">Rails Patterns</span></a><ul><li class="toc_level-2 toc_section-3"><a href="#policy-object"><span class="tocnumber">2.1</span> <span class="toctext">Policy object</span></a></li><li class="toc_level-2 toc_section-4"><a href="#query-object"><span class="tocnumber">2.2</span> <span class="toctext">Query object</span></a></li><li class="toc_level-2 toc_section-5"><a href="#service-objects"><span class="tocnumber">2.3</span> <span class="toctext">Service objects</span></a></li><li class="toc_level-2 toc_section-6"><a href="#observer"><span class="tocnumber">2.4</span> <span class="toctext">Observer</span></a></li><li class="toc_level-2 toc_section-7"><a href="#interactor"><span class="tocnumber">2.5</span> <span class="toctext">Interactor</span></a></li></ul></li><li class="toc_level-1 toc_section-8"><a href="#decorator"><span class="tocnumber">3</span> <span class="toctext">Decorator</span></a></li><li class="toc_level-1 toc_section-9"><a href="#facade-pattern"><span class="tocnumber">4</span> <span class="toctext">Facade pattern</span></a></li><li class="toc_level-1 toc_section-10"><a href="#tips"><span class="tocnumber">5</span> <span class="toctext">Tips</span></a></li></ul></td></tr></tbody></table></div><p><a href="http://blog.codeclimate.com/blog/2012/10/17/7-ways-to-decompose-fat-activerecord-models/">7-ways-to-decompose-fat-activerecord-models</a>
suggestions for code organization.</p>

<p>You can organize domain (controller, model and view) into separate folders
<a href="https://github.com/NullVoxPopuli/drawers">drawers</a></p>

<p>https://thoughtbot.com/upcase/intermediate-ruby-on-rails
https://code.tutsplus.com/articles/a-beginners-guide-to-design-patterns–net-12752</p>

<p>Three basic kind of design pattern:</p>
<ul>
  <li>structural</li>
  <li>creational</li>
  <li>behavioral</li>
</ul>

<p>https://www.youtube.com/watch?v=3SGRjUWScRw&amp;feature=youtu.be</p>

<p>Instead of</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Member &lt; ActiveRecord::Base
  has_many :email_addresses
  has_one :primary_email_address, conditions: { primary: true }
end
</code></pre></div></div>

<p>Use belongs_to on members</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Member &lt; ActiveRecord::Base
  has_many :email_addresses
  belongs_to :primary_email_address, class_name: "EmailAddress", foreign_key: :email_address_id
end
</code></pre></div></div>

<p>https://thoughtbot.com/blog/handling-associations-on-null-objects</p>

<h1 id="dhh">DHH</h1>

<p><a href="https://www.youtube.com/watch?v=D7zUOtlpUPw">dhh tips for rails</a></p>
<ul>
  <li>epipsode 1: do not use comments but method names or constants… follow
table of content: method definition should be in same order as they are used
in the class (in before callbacks)
administered concern define methods on associations. Also use <code class="language-plaintext highlighter-rouge">or</code> <code class="language-plaintext highlighter-rouge">|</code> to join
two arrays</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module Account::Administered
  extend ActiveSupport::Concern

  included do
    has_many :administratorships, dependent: :delete_all do
      def grant(person)
        create_or_find person: person
      end

      def revoke(person)
        where(person_id: person.id).destroy_all
      end
    end

    has_many :administrators, through: :administratorships, source: :person
  end

  def all_administrators
    administrators | all_owners
  end

  def administrator_candidates
    people.users.
      where.not(id: administratorships.pluck(:person_id)).
      where.now(id: ownerships.pluck(:person_id)).
      where.not(id: owner_person.id)
  end
end
</code></pre></div></div>
<ul>
  <li>episode 2: use callbacks to initiate background jobs</li>
  <li>episode 3: use globals in request/response cycle. For background jobs you need
to pass them as params.</li>
  <li>episode 4</li>
</ul>

<h1 id="rails-patterns">Rails Patterns</h1>

<p>Pawel Daborwski
Patterns are used for benefit of:</p>
<ul>
  <li>isolation: db/payment should be tested separately</li>
  <li>readability: class name should tell what given code is doing</li>
  <li>extendability: it should be easy to modify by changing in single place</li>
  <li>single responsibility: one method for one action</li>
</ul>

<h2 id="policy-object">Policy object</h2>

<p>It is used to check if someone is allowed to do the action. File name should use
<code class="language-plaintext highlighter-rouge">_policy</code> suffix. Return only boolean value. Inside method, only call methods on
passed objects.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class UsersPolicy
  def initialize(user)
    @user = user
  end
  def admin?
    @user.role == 'admin'
  end
end
</code></pre></div></div>

<h2 id="query-object">Query object</h2>

<p>Complex queries should be extracted and tested separatelly. File name could be
<code class="language-plaintext highlighter-rouge">app/queries/users/list_active_users_query.rb</code> for single query, or
<code class="language-plaintext highlighter-rouge">app/queries/users_query.rb</code> for multiple <code class="language-plaintext highlighter-rouge">#active</code> and <code class="language-plaintext highlighter-rouge">#suspended</code> methods.
For single query you can use class methods</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module Users
  class ListActiveUsersQuery
    def self.call
      User.where(status: 'active').where.not(email: nil)
    end
  end
end
</code></pre></div></div>
<p>for multiple you can use poro</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class UsersQuery
  def initialize(users = User.all)
    @users = users
  end
  def active
    @users.where(active: true)
  end
  def pending
    @users.where(pending: true)
  end
end
</code></pre></div></div>
<p>and you can chaining <code class="language-plaintext highlighter-rouge">query = UsersQuery.new</code> and <code class="language-plaintext highlighter-rouge">query.active.pending</code>.
You can use https://apidock.com/rails/ActiveRecord/QueryMethods/extending to
extend scopes.</p>

<h2 id="service-objects">Service objects</h2>

<p>Always define only one public method: <code class="language-plaintext highlighter-rouge">call</code>, <code class="language-plaintext highlighter-rouge">perform</code> or <code class="language-plaintext highlighter-rouge">process</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/services/match_posts.rb
def MatchPosts
  def initialize(posts)
    @posts = posts
  end

  def perform
  end
end
</code></pre></div></div>

<p>You should return object that can be success and hold some data</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/models/result.rb
class Result
  attr_accessor :message, :data

  # you can return in service like:
  #   return Result.new 'Next task created', next_task: next_task
  # and use in controller:
  #   if result.success? &amp;&amp; result.data[:next_task] == task
  def initialize(message, data = {})
    @message = message
    @data = data
  end

  def success?
    true
  end
end

# app/models/error.rb
class Error &lt; Result
  def success?
    false
  end
end
</code></pre></div></div>

<p>and you can rescue from exceptions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/services/my_service.rb
class MyService
  # Some custom exception if needed
  class ProcessException &lt; Exception
  end

  def initialize(h)
    @user = h[:user]
  end

  def process(posts)
    success_message = do_something posts
    Result.new success_message
  rescue ProcessException =&gt; e
    Error.new e.message
  end

  private

  def do_something(posts)
    raise ProcessException, "Error: empty posts" unless posts
    "Done with do_something"
  end
end
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># main.rb
require './my_service.rb'

my_service = MyService.new user: 'me'
puts my_service.process(1).success? # true
puts my_service.process(1).message # Done with do_something
puts my_service.process(false).success? # false
puts my_service.process(false).message # empty posts
</code></pre></div></div>

<h2 id="observer">Observer</h2>

<p>We an use observable objects to send notifications <a href="http://www.diatomenterprises.com/observer-pattern-in-3-languages-ruby-c-and-elixir/">implementation in 3
languages</a>
It could looks like <a href="https://en.wikipedia.org/wiki/Action_at_a_distance_(computer_programming)">action as a
distance</a>
antipattern but if we explicitly add than is it fine.
It is called publish/subscriber pattern. It allows you to observe one object
and when it’s changed then trigger certain code in other objects that are
subscribing the main object.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module ObservableImplementation
  def observers
    @observers ||= []
  end

  def notify_observers(*args)
    observers.each do |observer|
      observer.update(*args)
    end
  end

  def add_observer(object)
    observers &lt;&lt; object
  end
end

class Task
  include ObservableImplementation
  attr_accessor :counter
  def initialize
    self.counter = 0
  end

  def tick
    self.counter += 1
    notify_observers(counter)
  end
end

class PutsObserver
  def initialize(observable)
    observable.add_observer self
  end

  def update(counter)
    puts "Count has increased by #{counter}"
  end
end

class DotsObserver
  def initialize(observable)
    observable.add_observer self
  end

  def update(counter)
    puts "." * counter
  end
end

task = Task.new
task.tick
DotsObserver.new(task)
task.tick # ..
PutsObserver.new(task)
task.tick # ...
# Count has increased by 3
</code></pre></div></div>

<p>In ruby there are
https://docs.ruby-lang.org/en/2.2.0/Observable.html
where you call <code class="language-plaintext highlighter-rouge">changed</code> and <code class="language-plaintext highlighter-rouge">notify_observers params</code> (which will set changed
to false).
You need to call <code class="language-plaintext highlighter-rouge">task.add_observer DotsObserver.new</code>.</p>

<h2 id="interactor">Interactor</h2>

<p>Service object is similar to Command pattern which is implemented in gem
<a href="https://github.com/collectiveidea/interactor">https://github.com/collectiveidea/interactor</a></p>

<p>When does its single purpose, it affects tis given context</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>context.user = user
context.fail! error: 'Boom'
# .call will swallow exception Interactor::Failure
context.success? # false
</code></pre></div></div>

<p>Before and after hooks for preparing data. Before hooks are invoked in the order
they were defined.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>before do
  context.emails_sent = 0
end
after :reload # note that this will not be run if `fail!` is called
</code></pre></div></div>

<p>Example</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/interactors/authenticate_user.rb
class AuthenticateUser
  include Interactor

  def call
    if user = User.authenticate(context.email, context.password)
      context.user = user
      context.token = user.secret_token
    else
      context.user = User.new email: context.email
      context.user.errors.add :email, 'wrong email or password'
      context.fail!(message: "authenticate_user.failure")
    end
  end
end
</code></pre></div></div>
<p>and use in controller like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  result = AuthenticateUser.call(session_params)
  if result.success?
    session[:user_token] = result.token
    redirect_to dashboard_path
  else
    @user = result.user
    render :new
  end
</code></pre></div></div>

<p>Second type of interactor is Organizer which is used to run other interactors.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class PlaceOrder
  include Interactor::Organizer

  organize CreateOrder, ChargeCard
end
</code></pre></div></div>

<p>In this case then <code class="language-plaintext highlighter-rouge">ChargeCard</code> fails we can use <code class="language-plaintext highlighter-rouge">CreateOrder#rollback</code> method to
revert changes.</p>

<p>In test, you can stub other method calls and cover 100% of unit interactor tests
than write integration or acceptance tests to test wires.</p>

<h1 id="decorator">Decorator</h1>

<p>It is used to decorate object, ie catch method missing and send to object in
initializer on runtime. This is different than subclassing since it happens in
run-time.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/decorators/user_profile_decorator &lt; SimpleDelegator
class UserProfileDecorator &lt; SimpleDelegator
  def model
    __getobj__
  end
  def name
    "#{model.first_name} #{model.last_name}"
  end
end
</code></pre></div></div>
<p>usage</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user = Struct.new(:first_name, :last_name).new("John", "Doe")
decorator = UserProfileDecorator.new(user)
decorator.first_name # =&gt; "John"
decorator.name # =&gt; "John Doe"
</code></pre></div></div>

<p>Gem that supports decorating collections and associations
https://github.com/drapergem/draper</p>

<p>Another use case if for dependency injection, for example you have two pdf
generators than create graphs and you want to create another pdf that include
both graphs.
https://www.honeybadger.io/blog/decoupling-ruby-delegation-dependency-injection/</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class PrawnWrapper &lt; SimpleDelegator
  def initialize(document: nil)
    document ||= Prawn::Document.new(...)
    super(document)
  end
end
</code></pre></div></div>
<p>and call others using injection</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class OverviewReport &lt; PrawnWrapper
  ...
  def render
    sales = SaleReport.new(..., document: self)
    sales.sales_table
    costs = CostReport.new(..., document: self)
    costs.costs_pie_chart
    ...
  end
end
</code></pre></div></div>

<h1 id="facade-pattern">Facade pattern</h1>

<p>page 37</p>

<h1 id="tips">Tips</h1>

<ul>
  <li>Builder pattern is usefull to provide flexibility for example
https://github.com/rails/rails/blob/main/actionview/lib/action_view/helpers/tags/label.rb#L7</li>
</ul>

</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
