<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Sinatra</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Sinatra</h1>
    <p class="meta">May 31, 2018</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#sinatra"><span class="tocnumber">1</span> <span class="toctext">Sinatra</span></a><ul><li class="toc_level-2 toc_section-2"><a href="#sinatra-contrib"><span class="tocnumber">1.1</span> <span class="toctext">Sinatra Contrib</span></a></li><li class="toc_level-2 toc_section-3"><a href="#sinatra-book"><span class="tocnumber">1.2</span> <span class="toctext">Sinatra book</span></a></li><li class="toc_level-2 toc_section-4"><a href="#logger"><span class="tocnumber">1.3</span> <span class="toctext">Logger</span></a></li><li class="toc_level-2 toc_section-5"><a href="#enviroments"><span class="tocnumber">1.4</span> <span class="toctext">Enviroments</span></a></li><li class="toc_level-2 toc_section-6"><a href="#sinatra-sass"><span class="tocnumber">1.5</span> <span class="toctext">Sinatra Sass</span></a></li></ul></li><li class="toc_level-1 toc_section-7"><a href="#activerecord"><span class="tocnumber">2</span> <span class="toctext">Activerecord</span></a></li><li class="toc_level-1 toc_section-8"><a href="#sinatra-tests"><span class="tocnumber">3</span> <span class="toctext">Sinatra tests</span></a></li><li class="toc_level-1 toc_section-9"><a href="#console"><span class="tocnumber">4</span> <span class="toctext">Console</span></a></li><li class="toc_level-1 toc_section-10"><a href="#webpack"><span class="tocnumber">5</span> <span class="toctext">Webpack</span></a></li><li class="toc_level-1 toc_section-11"><a href="#sending-emails"><span class="tocnumber">6</span> <span class="toctext">Sending emails</span></a></li><li class="toc_level-1 toc_section-12"><a href="#timezone"><span class="tocnumber">7</span> <span class="toctext">Timezone</span></a></li><li class="toc_level-1 toc_section-13"><a href="#examples-of-opensource-apps"><span class="tocnumber">8</span> <span class="toctext">Examples of opensource apps</span></a></li><li class="toc_level-1 toc_section-14"><a href="#backbone"><span class="tocnumber">9</span> <span class="toctext">Backbone</span></a></li></ul></td></tr></tbody></table></div><h1 id="sinatra">Sinatra</h1>

<p>Default folder for partials is <code class="language-plaintext highlighter-rouge">views/</code> and name is with <code class="language-plaintext highlighter-rouge">.erb</code> extension.
Default layout file is <code class="language-plaintext highlighter-rouge">views/layout.erb</code>. Always use symbols when referencing
templates, event with subfolder <code class="language-plaintext highlighter-rouge">erb :'subdir/home'</code>. Instance variables are
accessible in templates.
Static files are server from <code class="language-plaintext highlighter-rouge">public/</code> folder.
For stylesheet use <code class="language-plaintext highlighter-rouge">scss :stylesheet, style: :expanded</code>
For coffescript <code class="language-plaintext highlighter-rouge">coffee :index</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># to change default views folder
set :views, settings.root + '/templates'
</code></pre></div></div>

<p>Filter can be used to modify request and response, set instance variable.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>before '/protected/*' do
  authenticate!
end
</code></pre></div></div>

<p>Session and other configuration options</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'securerandom'

enable :sessions
set :session_secret, ENV.fetch('SESSION_SECRET') { SecureRandom.hex(64) }

# to be able to access from other computers, or run with `ruby app.rb -o 0.0.0.0
set :bind, '0.0.0.0'

get '/:value' do
  session['val'] = params['value']
end
</code></pre></div></div>

<p>Redirect with <code class="language-plaintext highlighter-rouge">redirect to('/foo?bar=42')</code>.
Cache-control header is set with <code class="language-plaintext highlighter-rouge">cache_control :public</code>. Rack cache can be used
for caching.</p>

<p>Top level application assumes a micro app style configuration (a single app
file, public and views folders).
If you want modular style (run is disabled by default) you can inherit from
<code class="language-plaintext highlighter-rouge">Sinatra::Base</code> (logging and inline templates disabled by default).
If you want similar to classic style, you can write with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'sinatra/base'

class MyApp &lt; Sinatra::Application
  get '/' do
    'Hello world!'
  end
end
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># config.ru
require './app'
run MyApp
</code></pre></div></div>

<p>Run with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle exec rackup -p- 4567
</code></pre></div></div>

<h2 id="sinatra-contrib">Sinatra Contrib</h2>

<p>http://sinatrarb.com/contrib/</p>

<p>Reloading in Sinatra can be done with <code class="language-plaintext highlighter-rouge">rerun</code> http://sinatrarb.com/faq.html or
with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'sinatra/reloader' if development?
</code></pre></div></div>

<h2 id="sinatra-book">Sinatra book</h2>

<p>http://sinatra-org-book.herokuapp.com/</p>

<h2 id="logger">Logger</h2>

<p>Inside <code class="language-plaintext highlighter-rouge">get</code> actions you can define helper and use request logger</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get '/' do
  logger.info 'get_root'
end
</code></pre></div></div>

<p>For use in templates you can define helpers</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helpers do
  def logger
    request.logger
  end
end
</code></pre></div></div>

<p>To enable logging to a file use as well to stdout. Problem is that I do not see
custom logs with <code class="language-plaintext highlighter-rouge">logger.info params</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># http://recipes.sinatrarb.com/p/middleware/rack_commonlogger
configure do
  # logging is enabled by default in classic style applications,
  # so `enable :logging` is not needed
  # create folder `mkdir log` and gitignore with `touch log/.keep`
  file = File.new("#{settings.root}/log/#{settings.environment}.log", 'a+')
  file.sync = true
  use Rack::CommonLogger, file
end
</code></pre></div></div>

<p>For use in other places you can create global variable (I do not know how to
access logger outside of actions). But the problem here is that I do not see
messages in file (but see in STDOUT on developemnt) when I use <code class="language-plaintext highlighter-rouge">$logger.info</code>
but <code class="language-plaintext highlighter-rouge">logger.info</code> inside actions works fine.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># https://stackoverflow.com/questions/5995854/logging-in-sinatra
configure :production do
  $logger = Logger.new('log/common.log', 'hourly')
  $logger.level = Logger::WARN

  # Spit stdout and stderr to a file during production
  # in case something goes wrong
  $stdout.reopen("log/#{settings.environment}.log", 'w')
  $stdout.sync = true
  $stderr.reopen($stdout)
end

configure :development do
  $logger = Logger.new(STDOUT)
end
</code></pre></div></div>

<p>https://github.com/minodes/sinatra-logger</p>

<h2 id="enviroments">Enviroments</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>APP_ENV=production ruby my_app.rb
# or
ruby my_app.rb -e production
</code></pre></div></div>

<h2 id="sinatra-sass">Sinatra Sass</h2>

<p>To add support to scss you can add <code class="language-plaintext highlighter-rouge">gem 'sass'</code> and if using modular style</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># config.ru
require 'sass/plugin/rack'

Sass::Plugin.options[:style] = :compressed
use Sass::Plugin::Rack
</code></pre></div></div>

<p>or is using classis style, run</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sass --watch public/assets/stylesheets/sass:public/assets/stylesheets
</code></pre></div></div>

<p>and include in layout</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;link rel="stylesheet" href="/assets/stylesheets/switch.css"&gt;
</code></pre></div></div>

<h1 id="activerecord">Activerecord</h1>

<p>https://github.com/janko-m/sinatra-activerecord</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Gemfile
gem 'sinatra-activerecord'
gem 'sqlite3'
gem 'rake'

# app.rb
require 'sinatra/activerecord'
set :database, adapter: 'sqlite3', database: "#{__dir__}/db/home_automation.sqlite3"

# Rakefile
require 'sinatra/activerecord/rake'

namespace :db do
  task :load_config do
    require './app'
  end
end
</code></pre></div></div>

<p>Note that we use <code class="language-plaintext highlighter-rouge">__dir__</code> to get app_file folder so it works fine when we run
the app from non root path <code class="language-plaintext highlighter-rouge">ruby some/path/to/app.rb</code></p>

<p>And you can create tables</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake db:create_migration NAME=create_temperatures
</code></pre></div></div>

<p>and models</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Temperature &lt; ActiveRecord::Base
end
</code></pre></div></div>

<p>On raspberri pi you should install sqlite3</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get autoremove; sudo apt-get autoclean;sudo apt-get clean
sudo apt-get update; sudo apt-get -y dist-upgrade; sudo apt-get install sqlite3
sudo apt-get install libsqlite3-dev
</code></pre></div></div>

<h1 id="sinatra-tests">Sinatra tests</h1>

<p>https://www.sitepoint.com/build-sinatra-api-using-tdd-heroku-continuous-integration-travis/</p>

<h1 id="console">Console</h1>

<p>You can access console like <code class="language-plaintext highlighter-rouge">rails c</code> with https://github.com/sickill/racksh</p>

<h1 id="webpack">Webpack</h1>

<p>You can use javascript with hot reloading using https://github.com/kopylovvlad/sinatra-webpack-vuejs-template</p>

<h1 id="sending-emails">Sending emails</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Gemfile
gem 'mail'

# my_mail.rb
require 'mail'

# test with
# rvmsudo ruby -e "load 'my_mail.rb';MyMail.send()"
# using sudo requires -E to pass enviroment variables
# sudo -E ruby -e "load 'my_mail.rb';MyMail.send()"

GMAIL_EMAIL = ENV['GMAIL_EMAIL'] # ENV['rvm_EMAIL_USER_NAME'],
GMAIL_PASSWORD = ENV['GMAIL_PASSWORD'] # ENV['rvm_EMAIL_PASSWORD'],
EXCEPTION_RECIPIENTS = ENV['EXCEPTION_RECIPIENTS'] # ENV['rvm_EMAIL_RECIPIENT_EMAIL']

options = {
  address: 'smtp.gmail.com',
  port: 587,
  user_name: GMAIL_EMAIL,
  password: GMAIL_PASSWORD,
}
# puts options

Mail.defaults do
  delivery_method :smtp, options
end

module MyMail
  def self.send(subject: 'alert', text: 'hi', attachment: nil)
    puts "Send email #{text} #{attachment}"
    Mail.deliver do
      to EXCEPTION_RECIPIENTS
      from GMAIL_EMAIL
      subject subject
      body text
      add_file attachment unless attachment.nil?
    end
  rescue StandardError =&gt; e
    puts "MyMail.send failed #{e}"
  end
end
</code></pre></div></div>

<p>Usage in <code class="language-plaintext highlighter-rouge">app.rb</code> is like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MyMail.send attachment: image_file, text: S3.getUrl(video_file)
</code></pre></div></div>

<h1 id="timezone">Timezone</h1>

<p>In pure ruby, you can show UTC time in your time zone by specifying offset</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Time.now.localtime("+02:00")
</code></pre></div></div>

<h1 id="examples-of-opensource-apps">Examples of opensource apps</h1>

<ul>
  <li>https://github.com/swanson/stringer Nice Sinatra ActiveRecord Backbone app. It</li>
  <li>https://lbrito1.github.io/blog/2020/02/repurposing-android.html Running
sinatra on mobile phone</li>
</ul>

<h1 id="backbone">Backbone</h1>

<p>https://backbonejs.org/</p>

</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
