<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Ruby Http Client</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Ruby Http Client</h1>
    <p class="meta">May 18, 2018</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#nethttp"><span class="tocnumber">1</span> <span class="toctext">Net::HTTP</span></a></li><li class="toc_level-1 toc_section-2"><a href="#snippets"><span class="tocnumber">2</span> <span class="toctext">Snippets</span></a></li><li class="toc_level-1 toc_section-3"><a href="#httparty"><span class="tocnumber">3</span> <span class="toctext">HTTParty</span></a></li><li class="toc_level-1 toc_section-4"><a href="#open-uri"><span class="tocnumber">4</span> <span class="toctext">Open URI</span></a></li><li class="toc_level-1 toc_section-5"><a href="#restclient"><span class="tocnumber">5</span> <span class="toctext">RestClient</span></a></li><li class="toc_level-1 toc_section-6"><a href="#faraday"><span class="tocnumber">6</span> <span class="toctext">Faraday</span></a></li><li class="toc_level-1 toc_section-7"><a href="#debug-requests"><span class="tocnumber">7</span> <span class="toctext">Debug requests</span></a></li><li class="toc_level-1 toc_section-8"><a href="#outgoing-http-logs"><span class="tocnumber">8</span> <span class="toctext">Outgoing http logs</span></a></li><li class="toc_level-1 toc_section-9"><a href="#nokogiri"><span class="tocnumber">9</span> <span class="toctext">Nokogiri</span></a></li></ul></td></tr></tbody></table></div><h1 id="nethttp">Net::HTTP</h1>

<p>Http client https://docs.ruby-lang.org/en/2.0.0/Net/HTTP.html
Set uri</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uri = URI('http://www.example.com/search.cgi')

# add some params to uri
params = { :limit =&gt; 10, :page =&gt; 3 }
uri.query = URI.encode_www_form(params)
</code></pre></div></div>

<p>Simple one liner <code class="language-plaintext highlighter-rouge">Net::HTTP.get</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># you can get body (without status)
response_body = Net::HTTP.get uri
# but I prefer to fetch also the status
response = Net::HTTP.get_response uri
response.body # =&gt; &lt;html&gt;...
</code></pre></div></div>

<p>Simple one liner <code class="language-plaintext highlighter-rouge">Net::HTTP.post_form</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>response = Net::HTTP.post_form(uri, 'q' =&gt; ['ruby', 'perl'], 'max' =&gt; '50')
</code></pre></div></div>

<p>Longer format is with <code class="language-plaintext highlighter-rouge">HTTP.new</code> or <code class="language-plaintext highlighter-rouge">HTTP.start</code> block syntax (better since you
do not need to call <code class="language-plaintext highlighter-rouge">http.start</code> and it automatically close connection). Longer
means than you create separate <code class="language-plaintext highlighter-rouge">request</code> object and use with http connection to
make request</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http = Net::HTTP.new(uri.host, uri.port)
request = Net::HTTP::Get.new '/'
response = http.request request
</code></pre></div></div>

<p>For https you need to enable ssl. If uri is https but you do not use ssl than
you will get following error <code class="language-plaintext highlighter-rouge">EOFError: end of file reached</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># if you are using https
http.use_ssl = true
# or the best is to use
http.use_ssl = (uri.scheme == "https")
# you can also disable verify ssl with
http.verify_mode = OpenSSL::SSL::VERIFY_NONE

# or in block mode

res = Net::HTTP.start(uri.host, use_ssl: true, verify_mode: OpenSSL::SSL::VERIFY_NONE) {|http| http.request(req) }
</code></pre></div></div>

<p>You can define timeouts</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http.open_timeout = 1
# when response takes to much time
http.read_timeout = 3
# when you POST a lot of data
http.write_timeout = 10
</code></pre></div></div>

<p>On request object you can set headers</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>header = {
  'Content-Type': 'application/json',
  'Authorization': "Bearer #{key}",
}
request = Net::HTTP::Post.new(uri, header)
# or
request['Content-Type'] = 'text/json'
# or
http = Net::HTTP.new uri.host, uri.port
http.use_ssl = true
res = http.post uri.path, content.to_json, 'Content-type' =&gt; 'application/json', 'Accept' =&gt; 'text/json, application/json'
</code></pre></div></div>

<p>On response you can read headers</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>response.each_key {|k| res[k]}
{"server"=&gt;["nginx/1.6.2"], "date"=&gt;["Wed, 17 Oct 2018 22:22:51 GMT"], "content-type"=&gt;["text/html"], "content-length"=&gt;["184"], "connection"=&gt;["close"], "location"=&gt;["https://paytm.com/business/payments"]}
</code></pre></div></div>

<p>Set Form data</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>request.set_form_data(user: { name: 'Duke' })
# or
request.body = { user: { name: 'Duke' } }.to_json
# or plain text when request['Content-Type'] =
# 'application/x-www-form-urlencoded' in Postman there is no json curly braces
# this is not the same as to_json
request.body = 'grant_type=client_credentials'
</code></pre></div></div>

<p>Basic authentication header</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>request.basic_auth username, password
# or
request['Authorization'] = "Basic #{Base64.strict_encode64("#{consumer_key}:#{consumer_secret}")}"
</code></pre></div></div>

<h1 id="snippets">Snippets</h1>

<p>Handle redirection</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'net/http'
require 'uri'

def fetch(uri_str, limit = 10)
  # You should choose better exception.
  raise ArgumentError, 'HTTP redirect too deep' if limit == 0

  uri = URI.parse(uri_str)
  request = Net::HTTP::Get.new(uri, { 'User-Agent' =&gt; 'Mozilla/5.0 (etc...)' })
  response = Net::HTTP.start(uri.host, uri.port) { |http| http.request(request) }
  case response
  when Net::HTTPSuccess     then response
  when Net::HTTPRedirection then fetch(response['location'], limit - 1)
  else
    response.error!
  end
end

print fetch('http://www.ruby-lang.org/')
</code></pre></div></div>

<h1 id="httparty">HTTParty</h1>

<p>This gem is a little bit simpler than plain Net::HTTP (it is wrapper around
net/http).
It does not support multipart requests (needed for uploading a file)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require "HTTParty"

html = HTTParty.get("https://en.wikipedia.org/wiki/Douglas_Adams")
# =&gt; "&lt;!DOCTYPE html&gt;\n" + "&lt;html class=\"client-nojs\" lang=\"en\" dir=\"ltr\"&gt;\n" + "&lt;head&gt;\n" + "&lt;meta charset=\"UTF-8\"/&gt;\n" + "&lt;title&gt;Douglas Adams - Wikipedia&lt;/title&gt;\n" + ...
</code></pre></div></div>

<h1 id="open-uri">Open URI</h1>

<p>In standard ruby library</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'open-uri'

html = open("https://en.wikipedia.org/wiki/Douglas_Adams")
##&lt;File:/var/folders/zl/8
</code></pre></div></div>

<h1 id="restclient">RestClient</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'rest-client'
RestClient.post '/profile', file: File.new('photo.jpg', 'rb')
</code></pre></div></div>

<h1 id="faraday">Faraday</h1>

<p>Faraday allows you to choose any implemetnation (net/http, typhoeus)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'faraday'
conn =
Faraday.new do |f|
  f.request :multipart
  f.request :url_encoded
  f.adapter :net_http
end
file_io = Faraday::UploadIO.new('photo.jpg', 'image/jpeg')
conn.post('http://example.com/profile', file: file_io)
</code></pre></div></div>

<h1 id="debug-requests">Debug requests</h1>

<p>Ruby one liner http server</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruby -rsocket -e "trap('SIGINT') { exit }; Socket.tcp_server_loop(8080) { |s,_| puts s.readpartial(1024); puts; s.puts 'HTTP/1.1 200'; s.close }"
</code></pre></div></div>

<p>And open <a href="http://localhost:8080/">http://localhost:8080/</a> to see all headers and body</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET / HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.32 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9,sr;q=0.8,hr;q=0.7,bs;q=0.6,da;q=0.5,pt;q=0.4,bg;q=0.3
Cookie: _session_id=...
</code></pre></div></div>

<h1 id="outgoing-http-logs">Outgoing http logs</h1>

<p>https://github.com/trusche/httplog</p>

<h1 id="nokogiri">Nokogiri</h1>

<p>For parsing html you can look at post for scraping capybara selenium.</p>
</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
