<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Hotwire Turbo Websockets Actioncable</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Hotwire Turbo Websockets Actioncable</h1>
    <p class="meta">May 24, 2018</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#hotwire"><span class="tocnumber">1</span> <span class="toctext">Hotwire</span></a></li><li class="toc_level-1 toc_section-2"><a href="#turbo-drive"><span class="tocnumber">2</span> <span class="toctext">Turbo drive</span></a></li><li class="toc_level-1 toc_section-3"><a href="#devise-fix"><span class="tocnumber">3</span> <span class="toctext">Devise fix</span></a></li><li class="toc_level-1 toc_section-4"><a href="#sample-apps"><span class="tocnumber">4</span> <span class="toctext">Sample apps</span></a></li></ul></td></tr></tbody></table></div><h1 id="hotwire">Hotwire</h1>

<p>Note that Action Cable is deprecated in favor of hotwire. Here is old example
https://github.com/duleorlovic/premesti.se/commit/ad7cefe192cbbb6b97c13860eb6410d1b02cb5fc</p>

<p>Example of local hotwire folders
~/rails/tmp/turbo_modal_boostrap
<em>** ~/rails/tmp/hotwire **</em>
~/rails/tmp/rails_forms
~/rails/nested-habtm-forms-for-associations-in-rails</p>

<p>https://hotwire.dev/</p>

<p>GET are HTML and PATCH/POST are TURBO_STREAM requests for ALL forms on the page.
You should be able to edit inline twice double (at this stage, without importing
turbo in jsâ€¦ if you import than add turbo_stream.replace response)
There is an error <code class="language-plaintext highlighter-rouge">Error: Form responses must redirect to another location</code> if
we submit a form without <code class="language-plaintext highlighter-rouge">turbo_stream_tag</code>
https://github.com/hotwired/turbo-rails/issues/12#issuecomment-749857225</p>

<p>To run javascript on when turbo frame is loaded you can listen to events
https://turbo.hotwire.dev/reference/events
or you can use stimulus controller connect event.</p>

<p>Note that you do not have access to request when we broadcast over websocket so
to differentiate between current_user you need to use data attributes or meta
tag with <code class="language-plaintext highlighter-rouge">current_user.id</code> and add class in js if matches <code class="language-plaintext highlighter-rouge">author.id</code>
https://discuss.hotwire.dev/t/how-to-pass-current-user-id-to-a-controller/287/4
https://discuss.hotwire.dev/t/building-a-real-time-chat-system-having-trouble-with-chat-bubble-styling/2534/6</p>

<p>Another example is to automatically open modal, and close on submit</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= turbo_frame_tag 'modal' do %&gt;
  &lt;div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-controller='start-modal-on-connect'&gt;
    &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close"&gt; &lt;span aria-hidden="true"&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
    &lt;%= button_to 'Ok', interests_path(to_member_profile_id: @interest.to_member_profile.id), class: 'btn btn-primary mb-3', 'data-action': 'start-modal-on-connect#close' %&gt;

// app/javascript/controllers/start_modal_on_connect_controller.js
import { Controller } from 'stimulus'

export default class extends Controller {
  connect() {
    console.log('start-modal-on-connect')
    $(this.element).modal()
  }

  close() {
    console.log('start-modal-on-connect#close')
    $(this.element).modal('hide')
  }
}
</code></pre></div></div>
<p>Usually when modal is rendered from server, I use target value to <code class="language-plaintext highlighter-rouge">target
"modal-123"</code> and inside modal I use <code class="language-plaintext highlighter-rouge">target: "express_interest_buttons-123"</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/views/interets/index.html.erb
            &lt;%= turbo_frame_tag "modal-#{member_profile.id}", target: "express_interest_buttons-#{member_profile.id}" %&gt;
            &lt;%= render 'interests/express_interest_buttons', member_profile: member_profile %&gt;
              which is:
              &lt;%# turbo_frame_tag "express_interest_buttons-#{member_profile.id}", target: "modal-#{member_profile.id}" do %&gt;
                &lt;%= link_to new_cancel_interest_path(interest), class: "btn btn-primary interest-shown interestbtn" do %&gt;

# app/controllers/interests_controller.rb
  def new_cancel
    authorize @interest
  end

  def cancel
    authorize @interest
    @interest.cancelled!
    render partial: 'express_interest_buttons', locals: { member_profile: @interest.to_member_profile }
  end

# app/views/interes/new_cancel.html.erb
&lt;%= turbo_frame_tag "modal-#{@interest.to_member_profile.id}", target: "express_interest_buttons-#{@interest.to_member_profile.id}" do %&gt;
  &lt;%= button_to 'Ok', cancel_interest_path(@interest), class: 'btn btn-primary mb-3', 'data-action': 'start-modal-on-connect#close', method: :patch %&gt;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
// app/views/layouts/application.html.erb
    &lt;meta content="Free Matrimonial website for Indian Community in US &amp; Canada" name="description" /&gt;

// app/javascript/controllers/message_chat_controller.js
import { Controller } from 'stimulus'

export default class extends Controller {
  // &lt;li class="send-msg" data-controller='single-message' data-single-message-member-profile-id='&lt;%= message.member_profile.id %&gt;' hidden&gt;
  connect() {
    console.log('message-chat#connect')
    if (this.currentMemberProfileId == this.memberProfileId)
      this.element.classList.add('message--righted')

    this.element.hidden = false
  }

  get currentMemberProfileId() {
    return document.querySelector("[name=current-member-profile-id]").content
  }

  get memberProfileId() {
    return this.data.get('memberProfileId')
  }
}
</code></pre></div></div>

<p>Redirect inside turbo_frame_tag
  https://discuss.hotwire.dev/t/form-redirects-not-working-as-expected/2058/6
Solution is using stimulus event
https://github.com/hotwired/turbo/issues/138#issuecomment-802171574</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// app/javascript/controllers/turbo_form_submit_redirect_controller.js
import { Controller } from "stimulus"
import * as Turbo from "@hotwired/turbo"

export default class extends Controller {
  connect() {
    this.element.addEventListener("turbo:submit-end", (event) =&gt; {
      this.next(event)
    })
  }

  next(event) {
    if (event.detail.success) {
      Turbo.visit(event.detail.fetchResponse.response.url)
    }
  }
}
</code></pre></div></div>
<p>Usage is with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;turbo-frame id='phone' data-controller='turbo-form-submit-redirect'&gt;
</code></pre></div></div>
<p>note that it needs to be on first frame in case you have steps that replaces
several templates</p>

<p>Error when adding stimulus controller that use importing in js like
<code class="language-plaintext highlighter-rouge">import * as Turbo from "@hotwired/turbo"</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Uncaught DOMException: Failed to execute 'define' on 'CustomElementRegistry': the name "turbo-frame" has already been used with this registry
</code></pre></div></div>
<p>and I see that <code class="language-plaintext highlighter-rouge">cable</code> connection is not created when this error is present.
Solution is to import in main pack anywhere (below or above <code class="language-plaintext highlighter-rouge">import
"controllers"</code>). Error will remain, but at least <code class="language-plaintext highlighter-rouge">cable</code> connection is created</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app/javascript/packs/application.js
// without this line, cable websocket connection will fail if you use turbo in
// stimulus controllers: import * as Turbo from "@hotwired/turbo"
import '@hotwired/turbo-rails'
</code></pre></div></div>

<p>Note that when you include turbo in js than default html response has double
request problem (search above for <code class="language-plaintext highlighter-rouge">double</code>)</p>

<p>WS websocket tab in Network tab is showing <code class="language-plaintext highlighter-rouge">Websocket</code> connection when you are
running <code class="language-plaintext highlighter-rouge">bin/webpack-dev-server</code> server which is sending updates using that
connnection.</p>

<h1 id="turbo-drive">Turbo drive</h1>

<p>Once installed it is enabled for all links. To disable for particular link you
can use
https://turbo.hotwired.dev/handbook/drive#disabling-turbo-drive-on-specific-links-or-forms</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;a href="/" data-turbo="false"&gt;Disabled&lt;/a&gt;
</code></pre></div></div>

<p>Group disable does not work in Firefox (probably since bubling is not the same)
so better is to disable each link</p>

<h1 id="devise-fix">Devise fix</h1>

<p>https://gorails.com/episodes/devise-hotwire-turbo</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/controllers/turbo_controller.rb
class TurboController &lt; ApplicationController # rubocop:todo Lint/ConstantDefinitionInBlock
  class Responder &lt; ActionController::Responder
    def to_turbo_stream
      controller.render(options.merge(formats: :html))
    rescue ActionView::MissingTemplate =&gt; e
      raise e if get?

      if has_errors? &amp;&amp; default_action
        render rendering_options.merge(formats: :html, status: :unprocessable_entity)
      else
        redirect_to navigation_location
      end
    end
  end

  self.responder = Responder
  respond_to :html, :turbo_stream
end

# config/initializers/devise.rb
# https://gorails.com/episodes/devise-hotwire-turbo
Rails.application.reloader.to_prepare do
  class TurboFailureApp &lt; Devise::FailureApp # rubocop:todo Lint/ConstantDefinitionInBlock
    def respond
      if request_format == :turbo_stream
        redirect
      else
        super
      end
    end

    def skip_format?
      %w[html turbo_stream */*].include? request_format.to_s
    end
  end
end

Devise.setup do |config|

  # ==&gt; Controller configuration
  # Configure the parent class to the devise controllers.
  config.parent_controller = 'TurboController'

  # ==&gt; Warden configuration
  config.warden do |manager|
    manager.failure_app = TurboFailureApp
  end
end
</code></pre></div></div>

<h1 id="sample-apps">Sample apps</h1>

<p>bootstrap modal https://github.com/dparfrey/turbo_modal_bootstrap
twitter https://github.com/gorails-screencasts/hotwire-twitter-clone
todoapp https://github.com/johnreitano/foo2</p>

<p>https://www.driftingruby.com/episodes/hotwire
https://www.youtube.com/watch?v=b7dx1Yt3FzU
todo https://www.ombulabs.com/blog/rails/hotwire/hotwire-demo.html
https://evilmartians.com/chronicles/hotwire-reactive-rails-with-no-javascript
https://blog.engineyard.com/the-ruby-unbundled-series-why-you-should-check-out-hotwire-now?reddit</p>
</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
