<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Nested Habtm Forms For Associations In Rails</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Nested Habtm Forms For Associations In Rails</h1>
    <p class="meta">Dec 1, 2018</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#html-form-input"><span class="tocnumber">1</span> <span class="toctext">HTML Form Input</span></a></li><li class="toc_level-1 toc_section-2"><a href="#nested-forms"><span class="tocnumber">2</span> <span class="toctext">Nested forms</span></a></li><li class="toc_level-1 toc_section-3"><a href="#multiple-form-submit-buttons-for-different-actions"><span class="tocnumber">3</span> <span class="toctext">Multiple form submit buttons for different actions</span></a></li><li class="toc_level-1 toc_section-4"><a href="#rails-and-forms"><span class="tocnumber">4</span> <span class="toctext">Rails and Forms</span></a><ul><li class="toc_level-2 toc_section-5"><a href="#input-outside-of-a-form"><span class="tocnumber">4.1</span> <span class="toctext">Input outside of a form</span></a></li><li class="toc_level-2 toc_section-6"><a href="#dialog-element"><span class="tocnumber">4.2</span> <span class="toctext">Dialog element</span></a></li><li class="toc_level-2 toc_section-7"><a href="#fieldset--legend"><span class="tocnumber">4.3</span> <span class="toctext">Fieldset &amp; Legend</span></a></li></ul></li><li class="toc_level-1 toc_section-8"><a href="#input-attributes"><span class="tocnumber">5</span> <span class="toctext">Input Attributes</span></a><ul><li class="toc_level-2 toc_section-9"><a href="#autosuggestion"><span class="tocnumber">5.1</span> <span class="toctext">Autosuggestion</span></a></li><li class="toc_level-2 toc_section-10"><a href="#autocomplete"><span class="tocnumber">5.2</span> <span class="toctext">Autocomplete</span></a></li><li class="toc_level-2 toc_section-11"><a href="#autofocus"><span class="tocnumber">5.3</span> <span class="toctext">Autofocus</span></a></li><li class="toc_level-2 toc_section-12"><a href="#disabled"><span class="tocnumber">5.4</span> <span class="toctext">Disabled</span></a></li><li class="toc_level-2 toc_section-13"><a href="#required"><span class="tocnumber">5.5</span> <span class="toctext">Required</span></a></li><li class="toc_level-2 toc_section-14"><a href="#tabindex"><span class="tocnumber">5.6</span> <span class="toctext">Tabindex</span></a></li><li class="toc_level-2 toc_section-15"><a href="#placeholder"><span class="tocnumber">5.7</span> <span class="toctext">Placeholder</span></a></li></ul></li><li class="toc_level-1 toc_section-16"><a href="#select"><span class="tocnumber">6</span> <span class="toctext">Select</span></a></li></ul></td></tr></tbody></table></div><h1 id="html-form-input">HTML Form Input</h1>

<p>Start from basic docs for html
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input">input</a>
and <a href="https://www.w3.org/TR/html401/interact/forms.html">forms</a>
https://html.spec.whatwg.org/multipage/forms.html
The most important attribute is</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code> identify the input in data submitted with the form. If not provided,
this input will not we included.</li>
  <li><code class="language-plaintext highlighter-rouge">type</code> to identify a input type that input element represents</li>
  <li><code class="language-plaintext highlighter-rouge">value</code> when specified, it is initial value. For unselected <code class="language-plaintext highlighter-rouge">checkbox</code> or
<code class="language-plaintext highlighter-rouge">radio</code> it is not submitted. They have default value <code class="language-plaintext highlighter-rouge">on</code></li>
</ul>

<p>There is a lot of input types (like <code class="language-plaintext highlighter-rouge">color</code> which will popup
color picker) but here we will focus on:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">text</code> single line text field (line breaks are automatically removed). In
rails <code class="language-plaintext highlighter-rouge">f.text_field :name, size: 2</code> or <code class="language-plaintext highlighter-rouge">f.number_field :num, min: 1, max: 9</code>
to use shorter width, <code class="language-plaintext highlighter-rouge">f.time_field :t</code> will generate <code class="language-plaintext highlighter-rouge">type='time'</code> but
<code class="language-plaintext highlighter-rouge">f.time_select :t</code> will generate select options instead</li>
  <li><code class="language-plaintext highlighter-rouge">checkbox</code> allowing single value to be selected/deselected. <code class="language-plaintext highlighter-rouge">f.check_box
:name</code> will submit <code class="language-plaintext highlighter-rouge">'0'</code> in case it is not selected, but <code class="language-plaintext highlighter-rouge">check_box_tag :name</code>
will not.</li>
  <li><code class="language-plaintext highlighter-rouge">hidden</code> it is not displayed, but value is submitted</li>
  <li><code class="language-plaintext highlighter-rouge">radio</code> allowing a single value to be selected out of multiple choices, <code class="language-plaintext highlighter-rouge">f.radio_button :overnight_rate, 1, label: 'Yes', inline: true, checked: f.object.overnight_rate</code></li>
  <li><code class="language-plaintext highlighter-rouge">submit</code> ie <code class="language-plaintext highlighter-rouge">&lt;input type='submit'</code> acts like a button that submits the form.
You can use <code class="language-plaintext highlighter-rouge">&lt;button&gt;OK&lt;/button&gt;</code> (default is <code class="language-plaintext highlighter-rouge">type='submit'</code>) instead (button
that does not submit the form is <code class="language-plaintext highlighter-rouge">&lt;button type='button'&gt;</code>.</li>
</ul>

<p>Now start with what Rails provides https://api.rubyonrails.org/v5.2.1/classes/ActionView/Helpers/FormHelper.html#method-i-fields_for</p>

<p>Similar to nested forms, you can have select tag with multiple options (habtm
relation) so we can update without ajax (it is created in one request).
Since in html forms we can only send value or array</p>
<ul>
  <li>single value (html <code class="language-plaintext highlighter-rouge">name='name'</code>) In rails <code class="language-plaintext highlighter-rouge">text_field_tag :name</code> and
we got <code class="language-plaintext highlighter-rouge">params[:name] # =&gt; 'Duke'</code></li>
  <li>array (html <code class="language-plaintext highlighter-rouge">name='ids[]'</code>) In rails <code class="language-plaintext highlighter-rouge">text_field_tag 'ids[]'</code> or
<code class="language-plaintext highlighter-rouge">f.text_field :ids, name: 'ids[]'</code> and we got <code class="language-plaintext highlighter-rouge">params[:ids] #=&gt; [1,2]</code> Note
that you need to permit array <code class="language-plaintext highlighter-rouge">params.permit(ids: [])</code>. When you remove all
elements from DOM than nothing is send to server, so you need to add empty and
reject empty values
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>before_save :clear_unchecked_values
def clear_unchecked_values
  self.custom_sign_up_labels = custom_sign_up_labels.reject(&amp;:blank?)
  true
end
</code></pre></div>    </div>
  </li>
  <li>
    <p>hash is when you nest inside brackets and define specific key, for example
<code class="language-plaintext highlighter-rouge">name='user[name]</code>, in rails <code class="language-plaintext highlighter-rouge">f.text_field :name</code> (when f.object.class ==
User).  Note that you need to permit each key.</p>

    <p>Hash values can also be string, array or another hash. For array (html
<code class="language-plaintext highlighter-rouge">name='user[ids][]</code>) in rails you can use <code class="language-plaintext highlighter-rouge">f.text_field :ids, name:
'user[ids][]</code> (<code class="language-plaintext highlighter-rouge">f.text_field :ids</code> does not make sense since there are
multiple input fields, so better is to use <code class="language-plaintext highlighter-rouge">text_field_tag :name</code>, but if you
are using strong params, than you need to put inside model name, for example
<code class="language-plaintext highlighter-rouge">"#{f.object.class.name.underscore}[ids][]"</code>) we got
<code class="language-plaintext highlighter-rouge">params[:user][:ids] #=&gt; [1,2]</code>.  Hash with hash values rails use it for
<code class="language-plaintext highlighter-rouge">fields_for &amp; accepts_nested_attributes_for</code> html
<code class="language-plaintext highlighter-rouge">name='user[posts_attributes][0][id]</code> and we got
<code class="language-plaintext highlighter-rouge">params[:user][:posts_attributes]["0"][:id]</code>. Note that you need to permit
each key <code class="language-plaintext highlighter-rouge">params.require(:user).permit(posts_attributes: [:id,:name])</code></p>
  </li>
</ul>

<p>So for habtm or has_many through, we need to mark for destruction and than add
params</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># modal
class Book &lt; ApplicationRecord
  has_many :book_topics
  has_many :topics, through: :book_topics
  accepts_nested_attributes_for :book_topics
end
class BookTopic &lt; ApplicationRecord
  belongs_to :book
  belongs_to :topic
end

# html
      &lt;%= f.select :topic_ids, options_from_collection_for_select(Topic.all, :id, :topic_name, -&gt; (topic) { @book.book_topics.map(&amp;:topic).include? topic }), {}, multiple: true %&gt;

# controller
    @book.book_topics.each &amp;:mark_for_destruction
    book_topics_params = {
      book_topics_attributes: params[:book][:topic_ids].map {|id| { topic_id: id } }
    }
    if @book.update _book_params.merge book_topics_params

</code></pre></div></div>

<h1 id="nested-forms">Nested forms</h1>

<p><a href="http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html">http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html</a>
If you want to use nested forms like question and answers, good approach is to
<code class="language-plaintext highlighter-rouge">create!</code> on new action and redirect to edit. That way you have <code class="language-plaintext highlighter-rouge">question_id</code>.
For new questions or delete questions, you can simply use ajax. So start with
<code class="language-plaintext highlighter-rouge">rails g scaffold questions title;rails g model answers question:references</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># models/question.rb
class Question &lt; ActiveRecord::Base
  has_many :answers, dependent: :destroy
  accepts_nested_attributes_for :answers, allow_destroy: true
end

# questions/_form.html.erb
  &lt;div id="answers"&gt;
    &lt;h2&gt;Answers&lt;/h2&gt;
    &lt;% @question.answers.each do |answer| %&gt;
      &lt;%= render partial: 'answer', locals: { question_form: f, answer: answer } %&gt;
    &lt;% end %&gt;
  &lt;/div&gt;
  &lt;%= link_to "Create new answers", create_answer_question_path, remote: true,
  method: :post %&gt;

# questions/_answer.html.erb
&lt;%#
  question_form - we need this because we don't want to generate &lt;form&gt; tags
                - we need just fields
  answer - target answer

  we hard code "answers_attributes[]" because
  when we use fields_for :answer, than when we use ajax `new` twice we got same
  name for different records
  question[answers_attributes][0][id] (value 111)
  question[answers_attributes][0][id] (value 222)
  and only latest will be considered
  it is because uniq number is reset for each fields_for
  this sequential "0", "1" is used so you can show `fields_for :answers` for
  existing and new answers (which does not have id) so they are all separated
  with hard coded `answers_attributes[]` it is
  question[answers_attributes][111][id] (value 111)
  question[answers_attributes][222][id] (value 222)
  but for unsaved objects it will be
  question[answers_attributes][][id] (value nil)
  so there are two solutions:
    * always create objects and than render form
    * add fake id (used for key), but not provide a hidden input field 'id'
%&gt;
&lt;%= question_form.fields_for "answers_attributes[]", answer do |ff| %&gt;
  &lt;div class="field"&gt;
    &lt;%= ff.hidden_field :id %&gt;
    &lt;%= ff.text_field :content, placeholder: "Answer" %&gt;
    &lt;%= ff.number_field :score, placeholder: 'Score' %&gt;
    &lt;%= ff.number_field :position, placeholder: 'Position' %&gt;
    &lt;%= link_to "Destroy", destroy_answer_question_path(answer.question, answer_id: answer.id), remote: true, method: :delete %&gt;
  &lt;/div&gt;
&lt;% end %&gt;

# questions/create_answer.js.erb
&lt;% output = nil %&gt;
&lt;% form_for(@question) do |f| %&gt;
  &lt;% output = j render partial: 'answer', locals: { question_form: f, answer:
  @answer } %&gt;
  &lt;% end %&gt;
$('#answers').append('&lt;%= output %&gt;');

# config/routes.rb
  resources :questions do
    member do
      post :create_answer
      delete :destroy_answer
    end
  end

# controllers/questions_controller.js
  def create_answer
    @answer = @question.answers.create!
  end

  def destroy_answer
    @answer = @question.answers.find(params[:answer_id])
    @answer.destroy!
  end

    def question_params
      params.require(:question).permit(
        :title, :time_limit,
        answers_attributes: [:id, :score, :content, :_destroy]
      )
    end
</code></pre></div></div>

<p>You can try
<a href="https://github.com/nathanvda/cocoon">cocoon</a> gem and use
<code class="language-plaintext highlighter-rouge">link_to_add_association</code> <a href="https://www.sitepoint.com/better-nested-attributes-in-rails-with-the-cocoon-gem">tutorial
post</a></p>

<p><code class="language-plaintext highlighter-rouge">has_many :ip_addresses, inverse_of: :subscriber</code> is needed when you have
validation errors for <code class="language-plaintext highlighter-rouge">accepts_nested_attributes_for</code>
https://robots.thoughtbot.com/accepts-nested-attributes-for-with-has-many-through
Validation of uniqueness does not work for bulk update with <code class="language-plaintext highlighter-rouge">_attributes</code> since
it check only what is in db (not in params), so one solution is to add
<code class="language-plaintext highlighter-rouge">inverse_of</code> and to add validation</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # this works when we create one record (not for batch update with
  # ip_address_attributes)
  validates :fix_ip_address, presence: true, uniqueness: { scope: :parent_location_id }
  # so we need to validate that also
  validate :uniqueness_for_batch_update
  def uniqueness_for_batch_update
    ips = subscriber.ip_addresses.map(&amp;:fix_ip_address)
    errors.add(:fix_ip_address, 'already exists') if ips.size != ips.uniq.size
  end
</code></pre></div></div>

<p>Note that callback in nested model, like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Answer
  before_save :check_something_on_answer
end
</code></pre></div></div>
<p>will not be called when answers are updated as <code class="language-plaintext highlighter-rouge">answers_attributes</code></p>

<h1 id="multiple-form-submit-buttons-for-different-actions">Multiple form submit buttons for different actions</h1>

<p>you can use rails builder to show two buttons</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;%= f.submit "Some label" %&gt;
  &lt;%= f.submit "Some other label" %&gt;
</code></pre></div></div>

<p>will generate</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;input type="submit" name="commit" value="Some label"&gt;
  &lt;input type="submit" name="commit" value="Some other label"&gt;
</code></pre></div></div>

<p>so you can check on server</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  if params[:commit] == "Some label"
</code></pre></div></div>

<p>When you are not using <code class="language-plaintext highlighter-rouge">f.submit</code> but plain <code class="language-plaintext highlighter-rouge">&lt;button&gt;Some label&lt;/button&gt;</code> than
  you need to add <code class="language-plaintext highlighter-rouge">hidden_field_tag :commit, "Some label"</code></p>

<p>Sometimes there is a problem when automatic translator on the page change
  button labels and inputs so commit param is different…
  There are two solutions for that:
  Instead of <code class="language-plaintext highlighter-rouge">commit</code> you can use
  <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Input#attr-formaction">formaction</a>
  So you do not need to parse commits but you need different action methods to
  handle.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;%= form_for('url') do |f| %&gt;
      &lt;%= f.submit 'Create' %&gt;
      &lt;%= f.submit 'Special Action', formaction: special_action_path %&gt;
  &lt;% end %&gt;
</code></pre></div></div>

<p>Another solution to translations I18 of input submit is to use buttons with
  value as the same as the text inside button tag.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;%= form_for('url') do |f| %&gt;
    &lt;%# instead of &lt;input&gt; we use &lt;button&gt; with value (which could be the same as inner text) so automatic page translators do not change that value %&gt;
    &lt;%= f.button 'Create', value: 'Create' %&gt;
    &lt;%= f.button 'Special Action', value: 'Special Action' %&gt;
  &lt;% end %&gt;
</code></pre></div></div>
<p>this will generate</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;form action="url"&gt;
    &lt;button name="button" type="submit" value="Create"&gt;Create&lt;/button&gt;
    &lt;button name="button" type="submit" value="Special Action"&gt;Special Action&lt;/button&gt;
  &lt;/form&gt;
</code></pre></div></div>
<p>so you can grab <code class="language-plaintext highlighter-rouge">params[:button] == 'Create'</code></p>

<p>If you want to disable utf-8 and authenticity hidden fields, remove hidden
  input <code class="language-plaintext highlighter-rouge">name='commit'</code> for submit buttons <code class="language-plaintext highlighter-rouge">button_tag 'OK', name: nil</code> and use
  plain param name instead of in brackets <code class="language-plaintext highlighter-rouge">f.hidden_field :name</code> generate
  <code class="language-plaintext highlighter-rouge">name='[name]'</code> (but <code class="language-plaintext highlighter-rouge">f.text_field :name</code> generate <code class="language-plaintext highlighter-rouge">name='name'</code>), than use
  <code class="language-plaintext highlighter-rouge">hidden_field_tag :name</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;%= bootstrap_form_tag url: @atom_payment.atom_server_link, layout: :horizontal, enforce_utf8: false, authenticity_token: false do |f| %&gt;
      &lt;% @atom_payment.atom_params.each do |atom_param| %&gt;
        &lt;%= hidden_field_tag atom_param[:name], atom_param[:value] %&gt;
      &lt;% end %&gt;
      &lt;%= button_tag "Pay Now", name: nil, class: 'btn btn-primary btn-block', 'data-disable-with': 'Processing...' %&gt;
    &lt;% end %&gt;
</code></pre></div></div>
<ul>
  <li>if you want to access hash keys by symbol or string you can instantiate with
<code class="language-plaintext highlighter-rouge">params = HashWithIndifferentAccess.new name: 'Duke'</code> so you can use
<code class="language-plaintext highlighter-rouge">params[:name]</code> or <code class="language-plaintext highlighter-rouge">params["name"]</code>.</li>
</ul>

<p>Here is a rails app, and here is a gist</p>

<h1 id="rails-and-forms">Rails and Forms</h1>

<p>https://api.rubyonrails.org/v5.2.1/classes/ActionView/Helpers/FormHelper.html</p>

<h2 id="input-outside-of-a-form">Input outside of a form</h2>

<p><code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> can be outside of a <code class="language-plaintext highlighter-rouge">&lt;form&gt;</code>, all it needs is <code class="language-plaintext highlighter-rouge">form='id_of_a_form'</code></p>

<h2 id="dialog-element">Dialog element</h2>

<p>There is native html tag for modals <code class="language-plaintext highlighter-rouge">&lt;dialog&gt;</code>. When you call
<code class="language-plaintext highlighter-rouge">dialogEl.showModal()</code> there will be backgrop and autofocus is triggered (if
there is <code class="language-plaintext highlighter-rouge">autofocus</code> attribute).
https://alligator.io/html/dialog-element/</p>

<h2 id="fieldset--legend">Fieldset &amp; Legend</h2>

<p>Use <code class="language-plaintext highlighter-rouge">&lt;fieldset&gt;</code> to group several input fields into one section and set caption
label on this part with <code class="language-plaintext highlighter-rouge">&lt;legend&gt;</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;fieldset&gt;
  &lt;legend&gt;
    My section
  &lt;/legend&gt;
  My content
&lt;/fieldset&gt;
</code></pre></div></div>
<p>When it is disabled, all nested input fields can not be used, as they were
disabled. In Rails 6 I submitted a bug when using remote: true, all nested input
fields are submitted so in this case you need to disable manually each input
field. But it is fixed now https://github.com/rails/rails/issues/36728</p>

<p>Another problem with <code class="language-plaintext highlighter-rouge">f.fields_for :venue</code> is that if model persists, this will
add some hidden <code class="language-plaintext highlighter-rouge">venue_attributes[:id] = id</code>
https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/actionview/lib/action_view/helpers/form_helper.rb#L1928</p>

<p>You can set caption also on figure</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;figure&gt;
  &lt;img src="/wp-content/uploads/flamingo.jpg" alt="flamingo"&gt;
  &lt;figcaption&gt;&lt;i&gt;fig. 1&lt;/i&gt; A pink flamingo.&lt;/figcaption&gt;
&lt;/figure&gt;
</code></pre></div></div>

<h1 id="input-attributes">Input Attributes</h1>

<h2 id="autosuggestion">Autosuggestion</h2>

<p>Pure html autoselect suggestions (but not required from list) can be done using
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/datalist">datalist</a>
and <code class="language-plaintext highlighter-rouge">&lt;input list='id_of_datalist'&gt;</code> attribute.</p>

<h2 id="autocomplete">Autocomplete</h2>

<p>Autocomplete can be enabled with specific value https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/autocomplete
or disabled because off
<a href="https://developer.mozilla.org/en-US/docs/Web/Security/Securing_your_site/Turning_off_form_autocompletion">security</a>
(even disabled, browser can ask for auto save password, it will populate them)</p>

<p>Firefox has soft refresh which persist input values and disabled attribute on
refresh the page https://stackoverflow.com/questions/5985839/bug-with-firefox-disabled-attribute-of-input-not-resetting-when-refreshing
This can be disabled by hard refresh or autocomplete <code class="language-plaintext highlighter-rouge">off</code></p>

<p>But it is advisable to enable autocomplete so user get suggestions on phone
https://developer.apple.com/documentation/security/password_autofill/enabling_password_autofill_on_an_html_input_element</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;input id="user-text-field" type="email" autocomplete="username"/&gt;
&lt;input id="password-text-field" type="password" autocomplete="current-password"/&gt;

&lt;%= f.text_field :login, autofocus: true, autocomplete: "email", placeholder: 'Enter Mobile No. / Email ID', skip_label: true, autocapitalize: "off" %&gt;
&lt;%= form.label :mobile, 'What is your Mobile?', class: 'labeltext', autocomplete: "tel" %&gt;
&lt;%= form.text_field :otp_attempt, class: 'form-control', placeholder: 'Enter OTP', autofocus: true, required: true, autocomplete: "one-time-code" %&gt;
&lt;%= form.select :year, options_for_select(year_options, selected: form.object.year), {}, class: 'form-control', id: :year, autocomplete: "bday-year" %&gt;
&lt;%= form.text_field :zip, class: 'form-control', placeholder: 'Enter Your Zipcode', autofocus: true, required: true, autocomplete: "postal-code" %&gt;
&lt;%= form.password_field :password, class: 'form-control', placeholder: "Enter Password (min #{User.password_length.min} chars)", autocomplete: "new-password" %&gt;
&lt;%= form.password_field :password_confirmation, class: 'form-control', placeholder: 'Confirm Password', autocomplete: "new-password" %&gt;
</code></pre></div></div>

<h2 id="autofocus">Autofocus</h2>

<p>Auto focus input fields on page load (or dialog show). If you need to show focus
on input with existing value than you can use callback <code class="language-plaintext highlighter-rouge">onfocus</code>
https://stackoverflow.com/questions/511088/use-javascript-to-place-cursor-at-end-of-text-in-text-input-element/2345915#2345915</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;%= f.search_field :s, autofocus: true, onfocus: 'this.selectionStart = this.selectionEnd = this.value.length;' %&gt;
</code></pre></div></div>
<p>or another solution
https://stackoverflow.com/a/24891345/287166</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= form.text_field :mobile, class: 'form-control', placeholder: 'Enter Mobile', value: form.object.mobile || '+1', autofocus: true, onfocus: 'var temp = this.value; this.value = ""; this.value = temp' %&gt;
</code></pre></div></div>

<h2 id="disabled">Disabled</h2>

<p>Disabled inputs do not receive <code class="language-plaintext highlighter-rouge">click</code> event, and they are not submitted with
the form.
This can be used to preventDefault on click event for other <code class="language-plaintext highlighter-rouge">data-</code> event
listeners.</p>

<h2 id="required">Required</h2>

<p><code class="language-plaintext highlighter-rouge">required</code> is boolean attribute, when is present, user myst specify a value. On
all except (color, hidden, range, submit, image, reset, button). When it is on
<code class="language-plaintext highlighter-rouge">checkbox</code> than user have to select it before procceeding.
Required inputs has pseudoclass <code class="language-plaintext highlighter-rouge">:required</code>.</p>

<h2 id="tabindex">Tabindex</h2>

<p><code class="language-plaintext highlighter-rouge">tabindex</code> should be <code class="language-plaintext highlighter-rouge">0</code> so it is reachable by sequential keyboard navigation.</p>

<h2 id="placeholder">Placeholder</h2>

<p>There are three ways of providing more info about form field, but the best way
is using <code class="language-plaintext highlighter-rouge">label</code> and to avoid placeholders.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">label</code> element is outside of a input</li>
  <li><code class="language-plaintext highlighter-rouge">placeholder</code> text that is shown when field is empty. So when is not empty, no
show. Also browsers translators does not work on placeholders since it is
attribute (not a value or a text object).</li>
  <li>adjacent elements (google sign in use this)</li>
</ul>

<h1 id="select">Select</h1>

<p><a href="https://apidock.com/rails/ActionView/Helpers/FormOptionsHelper/select">form
select</a>
can accept as 2th param (choices) two variant:</p>

<ul>
  <li>flat collection <code class="language-plaintext highlighter-rouge">[['name', 123],...]</code></li>
  <li>if you need manual tags <code class="language-plaintext highlighter-rouge">&lt;select&gt;&lt;option&gt;&lt;/option&gt;&lt;/select&gt;</code> than you can use
<code class="language-plaintext highlighter-rouge">&lt;%= select tag "statuses[]", options_for_select([[]], selected: 1) %&gt;</code></li>
  <li>
    <p>nested collection <code class="language-plaintext highlighter-rouge">grouped_options_for_select()</code> (also exists
<code class="language-plaintext highlighter-rouge">f.grouped_collection_select</code>)</p>

    <p>Preselected value can be defined as second param in <code class="language-plaintext highlighter-rouge">options_for_select([],
selected: f.object.user_id</code>, or as 4th param in
<code class="language-plaintext highlighter-rouge">options_from_collection_for_select(User.all, :id, :email, selected:
f.object.user_id)</code>. Note that it can be <code class="language-plaintext highlighter-rouge">value</code> or hash <code class="language-plaintext highlighter-rouge">selected: value</code>.</p>
  </li>
</ul>

<p>as 3th param (options):</p>

<p>Sometimes when options do not include value that you want to set and you
use prompt to be shown, please preform check <code class="language-plaintext highlighter-rouge">{ prompt: 'Select package'
}.merge( options.present? ? { selected: @customer.some_other_package.id
} : {} )</code>. If target selected value is not in options, that first option will be
used, or prompt is shown when options is empty.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">disabled: [values]</code> to disable some options</li>
  <li><code class="language-plaintext highlighter-rouge">label: 'My label'</code></li>
  <li><code class="language-plaintext highlighter-rouge">prompt: 'Please select'</code> this is shown only if not already have some value</li>
  <li><code class="language-plaintext highlighter-rouge">include_blank: 'Please select'</code> this is shown always (even already have
value) I found usefull only with select2 where we use custom placeholder and
blank option is not selectable <code class="language-plaintext highlighter-rouge">&lt;%= f.select :customer_name_and_username,
options_from_collection_for_select(current_location.customers, 'id',
'name_and_username'),  { include_blank: true, label: 'Customer' },
'data-select2': true, placeholder: 'Search by Customer Name or Username' %&gt;</code></li>
</ul>

<p>as 4th params (html options)</p>
<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">multiple: true</code> so it is multi_select (instead of dropdown). Multi select
will be shown with its own scrollbar (use <code class="language-plaintext highlighter-rouge">size: 5</code> to limit the size).
In controller you need to allow arrays</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def event_params
  params.require(:event).permit(
    :title, skills: []
  )
end
</code></pre></div>    </div>
  </li>
  <li>
    <p>Form array can be set on any input, use square brackets <code class="language-plaintext highlighter-rouge">name='user_ids[]'</code>.
  In view you can set array of hidden fields</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> &lt;% @isp_push_packages.isp_package_ids.each do |isp_package_id| %&gt;
   &lt;%= f.hidden_field 'isp_package_ids[]', value: isp_package_id %&gt;
 &lt;% end %&gt;
</code></pre></div>    </div>
    <p>or using select <code class="language-plaintext highlighter-rouge">multiple: true</code> (it will automatically add <code class="language-plaintext highlighter-rouge">[]</code> to the name)</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;%= f.select isp_package_ids, options, {}, multiple: true %&gt;
</code></pre></div>    </div>
    <p>Note that you can replace dropdown select input with checkboxes, for example</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;% ApplicationRecord.split_and_convert_to_hash(LANGUAGES).values.each do |language| %&gt;
 &lt;%= f.check_box 'languages_spoken_at_home', { multiple: true, label: language}, language, nil %&gt;
  &lt;% end %&gt;
</code></pre></div>    </div>
  </li>
</ul>

<p>You can also nest in two dimensions ie it will be a hash with array values
  <code class="language-plaintext highlighter-rouge">name='user_ids[#{company.id}][]</code>. In this case you need to permit hash
  (Rails 5.2) or whitelist in before Rails 5.2</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  params.require(:post).permit(reseller_location_ids: {}) # Rails 5.2
  permit(files: params[:post][:files].key # before Rails 5.2

  &lt;%= select_tag 'reseller_location_ids[#{operator.id}]', options, multiple: true %&gt;
  # do not know how to use f.select since can not have method with a name
  `name[name]`
</code></pre></div></div>
<p>Note that if it is not required and nothing is selected than nothing will be
  sent, you should use hidden field or default value <code class="language-plaintext highlighter-rouge">{}</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;%= hidden_field_tag 'reseller_location_ids[0][]' %&gt;
  # or
  location_ids = (params[:reseller_location_ids] || {})[params[:reseller_operator_id]] || []
</code></pre></div></div>

<ul>
  <li>And in model you need to clean empty strings <code class="language-plaintext highlighter-rouge">[""]</code> when nothing is selected
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  before_validation :clean_empty_skills
  def clean_empty_skills
 self.skills = skills.select &amp;:present?
  end
</code></pre></div>    </div>
  </li>
</ul>

<p>examples
TODO
https://www.driftingruby.com/episodes/nested-forms-from-scratch-with-stimulusjs</p>

<p>instead of polymorhic, we could use separate columns <code class="language-plaintext highlighter-rouge">isp_id</code>, <code class="language-plaintext highlighter-rouge">operator_id</code>,
<code class="language-plaintext highlighter-rouge">location_id</code>. it is hard to search by that colum</p>

<p>for specific form inputs to ask, you can use fieldset and disable those which
are not necessary.</p>

<p>Single line oneliner form in one line is using button_to with params: label,
url, form class</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= button_to 'Email bounce', superadmin_user_path(@user, user: { email_bounce: true }), method: :patch, class: 'btn btn-danger', form_class: 'd-inline' %&gt;

&lt;%= link_to "Fair usage policy", expire_subscriber_path(@subscriber, button: 'fair_usage_policy'), method: :patch, class: 'btn btn-primary' %&gt;
</code></pre></div></div>
<p>Default is using POST, but you can change and add params</p>

<ul>
  <li>in rails <code class="language-plaintext highlighter-rouge">&lt;%= form_with ..., class: 'my-class'</code> you can use class attribute
directly, but other attributes are not passed, so you need to use html like
<code class="language-plaintext highlighter-rouge">&lt;%= form_with ..., html: { class: 'my-class' } %&gt;</code></li>
  <li>optional permit params that allows empty
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def _my_form_params
  params[:my_from] = {name: ""} unless params.keys.include? "my_from"
  params.require(:my_from).permit(:name)
end
</code></pre></div>    </div>
  </li>
</ul>

<p>todo https://web.dev/learn/forms/</p>
</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
