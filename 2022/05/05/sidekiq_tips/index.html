<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Sidekiq_tips</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Sidekiq_tips</h1>
    <p class="meta">May 5, 2022</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#sidekiq-tips"><span class="tocnumber">1</span> <span class="toctext">Sidekiq tips</span></a></li><li class="toc_level-1 toc_section-2"><a href="#queues"><span class="tocnumber">2</span> <span class="toctext">Queues</span></a></li><li class="toc_level-1 toc_section-3"><a href="#redis"><span class="tocnumber">3</span> <span class="toctext">Redis</span></a></li><li class="toc_level-1 toc_section-4"><a href="#web-ui"><span class="tocnumber">4</span> <span class="toctext">Web UI</span></a></li><li class="toc_level-1 toc_section-5"><a href="#scheduler"><span class="tocnumber">5</span> <span class="toctext">Scheduler</span></a></li><li class="toc_level-1 toc_section-6"><a href="#clear-of-find-a-job"><span class="tocnumber">6</span> <span class="toctext">Clear of find a job</span></a></li><li class="toc_level-1 toc_section-7"><a href="#test-background-jobs-spec"><span class="tocnumber">7</span> <span class="toctext">Test background jobs spec</span></a></li><li class="toc_level-1 toc_section-8"><a href="#start-with-rails"><span class="tocnumber">8</span> <span class="toctext">Start with rails</span></a></li></ul></td></tr></tbody></table></div><p>https://github.com/duleorlovic/sidekiq_tips/#readme</p>

<h1 id="sidekiq-tips">Sidekiq tips</h1>

<p>Docs on wiki
https://github.com/mperham/sidekiq/wiki</p>

<p>We could use sidekiq as queuing backend for ActiveJob
https://github.com/mperham/sidekiq/wiki/Active-Job
but since it is slower and sidekiq extension is hard to use, I prefer to use
basic sidekiq (outside of ActiveJob).</p>

<p>To install</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle add sidekiq
</code></pre></div></div>
<p>and run the main process</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sidekiq
</code></pre></div></div>

<p>You do not need to restart the process when you make changes in jobs. Restart is
needed when you make change in sidekiq.yml configuration.
You can start both rails and sidekiq in one command using Procfile</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Procfile
web: bundle exec rails s -p 3000
worker: bundle exec sidekiq -C config/sidekiq.yml
</code></pre></div></div>
<p>and start with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>foreman start
</code></pre></div></div>

<p>Letâ€™s create plain sidekiq job</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g sidekiq:job a
vi app/sidekiq/a_job.rb
</code></pre></div></div>

<p>Sidekiq uses syntax https://github.com/mperham/sidekiq/wiki/Scheduled-Jobs
similar to ActiveJob <code class="language-plaintext highlighter-rouge">perform_later</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AJob.perform_later args
AJob.set(wait: 1.week).perform_later args
AJob.set(wait_until: Date.tomorrow.noon).perform_later args
AJob.perform_now args
</code></pre></div></div>
<p>we have</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AJob.perform_async 'duke'
AJob.perform_in 3.hours, 'duke'
AJob.perform_at 3.hours.from_now, 'duke'

# to invoke perform_now use
AJob.new.perform 'duke'
</code></pre></div></div>

<p>With ActiveJob you can pass entire ActiveRecord objects because GlobalID will
deserialize for us. But if you are using directly sidekiq jobs (not inherited
from ActiveJob::Base) than you should pass object_id.</p>

<h1 id="queues">Queues</h1>

<p>Since the main process will run default queue, I prefer to name the queue based
on the app and use that name in configuration. If you run jobs from another app
you will get <code class="language-plaintext highlighter-rouge">NameError: uninitialized constant ...</code>
https://github.com/mperham/sidekiq/wiki/Advanced-Options</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># config/sidekiq.yml
---
:concurrency: 2
:queues:
  - my_app_critical
  - my_app_default
</code></pre></div></div>

<p>In this example <code class="language-plaintext highlighter-rouge">my_app_default</code> jobs will be executed only if there is no 2
<code class="language-plaintext highlighter-rouge">my_app_critical</code> enqueued jobs. Also note if there are 2 <code class="language-plaintext highlighter-rouge">my_app_default</code>
running jobs <code class="language-plaintext highlighter-rouge">my_app_critical</code> will have to wait them to complete.</p>

<p>Sidekiq supports ordered (like previos example) and weighted modes but you can
not mix those to modes. If, for example, you need a critical queue that is
processed first, and would like other queues to be weighted, you would dedicate
a Sidekiq process exclusively to the critical queue, and other Sidekiq processes
to service the rest of the queues.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sidekiq -q critical # Only handles jobs on the "critical" queue
sidekiq -q default -q low -q critical # Handles critical jobs only after checking for other jobs
</code></pre></div></div>

<h1 id="redis">Redis</h1>

<p>You need to install redis server, which is simply adding Heroku redis addon.
https://elements.heroku.com/addons/heroku-redis Or on AWS you can install
https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04
Since it allows only 10 connections you need to limit connections for sidekiq.</p>

<p>Sidekiq server uses two connections, so if <code class="language-plaintext highlighter-rouge">:concurrency: 3</code> than server uses 5
connections so you can use puma threads 5 to utilize all 10 connections.
https://github.com/mperham/sidekiq/issues/117
https://manuelvanrijn.nl/sidekiq-heroku-redis-calc/</p>

<p>For error</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A Redis::CommandError occurred in background at 2022-07-29 05:55:22 UTC :

  MISCONF Redis is configured to save RDB snapshots, but it's currently unable to persist to disk. Commands that may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.
  /Users/dule/.rvm/gems/ruby-3.0.1/gems/redis-4.2.5/lib/redis/client.rb:132:in `call'
</code></pre></div></div>
<p>you need to restart redis</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew services restart redis
</code></pre></div></div>

<h1 id="web-ui">Web UI</h1>

<p>https://github.com/mperham/sidekiq/wiki/Monitoring</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># config/routes.rb
require 'sidekiq/web'

  mount Sidekiq::Web =&gt; '/sidekiq'

# app/views/pages/index.html.erb
&lt;%= link_to "Sidekiq", "/sidekiq" %&gt;
</code></pre></div></div>

<p>Add back to app button</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># config/initializers/sidekiq.rb
require 'sidekiq/web'
Sidekiq::Web.app_url = '/' # show "Back to App" button
</code></pre></div></div>
<p>https://github.com/mperham/sidekiq/wiki/Best-Practices#4-use-precise-terminology
Do not use <code class="language-plaintext highlighter-rouge">worker</code> term
Job is created when you enqueue a job instance.
Process is the main sidekiq command that you started.
To see current processes and number of threads http://localhost:3000/sidekiq/busy
Busy Thread is created when proccess start executing the job</p>

<p>Job lifecycle https://github.com/mperham/sidekiq/wiki/Job-Lifecycle
Final state is either Processed (only counter) or Dead, other states are
transitive states (temporary states)</p>

<p>We can use sidekiq_options</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/sidekiq/a_job.rb
  # Default retry is 25, do not use if job is not idempotent
  sidekiq_options retry: 25
  # will be completely ephemeral, not in Retry or Dead, just increment counters
  sidekiq_options retry: false
  # will go immediately to the Dead tab upon first failure
  sidekiq_options retry: 0
</code></pre></div></div>

<h1 id="scheduler">Scheduler</h1>

<p>https://github.com/moove-it/sidekiq-scheduler</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle add sidekiq-scheduler
</code></pre></div></div>

<p>Create sample scheduler</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/sidekiq_worker/weekly_remainder_worker.rb
require 'sidekiq-scheduler'

class WeeklyRemainderWorker
  include Sidekiq::Worker
  sidekiq_options queue: 'my_app_default'

  def perform
    puts "WeeklyRemainderWorker finished"
  end
end
</code></pre></div></div>
<p>add to configuration</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># config/sidekiq.yml

:schedule:
  weekly_remainder:
    cron: '0 * * * * *'   # https://crontab.guru/
    class: WeeklyRemainderWorker
</code></pre></div></div>

<p>add to routes</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># config/routes.rb
require 'sidekiq-scheduler/web'
</code></pre></div></div>

<h1 id="clear-of-find-a-job">Clear of find a job</h1>

<p>To clear see https://gist.github.com/wbotelhos/fb865fba2b4f3518c8e533c7487d5354
To clear all jobs from a current queue named my_app_</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># this will not remove scheduled jobs, only enqueued jobs
Sidekiq::Queue.new.clear # this will clear `default` queue
Sidekiq::Queue.new('my_app_default').clear

Sidekiq::ScheduledSet.new.clear

# Reset counters
Sidekiq::Stats.new.reset
</code></pre></div></div>

<p>To find specific existing jobs you can use scan or map.compact</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>queue = Sidekiq::Queue.new("default")
# https://github.com/mperham/sidekiq/wiki/API
jobs = queue.map do |job|
  if job.klass == '[JOB_CLASS]'
    {job_id: job.jid, job_klass: job.klass, arguments: job.args}
  end
end.compact
</code></pre></div></div>

<h1 id="test-background-jobs-spec">Test background jobs spec</h1>

<p>You can not use ActiveJob assertions since we do not use ActiveJob
https://api.rubyonrails.org/classes/ActiveJob/TestHelper.html#method-i-assert_enqueued_jobs
like <code class="language-plaintext highlighter-rouge">assert_enqueued_with job: MyJob, args: [user]</code> <code class="language-plaintext highlighter-rouge">perform_enqueued_jobs</code> <code class="language-plaintext highlighter-rouge">assert_performed_jobs 1</code></p>

<p>But you can test using https://github.com/mperham/sidekiq/wiki/Testing</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/test_helper.rb
require "sidekiq/testing"
</code></pre></div></div>
<p>and</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test/sidekiq_workers/weekly_remainder_worker_test.rb
    assert_difference "AJob.jobs.size", 1 do
      ScheduleScraperPageWorker.new.perform
    end
</code></pre></div></div>

<h1 id="start-with-rails">Start with rails</h1>

<p>Sidekiq 7 enables you to run sidekiq with <code class="language-plaintext highlighter-rouge">rails s</code> command</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># config/puma.rb
# https://www.mikeperham.com/2022/10/27/sidekiq-7.0-embedding/
workers 2
threads 1, 3

require "sidekiq"
# preloading the application is necessary to ensure
# the configuration in your initializer runs before
# the boot callback below.
preload_app!

x = nil
on_worker_boot do
  x = Sidekiq.configure_embed do |config|
    # config.logger.level = Logger::DEBUG
    config.queues = %w[critical default low]
    config.concurrency = 2
  end
  x.run
end

on_worker_shutdown do
  x&amp;.stop
end
</code></pre></div></div>
</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
