<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Authorization_policy_cancan_pundit_action_policy</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Authorization_policy_cancan_pundit_action_policy</h1>
    <p class="meta">Apr 26, 2021</p>
  </header>

  <article class="post-content">
  <body><div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#cancan"><span class="tocnumber">1</span> <span class="toctext">Cancan</span></a></li><li class="toc_level-1 toc_section-2"><a href="#pundit"><span class="tocnumber">2</span> <span class="toctext">Pundit</span></a><ul><li class="toc_level-2 toc_section-3"><a href="#headless-policies"><span class="tocnumber">2.1</span> <span class="toctext">Headless policies</span></a></li><li class="toc_level-2 toc_section-4"><a href="#scopes"><span class="tocnumber">2.2</span> <span class="toctext">Scopes</span></a></li></ul></li><li class="toc_level-1 toc_section-5"><a href="#action-policy"><span class="tocnumber">3</span> <span class="toctext">Action Policy</span></a></li></ul></td></tr></tbody></table></div><h1 id="cancan">Cancan</h1>

<p>use cancancan and define all your actions in app/models/ability. If you want to
use
<a href="https://github.com/ryanb/cancan/wiki/authorizing-controller-actions#load_resource">load_resource</a>,
you should separately define: index (with hash), show/edit/update/destroy (with
block or hash), new/create (with hash). For nested resources just write parent
association</p>

<p>Note that following next <code class="language-plaintext highlighter-rouge">cannot</code> rule will override a previous <code class="language-plaintext highlighter-rouge">can</code> rule, so
it is enough to set <code class="language-plaintext highlighter-rouge">can :manage, :all</code> and than write what <code class="language-plaintext highlighter-rouge">cannot :destroy,
Project</code></p>

<p>Define abilities
https://github.com/CanCanCommunity/cancancan/wiki/defining-abilities</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>can :read, Article # autorize! :read, Article will return true
can :crud, Article # authorize! :read/:create/:update/:destroy, Article will return true
# https://github.com/CanCanCommunity/cancancan/wiki/Action-Aliases
aliase_action :index, :show, to: :read | :new, to: :create | :edit. to: :update
can :manage, Article # authorize! :any_action, Article will return true
can [:update, :destroy], [Post, Comment] # array notation
</code></pre></div></div>
<p>Hash of conditions</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># can read only posts that belongs to user
can :read, Post, user_id: user.id
</code></pre></div></div>
<p>Defining with a block is evaluated only when instance is passed (for example not
in index action when class is used, ie if you call <code class="language-plaintext highlighter-rouge">can? :update, Project</code> it
will return true)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>can :update, Project do |project|
  false
end
</code></pre></div></div>

<p>Defining with a block without other arguments can be used for defining
Abilities and roles in database
https://github.com/CanCanCommunity/cancancan/wiki/Abilities-in-Database</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g model Permission user_id:integer name:string subject_class:string subject_id:integer action:string description:text

# app/models/ability.rb
class Ability
  include CanCan::Ability
  can do |action, subject_class, subject|
    # action: :read, subject_class: User, subject: 1 or nil
  end
end
</code></pre></div></div>

<p>Example that only admins can change, for example company_id, with
can_change_user_company_id</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># in models/ability.rb
can :can_change_user_company_id, User if user.admin?

&lt;!-- users/_form.html.erb --&gt;
&lt;% if can? :can_change_user_company_id, @user %&gt;
  &lt;!-- role checkboxes go here --&gt;
&lt;% end %&gt;

# users_controller.rb
def update
  authorize! :can_change_user_company_id, @user if params[:user][:company_id]
  # ...
end
</code></pre></div></div>

<h1 id="pundit">Pundit</h1>

<p>https://github.com/varvet/pundit</p>

<p>Install with gem and include in controller</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Gemfile
gem 'pundit'

# app/controllers/application_controller.rb
class ApplicationController &lt; ActionController::Base
  include Pundit
end

# generate default app/policies/application_policy.rb
rails g pundit:install
</code></pre></div></div>

<p>Sample ruby poro class</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class PostPolicy
  attr_reader :user, :post

  def initialize(user, post)
    @user = user
    @post = post
  end

  def update?
    user.admin? or not post.published?
  end
end
</code></pre></div></div>
<p>Pundit will assume that:</p>
<ul>
  <li>class has the same name as model + suffix <code class="language-plaintext highlighter-rouge">Policy</code></li>
  <li>first argument is a <code class="language-plaintext highlighter-rouge">current_user</code> (called where it was invoked) and stored in
<code class="language-plaintext highlighter-rouge">user</code>.</li>
  <li>second argument is object and stored in <code class="language-plaintext highlighter-rouge">record</code> (if you use generated
ApplicationPolicy).</li>
  <li>define methods like method name plus ?</li>
</ul>

<p>When using <code class="language-plaintext highlighter-rouge">authorize</code> you can set first argument as a class <code class="language-plaintext highlighter-rouge">authorize Post</code> or
a symbol for headless policy. Second argument could be action name: <code class="language-plaintext highlighter-rouge">authorize
@post, :destroy?</code>. To specify Policy class you can use <code class="language-plaintext highlighter-rouge">authorize @post,
policy_class: PostPolicy</code></p>

<p>In controller <code class="language-plaintext highlighter-rouge">authorize @post</code> inside <code class="language-plaintext highlighter-rouge">def update</code> action will instantiate
policy with <code class="language-plaintext highlighter-rouge">current_user</code> and call method with <code class="language-plaintext highlighter-rouge">?</code> at the end, something like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unless PostPolicy.new(current_user, @post).update?
  raise Pundit::NotAuthorizedError, "not allowed to update? this #{@post.inspect}"
end
</code></pre></div></div>

<p>In view, you can use <code class="language-plaintext highlighter-rouge">if policy(@post).update?</code> method to check if current_user
is authorized.
You can rescue from not authorized requests
https://github.com/varvet/pundit#rescuing-a-denied-authorization-in-rails</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def new
  authorize @user
  rescue Pundit::NotAuthorizedError =&gt; e
    flash.now[:alert] = e.message
    render :error
  end
end
</code></pre></div></div>

<h2 id="headless-policies">Headless policies</h2>

<p>Headless policies, if you do not have corresponding model.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/policies/dashboard_policy.rb
class DashboardPolicy &lt; Struct.new(:user, :dashboard)
  # ...
end
</code></pre></div></div>
<p>and use like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% if policy(:dashboard).show? %&gt;
  &lt;%= link_to 'Dashboard', dashboard_path %&gt;
&lt;% end %&gt;
</code></pre></div></div>

<h2 id="scopes">Scopes</h2>

<p>To define scope on a model for which current_user have access, punding assumes:</p>
<ul>
  <li>class has name <code class="language-plaintext highlighter-rouge">Scope</code> and is nested under the policy class</li>
  <li>first argument is user and second argument is a scope</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class PostPolicy &lt; ApplicationPolicy
  class Scope &lt; Scope
    def resolve
      if user.admin?
        scope.all
      else
        scope.where(published: true)
      end
    end
  end

  def update?
    user.admin? or not record.published?
  end
end
</code></pre></div></div>
<p>and you can use like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def index
  # @posts = PostPolicy::Scope.new(current_user, Post).resolve
  @posts = policy_scope(Post)
end

def show
  @post = policy_scope(Post).find(params[:id])
end
</code></pre></div></div>

<p>To check if <code class="language-plaintext highlighter-rouge">authorize</code> is called you can use <code class="language-plaintext highlighter-rouge">verify_authorized</code> so it raises
error if <code class="language-plaintext highlighter-rouge">authorize</code> is not called.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/controllers/application_controller.rb
class ApplicationController &lt; ActionController::Base
  include Pundit
  after_action :verify_authorized
end
</code></pre></div></div>

<p>Also you can check if user exists in ApplicationPolicy (so you not need to check
in other policies).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ApplicationPolicy
  def initialize(user, record)
    raise Pundit::NotAuthorizedError, "must be logged in" unless user
    @user   = user
    @record = record
  end

  class Scope
    attr_reader :user, :scope

    def initialize(user, scope)
      raise Pundit::NotAuthorizedError, "must be logged in" unless user
      @user = user
      @scope = scope
    end
  end
end
</code></pre></div></div>

<p>Use alias after method are defined</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class MyPolicy &lt; ApplicationPolicy
  def create?
  end
  alias new? create?
end
</code></pre></div></div>

<h1 id="action-policy">Action Policy</h1>

<p>https://github.com/palkan/action_policy is similar to pundit</p>

<p>Generate application policy</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate action_policy:install
rails generate action_policy:policy post
</code></pre></div></div>

<p>Use in controller (policy class is infered from model name, method infers from
action name and current_user becomes user).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # You can check in before action
  def _set_post
    authorize! @post
  end

  # or with specific method
  authorize! @post, to: :update?
  # or with specific policy
  authorize! @post, with: CustomPostPolicy

  # bang will raise error if not allowed
  rescue_from ActionPolicy::Unauthorized do |ex|
    # Exception object contains the following information
    ex.policy #=&gt; policy class, e.g. UserPolicy
    ex.rule #=&gt; applied rule, e.g. :show?
  end

  # make sure we call authorize! during the action, use this after_action
  verify_authorized
</code></pre></div></div>

<p>or use in view</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% if allowed_to? :edit?, post %&gt;
</code></pre></div></div>

<p>For non models, services you need to pass any object and policy class</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% if allowed_to? :index?, Object, with: TranslationsPolicy %&gt;
  &lt;%= link_to 'Translations', translations_path %&gt;
&lt;% end %&gt;
</code></pre></div></div>

<p>Define policy using <code class="language-plaintext highlighter-rouge">user</code> and <code class="language-plaintext highlighter-rouge">record</code> instance methods. Remember to use <code class="language-plaintext highlighter-rouge">?</code> as
suffix for method names.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class CommentPolicy &lt; ApplicationPolicy
  # https://actionpolicy.evilmartians.io/#/authorization_context
  # If you have some pages without user, you can define that with allow_nil: true
  # do not define on ApplicationPolicy since you need to check user.nil? in
  # every method... For view, you can check current_user before policy check
  authorize :user, allow_nil: true

  # you can call other policies, synonim as `check?`
  def update?
    user.admin? || allowed_to?(:update?, record.post)
  end

  # pass fast or fail fast with `allow` and `deny`
  def show?
    allow! if user.admin?

    user.public?
  end

  # alias synonims so you do not need to repeat dry, NOTE that is will call if
  # method exists, so alias is used only when method missing
  # By default, ActionPolicy::Base adds one alias: alias_rule :new?, to: :create?.
  alias_rule :edit?, :destroy?, to: :update?

  # default rule is :manage (not matching anything, defaults are index? create?
  # https://github.com/palkan/action_policy/blob/master/docs/custom_policy.md
  def manage?
    true
  end
end
</code></pre></div></div>

</body>
  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
