<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Ruby on rails and Ajax javascript</title>
      <meta name="viewport" content="width=device-width">
      <meta name="description" content="I am writing here some toughts during my work in Ruby on Rails, Javascript and other">
      <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"/>

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/css/main.css">
      <link rel="stylesheet" href="/assets/css/toc.css">

  </head>

  <body>

    <header class="site-header">

      <div class="wrap">

        <a class="site-title" href="/">duleorlovic - web developer</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
              <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
                h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
                h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </a>
          <div class="trigger">
            
              <a class="page-link" href="/about/">About</a>
            
              
            
              
            
              
            
          </div>
        </nav>
        <small>tools like
          <a href=" 
            /2015/04/05/common-rails-bootstrap-snippets/"
            >Rails bootstrap</a>,
          <a href=" /2015/11/09/rails-testing/">Rails testing</a>
            and <a href=" 
            /2016/04/12/rails-tips/">Rails tips</a>
          are still in use so content can be updated!
          <a href="javascript:void(0)"
            onclick="document.getElementById('mc_embed_signup').classList.toggle('active');">Notify
          me</a>
        </small>
	  <!-- Begin MailChimp Signup Form -->
	  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
	  <style type="text/css">
		  #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
		  /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
		     We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
	  </style>
	  <div id="mc_embed_signup" class="signup-form">
	    <form action="//trk.us14.list-manage.com/subscribe/post?u=819590ae53cb08bddb952ed97&amp;id=ec1213024d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
		<div id="mc_embed_signup_scroll">
	    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
	    <div class="mc-field-group">
		    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
	    </label>
		    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
	    </div>
		    <div id="mce-responses" class="clear">
			    <div class="response" id="mce-error-response" style="display:none"></div>
			    <div class="response" id="mce-success-response" style="display:none"></div>
		    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_819590ae53cb08bddb952ed97_ec1213024d" tabindex="-1" value=""></div>
		<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</div>
	    </form>
	  </div>
	  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
	  <!--End mc_embed_signup-->

      </div>
    <!-- Html Elements for Search -->
    <div id="search-demo-container">
    <input type="text" id="search-input" placeholder="search...">
    <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to jekyll-search.js -->
    <script src="/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
      });
    </script>

    </header>
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Ruby on rails and Ajax javascript</h1>
    <p class="meta">Sep 2, 2014</p>
  </header>

  <article class="post-content">
  <p>Do you like one page application ? Do you like Rails ? Here is their child…</p>

<h2 id="ajax-with-rails">Ajax with Rails</h2>

<p><a href="http://edgeguides.rubyonrails.org/working_with_javascript_in_rails.html">Rails and
javascript</a>
can live together but some rules has to be established so you know what is going
on. Anytime you can put <code class="highlighter-rouge">debugger;</code> anywhere in javascript code and it should
stop if you have enabled some of js tools in your browser.</p>

<p><code class="highlighter-rouge">data-remote</code> ajax calls are enabled with
<a href="https://github.com/rails/jquery-ujs/wiki">jquery_ujs</a>.</p>

<p>There are two approaches when dealing with ajax calls: server responds with
final templates and javascript, or server responds with json so client side
javascript is responsible for rendering.</p>

<p>For CRUD actions, ajax usually simulate get actions for links (new, show, edit),
post actions for forms (create, update) and some patch actions for changing the
state of item (destroy, activate, pause …).</p>

<p>For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># edit.js.erb
$('#question-&lt;%= @question.id %&gt;').replaceWith(" &lt;%= j render partial: 'questions/edit_question', { question: @question } %&gt;");
</code></pre></div></div>

<p>and</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># update.js.erb
$('#question-&lt;%= @question.id %&gt;').replaceWith(" &lt;%= j render partial: 'questions/show_question', { question: @question } %&gt;");
</code></pre></div></div>

<p>Do we need for each CRUD action to write this respond.js? No, we can simplify
this by rendering respond.html templates and replacing content in javascript. If
you need different rendering in index than it is in show action (for example
show action has some new buttons etc), than you need to treat them separately,
one partial for index and one template for show.</p>

<p>All data-attributes names should be lower case.</p>

<p>For ajax requests, if there are no coresponding respond.js, rails will fall back
for rendering respond.html. We just need to stop layout rendering in this case
with this line in controller:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># app/controllers/surveys_controller.rb
layout Proc.new { |controller| false if controller.request.xhr? }
</code></pre></div></div>

<p>Using this unobtrusive ajax, we do not need ID’s for each element since we know
what is <code class="highlighter-rouge">e.target</code> element so we can use
<code class="highlighter-rouge">$(e.target).closest('p').replaceWith($new_elem);</code>.</p>

<p>For errors on form validations we could respond with json and some non
successfully error code, for example <code class="highlighter-rouge">format.js { render json: @question.errors,
status: :unprocessable_entity }</code>, but this is approach is more angular oriented.</p>

<h2 id="event-listeners-for-new-elements">Event listeners for new elements</h2>

<p>If you use javascript code like <code class="highlighter-rouge">$('a[data-activate]').click(...</code> it will not
bind to new elements created by ajax. Instead you should bind to body or another
element that stays on page and and use delegation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$('body').on('click', 'a[data-activate]', function() {});` 
</code></pre></div></div>

<p>If you  bind on <code class="highlighter-rouge">document</code> element make sure it is called only once, because of
turbolinks if you navigate 3 times to that page where you are calling the
script, you will have 3 event listeners.</p>

<p>If you need something like datepicker you can bind on focus
<a href="http://stackoverflow.com/questions/10433154/putting-datepicker-on-dynamically-created-elements-jquery-jqueryui">link</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$('body').on('focus',".datepicker_recurring_start", function(){
  $(this).datepicker();
});
</code></pre></div></div>

<p>Order of binded events on the same element is by definition order. If you want
to execute on click event <strong>before</strong> other is target that is closer, for example
insted of <code class="highlighter-rouge">$(document).on('click','[data-1]',</code> use
<code class="highlighter-rouge">$('body').on('click','[data-1]',</code>. If you want to execute <strong>after</strong> events that
are binded to <code class="highlighter-rouge">$(document).on('click'</code> than you should wrapp all that in one
function and call the code with prefered order.</p>

<h2 id="disable-with-adding">Disable with “Adding…”</h2>

<p>When you work with ajax it is advisable to use rails ujs <code class="highlighter-rouge">data: { disable_with:
"Adding..." }</code> because user can click several times on a link before server
responds. This is very important for all buttons/links that are not idempotent
actions (idempotent actions are ones that you can apply them as many times as
you want without worries, for example abs(abs(abs(x))) ).</p>

<p>When you are using</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;%= link_to path, data: { disable_with: "Saving"} do %&gt;
  &lt;div&gt;..&lt;/div&gt;
&lt;% end %&gt;
</code></pre></div></div>

<p>this will not work because whole <code class="highlighter-rouge">&lt;div&gt;..&lt;/div&gt;</code> will
be replaced with <code class="highlighter-rouge">Saving</code> (without div’s). It is better to use <code class="highlighter-rouge">disable_with:
"&lt;div&gt;Saving&lt;span class='loading-icon'&gt;&lt;/span&gt;&lt;/div&gt;".html_safe</code>.</p>

<h2 id="show-ajax-errors">Show ajax errors</h2>

<p>In case of network failure or other errors, ajax links (with <code class="highlighter-rouge">[data-remote]</code>) do
not inform the user. So it is advisable to attach event listener in case of
errors (this is not error in form validations or some other response from
server, it is a real error usually timeout because server did not respond).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// error handling just for debugging
$(document).on('ajax:error', '[data-remote]', function(e, xhr, status, error) {
  $('#flash-messages').append('Server responds with ' + status + ' ' + error);
  LOG &amp;&amp; console.log("ajax:error [data-remote] " + status+' '+error );
});
</code></pre></div></div>

<h2 id="flash-messages">Flash messages</h2>

<p>In case of some form validations error or some successul action we can send
flash message to the user. In rails it is just flash[:notice]=”Message text”,
but if we use ajax calls, we should discard flash object otherwise it will show
up on next page reload
<a href="http://stackoverflow.com/questions/21032465/rails-doesnt-display-flash-messages-after-ajax-call">link</a>.
With ajax server can send error and notice message with X-Message-Flash.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ApplicationController &lt; ActionController::Base
  
  after_filter :flash_to_headers                                       
  
  def flash_to_headers                                                 
    # http://stackoverflow.com/questions/21032465/rails-doesnt-display-flash-messages-after-ajax-call
    return unless request.xhr?
    # in ajax requests we return flash as X message                    
    response.headers['X-Message-Flash'] = flash.to_json unless flash.empty? 
    # discard flash object otherwise it will show up on next page load 
    flash.discard 
  end                                                                  
end 
</code></pre></div></div>

<p>This approach should be coupled with writing respond.js block that do not
redirect for example for update/create action <code class="highlighter-rouge">format.js { render :show, status:
:ok, location: @survey, content_type: Mime::HTML }</code> so we have those messages in
javascript. Another solution is not to discard flash and use native redirection
(the same as for format.html) ie not writing forman.js as use default
format.html responses. There is also <code class="highlighter-rouge">flash.now[:notice] = msg</code> if you want to
customize it further, probably on change (PUT, PATCH) requests, but think it
twice, because but not on form submit because forms are wrapped with classes
errors, and usually on some index pages (where we change some of the object
property and wants to stay on the same page).</p>

<ul>
  <li>GET INDEX, GET SHOW(:id), GET NEW, GET EDIT(:id), not flash messages, response is template so ajax is ok (format.js == format.html)</li>
  <li>POST CREATE, usually flash message, respond is redirect and in ajax is ok, second request is GET(:id) (format.js == format.html)</li>
  <li>PATCH/PUT UPDATE(:id), usually flash message, respond is redirect and in ajax is ok, second request is GET(:id) (format.js == format.html)</li>
  <li>DELETE DELETE(:id), usually flash message, respond is redirect but in ajax is not fine, second request is stil DELETE in chrome so use <code class="highlighter-rouge">format.js { render nothing: true }</code></li>
</ul>

<p>To summarize differences between using rails native format.js files and thiw rails unobtrusive ajax:</p>
<ul>
  <li>pros: unobtrusive ajax approach knows which link is clicked so it do not require specifix id (but it requres parameter which closest element should be replaced). This is specifically important when we generate forms for new objects (new records does not have id). You do not need to generate some random id-s to target that forms so they could be replaced with show partials.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Used to add class 'active' to selector
// example &lt;button data-activate=".popup"&gt;&lt;/button&gt;
$(document).on('click','[data-activate]', function(e) {
  $( $(this).data('activate')).addClass('active');
  e.preventDefault();
  LOG &amp;&amp; console.log("click a[data-activate]="+$(this).data('activate'));
});
// this could be toogle but it is clearer to use activate deactivate
// Used to remove class 'active' to selector
// example &lt;button data-deactivate=".popup"&gt;&lt;/button&gt;
$(document).on('click','[data-deactivate]', function(e) {
  $( $(this).data('deactivate')).removeClass('active');
  if ( $(this).data('prevent-default') != false)
    e.preventDefault();
  LOG &amp;&amp; console.log("click a[data-deactivate]="+$(this).data('deactivate'));
});
</code></pre></div></div>

<p>pros/cons: if there is an error respond.js you will not notice that in console, but in this approach, it will be shown as console error</p>

<p>Custom js functions like select2 or autosize should be defined next to target elements. for example</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   &lt;%= f.textarea :content %&gt;
   &lt;% controller.js_functions &lt;&lt; { 'textarea' =&gt; 'autosize' } %&gt;
</code></pre></div></div>

<p>That way it is much clearer. when you load the partial you do not need to worry what it needs to call (like in .js files), scope is much narrower (you will not change all the textarea, because this function is called on children(‘textarea’) of this partial).</p>

<p>When you are rendering back the form that has some _destoyed submodels, you should not display tham again:</p>

<p>Adding new elements can be done in javascript (without server active) but then the user has to confirm that, ie submit the form.
You can add remove new elements with ajax, so there is no need for submitting.</p>

<p>We used both forms.</p>


  </article>

  
  
  
  
    
  
  
  
  
  
  
  
  

</div>

      </div>
    </div>

    <style type='text/css'>
      .similar-links {
        display: inline-block;
        padding: 10px;
      }
    </style>
    <footer class="site-footer">

      <div class="wrap">

        <h2 class="footer-heading">duleorlovic - web developer</h2>

        <div class="footer-col-1 column">
          <ul>
            <li><a href="http://duleorlovic.github.io/tips/">short indistinct tips</a></li>
          </ul>
        </div>

        <div class="footer-col-2 column">
          <ul>
            <li>
              <a href="https://github.com/duleorlovic">
                <span class="icon github">
                  <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                    c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                    c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                    c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                    C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                    c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                    c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                    c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                    c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                  </svg>
                </span>
                <span class="username">duleorlovic</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="footer-col-3 column">
          <p class="text">I am writing here some toughts during my work in Ruby on Rails, Javascript and other</p>
        </div>

      </div>

    </footer>

  </body>
</html>
